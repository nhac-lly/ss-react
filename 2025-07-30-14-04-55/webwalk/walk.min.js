var iR=Object.defineProperty,nR=Object.defineProperties;var sR=Object.getOwnPropertyDescriptors;var ib=Object.getOwnPropertySymbols;var rR=Object.prototype.hasOwnProperty,oR=Object.prototype.propertyIsEnumerable;var Ep=(Ce,nt,Ui)=>nt in Ce?iR(Ce,nt,{enumerable:!0,configurable:!0,writable:!0,value:Ui}):Ce[nt]=Ui,si=(Ce,nt)=>{for(var Ui in nt||(nt={}))rR.call(nt,Ui)&&Ep(Ce,Ui,nt[Ui]);if(ib)for(var Ui of ib(nt))oR.call(nt,Ui)&&Ep(Ce,Ui,nt[Ui]);return Ce},Rn=(Ce,nt)=>nR(Ce,sR(nt));var o=(Ce,nt,Ui)=>(Ep(Ce,typeof nt!="symbol"?nt+"":nt,Ui),Ui);var $t=(Ce,nt,Ui)=>new Promise((zs,bo)=>{var Dc=lr=>{try{yo(Ui.next(lr))}catch(da){bo(da)}},ha=lr=>{try{yo(Ui.throw(lr))}catch(da){bo(da)}},yo=lr=>lr.done?zs(lr.value):Promise.resolve(lr.value).then(Dc,ha);yo((Ui=Ui.apply(Ce,nt)).next())});(function(){var w0,S0,M0,P0,C0,Xa,ta;(function(){function r(I,V,te){return I.call.apply(I.bind,arguments)}function t(I,V,te){if(!I)throw Error();if(2<arguments.length){var se=Array.prototype.slice.call(arguments,2);return function(){var Ie=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(Ie,se),I.apply(V,Ie)}}return function(){return I.apply(V,arguments)}}function e(I,V,te){return e=Function.prototype.bind&&Function.prototype.bind.toString().indexOf("native code")!=-1?r:t,e.apply(null,arguments)}var i=Date.now||function(){return+new Date};function n(I,V){this.a=I,this.m=V||I,this.c=this.m.document}var s=!!window.FontFace;function a(I,V,te,se){if(V=I.c.createElement(V),te)for(var Ie in te)te.hasOwnProperty(Ie)&&(Ie=="style"?V.style.cssText=te[Ie]:V.setAttribute(Ie,te[Ie]));return se&&V.appendChild(I.c.createTextNode(se)),V}function l(I,V,te){I=I.c.getElementsByTagName(V)[0],I||(I=document.documentElement),I.insertBefore(te,I.lastChild)}function c(I){I.parentNode&&I.parentNode.removeChild(I)}function h(I,V,te){V=V||[],te=te||[];for(var se=I.className.split(/\s+/),Ie=0;Ie<V.length;Ie+=1){for(var Je=!1,Ve=0;Ve<se.length;Ve+=1)if(V[Ie]===se[Ve]){Je=!0;break}Je||se.push(V[Ie])}for(V=[],Ie=0;Ie<se.length;Ie+=1){for(Je=!1,Ve=0;Ve<te.length;Ve+=1)if(se[Ie]===te[Ve]){Je=!0;break}Je||V.push(se[Ie])}I.className=V.join(" ").replace(/\s+/g," ").replace(/^\s+|\s+$/,"")}function d(I,V){for(var te=I.className.split(/\s+/),se=0,Ie=te.length;se<Ie;se++)if(te[se]==V)return!0;return!1}function u(I){if(typeof I.f=="string")return I.f;var V=I.m.location.protocol;return V=="about:"&&(V=I.a.location.protocol),V=="https:"?"https:":"http:"}function f(I){return I.m.location.hostname||I.a.location.hostname}function p(I,V,te){function se(){kt&&Ie&&Je&&(kt(Ve),kt=null)}V=a(I,"link",{rel:"stylesheet",href:V,media:"all"});var Ie=!1,Je=!0,Ve=null,kt=te||null;s?(V.onload=function(){Ie=!0,se()},V.onerror=function(){Ie=!0,Ve=Error("Stylesheet failed to load"),se()}):setTimeout(function(){Ie=!0,se()},0),l(I,"head",V)}function m(I,V,te,se){var Ie=I.c.getElementsByTagName("head")[0];if(Ie){var Je=a(I,"script",{src:V}),Ve=!1;return Je.onload=Je.onreadystatechange=function(){Ve||this.readyState&&this.readyState!="loaded"&&this.readyState!="complete"||(Ve=!0,te&&te(null),Je.onload=Je.onreadystatechange=null,Je.parentNode.tagName=="HEAD"&&Ie.removeChild(Je))},Ie.appendChild(Je),setTimeout(function(){Ve||(Ve=!0,te&&te(Error("Script load timeout")))},se||5e3),Je}return null}function b(){this.a=0,this.c=null}function g(I){return I.a++,function(){I.a--,w(I)}}function x(I,V){I.c=V,w(I)}function w(I){I.a==0&&I.c&&(I.c(),I.c=null)}function C(I){this.a=I||"-"}C.prototype.c=function(I){for(var V=[],te=0;te<arguments.length;te++)V.push(arguments[te].replace(/[\W_]+/g,"").toLowerCase());return V.join(this.a)};function M(I,V){this.c=I,this.f=4,this.a="n";var te=(V||"n4").match(/^([nio])([1-9])$/i);te&&(this.a=te[1],this.f=parseInt(te[2],10))}function D(I){return $(I)+" "+(I.f+"00")+" 300px "+W(I.c)}function W(I){var V=[];I=I.split(/,\s*/);for(var te=0;te<I.length;te++){var se=I[te].replace(/['"]/g,"");se.indexOf(" ")!=-1||/^\d/.test(se)?V.push("'"+se+"'"):V.push(se)}return V.join(",")}function z(I){return I.a+I.f}function $(I){var V="normal";return I.a==="o"?V="oblique":I.a==="i"&&(V="italic"),V}function Z(I){var V=4,te="n",se=null;return I&&((se=I.match(/(normal|oblique|italic)/i))&&se[1]&&(te=se[1].substr(0,1).toLowerCase()),(se=I.match(/([1-9]00|normal|bold)/i))&&se[1]&&(/bold/i.test(se[1])?V=7:/[1-9]00/.test(se[1])&&(V=parseInt(se[1].substr(0,1),10)))),te+V}function ne(I,V){this.c=I,this.f=I.m.document.documentElement,this.h=V,this.a=new C("-"),this.j=V.events!==!1,this.g=V.classes!==!1}function Me(I){I.g&&h(I.f,[I.a.c("wf","loading")]),xe(I,"loading")}function Xe(I){if(I.g){var V=d(I.f,I.a.c("wf","active")),te=[],se=[I.a.c("wf","loading")];V||te.push(I.a.c("wf","inactive")),h(I.f,te,se)}xe(I,"inactive")}function xe(I,V,te){I.j&&I.h[V]&&(te?I.h[V](te.c,z(te)):I.h[V]())}function Le(){this.c={}}function B(I,V,te){var se=[],Ie;for(Ie in V)if(V.hasOwnProperty(Ie)){var Je=I.c[Ie];Je&&se.push(Je(V[Ie],te))}return se}function Y(I,V){this.c=I,this.f=V,this.a=a(this.c,"span",{"aria-hidden":"true"},this.f)}function re(I){l(I.c,"body",I.a)}function le(I){return"display:block;position:absolute;top:-9999px;left:-9999px;font-size:300px;width:auto;height:auto;line-height:normal;margin:0;padding:0;font-variant:normal;white-space:nowrap;font-family:"+W(I.c)+";"+("font-style:"+$(I)+";font-weight:"+(I.f+"00")+";")}function ge(I,V,te,se,Ie,Je){this.g=I,this.j=V,this.a=se,this.c=te,this.f=Ie||3e3,this.h=Je||void 0}ge.prototype.start=function(){var I=this.c.m.document,V=this,te=i(),se=new Promise(function(Je,Ve){function kt(){i()-te>=V.f?Ve():I.fonts.load(D(V.a),V.h).then(function(Wt){1<=Wt.length?Je():setTimeout(kt,25)},function(){Ve()})}kt()}),Ie=new Promise(function(Je,Ve){setTimeout(Ve,V.f)});Promise.race([Ie,se]).then(function(){V.g(V.a)},function(){V.j(V.a)})};function pe(I,V,te,se,Ie,Je,Ve){this.v=I,this.B=V,this.c=te,this.a=se,this.s=Ve||"BESbswy",this.f={},this.w=Ie||3e3,this.u=Je||null,this.o=this.j=this.h=this.g=null,this.g=new Y(this.c,this.s),this.h=new Y(this.c,this.s),this.j=new Y(this.c,this.s),this.o=new Y(this.c,this.s),I=new M(this.a.c+",serif",z(this.a)),I=le(I),this.g.a.style.cssText=I,I=new M(this.a.c+",sans-serif",z(this.a)),I=le(I),this.h.a.style.cssText=I,I=new M("serif",z(this.a)),I=le(I),this.j.a.style.cssText=I,I=new M("sans-serif",z(this.a)),I=le(I),this.o.a.style.cssText=I,re(this.g),re(this.h),re(this.j),re(this.o)}var Ae={D:"serif",C:"sans-serif"},Fe=null;function he(){if(Fe===null){var I=/AppleWebKit\/([0-9]+)(?:\.([0-9]+))/.exec(window.navigator.userAgent);Fe=!!I&&(536>parseInt(I[1],10)||parseInt(I[1],10)===536&&11>=parseInt(I[2],10))}return Fe}pe.prototype.start=function(){this.f.serif=this.j.a.offsetWidth,this.f["sans-serif"]=this.o.a.offsetWidth,this.A=i(),Ze(this)};function tt(I,V,te){for(var se in Ae)if(Ae.hasOwnProperty(se)&&V===I.f[Ae[se]]&&te===I.f[Ae[se]])return!0;return!1}function Ze(I){var V=I.g.a.offsetWidth,te=I.h.a.offsetWidth,se;(se=V===I.f.serif&&te===I.f["sans-serif"])||(se=he()&&tt(I,V,te)),se?i()-I.A>=I.w?he()&&tt(I,V,te)&&(I.u===null||I.u.hasOwnProperty(I.a.c))?U(I,I.v):U(I,I.B):N(I):U(I,I.v)}function N(I){setTimeout(e(function(){Ze(this)},I),50)}function U(I,V){setTimeout(e(function(){c(this.g.a),c(this.h.a),c(this.j.a),c(this.o.a),V(this.a)},I),0)}function k(I,V,te){this.c=I,this.a=V,this.f=0,this.o=this.j=!1,this.s=te}var X=null;k.prototype.g=function(I){var V=this.a;V.g&&h(V.f,[V.a.c("wf",I.c,z(I).toString(),"active")],[V.a.c("wf",I.c,z(I).toString(),"loading"),V.a.c("wf",I.c,z(I).toString(),"inactive")]),xe(V,"fontactive",I),this.o=!0,ve(this)},k.prototype.h=function(I){var V=this.a;if(V.g){var te=d(V.f,V.a.c("wf",I.c,z(I).toString(),"active")),se=[],Ie=[V.a.c("wf",I.c,z(I).toString(),"loading")];te||se.push(V.a.c("wf",I.c,z(I).toString(),"inactive")),h(V.f,se,Ie)}xe(V,"fontinactive",I),ve(this)};function ve(I){--I.f==0&&I.j&&(I.o?(I=I.a,I.g&&h(I.f,[I.a.c("wf","active")],[I.a.c("wf","loading"),I.a.c("wf","inactive")]),xe(I,"active")):Xe(I.a))}function De(I){this.j=I,this.a=new Le,this.h=0,this.f=this.g=!0}De.prototype.load=function(I){this.c=new n(this.j,I.context||this.j),this.g=I.events!==!1,this.f=I.classes!==!1,Ne(this,new ne(this.c,I),I)};function qe(I,V,te,se,Ie){var Je=--I.h==0;(I.f||I.g)&&setTimeout(function(){var Ve=Ie||null,kt=se||null||{};if(te.length===0&&Je)Xe(V.a);else{V.f+=te.length,Je&&(V.j=Je);var Wt,wi=[];for(Wt=0;Wt<te.length;Wt++){var ai=te[Wt],Di=kt[ai.c],ts=V.a,Br=ai;ts.g&&h(ts.f,[ts.a.c("wf",Br.c,z(Br).toString(),"loading")]),xe(ts,"fontloading",Br),ts=null,X===null&&(X=window.FontFace?(Br=/Gecko.*Firefox\/(\d+)/.exec(window.navigator.userAgent))?42<parseInt(Br[1],10):!0:!1),X?ts=new ge(e(V.g,V),e(V.h,V),V.c,ai,V.s,Di):ts=new pe(e(V.g,V),e(V.h,V),V.c,ai,V.s,Ve,Di),wi.push(ts)}for(Wt=0;Wt<wi.length;Wt++)wi[Wt].start()}},0)}function Ne(I,V,te){var Ie=[],se=te.timeout;Me(V);var Ie=B(I.a,te,I.c),Je=new k(I.c,V,se);for(I.h=Ie.length,V=0,te=Ie.length;V<te;V++)Ie[V].load(function(Ve,kt,Wt){qe(I,Je,Ve,kt,Wt)})}function me(I,V){this.c=I,this.a=V}function Ye(I,V,te){var se=u(I.c);return I=(I.a.api||"fast.fonts.net/jsapi").replace(/^.*http(s?):(\/\/)?/,""),se+"//"+I+"/"+V+".js"+(te?"?v="+te:"")}me.prototype.load=function(I){function V(){if(Je["__mti_fntLst"+se]){var Ve=Je["__mti_fntLst"+se](),kt=[],Wt;if(Ve)for(var wi=0;wi<Ve.length;wi++){var ai=Ve[wi].fontfamily;Ve[wi].fontStyle!=null&&Ve[wi].fontWeight!=null?(Wt=Ve[wi].fontStyle+Ve[wi].fontWeight,kt.push(new M(ai,Wt))):kt.push(new M(ai))}I(kt)}else setTimeout(function(){V()},50)}var te=this,se=te.a.projectId,Ie=te.a.version;if(se){var Je=te.c.m;m(this.c,Ye(te,se,Ie),function(Ve){Ve?I([]):(Je["__MonotypeConfiguration__"+se]=function(){return te.a},V())}).id="__MonotypeAPIScript__"+se}else I([])};function ue(I,V){this.c=I,this.a=V}ue.prototype.load=function(I){var V,te,se=this.a.urls||[],Ie=this.a.families||[],Je=this.a.testStrings||{},Ve=new b;for(V=0,te=se.length;V<te;V++)p(this.c,se[V],g(Ve));var kt=[];for(V=0,te=Ie.length;V<te;V++)if(se=Ie[V].split(":"),se[1])for(var Wt=se[1].split(","),wi=0;wi<Wt.length;wi+=1)kt.push(new M(se[0],Wt[wi]));else kt.push(new M(se[0]));x(Ve,function(){I(kt,Je)})};function Ee(I,V,te){I?this.c=I:this.c=V+Pe,this.a=[],this.f=[],this.g=te||""}var Pe="//fonts.googleapis.com/css";function He(I,V){for(var te=V.length,se=0;se<te;se++){var Ie=V[se].split(":");Ie.length==3&&I.f.push(Ie.pop());var Je="";Ie.length==2&&Ie[1]!=""&&(Je=":"),I.a.push(Ie.join(Je))}}function lt(I){if(I.a.length==0)throw Error("No fonts to load!");if(I.c.indexOf("kit=")!=-1)return I.c;for(var V=I.a.length,te=[],se=0;se<V;se++)te.push(I.a[se].replace(/ /g,"+"));return V=I.c+"?family="+te.join("%7C"),0<I.f.length&&(V+="&subset="+I.f.join(",")),0<I.g.length&&(V+="&text="+encodeURIComponent(I.g)),V}function Rt(I){this.f=I,this.a=[],this.c={}}var Et={latin:"BESbswy","latin-ext":"çöüğş",cyrillic:"йяЖ",greek:"αβΣ",khmer:"កខគ",Hanuman:"កខគ"},F={thin:"1",extralight:"2","extra-light":"2",ultralight:"2","ultra-light":"2",light:"3",regular:"4",book:"4",medium:"5","semi-bold":"6",semibold:"6","demi-bold":"6",demibold:"6",bold:"7","extra-bold":"8",extrabold:"8","ultra-bold":"8",ultrabold:"8",black:"9",heavy:"9",l:"3",r:"4",b:"7"},ee={i:"i",italic:"i",n:"n",normal:"n"},ze=/^(thin|(?:(?:extra|ultra)-?)?light|regular|book|medium|(?:(?:semi|demi|extra|ultra)-?)?bold|black|heavy|l|r|b|[1-9]00)?(n|i|normal|italic)?$/;function Lt(I){for(var V=I.f.length,te=0;te<V;te++){var se=I.f[te].split(":"),Ie=se[0].replace(/\+/g," "),Je=["n4"];if(2<=se.length){var Ve,kt=se[1];if(Ve=[],kt)for(var kt=kt.split(","),Wt=kt.length,wi=0;wi<Wt;wi++){var ai;if(ai=kt[wi],ai.match(/^[\w-]+$/)){var Di=ze.exec(ai.toLowerCase());if(Di==null)ai="";else{if(ai=Di[2],ai=ai==null||ai==""?"n":ee[ai],Di=Di[1],Di==null||Di=="")Di="4";else var ts=F[Di],Di=ts||(isNaN(Di)?"4":Di.substr(0,1));ai=[ai,Di].join("")}}else ai="";ai&&Ve.push(ai)}0<Ve.length&&(Je=Ve),se.length==3&&(se=se[2],Ve=[],se=se?se.split(","):Ve,0<se.length&&(se=Et[se[0]])&&(I.c[Ie]=se))}for(I.c[Ie]||(se=Et[Ie])&&(I.c[Ie]=se),se=0;se<Je.length;se+=1)I.a.push(new M(Ie,Je[se]))}}function Ht(I,V){this.c=I,this.a=V}var gt={Arimo:!0,Cousine:!0,Tinos:!0};Ht.prototype.load=function(I){var V=new b,te=this.c,se=new Ee(this.a.api,u(te),this.a.text),Ie=this.a.families;He(se,Ie);var Je=new Rt(Ie);Lt(Je),p(te,lt(se),g(V)),x(V,function(){I(Je.a,Je.c,gt)})};function Wi(I,V){this.c=I,this.a=V}Wi.prototype.load=function(I){var V=this.a.id,te=this.c.m;V?m(this.c,(this.a.api||"https://use.typekit.net")+"/"+V+".js",function(se){if(se)I([]);else if(te.Typekit&&te.Typekit.config&&te.Typekit.config.fn){se=te.Typekit.config.fn;for(var Ie=[],Je=0;Je<se.length;Je+=2)for(var Ve=se[Je],kt=se[Je+1],Wt=0;Wt<kt.length;Wt++)Ie.push(new M(Ve,kt[Wt]));try{te.Typekit.load({events:!1,classes:!1,async:!0})}catch(wi){}I(Ie)}},2e3):I([])};function Bi(I,V){this.c=I,this.f=V,this.a=[]}Bi.prototype.load=function(I){var V=this.f.id,te=this.c.m,se=this;V?(te.__webfontfontdeckmodule__||(te.__webfontfontdeckmodule__={}),te.__webfontfontdeckmodule__[V]=function(Ie,Je){for(var Ve=0,kt=Je.fonts.length;Ve<kt;++Ve){var Wt=Je.fonts[Ve];se.a.push(new M(Wt.name,Z("font-weight:"+Wt.weight+";font-style:"+Wt.style)))}I(se.a)},m(this.c,u(this.c)+(this.f.api||"//f.fontdeck.com/s/css/js/")+f(this.c)+"/"+V+".js",function(Ie){Ie&&I([])})):I([])};var Ii=new De(window);Ii.a.c.custom=function(I,V){return new ue(V,I)},Ii.a.c.fontdeck=function(I,V){return new Bi(V,I)},Ii.a.c.monotype=function(I,V){return new me(V,I)},Ii.a.c.typekit=function(I,V){return new Wi(V,I)},Ii.a.c.google=function(I,V){return new Ht(V,I)};var Be={load:e(Ii.load,Ii)};typeof define=="function"&&define.amd?define(function(){return Be}):typeof module!="undefined"&&module.exports?module.exports=Be:(window.WebFont=Be,window.WebFontConfig&&Ii.load(window.WebFontConfig))})();/**
 * @license
 * webxr-polyfill
 * Copyright (c) 2017 Google
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *//**
 * @license
 * cardboard-vr-display
 * Copyright (c) 2015-2017 Google
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *//**
 * @license
 * webvr-polyfill-dpdb 
 * Copyright (c) 2017 Google
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *//**
 * @license
 * wglu-preserve-state
 * Copyright (c) 2016, Brandon Jones.
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 *//**
 * @license
 * nosleep.js
 * Copyright (c) 2017, Rich Tibbett
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */(function(r,t){typeof exports=="object"&&typeof module!="undefined"?module.exports=t():typeof define=="function"&&define.amd?define(t):r.WebXRPolyfill=t()})(this,function(){"use strict";const r=typeof global!="undefined"?global:typeof self!="undefined"?self:typeof window!="undefined"?window:{},t=Symbol("@@webxr-polyfill/EventTarget");class e{constructor(){this[t]={listeners:new Map}}addEventListener(_,S){if(typeof _!="string")throw new Error("`type` must be a string");if(typeof S!="function")throw new Error("`listener` must be a function");const R=this[t].listeners.get(_)||[];R.push(S),this[t].listeners.set(_,R)}removeEventListener(_,S){if(typeof _!="string")throw new Error("`type` must be a string");if(typeof S!="function")throw new Error("`listener` must be a function");const R=this[t].listeners.get(_)||[];for(let G=R.length;G>=0;G--)R[G]===S&&R.pop()}dispatchEvent(_,S){const R=this[t].listeners.get(_)||[],G=[];for(let Q=0;Q<R.length;Q++)G[Q]=R[Q];for(let Q of G)Q(S);typeof this[`on${_}`]=="function"&&this[`on${_}`](S)}}const i=1e-6;let n=typeof Float32Array!="undefined"?Float32Array:Array;const s=Math.PI/180;function a(){let E=new n(16);return n!=Float32Array&&(E[1]=0,E[2]=0,E[3]=0,E[4]=0,E[6]=0,E[7]=0,E[8]=0,E[9]=0,E[11]=0,E[12]=0,E[13]=0,E[14]=0),E[0]=1,E[5]=1,E[10]=1,E[15]=1,E}function l(E,_){return E[0]=_[0],E[1]=_[1],E[2]=_[2],E[3]=_[3],E[4]=_[4],E[5]=_[5],E[6]=_[6],E[7]=_[7],E[8]=_[8],E[9]=_[9],E[10]=_[10],E[11]=_[11],E[12]=_[12],E[13]=_[13],E[14]=_[14],E[15]=_[15],E}function c(E){return E[0]=1,E[1]=0,E[2]=0,E[3]=0,E[4]=0,E[5]=1,E[6]=0,E[7]=0,E[8]=0,E[9]=0,E[10]=1,E[11]=0,E[12]=0,E[13]=0,E[14]=0,E[15]=1,E}function h(E,_){let S=_[0],R=_[1],G=_[2],Q=_[3],J=_[4],ae=_[5],Se=_[6],be=_[7],Qe=_[8],ht=_[9],jt=_[10],ei=_[11],fi=_[12],ti=_[13],Xt=_[14],Si=_[15],ln=S*ae-R*J,Ct=S*Se-G*J,Ft=S*be-Q*J,Gt=R*Se-G*ae,St=R*be-Q*ae,ks=G*be-Q*Se,mo=Qe*ti-ht*fi,_o=Qe*Xt-jt*fi,sa=Qe*Si-ei*fi,Nr=ht*Xt-jt*ti,go=ht*Si-ei*ti,Ur=jt*Si-ei*Xt,Li=ln*Ur-Ct*go+Ft*Nr+Gt*sa-St*_o+ks*mo;return Li?(Li=1/Li,E[0]=(ae*Ur-Se*go+be*Nr)*Li,E[1]=(G*go-R*Ur-Q*Nr)*Li,E[2]=(ti*ks-Xt*St+Si*Gt)*Li,E[3]=(jt*St-ht*ks-ei*Gt)*Li,E[4]=(Se*sa-J*Ur-be*_o)*Li,E[5]=(S*Ur-G*sa+Q*_o)*Li,E[6]=(Xt*Ft-fi*ks-Si*Ct)*Li,E[7]=(Qe*ks-jt*Ft+ei*Ct)*Li,E[8]=(J*go-ae*sa+be*mo)*Li,E[9]=(R*sa-S*go-Q*mo)*Li,E[10]=(fi*St-ti*Ft+Si*ln)*Li,E[11]=(ht*Ft-Qe*St-ei*ln)*Li,E[12]=(ae*_o-J*Nr-Se*mo)*Li,E[13]=(S*Nr-R*_o+G*mo)*Li,E[14]=(ti*Ct-fi*Gt-Xt*ln)*Li,E[15]=(Qe*Gt-ht*Ct+jt*ln)*Li,E):null}function d(E,_,S){let R=_[0],G=_[1],Q=_[2],J=_[3],ae=_[4],Se=_[5],be=_[6],Qe=_[7],ht=_[8],jt=_[9],ei=_[10],fi=_[11],ti=_[12],Xt=_[13],Si=_[14],ln=_[15],Ct=S[0],Ft=S[1],Gt=S[2],St=S[3];return E[0]=Ct*R+Ft*ae+Gt*ht+St*ti,E[1]=Ct*G+Ft*Se+Gt*jt+St*Xt,E[2]=Ct*Q+Ft*be+Gt*ei+St*Si,E[3]=Ct*J+Ft*Qe+Gt*fi+St*ln,Ct=S[4],Ft=S[5],Gt=S[6],St=S[7],E[4]=Ct*R+Ft*ae+Gt*ht+St*ti,E[5]=Ct*G+Ft*Se+Gt*jt+St*Xt,E[6]=Ct*Q+Ft*be+Gt*ei+St*Si,E[7]=Ct*J+Ft*Qe+Gt*fi+St*ln,Ct=S[8],Ft=S[9],Gt=S[10],St=S[11],E[8]=Ct*R+Ft*ae+Gt*ht+St*ti,E[9]=Ct*G+Ft*Se+Gt*jt+St*Xt,E[10]=Ct*Q+Ft*be+Gt*ei+St*Si,E[11]=Ct*J+Ft*Qe+Gt*fi+St*ln,Ct=S[12],Ft=S[13],Gt=S[14],St=S[15],E[12]=Ct*R+Ft*ae+Gt*ht+St*ti,E[13]=Ct*G+Ft*Se+Gt*jt+St*Xt,E[14]=Ct*Q+Ft*be+Gt*ei+St*Si,E[15]=Ct*J+Ft*Qe+Gt*fi+St*ln,E}function u(E,_,S){let R=_[0],G=_[1],Q=_[2],J=_[3],ae=R+R,Se=G+G,be=Q+Q,Qe=R*ae,ht=R*Se,jt=R*be,ei=G*Se,fi=G*be,ti=Q*be,Xt=J*ae,Si=J*Se,ln=J*be;return E[0]=1-(ei+ti),E[1]=ht+ln,E[2]=jt-Si,E[3]=0,E[4]=ht-ln,E[5]=1-(Qe+ti),E[6]=fi+Xt,E[7]=0,E[8]=jt+Si,E[9]=fi-Xt,E[10]=1-(Qe+ei),E[11]=0,E[12]=S[0],E[13]=S[1],E[14]=S[2],E[15]=1,E}function f(E,_){return E[0]=_[12],E[1]=_[13],E[2]=_[14],E}function p(E,_){let S=_[0]+_[5]+_[10],R=0;return S>0?(R=Math.sqrt(S+1)*2,E[3]=.25*R,E[0]=(_[6]-_[9])/R,E[1]=(_[8]-_[2])/R,E[2]=(_[1]-_[4])/R):_[0]>_[5]&&_[0]>_[10]?(R=Math.sqrt(1+_[0]-_[5]-_[10])*2,E[3]=(_[6]-_[9])/R,E[0]=.25*R,E[1]=(_[1]+_[4])/R,E[2]=(_[8]+_[2])/R):_[5]>_[10]?(R=Math.sqrt(1+_[5]-_[0]-_[10])*2,E[3]=(_[8]-_[2])/R,E[0]=(_[1]+_[4])/R,E[1]=.25*R,E[2]=(_[6]+_[9])/R):(R=Math.sqrt(1+_[10]-_[0]-_[5])*2,E[3]=(_[1]-_[4])/R,E[0]=(_[8]+_[2])/R,E[1]=(_[6]+_[9])/R,E[2]=.25*R),E}function m(E,_,S,R,G){let Q=1/Math.tan(_/2),J;return E[0]=Q/S,E[1]=0,E[2]=0,E[3]=0,E[4]=0,E[5]=Q,E[6]=0,E[7]=0,E[8]=0,E[9]=0,E[11]=-1,E[12]=0,E[13]=0,E[15]=0,G!=null&&G!==1/0?(J=1/(R-G),E[10]=(G+R)*J,E[14]=2*G*R*J):(E[10]=-1,E[14]=-2*R),E}function b(){let E=new n(3);return n!=Float32Array&&(E[0]=0,E[1]=0,E[2]=0),E}function g(E){var _=new n(3);return _[0]=E[0],_[1]=E[1],_[2]=E[2],_}function x(E){let _=E[0],S=E[1],R=E[2];return Math.sqrt(_*_+S*S+R*R)}function w(E,_,S){let R=new n(3);return R[0]=E,R[1]=_,R[2]=S,R}function C(E,_){return E[0]=_[0],E[1]=_[1],E[2]=_[2],E}function M(E,_,S){return E[0]=_[0]+S[0],E[1]=_[1]+S[1],E[2]=_[2]+S[2],E}function D(E,_,S){return E[0]=_[0]*S,E[1]=_[1]*S,E[2]=_[2]*S,E}function W(E,_){let S=_[0],R=_[1],G=_[2],Q=S*S+R*R+G*G;return Q>0&&(Q=1/Math.sqrt(Q),E[0]=_[0]*Q,E[1]=_[1]*Q,E[2]=_[2]*Q),E}function z(E,_){return E[0]*_[0]+E[1]*_[1]+E[2]*_[2]}function $(E,_,S){let R=_[0],G=_[1],Q=_[2],J=S[0],ae=S[1],Se=S[2];return E[0]=G*Se-Q*ae,E[1]=Q*J-R*Se,E[2]=R*ae-G*J,E}function Z(E,_,S){let R=S[0],G=S[1],Q=S[2],J=S[3],ae=_[0],Se=_[1],be=_[2],Qe=G*be-Q*Se,ht=Q*ae-R*be,jt=R*Se-G*ae,ei=G*jt-Q*ht,fi=Q*Qe-R*jt,ti=R*ht-G*Qe,Xt=J*2;return Qe*=Xt,ht*=Xt,jt*=Xt,ei*=2,fi*=2,ti*=2,E[0]=ae+Qe+ei,E[1]=Se+ht+fi,E[2]=be+jt+ti,E}function ne(E,_){let S=w(E[0],E[1],E[2]),R=w(_[0],_[1],_[2]);W(S,S),W(R,R);let G=z(S,R);return G>1?0:G<-1?Math.PI:Math.acos(G)}const Me=x,Xe=function(){let E=b();return function(_,S,R,G,Q,J){let ae,Se;for(S||(S=3),R||(R=0),G?Se=Math.min(G*S+R,_.length):Se=_.length,ae=R;ae<Se;ae+=S)E[0]=_[ae],E[1]=_[ae+1],E[2]=_[ae+2],Q(E,E,J),_[ae]=E[0],_[ae+1]=E[1],_[ae+2]=E[2];return _}}();function xe(){let E=new n(9);return n!=Float32Array&&(E[1]=0,E[2]=0,E[3]=0,E[5]=0,E[6]=0,E[7]=0),E[0]=1,E[4]=1,E[8]=1,E}function Le(){let E=new n(4);return n!=Float32Array&&(E[0]=0,E[1]=0,E[2]=0,E[3]=0),E}function B(E){let _=new n(4);return _[0]=E[0],_[1]=E[1],_[2]=E[2],_[3]=E[3],_}function Y(E,_,S,R){let G=new n(4);return G[0]=E,G[1]=_,G[2]=S,G[3]=R,G}function re(E,_){return E[0]=_[0],E[1]=_[1],E[2]=_[2],E[3]=_[3],E}function le(E,_){let S=_[0],R=_[1],G=_[2],Q=_[3],J=S*S+R*R+G*G+Q*Q;return J>0&&(J=1/Math.sqrt(J),E[0]=S*J,E[1]=R*J,E[2]=G*J,E[3]=Q*J),E}const ge=function(){let E=Le();return function(_,S,R,G,Q,J){let ae,Se;for(S||(S=4),R||(R=0),G?Se=Math.min(G*S+R,_.length):Se=_.length,ae=R;ae<Se;ae+=S)E[0]=_[ae],E[1]=_[ae+1],E[2]=_[ae+2],E[3]=_[ae+3],Q(E,E,J),_[ae]=E[0],_[ae+1]=E[1],_[ae+2]=E[2],_[ae+3]=E[3];return _}}();function pe(){let E=new n(4);return n!=Float32Array&&(E[0]=0,E[1]=0,E[2]=0),E[3]=1,E}function Ae(E,_,S){S=S*.5;let R=Math.sin(S);return E[0]=R*_[0],E[1]=R*_[1],E[2]=R*_[2],E[3]=Math.cos(S),E}function Fe(E,_,S){let R=_[0],G=_[1],Q=_[2],J=_[3],ae=S[0],Se=S[1],be=S[2],Qe=S[3];return E[0]=R*Qe+J*ae+G*be-Q*Se,E[1]=G*Qe+J*Se+Q*ae-R*be,E[2]=Q*Qe+J*be+R*Se-G*ae,E[3]=J*Qe-R*ae-G*Se-Q*be,E}function he(E,_,S,R){let G=_[0],Q=_[1],J=_[2],ae=_[3],Se=S[0],be=S[1],Qe=S[2],ht=S[3],jt,ei,fi,ti,Xt;return ei=G*Se+Q*be+J*Qe+ae*ht,ei<0&&(ei=-ei,Se=-Se,be=-be,Qe=-Qe,ht=-ht),1-ei>i?(jt=Math.acos(ei),fi=Math.sin(jt),ti=Math.sin((1-R)*jt)/fi,Xt=Math.sin(R*jt)/fi):(ti=1-R,Xt=R),E[0]=ti*G+Xt*Se,E[1]=ti*Q+Xt*be,E[2]=ti*J+Xt*Qe,E[3]=ti*ae+Xt*ht,E}function tt(E,_){let S=_[0],R=_[1],G=_[2],Q=_[3],J=S*S+R*R+G*G+Q*Q,ae=J?1/J:0;return E[0]=-S*ae,E[1]=-R*ae,E[2]=-G*ae,E[3]=Q*ae,E}function Ze(E,_){let S=_[0]+_[4]+_[8],R;if(S>0)R=Math.sqrt(S+1),E[3]=.5*R,R=.5/R,E[0]=(_[5]-_[7])*R,E[1]=(_[6]-_[2])*R,E[2]=(_[1]-_[3])*R;else{let G=0;_[4]>_[0]&&(G=1),_[8]>_[G*3+G]&&(G=2);let Q=(G+1)%3,J=(G+2)%3;R=Math.sqrt(_[G*3+G]-_[Q*3+Q]-_[J*3+J]+1),E[G]=.5*R,R=.5/R,E[3]=(_[Q*3+J]-_[J*3+Q])*R,E[Q]=(_[Q*3+G]+_[G*3+Q])*R,E[J]=(_[J*3+G]+_[G*3+J])*R}return E}function N(E,_,S,R){let G=.5*Math.PI/180;_*=G,S*=G,R*=G;let Q=Math.sin(_),J=Math.cos(_),ae=Math.sin(S),Se=Math.cos(S),be=Math.sin(R),Qe=Math.cos(R);return E[0]=Q*Se*Qe-J*ae*be,E[1]=J*ae*Qe+Q*Se*be,E[2]=J*Se*be-Q*ae*Qe,E[3]=J*Se*Qe+Q*ae*be,E}const U=B,k=Y,X=re,ve=le,De=function(){let E=b(),_=w(1,0,0),S=w(0,1,0);return function(R,G,Q){let J=z(G,Q);return J<-.999999?($(E,_,G),Me(E)<1e-6&&$(E,S,G),W(E,E),Ae(R,E,Math.PI),R):J>.999999?(R[0]=0,R[1]=0,R[2]=0,R[3]=1,R):($(E,G,Q),R[0]=E[0],R[1]=E[1],R[2]=E[2],R[3]=1+J,ve(R,R))}}(),qe=function(){let E=pe(),_=pe();return function(S,R,G,Q,J,ae){return he(E,R,J,ae),he(_,G,Q,ae),he(S,E,_,2*ae*(1-ae)),S}}(),Ne=function(){let E=xe();return function(_,S,R,G){return E[0]=R[0],E[3]=R[1],E[6]=R[2],E[1]=G[0],E[4]=G[1],E[7]=G[2],E[2]=-S[0],E[5]=-S[1],E[8]=-S[2],ve(_,Ze(_,E))}}();if(!("DOMPointReadOnly"in window)){const E=Symbol("@@webxr-polyfill/DOMPointReadOnly");window.DOMPointReadOnly=class nb{constructor(S,R,G,Q){if(arguments.length===1)this[E]={x:S.x,y:S.y,z:S.z,w:S.w};else if(arguments.length===4)this[E]={x:S,y:R,z:G,w:Q};else throw new TypeError("Must supply either 1 or 4 arguments")}get x(){return this[E].x}get y(){return this[E].y}get z(){return this[E].z}get w(){return this[E].w}static fromPoint(S){return new nb(S.x,S.y,S.z,S.w)}}}const me=Symbol("@@webxr-polyfill/XRRigidTransform");class Ye{constructor(){if(this[me]={matrix:null,position:null,orientation:null,inverse:null},arguments.length===0)this[me].matrix=c(new Float32Array(16));else if(arguments.length===1)arguments[0]instanceof Float32Array?this[me].matrix=arguments[0]:(this[me].position=this._getPoint(arguments[0]),this[me].orientation=DOMPointReadOnly.fromPoint({x:0,y:0,z:0,w:1}));else if(arguments.length===2)this[me].position=this._getPoint(arguments[0]),this[me].orientation=this._getPoint(arguments[1]);else throw new Error("Too many arguments!");if(this[me].matrix){let _=b();f(_,this[me].matrix),this[me].position=DOMPointReadOnly.fromPoint({x:_[0],y:_[1],z:_[2]});let S=pe();p(S,this[me].matrix),this[me].orientation=DOMPointReadOnly.fromPoint({x:S[0],y:S[1],z:S[2],w:S[3]})}else this[me].matrix=c(new Float32Array(16)),u(this[me].matrix,k(this[me].orientation.x,this[me].orientation.y,this[me].orientation.z,this[me].orientation.w),w(this[me].position.x,this[me].position.y,this[me].position.z))}_getPoint(_){return _ instanceof DOMPointReadOnly?_:DOMPointReadOnly.fromPoint(_)}get matrix(){return this[me].matrix}get position(){return this[me].position}get orientation(){return this[me].orientation}get inverse(){if(this[me].inverse===null){let _=c(new Float32Array(16));h(_,this[me].matrix),this[me].inverse=new Ye(_),this[me].inverse[me].inverse=this}return this[me].inverse}}const ue=Symbol("@@webxr-polyfill/XRSpace");class Ee{constructor(_=null,S=null){this[ue]={specialType:_,inputSource:S,baseMatrix:null,inverseBaseMatrix:null,lastFrameId:-1}}get _specialType(){return this[ue].specialType}get _inputSource(){return this[ue].inputSource}_ensurePoseUpdated(_,S){S!=this[ue].lastFrameId&&(this[ue].lastFrameId=S,this._onPoseUpdate(_))}_onPoseUpdate(_){this[ue].specialType=="viewer"&&(this._baseMatrix=_.getBasePoseMatrix())}set _baseMatrix(_){this[ue].baseMatrix=_,this[ue].inverseBaseMatrix=null}get _baseMatrix(){return this[ue].baseMatrix||this[ue].inverseBaseMatrix&&(this[ue].baseMatrix=new Float32Array(16),h(this[ue].baseMatrix,this[ue].inverseBaseMatrix)),this[ue].baseMatrix}set _inverseBaseMatrix(_){this[ue].inverseBaseMatrix=_,this[ue].baseMatrix=null}get _inverseBaseMatrix(){return this[ue].inverseBaseMatrix||this[ue].baseMatrix&&(this[ue].inverseBaseMatrix=new Float32Array(16),h(this[ue].inverseBaseMatrix,this[ue].baseMatrix)),this[ue].inverseBaseMatrix}_getSpaceRelativeTransform(_){if(!this._inverseBaseMatrix||!_._baseMatrix)return null;let S=new Float32Array(16);return d(S,this._inverseBaseMatrix,_._baseMatrix),new Ye(S)}}const Pe=1.6,He=Symbol("@@webxr-polyfill/XRReferenceSpace"),lt=["viewer","local","local-floor","bounded-floor","unbounded"];function Rt(E){return E==="bounded-floor"||E==="local-floor"}class Et extends Ee{constructor(_,S=null){if(!lt.includes(_))throw new Error(`XRReferenceSpaceType must be one of ${lt}`);if(super(_),_==="bounded-floor"&&!S)throw new Error("XRReferenceSpace cannot use 'bounded-floor' type if the platform does not provide the floor level");Rt(_)&&!S&&(S=c(new Float32Array(16)),S[13]=Pe),this._inverseBaseMatrix=S||c(new Float32Array(16)),this[He]={type:_,transform:S,originOffset:c(new Float32Array(16))}}_transformBasePoseMatrix(_,S){d(_,this._inverseBaseMatrix,S)}_originOffsetMatrix(){return this[He].originOffset}_adjustForOriginOffset(_){let S=new Float32Array(16);h(S,this[He].originOffset),d(_,S,_)}_getSpaceRelativeTransform(_){let S=super._getSpaceRelativeTransform(_);return this._adjustForOriginOffset(S.matrix),new XRRigidTransform(S.matrix)}getOffsetReferenceSpace(_){let S=new Et(this[He].type,this[He].transform,this[He].bounds);return d(S[He].originOffset,this[He].originOffset,_.matrix),S}}const F=Symbol("@@webxr-polyfill/XR"),ee=["inline","immersive-vr","immersive-ar"],ze={inline:{requiredFeatures:["viewer"],optionalFeatures:[]},"immersive-vr":{requiredFeatures:["viewer","local"],optionalFeatures:[]},"immersive-ar":{requiredFeatures:["viewer","local"],optionalFeatures:[]}},Lt=`Polyfill Error: Must call navigator.xr.isSessionSupported() with any XRSessionMode
  or navigator.xr.requestSession('inline') prior to requesting an immersive
  session. This is a limitation specific to the WebXR Polyfill and does not apply
  to native implementations of the API.`;class Ht extends e{constructor(_){super(),this[F]={device:null,devicePromise:_,immersiveSession:null,inlineSessions:new Set},_.then(S=>{this[F].device=S})}isSessionSupported(_){return $t(this,null,function*(){return this[F].device||(yield this[F].devicePromise),_!="inline"?Promise.resolve(this[F].device.isSessionSupported(_)):Promise.resolve(!0)})}requestSession(_,S){return $t(this,null,function*(){if(!this[F].device){if(_!="inline")throw new Error(Lt);yield this[F].devicePromise}if(!ee.includes(_))throw new TypeError(`The provided value '${_}' is not a valid enum value of type XRSessionMode`);const R=ze[_],G=R.requiredFeatures.concat(S&&S.requiredFeatures?S.requiredFeatures:[]),Q=R.optionalFeatures.concat(S&&S.optionalFeatures?S.optionalFeatures:[]),J=new Set;let ae=!1;for(let ht of G)this[F].device.isFeatureSupported(ht)?J.add(ht):(console.error(`The required feature '${ht}' is not supported`),ae=!0);if(ae)throw new DOMException("Session does not support some required features","NotSupportedError");for(let ht of Q)this[F].device.isFeatureSupported(ht)?J.add(ht):console.log(`The optional feature '${ht}' is not supported`);const Se=yield this[F].device.requestSession(_,J),be=new XRSession(this[F].device,_,Se);_=="inline"?this[F].inlineSessions.add(be):this[F].immersiveSession=be;const Qe=()=>{_=="inline"?this[F].inlineSessions.delete(be):this[F].immersiveSession=null,be.removeEventListener("end",Qe)};return be.addEventListener("end",Qe),be})}}let gt;if("performance"in r)gt=()=>performance.now();else{let E=Date.now();gt=()=>Date.now()-E}var Wi=gt;const Bi=Symbol("@@webxr-polyfill/XRPose");class Ii{constructor(_,S){this[Bi]={transform:_,emulatedPosition:S}}get transform(){return this[Bi].transform}get emulatedPosition(){return this[Bi].emulatedPosition}}const Be=Symbol("@@webxr-polyfill/XRViewerPose");class I extends Ii{constructor(_,S,R=!1){super(_,R),this[Be]={views:S}}get views(){return this[Be].views}}const V=Symbol("@@webxr-polyfill/XRViewport");class te{constructor(_){this[V]={target:_}}get x(){return this[V].target.x}get y(){return this[V].target.y}get width(){return this[V].target.width}get height(){return this[V].target.height}}const se=["left","right","none"],Ie=Symbol("@@webxr-polyfill/XRView");class Je{constructor(_,S,R,G){if(!se.includes(R))throw new Error(`XREye must be one of: ${se}`);const Q=Object.create(null),J=new te(Q);this[Ie]={device:_,eye:R,viewport:J,temp:Q,sessionId:G,transform:S}}get eye(){return this[Ie].eye}get projectionMatrix(){return this[Ie].device.getProjectionMatrix(this.eye)}get transform(){return this[Ie].transform}_getViewport(_){if(this[Ie].device.getViewport(this[Ie].sessionId,this.eye,_,this[Ie].temp))return this[Ie].viewport}}const Ve=Symbol("@@webxr-polyfill/XRFrame"),kt="XRFrame access outside the callback that produced it is invalid.",Wt="getViewerPose can only be called on XRFrame objects passed to XRSession.requestAnimationFrame callbacks.";let wi=0;class ai{constructor(_,S,R){this[Ve]={id:++wi,active:!1,animationFrame:!1,device:_,session:S,sessionId:R}}get session(){return this[Ve].session}getViewerPose(_){if(!this[Ve].animationFrame)throw new DOMException(Wt,"InvalidStateError");if(!this[Ve].active)throw new DOMException(kt,"InvalidStateError");const S=this[Ve].device,R=this[Ve].session;R[ce].viewerSpace._ensurePoseUpdated(S,this[Ve].id),_._ensurePoseUpdated(S,this[Ve].id);let G=_._getSpaceRelativeTransform(R[ce].viewerSpace);const Q=[];for(let ae of R[ce].viewSpaces){ae._ensurePoseUpdated(S,this[Ve].id);let Se=_._getSpaceRelativeTransform(ae),be=new Je(S,Se,ae.eye,this[Ve].sessionId);Q.push(be)}return new I(G,Q,!1)}getPose(_,S){if(!this[Ve].active)throw new DOMException(kt,"InvalidStateError");const R=this[Ve].device;if(_._specialType==="target-ray"||_._specialType==="grip")return R.getInputPose(_._inputSource,S,_._specialType);{_._ensurePoseUpdated(R,this[Ve].id),S._ensurePoseUpdated(R,this[Ve].id);let G=S._getSpaceRelativeTransform(_);return G?new XRPose(G,!1):null}}}const Di=Symbol("@@webxr-polyfill/XRRenderState"),ts=Object.freeze({depthNear:.1,depthFar:1e3,inlineVerticalFieldOfView:null,baseLayer:null});class Br{constructor(_={}){const S=Object.assign({},ts,_);this[Di]={config:S}}get depthNear(){return this[Di].config.depthNear}get depthFar(){return this[Di].config.depthFar}get inlineVerticalFieldOfView(){return this[Di].config.inlineVerticalFieldOfView}get baseLayer(){return this[Di].config.baseLayer}}const R0=Symbol("@@webxr-polyfill/polyfilled-xr-compatible"),rp=Symbol("@@webxr-polyfill/xr-compatible"),na=Symbol("@@webxr-polyfill/XRWebGLLayer"),NP=Object.freeze({antialias:!0,depth:!1,stencil:!1,alpha:!0,multiview:!1,ignoreDepthValues:!1,framebufferScaleFactor:1});class UP{constructor(_,S,R={}){const G=Object.assign({},NP,R);if(!(_ instanceof D0))throw new Error("session must be a XRSession");if(_.ended)throw new Error("InvalidStateError");if(S[R0]&&S[rp]!==!0)throw new Error("InvalidStateError");const Q=S.getParameter(S.FRAMEBUFFER_BINDING);this[na]={context:S,config:G,framebuffer:Q,session:_}}get context(){return this[na].context}get antialias(){return this[na].config.antialias}get ignoreDepthValues(){return!0}get framebuffer(){return this[na].framebuffer}get framebufferWidth(){return this[na].context.drawingBufferWidth}get framebufferHeight(){return this[na].context.drawingBufferHeight}get _session(){return this[na].session}getViewport(_){return _._getViewport(this)}static getNativeFramebufferScaleFactor(_){if(!_)throw new TypeError("getNativeFramebufferScaleFactor must be passed a session.");return _[ce].ended?0:1}}const op=Symbol("@@webxr-polyfill/XRInputSourceEvent");function ap(E,_){const S=new Event(E,_);return S[op]={frame:_.frame,inputSource:_.inputSource},Object.setPrototypeOf(S,ap.prototype),Object.defineProperty(S,"frame",{get(){return this[op].frame}}),Object.defineProperty(S,"inputSource",{get(){return this[op].inputSource}}),S}const I0=Symbol("@@webxr-polyfill/XRSessionEvent");function bd(E,_){const S=new Event(E,_);return S[I0]={session:_.session},Object.setPrototypeOf(S,bd.prototype),Object.defineProperty(S,"session",{get(){return this[I0].session}}),S}const yd=Symbol("@@webxr-polyfill/XRInputSourcesChangeEvent");function lp(E,_){const S=new Event(E,_);return S[yd]={session:_.session,added:_.added,removed:_.removed},Object.setPrototypeOf(S,lp.prototype),Object.defineProperty(S,"session",{get(){return this[yd].session}}),Object.defineProperty(S,"added",{get(){return this[yd].added}}),Object.defineProperty(S,"removed",{get(){return this[yd].removed}}),S}const ce=Symbol("@@webxr-polyfill/XRSession");class cp extends Ee{constructor(_){super(_)}get eye(){return this._specialType}_onPoseUpdate(_){this._inverseBaseMatrix=_.getBaseViewMatrix(this._specialType)}}class D0 extends e{constructor(_,S,R){super();let G=S!="inline",Q=new Br({inlineVerticalFieldOfView:G?null:Math.PI*.5});this[ce]={device:_,mode:S,immersive:G,ended:!1,suspended:!1,frameCallbacks:[],currentFrameCallbacks:null,frameHandle:0,deviceFrameHandle:null,id:R,activeRenderState:Q,pendingRenderState:null,viewerSpace:new Et("viewer"),viewSpaces:[],currentInputSources:[]},G?this[ce].viewSpaces.push(new cp("left"),new cp("right")):this[ce].viewSpaces.push(new cp("none")),this[ce].onDeviceFrame=()=>{if(this[ce].ended||this[ce].suspended||(this[ce].deviceFrameHandle=null,this[ce].startDeviceFrameLoop(),this[ce].pendingRenderState!==null&&(this[ce].activeRenderState=new Br(this[ce].pendingRenderState),this[ce].pendingRenderState=null,this[ce].activeRenderState.baseLayer&&this[ce].device.onBaseLayerSet(this[ce].id,this[ce].activeRenderState.baseLayer)),this[ce].activeRenderState.baseLayer===null))return;const J=new ai(_,this,this[ce].id),ae=this[ce].currentFrameCallbacks=this[ce].frameCallbacks;this[ce].frameCallbacks=[],J[Ve].active=!0,J[Ve].animationFrame=!0,this[ce].device.onFrameStart(this[ce].id,this[ce].activeRenderState),this._checkInputSourcesChange();const Se=Wi();for(let be=0;be<ae.length;be++)try{!ae[be].cancelled&&typeof ae[be].callback=="function"&&ae[be].callback(Se,J)}catch(Qe){console.error(Qe)}this[ce].currentFrameCallbacks=null,J[Ve].active=!1,this[ce].device.onFrameEnd(this[ce].id)},this[ce].startDeviceFrameLoop=()=>{this[ce].deviceFrameHandle===null&&(this[ce].deviceFrameHandle=this[ce].device.requestAnimationFrame(this[ce].onDeviceFrame))},this[ce].stopDeviceFrameLoop=()=>{const J=this[ce].deviceFrameHandle;J!==null&&(this[ce].device.cancelAnimationFrame(J),this[ce].deviceFrameHandle=null)},this[ce].onPresentationEnd=J=>{if(J!==this[ce].id){this[ce].suspended=!1,this[ce].startDeviceFrameLoop(),this.dispatchEvent("focus",{session:this});return}this[ce].ended=!0,this[ce].stopDeviceFrameLoop(),_.removeEventListener("@@webxr-polyfill/vr-present-end",this[ce].onPresentationEnd),_.removeEventListener("@@webxr-polyfill/vr-present-start",this[ce].onPresentationStart),_.removeEventListener("@@webxr-polyfill/input-select-start",this[ce].onSelectStart),_.removeEventListener("@@webxr-polyfill/input-select-end",this[ce].onSelectEnd),this.dispatchEvent("end",bd("end",{session:this}))},_.addEventListener("@@webxr-polyfill/vr-present-end",this[ce].onPresentationEnd),this[ce].onPresentationStart=J=>{J!==this[ce].id&&(this[ce].suspended=!0,this[ce].stopDeviceFrameLoop(),this.dispatchEvent("blur",{session:this}))},_.addEventListener("@@webxr-polyfill/vr-present-start",this[ce].onPresentationStart),this[ce].onSelectStart=J=>{J.sessionId===this[ce].id&&this[ce].dispatchInputSourceEvent("selectstart",J.inputSource)},_.addEventListener("@@webxr-polyfill/input-select-start",this[ce].onSelectStart),this[ce].onSelectEnd=J=>{J.sessionId===this[ce].id&&(this[ce].dispatchInputSourceEvent("selectend",J.inputSource),this[ce].dispatchInputSourceEvent("select",J.inputSource))},_.addEventListener("@@webxr-polyfill/input-select-end",this[ce].onSelectEnd),this[ce].onSqueezeStart=J=>{J.sessionId===this[ce].id&&this[ce].dispatchInputSourceEvent("squeezestart",J.inputSource)},_.addEventListener("@@webxr-polyfill/input-squeeze-start",this[ce].onSqueezeStart),this[ce].onSqueezeEnd=J=>{J.sessionId===this[ce].id&&(this[ce].dispatchInputSourceEvent("squeezeend",J.inputSource),this[ce].dispatchInputSourceEvent("squeeze",J.inputSource))},_.addEventListener("@@webxr-polyfill/input-squeeze-end",this[ce].onSqueezeEnd),this[ce].dispatchInputSourceEvent=(J,ae)=>{const Se=new ai(_,this,this[ce].id),be=ap(J,{frame:Se,inputSource:ae});Se[Ve].active=!0,this.dispatchEvent(J,be),Se[Ve].active=!1},this[ce].startDeviceFrameLoop(),this.onblur=void 0,this.onfocus=void 0,this.onresetpose=void 0,this.onend=void 0,this.onselect=void 0,this.onselectstart=void 0,this.onselectend=void 0}get renderState(){return this[ce].activeRenderState}get environmentBlendMode(){return this[ce].device.environmentBlendMode||"opaque"}requestReferenceSpace(_){return $t(this,null,function*(){if(this[ce].ended)return;if(!lt.includes(_))throw new TypeError(`XRReferenceSpaceType must be one of ${lt}`);if(!this[ce].device.doesSessionSupportReferenceSpace(this[ce].id,_))throw new DOMException(`The ${_} reference space is not supported by this session.`,"NotSupportedError");if(_==="viewer")return this[ce].viewerSpace;let S=yield this[ce].device.requestFrameOfReferenceTransform(_);if(_==="bounded-floor")throw S?this[ce].device.requestStageBounds()?new DOMException(`The WebXR polyfill does not support the ${_} reference space yet.`,"NotSupportedError"):new DOMException(`${_} XRReferenceSpace not supported by this device.`,"NotSupportedError"):new DOMException(`${_} XRReferenceSpace not supported by this device.`,"NotSupportedError");return new Et(_,S)})}requestAnimationFrame(_){if(this[ce].ended)return;const S=++this[ce].frameHandle;return this[ce].frameCallbacks.push({handle:S,callback:_,cancelled:!1}),S}cancelAnimationFrame(_){let S=this[ce].frameCallbacks,R=S.findIndex(G=>G&&G.handle===_);R>-1&&(S[R].cancelled=!0,S.splice(R,1)),S=this[ce].currentFrameCallbacks,S&&(R=S.findIndex(G=>G&&G.handle===_),R>-1&&(S[R].cancelled=!0))}get inputSources(){return this[ce].device.getInputSources()}end(){return $t(this,null,function*(){if(!this[ce].ended)return this[ce].immersive&&(this[ce].ended=!0,this[ce].device.removeEventListener("@@webxr-polyfill/vr-present-start",this[ce].onPresentationStart),this[ce].device.removeEventListener("@@webxr-polyfill/vr-present-end",this[ce].onPresentationEnd),this[ce].device.removeEventListener("@@webxr-polyfill/input-select-start",this[ce].onSelectStart),this[ce].device.removeEventListener("@@webxr-polyfill/input-select-end",this[ce].onSelectEnd),this.dispatchEvent("end",bd("end",{session:this}))),this[ce].stopDeviceFrameLoop(),this[ce].device.endSession(this[ce].id)})}updateRenderState(_){if(this[ce].ended){const R="Can't call updateRenderState on an XRSession that has already ended.";throw new Error(R)}if(_.baseLayer&&_.baseLayer._session!==this){const R="Called updateRenderState with a base layer that was created by a different session.";throw new Error(R)}if(_.inlineVerticalFieldOfView!==null&&_.inlineVerticalFieldOfView!==void 0)if(this[ce].immersive){const R="inlineVerticalFieldOfView must not be set for an XRRenderState passed to updateRenderState for an immersive session.";throw new Error(R)}else _.inlineVerticalFieldOfView=Math.min(3.13,Math.max(.01,_.inlineVerticalFieldOfView));if(this[ce].pendingRenderState===null){const R=this[ce].activeRenderState;this[ce].pendingRenderState={depthNear:R.depthNear,depthFar:R.depthFar,inlineVerticalFieldOfView:R.inlineVerticalFieldOfView,baseLayer:R.baseLayer}}Object.assign(this[ce].pendingRenderState,_)}_checkInputSourcesChange(){const _=[],S=[],R=this.inputSources,G=this[ce].currentInputSources;for(const Q of R)G.includes(Q)||_.push(Q);for(const Q of G)R.includes(Q)||S.push(Q);(_.length>0||S.length>0)&&this.dispatchEvent("inputsourceschange",lp("inputsourceschange",{session:this,added:_,removed:S})),this[ce].currentInputSources.length=0;for(const Q of R)this[ce].currentInputSources.push(Q)}}const po=Symbol("@@webxr-polyfill/XRInputSource");class L0{constructor(_){this[po]={impl:_,gripSpace:new Ee("grip",this),targetRaySpace:new Ee("target-ray",this)}}get handedness(){return this[po].impl.handedness}get targetRayMode(){return this[po].impl.targetRayMode}get gripSpace(){let _=this[po].impl.targetRayMode;return _==="gaze"||_==="screen"?null:this[po].gripSpace}get targetRaySpace(){return this[po].targetRaySpace}get profiles(){return this[po].impl.profiles}get gamepad(){return this[po].impl.gamepad}}const hp=Symbol("@@webxr-polyfill/XRReferenceSpaceEvent");function O0(E,_){const S=new Event(E,_);return S[hp]={referenceSpace:_.referenceSpace,transform:_.transform||null},Object.setPrototypeOf(S,O0.prototype),Object.defineProperty(S,"referenceSpace",{get(){return this[hp].referenceSpace}}),Object.defineProperty(S,"transform",{get(){return this[hp].transform}}),S}var dp={XRSystem:Ht,XRSession:D0,XRSessionEvent:bd,XRFrame:ai,XRView:Je,XRViewport:te,XRViewerPose:I,XRWebGLLayer:UP,XRSpace:Ee,XRReferenceSpace:Et,XRReferenceSpaceEvent:O0,XRInputSource:L0,XRInputSourceEvent:ap,XRInputSourcesChangeEvent:lp,XRRenderState:Br,XRRigidTransform:Ye,XRPose:Ii};const F0=E=>typeof E.prototype.makeXRCompatible=="function"?!1:(E.prototype.makeXRCompatible=function(){return this[rp]=!0,Promise.resolve()},!0),B0=E=>{const _=E.prototype.getContext;E.prototype.getContext=function(S,R){const G=_.call(this,S,R);return G&&(G[R0]=!0,R&&"xrCompatible"in R&&(G[rp]=R.xrCompatible)),G}},kP=E=>!!(E.ImageBitmapRenderingContext&&E.createImageBitmap),VP=E=>{var _=!1;return function(S){(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(S)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(S.substr(0,4)))&&(_=!0)}(E.navigator.userAgent||E.navigator.vendor||E.opera),_},zP=E=>{E.style.display="block",E.style.position="absolute",E.style.width=E.style.height="1px",E.style.top=E.style.left="0px"};var up=typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{};function GP(E){return E&&E.__esModule&&Object.prototype.hasOwnProperty.call(E,"default")?E.default:E}function HP(E,_){return _={exports:{}},E(_,_.exports),_.exports}var WP=HP(function(E,_){(function(S,R){E.exports=R()})(up,function(){var S=function(v,y){if(!(v instanceof y))throw new TypeError("Cannot call a class as a function")},R=function(){function v(y,A){for(var P=0;P<A.length;P++){var O=A[P];O.enumerable=O.enumerable||!1,O.configurable=!0,"value"in O&&(O.writable=!0),Object.defineProperty(y,O.key,O)}}return function(y,A,P){return A&&v(y.prototype,A),P&&v(y,P),y}}(),G=function(){function v(y,A){var P=[],O=!0,j=!1,q=void 0;try{for(var de=y[Symbol.iterator](),fe;!(O=(fe=de.next()).done)&&(P.push(fe.value),!(A&&P.length===A));O=!0);}catch(K){j=!0,q=K}finally{try{!O&&de.return&&de.return()}finally{if(j)throw q}}return P}return function(y,A){if(Array.isArray(y))return y;if(Symbol.iterator in Object(y))return v(y,A);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),Q=.001,J=1,ae=function(y,A){return"data:"+y+","+encodeURIComponent(A)},Se=function(y,A,P){return y+(A-y)*P},be=function(){var v=/iPad|iPhone|iPod/.test(navigator.platform);return function(){return v}}(),Qe=function(){var v=navigator.userAgent.indexOf("Version")!==-1&&navigator.userAgent.indexOf("Android")!==-1&&navigator.userAgent.indexOf("Chrome")!==-1;return function(){return v}}(),ht=function(){var v=/^((?!chrome|android).)*safari/i.test(navigator.userAgent);return function(){return v}}(),jt=function(){var v=navigator.userAgent.indexOf("Firefox")!==-1&&navigator.userAgent.indexOf("Android")!==-1;return function(){return v}}(),ei=function(){var v=navigator.userAgent.match(/.*Chrome\/([0-9]+)/),y=v?parseInt(v[1],10):null;return function(){return y}}(),fi=function(){var v=!1;return v=be()&&ht()&&navigator.userAgent.indexOf("13_4")!==-1,function(){return v}}(),ti=function(){var v=!1;if(ei()===65){var y=navigator.userAgent.match(/.*Chrome\/([0-9\.]*)/);if(y){var A=y[1].split("."),P=G(A,4),O=P[0],j=P[1],q=P[2],de=P[3];v=parseInt(q,10)===3325&&parseInt(de,10)<148}}return function(){return v}}(),Xt=function(){var v=navigator.userAgent.indexOf("R7 Build")!==-1;return function(){return v}}(),Si=function(){var y=window.orientation==90||window.orientation==-90;return Xt()?!y:y},ln=function(y){return!(isNaN(y)||y<=Q||y>J)},Ct=function(){return Math.max(window.screen.width,window.screen.height)*window.devicePixelRatio},Ft=function(){return Math.min(window.screen.width,window.screen.height)*window.devicePixelRatio},Gt=function(y){if(Qe())return!1;if(y.requestFullscreen)y.requestFullscreen();else if(y.webkitRequestFullscreen)y.webkitRequestFullscreen();else if(y.mozRequestFullScreen)y.mozRequestFullScreen();else if(y.msRequestFullscreen)y.msRequestFullscreen();else return!1;return!0},St=function(){if(document.exitFullscreen)document.exitFullscreen();else if(document.webkitExitFullscreen)document.webkitExitFullscreen();else if(document.mozCancelFullScreen)document.mozCancelFullScreen();else if(document.msExitFullscreen)document.msExitFullscreen();else return!1;return!0},ks=function(){return document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement},mo=function(y,A,P,O){var j=y.createShader(y.VERTEX_SHADER);y.shaderSource(j,A),y.compileShader(j);var q=y.createShader(y.FRAGMENT_SHADER);y.shaderSource(q,P),y.compileShader(q);var de=y.createProgram();y.attachShader(de,j),y.attachShader(de,q);for(var fe in O)y.bindAttribLocation(de,O[fe],fe);return y.linkProgram(de),y.deleteShader(j),y.deleteShader(q),de},_o=function(y,A){for(var P={},O=y.getProgramParameter(A,y.ACTIVE_UNIFORMS),j="",q=0;q<O;q++){var de=y.getActiveUniform(A,q);j=de.name.replace("[0]",""),P[j]=y.getUniformLocation(A,j)}return P},sa=function(y,A,P,O,j,q,de){var fe=1/(A-P),K=1/(O-j),ie=1/(q-de);return y[0]=-2*fe,y[1]=0,y[2]=0,y[3]=0,y[4]=0,y[5]=-2*K,y[6]=0,y[7]=0,y[8]=0,y[9]=0,y[10]=2*ie,y[11]=0,y[12]=(A+P)*fe,y[13]=(j+O)*K,y[14]=(de+q)*ie,y[15]=1,y},Nr=function(){var y=!1;return function(A){(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(A)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(A.substr(0,4)))&&(y=!0)}(navigator.userAgent||navigator.vendor||window.opera),y},go=function(y,A){for(var P in A)A.hasOwnProperty(P)&&(y[P]=A[P]);return y},Ur=function(y){if(be()){var A=y.style.width,P=y.style.height;y.style.width=parseInt(A)+1+"px",y.style.height=parseInt(P)+"px",setTimeout(function(){y.style.width=A,y.style.height=P},100)}window.canvas=y},Li=function(){var v=Math.PI/180,y=Math.PI*.25;function A(K,ie,Te,et){var ot=Math.tan(ie?ie.upDegrees*v:y),ut=Math.tan(ie?ie.downDegrees*v:y),It=Math.tan(ie?ie.leftDegrees*v:y),vt=Math.tan(ie?ie.rightDegrees*v:y),_t=2/(It+vt),pi=2/(ot+ut);return K[0]=_t,K[1]=0,K[2]=0,K[3]=0,K[4]=0,K[5]=pi,K[6]=0,K[7]=0,K[8]=-((It-vt)*_t*.5),K[9]=(ot-ut)*pi*.5,K[10]=et/(Te-et),K[11]=-1,K[12]=0,K[13]=0,K[14]=et*Te/(Te-et),K[15]=0,K}function P(K,ie,Te){var et=ie[0],ot=ie[1],ut=ie[2],It=ie[3],vt=et+et,_t=ot+ot,pi=ut+ut,Ni=et*vt,Ji=et*_t,Pi=et*pi,yn=ot*_t,is=ot*pi,ns=ut*pi,ss=It*vt,rs=It*_t,vo=It*pi;return K[0]=1-(yn+ns),K[1]=Ji+vo,K[2]=Pi-rs,K[3]=0,K[4]=Ji-vo,K[5]=1-(Ni+ns),K[6]=is+ss,K[7]=0,K[8]=Pi+rs,K[9]=is-ss,K[10]=1-(Ni+yn),K[11]=0,K[12]=Te[0],K[13]=Te[1],K[14]=Te[2],K[15]=1,K}function O(K,ie,Te){var et=Te[0],ot=Te[1],ut=Te[2],It,vt,_t,pi,Ni,Ji,Pi,yn,is,ns,ss,rs;return ie===K?(K[12]=ie[0]*et+ie[4]*ot+ie[8]*ut+ie[12],K[13]=ie[1]*et+ie[5]*ot+ie[9]*ut+ie[13],K[14]=ie[2]*et+ie[6]*ot+ie[10]*ut+ie[14],K[15]=ie[3]*et+ie[7]*ot+ie[11]*ut+ie[15]):(It=ie[0],vt=ie[1],_t=ie[2],pi=ie[3],Ni=ie[4],Ji=ie[5],Pi=ie[6],yn=ie[7],is=ie[8],ns=ie[9],ss=ie[10],rs=ie[11],K[0]=It,K[1]=vt,K[2]=_t,K[3]=pi,K[4]=Ni,K[5]=Ji,K[6]=Pi,K[7]=yn,K[8]=is,K[9]=ns,K[10]=ss,K[11]=rs,K[12]=It*et+Ni*ot+is*ut+ie[12],K[13]=vt*et+Ji*ot+ns*ut+ie[13],K[14]=_t*et+Pi*ot+ss*ut+ie[14],K[15]=pi*et+yn*ot+rs*ut+ie[15]),K}function j(K,ie){var Te=ie[0],et=ie[1],ot=ie[2],ut=ie[3],It=ie[4],vt=ie[5],_t=ie[6],pi=ie[7],Ni=ie[8],Ji=ie[9],Pi=ie[10],yn=ie[11],is=ie[12],ns=ie[13],ss=ie[14],rs=ie[15],vo=Te*vt-et*It,xc=Te*_t-ot*It,Ec=Te*pi-ut*It,Ac=et*_t-ot*vt,Tc=et*pi-ut*vt,wc=ot*pi-ut*_t,Sc=Ni*ns-Ji*is,Mc=Ni*ss-Pi*is,Pc=Ni*rs-yn*is,Cc=Ji*ss-Pi*ns,Rc=Ji*rs-yn*ns,Ic=Pi*rs-yn*ss,qi=vo*Ic-xc*Rc+Ec*Cc+Ac*Pc-Tc*Mc+wc*Sc;return qi?(qi=1/qi,K[0]=(vt*Ic-_t*Rc+pi*Cc)*qi,K[1]=(ot*Rc-et*Ic-ut*Cc)*qi,K[2]=(ns*wc-ss*Tc+rs*Ac)*qi,K[3]=(Pi*Tc-Ji*wc-yn*Ac)*qi,K[4]=(_t*Pc-It*Ic-pi*Mc)*qi,K[5]=(Te*Ic-ot*Pc+ut*Mc)*qi,K[6]=(ss*Ec-is*wc-rs*xc)*qi,K[7]=(Ni*wc-Pi*Ec+yn*xc)*qi,K[8]=(It*Rc-vt*Pc+pi*Sc)*qi,K[9]=(et*Pc-Te*Rc-ut*Sc)*qi,K[10]=(is*Tc-ns*Ec+rs*vo)*qi,K[11]=(Ji*Ec-Ni*Tc-yn*vo)*qi,K[12]=(vt*Mc-It*Cc-_t*Sc)*qi,K[13]=(Te*Cc-et*Mc+ot*Sc)*qi,K[14]=(ns*xc-is*Ac-ss*vo)*qi,K[15]=(Ni*Ac-Ji*xc+Pi*vo)*qi,K):null}var q=new Float32Array([0,0,0,1]),de=new Float32Array([0,0,0]);function fe(K,ie,Te,et,ot,ut){A(K,et||null,ut.depthNear,ut.depthFar);var It=Te.orientation||q,vt=Te.position||de;P(ie,It,vt),ot&&O(ie,ie,ot),j(ie,ie)}return function(K,ie,Te){return!K||!ie?!1:(K.pose=ie,K.timestamp=ie.timestamp,fe(K.leftProjectionMatrix,K.leftViewMatrix,ie,Te._getFieldOfView("left"),Te._getEyeOffset("left"),Te),fe(K.rightProjectionMatrix,K.rightViewMatrix,ie,Te._getFieldOfView("right"),Te._getEyeOffset("right"),Te),!0)}}(),EC=function(){var y=window.self!==window.top,A=q0(document.referrer),P=q0(window.location.href);return y&&A!==P},q0=function(y){var A,P=y.indexOf("://");P!==-1?A=P+3:A=0;var O=y.indexOf("/",A);return O===-1&&(O=y.length),y.substring(0,O)},AC=function(y){if(y.w>1)return console.warn("getQuaternionAngle: w > 1"),0;var A=2*Math.acos(y.w);return A},pp=function(){var v={};return function(y,A){v[y]===void 0&&(console.warn("webvr-polyfill: "+A),v[y]=!0)}}(),ra=function(y,A){var P=A?"Please use "+A+" instead.":"";pp(y,y+" has been deprecated. This may not work on native WebVR displays. "+P)};function TC(v,y,A){if(!y){A(v);return}for(var P=[],O=null,j=0;j<y.length;++j){var q=y[j];switch(q){case v.TEXTURE_BINDING_2D:case v.TEXTURE_BINDING_CUBE_MAP:var de=y[++j];if(de<v.TEXTURE0||de>v.TEXTURE31){console.error("TEXTURE_BINDING_2D or TEXTURE_BINDING_CUBE_MAP must be followed by a valid texture unit"),P.push(null,null);break}O||(O=v.getParameter(v.ACTIVE_TEXTURE)),v.activeTexture(de),P.push(v.getParameter(q),null);break;case v.ACTIVE_TEXTURE:O=v.getParameter(v.ACTIVE_TEXTURE),P.push(null);break;default:P.push(v.getParameter(q));break}}A(v);for(var j=0;j<y.length;++j){var q=y[j],fe=P[j];switch(q){case v.ACTIVE_TEXTURE:break;case v.ARRAY_BUFFER_BINDING:v.bindBuffer(v.ARRAY_BUFFER,fe);break;case v.COLOR_CLEAR_VALUE:v.clearColor(fe[0],fe[1],fe[2],fe[3]);break;case v.COLOR_WRITEMASK:v.colorMask(fe[0],fe[1],fe[2],fe[3]);break;case v.CURRENT_PROGRAM:v.useProgram(fe);break;case v.ELEMENT_ARRAY_BUFFER_BINDING:v.bindBuffer(v.ELEMENT_ARRAY_BUFFER,fe);break;case v.FRAMEBUFFER_BINDING:v.bindFramebuffer(v.FRAMEBUFFER,fe);break;case v.RENDERBUFFER_BINDING:v.bindRenderbuffer(v.RENDERBUFFER,fe);break;case v.TEXTURE_BINDING_2D:var de=y[++j];if(de<v.TEXTURE0||de>v.TEXTURE31)break;v.activeTexture(de),v.bindTexture(v.TEXTURE_2D,fe);break;case v.TEXTURE_BINDING_CUBE_MAP:var de=y[++j];if(de<v.TEXTURE0||de>v.TEXTURE31)break;v.activeTexture(de),v.bindTexture(v.TEXTURE_CUBE_MAP,fe);break;case v.VIEWPORT:v.viewport(fe[0],fe[1],fe[2],fe[3]);break;case v.BLEND:case v.CULL_FACE:case v.DEPTH_TEST:case v.SCISSOR_TEST:case v.STENCIL_TEST:fe?v.enable(q):v.disable(q);break;default:console.log("No GL restore behavior for 0x"+q.toString(16));break}O&&v.activeTexture(O)}}var vc=TC,wC=["attribute vec2 position;","attribute vec3 texCoord;","varying vec2 vTexCoord;","uniform vec4 viewportOffsetScale[2];","void main() {","  vec4 viewport = viewportOffsetScale[int(texCoord.z)];","  vTexCoord = (texCoord.xy * viewport.zw) + viewport.xy;","  gl_Position = vec4( position, 1.0, 1.0 );","}"].join(`
`),SC=["precision mediump float;","uniform sampler2D diffuse;","varying vec2 vTexCoord;","void main() {","  gl_FragColor = texture2D(diffuse, vTexCoord);","}"].join(`
`);function Vs(v,y,A,P){this.gl=v,this.cardboardUI=y,this.bufferScale=A,this.dirtySubmitFrameBindings=P,this.ctxAttribs=v.getContextAttributes(),this.instanceExt=v.getExtension("ANGLE_instanced_arrays"),this.meshWidth=20,this.meshHeight=20,this.bufferWidth=v.drawingBufferWidth,this.bufferHeight=v.drawingBufferHeight,this.realBindFramebuffer=v.bindFramebuffer,this.realEnable=v.enable,this.realDisable=v.disable,this.realColorMask=v.colorMask,this.realClearColor=v.clearColor,this.realViewport=v.viewport,be()||(this.realCanvasWidth=Object.getOwnPropertyDescriptor(v.canvas.__proto__,"width"),this.realCanvasHeight=Object.getOwnPropertyDescriptor(v.canvas.__proto__,"height")),this.isPatched=!1,this.lastBoundFramebuffer=null,this.cullFace=!1,this.depthTest=!1,this.blend=!1,this.scissorTest=!1,this.stencilTest=!1,this.viewport=[0,0,0,0],this.colorMask=[!0,!0,!0,!0],this.clearColor=[0,0,0,0],this.attribs={position:0,texCoord:1},this.program=mo(v,wC,SC,this.attribs),this.uniforms=_o(v,this.program),this.viewportOffsetScale=new Float32Array(8),this.setTextureBounds(),this.vertexBuffer=v.createBuffer(),this.indexBuffer=v.createBuffer(),this.indexCount=0,this.renderTarget=v.createTexture(),this.framebuffer=v.createFramebuffer(),this.depthStencilBuffer=null,this.depthBuffer=null,this.stencilBuffer=null,this.ctxAttribs.depth&&this.ctxAttribs.stencil?this.depthStencilBuffer=v.createRenderbuffer():this.ctxAttribs.depth?this.depthBuffer=v.createRenderbuffer():this.ctxAttribs.stencil&&(this.stencilBuffer=v.createRenderbuffer()),this.patch(),this.onResize()}Vs.prototype.destroy=function(){var v=this.gl;this.unpatch(),v.deleteProgram(this.program),v.deleteBuffer(this.vertexBuffer),v.deleteBuffer(this.indexBuffer),v.deleteTexture(this.renderTarget),v.deleteFramebuffer(this.framebuffer),this.depthStencilBuffer&&v.deleteRenderbuffer(this.depthStencilBuffer),this.depthBuffer&&v.deleteRenderbuffer(this.depthBuffer),this.stencilBuffer&&v.deleteRenderbuffer(this.stencilBuffer),this.cardboardUI&&this.cardboardUI.destroy()},Vs.prototype.onResize=function(){var v=this.gl,y=this,A=[v.RENDERBUFFER_BINDING,v.TEXTURE_BINDING_2D,v.TEXTURE0];vc(v,A,function(P){y.realBindFramebuffer.call(P,P.FRAMEBUFFER,null),y.scissorTest&&y.realDisable.call(P,P.SCISSOR_TEST),y.realColorMask.call(P,!0,!0,!0,!0),y.realViewport.call(P,0,0,P.drawingBufferWidth,P.drawingBufferHeight),y.realClearColor.call(P,0,0,0,1),P.clear(P.COLOR_BUFFER_BIT),y.realBindFramebuffer.call(P,P.FRAMEBUFFER,y.framebuffer),P.bindTexture(P.TEXTURE_2D,y.renderTarget),P.texImage2D(P.TEXTURE_2D,0,y.ctxAttribs.alpha?P.RGBA:P.RGB,y.bufferWidth,y.bufferHeight,0,y.ctxAttribs.alpha?P.RGBA:P.RGB,P.UNSIGNED_BYTE,null),P.texParameteri(P.TEXTURE_2D,P.TEXTURE_MAG_FILTER,P.LINEAR),P.texParameteri(P.TEXTURE_2D,P.TEXTURE_MIN_FILTER,P.LINEAR),P.texParameteri(P.TEXTURE_2D,P.TEXTURE_WRAP_S,P.CLAMP_TO_EDGE),P.texParameteri(P.TEXTURE_2D,P.TEXTURE_WRAP_T,P.CLAMP_TO_EDGE),P.framebufferTexture2D(P.FRAMEBUFFER,P.COLOR_ATTACHMENT0,P.TEXTURE_2D,y.renderTarget,0),y.ctxAttribs.depth&&y.ctxAttribs.stencil?(P.bindRenderbuffer(P.RENDERBUFFER,y.depthStencilBuffer),P.renderbufferStorage(P.RENDERBUFFER,P.DEPTH_STENCIL,y.bufferWidth,y.bufferHeight),P.framebufferRenderbuffer(P.FRAMEBUFFER,P.DEPTH_STENCIL_ATTACHMENT,P.RENDERBUFFER,y.depthStencilBuffer)):y.ctxAttribs.depth?(P.bindRenderbuffer(P.RENDERBUFFER,y.depthBuffer),P.renderbufferStorage(P.RENDERBUFFER,P.DEPTH_COMPONENT16,y.bufferWidth,y.bufferHeight),P.framebufferRenderbuffer(P.FRAMEBUFFER,P.DEPTH_ATTACHMENT,P.RENDERBUFFER,y.depthBuffer)):y.ctxAttribs.stencil&&(P.bindRenderbuffer(P.RENDERBUFFER,y.stencilBuffer),P.renderbufferStorage(P.RENDERBUFFER,P.STENCIL_INDEX8,y.bufferWidth,y.bufferHeight),P.framebufferRenderbuffer(P.FRAMEBUFFER,P.STENCIL_ATTACHMENT,P.RENDERBUFFER,y.stencilBuffer)),!P.checkFramebufferStatus(P.FRAMEBUFFER)===P.FRAMEBUFFER_COMPLETE&&console.error("Framebuffer incomplete!"),y.realBindFramebuffer.call(P,P.FRAMEBUFFER,y.lastBoundFramebuffer),y.scissorTest&&y.realEnable.call(P,P.SCISSOR_TEST),y.realColorMask.apply(P,y.colorMask),y.realViewport.apply(P,y.viewport),y.realClearColor.apply(P,y.clearColor)}),this.cardboardUI&&this.cardboardUI.onResize()},Vs.prototype.patch=function(){if(!this.isPatched){var v=this,y=this.gl.canvas,A=this.gl;be()||(y.width=Ct()*this.bufferScale,y.height=Ft()*this.bufferScale,Object.defineProperty(y,"width",{configurable:!0,enumerable:!0,get:function(){return v.bufferWidth},set:function(O){v.bufferWidth=O,v.realCanvasWidth.set.call(y,O),v.onResize()}}),Object.defineProperty(y,"height",{configurable:!0,enumerable:!0,get:function(){return v.bufferHeight},set:function(O){v.bufferHeight=O,v.realCanvasHeight.set.call(y,O),v.onResize()}})),this.lastBoundFramebuffer=A.getParameter(A.FRAMEBUFFER_BINDING),this.lastBoundFramebuffer==null&&(this.lastBoundFramebuffer=this.framebuffer,this.gl.bindFramebuffer(A.FRAMEBUFFER,this.framebuffer)),this.gl.bindFramebuffer=function(P,O){v.lastBoundFramebuffer=O||v.framebuffer,v.realBindFramebuffer.call(A,P,v.lastBoundFramebuffer)},this.cullFace=A.getParameter(A.CULL_FACE),this.depthTest=A.getParameter(A.DEPTH_TEST),this.blend=A.getParameter(A.BLEND),this.scissorTest=A.getParameter(A.SCISSOR_TEST),this.stencilTest=A.getParameter(A.STENCIL_TEST),A.enable=function(P){switch(P){case A.CULL_FACE:v.cullFace=!0;break;case A.DEPTH_TEST:v.depthTest=!0;break;case A.BLEND:v.blend=!0;break;case A.SCISSOR_TEST:v.scissorTest=!0;break;case A.STENCIL_TEST:v.stencilTest=!0;break}v.realEnable.call(A,P)},A.disable=function(P){switch(P){case A.CULL_FACE:v.cullFace=!1;break;case A.DEPTH_TEST:v.depthTest=!1;break;case A.BLEND:v.blend=!1;break;case A.SCISSOR_TEST:v.scissorTest=!1;break;case A.STENCIL_TEST:v.stencilTest=!1;break}v.realDisable.call(A,P)},this.colorMask=A.getParameter(A.COLOR_WRITEMASK),A.colorMask=function(P,O,j,q){v.colorMask[0]=P,v.colorMask[1]=O,v.colorMask[2]=j,v.colorMask[3]=q,v.realColorMask.call(A,P,O,j,q)},this.clearColor=A.getParameter(A.COLOR_CLEAR_VALUE),A.clearColor=function(P,O,j,q){v.clearColor[0]=P,v.clearColor[1]=O,v.clearColor[2]=j,v.clearColor[3]=q,v.realClearColor.call(A,P,O,j,q)},this.viewport=A.getParameter(A.VIEWPORT),A.viewport=function(P,O,j,q){v.viewport[0]=P,v.viewport[1]=O,v.viewport[2]=j,v.viewport[3]=q,v.realViewport.call(A,P,O,j,q)},this.isPatched=!0,Ur(y)}},Vs.prototype.unpatch=function(){if(this.isPatched){var v=this.gl,y=this.gl.canvas;be()||(Object.defineProperty(y,"width",this.realCanvasWidth),Object.defineProperty(y,"height",this.realCanvasHeight)),y.width=this.bufferWidth,y.height=this.bufferHeight,v.bindFramebuffer=this.realBindFramebuffer,v.enable=this.realEnable,v.disable=this.realDisable,v.colorMask=this.realColorMask,v.clearColor=this.realClearColor,v.viewport=this.realViewport,this.lastBoundFramebuffer==this.framebuffer&&v.bindFramebuffer(v.FRAMEBUFFER,null),this.isPatched=!1,setTimeout(function(){Ur(y)},1)}},Vs.prototype.setTextureBounds=function(v,y){v||(v=[0,0,.5,1]),y||(y=[.5,0,.5,1]),this.viewportOffsetScale[0]=v[0],this.viewportOffsetScale[1]=v[1],this.viewportOffsetScale[2]=v[2],this.viewportOffsetScale[3]=v[3],this.viewportOffsetScale[4]=y[0],this.viewportOffsetScale[5]=y[1],this.viewportOffsetScale[6]=y[2],this.viewportOffsetScale[7]=y[3]},Vs.prototype.submitFrame=function(){var v=this.gl,y=this,A=[];if(this.dirtySubmitFrameBindings||A.push(v.CURRENT_PROGRAM,v.ARRAY_BUFFER_BINDING,v.ELEMENT_ARRAY_BUFFER_BINDING,v.TEXTURE_BINDING_2D,v.TEXTURE0),vc(v,A,function(O){y.realBindFramebuffer.call(O,O.FRAMEBUFFER,null);var j=0,q=0;y.instanceExt&&(j=O.getVertexAttrib(y.attribs.position,y.instanceExt.VERTEX_ATTRIB_ARRAY_DIVISOR_ANGLE),q=O.getVertexAttrib(y.attribs.texCoord,y.instanceExt.VERTEX_ATTRIB_ARRAY_DIVISOR_ANGLE)),y.cullFace&&y.realDisable.call(O,O.CULL_FACE),y.depthTest&&y.realDisable.call(O,O.DEPTH_TEST),y.blend&&y.realDisable.call(O,O.BLEND),y.scissorTest&&y.realDisable.call(O,O.SCISSOR_TEST),y.stencilTest&&y.realDisable.call(O,O.STENCIL_TEST),y.realColorMask.call(O,!0,!0,!0,!0),y.realViewport.call(O,0,0,O.drawingBufferWidth,O.drawingBufferHeight),(y.ctxAttribs.alpha||be())&&(y.realClearColor.call(O,0,0,0,1),O.clear(O.COLOR_BUFFER_BIT)),O.useProgram(y.program),O.bindBuffer(O.ELEMENT_ARRAY_BUFFER,y.indexBuffer),O.bindBuffer(O.ARRAY_BUFFER,y.vertexBuffer),O.enableVertexAttribArray(y.attribs.position),O.enableVertexAttribArray(y.attribs.texCoord),O.vertexAttribPointer(y.attribs.position,2,O.FLOAT,!1,20,0),O.vertexAttribPointer(y.attribs.texCoord,3,O.FLOAT,!1,20,8),y.instanceExt&&(j!=0&&y.instanceExt.vertexAttribDivisorANGLE(y.attribs.position,0),q!=0&&y.instanceExt.vertexAttribDivisorANGLE(y.attribs.texCoord,0)),O.activeTexture(O.TEXTURE0),O.uniform1i(y.uniforms.diffuse,0),O.bindTexture(O.TEXTURE_2D,y.renderTarget),O.uniform4fv(y.uniforms.viewportOffsetScale,y.viewportOffsetScale),O.drawElements(O.TRIANGLES,y.indexCount,O.UNSIGNED_SHORT,0),y.cardboardUI&&y.cardboardUI.renderNoState(),y.realBindFramebuffer.call(y.gl,O.FRAMEBUFFER,y.framebuffer),y.ctxAttribs.preserveDrawingBuffer||(y.realClearColor.call(O,0,0,0,0),O.clear(O.COLOR_BUFFER_BIT)),y.dirtySubmitFrameBindings||y.realBindFramebuffer.call(O,O.FRAMEBUFFER,y.lastBoundFramebuffer),y.cullFace&&y.realEnable.call(O,O.CULL_FACE),y.depthTest&&y.realEnable.call(O,O.DEPTH_TEST),y.blend&&y.realEnable.call(O,O.BLEND),y.scissorTest&&y.realEnable.call(O,O.SCISSOR_TEST),y.stencilTest&&y.realEnable.call(O,O.STENCIL_TEST),y.realColorMask.apply(O,y.colorMask),y.realViewport.apply(O,y.viewport),(y.ctxAttribs.alpha||!y.ctxAttribs.preserveDrawingBuffer)&&y.realClearColor.apply(O,y.clearColor),y.instanceExt&&(j!=0&&y.instanceExt.vertexAttribDivisorANGLE(y.attribs.position,j),q!=0&&y.instanceExt.vertexAttribDivisorANGLE(y.attribs.texCoord,q))}),be()){var P=v.canvas;(P.width!=y.bufferWidth||P.height!=y.bufferHeight)&&(y.bufferWidth=P.width,y.bufferHeight=P.height,y.onResize())}},Vs.prototype.updateDeviceInfo=function(v){var y=this.gl,A=this,P=[y.ARRAY_BUFFER_BINDING,y.ELEMENT_ARRAY_BUFFER_BINDING];vc(y,P,function(O){var j=A.computeMeshVertices_(A.meshWidth,A.meshHeight,v);if(O.bindBuffer(O.ARRAY_BUFFER,A.vertexBuffer),O.bufferData(O.ARRAY_BUFFER,j,O.STATIC_DRAW),!A.indexCount){var q=A.computeMeshIndices_(A.meshWidth,A.meshHeight);O.bindBuffer(O.ELEMENT_ARRAY_BUFFER,A.indexBuffer),O.bufferData(O.ELEMENT_ARRAY_BUFFER,q,O.STATIC_DRAW),A.indexCount=q.length}})},Vs.prototype.computeMeshVertices_=function(v,y,A){for(var P=new Float32Array(2*v*y*5),O=A.getLeftEyeVisibleTanAngles(),j=A.getLeftEyeNoLensTanAngles(),q=A.getLeftEyeVisibleScreenRect(j),de=0,fe=0;fe<2;fe++){for(var K=0;K<y;K++)for(var ie=0;ie<v;ie++,de++){var Te=ie/(v-1),et=K/(y-1),ot=Te,ut=et,It=Se(O[0],O[2],Te),vt=Se(O[3],O[1],et),_t=Math.sqrt(It*It+vt*vt),pi=A.distortion.distortInverse(_t),Ni=It*pi/_t,Ji=vt*pi/_t;Te=(Ni-j[0])/(j[2]-j[0]),et=(Ji-j[3])/(j[1]-j[3]),Te=(q.x+Te*q.width-.5)*2,et=(q.y+et*q.height-.5)*2,P[de*5+0]=Te,P[de*5+1]=et,P[de*5+2]=ot,P[de*5+3]=ut,P[de*5+4]=fe}var Pi=O[2]-O[0];O[0]=-(Pi+O[0]),O[2]=Pi-O[2],Pi=j[2]-j[0],j[0]=-(Pi+j[0]),j[2]=Pi-j[2],q.x=1-(q.x+q.width)}return P},Vs.prototype.computeMeshIndices_=function(v,y){for(var A=new Uint16Array(2*(v-1)*(y-1)*6),P=v/2,O=y/2,j=0,q=0,de=0;de<2;de++)for(var fe=0;fe<y;fe++)for(var K=0;K<v;K++,j++)K==0||fe==0||(K<=P==fe<=O?(A[q++]=j,A[q++]=j-v-1,A[q++]=j-v,A[q++]=j-v-1,A[q++]=j,A[q++]=j-1):(A[q++]=j-1,A[q++]=j-v,A[q++]=j,A[q++]=j-v,A[q++]=j-1,A[q++]=j-v-1));return A},Vs.prototype.getOwnPropertyDescriptor_=function(v,y){var A=Object.getOwnPropertyDescriptor(v,y);return(A.get===void 0||A.set===void 0)&&(A.configurable=!0,A.enumerable=!0,A.get=function(){return this.getAttribute(y)},A.set=function(P){this.setAttribute(y,P)}),A};var MC=["attribute vec2 position;","uniform mat4 projectionMat;","void main() {","  gl_Position = projectionMat * vec4( position, -1.0, 1.0 );","}"].join(`
`),PC=["precision mediump float;","uniform vec4 color;","void main() {","  gl_FragColor = color;","}"].join(`
`),Y0=Math.PI/180,mp=60,Q0=12,K0=20,_p=1,$0=.75,Z0=.3125,CC=4,oa=28,gp=1.5;function aa(v){this.gl=v,this.attribs={position:0},this.program=mo(v,MC,PC,this.attribs),this.uniforms=_o(v,this.program),this.vertexBuffer=v.createBuffer(),this.gearOffset=0,this.gearVertexCount=0,this.arrowOffset=0,this.arrowVertexCount=0,this.projMat=new Float32Array(16),this.listener=null,this.onResize()}aa.prototype.destroy=function(){var v=this.gl;this.listener&&v.canvas.removeEventListener("click",this.listener,!1),v.deleteProgram(this.program),v.deleteBuffer(this.vertexBuffer)},aa.prototype.listen=function(v,y){var A=this.gl.canvas;this.listener=function(P){var O=A.clientWidth/2,j=oa*gp,q=P.touches?P.touches[0].clientX:P.clientX,de=P.touches?P.touches[0].clientY:P.clientY;q>O-j&&q<O+j&&de>A.clientHeight-j?v(P):q<j&&de<j&&y(P)},A.addEventListener("click",this.listener,!1),A.addEventListener("touchstart",this.listener,!1)},aa.prototype.onResize=function(){var v=this.gl,y=this,A=[v.ARRAY_BUFFER_BINDING];vc(v,A,function(P){var O=[],j=P.drawingBufferWidth/2,q=Math.max(screen.width,screen.height)*window.devicePixelRatio,de=P.drawingBufferWidth/q,fe=de*window.devicePixelRatio,K=CC*fe/2,ie=oa*gp*fe,Te=oa*fe/2,et=(oa*gp-oa)*fe;O.push(j-K,ie),O.push(j-K,P.drawingBufferHeight),O.push(j+K,ie),O.push(j+K,P.drawingBufferHeight),y.gearOffset=O.length/2;function ot(pi,Ni){var Ji=(90-pi)*Y0,Pi=Math.cos(Ji),yn=Math.sin(Ji);O.push(Z0*Pi*Te+j,Z0*yn*Te+Te),O.push(Ni*Pi*Te+j,Ni*yn*Te+Te)}for(var ut=0;ut<=6;ut++){var It=ut*mp;ot(It,_p),ot(It+Q0,_p),ot(It+K0,$0),ot(It+(mp-K0),$0),ot(It+(mp-Q0),_p)}y.gearVertexCount=O.length/2-y.gearOffset,y.arrowOffset=O.length/2;function vt(pi,Ni){O.push(et+pi,P.drawingBufferHeight-et-Ni)}var _t=K/Math.sin(45*Y0);vt(0,Te),vt(Te,0),vt(Te+_t,_t),vt(_t,Te+_t),vt(_t,Te-_t),vt(0,Te),vt(Te,Te*2),vt(Te+_t,Te*2-_t),vt(_t,Te-_t),vt(0,Te),vt(_t,Te-K),vt(oa*fe,Te-K),vt(_t,Te+K),vt(oa*fe,Te+K),y.arrowVertexCount=O.length/2-y.arrowOffset,P.bindBuffer(P.ARRAY_BUFFER,y.vertexBuffer),P.bufferData(P.ARRAY_BUFFER,new Float32Array(O),P.STATIC_DRAW)})},aa.prototype.render=function(){var v=this.gl,y=this,A=[v.CULL_FACE,v.DEPTH_TEST,v.BLEND,v.SCISSOR_TEST,v.STENCIL_TEST,v.COLOR_WRITEMASK,v.VIEWPORT,v.CURRENT_PROGRAM,v.ARRAY_BUFFER_BINDING];vc(v,A,function(P){P.disable(P.CULL_FACE),P.disable(P.DEPTH_TEST),P.disable(P.BLEND),P.disable(P.SCISSOR_TEST),P.disable(P.STENCIL_TEST),P.colorMask(!0,!0,!0,!0),P.viewport(0,0,P.drawingBufferWidth,P.drawingBufferHeight),y.renderNoState()})},aa.prototype.renderNoState=function(){var v=this.gl;v.useProgram(this.program),v.bindBuffer(v.ARRAY_BUFFER,this.vertexBuffer),v.enableVertexAttribArray(this.attribs.position),v.vertexAttribPointer(this.attribs.position,2,v.FLOAT,!1,8,0),v.uniform4f(this.uniforms.color,1,1,1,1),sa(this.projMat,0,v.drawingBufferWidth,0,v.drawingBufferHeight,.1,1024),v.uniformMatrix4fv(this.uniforms.projectionMat,!1,this.projMat),v.drawArrays(v.TRIANGLE_STRIP,0,4),v.drawArrays(v.TRIANGLE_STRIP,this.gearOffset,this.gearVertexCount),v.drawArrays(v.TRIANGLE_STRIP,this.arrowOffset,this.arrowVertexCount)};function Ed(v){this.coefficients=v}Ed.prototype.distortInverse=function(v){for(var y=0,A=1,P=v-this.distort(y);Math.abs(A-y)>1e-4;){var O=v-this.distort(A),j=A-O*((A-y)/(O-P));y=A,A=j,P=O}return A},Ed.prototype.distort=function(v){for(var y=v*v,A=0,P=0;P<this.coefficients.length;P++)A=y*(A+this.coefficients[P]);return(A+1)*v};var or=Math.PI/180,ar=180/Math.PI,Mi=function(y,A,P){this.x=y||0,this.y=A||0,this.z=P||0};Mi.prototype={constructor:Mi,set:function(y,A,P){return this.x=y,this.y=A,this.z=P,this},copy:function(y){return this.x=y.x,this.y=y.y,this.z=y.z,this},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},normalize:function(){var y=this.length();if(y!==0){var A=1/y;this.multiplyScalar(A)}else this.x=0,this.y=0,this.z=0;return this},multiplyScalar:function(y){this.x*=y,this.y*=y,this.z*=y},applyQuaternion:function(y){var A=this.x,P=this.y,O=this.z,j=y.x,q=y.y,de=y.z,fe=y.w,K=fe*A+q*O-de*P,ie=fe*P+de*A-j*O,Te=fe*O+j*P-q*A,et=-j*A-q*P-de*O;return this.x=K*fe+et*-j+ie*-de-Te*-q,this.y=ie*fe+et*-q+Te*-j-K*-de,this.z=Te*fe+et*-de+K*-q-ie*-j,this},dot:function(y){return this.x*y.x+this.y*y.y+this.z*y.z},crossVectors:function(y,A){var P=y.x,O=y.y,j=y.z,q=A.x,de=A.y,fe=A.z;return this.x=O*fe-j*de,this.y=j*q-P*fe,this.z=P*de-O*q,this}};var qt=function(y,A,P,O){this.x=y||0,this.y=A||0,this.z=P||0,this.w=O!==void 0?O:1};qt.prototype={constructor:qt,set:function(y,A,P,O){return this.x=y,this.y=A,this.z=P,this.w=O,this},copy:function(y){return this.x=y.x,this.y=y.y,this.z=y.z,this.w=y.w,this},setFromEulerXYZ:function(y,A,P){var O=Math.cos(y/2),j=Math.cos(A/2),q=Math.cos(P/2),de=Math.sin(y/2),fe=Math.sin(A/2),K=Math.sin(P/2);return this.x=de*j*q+O*fe*K,this.y=O*fe*q-de*j*K,this.z=O*j*K+de*fe*q,this.w=O*j*q-de*fe*K,this},setFromEulerYXZ:function(y,A,P){var O=Math.cos(y/2),j=Math.cos(A/2),q=Math.cos(P/2),de=Math.sin(y/2),fe=Math.sin(A/2),K=Math.sin(P/2);return this.x=de*j*q+O*fe*K,this.y=O*fe*q-de*j*K,this.z=O*j*K-de*fe*q,this.w=O*j*q+de*fe*K,this},setFromAxisAngle:function(y,A){var P=A/2,O=Math.sin(P);return this.x=y.x*O,this.y=y.y*O,this.z=y.z*O,this.w=Math.cos(P),this},multiply:function(y){return this.multiplyQuaternions(this,y)},multiplyQuaternions:function(y,A){var P=y.x,O=y.y,j=y.z,q=y.w,de=A.x,fe=A.y,K=A.z,ie=A.w;return this.x=P*ie+q*de+O*K-j*fe,this.y=O*ie+q*fe+j*de-P*K,this.z=j*ie+q*K+P*fe-O*de,this.w=q*ie-P*de-O*fe-j*K,this},inverse:function(){return this.x*=-1,this.y*=-1,this.z*=-1,this.normalize(),this},normalize:function(){var y=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);return y===0?(this.x=0,this.y=0,this.z=0,this.w=1):(y=1/y,this.x=this.x*y,this.y=this.y*y,this.z=this.z*y,this.w=this.w*y),this},slerp:function(y,A){if(A===0)return this;if(A===1)return this.copy(y);var P=this.x,O=this.y,j=this.z,q=this.w,de=q*y.w+P*y.x+O*y.y+j*y.z;if(de<0?(this.w=-y.w,this.x=-y.x,this.y=-y.y,this.z=-y.z,de=-de):this.copy(y),de>=1)return this.w=q,this.x=P,this.y=O,this.z=j,this;var fe=Math.acos(de),K=Math.sqrt(1-de*de);if(Math.abs(K)<.001)return this.w=.5*(q+this.w),this.x=.5*(P+this.x),this.y=.5*(O+this.y),this.z=.5*(j+this.z),this;var ie=Math.sin((1-A)*fe)/K,Te=Math.sin(A*fe)/K;return this.w=q*ie+this.w*Te,this.x=P*ie+this.x*Te,this.y=O*ie+this.y*Te,this.z=j*ie+this.z*Te,this},setFromUnitVectors:function(){var v,y,A=1e-6;return function(P,O){return v===void 0&&(v=new Mi),y=P.dot(O)+1,y<A?(y=0,Math.abs(P.x)>Math.abs(P.z)?v.set(-P.y,P.x,0):v.set(0,-P.z,P.y)):v.crossVectors(P,O),this.x=v.x,this.y=v.y,this.z=v.z,this.w=y,this.normalize(),this}}()};function vp(v){this.width=v.width||Ct(),this.height=v.height||Ft(),this.widthMeters=v.widthMeters,this.heightMeters=v.heightMeters,this.bevelMeters=v.bevelMeters}var RC=new vp({widthMeters:.11,heightMeters:.062,bevelMeters:.004}),IC=new vp({widthMeters:.1038,heightMeters:.0584,bevelMeters:.004}),bp={CardboardV1:new yp({id:"CardboardV1",label:"Cardboard I/O 2014",fov:40,interLensDistance:.06,baselineLensDistance:.035,screenLensDistance:.042,distortionCoefficients:[.441,.156],inverseCoefficients:[-.4410035,.42756155,-.4804439,.5460139,-.58821183,.5733938,-.48303202,.33299083,-.17573841,.0651772,-.01488963,.001559834]}),CardboardV2:new yp({id:"CardboardV2",label:"Cardboard I/O 2015",fov:60,interLensDistance:.064,baselineLensDistance:.035,screenLensDistance:.039,distortionCoefficients:[.34,.55],inverseCoefficients:[-.33836704,-.18162185,.862655,-1.2462051,1.0560602,-.58208317,.21609078,-.05444823,.009177956,-.0009904169,6183535e-11,-16981803e-13]})};function ji(v,y){this.viewer=bp.CardboardV2,this.updateDeviceParams(v),this.distortion=new Ed(this.viewer.distortionCoefficients);for(var A=0;A<y.length;A++){var P=y[A];bp[P.id]=new yp(P)}}ji.prototype.updateDeviceParams=function(v){this.device=this.determineDevice_(v)||this.device},ji.prototype.getDevice=function(){return this.device},ji.prototype.setViewer=function(v){this.viewer=v,this.distortion=new Ed(this.viewer.distortionCoefficients)},ji.prototype.determineDevice_=function(v){if(!v)return be()?(console.warn("Using fallback iOS device measurements."),IC):(console.warn("Using fallback Android device measurements."),RC);var y=.0254,A=y/v.xdpi,P=y/v.ydpi,O=Ct(),j=Ft();return new vp({widthMeters:A*O,heightMeters:P*j,bevelMeters:v.bevelMm*.001})},ji.prototype.getDistortedFieldOfViewLeftEye=function(){var v=this.viewer,y=this.device,A=this.distortion,P=v.screenLensDistance,O=(y.widthMeters-v.interLensDistance)/2,j=v.interLensDistance/2,q=v.baselineLensDistance-y.bevelMeters,de=y.heightMeters-q,fe=ar*Math.atan(A.distort(O/P)),K=ar*Math.atan(A.distort(j/P)),ie=ar*Math.atan(A.distort(q/P)),Te=ar*Math.atan(A.distort(de/P));return{leftDegrees:Math.min(fe,v.fov),rightDegrees:Math.min(K,v.fov),downDegrees:Math.min(ie,v.fov),upDegrees:Math.min(Te,v.fov)}},ji.prototype.getLeftEyeVisibleTanAngles=function(){var v=this.viewer,y=this.device,A=this.distortion,P=Math.tan(-or*v.fov),O=Math.tan(or*v.fov),j=Math.tan(or*v.fov),q=Math.tan(-or*v.fov),de=y.widthMeters/4,fe=y.heightMeters/2,K=v.baselineLensDistance-y.bevelMeters-fe,ie=v.interLensDistance/2-de,Te=-K,et=v.screenLensDistance,ot=A.distort((ie-de)/et),ut=A.distort((Te+fe)/et),It=A.distort((ie+de)/et),vt=A.distort((Te-fe)/et),_t=new Float32Array(4);return _t[0]=Math.max(P,ot),_t[1]=Math.min(O,ut),_t[2]=Math.min(j,It),_t[3]=Math.max(q,vt),_t},ji.prototype.getLeftEyeNoLensTanAngles=function(){var v=this.viewer,y=this.device,A=this.distortion,P=new Float32Array(4),O=A.distortInverse(Math.tan(-or*v.fov)),j=A.distortInverse(Math.tan(or*v.fov)),q=A.distortInverse(Math.tan(or*v.fov)),de=A.distortInverse(Math.tan(-or*v.fov)),fe=y.widthMeters/4,K=y.heightMeters/2,ie=v.baselineLensDistance-y.bevelMeters-K,Te=v.interLensDistance/2-fe,et=-ie,ot=v.screenLensDistance,ut=(Te-fe)/ot,It=(et+K)/ot,vt=(Te+fe)/ot,_t=(et-K)/ot;return P[0]=Math.max(O,ut),P[1]=Math.min(j,It),P[2]=Math.min(q,vt),P[3]=Math.max(de,_t),P},ji.prototype.getLeftEyeVisibleScreenRect=function(v){var y=this.viewer,A=this.device,P=y.screenLensDistance,O=(A.widthMeters-y.interLensDistance)/2,j=y.baselineLensDistance-A.bevelMeters,q=(v[0]*P+O)/A.widthMeters,de=(v[1]*P+j)/A.heightMeters,fe=(v[2]*P+O)/A.widthMeters,K=(v[3]*P+j)/A.heightMeters;return{x:q,y:K,width:fe-q,height:de-K}},ji.prototype.getFieldOfViewLeftEye=function(v){return v?this.getUndistortedFieldOfViewLeftEye():this.getDistortedFieldOfViewLeftEye()},ji.prototype.getFieldOfViewRightEye=function(v){var y=this.getFieldOfViewLeftEye(v);return{leftDegrees:y.rightDegrees,rightDegrees:y.leftDegrees,upDegrees:y.upDegrees,downDegrees:y.downDegrees}},ji.prototype.getUndistortedFieldOfViewLeftEye=function(){var v=this.getUndistortedParams_();return{leftDegrees:ar*Math.atan(v.outerDist),rightDegrees:ar*Math.atan(v.innerDist),downDegrees:ar*Math.atan(v.bottomDist),upDegrees:ar*Math.atan(v.topDist)}},ji.prototype.getUndistortedViewportLeftEye=function(){var v=this.getUndistortedParams_(),y=this.viewer,A=this.device,P=y.screenLensDistance,O=A.widthMeters/P,j=A.heightMeters/P,q=A.width/O,de=A.height/j,fe=Math.round((v.eyePosX-v.outerDist)*q),K=Math.round((v.eyePosY-v.bottomDist)*de);return{x:fe,y:K,width:Math.round((v.eyePosX+v.innerDist)*q)-fe,height:Math.round((v.eyePosY+v.topDist)*de)-K}},ji.prototype.getUndistortedParams_=function(){var v=this.viewer,y=this.device,A=this.distortion,P=v.screenLensDistance,O=v.interLensDistance/2/P,j=y.widthMeters/P,q=y.heightMeters/P,de=j/2-O,fe=(v.baselineLensDistance-y.bevelMeters)/P,K=v.fov,ie=A.distortInverse(Math.tan(or*K)),Te=Math.min(de,ie),et=Math.min(O,ie),ot=Math.min(fe,ie),ut=Math.min(q-fe,ie);return{outerDist:Te,innerDist:et,topDist:ut,bottomDist:ot,eyePosX:de,eyePosY:fe}};function yp(v){this.id=v.id,this.label=v.label,this.fov=v.fov,this.interLensDistance=v.interLensDistance,this.baselineLensDistance=v.baselineLensDistance,this.screenLensDistance=v.screenLensDistance,this.distortionCoefficients=v.distortionCoefficients,this.inverseCoefficients=v.inverseCoefficients}ji.Viewers=bp;var DC=1,LC="2019-11-09T17:36:14Z",OC=[{type:"android",rules:[{mdmh:"asus/*/Nexus 7/*"},{ua:"Nexus 7"}],dpi:[320.8,323],bw:3,ac:500},{type:"android",rules:[{mdmh:"asus/*/ASUS_X00PD/*"},{ua:"ASUS_X00PD"}],dpi:245,bw:3,ac:500},{type:"android",rules:[{mdmh:"asus/*/ASUS_X008D/*"},{ua:"ASUS_X008D"}],dpi:282,bw:3,ac:500},{type:"android",rules:[{mdmh:"asus/*/ASUS_Z00AD/*"},{ua:"ASUS_Z00AD"}],dpi:[403,404.6],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"Google/*/Pixel 2 XL/*"},{ua:"Pixel 2 XL"}],dpi:537.9,bw:3,ac:1e3},{type:"android",rules:[{mdmh:"Google/*/Pixel 3 XL/*"},{ua:"Pixel 3 XL"}],dpi:[558.5,553.8],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"Google/*/Pixel XL/*"},{ua:"Pixel XL"}],dpi:[537.9,533],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"Google/*/Pixel 3/*"},{ua:"Pixel 3"}],dpi:442.4,bw:3,ac:1e3},{type:"android",rules:[{mdmh:"Google/*/Pixel 2/*"},{ua:"Pixel 2"}],dpi:441,bw:3,ac:500},{type:"android",rules:[{mdmh:"Google/*/Pixel/*"},{ua:"Pixel"}],dpi:[432.6,436.7],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"HTC/*/HTC6435LVW/*"},{ua:"HTC6435LVW"}],dpi:[449.7,443.3],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"HTC/*/HTC One XL/*"},{ua:"HTC One XL"}],dpi:[315.3,314.6],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"htc/*/Nexus 9/*"},{ua:"Nexus 9"}],dpi:289,bw:3,ac:500},{type:"android",rules:[{mdmh:"HTC/*/HTC One M9/*"},{ua:"HTC One M9"}],dpi:[442.5,443.3],bw:3,ac:500},{type:"android",rules:[{mdmh:"HTC/*/HTC One_M8/*"},{ua:"HTC One_M8"}],dpi:[449.7,447.4],bw:3,ac:500},{type:"android",rules:[{mdmh:"HTC/*/HTC One/*"},{ua:"HTC One"}],dpi:472.8,bw:3,ac:1e3},{type:"android",rules:[{mdmh:"Huawei/*/Nexus 6P/*"},{ua:"Nexus 6P"}],dpi:[515.1,518],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"Huawei/*/BLN-L24/*"},{ua:"HONORBLN-L24"}],dpi:480,bw:4,ac:500},{type:"android",rules:[{mdmh:"Huawei/*/BKL-L09/*"},{ua:"BKL-L09"}],dpi:403,bw:3.47,ac:500},{type:"android",rules:[{mdmh:"LENOVO/*/Lenovo PB2-690Y/*"},{ua:"Lenovo PB2-690Y"}],dpi:[457.2,454.713],bw:3,ac:500},{type:"android",rules:[{mdmh:"LGE/*/Nexus 5X/*"},{ua:"Nexus 5X"}],dpi:[422,419.9],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"LGE/*/LGMS345/*"},{ua:"LGMS345"}],dpi:[221.7,219.1],bw:3,ac:500},{type:"android",rules:[{mdmh:"LGE/*/LG-D800/*"},{ua:"LG-D800"}],dpi:[422,424.1],bw:3,ac:500},{type:"android",rules:[{mdmh:"LGE/*/LG-D850/*"},{ua:"LG-D850"}],dpi:[537.9,541.9],bw:3,ac:500},{type:"android",rules:[{mdmh:"LGE/*/VS985 4G/*"},{ua:"VS985 4G"}],dpi:[537.9,535.6],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"LGE/*/Nexus 5/*"},{ua:"Nexus 5 B"}],dpi:[442.4,444.8],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"LGE/*/Nexus 4/*"},{ua:"Nexus 4"}],dpi:[319.8,318.4],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"LGE/*/LG-P769/*"},{ua:"LG-P769"}],dpi:[240.6,247.5],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"LGE/*/LGMS323/*"},{ua:"LGMS323"}],dpi:[206.6,204.6],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"LGE/*/LGLS996/*"},{ua:"LGLS996"}],dpi:[403.4,401.5],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"Micromax/*/4560MMX/*"},{ua:"4560MMX"}],dpi:[240,219.4],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"Micromax/*/A250/*"},{ua:"Micromax A250"}],dpi:[480,446.4],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"Micromax/*/Micromax AQ4501/*"},{ua:"Micromax AQ4501"}],dpi:240,bw:3,ac:500},{type:"android",rules:[{mdmh:"motorola/*/G5/*"},{ua:"Moto G (5) Plus"}],dpi:[403.4,403],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"motorola/*/DROID RAZR/*"},{ua:"DROID RAZR"}],dpi:[368.1,256.7],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"motorola/*/XT830C/*"},{ua:"XT830C"}],dpi:[254,255.9],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"motorola/*/XT1021/*"},{ua:"XT1021"}],dpi:[254,256.7],bw:3,ac:500},{type:"android",rules:[{mdmh:"motorola/*/XT1023/*"},{ua:"XT1023"}],dpi:[254,256.7],bw:3,ac:500},{type:"android",rules:[{mdmh:"motorola/*/XT1028/*"},{ua:"XT1028"}],dpi:[326.6,327.6],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"motorola/*/XT1034/*"},{ua:"XT1034"}],dpi:[326.6,328.4],bw:3,ac:500},{type:"android",rules:[{mdmh:"motorola/*/XT1053/*"},{ua:"XT1053"}],dpi:[315.3,316.1],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"motorola/*/XT1562/*"},{ua:"XT1562"}],dpi:[403.4,402.7],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"motorola/*/Nexus 6/*"},{ua:"Nexus 6 B"}],dpi:[494.3,489.7],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"motorola/*/XT1063/*"},{ua:"XT1063"}],dpi:[295,296.6],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"motorola/*/XT1064/*"},{ua:"XT1064"}],dpi:[295,295.6],bw:3,ac:500},{type:"android",rules:[{mdmh:"motorola/*/XT1092/*"},{ua:"XT1092"}],dpi:[422,424.1],bw:3,ac:500},{type:"android",rules:[{mdmh:"motorola/*/XT1095/*"},{ua:"XT1095"}],dpi:[422,423.4],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"motorola/*/G4/*"},{ua:"Moto G (4)"}],dpi:401,bw:4,ac:1e3},{type:"android",rules:[{mdmh:"OnePlus/*/A0001/*"},{ua:"A0001"}],dpi:[403.4,401],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"OnePlus/*/ONE E1001/*"},{ua:"ONE E1001"}],dpi:[442.4,441.4],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"OnePlus/*/ONE E1003/*"},{ua:"ONE E1003"}],dpi:[442.4,441.4],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"OnePlus/*/ONE E1005/*"},{ua:"ONE E1005"}],dpi:[442.4,441.4],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"OnePlus/*/ONE A2001/*"},{ua:"ONE A2001"}],dpi:[391.9,405.4],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"OnePlus/*/ONE A2003/*"},{ua:"ONE A2003"}],dpi:[391.9,405.4],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"OnePlus/*/ONE A2005/*"},{ua:"ONE A2005"}],dpi:[391.9,405.4],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"OnePlus/*/ONEPLUS A3000/*"},{ua:"ONEPLUS A3000"}],dpi:401,bw:3,ac:500},{type:"android",rules:[{mdmh:"OnePlus/*/ONEPLUS A3003/*"},{ua:"ONEPLUS A3003"}],dpi:401,bw:3,ac:500},{type:"android",rules:[{mdmh:"OnePlus/*/ONEPLUS A3010/*"},{ua:"ONEPLUS A3010"}],dpi:401,bw:3,ac:500},{type:"android",rules:[{mdmh:"OnePlus/*/ONEPLUS A5000/*"},{ua:"ONEPLUS A5000 "}],dpi:[403.411,399.737],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"OnePlus/*/ONE A5010/*"},{ua:"ONEPLUS A5010"}],dpi:[403,400],bw:2,ac:1e3},{type:"android",rules:[{mdmh:"OnePlus/*/ONEPLUS A6000/*"},{ua:"ONEPLUS A6000"}],dpi:401,bw:3,ac:500},{type:"android",rules:[{mdmh:"OnePlus/*/ONEPLUS A6003/*"},{ua:"ONEPLUS A6003"}],dpi:401,bw:3,ac:500},{type:"android",rules:[{mdmh:"OnePlus/*/ONEPLUS A6010/*"},{ua:"ONEPLUS A6010"}],dpi:401,bw:2,ac:500},{type:"android",rules:[{mdmh:"OnePlus/*/ONEPLUS A6013/*"},{ua:"ONEPLUS A6013"}],dpi:401,bw:2,ac:500},{type:"android",rules:[{mdmh:"OPPO/*/X909/*"},{ua:"X909"}],dpi:[442.4,444.1],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/GT-I9082/*"},{ua:"GT-I9082"}],dpi:[184.7,185.4],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-G360P/*"},{ua:"SM-G360P"}],dpi:[196.7,205.4],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/Nexus S/*"},{ua:"Nexus S"}],dpi:[234.5,229.8],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/GT-I9300/*"},{ua:"GT-I9300"}],dpi:[304.8,303.9],bw:5,ac:500},{type:"android",rules:[{mdmh:"samsung/*/SM-T230NU/*"},{ua:"SM-T230NU"}],dpi:216,bw:3,ac:500},{type:"android",rules:[{mdmh:"samsung/*/SGH-T399/*"},{ua:"SGH-T399"}],dpi:[217.7,231.4],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SGH-M919/*"},{ua:"SGH-M919"}],dpi:[440.8,437.7],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-N9005/*"},{ua:"SM-N9005"}],dpi:[386.4,387],bw:3,ac:500},{type:"android",rules:[{mdmh:"samsung/*/SAMSUNG-SM-N900A/*"},{ua:"SAMSUNG-SM-N900A"}],dpi:[386.4,387.7],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/GT-I9500/*"},{ua:"GT-I9500"}],dpi:[442.5,443.3],bw:3,ac:500},{type:"android",rules:[{mdmh:"samsung/*/GT-I9505/*"},{ua:"GT-I9505"}],dpi:439.4,bw:4,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-G900F/*"},{ua:"SM-G900F"}],dpi:[415.6,431.6],bw:5,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-G900M/*"},{ua:"SM-G900M"}],dpi:[415.6,431.6],bw:5,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-G800F/*"},{ua:"SM-G800F"}],dpi:326.8,bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-G906S/*"},{ua:"SM-G906S"}],dpi:[562.7,572.4],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/GT-I9300/*"},{ua:"GT-I9300"}],dpi:[306.7,304.8],bw:5,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-T535/*"},{ua:"SM-T535"}],dpi:[142.6,136.4],bw:3,ac:500},{type:"android",rules:[{mdmh:"samsung/*/SM-N920C/*"},{ua:"SM-N920C"}],dpi:[515.1,518.4],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-N920P/*"},{ua:"SM-N920P"}],dpi:[386.3655,390.144],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-N920W8/*"},{ua:"SM-N920W8"}],dpi:[515.1,518.4],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/GT-I9300I/*"},{ua:"GT-I9300I"}],dpi:[304.8,305.8],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/GT-I9195/*"},{ua:"GT-I9195"}],dpi:[249.4,256.7],bw:3,ac:500},{type:"android",rules:[{mdmh:"samsung/*/SPH-L520/*"},{ua:"SPH-L520"}],dpi:[249.4,255.9],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SAMSUNG-SGH-I717/*"},{ua:"SAMSUNG-SGH-I717"}],dpi:285.8,bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SPH-D710/*"},{ua:"SPH-D710"}],dpi:[217.7,204.2],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/GT-N7100/*"},{ua:"GT-N7100"}],dpi:265.1,bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SCH-I605/*"},{ua:"SCH-I605"}],dpi:265.1,bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/Galaxy Nexus/*"},{ua:"Galaxy Nexus"}],dpi:[315.3,314.2],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-N910H/*"},{ua:"SM-N910H"}],dpi:[515.1,518],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-N910C/*"},{ua:"SM-N910C"}],dpi:[515.2,520.2],bw:3,ac:500},{type:"android",rules:[{mdmh:"samsung/*/SM-G130M/*"},{ua:"SM-G130M"}],dpi:[165.9,164.8],bw:3,ac:500},{type:"android",rules:[{mdmh:"samsung/*/SM-G928I/*"},{ua:"SM-G928I"}],dpi:[515.1,518.4],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-G920F/*"},{ua:"SM-G920F"}],dpi:580.6,bw:3,ac:500},{type:"android",rules:[{mdmh:"samsung/*/SM-G920P/*"},{ua:"SM-G920P"}],dpi:[522.5,577],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-G925F/*"},{ua:"SM-G925F"}],dpi:580.6,bw:3,ac:500},{type:"android",rules:[{mdmh:"samsung/*/SM-G925V/*"},{ua:"SM-G925V"}],dpi:[522.5,576.6],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-G930F/*"},{ua:"SM-G930F"}],dpi:576.6,bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-G935F/*"},{ua:"SM-G935F"}],dpi:533,bw:3,ac:500},{type:"android",rules:[{mdmh:"samsung/*/SM-G950F/*"},{ua:"SM-G950F"}],dpi:[562.707,565.293],bw:3,ac:500},{type:"android",rules:[{mdmh:"samsung/*/SM-G955U/*"},{ua:"SM-G955U"}],dpi:[522.514,525.762],bw:3,ac:500},{type:"android",rules:[{mdmh:"samsung/*/SM-G955F/*"},{ua:"SM-G955F"}],dpi:[522.514,525.762],bw:3,ac:500},{type:"android",rules:[{mdmh:"samsung/*/SM-G960F/*"},{ua:"SM-G960F"}],dpi:[569.575,571.5],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-G9600/*"},{ua:"SM-G9600"}],dpi:[569.575,571.5],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-G960T/*"},{ua:"SM-G960T"}],dpi:[569.575,571.5],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-G960N/*"},{ua:"SM-G960N"}],dpi:[569.575,571.5],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-G960U/*"},{ua:"SM-G960U"}],dpi:[569.575,571.5],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-G9608/*"},{ua:"SM-G9608"}],dpi:[569.575,571.5],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-G960FD/*"},{ua:"SM-G960FD"}],dpi:[569.575,571.5],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-G960W/*"},{ua:"SM-G960W"}],dpi:[569.575,571.5],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-G965F/*"},{ua:"SM-G965F"}],dpi:529,bw:2,ac:1e3},{type:"android",rules:[{mdmh:"Sony/*/C6903/*"},{ua:"C6903"}],dpi:[442.5,443.3],bw:3,ac:500},{type:"android",rules:[{mdmh:"Sony/*/D6653/*"},{ua:"D6653"}],dpi:[428.6,427.6],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"Sony/*/E6653/*"},{ua:"E6653"}],dpi:[428.6,425.7],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"Sony/*/E6853/*"},{ua:"E6853"}],dpi:[403.4,401.9],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"Sony/*/SGP321/*"},{ua:"SGP321"}],dpi:[224.7,224.1],bw:3,ac:500},{type:"android",rules:[{mdmh:"TCT/*/ALCATEL ONE TOUCH Fierce/*"},{ua:"ALCATEL ONE TOUCH Fierce"}],dpi:[240,247.5],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"THL/*/thl 5000/*"},{ua:"thl 5000"}],dpi:[480,443.3],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"Fly/*/IQ4412/*"},{ua:"IQ4412"}],dpi:307.9,bw:3,ac:1e3},{type:"android",rules:[{mdmh:"ZTE/*/ZTE Blade L2/*"},{ua:"ZTE Blade L2"}],dpi:240,bw:3,ac:500},{type:"android",rules:[{mdmh:"BENEVE/*/VR518/*"},{ua:"VR518"}],dpi:480,bw:3,ac:500},{type:"ios",rules:[{res:[640,960]}],dpi:[325.1,328.4],bw:4,ac:1e3},{type:"ios",rules:[{res:[640,1136]}],dpi:[317.1,320.2],bw:3,ac:1e3},{type:"ios",rules:[{res:[750,1334]}],dpi:326.4,bw:4,ac:1e3},{type:"ios",rules:[{res:[1242,2208]}],dpi:[453.6,458.4],bw:4,ac:1e3},{type:"ios",rules:[{res:[1125,2001]}],dpi:[410.9,415.4],bw:4,ac:1e3},{type:"ios",rules:[{res:[1125,2436]}],dpi:458,bw:4,ac:1e3},{type:"android",rules:[{mdmh:"Huawei/*/EML-L29/*"},{ua:"EML-L29"}],dpi:428,bw:3.45,ac:500},{type:"android",rules:[{mdmh:"Nokia/*/Nokia 7.1/*"},{ua:"Nokia 7.1"}],dpi:[432,431.9],bw:3,ac:500},{type:"ios",rules:[{res:[1242,2688]}],dpi:458,bw:4,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-G570M/*"},{ua:"SM-G570M"}],dpi:320,bw:3.684,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-G970F/*"},{ua:"SM-G970F"}],dpi:438,bw:2.281,ac:500},{type:"android",rules:[{mdmh:"samsung/*/SM-G973F/*"},{ua:"SM-G973F"}],dpi:550,bw:2.002,ac:500},{type:"android",rules:[{mdmh:"samsung/*/SM-G975F/*"},{ua:"SM-G975F"}],dpi:522,bw:2.054,ac:500},{type:"android",rules:[{mdmh:"samsung/*/SM-G977F/*"},{ua:"SM-G977F"}],dpi:505,bw:2.334,ac:500},{type:"ios",rules:[{res:[828,1792]}],dpi:326,bw:5,ac:500}],FC={format:DC,last_updated:LC,devices:OC};function bc(v,y){if(this.dpdb=FC,this.recalculateDeviceParams_(),v){this.onDeviceParamsUpdated=y;var A=new XMLHttpRequest,P=this;A.open("GET",v,!0),A.addEventListener("load",function(){P.loading=!1,A.status>=200&&A.status<=299?(P.dpdb=JSON.parse(A.response),P.recalculateDeviceParams_()):console.error("Error loading online DPDB!")}),A.send()}}bc.prototype.getDeviceParams=function(){return this.deviceParams},bc.prototype.recalculateDeviceParams_=function(){var v=this.calcDeviceParams_();v?(this.deviceParams=v,this.onDeviceParamsUpdated&&this.onDeviceParamsUpdated(this.deviceParams)):console.error("Failed to recalculate device parameters.")},bc.prototype.calcDeviceParams_=function(){var v=this.dpdb;if(!v)return console.error("DPDB not available."),null;if(v.format!=1)return console.error("DPDB has unexpected format version."),null;if(!v.devices||!v.devices.length)return console.error("DPDB does not have a devices section."),null;var y=navigator.userAgent||navigator.vendor||window.opera,A=Ct(),P=Ft();if(!v.devices)return console.error("DPDB has no devices section."),null;for(var O=0;O<v.devices.length;O++){var j=v.devices[O];if(!j.rules){console.warn("Device["+O+"] has no rules section.");continue}if(j.type!="ios"&&j.type!="android"){console.warn("Device["+O+"] has invalid type.");continue}if(be()==(j.type=="ios")){for(var q=!1,de=0;de<j.rules.length;de++){var fe=j.rules[de];if(this.ruleMatches_(fe,y,A,P)){q=!0;break}}if(q){var K=j.dpi[0]||j.dpi,ie=j.dpi[1]||j.dpi;return new BC({xdpi:K,ydpi:ie,bevelMm:j.bw})}}}return console.warn("No DPDB device match."),null},bc.prototype.ruleMatches_=function(v,y,A,P){if(!v.ua&&!v.res||(v.ua&&v.ua.substring(0,2)==="SM"&&(v.ua=v.ua.substring(0,7)),v.ua&&y.indexOf(v.ua)<0))return!1;if(v.res){if(!v.res[0]||!v.res[1])return!1;var O=v.res[0],j=v.res[1];if(Math.min(A,P)!=Math.min(O,j)||Math.max(A,P)!=Math.max(O,j))return!1}return!0};function BC(v){this.xdpi=v.xdpi,this.ydpi=v.ydpi,this.bevelMm=v.bevelMm}function yc(v,y){this.set(v,y)}yc.prototype.set=function(v,y){this.sample=v,this.timestampS=y},yc.prototype.copy=function(v){this.set(v.sample,v.timestampS)};function la(v,y){this.kFilter=v,this.isDebug=y,this.currentAccelMeasurement=new yc,this.currentGyroMeasurement=new yc,this.previousGyroMeasurement=new yc,be()?this.filterQ=new qt(-1,0,0,1):this.filterQ=new qt(1,0,0,1),this.previousFilterQ=new qt,this.previousFilterQ.copy(this.filterQ),this.accelQ=new qt,this.isOrientationInitialized=!1,this.estimatedGravity=new Mi,this.measuredGravity=new Mi,this.gyroIntegralQ=new qt}la.prototype.addAccelMeasurement=function(v,y){this.currentAccelMeasurement.set(v,y)},la.prototype.addGyroMeasurement=function(v,y){this.currentGyroMeasurement.set(v,y);var A=y-this.previousGyroMeasurement.timestampS;ln(A)&&this.run_(),this.previousGyroMeasurement.copy(this.currentGyroMeasurement)},la.prototype.run_=function(){if(!this.isOrientationInitialized){this.accelQ=this.accelToQuaternion_(this.currentAccelMeasurement.sample),this.previousFilterQ.copy(this.accelQ),this.isOrientationInitialized=!0;return}var v=this.currentGyroMeasurement.timestampS-this.previousGyroMeasurement.timestampS,y=this.gyroToQuaternionDelta_(this.currentGyroMeasurement.sample,v);this.gyroIntegralQ.multiply(y),this.filterQ.copy(this.previousFilterQ),this.filterQ.multiply(y);var A=new qt;A.copy(this.filterQ),A.inverse(),this.estimatedGravity.set(0,0,-1),this.estimatedGravity.applyQuaternion(A),this.estimatedGravity.normalize(),this.measuredGravity.copy(this.currentAccelMeasurement.sample),this.measuredGravity.normalize();var P=new qt;P.setFromUnitVectors(this.estimatedGravity,this.measuredGravity),P.inverse(),this.isDebug&&console.log("Delta: %d deg, G_est: (%s, %s, %s), G_meas: (%s, %s, %s)",ar*AC(P),this.estimatedGravity.x.toFixed(1),this.estimatedGravity.y.toFixed(1),this.estimatedGravity.z.toFixed(1),this.measuredGravity.x.toFixed(1),this.measuredGravity.y.toFixed(1),this.measuredGravity.z.toFixed(1));var O=new qt;O.copy(this.filterQ),O.multiply(P),this.filterQ.slerp(O,1-this.kFilter),this.previousFilterQ.copy(this.filterQ)},la.prototype.getOrientation=function(){return this.filterQ},la.prototype.accelToQuaternion_=function(v){var y=new Mi;y.copy(v),y.normalize();var A=new qt;return A.setFromUnitVectors(new Mi(0,0,-1),y),A.inverse(),A},la.prototype.gyroToQuaternionDelta_=function(v,y){var A=new qt,P=new Mi;return P.copy(v),P.normalize(),A.setFromAxisAngle(P,v.length()*y),A};function J0(v,y){this.predictionTimeS=v,this.isDebug=y,this.previousQ=new qt,this.previousTimestampS=null,this.deltaQ=new qt,this.outQ=new qt}J0.prototype.getPrediction=function(v,y,A){if(!this.previousTimestampS)return this.previousQ.copy(v),this.previousTimestampS=A,v;var P=new Mi;P.copy(y),P.normalize();var O=y.length();if(O<or*20)return this.isDebug&&console.log("Moving slowly, at %s deg/s: no prediction",(ar*O).toFixed(1)),this.outQ.copy(v),this.previousQ.copy(v),this.outQ;var j=O*this.predictionTimeS;return this.deltaQ.setFromAxisAngle(P,j),this.outQ.copy(this.previousQ),this.outQ.multiply(this.deltaQ),this.previousQ.copy(v),this.previousTimestampS=A,this.outQ};function gs(v,y,A,P){this.yawOnly=A,this.accelerometer=new Mi,this.gyroscope=new Mi,this.filter=new la(v,P),this.posePredictor=new J0(y,P),this.isFirefoxAndroid=jt(),this.isIOS=be();var O=ei();this.isDeviceMotionInRadians=!this.isIOS&&O&&O<66,this.isWithoutDeviceMotion=ti()||fi(),this.filterToWorldQ=new qt,be()?this.filterToWorldQ.setFromAxisAngle(new Mi(1,0,0),Math.PI/2):this.filterToWorldQ.setFromAxisAngle(new Mi(1,0,0),-Math.PI/2),this.inverseWorldToScreenQ=new qt,this.worldToScreenQ=new qt,this.originalPoseAdjustQ=new qt,this.originalPoseAdjustQ.setFromAxisAngle(new Mi(0,0,1),-window.orientation*Math.PI/180),this.setScreenTransform_(),Si()&&this.filterToWorldQ.multiply(this.inverseWorldToScreenQ),this.resetQ=new qt,this.orientationOut_=new Float32Array(4),this.start()}gs.prototype.getPosition=function(){return null},gs.prototype.getOrientation=function(){var v=void 0;if(this.isWithoutDeviceMotion&&this._deviceOrientationQ){this.deviceOrientationFixQ=this.deviceOrientationFixQ||function(){var O=new qt().setFromAxisAngle(new Mi(0,0,-1),0),j=new qt;return window.orientation===-90?j.setFromAxisAngle(new Mi(0,1,0),Math.PI/-2):j.setFromAxisAngle(new Mi(0,1,0),Math.PI/2),O.multiply(j)}(),this.deviceOrientationFilterToWorldQ=this.deviceOrientationFilterToWorldQ||function(){var O=new qt;return O.setFromAxisAngle(new Mi(1,0,0),-Math.PI/2),O}(),v=this._deviceOrientationQ;var A=new qt;return A.copy(v),A.multiply(this.deviceOrientationFilterToWorldQ),A.multiply(this.resetQ),A.multiply(this.worldToScreenQ),A.multiplyQuaternions(this.deviceOrientationFixQ,A),this.yawOnly&&(A.x=0,A.z=0,A.normalize()),this.orientationOut_[0]=A.x,this.orientationOut_[1]=A.y,this.orientationOut_[2]=A.z,this.orientationOut_[3]=A.w,this.orientationOut_}else{var y=this.filter.getOrientation();v=this.posePredictor.getPrediction(y,this.gyroscope,this.previousTimestampS)}var A=new qt;return A.copy(this.filterToWorldQ),A.multiply(this.resetQ),A.multiply(v),A.multiply(this.worldToScreenQ),this.yawOnly&&(A.x=0,A.z=0,A.normalize()),this.orientationOut_[0]=A.x,this.orientationOut_[1]=A.y,this.orientationOut_[2]=A.z,this.orientationOut_[3]=A.w,this.orientationOut_},gs.prototype.resetPose=function(){this.resetQ.copy(this.filter.getOrientation()),this.resetQ.x=0,this.resetQ.y=0,this.resetQ.z*=-1,this.resetQ.normalize(),Si()&&this.resetQ.multiply(this.inverseWorldToScreenQ),this.resetQ.multiply(this.originalPoseAdjustQ)},gs.prototype.onDeviceOrientation_=function(v){this._deviceOrientationQ=this._deviceOrientationQ||new qt;var y=v.alpha,A=v.beta,P=v.gamma;y=(y||0)*Math.PI/180,A=(A||0)*Math.PI/180,P=(P||0)*Math.PI/180,this._deviceOrientationQ.setFromEulerYXZ(A,y,-P)},gs.prototype.onDeviceMotion_=function(v){this.updateDeviceMotion_(v)},gs.prototype.updateDeviceMotion_=function(v){var y=v.accelerationIncludingGravity,A=v.rotationRate,P=v.timeStamp/1e3,O=P-this.previousTimestampS;if(O<0){pp("fusion-pose-sensor:invalid:non-monotonic","Invalid timestamps detected: non-monotonic timestamp from devicemotion"),this.previousTimestampS=P;return}else if(O<=Q||O>J){pp("fusion-pose-sensor:invalid:outside-threshold","Invalid timestamps detected: Timestamp from devicemotion outside expected range."),this.previousTimestampS=P;return}this.accelerometer.set(-y.x,-y.y,-y.z),A&&(Xt()?this.gyroscope.set(-A.beta,A.alpha,A.gamma):this.gyroscope.set(A.alpha,A.beta,A.gamma),this.isDeviceMotionInRadians||this.gyroscope.multiplyScalar(Math.PI/180),this.filter.addGyroMeasurement(this.gyroscope,P)),this.filter.addAccelMeasurement(this.accelerometer,P),this.previousTimestampS=P},gs.prototype.onOrientationChange_=function(v){this.setScreenTransform_()},gs.prototype.onMessage_=function(v){var y=v.data;if(!(!y||!y.type)){var A=y.type.toLowerCase();A==="devicemotion"&&this.updateDeviceMotion_(y.deviceMotionEvent)}},gs.prototype.setScreenTransform_=function(){switch(this.worldToScreenQ.set(0,0,0,1),window.orientation){case 0:break;case 90:this.worldToScreenQ.setFromAxisAngle(new Mi(0,0,1),-Math.PI/2);break;case-90:this.worldToScreenQ.setFromAxisAngle(new Mi(0,0,1),Math.PI/2);break;case 180:break}this.inverseWorldToScreenQ.copy(this.worldToScreenQ),this.inverseWorldToScreenQ.inverse()},gs.prototype.start=function(){this.onDeviceMotionCallback_=this.onDeviceMotion_.bind(this),this.onOrientationChangeCallback_=this.onOrientationChange_.bind(this),this.onMessageCallback_=this.onMessage_.bind(this),this.onDeviceOrientationCallback_=this.onDeviceOrientation_.bind(this),be()&&EC()&&window.addEventListener("message",this.onMessageCallback_),window.addEventListener("orientationchange",this.onOrientationChangeCallback_),this.isWithoutDeviceMotion?window.addEventListener("deviceorientation",this.onDeviceOrientationCallback_):window.addEventListener("devicemotion",this.onDeviceMotionCallback_)},gs.prototype.stop=function(){window.removeEventListener("devicemotion",this.onDeviceMotionCallback_),window.removeEventListener("deviceorientation",this.onDeviceOrientationCallback_),window.removeEventListener("orientationchange",this.onOrientationChangeCallback_),window.removeEventListener("message",this.onMessageCallback_)};var NC=60,UC=new Mi(1,0,0),kC=new Mi(0,0,1),xp=new qt;xp.setFromAxisAngle(UC,-Math.PI/2),xp.multiply(new qt().setFromAxisAngle(kC,Math.PI/2));var VC=function(){function v(y){S(this,v),this.config=y,this.sensor=null,this.fusionSensor=null,this._out=new Float32Array(4),this.api=null,this.errors=[],this._sensorQ=new qt,this._outQ=new qt,this._onSensorRead=this._onSensorRead.bind(this),this._onSensorError=this._onSensorError.bind(this),this.init()}return R(v,[{key:"init",value:function(){var A=null;try{A=new RelativeOrientationSensor({frequency:NC,referenceFrame:"screen"}),A.addEventListener("error",this._onSensorError)}catch(P){this.errors.push(P),P.name==="SecurityError"?(console.error("Cannot construct sensors due to the Feature Policy"),console.warn('Attempting to fall back using "devicemotion"; however this will fail in the future without correct permissions.'),this.useDeviceMotion()):P.name==="ReferenceError"?this.useDeviceMotion():console.error(P)}A&&(this.api="sensor",this.sensor=A,this.sensor.addEventListener("reading",this._onSensorRead),this.sensor.start())}},{key:"useDeviceMotion",value:function(){this.api="devicemotion",this.fusionSensor=new gs(this.config.K_FILTER,this.config.PREDICTION_TIME_S,this.config.YAW_ONLY,this.config.DEBUG),this.sensor&&(this.sensor.removeEventListener("reading",this._onSensorRead),this.sensor.removeEventListener("error",this._onSensorError),this.sensor=null)}},{key:"getOrientation",value:function(){if(this.fusionSensor)return this.fusionSensor.getOrientation();if(!this.sensor||!this.sensor.quaternion)return this._out[0]=this._out[1]=this._out[2]=0,this._out[3]=1,this._out;var A=this.sensor.quaternion;this._sensorQ.set(A[0],A[1],A[2],A[3]);var P=this._outQ;return P.copy(xp),P.multiply(this._sensorQ),this.config.YAW_ONLY&&(P.x=P.z=0,P.normalize()),this._out[0]=P.x,this._out[1]=P.y,this._out[2]=P.z,this._out[3]=P.w,this._out}},{key:"_onSensorError",value:function(A){this.errors.push(A.error),A.error.name==="NotAllowedError"?console.error("Permission to access sensor was denied"):A.error.name==="NotReadableError"?console.error("Sensor could not be read"):console.error(A.error),this.useDeviceMotion()}},{key:"_onSensorRead",value:function(){}}]),v}(),zC="<svg width='198' height='240' viewBox='0 0 198 240' xmlns='http://www.w3.org/2000/svg'><g fill='none' fill-rule='evenodd'><path d='M149.625 109.527l6.737 3.891v.886c0 .177.013.36.038.549.01.081.02.162.027.242.14 1.415.974 2.998 2.105 3.999l5.72 5.062.081-.09s4.382-2.53 5.235-3.024l25.97 14.993v54.001c0 .771-.386 1.217-.948 1.217-.233 0-.495-.076-.772-.236l-23.967-13.838-.014.024-27.322 15.775-.85-1.323c-4.731-1.529-9.748-2.74-14.951-3.61a.27.27 0 0 0-.007.024l-5.067 16.961-7.891 4.556-.037-.063v27.59c0 .772-.386 1.217-.948 1.217-.232 0-.495-.076-.772-.236l-42.473-24.522c-.95-.549-1.72-1.877-1.72-2.967v-1.035l-.021.047a5.111 5.111 0 0 0-1.816-.399 5.682 5.682 0 0 0-.546.001 13.724 13.724 0 0 1-1.918-.041c-1.655-.153-3.2-.6-4.404-1.296l-46.576-26.89.005.012-10.278-18.75c-1.001-1.827-.241-4.216 1.698-5.336l56.011-32.345a4.194 4.194 0 0 1 2.099-.572c1.326 0 2.572.659 3.227 1.853l.005-.003.227.413-.006.004a9.63 9.63 0 0 0 1.477 2.018l.277.27c1.914 1.85 4.468 2.801 7.113 2.801 1.949 0 3.948-.517 5.775-1.572.013 0 7.319-4.219 7.319-4.219a4.194 4.194 0 0 1 2.099-.572c1.326 0 2.572.658 3.226 1.853l3.25 5.928.022-.018 6.785 3.917-.105-.182 46.881-26.965m0-1.635c-.282 0-.563.073-.815.218l-46.169 26.556-5.41-3.124-3.005-5.481c-.913-1.667-2.699-2.702-4.66-2.703-1.011 0-2.02.274-2.917.792a3825 3825 0 0 1-7.275 4.195l-.044.024a9.937 9.937 0 0 1-4.957 1.353c-2.292 0-4.414-.832-5.976-2.342l-.252-.245a7.992 7.992 0 0 1-1.139-1.534 1.379 1.379 0 0 0-.06-.122l-.227-.414a1.718 1.718 0 0 0-.095-.154c-.938-1.574-2.673-2.545-4.571-2.545-1.011 0-2.02.274-2.917.792L3.125 155.502c-2.699 1.559-3.738 4.94-2.314 7.538l10.278 18.75c.177.323.448.563.761.704l46.426 26.804c1.403.81 3.157 1.332 5.072 1.508a15.661 15.661 0 0 0 2.146.046 4.766 4.766 0 0 1 .396 0c.096.004.19.011.283.022.109 1.593 1.159 3.323 2.529 4.114l42.472 24.522c.524.302 1.058.455 1.59.455 1.497 0 2.583-1.2 2.583-2.852v-26.562l7.111-4.105a1.64 1.64 0 0 0 .749-.948l4.658-15.593c4.414.797 8.692 1.848 12.742 3.128l.533.829a1.634 1.634 0 0 0 2.193.531l26.532-15.317L193 192.433c.523.302 1.058.455 1.59.455 1.497 0 2.583-1.199 2.583-2.852v-54.001c0-.584-.312-1.124-.818-1.416l-25.97-14.993a1.633 1.633 0 0 0-1.636.001c-.606.351-2.993 1.73-4.325 2.498l-4.809-4.255c-.819-.725-1.461-1.933-1.561-2.936a7.776 7.776 0 0 0-.033-.294 2.487 2.487 0 0 1-.023-.336v-.886c0-.584-.312-1.123-.817-1.416l-6.739-3.891a1.633 1.633 0 0 0-.817-.219' fill='#455A64'/><path d='M96.027 132.636l46.576 26.891c1.204.695 1.979 1.587 2.242 2.541l-.01.007-81.374 46.982h-.001c-1.654-.152-3.199-.6-4.403-1.295l-46.576-26.891 83.546-48.235' fill='#FAFAFA'/><path d='M63.461 209.174c-.008 0-.015 0-.022-.002-1.693-.156-3.228-.609-4.441-1.309l-46.576-26.89a.118.118 0 0 1 0-.203l83.546-48.235a.117.117 0 0 1 .117 0l46.576 26.891c1.227.708 2.021 1.612 2.296 2.611a.116.116 0 0 1-.042.124l-.021.016-81.375 46.981a.11.11 0 0 1-.058.016zm-50.747-28.303l46.401 26.79c1.178.68 2.671 1.121 4.32 1.276l81.272-46.922c-.279-.907-1.025-1.73-2.163-2.387l-46.517-26.857-83.313 48.1z' fill='#607D8B'/><path d='M148.327 165.471a5.85 5.85 0 0 1-.546.001c-1.894-.083-3.302-1.038-3.145-2.132a2.693 2.693 0 0 0-.072-1.105l-81.103 46.822c.628.058 1.272.073 1.918.042.182-.009.364-.009.546-.001 1.894.083 3.302 1.038 3.145 2.132l79.257-45.759' fill='#FFF'/><path d='M69.07 211.347a.118.118 0 0 1-.115-.134c.045-.317-.057-.637-.297-.925-.505-.61-1.555-1.022-2.738-1.074a5.966 5.966 0 0 0-.535.001 14.03 14.03 0 0 1-1.935-.041.117.117 0 0 1-.103-.092.116.116 0 0 1 .055-.126l81.104-46.822a.117.117 0 0 1 .171.07c.104.381.129.768.074 1.153-.045.316.057.637.296.925.506.61 1.555 1.021 2.739 1.073.178.008.357.008.535-.001a.117.117 0 0 1 .064.218l-79.256 45.759a.114.114 0 0 1-.059.016zm-3.405-2.372c.089 0 .177.002.265.006 1.266.056 2.353.488 2.908 1.158.227.274.35.575.36.882l78.685-45.429c-.036 0-.072-.001-.107-.003-1.267-.056-2.354-.489-2.909-1.158-.282-.34-.402-.724-.347-1.107a2.604 2.604 0 0 0-.032-.91L63.846 208.97a13.91 13.91 0 0 0 1.528.012c.097-.005.194-.007.291-.007z' fill='#607D8B'/><path d='M2.208 162.134c-1.001-1.827-.241-4.217 1.698-5.337l56.011-32.344c1.939-1.12 4.324-.546 5.326 1.281l.232.41a9.344 9.344 0 0 0 1.47 2.021l.278.27c3.325 3.214 8.583 3.716 12.888 1.23l7.319-4.22c1.94-1.119 4.324-.546 5.325 1.282l3.25 5.928-83.519 48.229-10.278-18.75z' fill='#FAFAFA'/><path d='M12.486 181.001a.112.112 0 0 1-.031-.005.114.114 0 0 1-.071-.056L2.106 162.19c-1.031-1.88-.249-4.345 1.742-5.494l56.01-32.344a4.328 4.328 0 0 1 2.158-.588c1.415 0 2.65.702 3.311 1.882.01.008.018.017.024.028l.227.414a.122.122 0 0 1 .013.038 9.508 9.508 0 0 0 1.439 1.959l.275.266c1.846 1.786 4.344 2.769 7.031 2.769 1.977 0 3.954-.538 5.717-1.557a.148.148 0 0 1 .035-.013l7.284-4.206a4.321 4.321 0 0 1 2.157-.588c1.427 0 2.672.716 3.329 1.914l3.249 5.929a.116.116 0 0 1-.044.157l-83.518 48.229a.116.116 0 0 1-.059.016zm49.53-57.004c-.704 0-1.41.193-2.041.557l-56.01 32.345c-1.882 1.086-2.624 3.409-1.655 5.179l10.221 18.645 83.317-48.112-3.195-5.829c-.615-1.122-1.783-1.792-3.124-1.792a4.08 4.08 0 0 0-2.04.557l-7.317 4.225a.148.148 0 0 1-.035.013 11.7 11.7 0 0 1-5.801 1.569c-2.748 0-5.303-1.007-7.194-2.835l-.278-.27a9.716 9.716 0 0 1-1.497-2.046.096.096 0 0 1-.013-.037l-.191-.347a.11.11 0 0 1-.023-.029c-.615-1.123-1.783-1.793-3.124-1.793z' fill='#607D8B'/><path d='M42.434 155.808c-2.51-.001-4.697-1.258-5.852-3.365-1.811-3.304-.438-7.634 3.059-9.654l12.291-7.098a7.599 7.599 0 0 1 3.789-1.033c2.51 0 4.697 1.258 5.852 3.365 1.811 3.304.439 7.634-3.059 9.654l-12.291 7.098a7.606 7.606 0 0 1-3.789 1.033zm13.287-20.683a7.128 7.128 0 0 0-3.555.971l-12.291 7.098c-3.279 1.893-4.573 5.942-2.883 9.024 1.071 1.955 3.106 3.122 5.442 3.122a7.13 7.13 0 0 0 3.556-.97l12.291-7.098c3.279-1.893 4.572-5.942 2.883-9.024-1.072-1.955-3.106-3.123-5.443-3.123z' fill='#607D8B'/><path d='M149.588 109.407l6.737 3.89v.887c0 .176.013.36.037.549.011.081.02.161.028.242.14 1.415.973 2.998 2.105 3.999l7.396 6.545c.177.156.358.295.541.415 1.579 1.04 2.95.466 3.062-1.282.049-.784.057-1.595.023-2.429l-.003-.16v-1.151l25.987 15.003v54c0 1.09-.77 1.53-1.72.982l-42.473-24.523c-.95-.548-1.72-1.877-1.72-2.966v-34.033' fill='#FAFAFA'/><path d='M194.553 191.25c-.257 0-.54-.085-.831-.253l-42.472-24.521c-.981-.567-1.779-1.943-1.779-3.068v-34.033h.234v34.033c0 1.051.745 2.336 1.661 2.866l42.473 24.521c.424.245.816.288 1.103.122.285-.164.442-.52.442-1.002v-53.933l-25.753-14.868.003 1.106c.034.832.026 1.654-.024 2.439-.054.844-.396 1.464-.963 1.746-.619.309-1.45.173-2.28-.373a5.023 5.023 0 0 1-.553-.426l-7.397-6.544c-1.158-1.026-1.999-2.625-2.143-4.076a9.624 9.624 0 0 0-.027-.238 4.241 4.241 0 0 1-.038-.564v-.82l-6.68-3.856.117-.202 6.738 3.89.058.034v.954c0 .171.012.351.036.533.011.083.021.165.029.246.138 1.395.948 2.935 2.065 3.923l7.397 6.545c.173.153.35.289.527.406.758.499 1.504.63 2.047.359.49-.243.786-.795.834-1.551.05-.778.057-1.591.024-2.417l-.004-.163v-1.355l.175.1 25.987 15.004.059.033v54.068c0 .569-.198.996-.559 1.204a1.002 1.002 0 0 1-.506.131' fill='#607D8B'/><path d='M145.685 163.161l24.115 13.922-25.978 14.998-1.462-.307c-6.534-2.17-13.628-3.728-21.019-4.616-4.365-.524-8.663 1.096-9.598 3.62a2.746 2.746 0 0 0-.011 1.928c1.538 4.267 4.236 8.363 7.995 12.135l.532.845-25.977 14.997-24.115-13.922 75.518-43.6' fill='#FFF'/><path d='M94.282 220.818l-.059-.033-24.29-14.024.175-.101 75.577-43.634.058.033 24.29 14.024-26.191 15.122-.045-.01-1.461-.307c-6.549-2.174-13.613-3.725-21.009-4.614a13.744 13.744 0 0 0-1.638-.097c-3.758 0-7.054 1.531-7.837 3.642a2.62 2.62 0 0 0-.01 1.848c1.535 4.258 4.216 8.326 7.968 12.091l.016.021.526.835.006.01.064.102-.105.061-25.977 14.998-.058.033zm-23.881-14.057l23.881 13.788 24.802-14.32c.546-.315.846-.489 1.017-.575l-.466-.74c-3.771-3.787-6.467-7.881-8.013-12.168a2.851 2.851 0 0 1 .011-2.008c.815-2.199 4.203-3.795 8.056-3.795.557 0 1.117.033 1.666.099 7.412.891 14.491 2.445 21.041 4.621.836.175 1.215.254 1.39.304l25.78-14.884-23.881-13.788-75.284 43.466z' fill='#607D8B'/><path d='M167.23 125.979v50.871l-27.321 15.773-6.461-14.167c-.91-1.996-3.428-1.738-5.624.574a10.238 10.238 0 0 0-2.33 4.018l-6.46 21.628-27.322 15.774v-50.871l75.518-43.6' fill='#FFF'/><path d='M91.712 220.567a.127.127 0 0 1-.059-.016.118.118 0 0 1-.058-.101v-50.871c0-.042.023-.08.058-.101l75.519-43.6a.117.117 0 0 1 .175.101v50.871c0 .041-.023.08-.059.1l-27.321 15.775a.118.118 0 0 1-.094.01.12.12 0 0 1-.071-.063l-6.46-14.168c-.375-.822-1.062-1.275-1.934-1.275-1.089 0-2.364.686-3.5 1.881a10.206 10.206 0 0 0-2.302 3.972l-6.46 21.627a.118.118 0 0 1-.054.068L91.77 220.551a.12.12 0 0 1-.058.016zm.117-50.92v50.601l27.106-15.65 6.447-21.583a10.286 10.286 0 0 1 2.357-4.065c1.18-1.242 2.517-1.954 3.669-1.954.969 0 1.731.501 2.146 1.411l6.407 14.051 27.152-15.676v-50.601l-75.284 43.466z' fill='#607D8B'/><path d='M168.543 126.213v50.87l-27.322 15.774-6.46-14.168c-.91-1.995-3.428-1.738-5.624.574a10.248 10.248 0 0 0-2.33 4.019l-6.461 21.627-27.321 15.774v-50.87l75.518-43.6' fill='#FFF'/><path d='M93.025 220.8a.123.123 0 0 1-.059-.015.12.12 0 0 1-.058-.101v-50.871c0-.042.023-.08.058-.101l75.518-43.6a.112.112 0 0 1 .117 0c.036.02.059.059.059.1v50.871a.116.116 0 0 1-.059.101l-27.321 15.774a.111.111 0 0 1-.094.01.115.115 0 0 1-.071-.062l-6.46-14.168c-.375-.823-1.062-1.275-1.935-1.275-1.088 0-2.363.685-3.499 1.881a10.19 10.19 0 0 0-2.302 3.971l-6.461 21.628a.108.108 0 0 1-.053.067l-27.322 15.775a.12.12 0 0 1-.058.015zm.117-50.919v50.6l27.106-15.649 6.447-21.584a10.293 10.293 0 0 1 2.357-4.065c1.179-1.241 2.516-1.954 3.668-1.954.969 0 1.732.502 2.147 1.412l6.407 14.051 27.152-15.676v-50.601l-75.284 43.466z' fill='#607D8B'/><path d='M169.8 177.083l-27.322 15.774-6.46-14.168c-.91-1.995-3.428-1.738-5.625.574a10.246 10.246 0 0 0-2.329 4.019l-6.461 21.627-27.321 15.774v-50.87l75.518-43.6v50.87z' fill='#FAFAFA'/><path d='M94.282 220.917a.234.234 0 0 1-.234-.233v-50.871c0-.083.045-.161.117-.202l75.518-43.601a.234.234 0 1 1 .35.202v50.871a.233.233 0 0 1-.116.202l-27.322 15.775a.232.232 0 0 1-.329-.106l-6.461-14.168c-.36-.789-.992-1.206-1.828-1.206-1.056 0-2.301.672-3.415 1.844a10.099 10.099 0 0 0-2.275 3.924l-6.46 21.628a.235.235 0 0 1-.107.136l-27.322 15.774a.23.23 0 0 1-.116.031zm.233-50.969v50.331l26.891-15.525 6.434-21.539a10.41 10.41 0 0 1 2.384-4.112c1.201-1.265 2.569-1.991 3.753-1.991 1.018 0 1.818.526 2.253 1.48l6.354 13.934 26.982-15.578v-50.331l-75.051 43.331z' fill='#607D8B'/><path d='M109.894 199.943c-1.774 0-3.241-.725-4.244-2.12a.224.224 0 0 1 .023-.294.233.233 0 0 1 .301-.023c.78.547 1.705.827 2.75.827 1.323 0 2.754-.439 4.256-1.306 5.311-3.067 9.631-10.518 9.631-16.611 0-1.927-.442-3.56-1.278-4.724a.232.232 0 0 1 .323-.327c1.671 1.172 2.591 3.381 2.591 6.219 0 6.242-4.426 13.863-9.865 17.003-1.574.908-3.084 1.356-4.488 1.356zm-2.969-1.542c.813.651 1.82.877 2.968.877h.001c1.321 0 2.753-.327 4.254-1.194 5.311-3.067 9.632-10.463 9.632-16.556 0-1.979-.463-3.599-1.326-4.761.411 1.035.625 2.275.625 3.635 0 6.243-4.426 13.883-9.865 17.023-1.574.909-3.084 1.317-4.49 1.317-.641 0-1.243-.149-1.799-.341z' fill='#607D8B'/><path d='M113.097 197.23c5.384-3.108 9.748-10.636 9.748-16.814 0-2.051-.483-3.692-1.323-4.86-1.784-1.252-4.374-1.194-7.257.47-5.384 3.108-9.748 10.636-9.748 16.814 0 2.051.483 3.692 1.323 4.86 1.784 1.252 4.374 1.194 7.257-.47' fill='#FAFAFA'/><path d='M108.724 198.614c-1.142 0-2.158-.213-3.019-.817-.021-.014-.04.014-.055-.007-.894-1.244-1.367-2.948-1.367-4.973 0-6.242 4.426-13.864 9.865-17.005 1.574-.908 3.084-1.363 4.49-1.363 1.142 0 2.158.309 3.018.913a.23.23 0 0 1 .056.056c.894 1.244 1.367 2.972 1.367 4.997 0 6.243-4.426 13.783-9.865 16.923-1.574.909-3.084 1.276-4.49 1.276zm-2.718-1.109c.774.532 1.688.776 2.718.776 1.323 0 2.754-.413 4.256-1.28 5.311-3.066 9.631-10.505 9.631-16.598 0-1.909-.434-3.523-1.255-4.685-.774-.533-1.688-.799-2.718-.799-1.323 0-2.755.441-4.256 1.308-5.311 3.066-9.631 10.506-9.631 16.599 0 1.909.434 3.517 1.255 4.679z' fill='#607D8B'/><path d='M149.318 114.262l-9.984 8.878 15.893 11.031 5.589-6.112-11.498-13.797' fill='#FAFAFA'/><path d='M169.676 120.84l-9.748 5.627c-3.642 2.103-9.528 2.113-13.147.024-3.62-2.089-3.601-5.488.041-7.591l9.495-5.608-6.729-3.885-81.836 47.071 45.923 26.514 3.081-1.779c.631-.365.869-.898.618-1.39-2.357-4.632-2.593-9.546-.683-14.262 5.638-13.92 24.509-24.815 48.618-28.07 8.169-1.103 16.68-.967 24.704.394.852.145 1.776.008 2.407-.357l3.081-1.778-25.825-14.91' fill='#FAFAFA'/><path d='M113.675 183.459a.47.47 0 0 1-.233-.062l-45.924-26.515a.468.468 0 0 1 .001-.809l81.836-47.071a.467.467 0 0 1 .466 0l6.729 3.885a.467.467 0 0 1-.467.809l-6.496-3.75-80.9 46.533 44.988 25.973 2.848-1.644c.192-.111.62-.409.435-.773-2.416-4.748-2.658-9.814-.7-14.65 2.806-6.927 8.885-13.242 17.582-18.263 8.657-4.998 19.518-8.489 31.407-10.094 8.198-1.107 16.79-.97 24.844.397.739.125 1.561.007 2.095-.301l2.381-1.374-25.125-14.506a.467.467 0 0 1 .467-.809l25.825 14.91a.467.467 0 0 1 0 .809l-3.081 1.779c-.721.417-1.763.575-2.718.413-7.963-1.351-16.457-1.486-24.563-.392-11.77 1.589-22.512 5.039-31.065 9.977-8.514 4.916-14.456 11.073-17.183 17.805-1.854 4.578-1.623 9.376.666 13.875.37.725.055 1.513-.8 2.006l-3.081 1.78a.476.476 0 0 1-.234.062' fill='#455A64'/><path d='M153.316 128.279c-2.413 0-4.821-.528-6.652-1.586-1.818-1.049-2.82-2.461-2.82-3.975 0-1.527 1.016-2.955 2.861-4.02l9.493-5.607a.233.233 0 1 1 .238.402l-9.496 5.609c-1.696.979-2.628 2.263-2.628 3.616 0 1.34.918 2.608 2.585 3.571 3.549 2.049 9.343 2.038 12.914-.024l9.748-5.628a.234.234 0 0 1 .234.405l-9.748 5.628c-1.858 1.072-4.296 1.609-6.729 1.609' fill='#607D8B'/><path d='M113.675 182.992l-45.913-26.508M113.675 183.342a.346.346 0 0 1-.175-.047l-45.913-26.508a.35.35 0 1 1 .35-.607l45.913 26.508a.35.35 0 0 1-.175.654' fill='#455A64'/><path d='M67.762 156.484v54.001c0 1.09.77 2.418 1.72 2.967l42.473 24.521c.95.549 1.72.11 1.72-.98v-54.001' fill='#FAFAFA'/><path d='M112.727 238.561c-.297 0-.62-.095-.947-.285l-42.473-24.521c-1.063-.613-1.895-2.05-1.895-3.27v-54.001a.35.35 0 1 1 .701 0v54.001c0 .96.707 2.18 1.544 2.663l42.473 24.522c.344.198.661.243.87.122.206-.119.325-.411.325-.799v-54.001a.35.35 0 1 1 .7 0v54.001c0 .655-.239 1.154-.675 1.406a1.235 1.235 0 0 1-.623.162' fill='#455A64'/><path d='M112.86 147.512h-.001c-2.318 0-4.499-.522-6.142-1.471-1.705-.984-2.643-2.315-2.643-3.749 0-1.445.952-2.791 2.68-3.788l12.041-6.953c1.668-.962 3.874-1.493 6.212-1.493 2.318 0 4.499.523 6.143 1.472 1.704.984 2.643 2.315 2.643 3.748 0 1.446-.952 2.791-2.68 3.789l-12.042 6.952c-1.668.963-3.874 1.493-6.211 1.493zm12.147-16.753c-2.217 0-4.298.497-5.861 1.399l-12.042 6.952c-1.502.868-2.33 1.998-2.33 3.182 0 1.173.815 2.289 2.293 3.142 1.538.889 3.596 1.378 5.792 1.378h.001c2.216 0 4.298-.497 5.861-1.399l12.041-6.953c1.502-.867 2.33-1.997 2.33-3.182 0-1.172-.814-2.288-2.292-3.142-1.539-.888-3.596-1.377-5.793-1.377z' fill='#607D8B'/><path d='M165.63 123.219l-5.734 3.311c-3.167 1.828-8.286 1.837-11.433.02-3.147-1.817-3.131-4.772.036-6.601l5.734-3.31 11.397 6.58' fill='#FAFAFA'/><path d='M154.233 117.448l9.995 5.771-4.682 2.704c-1.434.827-3.352 1.283-5.399 1.283-2.029 0-3.923-.449-5.333-1.263-1.29-.744-2-1.694-2-2.674 0-.991.723-1.955 2.036-2.713l5.383-3.108m0-.809l-5.734 3.31c-3.167 1.829-3.183 4.784-.036 6.601 1.568.905 3.623 1.357 5.684 1.357 2.077 0 4.159-.46 5.749-1.377l5.734-3.311-11.397-6.58M145.445 179.667c-1.773 0-3.241-.85-4.243-2.245-.067-.092-.057-.275.023-.356.08-.081.207-.12.3-.055.781.548 1.706.812 2.751.811 1.322 0 2.754-.446 4.256-1.313 5.31-3.066 9.631-10.522 9.631-16.615 0-1.927-.442-3.562-1.279-4.726a.235.235 0 0 1 .024-.301.232.232 0 0 1 .3-.027c1.67 1.172 2.59 3.38 2.59 6.219 0 6.242-4.425 13.987-9.865 17.127-1.573.908-3.083 1.481-4.488 1.481zM142.476 178c.814.651 1.82 1.002 2.969 1.002 1.322 0 2.753-.452 4.255-1.32 5.31-3.065 9.631-10.523 9.631-16.617 0-1.98-.463-3.63-1.325-4.793.411 1.035.624 2.26.624 3.62 0 6.242-4.425 13.875-9.865 17.015-1.573.909-3.084 1.376-4.489 1.376a5.49 5.49 0 0 1-1.8-.283z' fill='#607D8B'/><path d='M148.648 176.704c5.384-3.108 9.748-10.636 9.748-16.813 0-2.052-.483-3.693-1.322-4.861-1.785-1.252-4.375-1.194-7.258.471-5.383 3.108-9.748 10.636-9.748 16.813 0 2.051.484 3.692 1.323 4.86 1.785 1.253 4.374 1.195 7.257-.47' fill='#FAFAFA'/><path d='M144.276 178.276c-1.143 0-2.158-.307-3.019-.911a.217.217 0 0 1-.055-.054c-.895-1.244-1.367-2.972-1.367-4.997 0-6.241 4.425-13.875 9.865-17.016 1.573-.908 3.084-1.369 4.489-1.369 1.143 0 2.158.307 3.019.91a.24.24 0 0 1 .055.055c.894 1.244 1.367 2.971 1.367 4.997 0 6.241-4.425 13.875-9.865 17.016-1.573.908-3.084 1.369-4.489 1.369zm-2.718-1.172c.773.533 1.687.901 2.718.901 1.322 0 2.754-.538 4.256-1.405 5.31-3.066 9.631-10.567 9.631-16.661 0-1.908-.434-3.554-1.256-4.716-.774-.532-1.688-.814-2.718-.814-1.322 0-2.754.433-4.256 1.3-5.31 3.066-9.631 10.564-9.631 16.657 0 1.91.434 3.576 1.256 4.738z' fill='#607D8B'/><path d='M150.72 172.361l-.363-.295a24.105 24.105 0 0 0 2.148-3.128 24.05 24.05 0 0 0 1.977-4.375l.443.149a24.54 24.54 0 0 1-2.015 4.46 24.61 24.61 0 0 1-2.19 3.189M115.917 191.514l-.363-.294a24.174 24.174 0 0 0 2.148-3.128 24.038 24.038 0 0 0 1.976-4.375l.443.148a24.48 24.48 0 0 1-2.015 4.461 24.662 24.662 0 0 1-2.189 3.188M114 237.476V182.584 237.476' fill='#607D8B'/><g><path d='M81.822 37.474c.017-.135-.075-.28-.267-.392-.327-.188-.826-.21-1.109-.045l-6.012 3.471c-.131.076-.194.178-.191.285.002.132.002.461.002.578v.043l-.007.128-6.591 3.779c-.001 0-2.077 1.046-2.787 5.192 0 0-.912 6.961-.898 19.745.015 12.57.606 17.07 1.167 21.351.22 1.684 3.001 2.125 3.001 2.125.331.04.698-.027 1.08-.248l75.273-43.551c1.808-1.069 2.667-3.719 3.056-6.284 1.213-7.99 1.675-32.978-.275-39.878-.196-.693-.51-1.083-.868-1.282l-2.086-.79c-.727.028-1.416.467-1.534.535L82.032 37.072l-.21.402' fill='#FFF'/><path d='M144.311 1.701l2.085.79c.358.199.672.589.868 1.282 1.949 6.9 1.487 31.887.275 39.878-.39 2.565-1.249 5.215-3.056 6.284L69.21 93.486a1.78 1.78 0 0 1-.896.258l-.183-.011c0 .001-2.782-.44-3.003-2.124-.56-4.282-1.151-8.781-1.165-21.351-.015-12.784.897-19.745.897-19.745.71-4.146 2.787-5.192 2.787-5.192l6.591-3.779.007-.128v-.043c0-.117 0-.446-.002-.578-.003-.107.059-.21.191-.285l6.012-3.472a.98.98 0 0 1 .481-.11c.218 0 .449.053.627.156.193.112.285.258.268.392l.211-.402 60.744-34.836c.117-.068.806-.507 1.534-.535m0-.997l-.039.001c-.618.023-1.283.244-1.974.656l-.021.012-60.519 34.706a2.358 2.358 0 0 0-.831-.15c-.365 0-.704.084-.98.244l-6.012 3.471c-.442.255-.699.69-.689 1.166l.001.15-6.08 3.487c-.373.199-2.542 1.531-3.29 5.898l-.006.039c-.009.07-.92 7.173-.906 19.875.014 12.62.603 17.116 1.172 21.465l.002.015c.308 2.355 3.475 2.923 3.836 2.98l.034.004c.101.013.204.019.305.019a2.77 2.77 0 0 0 1.396-.392l75.273-43.552c1.811-1.071 2.999-3.423 3.542-6.997 1.186-7.814 1.734-33.096-.301-40.299-.253-.893-.704-1.527-1.343-1.882l-.132-.062-2.085-.789a.973.973 0 0 0-.353-.065' fill='#455A64'/><path d='M128.267 11.565l1.495.434-56.339 32.326' fill='#FFF'/><path d='M74.202 90.545a.5.5 0 0 1-.25-.931l18.437-10.645a.499.499 0 1 1 .499.864L74.451 90.478l-.249.067M75.764 42.654l-.108-.062.046-.171 5.135-2.964.17.045-.045.171-5.135 2.964-.063.017M70.52 90.375V46.421l.063-.036L137.84 7.554v43.954l-.062.036L70.52 90.375zm.25-43.811v43.38l66.821-38.579V7.985L70.77 46.564z' fill='#607D8B'/><path d='M86.986 83.182c-.23.149-.612.384-.849.523l-11.505 6.701c-.237.139-.206.252.068.252h.565c.275 0 .693-.113.93-.252L87.7 83.705c.237-.139.428-.253.425-.256a11.29 11.29 0 0 1-.006-.503c0-.274-.188-.377-.418-.227l-.715.463' fill='#607D8B'/><path d='M75.266 90.782H74.7c-.2 0-.316-.056-.346-.166-.03-.11.043-.217.215-.317l11.505-6.702c.236-.138.615-.371.844-.519l.715-.464a.488.488 0 0 1 .266-.089c.172 0 .345.13.345.421 0 .214.001.363.003.437l.006.004-.004.069c-.003.075-.003.075-.486.356l-11.505 6.702a2.282 2.282 0 0 1-.992.268zm-.6-.25l.034.001h.566c.252 0 .649-.108.866-.234l11.505-6.702c.168-.098.294-.173.361-.214-.004-.084-.004-.218-.004-.437l-.095-.171-.131.049-.714.463c-.232.15-.616.386-.854.525l-11.505 6.702-.029.018z' fill='#607D8B'/><path d='M75.266 89.871H74.7c-.2 0-.316-.056-.346-.166-.03-.11.043-.217.215-.317l11.505-6.702c.258-.151.694-.268.993-.268h.565c.2 0 .316.056.346.166.03.11-.043.217-.215.317l-11.505 6.702a2.282 2.282 0 0 1-.992.268zm-.6-.25l.034.001h.566c.252 0 .649-.107.866-.234l11.505-6.702.03-.018-.035-.001h-.565c-.252 0-.649.108-.867.234l-11.505 6.702-.029.018zM74.37 90.801v-1.247 1.247' fill='#607D8B'/><path d='M68.13 93.901c-.751-.093-1.314-.737-1.439-1.376-.831-4.238-1.151-8.782-1.165-21.352-.015-12.784.897-19.745.897-19.745.711-4.146 2.787-5.192 2.787-5.192l74.859-43.219c.223-.129 2.487-1.584 3.195.923 1.95 6.9 1.488 31.887.275 39.878-.389 2.565-1.248 5.215-3.056 6.283L69.21 93.653c-.382.221-.749.288-1.08.248 0 0-2.781-.441-3.001-2.125-.561-4.281-1.152-8.781-1.167-21.351-.014-12.784.898-19.745.898-19.745.71-4.146 2.787-5.191 2.787-5.191l6.598-3.81.871-.119 6.599-3.83.046-.461L68.13 93.901' fill='#FAFAFA'/><path d='M68.317 94.161l-.215-.013h-.001l-.244-.047c-.719-.156-2.772-.736-2.976-2.292-.568-4.34-1.154-8.813-1.168-21.384-.014-12.654.891-19.707.9-19.777.725-4.231 2.832-5.338 2.922-5.382l6.628-3.827.87-.119 6.446-3.742.034-.334a.248.248 0 0 1 .273-.223.248.248 0 0 1 .223.272l-.059.589-6.752 3.919-.87.118-6.556 3.785c-.031.016-1.99 1.068-2.666 5.018-.007.06-.908 7.086-.894 19.702.014 12.539.597 16.996 1.161 21.305.091.691.689 1.154 1.309 1.452a1.95 1.95 0 0 1-.236-.609c-.781-3.984-1.155-8.202-1.17-21.399-.014-12.653.891-19.707.9-19.777.725-4.231 2.832-5.337 2.922-5.382-.004.001 74.444-42.98 74.846-43.212l.028-.017c.904-.538 1.72-.688 2.36-.433.555.221.949.733 1.172 1.52 2.014 7.128 1.46 32.219.281 39.983-.507 3.341-1.575 5.515-3.175 6.462L69.335 93.869a2.023 2.023 0 0 1-1.018.292zm-.147-.507c.293.036.604-.037.915-.217l75.273-43.551c1.823-1.078 2.602-3.915 2.934-6.106 1.174-7.731 1.731-32.695-.268-39.772-.178-.631-.473-1.032-.876-1.192-.484-.193-1.166-.052-1.921.397l-.034.021-74.858 43.218c-.031.017-1.989 1.069-2.666 5.019-.007.059-.908 7.085-.894 19.702.015 13.155.386 17.351 1.161 21.303.09.461.476.983 1.037 1.139.114.025.185.037.196.039h.001z' fill='#455A64'/><path d='M69.317 68.982c.489-.281.885-.056.885.505 0 .56-.396 1.243-.885 1.525-.488.282-.884.057-.884-.504 0-.56.396-1.243.884-1.526' fill='#FFF'/><path d='M68.92 71.133c-.289 0-.487-.228-.487-.625 0-.56.396-1.243.884-1.526a.812.812 0 0 1 .397-.121c.289 0 .488.229.488.626 0 .56-.396 1.243-.885 1.525a.812.812 0 0 1-.397.121m.794-2.459a.976.976 0 0 0-.49.147c-.548.317-.978 1.058-.978 1.687 0 .486.271.812.674.812a.985.985 0 0 0 .491-.146c.548-.317.978-1.057.978-1.687 0-.486-.272-.813-.675-.813' fill='#8097A2'/><path d='M68.92 70.947c-.271 0-.299-.307-.299-.439 0-.491.361-1.116.79-1.363a.632.632 0 0 1 .303-.096c.272 0 .301.306.301.438 0 .491-.363 1.116-.791 1.364a.629.629 0 0 1-.304.096m.794-2.086a.812.812 0 0 0-.397.121c-.488.283-.884.966-.884 1.526 0 .397.198.625.487.625a.812.812 0 0 0 .397-.121c.489-.282.885-.965.885-1.525 0-.397-.199-.626-.488-.626' fill='#8097A2'/><path d='M69.444 85.35c.264-.152.477-.031.477.272 0 .303-.213.67-.477.822-.263.153-.477.031-.477-.271 0-.302.214-.671.477-.823' fill='#FFF'/><path d='M69.23 86.51c-.156 0-.263-.123-.263-.337 0-.302.214-.671.477-.823a.431.431 0 0 1 .214-.066c.156 0 .263.124.263.338 0 .303-.213.67-.477.822a.431.431 0 0 1-.214.066m.428-1.412c-.1 0-.203.029-.307.09-.32.185-.57.618-.57.985 0 .309.185.524.449.524a.63.63 0 0 0 .308-.09c.32-.185.57-.618.57-.985 0-.309-.185-.524-.45-.524' fill='#8097A2'/><path d='M69.23 86.322l-.076-.149c0-.235.179-.544.384-.661l.12-.041.076.151c0 .234-.179.542-.383.66l-.121.04m.428-1.038a.431.431 0 0 0-.214.066c-.263.152-.477.521-.477.823 0 .214.107.337.263.337a.431.431 0 0 0 .214-.066c.264-.152.477-.519.477-.822 0-.214-.107-.338-.263-.338' fill='#8097A2'/><path d='M139.278 7.769v43.667L72.208 90.16V46.493l67.07-38.724' fill='#455A64'/><path d='M72.083 90.375V46.421l.063-.036 67.257-38.831v43.954l-.062.036-67.258 38.831zm.25-43.811v43.38l66.821-38.579V7.985L72.333 46.564z' fill='#607D8B'/></g><path d='M125.737 88.647l-7.639 3.334V84l-11.459 4.713v8.269L99 100.315l13.369 3.646 13.368-15.314' fill='#455A64'/></g></svg>";function ca(){this.loadIcon_();var v=document.createElement("div"),q=v.style;q.position="fixed",q.top=0,q.right=0,q.bottom=0,q.left=0,q.backgroundColor="gray",q.fontFamily="sans-serif",q.zIndex=1e6;var y=document.createElement("img");y.src=this.icon;var q=y.style;q.marginLeft="25%",q.marginTop="25%",q.width="50%",v.appendChild(y);var A=document.createElement("div"),q=A.style;q.textAlign="center",q.fontSize="16px",q.lineHeight="24px",q.margin="24px 25%",q.width="50%",A.innerHTML="Place your phone into your Cardboard viewer.",v.appendChild(A);var P=document.createElement("div"),q=P.style;q.backgroundColor="#CFD8DC",q.position="fixed",q.bottom=0,q.width="100%",q.height="48px",q.padding="14px 24px",q.boxSizing="border-box",q.color="#656A6B",v.appendChild(P);var O=document.createElement("div");O.style.float="left",O.innerHTML="No Cardboard viewer?";var j=document.createElement("a");j.href="https://www.google.com/get/cardboard/get-cardboard/",j.innerHTML="get one",j.target="_blank";var q=j.style;q.float="right",q.fontWeight=600,q.textTransform="uppercase",q.borderLeft="1px solid gray",q.paddingLeft="24px",q.textDecoration="none",q.color="#656A6B",P.appendChild(O),P.appendChild(j),this.overlay=v,this.text=A,this.hide()}ca.prototype.show=function(v){!v&&!this.overlay.parentElement?document.body.appendChild(this.overlay):v&&(this.overlay.parentElement&&this.overlay.parentElement!=v&&this.overlay.parentElement.removeChild(this.overlay),v.appendChild(this.overlay)),this.overlay.style.display="block";var y=this.overlay.querySelector("img"),A=y.style;Si()?(A.width="20%",A.marginLeft="40%",A.marginTop="3%"):(A.width="50%",A.marginLeft="25%",A.marginTop="25%")},ca.prototype.hide=function(){this.overlay.style.display="none"},ca.prototype.showTemporarily=function(v,y){this.show(y),this.timer=setTimeout(this.hide.bind(this),v)},ca.prototype.disableShowTemporarily=function(){clearTimeout(this.timer)},ca.prototype.update=function(){this.disableShowTemporarily(),!Si()&&Nr()?this.show():this.hide()},ca.prototype.loadIcon_=function(){this.icon=ae("image/svg+xml",zC)};var GC="CardboardV1",eb="WEBVR_CARDBOARD_VIEWER",HC="webvr-polyfill-viewer-selector";function vs(v){try{this.selectedKey=localStorage.getItem(eb)}catch(y){console.error("Failed to load viewer profile: %s",y)}this.selectedKey||(this.selectedKey=v||GC),this.dialog=this.createDialog_(ji.Viewers),this.root=null,this.onChangeCallbacks_=[]}vs.prototype.show=function(v){this.root=v,v.appendChild(this.dialog);var y=this.dialog.querySelector("#"+this.selectedKey);y.checked=!0,this.dialog.style.display="block"},vs.prototype.hide=function(){this.root&&this.root.contains(this.dialog)&&this.root.removeChild(this.dialog),this.dialog.style.display="none"},vs.prototype.getCurrentViewer=function(){return ji.Viewers[this.selectedKey]},vs.prototype.getSelectedKey_=function(){var v=this.dialog.querySelector("input[name=field]:checked");return v?v.id:null},vs.prototype.onChange=function(v){this.onChangeCallbacks_.push(v)},vs.prototype.fireOnChange_=function(v){for(var y=0;y<this.onChangeCallbacks_.length;y++)this.onChangeCallbacks_[y](v)},vs.prototype.onSave_=function(){if(this.selectedKey=this.getSelectedKey_(),!this.selectedKey||!ji.Viewers[this.selectedKey]){console.error("ViewerSelector.onSave_: this should never happen!");return}this.fireOnChange_(ji.Viewers[this.selectedKey]);try{localStorage.setItem(eb,this.selectedKey)}catch(v){console.error("Failed to save viewer profile: %s",v)}this.hide()},vs.prototype.createDialog_=function(v){var y=document.createElement("div");y.classList.add(HC),y.style.display="none";var A=document.createElement("div"),j=A.style;j.position="fixed",j.left=0,j.top=0,j.width="100%",j.height="100%",j.background="rgba(0, 0, 0, 0.3)",A.addEventListener("click",this.hide.bind(this));var P=280,O=document.createElement("div"),j=O.style;j.boxSizing="border-box",j.position="fixed",j.top="24px",j.left="50%",j.marginLeft=-P/2+"px",j.width=P+"px",j.padding="24px",j.overflow="hidden",j.background="#fafafa",j.fontFamily="'Roboto', sans-serif",j.boxShadow="0px 5px 20px #666",O.appendChild(this.createH1_("Select your viewer"));for(var q in v)O.appendChild(this.createChoice_(q,v[q].label));return O.appendChild(this.createButton_("Save",this.onSave_.bind(this))),y.appendChild(A),y.appendChild(O),y},vs.prototype.createH1_=function(v){var y=document.createElement("h1"),A=y.style;return A.color="black",A.fontSize="20px",A.fontWeight="bold",A.marginTop=0,A.marginBottom="24px",y.innerHTML=v,y},vs.prototype.createChoice_=function(v,y){var A=document.createElement("div");A.style.marginTop="8px",A.style.color="black";var P=document.createElement("input");P.style.fontSize="30px",P.setAttribute("id",v),P.setAttribute("type","radio"),P.setAttribute("value",v),P.setAttribute("name","field");var O=document.createElement("label");return O.style.marginLeft="4px",O.setAttribute("for",v),O.innerHTML=y,A.appendChild(P),A.appendChild(O),A},vs.prototype.createButton_=function(v,y){var A=document.createElement("button");A.innerHTML=v;var P=A.style;return P.float="right",P.textTransform="uppercase",P.color="#1094f7",P.fontSize="14px",P.letterSpacing=0,P.border=0,P.background="none",P.marginTop="16px",A.addEventListener("click",y),A};var WC=typeof window!="undefined"?window:typeof up!="undefined"?up:typeof self!="undefined"?self:{};function jC(v){return v&&v.__esModule&&Object.prototype.hasOwnProperty.call(v,"default")?v.default:v}function XC(v,y){return y={exports:{}},v(y,y.exports),y.exports}var qC=XC(function(v,y){(function(P,O){v.exports=O()})(WC,function(){return function(A){var P={};function O(j){if(P[j])return P[j].exports;var q=P[j]={i:j,l:!1,exports:{}};return A[j].call(q.exports,q,q.exports,O),q.l=!0,q.exports}return O.m=A,O.c=P,O.d=function(j,q,de){O.o(j,q)||Object.defineProperty(j,q,{configurable:!1,enumerable:!0,get:de})},O.n=function(j){var q=j&&j.__esModule?function(){return j.default}:function(){return j};return O.d(q,"a",q),q},O.o=function(j,q){return Object.prototype.hasOwnProperty.call(j,q)},O.p="",O(O.s=0)}([function(A,P,O){var j=function(){function ie(Te,et){for(var ot=0;ot<et.length;ot++){var ut=et[ot];ut.enumerable=ut.enumerable||!1,ut.configurable=!0,"value"in ut&&(ut.writable=!0),Object.defineProperty(Te,ut.key,ut)}}return function(Te,et,ot){return et&&ie(Te.prototype,et),ot&&ie(Te,ot),Te}}();function q(ie,Te){if(!(ie instanceof Te))throw new TypeError("Cannot call a class as a function")}var de=O(1),fe=typeof navigator!="undefined"&&parseFloat((""+(/CPU.*OS ([0-9_]{3,4})[0-9_]{0,1}|(CPU like).*AppleWebKit.*Mobile/i.exec(navigator.userAgent)||[0,""])[1]).replace("undefined","3_2").replace("_",".").replace("_",""))<10&&!window.MSStream,K=function(){function ie(){q(this,ie),fe?this.noSleepTimer=null:(this.noSleepVideo=document.createElement("video"),this.noSleepVideo.setAttribute("playsinline",""),this.noSleepVideo.setAttribute("src",de),this.noSleepVideo.addEventListener("timeupdate",function(Te){this.noSleepVideo.currentTime>.5&&(this.noSleepVideo.currentTime=Math.random())}.bind(this)))}return j(ie,[{key:"enable",value:function(){fe?(this.disable(),this.noSleepTimer=window.setInterval(function(){window.location.href="/",window.setTimeout(window.stop,0)},15e3)):this.noSleepVideo.play()}},{key:"disable",value:function(){fe?this.noSleepTimer&&(window.clearInterval(this.noSleepTimer),this.noSleepTimer=null):this.noSleepVideo.pause()}}]),ie}();A.exports=K},function(A,P,O){A.exports="data:video/mp4;base64,AAAAIGZ0eXBtcDQyAAACAGlzb21pc28yYXZjMW1wNDEAAAAIZnJlZQAACKBtZGF0AAAC8wYF///v3EXpvebZSLeWLNgg2SPu73gyNjQgLSBjb3JlIDE0MiByMjQ3OSBkZDc5YTYxIC0gSC4yNjQvTVBFRy00IEFWQyBjb2RlYyAtIENvcHlsZWZ0IDIwMDMtMjAxNCAtIGh0dHA6Ly93d3cudmlkZW9sYW4ub3JnL3gyNjQuaHRtbCAtIG9wdGlvbnM6IGNhYmFjPTEgcmVmPTEgZGVibG9jaz0xOjA6MCBhbmFseXNlPTB4MToweDExMSBtZT1oZXggc3VibWU9MiBwc3k9MSBwc3lfcmQ9MS4wMDowLjAwIG1peGVkX3JlZj0wIG1lX3JhbmdlPTE2IGNocm9tYV9tZT0xIHRyZWxsaXM9MCA4eDhkY3Q9MCBjcW09MCBkZWFkem9uZT0yMSwxMSBmYXN0X3Bza2lwPTEgY2hyb21hX3FwX29mZnNldD0wIHRocmVhZHM9NiBsb29rYWhlYWRfdGhyZWFkcz0xIHNsaWNlZF90aHJlYWRzPTAgbnI9MCBkZWNpbWF0ZT0xIGludGVybGFjZWQ9MCBibHVyYXlfY29tcGF0PTAgY29uc3RyYWluZWRfaW50cmE9MCBiZnJhbWVzPTMgYl9weXJhbWlkPTIgYl9hZGFwdD0xIGJfYmlhcz0wIGRpcmVjdD0xIHdlaWdodGI9MSBvcGVuX2dvcD0wIHdlaWdodHA9MSBrZXlpbnQ9MzAwIGtleWludF9taW49MzAgc2NlbmVjdXQ9NDAgaW50cmFfcmVmcmVzaD0wIHJjX2xvb2thaGVhZD0xMCByYz1jcmYgbWJ0cmVlPTEgY3JmPTIwLjAgcWNvbXA9MC42MCBxcG1pbj0wIHFwbWF4PTY5IHFwc3RlcD00IHZidl9tYXhyYXRlPTIwMDAwIHZidl9idWZzaXplPTI1MDAwIGNyZl9tYXg9MC4wIG5hbF9ocmQ9bm9uZSBmaWxsZXI9MCBpcF9yYXRpbz0xLjQwIGFxPTE6MS4wMACAAAAAOWWIhAA3//p+C7v8tDDSTjf97w55i3SbRPO4ZY+hkjD5hbkAkL3zpJ6h/LR1CAABzgB1kqqzUorlhQAAAAxBmiQYhn/+qZYADLgAAAAJQZ5CQhX/AAj5IQADQGgcIQADQGgcAAAACQGeYUQn/wALKCEAA0BoHAAAAAkBnmNEJ/8ACykhAANAaBwhAANAaBwAAAANQZpoNExDP/6plgAMuSEAA0BoHAAAAAtBnoZFESwr/wAI+SEAA0BoHCEAA0BoHAAAAAkBnqVEJ/8ACykhAANAaBwAAAAJAZ6nRCf/AAsoIQADQGgcIQADQGgcAAAADUGarDRMQz/+qZYADLghAANAaBwAAAALQZ7KRRUsK/8ACPkhAANAaBwAAAAJAZ7pRCf/AAsoIQADQGgcIQADQGgcAAAACQGe60Qn/wALKCEAA0BoHAAAAA1BmvA0TEM//qmWAAy5IQADQGgcIQADQGgcAAAAC0GfDkUVLCv/AAj5IQADQGgcAAAACQGfLUQn/wALKSEAA0BoHCEAA0BoHAAAAAkBny9EJ/8ACyghAANAaBwAAAANQZs0NExDP/6plgAMuCEAA0BoHAAAAAtBn1JFFSwr/wAI+SEAA0BoHCEAA0BoHAAAAAkBn3FEJ/8ACyghAANAaBwAAAAJAZ9zRCf/AAsoIQADQGgcIQADQGgcAAAADUGbeDRMQz/+qZYADLkhAANAaBwAAAALQZ+WRRUsK/8ACPghAANAaBwhAANAaBwAAAAJAZ+1RCf/AAspIQADQGgcAAAACQGft0Qn/wALKSEAA0BoHCEAA0BoHAAAAA1Bm7w0TEM//qmWAAy4IQADQGgcAAAAC0Gf2kUVLCv/AAj5IQADQGgcAAAACQGf+UQn/wALKCEAA0BoHCEAA0BoHAAAAAkBn/tEJ/8ACykhAANAaBwAAAANQZvgNExDP/6plgAMuSEAA0BoHCEAA0BoHAAAAAtBnh5FFSwr/wAI+CEAA0BoHAAAAAkBnj1EJ/8ACyghAANAaBwhAANAaBwAAAAJAZ4/RCf/AAspIQADQGgcAAAADUGaJDRMQz/+qZYADLghAANAaBwAAAALQZ5CRRUsK/8ACPkhAANAaBwhAANAaBwAAAAJAZ5hRCf/AAsoIQADQGgcAAAACQGeY0Qn/wALKSEAA0BoHCEAA0BoHAAAAA1Bmmg0TEM//qmWAAy5IQADQGgcAAAAC0GehkUVLCv/AAj5IQADQGgcIQADQGgcAAAACQGepUQn/wALKSEAA0BoHAAAAAkBnqdEJ/8ACyghAANAaBwAAAANQZqsNExDP/6plgAMuCEAA0BoHCEAA0BoHAAAAAtBnspFFSwr/wAI+SEAA0BoHAAAAAkBnulEJ/8ACyghAANAaBwhAANAaBwAAAAJAZ7rRCf/AAsoIQADQGgcAAAADUGa8DRMQz/+qZYADLkhAANAaBwhAANAaBwAAAALQZ8ORRUsK/8ACPkhAANAaBwAAAAJAZ8tRCf/AAspIQADQGgcIQADQGgcAAAACQGfL0Qn/wALKCEAA0BoHAAAAA1BmzQ0TEM//qmWAAy4IQADQGgcAAAAC0GfUkUVLCv/AAj5IQADQGgcIQADQGgcAAAACQGfcUQn/wALKCEAA0BoHAAAAAkBn3NEJ/8ACyghAANAaBwhAANAaBwAAAANQZt4NExC//6plgAMuSEAA0BoHAAAAAtBn5ZFFSwr/wAI+CEAA0BoHCEAA0BoHAAAAAkBn7VEJ/8ACykhAANAaBwAAAAJAZ+3RCf/AAspIQADQGgcAAAADUGbuzRMQn/+nhAAYsAhAANAaBwhAANAaBwAAAAJQZ/aQhP/AAspIQADQGgcAAAACQGf+UQn/wALKCEAA0BoHCEAA0BoHCEAA0BoHCEAA0BoHCEAA0BoHCEAA0BoHAAACiFtb292AAAAbG12aGQAAAAA1YCCX9WAgl8AAAPoAAAH/AABAAABAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADAAAAGGlvZHMAAAAAEICAgAcAT////v7/AAAF+XRyYWsAAABcdGtoZAAAAAPVgIJf1YCCXwAAAAEAAAAAAAAH0AAAAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAEAAAAAAygAAAMoAAAAAACRlZHRzAAAAHGVsc3QAAAAAAAAAAQAAB9AAABdwAAEAAAAABXFtZGlhAAAAIG1kaGQAAAAA1YCCX9WAgl8AAV+QAAK/IFXEAAAAAAAtaGRscgAAAAAAAAAAdmlkZQAAAAAAAAAAAAAAAFZpZGVvSGFuZGxlcgAAAAUcbWluZgAAABR2bWhkAAAAAQAAAAAAAAAAAAAAJGRpbmYAAAAcZHJlZgAAAAAAAAABAAAADHVybCAAAAABAAAE3HN0YmwAAACYc3RzZAAAAAAAAAABAAAAiGF2YzEAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAygDKAEgAAABIAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAY//8AAAAyYXZjQwFNQCj/4QAbZ01AKOyho3ySTUBAQFAAAAMAEAAr8gDxgxlgAQAEaO+G8gAAABhzdHRzAAAAAAAAAAEAAAA8AAALuAAAABRzdHNzAAAAAAAAAAEAAAABAAAB8GN0dHMAAAAAAAAAPAAAAAEAABdwAAAAAQAAOpgAAAABAAAXcAAAAAEAAAAAAAAAAQAAC7gAAAABAAA6mAAAAAEAABdwAAAAAQAAAAAAAAABAAALuAAAAAEAADqYAAAAAQAAF3AAAAABAAAAAAAAAAEAAAu4AAAAAQAAOpgAAAABAAAXcAAAAAEAAAAAAAAAAQAAC7gAAAABAAA6mAAAAAEAABdwAAAAAQAAAAAAAAABAAALuAAAAAEAADqYAAAAAQAAF3AAAAABAAAAAAAAAAEAAAu4AAAAAQAAOpgAAAABAAAXcAAAAAEAAAAAAAAAAQAAC7gAAAABAAA6mAAAAAEAABdwAAAAAQAAAAAAAAABAAALuAAAAAEAADqYAAAAAQAAF3AAAAABAAAAAAAAAAEAAAu4AAAAAQAAOpgAAAABAAAXcAAAAAEAAAAAAAAAAQAAC7gAAAABAAA6mAAAAAEAABdwAAAAAQAAAAAAAAABAAALuAAAAAEAADqYAAAAAQAAF3AAAAABAAAAAAAAAAEAAAu4AAAAAQAAOpgAAAABAAAXcAAAAAEAAAAAAAAAAQAAC7gAAAABAAA6mAAAAAEAABdwAAAAAQAAAAAAAAABAAALuAAAAAEAAC7gAAAAAQAAF3AAAAABAAAAAAAAABxzdHNjAAAAAAAAAAEAAAABAAAAAQAAAAEAAAEEc3RzegAAAAAAAAAAAAAAPAAAAzQAAAAQAAAADQAAAA0AAAANAAAAEQAAAA8AAAANAAAADQAAABEAAAAPAAAADQAAAA0AAAARAAAADwAAAA0AAAANAAAAEQAAAA8AAAANAAAADQAAABEAAAAPAAAADQAAAA0AAAARAAAADwAAAA0AAAANAAAAEQAAAA8AAAANAAAADQAAABEAAAAPAAAADQAAAA0AAAARAAAADwAAAA0AAAANAAAAEQAAAA8AAAANAAAADQAAABEAAAAPAAAADQAAAA0AAAARAAAADwAAAA0AAAANAAAAEQAAAA8AAAANAAAADQAAABEAAAANAAAADQAAAQBzdGNvAAAAAAAAADwAAAAwAAADZAAAA3QAAAONAAADoAAAA7kAAAPQAAAD6wAAA/4AAAQXAAAELgAABEMAAARcAAAEbwAABIwAAAShAAAEugAABM0AAATkAAAE/wAABRIAAAUrAAAFQgAABV0AAAVwAAAFiQAABaAAAAW1AAAFzgAABeEAAAX+AAAGEwAABiwAAAY/AAAGVgAABnEAAAaEAAAGnQAABrQAAAbPAAAG4gAABvUAAAcSAAAHJwAAB0AAAAdTAAAHcAAAB4UAAAeeAAAHsQAAB8gAAAfjAAAH9gAACA8AAAgmAAAIQQAACFQAAAhnAAAIhAAACJcAAAMsdHJhawAAAFx0a2hkAAAAA9WAgl/VgIJfAAAAAgAAAAAAAAf8AAAAAAAAAAAAAAABAQAAAAABAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAACsm1kaWEAAAAgbWRoZAAAAADVgIJf1YCCXwAArEQAAWAAVcQAAAAAACdoZGxyAAAAAAAAAABzb3VuAAAAAAAAAAAAAAAAU3RlcmVvAAAAAmNtaW5mAAAAEHNtaGQAAAAAAAAAAAAAACRkaW5mAAAAHGRyZWYAAAAAAAAAAQAAAAx1cmwgAAAAAQAAAidzdGJsAAAAZ3N0c2QAAAAAAAAAAQAAAFdtcDRhAAAAAAAAAAEAAAAAAAAAAAACABAAAAAArEQAAAAAADNlc2RzAAAAAAOAgIAiAAIABICAgBRAFQAAAAADDUAAAAAABYCAgAISEAaAgIABAgAAABhzdHRzAAAAAAAAAAEAAABYAAAEAAAAABxzdHNjAAAAAAAAAAEAAAABAAAAAQAAAAEAAAAUc3RzegAAAAAAAAAGAAAAWAAAAXBzdGNvAAAAAAAAAFgAAAOBAAADhwAAA5oAAAOtAAADswAAA8oAAAPfAAAD5QAAA/gAAAQLAAAEEQAABCgAAAQ9AAAEUAAABFYAAARpAAAEgAAABIYAAASbAAAErgAABLQAAATHAAAE3gAABPMAAAT5AAAFDAAABR8AAAUlAAAFPAAABVEAAAVXAAAFagAABX0AAAWDAAAFmgAABa8AAAXCAAAFyAAABdsAAAXyAAAF+AAABg0AAAYgAAAGJgAABjkAAAZQAAAGZQAABmsAAAZ+AAAGkQAABpcAAAauAAAGwwAABskAAAbcAAAG7wAABwYAAAcMAAAHIQAABzQAAAc6AAAHTQAAB2QAAAdqAAAHfwAAB5IAAAeYAAAHqwAAB8IAAAfXAAAH3QAAB/AAAAgDAAAICQAACCAAAAg1AAAIOwAACE4AAAhhAAAIeAAACH4AAAiRAAAIpAAACKoAAAiwAAAItgAACLwAAAjCAAAAFnVkdGEAAAAObmFtZVN0ZXJlbwAAAHB1ZHRhAAAAaG1ldGEAAAAAAAAAIWhkbHIAAAAAAAAAAG1kaXJhcHBsAAAAAAAAAAAAAAAAO2lsc3QAAAAzqXRvbwAAACtkYXRhAAAAAQAAAABIYW5kQnJha2UgMC4xMC4yIDIwMTUwNjExMDA="}])})}),YC=jC(qC),QC=1e3,KC=[0,0,.5,1],$C=[.5,0,.5,1],ZC=window.requestAnimationFrame,JC=window.cancelAnimationFrame;function eR(){this.leftProjectionMatrix=new Float32Array(16),this.leftViewMatrix=new Float32Array(16),this.rightProjectionMatrix=new Float32Array(16),this.rightViewMatrix=new Float32Array(16),this.pose=null}function tb(v){Object.defineProperties(this,{hasPosition:{writable:!1,enumerable:!0,value:v.hasPosition},hasExternalDisplay:{writable:!1,enumerable:!0,value:v.hasExternalDisplay},canPresent:{writable:!1,enumerable:!0,value:v.canPresent},maxLayers:{writable:!1,enumerable:!0,value:v.maxLayers},hasOrientation:{enumerable:!0,get:function(){return ra("VRDisplayCapabilities.prototype.hasOrientation","VRDisplay.prototype.getFrameData"),v.hasOrientation}}})}function vi(v){v=v||{};var y="wakelock"in v?v.wakelock:!0;this.isPolyfilled=!0,this.displayId=QC++,this.displayName="",this.depthNear=.01,this.depthFar=1e4,this.isPresenting=!1,Object.defineProperty(this,"isConnected",{get:function(){return ra("VRDisplay.prototype.isConnected","VRDisplayCapabilities.prototype.hasExternalDisplay"),!1}}),this.capabilities=new tb({hasPosition:!1,hasOrientation:!1,hasExternalDisplay:!1,canPresent:!1,maxLayers:1}),this.stageParameters=null,this.waitingForPresent_=!1,this.layer_=null,this.originalParent_=null,this.fullscreenElement_=null,this.fullscreenWrapper_=null,this.fullscreenElementCachedStyle_=null,this.fullscreenEventTarget_=null,this.fullscreenChangeHandler_=null,this.fullscreenErrorHandler_=null,y&&Nr()&&(this.wakelock_=new YC)}vi.prototype.getFrameData=function(v){return Li(v,this._getPose(),this)},vi.prototype.getPose=function(){return ra("VRDisplay.prototype.getPose","VRDisplay.prototype.getFrameData"),this._getPose()},vi.prototype.resetPose=function(){return ra("VRDisplay.prototype.resetPose"),this._resetPose()},vi.prototype.getImmediatePose=function(){return ra("VRDisplay.prototype.getImmediatePose","VRDisplay.prototype.getFrameData"),this._getPose()},vi.prototype.requestAnimationFrame=function(v){return ZC(v)},vi.prototype.cancelAnimationFrame=function(v){return JC(v)},vi.prototype.wrapForFullscreen=function(v){if(be())return v;if(!this.fullscreenWrapper_){this.fullscreenWrapper_=document.createElement("div");var y=["height: "+Math.min(screen.height,screen.width)+"px !important","top: 0 !important","left: 0 !important","right: 0 !important","border: 0","margin: 0","padding: 0","z-index: 999999 !important","position: fixed"];this.fullscreenWrapper_.setAttribute("style",y.join("; ")+";"),this.fullscreenWrapper_.classList.add("webvr-polyfill-fullscreen-wrapper")}if(this.fullscreenElement_==v)return this.fullscreenWrapper_;if(this.fullscreenElement_&&(this.originalParent_?this.originalParent_.appendChild(this.fullscreenElement_):this.fullscreenElement_.parentElement.removeChild(this.fullscreenElement_)),this.fullscreenElement_=v,this.originalParent_=v.parentElement,this.originalParent_||document.body.appendChild(v),!this.fullscreenWrapper_.parentElement){var A=this.fullscreenElement_.parentElement;A.insertBefore(this.fullscreenWrapper_,this.fullscreenElement_),A.removeChild(this.fullscreenElement_)}this.fullscreenWrapper_.insertBefore(this.fullscreenElement_,this.fullscreenWrapper_.firstChild),this.fullscreenElementCachedStyle_=this.fullscreenElement_.getAttribute("style");var P=this;function O(){if(P.fullscreenElement_){var j=["position: absolute","top: 0","left: 0","width: "+Math.max(screen.width,screen.height)+"px","height: "+Math.min(screen.height,screen.width)+"px","border: 0","margin: 0","padding: 0"];P.fullscreenElement_.setAttribute("style",j.join("; ")+";")}}return O(),this.fullscreenWrapper_},vi.prototype.removeFullscreenWrapper=function(){if(this.fullscreenElement_){var v=this.fullscreenElement_;this.fullscreenElementCachedStyle_?v.setAttribute("style",this.fullscreenElementCachedStyle_):v.removeAttribute("style"),this.fullscreenElement_=null,this.fullscreenElementCachedStyle_=null;var y=this.fullscreenWrapper_.parentElement;return this.fullscreenWrapper_.removeChild(v),this.originalParent_===y?y.insertBefore(v,this.fullscreenWrapper_):this.originalParent_&&this.originalParent_.appendChild(v),y.removeChild(this.fullscreenWrapper_),v}},vi.prototype.requestPresent=function(v){var y=this.isPresenting,A=this;return v instanceof Array||(ra("VRDisplay.prototype.requestPresent with non-array argument","an array of VRLayers as the first argument"),v=[v]),new Promise(function(P,O){if(!A.capabilities.canPresent){O(new Error("VRDisplay is not capable of presenting."));return}if(v.length==0||v.length>A.capabilities.maxLayers){O(new Error("Invalid number of layers."));return}var j=v[0];if(!j.source){P();return}var q=j.leftBounds||KC,de=j.rightBounds||$C;if(y){var fe=A.layer_;fe.source!==j.source&&(fe.source=j.source);for(var K=0;K<4;K++)fe.leftBounds[K]=q[K],fe.rightBounds[K]=de[K];A.wrapForFullscreen(A.layer_.source),A.updatePresent_(),P();return}if(A.layer_={predistorted:j.predistorted,source:j.source,leftBounds:q.slice(0),rightBounds:de.slice(0)},A.waitingForPresent_=!1,A.layer_&&A.layer_.source){var ie=A.wrapForFullscreen(A.layer_.source),Te=function(){var ut=ks();A.isPresenting=ie===ut,A.isPresenting?(screen.orientation&&screen.orientation.lock&&screen.orientation.lock("landscape-primary").catch(function(It){console.error("screen.orientation.lock() failed due to",It.message)}),A.waitingForPresent_=!1,A.beginPresent_(),P()):(screen.orientation&&screen.orientation.unlock&&screen.orientation.unlock(),A.removeFullscreenWrapper(),A.disableWakeLock(),A.endPresent_(),A.removeFullscreenListeners_()),A.fireVRDisplayPresentChange_()},et=function(){A.waitingForPresent_&&(A.removeFullscreenWrapper(),A.removeFullscreenListeners_(),A.disableWakeLock(),A.waitingForPresent_=!1,A.isPresenting=!1,O(new Error("Unable to present.")))};A.addFullscreenListeners_(ie,Te,et),Gt(ie)?(A.enableWakeLock(),A.waitingForPresent_=!0):(be()||Qe())&&(A.enableWakeLock(),A.isPresenting=!0,A.beginPresent_(),A.fireVRDisplayPresentChange_(),P())}!A.waitingForPresent_&&!be()&&(St(),O(new Error("Unable to present.")))})},vi.prototype.exitPresent=function(){var v=this.isPresenting,y=this;return this.isPresenting=!1,this.layer_=null,this.disableWakeLock(),new Promise(function(A,P){v?(!St()&&be()&&(y.endPresent_(),y.fireVRDisplayPresentChange_()),Qe()&&(y.removeFullscreenWrapper(),y.removeFullscreenListeners_(),y.endPresent_(),y.fireVRDisplayPresentChange_()),A()):P(new Error("Was not presenting to VRDisplay."))})},vi.prototype.getLayers=function(){return this.layer_?[this.layer_]:[]},vi.prototype.fireVRDisplayPresentChange_=function(){var v=new CustomEvent("vrdisplaypresentchange",{detail:{display:this}});window.dispatchEvent(v)},vi.prototype.fireVRDisplayConnect_=function(){var v=new CustomEvent("vrdisplayconnect",{detail:{display:this}});window.dispatchEvent(v)},vi.prototype.addFullscreenListeners_=function(v,y,A){this.removeFullscreenListeners_(),this.fullscreenEventTarget_=v,this.fullscreenChangeHandler_=y,this.fullscreenErrorHandler_=A,y&&(document.fullscreenEnabled?v.addEventListener("fullscreenchange",y,!1):document.webkitFullscreenEnabled?v.addEventListener("webkitfullscreenchange",y,!1):document.mozFullScreenEnabled?document.addEventListener("mozfullscreenchange",y,!1):document.msFullscreenEnabled&&v.addEventListener("msfullscreenchange",y,!1)),A&&(document.fullscreenEnabled?v.addEventListener("fullscreenerror",A,!1):document.webkitFullscreenEnabled?v.addEventListener("webkitfullscreenerror",A,!1):document.mozFullScreenEnabled?document.addEventListener("mozfullscreenerror",A,!1):document.msFullscreenEnabled&&v.addEventListener("msfullscreenerror",A,!1))},vi.prototype.removeFullscreenListeners_=function(){if(this.fullscreenEventTarget_){var v=this.fullscreenEventTarget_;if(this.fullscreenChangeHandler_){var y=this.fullscreenChangeHandler_;v.removeEventListener("fullscreenchange",y,!1),v.removeEventListener("webkitfullscreenchange",y,!1),document.removeEventListener("mozfullscreenchange",y,!1),v.removeEventListener("msfullscreenchange",y,!1)}if(this.fullscreenErrorHandler_){var A=this.fullscreenErrorHandler_;v.removeEventListener("fullscreenerror",A,!1),v.removeEventListener("webkitfullscreenerror",A,!1),document.removeEventListener("mozfullscreenerror",A,!1),v.removeEventListener("msfullscreenerror",A,!1)}this.fullscreenEventTarget_=null,this.fullscreenChangeHandler_=null,this.fullscreenErrorHandler_=null}},vi.prototype.enableWakeLock=function(){this.wakelock_&&this.wakelock_.enable()},vi.prototype.disableWakeLock=function(){this.wakelock_&&this.wakelock_.disable()},vi.prototype.beginPresent_=function(){},vi.prototype.endPresent_=function(){},vi.prototype.submitFrame=function(v){},vi.prototype.getEyeParameters=function(v){return null};var tR={ADDITIONAL_VIEWERS:[],DEFAULT_VIEWER:"",MOBILE_WAKE_LOCK:!0,DEBUG:!1,DPDB_URL:"https://dpdb.webvr.rocks/dpdb.json",K_FILTER:.98,PREDICTION_TIME_S:.04,CARDBOARD_UI_DISABLED:!1,ROTATE_INSTRUCTIONS_DISABLED:!1,YAW_ONLY:!1,BUFFER_SCALE:.5,DIRTY_SUBMIT_FRAME_BINDINGS:!1},Ad={LEFT:"left",RIGHT:"right"};function Xi(v){var y=go({},tR);v=go(y,v||{}),vi.call(this,{wakelock:v.MOBILE_WAKE_LOCK}),this.config=v,this.displayName="Cardboard VRDisplay",this.capabilities=new tb({hasPosition:!1,hasOrientation:!0,hasExternalDisplay:!1,canPresent:!0,maxLayers:1}),this.stageParameters=null,this.bufferScale_=this.config.BUFFER_SCALE,this.poseSensor_=new VC(this.config),this.distorter_=null,this.cardboardUI_=null,this.dpdb_=new bc(this.config.DPDB_URL,this.onDeviceParamsUpdated_.bind(this)),this.deviceInfo_=new ji(this.dpdb_.getDeviceParams(),v.ADDITIONAL_VIEWERS),this.viewerSelector_=new vs(v.DEFAULT_VIEWER),this.viewerSelector_.onChange(this.onViewerChanged_.bind(this)),this.deviceInfo_.setViewer(this.viewerSelector_.getCurrentViewer()),this.config.ROTATE_INSTRUCTIONS_DISABLED||(this.rotateInstructions_=new ca),be()&&window.addEventListener("resize",this.onResize_.bind(this))}return Xi.prototype=Object.create(vi.prototype),Xi.prototype._getPose=function(){return{position:null,orientation:this.poseSensor_.getOrientation(),linearVelocity:null,linearAcceleration:null,angularVelocity:null,angularAcceleration:null}},Xi.prototype._resetPose=function(){this.poseSensor_.resetPose&&this.poseSensor_.resetPose()},Xi.prototype._getFieldOfView=function(v){var y;if(v==Ad.LEFT)y=this.deviceInfo_.getFieldOfViewLeftEye();else if(v==Ad.RIGHT)y=this.deviceInfo_.getFieldOfViewRightEye();else return console.error("Invalid eye provided: %s",v),null;return y},Xi.prototype._getEyeOffset=function(v){var y;if(v==Ad.LEFT)y=[-this.deviceInfo_.viewer.interLensDistance*.5,0,0];else if(v==Ad.RIGHT)y=[this.deviceInfo_.viewer.interLensDistance*.5,0,0];else return console.error("Invalid eye provided: %s",v),null;return y},Xi.prototype.getEyeParameters=function(v){var y=this._getEyeOffset(v),A=this._getFieldOfView(v),P={offset:y,renderWidth:this.deviceInfo_.device.width*.5*this.bufferScale_,renderHeight:this.deviceInfo_.device.height*this.bufferScale_};return Object.defineProperty(P,"fieldOfView",{enumerable:!0,get:function(){return ra("VRFieldOfView","VRFrameData's projection matrices"),A}}),P},Xi.prototype.onDeviceParamsUpdated_=function(v){this.config.DEBUG&&console.log("DPDB reported that device params were updated."),this.deviceInfo_.updateDeviceParams(v),this.distorter_&&this.distorter_.updateDeviceInfo(this.deviceInfo_)},Xi.prototype.updateBounds_=function(){this.layer_&&this.distorter_&&(this.layer_.leftBounds||this.layer_.rightBounds)&&this.distorter_.setTextureBounds(this.layer_.leftBounds,this.layer_.rightBounds)},Xi.prototype.beginPresent_=function(){var v=this.layer_.source.getContext("webgl");v||(v=this.layer_.source.getContext("experimental-webgl")),v||(v=this.layer_.source.getContext("webgl2")),v&&(this.layer_.predistorted?this.config.CARDBOARD_UI_DISABLED||(v.canvas.width=Ct()*this.bufferScale_,v.canvas.height=Ft()*this.bufferScale_,this.cardboardUI_=new aa(v)):(this.config.CARDBOARD_UI_DISABLED||(this.cardboardUI_=new aa(v)),this.distorter_=new Vs(v,this.cardboardUI_,this.config.BUFFER_SCALE,this.config.DIRTY_SUBMIT_FRAME_BINDINGS),this.distorter_.updateDeviceInfo(this.deviceInfo_)),this.cardboardUI_&&this.cardboardUI_.listen(function(y){this.viewerSelector_.show(this.layer_.source.parentElement),y.stopPropagation(),y.preventDefault()}.bind(this),function(y){this.exitPresent(),y.stopPropagation(),y.preventDefault()}.bind(this)),this.rotateInstructions_&&(Si()&&Nr()?this.rotateInstructions_.showTemporarily(3e3,this.layer_.source.parentElement):this.rotateInstructions_.update()),this.orientationHandler=this.onOrientationChange_.bind(this),window.addEventListener("orientationchange",this.orientationHandler),this.vrdisplaypresentchangeHandler=this.updateBounds_.bind(this),window.addEventListener("vrdisplaypresentchange",this.vrdisplaypresentchangeHandler),this.fireVRDisplayDeviceParamsChange_())},Xi.prototype.endPresent_=function(){this.distorter_&&(this.distorter_.destroy(),this.distorter_=null),this.cardboardUI_&&(this.cardboardUI_.destroy(),this.cardboardUI_=null),this.rotateInstructions_&&this.rotateInstructions_.hide(),this.viewerSelector_.hide(),window.removeEventListener("orientationchange",this.orientationHandler),window.removeEventListener("vrdisplaypresentchange",this.vrdisplaypresentchangeHandler)},Xi.prototype.updatePresent_=function(){this.endPresent_(),this.beginPresent_()},Xi.prototype.submitFrame=function(v){if(this.distorter_)this.updateBounds_(),this.distorter_.submitFrame();else if(this.cardboardUI_&&this.layer_){var y=this.layer_.source.getContext("webgl");y||(y=this.layer_.source.getContext("experimental-webgl")),y||(y=this.layer_.source.getContext("webgl2"));var A=y.canvas;(A.width!=this.lastWidth||A.height!=this.lastHeight)&&this.cardboardUI_.onResize(),this.lastWidth=A.width,this.lastHeight=A.height,this.cardboardUI_.render()}},Xi.prototype.onOrientationChange_=function(v){this.viewerSelector_.hide(),this.rotateInstructions_&&this.rotateInstructions_.update(),this.onResize_()},Xi.prototype.onResize_=function(v){if(this.layer_){var y=this.layer_.source.getContext("webgl");y||(y=this.layer_.source.getContext("experimental-webgl")),y||(y=this.layer_.source.getContext("webgl2"));var A=["position: absolute","top: 0","left: 0","width: 100vw","height: 100vh","border: 0","margin: 0","padding: 0px","box-sizing: content-box"];y.canvas.setAttribute("style",A.join("; ")+";"),Ur(y.canvas)}},Xi.prototype.onViewerChanged_=function(v){this.deviceInfo_.setViewer(v),this.distorter_&&this.distorter_.updateDeviceInfo(this.deviceInfo_),this.fireVRDisplayDeviceParamsChange_()},Xi.prototype.fireVRDisplayDeviceParamsChange_=function(){var v=new CustomEvent("vrdisplaydeviceparamschange",{detail:{vrdisplay:this,deviceInfo:this.deviceInfo_}});window.dispatchEvent(v)},Xi.VRFrameData=eR,Xi.VRDisplay=vi,Xi})}),jP=GP(WP);class N0 extends e{constructor(_){super(),this.global=_,this.onWindowResize=this.onWindowResize.bind(this),this.global.window.addEventListener("resize",this.onWindowResize),this.environmentBlendMode="opaque"}onBaseLayerSet(_,S){throw new Error("Not implemented")}isSessionSupported(_){throw new Error("Not implemented")}isFeatureSupported(_){throw new Error("Not implemented")}requestSession(_,S){return $t(this,null,function*(){throw new Error("Not implemented")})}requestAnimationFrame(_){throw new Error("Not implemented")}onFrameStart(_){throw new Error("Not implemented")}onFrameEnd(_){throw new Error("Not implemented")}doesSessionSupportReferenceSpace(_,S){throw new Error("Not implemented")}requestStageBounds(){throw new Error("Not implemented")}requestFrameOfReferenceTransform(_,S){return $t(this,null,function*(){})}cancelAnimationFrame(_){throw new Error("Not implemented")}endSession(_){throw new Error("Not implemented")}getViewport(_,S,R,G){throw new Error("Not implemented")}getProjectionMatrix(_){throw new Error("Not implemented")}getBasePoseMatrix(){throw new Error("Not implemented")}getBaseViewMatrix(_){throw new Error("Not implemented")}getInputSources(){throw new Error("Not implemented")}getInputPose(_,S,R){throw new Error("Not implemented")}onWindowResize(){this.onWindowResize()}}let XP={mapping:"",profiles:["google-daydream","generic-trigger-touchpad"],buttons:{length:3,0:null,1:null,2:0}},qP={mapping:"xr-standard",profiles:["htc-vive-focus","generic-trigger-touchpad"],buttons:{length:3,0:1,1:null,2:0}},YP={mapping:"xr-standard",profiles:["oculus-go","generic-trigger-touchpad"],buttons:{length:3,0:1,1:null,2:0},gripTransform:{orientation:[Math.PI*.11,0,0,1]}},U0={mapping:"xr-standard",displayProfiles:{"Oculus Quest":["oculus-touch-v2","oculus-touch","generic-trigger-squeeze-thumbstick"]},profiles:["oculus-touch","generic-trigger-squeeze-thumbstick"],axes:{length:4,0:null,1:null,2:0,3:1},buttons:{length:7,0:1,1:2,2:null,3:0,4:3,5:4,6:null},gripTransform:{position:[0,-.02,.04,1],orientation:[Math.PI*.11,0,0,1]}},QP={mapping:"xr-standard",profiles:["htc-vive","generic-trigger-squeeze-touchpad"],displayProfiles:{"HTC Vive":["htc-vive","generic-trigger-squeeze-touchpad"],"HTC Vive DVT":["htc-vive","generic-trigger-squeeze-touchpad"],"Valve Index":["valve-index","generic-trigger-squeeze-touchpad-thumbstick"]},buttons:{length:3,0:1,1:2,2:0},gripTransform:{position:[0,0,.05,1]},targetRayTransform:{orientation:[Math.PI*-.08,0,0,1]},userAgentOverrides:{Firefox:{axes:{invert:[1,3]}}}},KP={mapping:"xr-standard",profiles:["samsung-gearvr","generic-trigger-touchpad"],buttons:{length:3,0:1,1:null,2:0},gripTransform:{orientation:[Math.PI*.11,0,0,1]}},$P={mapping:"xr-standard",profiles:["samsung-odyssey","microsoft-mixed-reality","generic-trigger-squeeze-touchpad-thumbstick"],buttons:{length:4,0:1,1:0,2:2,3:4},gripTransform:{position:[0,-.02,.04,1],orientation:[Math.PI*.11,0,0,1]}},fp={mapping:"xr-standard",profiles:["microsoft-mixed-reality","generic-trigger-squeeze-touchpad-thumbstick"],buttons:{length:4,0:1,1:0,2:2,3:4},gripTransform:{position:[0,-.02,.04,1],orientation:[Math.PI*.11,0,0,1]}},ZP={"Daydream Controller":XP,"Gear VR Controller":KP,"HTC Vive Focus Controller":qP,"Oculus Go Controller":YP,"Oculus Touch (Right)":U0,"Oculus Touch (Left)":U0,"OpenVR Gamepad":QP,"Spatial Controller (Spatial Interaction Source) 045E-065A":fp,"Spatial Controller (Spatial Interaction Source) 045E-065D":$P,"Windows Mixed Reality (Right)":fp,"Windows Mixed Reality (Left)":fp};const k0=w(.155,-.465,-.15),JP=w(-.155,-.465,-.15),eC=w(0,0,-.25),tC=w(0,0,.05),V0=w(-.08,.14,.08),z0=.4,iC=.4,nC=.61,sC=.175,rC=.12,oC=.87,G0=180/Math.PI;function aC(E,_,S){function R(Se,be,Qe){return Se<be?be:Se>Qe?Qe:Se}var G=_[0]*_[0],Q=_[1]*_[1],J=_[2]*_[2],ae=_[3]*_[3];if(S==="XYZ")E[0]=Math.atan2(2*(_[0]*_[3]-_[1]*_[2]),ae-G-Q+J),E[1]=Math.asin(R(2*(_[0]*_[2]+_[1]*_[3]),-1,1)),E[2]=Math.atan2(2*(_[2]*_[3]-_[0]*_[1]),ae+G-Q-J);else if(S==="YXZ")E[0]=Math.asin(R(2*(_[0]*_[3]-_[1]*_[2]),-1,1)),E[1]=Math.atan2(2*(_[0]*_[2]+_[1]*_[3]),ae-G-Q+J),E[2]=Math.atan2(2*(_[0]*_[1]+_[2]*_[3]),ae-G+Q-J);else if(S==="ZXY")E[0]=Math.asin(R(2*(_[0]*_[3]+_[1]*_[2]),-1,1)),E[1]=Math.atan2(2*(_[1]*_[3]-_[2]*_[0]),ae-G-Q+J),E[2]=Math.atan2(2*(_[2]*_[3]-_[0]*_[1]),ae-G+Q-J);else if(S==="ZYX")E[0]=Math.atan2(2*(_[0]*_[3]+_[2]*_[1]),ae-G-Q+J),E[1]=Math.asin(R(2*(_[1]*_[3]-_[0]*_[2]),-1,1)),E[2]=Math.atan2(2*(_[0]*_[1]+_[2]*_[3]),ae+G-Q-J);else if(S==="YZX")E[0]=Math.atan2(2*(_[0]*_[3]-_[2]*_[1]),ae-G+Q-J),E[1]=Math.atan2(2*(_[1]*_[3]-_[0]*_[2]),ae+G-Q-J),E[2]=Math.asin(R(2*(_[0]*_[1]+_[2]*_[3]),-1,1));else if(S==="XZY")E[0]=Math.atan2(2*(_[0]*_[3]+_[1]*_[2]),ae-G+Q-J),E[1]=Math.atan2(2*(_[0]*_[2]+_[1]*_[3]),ae+G-Q-J),E[2]=Math.asin(R(2*(_[2]*_[3]-_[0]*_[1]),-1,1));else{console.log("No order given for quaternion to euler conversion.");return}}class lC{constructor(){this.hand="right",this.headElbowOffset=k0,this.controllerQ=pe(),this.lastControllerQ=pe(),this.headQ=pe(),this.headPos=b(),this.elbowPos=b(),this.wristPos=b(),this.time=null,this.lastTime=null,this.rootQ=pe(),this.position=b()}setHandedness(_){this.hand!=_&&(this.hand=_,this.hand=="left"?this.headElbowOffset=JP:this.headElbowOffset=k0)}update(_,S){this.time=Wi(),_&&(X(this.lastControllerQ,this.controllerQ),X(this.controllerQ,_)),S&&(f(this.headPos,S),p(this.headQ,S));let R=this.getHeadYawOrientation_(),G=this.quatAngle_(this.lastControllerQ,this.controllerQ),Q=(this.time-this.lastTime)/1e3;G/Q>nC?he(this.rootQ,this.rootQ,R,Math.min(G/sC,1)):X(this.rootQ,R);let ae=w(0,0,-1);Z(ae,ae,this.controllerQ);let Se=z(ae,[0,1,0]),be=this.clamp_((Se-rC)/oC,0,1),Qe=U(this.rootQ);tt(Qe,Qe),Fe(Qe,Qe,this.controllerQ);let ht=this.elbowPos;C(ht,this.headPos),M(ht,ht,this.headElbowOffset);let jt=g(V0);D(jt,jt,be),M(ht,ht,jt);let fi=this.quatAngle_(Qe,pe())*G0,ti=1-Math.pow(fi/180,4),Xt=z0,Si=1-z0,ln=ti*(Xt+Si*be*iC),Ct=pe();he(Ct,Ct,Qe,ln);let Ft=tt(pe(),Ct),Gt=U(Qe);Fe(Gt,Gt,Ft);let St=this.wristPos;C(St,tC),Z(St,St,Ct),M(St,St,eC),Z(St,St,Gt),M(St,St,ht);let ks=g(V0);D(ks,ks,be),M(this.position,this.wristPos,ks),Z(this.position,this.position,this.rootQ),this.lastTime=this.time}getPosition(){return this.position}getHeadYawOrientation_(){let _=b();return aC(_,this.headQ,"YXZ"),N(pe(),0,_[1]*G0,0)}clamp_(_,S,R){return Math.min(Math.max(_,S),R)}quatAngle_(_,S){let R=[0,0,-1],G=[0,0,-1];return Z(R,R,_),Z(G,G,S),ne(R,G)}}const bn=Symbol("@@webxr-polyfill/XRRemappedGamepad"),H0={pressed:!1,touched:!1,value:0};Object.freeze(H0);class cC{constructor(_,S,R){if(R||(R={}),R.userAgentOverrides){for(let be in R.userAgentOverrides)if(navigator.userAgent.includes(be)){let Qe=R.userAgentOverrides[be];for(let ht in Qe)ht in R?Object.assign(R[ht],Qe[ht]):R[ht]=Qe[ht];break}}let G=new Array(R.axes&&R.axes.length?R.axes.length:_.axes.length),Q=new Array(R.buttons&&R.buttons.length?R.buttons.length:_.buttons.length),J=null;if(R.gripTransform){let be=R.gripTransform.orientation||[0,0,0,1];J=a(),u(J,ve(be,be),R.gripTransform.position||[0,0,0])}let ae=null;if(R.targetRayTransform){let be=R.targetRayTransform.orientation||[0,0,0,1];ae=a(),u(ae,ve(be,be),R.targetRayTransform.position||[0,0,0])}let Se=R.profiles;R.displayProfiles&&S.displayName in R.displayProfiles&&(Se=R.displayProfiles[S.displayName]),this[bn]={gamepad:_,map:R,profiles:Se||[_.id],mapping:R.mapping||_.mapping,axes:G,buttons:Q,gripTransform:J,targetRayTransform:ae},this._update()}_update(){let _=this[bn].gamepad,S=this[bn].map,R=this[bn].axes;for(let Q=0;Q<R.length;++Q)S.axes&&Q in S.axes?S.axes[Q]===null?R[Q]=0:R[Q]=_.axes[S.axes[Q]]:R[Q]=_.axes[Q];if(S.axes&&S.axes.invert)for(let Q of S.axes.invert)Q<R.length&&(R[Q]*=-1);let G=this[bn].buttons;for(let Q=0;Q<G.length;++Q)S.buttons&&Q in S.buttons?S.buttons[Q]===null?G[Q]=H0:G[Q]=_.buttons[S.buttons[Q]]:G[Q]=_.buttons[Q]}get id(){return""}get _profiles(){return this[bn].profiles}get index(){return-1}get connected(){return this[bn].gamepad.connected}get timestamp(){return this[bn].gamepad.timestamp}get mapping(){return this[bn].mapping}get axes(){return this[bn].axes}get buttons(){return this[bn].buttons}get hapticActuators(){return this[bn].gamepad.hapticActuators}}class hC{constructor(_,S,R=0,G=-1){this.polyfill=_,this.display=S,this.nativeGamepad=null,this.gamepad=null,this.inputSource=new L0(this),this.lastPosition=b(),this.emulatedPosition=!1,this.basePoseMatrix=a(),this.outputMatrix=a(),this.primaryButtonIndex=R,this.primaryActionPressed=!1,this.primarySqueezeButtonIndex=G,this.primarySqueezeActionPressed=!1,this.handedness="",this.targetRayMode="gaze",this.armModel=null}get profiles(){return this.gamepad?this.gamepad._profiles:[]}updateFromGamepad(_){this.nativeGamepad!==_&&(this.nativeGamepad=_,_?this.gamepad=new cC(_,this.display,ZP[_.id]):this.gamepad=null),this.handedness=_.hand===""?"none":_.hand,this.gamepad&&this.gamepad._update(),_.pose?(this.targetRayMode="tracked-pointer",this.emulatedPosition=!_.pose.hasPosition):_.hand===""&&(this.targetRayMode="gaze",this.emulatedPosition=!1)}updateBasePoseMatrix(){if(this.nativeGamepad&&this.nativeGamepad.pose){let _=this.nativeGamepad.pose,S=_.position,R=_.orientation;if(!S&&!R)return;S?(this.lastPosition[0]=S[0],this.lastPosition[1]=S[1],this.lastPosition[2]=S[2]):_.hasPosition?S=this.lastPosition:(this.armModel||(this.armModel=new lC),this.armModel.setHandedness(this.nativeGamepad.hand),this.armModel.update(R,this.polyfill.getBasePoseMatrix()),S=this.armModel.getPosition()),u(this.basePoseMatrix,R,S)}else l(this.basePoseMatrix,this.polyfill.getBasePoseMatrix());return this.basePoseMatrix}getXRPose(_,S){switch(this.updateBasePoseMatrix(),S){case"target-ray":_._transformBasePoseMatrix(this.outputMatrix,this.basePoseMatrix),this.gamepad&&this.gamepad[bn].targetRayTransform&&d(this.outputMatrix,this.outputMatrix,this.gamepad[bn].targetRayTransform);break;case"grip":if(!this.nativeGamepad||!this.nativeGamepad.pose)return null;_._transformBasePoseMatrix(this.outputMatrix,this.basePoseMatrix),this.gamepad&&this.gamepad[bn].gripTransform&&d(this.outputMatrix,this.outputMatrix,this.gamepad[bn].gripTransform);break;default:return null}return _._adjustForOriginOffset(this.outputMatrix),new XRPose(new XRRigidTransform(this.outputMatrix),this.emulatedPosition)}}const gc=!1,W0={highRefreshRate:!0},j0={oculus:1,openvr:1,"spatial controller (spatial interaction source)":1};let dC=0;class uC{constructor(_,S,R={}){if(this.mode=_,this.enabledFeatures=S,this.outputContext=null,this.immersive=_=="immersive-vr"||_=="immersive-ar",this.ended=null,this.baseLayer=null,this.id=++dC,this.modifiedCanvasLayer=!1,this.outputContext&&!gc){const G=R.renderContextType||"2d";this.renderContext=this.outputContext.canvas.getContext(G)}}}class X0 extends N0{constructor(_,S){const{canPresent:R}=S.capabilities;super(_),this.display=S,this.frame=new _.VRFrameData,this.sessions=new Map,this.immersiveSession=null,this.canPresent=R,this.baseModelMatrix=a(),this.gamepadInputSources={},this.tempVec3=new Float32Array(3),this.onVRDisplayPresentChange=this.onVRDisplayPresentChange.bind(this),_.window.addEventListener("vrdisplaypresentchange",this.onVRDisplayPresentChange),this.CAN_USE_GAMEPAD=_.navigator&&"getGamepads"in _.navigator,this.HAS_BITMAP_SUPPORT=kP(_)}get depthNear(){return this.display.depthNear}set depthNear(_){this.display.depthNear=_}get depthFar(){return this.display.depthFar}set depthFar(_){this.display.depthFar=_}onBaseLayerSet(_,S){const R=this.sessions.get(_),G=S.context.canvas;if(R.immersive){const Q=this.display.getEyeParameters("left"),J=this.display.getEyeParameters("right");G.width=Math.max(Q.renderWidth,J.renderWidth)*2,G.height=Math.max(Q.renderHeight,J.renderHeight),this.display.requestPresent([{source:G,attributes:W0}]).then(()=>{!gc&&!this.global.document.body.contains(G)&&(R.modifiedCanvasLayer=!0,this.global.document.body.appendChild(G),zP(G)),R.baseLayer=S})}else R.baseLayer=S}isSessionSupported(_){return!(_=="immersive-ar"||_=="immersive-vr"&&this.canPresent===!1)}isFeatureSupported(_){switch(_){case"viewer":return!0;case"local":return!0;case"local-floor":return!0;case"bounded":return!1;case"unbounded":return!1;default:return!1}}requestSession(_,S){return $t(this,null,function*(){if(!this.isSessionSupported(_))return Promise.reject();let R=_=="immersive-vr";if(R){const Q=this.global.document.createElement("canvas");if(!gc){const J=Q.getContext("webgl")}yield this.display.requestPresent([{source:Q,attributes:W0}])}const G=new uC(_,S,{renderContextType:this.HAS_BITMAP_SUPPORT?"bitmaprenderer":"2d"});return this.sessions.set(G.id,G),R&&(this.immersiveSession=G,this.dispatchEvent("@@webxr-polyfill/vr-present-start",G.id)),Promise.resolve(G.id)})}requestAnimationFrame(_){return this.display.requestAnimationFrame(_)}getPrimaryButtonIndex(_){let S=0,R=_.id.toLowerCase();for(let G in j0)if(R.includes(G)){S=j0[G];break}return Math.min(S,_.buttons.length-1)}onFrameStart(_,S){this.display.depthNear=S.depthNear,this.display.depthFar=S.depthFar,this.display.getFrameData(this.frame);const R=this.sessions.get(_);if(R.immersive&&this.CAN_USE_GAMEPAD){let G=this.gamepadInputSources;this.gamepadInputSources={};let Q=this.global.navigator.getGamepads();for(let J=0;J<Q.length;++J){let ae=Q[J];if(ae&&ae.displayId>0){let Se=G[J];if(Se||(Se=new hC(this,this.display,this.getPrimaryButtonIndex(ae))),Se.updateFromGamepad(ae),this.gamepadInputSources[J]=Se,Se.primaryButtonIndex!=-1){let be=ae.buttons[Se.primaryButtonIndex].pressed;be&&!Se.primaryActionPressed?this.dispatchEvent("@@webxr-polyfill/input-select-start",{sessionId:R.id,inputSource:Se.inputSource}):!be&&Se.primaryActionPressed&&this.dispatchEvent("@@webxr-polyfill/input-select-end",{sessionId:R.id,inputSource:Se.inputSource}),Se.primaryActionPressed=be}if(Se.primarySqueezeButtonIndex!=-1){let be=ae.buttons[Se.primarySqueezeButtonIndex].pressed;be&&!Se.primarySqueezeActionPressed?this.dispatchEvent("@@webxr-polyfill/input-squeeze-start",{sessionId:R.id,inputSource:Se.inputSource}):!be&&Se.primarySqueezeActionPressed&&this.dispatchEvent("@@webxr-polyfill/input-squeeze-end",{sessionId:R.id,inputSource:Se.inputSource}),Se.primarySqueezeActionPressed=be}}}}if(!gc&&!R.immersive&&R.baseLayer){const G=R.baseLayer.context.canvas;m(this.frame.leftProjectionMatrix,S.inlineVerticalFieldOfView,G.width/G.height,S.depthNear,S.depthFar)}}onFrameEnd(_){const S=this.sessions.get(_);if(!(S.ended||!S.baseLayer)){if(S.outputContext&&!(S.immersive&&!this.display.capabilities.hasExternalDisplay)){const R=S.immersive&&this.display.capabilities.hasExternalDisplay,G=S.baseLayer.context.canvas,Q=R?G.width/2:G.width,J=G.height;if(!gc){const ae=S.outputContext.canvas,Se=ae.width,be=ae.height,Qe=S.renderContext;this.HAS_BITMAP_SUPPORT?G.transferToImageBitmap?Qe.transferFromImageBitmap(G.transferToImageBitmap()):this.global.createImageBitmap(G,0,0,Q,J,{resizeWidth:Se,resizeHeight:be}).then(ht=>Qe.transferFromImageBitmap(ht)):Qe.drawImage(G,0,0,Q,J,0,0,Se,be)}}S.immersive&&S.baseLayer&&this.display.submitFrame()}}cancelAnimationFrame(_){this.display.cancelAnimationFrame(_)}endSession(_){return $t(this,null,function*(){const S=this.sessions.get(_);if(!S.ended){if(S.immersive)return this.display.exitPresent();S.ended=!0}})}doesSessionSupportReferenceSpace(_,S){const R=this.sessions.get(_);return R.ended?!1:R.enabledFeatures.has(S)}requestStageBounds(){if(this.display.stageParameters){const _=this.display.stageParameters.sizeX,S=this.display.stageParameters.sizeZ,R=[];return R.push(-_/2),R.push(-S/2),R.push(_/2),R.push(-S/2),R.push(_/2),R.push(S/2),R.push(-_/2),R.push(S/2),R}return null}requestFrameOfReferenceTransform(_,S){return $t(this,null,function*(){return(_==="local-floor"||_==="bounded-floor")&&this.display.stageParameters&&this.display.stageParameters.sittingToStandingTransform?this.display.stageParameters.sittingToStandingTransform:null})}getProjectionMatrix(_){if(_==="left")return this.frame.leftProjectionMatrix;if(_==="right")return this.frame.rightProjectionMatrix;if(_==="none")return this.frame.leftProjectionMatrix;throw new Error("eye must be of type 'left' or 'right'")}getViewport(_,S,R,G){const Q=this.sessions.get(_),{width:J,height:ae}=R.context.canvas;if(!Q.immersive)return G.x=G.y=0,G.width=J,G.height=ae,!0;if(S==="left"||S==="none")G.x=0;else if(S==="right")G.x=J/2;else return!1;return G.y=0,G.width=J/2,G.height=ae,!0}getBasePoseMatrix(){let{position:_,orientation:S}=this.frame.pose;return!_&&!S?this.baseModelMatrix:(_||(_=this.tempVec3,_[0]=_[1]=_[2]=0),u(this.baseModelMatrix,S,_),this.baseModelMatrix)}getBaseViewMatrix(_){if(_==="left"||_==="none")return this.frame.leftViewMatrix;if(_==="right")return this.frame.rightViewMatrix;throw new Error("eye must be of type 'left' or 'right'")}getInputSources(){let _=[];for(let S in this.gamepadInputSources)_.push(this.gamepadInputSources[S].inputSource);return _}getInputPose(_,S,R){if(!S)return null;for(let G in this.gamepadInputSources){let Q=this.gamepadInputSources[G];if(Q.inputSource===_)return Q.getXRPose(S,R)}return null}onWindowResize(){}onVRDisplayPresentChange(_){this.display.isPresenting||this.sessions.forEach(S=>{if(S.immersive&&!S.ended){if(S.modifiedCanvasLayer){const R=S.baseLayer.context.canvas;document.body.removeChild(R),R.setAttribute("style","")}this.immersiveSession===S&&(this.immersiveSession=null),this.dispatchEvent("@@webxr-polyfill/vr-present-end",S.id)}})}}class fC extends X0{constructor(_,S){const R=new jP(S||{});super(_,R),this.display=R,this.frame={rightViewMatrix:new Float32Array(16),leftViewMatrix:new Float32Array(16),rightProjectionMatrix:new Float32Array(16),leftProjectionMatrix:new Float32Array(16),pose:null,timestamp:null}}}const pC=!1;let mC=0;class _C{constructor(_,S){this.mode=_,this.enabledFeatures=S,this.ended=null,this.baseLayer=null,this.id=++mC}}class gC extends N0{constructor(_){super(_),this.sessions=new Map,this.projectionMatrix=a(),this.identityMatrix=a()}onBaseLayerSet(_,S){const R=this.sessions.get(_);R.baseLayer=S}isSessionSupported(_){return _=="inline"}isFeatureSupported(_){switch(_){case"viewer":return!0;default:return!1}}requestSession(_,S){return $t(this,null,function*(){if(!this.isSessionSupported(_))return Promise.reject();const R=new _C(_,S);return this.sessions.set(R.id,R),Promise.resolve(R.id)})}requestAnimationFrame(_){return window.requestAnimationFrame(_)}cancelAnimationFrame(_){window.cancelAnimationFrame(_)}onFrameStart(_,S){if(pC)return;const R=this.sessions.get(_);if(R.baseLayer){const G=R.baseLayer.context.canvas;m(this.projectionMatrix,S.inlineVerticalFieldOfView,G.width/G.height,S.depthNear,S.depthFar)}}onFrameEnd(_){}endSession(_){return $t(this,null,function*(){const S=this.sessions.get(_);S.ended=!0})}doesSessionSupportReferenceSpace(_,S){const R=this.sessions.get(_);return R.ended?!1:R.enabledFeatures.has(S)}requestStageBounds(){return null}requestFrameOfReferenceTransform(_,S){return $t(this,null,function*(){return null})}getProjectionMatrix(_){return this.projectionMatrix}getViewport(_,S,R,G){const Q=this.sessions.get(_),{width:J,height:ae}=R.context.canvas;return G.x=G.y=0,G.width=J,G.height=ae,!0}getBasePoseMatrix(){return this.identityMatrix}getBaseViewMatrix(_){return this.identityMatrix}getInputSources(){return[]}getInputPose(_,S,R){return null}onWindowResize(){}}const vC=function(E){return $t(this,null,function*(){let _=null;if("getVRDisplays"in E.navigator)try{const S=yield E.navigator.getVRDisplays();S&&S.length&&(_=new X0(E,S[0]))}catch(S){}return _})},bC=function(E,_){return $t(this,null,function*(){if(_.webvr){let R=yield vC(E);if(R)return R}let S=VP(E);return S&&_.cardboard||!S&&_.allowCardboardOnDesktop?(E.VRFrameData||(E.VRFrameData=function(){this.rightViewMatrix=new Float32Array(16),this.leftViewMatrix=new Float32Array(16),this.rightProjectionMatrix=new Float32Array(16),this.leftProjectionMatrix=new Float32Array(16),this.pose=null}),new fC(E,_.cardboardConfig)):new gC(E)})},yC={global:r,webvr:!0,cardboard:!0,cardboardConfig:null,allowCardboardOnDesktop:!1},xd=["navigator","HTMLCanvasElement","WebGLRenderingContext"];class xC{constructor(_={}){this.config=Object.freeze(Object.assign({},yC,_)),this.global=this.config.global,this.nativeWebXR="xr"in this.global.navigator,this.injected=!1,this.nativeWebXR?this._injectCompatibilityShims(this.global):this._injectPolyfill(this.global)}_injectPolyfill(_){if(!xd.every(S=>!!_[S]))throw new Error(`Global must have the following attributes : ${xd}`);for(const S of Object.keys(dp))_[S]!==void 0?console.warn(`${S} already defined on global.`):_[S]=dp[S];F0(_.WebGLRenderingContext)&&(B0(_.HTMLCanvasElement),_.OffscreenCanvas&&B0(_.OffscreenCanvas),_.WebGL2RenderingContext&&F0(_.WebGL2RenderingContext),window.isSecureContext||console.warn(`WebXR Polyfill Warning:
  This page is not running in a secure context (https:// or localhost)!
  This means that although the page may be able to use the WebXR Polyfill it will
  not be able to use native WebXR implementations, and as such will not be able to
  access dedicated VR or AR hardware, and will not be able to take advantage of
  any performance improvements a native WebXR implementation may offer. Please
  host this content on a secure origin for the best user experience.
  `)),this.injected=!0,this._patchNavigatorXR()}_patchNavigatorXR(){let _=bC(this.global,this.config);this.xr=new dp.XRSystem(_),Object.defineProperty(this.global.navigator,"xr",{value:this.xr,configurable:!0})}_injectCompatibilityShims(_){if(!xd.every(S=>!!_[S]))throw new Error(`Global must have the following attributes : ${xd}`);if(_.navigator.xr&&"supportsSession"in _.navigator.xr&&!("isSessionSupported"in _.navigator.xr)){let S=_.navigator.xr.supportsSession;_.navigator.xr.isSessionSupported=function(R){return S.call(this,R).then(()=>!0).catch(()=>!1)},_.navigator.xr.supportsSession=function(R){return console.warn("navigator.xr.supportsSession() is deprecated. Please call navigator.xr.isSessionSupported() instead and check the boolean value returned when the promise resolves."),S.call(this,R)}}}}return xC});/*!
 * Copyright (C) 2024-present Shapespark
 */function Ce(r,t){if(!r)throw new Error(t)}function nt(r,t){console.assert(!!r,t)}function Ui(r,t){}function zs(r,t){throw new Error(`Unreachable code reached: ${t}`)}function bo(r,t){return(r&t)===t}function Dc(r,t){return r[t]}function ha(r,t,e){r[t]=e}function yo(r){if(!r)return{};const t={};return r.includes("#")&&r.includes("?"),r.substring(1).split("&").forEach(function(e){const i=e.indexOf("=");i>=0?t[e.substring(0,i)]=e.substring(i+1):t[e]=void 0}),t}function lr(r){if(!r.includes("#"))return[r,""];const t=r.indexOf("#");return[r.substring(0,t),r.substring(t)]}function da(r,t){const e=document.createElement("a");e.href=r,e.download=t,document.body.appendChild(e),e.style.cssText="display: none",e.click(),e.remove(),window.URL.revokeObjectURL(r)}function Lc(r,t,e="application/octet-stream"){const i=new Blob([r],{type:e}),n=window.URL.createObjectURL(i);da(n,t)}class Td{constructor(t){o(this,"base");o(this,"hashParts",{});const[e,i]=lr(t);this.base=e,this.hashParts=yo(i)}removeHash(t){Object.prototype.hasOwnProperty.call(this.hashParts,t),delete this.hashParts[t]}addHash(t,e=void 0){this.hashParts[t]=e}hasHash(t){return Object.prototype.hasOwnProperty.call(this.hashParts,t)}getHashValue(t){return this.hashParts[t]}getFullUrl(){let t="";for(const[e,i]of Object.entries(this.hashParts))t+=(t.length?"&":"#")+e+(i!==void 0?`=${i}`:"");return this.base.concat(t)}}function Gs(r,t){return r===t?0:r<t?-1:1}class xo{constructor(t){o(this,"_flags",0);if(t)for(const e of t)this.setFlag(e,!0)}setFlag(t,e){e?this._flags|=1<<t:this._flags&=~(1<<t)}enableFlag(t){this.setFlag(t,!0)}isFlagEnabled(t){const e=1<<t;return(this._flags&e)===e}disableFlag(t){this.setFlag(t,!1)}compare(t){return Gs(this._flags,t._flags)}}class ua{constructor(t){o(this,"_mask",0);t&&(this._mask=t)}set(t){this._mask|=t}get(t){return(this._mask&t)===t}isAnyBitSet(t){return(this._mask&t)!==0}copyFrom(t){this._mask=t._mask}compare(t){return Gs(this._mask,t._mask)}}function Oc(r){return Math.round(Yi(r,-1,1)*127)}function Fc(r){return r<=127?1:r<=32767?2:4}function wd(r,t,e){return r+e*(t-r)}function bs(r,t){const e=Math.pow(10,t);return Math.round(r*e)/e}function Sd(r){return Math.log(r)/Math.log(2)}function rb(r,t){return Sd(t)-Sd(r)+1}function Yi(r,t,e){return r<t?t:r>e?e:r}function ki(r,t,e,i,n){return i+(r-t)*(n-i)/(e-t)}function Ai(r){const t=Math.PI/180;return r*t}function Wn(r){const t=180/Math.PI;return r*t}function Oi(r,t,e){return Math.abs(r-t)<e}const Bs=class Bs{constructor(t=0,e=0,i=0){o(this,"x");o(this,"y");o(this,"z");this.x=t,this.y=e,this.z=i}set(t,e,i){return this.x=t,this.y=e,this.z=i,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setZ(t){return this.z=t,this}setComponent(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;case 2:this.z=e;break;default:throw new Error("index is out of range: "+t)}}getComponent(t){switch(t){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+t)}}copyFrom(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}addScalar(t){return this.x+=t,this.y+=t,this.z+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this}sub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}subScalar(t){return this.x-=t,this.y-=t,this.z-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this}multiply(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this}multiplyScalar(t){return this.x*=t,this.y*=t,this.z*=t,this}multiplyVectors(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this}divide(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this}divideScalar(t){if(t!==0){const e=1/t;this.x*=e,this.y*=e,this.z*=e}else this.x=0,this.y=0,this.z=0;return this}min(t){return this.x>t.x&&(this.x=t.x),this.y>t.y&&(this.y=t.y),this.z>t.z&&(this.z=t.z),this}max(t){return this.x<t.x&&(this.x=t.x),this.y<t.y&&(this.y=t.y),this.z<t.z&&(this.z=t.z),this}minScalar(t){return this.x>t&&(this.x=t),this.y>t&&(this.y=t),this.z>t&&(this.z=t),this}maxScalar(t){return this.x<t&&(this.x=t),this.y<t&&(this.y=t),this.z<t&&(this.z=t),this}clamp(t,e){return this.x=this.x<t.x?t.x:this.x>e.x?e.x:this.x,this.y=this.y<t.y?t.y:this.y>e.y?e.y:this.y,this.z=this.z<t.z?t.z:this.z>e.z?e.z:this.z,this}clampScalar(t,e){return this.x=this.x<t?t:this.x>e?e:this.x,this.y=this.y<t?t:this.y>e?e:this.y,this.z=this.z<t?t:this.z>e?e:this.z,this}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}lengthManhattan(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}normalize(){return this.divideScalar(this.length())}setLength(t){const e=this.length();return e!==0&&t!==e&&this.multiplyScalar(t/e),this}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this}lerpVectors(t,e,i){return this.subVectors(e,t).multiplyScalar(i).add(t),this}cross(t){const e=this.x,i=this.y,n=this.z;return this.x=i*t.z-n*t.y,this.y=n*t.x-e*t.z,this.z=e*t.y-i*t.x,this}crossVectors(t,e){return this.x=t.y*e.z-t.z*e.y,this.y=t.z*e.x-t.x*e.z,this.z=t.x*e.y-t.y*e.x,this}projectOnVector(t){Bs._tempVec3.copyFrom(t).normalize();const e=this.dot(Bs._tempVec3);return this.copyFrom(Bs._tempVec3).multiplyScalar(e)}projectOnPlane(t){return Bs._tempVec3.copyFrom(this).projectOnVector(t),this.sub(Bs._tempVec3)}reflect(t){return this.sub(Bs._tempVec3.copyFrom(t).multiplyScalar(2*this.dot(t)))}angleTo(t){const e=this.dot(t)/(this.length()*t.length());return Math.acos(Yi(e,-1,1))}distanceTo(t){return Math.sqrt(this.distanceToSquared(t))}distanceToSquared(t){const e=this.x-t.x,i=this.y-t.y,n=this.z-t.z;return e*e+i*i+n*n}equals(t){return t.x===this.x&&t.y===this.y&&t.z===this.z}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this.z=t[e+2],this}fillArray(t,e=0){t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z}addToArray(t,e=0){t[e]+=this.x,t[e+1]+=this.y,t[e+2]+=this.z}toArray(){return[this.x,this.y,this.z]}clone(){return new Bs(this.x,this.y,this.z)}};o(Bs,"_tempVec3",new Bs);let L=Bs;const Zo=class Zo{constructor(t=new L,e=0){o(this,"center");o(this,"radius");this.center=t,this.radius=e}set(t,e){return this.center.copyFrom(t),this.radius=e,this}setFromBox(t){return t.center(this.center),this.radius=Zo._tempVec3.subVectors(this.center,t.min).length(),this}setFromPoints(t,e){const i=this.center,n=new li;e!==void 0?i.copyFrom(e):n.setFromPoints(t).center(i);let s=0;for(const a of t)s=Math.max(s,i.distanceToSquared(a));return this.radius=Math.sqrt(s),this}copyFrom(t){return this.center.copyFrom(t.center),this.radius=t.radius,this}empty(){return this.radius<=0}containsPoint(t){return t.distanceToSquared(this.center)<=this.radius*this.radius}distanceToPoint(t){return t.distanceTo(this.center)-this.radius}intersectsSphere(t){const e=this.radius+t.radius;return t.center.distanceToSquared(this.center)<=e*e}clampPoint(t,e){const i=this.center.distanceToSquared(t),n=e||new L;return n.copyFrom(t),i>this.radius*this.radius&&(n.sub(this.center).normalize(),n.multiplyScalar(this.radius).add(this.center)),n}getBoundingBox(){const t=new li;return t.set(this.center,this.center),t.expandByScalar(this.radius),t}applyMatrix4(t){return t.affineTransformPoint3(this.center),this.radius=this.radius*t.getMaxScaleOnAxis(),this}translate(t){return this.center.add(t),this}equals(t){return t.center.equals(this.center)&&t.radius===this.radius}clone(){return new Zo().copyFrom(this)}static union(t,e){if(e.empty()){e.copyFrom(t);return}const i=e.center.distanceTo(t.center);let n,s;t.radius>e.radius?(n=t,s=e):(n=e,s=t);const a=(n.radius+s.radius+i)/2;if(a<=n.radius){e.copyFrom(n);return}const l=(a-n.radius)/i;console.assert(l>0),Zo._tempVec3.copyFrom(s.center).sub(n.center).multiplyScalar(l),e.center.copyFrom(n.center).add(Zo._tempVec3),e.radius=a}};o(Zo,"_tempVec3",new L);let os=Zo;const co=class co{constructor(t,e){o(this,"min",new L(1/0,1/0,1/0));o(this,"max",new L(-1/0,-1/0,-1/0));t&&e?this.set(t,e):Ce(!t&&!e)}set(t,e){return this.min.copyFrom(t),this.max.copyFrom(e),this}setFromPoints(t){this.makeEmpty();for(const e of t)this.expandByPoint(e);return this}setFromArray(t,e=0,i=t.length/3){this.makeEmpty();const n=new L,s=e*3,a=(e+i)*3;s<=t.length&&a<=t.length;for(let l=s;l<a;l+=3)n.set(t[l],t[l+1],t[l+2]),this.expandByPoint(n);return this}copyFrom(t){return this.min.copyFrom(t.min),this.max.copyFrom(t.max),this}makeEmpty(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this}empty(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z}center(t){return(t!=null?t:new L).addVectors(this.min,this.max).multiplyScalar(.5)}size(t){return(t!=null?t:new L).subVectors(this.max,this.min)}volume(){return this.empty()?0:(this.max.x-this.min.x)*(this.max.y-this.min.y)*(this.max.z-this.min.z)}expandByPoint(t){return this.min.min(t),this.max.max(t),this}expandByVector(t){return this.min.sub(t),this.max.add(t),this}expandByScalar(t){return this.min.addScalar(-t),this.max.addScalar(t),this}containsPoint(t){return!(t.x<this.min.x||t.x>this.max.x||t.y<this.min.y||t.y>this.max.y||t.z<this.min.z||t.z>this.max.z)}containsBox(t){return this.min.x<=t.min.x&&t.max.x<=this.max.x&&this.min.y<=t.min.y&&t.max.y<=this.max.y&&this.min.z<=t.min.z&&t.max.z<=this.max.z}getParameter(t,e){return(e!=null?e:new L).set((t.x-this.min.x)/(this.max.x-this.min.x),(t.y-this.min.y)/(this.max.y-this.min.y),(t.z-this.min.z)/(this.max.z-this.min.z))}isIntersectionBox(t){return!(t.max.x<this.min.x||t.min.x>this.max.x||t.max.y<this.min.y||t.min.y>this.max.y||t.max.z<this.min.z||t.min.z>this.max.z)}clampPoint(t,e){return(e!=null?e:new L).copyFrom(t).clamp(this.min,this.max)}distanceToPoint(t){return co._tempVec3.copyFrom(t).clamp(this.min,this.max).sub(t).length()}getBoundingSphere(t){const e=t!=null?t:new os;return e.center=this.center(),e.radius=this.size(co._tempVec3).length()*.5,e}intersect(t){return this.min.max(t.min),this.max.min(t.max),this}union(t){return this.min.min(t.min),this.max.max(t.max),this}applyMatrix4(t){const e=(i,n,s)=>{co._tempVec3.set(i,n,s),this.expandByPoint(t.affineTransformPoint3(co._tempVec3))};return e(this.min.x,this.min.y,this.min.z),e(this.min.x,this.min.y,this.max.z),e(this.min.x,this.max.y,this.min.z),e(this.min.x,this.max.y,this.max.z),e(this.max.x,this.min.y,this.min.z),e(this.max.x,this.min.y,this.max.z),e(this.max.x,this.max.y,this.min.z),e(this.max.x,this.max.y,this.max.z),this}translate(t){return this.min.add(t),this.max.add(t),this}equals(t){return t.min.equals(this.min)&&t.max.equals(this.max)}clone(){return new co(this.min,this.max)}};o(co,"_tempVec3",new L);let li=co;class ye{constructor(t=0,e=0){o(this,"x");o(this,"y");this.x=t,this.y=e}set(t,e){return this.x=t,this.y=e,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setComponent(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;default:throw new Error("index is out of range: "+t)}}getComponent(t){switch(t){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+t)}}copyFrom(t){return this.x=t.x,this.y=t.y,this}add(t){return this.x+=t.x,this.y+=t.y,this}addScalar(t){return this.x+=t,this.y+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this}sub(t){return this.x-=t.x,this.y-=t.y,this}subScalar(t){return this.x-=t,this.y-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this}multiply(t){return this.x*=t.x,this.y*=t.y,this}multiplyScalar(t){return this.x*=t,this.y*=t,this}divide(t){return this.x/=t.x,this.y/=t.y,this}divideScalar(t){if(t!==0){const e=1/t;this.x*=e,this.y*=e}else this.x=0,this.y=0;return this}min(t){return this.x>t.x&&(this.x=t.x),this.y>t.y&&(this.y=t.y),this}max(t){return this.x<t.x&&(this.x=t.x),this.y<t.y&&(this.y=t.y),this}clamp(t,e){return this.x=this.x<t.x?t.x:this.x>e.x?e.x:this.x,this.y=this.y<t.y?t.y:this.y>e.y?e.y:this.y,this}clampScalar(t,e){return this.x=this.x<t?t:this.x>e?e:this.x,this.y=this.y<t?t:this.y>e?e:this.y,this}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this}negate(){return this.x=-this.x,this.y=-this.y,this}dot(t){return this.x*t.x+this.y*t.y}lengthSq(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}normalize(){return this.divideScalar(this.length())}distanceTo(t){return Math.sqrt(this.distanceToSquared(t))}distanceToSquared(t){const e=this.x-t.x,i=this.y-t.y;return e*e+i*i}setLength(t){const e=this.length();return e!==0&&t!==e&&this.multiplyScalar(t/e),this}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this}lerpVectors(t,e,i){return this.subVectors(e,t).multiplyScalar(i).add(t),this}static crossVectors(t,e){return t.x*e.y-t.y*e.x}equals(t){return t.x===this.x&&t.y===this.y}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this}fillArray(t,e=0){return t[e]=this.x,t[e+1]=this.y,t}toArray(){return[this.x,this.y]}clone(){return new ye(this.x,this.y)}}const ac=class ac{constructor(t=new ye(1/0,1/0),e=new ye(-1/0,-1/0)){o(this,"min");o(this,"max");this.min=t,this.max=e}set(t,e){return this.min.copyFrom(t),this.max.copyFrom(e),this}setFromPoints(t){this.makeEmpty();for(const e of t)this.expandByPoint(e);return this}copyFrom(t){return this.min.copyFrom(t.min),this.max.copyFrom(t.max),this}makeEmpty(){return this.min.x=this.min.y=1/0,this.max.x=this.max.y=-1/0,this}empty(){return this.max.x<this.min.x||this.max.y<this.min.y}center(t=new ye){return t.addVectors(this.min,this.max).multiplyScalar(.5)}size(t=new ye){return t.subVectors(this.max,this.min)}expandByPoint(t){return this.min.min(t),this.max.max(t),this}expandByVector(t){return this.min.sub(t),this.max.add(t),this}expandByScalar(t){return this.min.addScalar(-t),this.max.addScalar(t),this}containsPoint(t){return!(t.x<this.min.x||t.x>this.max.x||t.y<this.min.y||t.y>this.max.y)}containsBox(t){return this.min.x<=t.min.x&&t.max.x<=this.max.x&&this.min.y<=t.min.y&&t.max.y<=this.max.y}getParameter(t,e=new ye){return e.set((t.x-this.min.x)/(this.max.x-this.min.x),(t.y-this.min.y)/(this.max.y-this.min.y))}isIntersectionBox(t){return!(t.max.x<this.min.x||t.min.x>this.max.x||t.max.y<this.min.y||t.min.y>this.max.y)}clampPoint(t,e=new ye){return e.copyFrom(t).clamp(this.min,this.max)}distanceToPoint(t){return ac._tempVec2.copyFrom(t).clamp(this.min,this.max).sub(t).length()}intersect(t){return this.min.max(t.min),this.max.min(t.max),this}union(t){return this.min.min(t.min),this.max.max(t.max),this}translate(t){return this.min.add(t),this.max.add(t),this}equals(t){return t.min.equals(this.min)&&t.max.equals(this.max)}clone(){return new ac().copyFrom(this)}};o(ac,"_tempVec2",new ye);let Qa=ac;function ob(r){return r<=.0031308?r*12.92:Math.pow(r,1/2.4)*1.055-.055}function Bc(r){return r<=.04045?r/12.92:Math.pow((r+.055)/1.055,2.4)}class ab{constructor(){o(this,"h",0);o(this,"s",0);o(this,"l",0)}}const pn=class pn{constructor(t,e,i){o(this,"r",0);o(this,"g",0);o(this,"b",0);return typeof t=="number"&&e!==void 0&&i!==void 0?this.setRGB(t,e,i):t!==void 0?this.set(t):this}set(t){return t instanceof pn?this.copyFrom(t):typeof t=="number"?this.setHex(t):typeof t=="string"&&this.setStyle(t),this}setHex(t){return t=Math.floor(t),this.r=(t>>16&255)/255,this.g=(t>>8&255)/255,this.b=(t&255)/255,this}setRGB(t,e,i){return this.r=t,this.g=e,this.b=i,this}setHSL(t){const e=t.h,i=t.s,n=t.l;if(i===0)this.r=this.g=this.b=n;else{const s=function(c,h,d){return d<0&&(d+=1),d>1&&(d-=1),d<.16666666666666666?c+(h-c)*6*d:d<.5?h:d<.6666666666666666?c+(h-c)*6*(.6666666666666666-d):c},a=n<=.5?n*(1+i):n+i-n*i,l=2*n-a;this.r=s(l,a,e+1/3),this.g=s(l,a,e),this.b=s(l,a,e-1/3)}return this}setStyle(t){if(/^rgb\((\d+), ?(\d+), ?(\d+)\)$/i.test(t)){const e=/^rgb\((\d+), ?(\d+), ?(\d+)\)$/i.exec(t);this.r=Math.min(255,parseInt(e[1],10))/255,this.g=Math.min(255,parseInt(e[2],10))/255,this.b=Math.min(255,parseInt(e[3],10))/255}else if(/^rgb\((\d+)%, ?(\d+)%, ?(\d+)%\)$/i.test(t)){const e=/^rgb\((\d+)%, ?(\d+)%, ?(\d+)%\)$/i.exec(t);this.r=Math.min(100,parseInt(e[1],10))/100,this.g=Math.min(100,parseInt(e[2],10))/100,this.b=Math.min(100,parseInt(e[3],10))/100}else if(/^#([0-9a-f]{6})$/i.test(t)){const e=/^#([0-9a-f]{6})$/i.exec(t);this.setHex(parseInt(e[1],16))}else if(/^#([0-9a-f])([0-9a-f])([0-9a-f])$/i.test(t)){const e=/^#([0-9a-f])([0-9a-f])([0-9a-f])$/i.exec(t);this.setHex(parseInt(e[1]+e[1]+e[2]+e[2]+e[3]+e[3],16))}else/^(\w+)$/i.test(t)&&this.setHex(Hs[t]);return this}copyFrom(t){return this.r=t.r,this.g=t.g,this.b=t.b,this}convertGammaToLinear(){return this.r=Bc(this.r),this.g=Bc(this.g),this.b=Bc(this.b),this}roundChannels(){return this.r=bs(this.r,3),this.g=bs(this.g,3),this.b=bs(this.b,3),this}getHex(){return this.r*255<<16^this.g*255<<8^this.b*255<<0}getHexString(){return("000000"+this.getHex().toString(16)).slice(-6)}getHSL(){const t=new ab,e=this.r,i=this.g,n=this.b,s=Math.max(e,i,n),a=Math.min(e,i,n);let l,c;const h=(a+s)/2;if(a===s)l=0,c=0;else{const d=s-a;c=h<=.5?d/(s+a):d/(2-s-a),l=s==e?(i-n)/d+(i<n?6:0):s==i?(n-e)/d+2:(e-i)/d+4,l/=6}return t.h=l,t.s=c,t.l=h,t}getStyle(){return"rgb("+(this.r*255|0)+","+(this.g*255|0)+","+(this.b*255|0)+")"}offsetHSL(t,e,i){const n=this.getHSL();return n.h+=t,n.s+=e,n.l+=i,this.setHSL(n),this}add(t){return this.r+=t.r,this.g+=t.g,this.b+=t.b,this}addColors(t,e){return this.r=t.r+e.r,this.g=t.g+e.g,this.b=t.b+e.b,this}addScalar(t){return this.r+=t,this.g+=t,this.b+=t,this}multiply(t){return this.r*=t.r,this.g*=t.g,this.b*=t.b,this}multiplyScalar(t){return this.r*=t,this.g*=t,this.b*=t,this}lerp(t,e){return this.r+=(t.r-this.r)*e,this.g+=(t.g-this.g)*e,this.b+=(t.b-this.b)*e,this}lerpColors(t,e,i){return this.r=wd(t.r,e.r,i),this.g=wd(t.g,e.g,i),this.b=wd(t.b,e.b,i),this}equals(t){return t.r===this.r&&t.g===this.g&&t.b===this.b}fromArray(t){return this.r=t[0],this.g=t[1],this.b=t[2],this}toArray(){return[this.r,this.g,this.b]}clone(){return new pn().setRGB(this.r,this.g,this.b)}};o(pn,"BLACK",new pn(0)),o(pn,"WHITE",new pn(16777215)),o(pn,"RED",new pn(16711680)),o(pn,"GREEN",new pn(65280)),o(pn,"BLUE",new pn(255)),o(pn,"ORANGE",new pn(16753920));let _e=pn;const Hs={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074},ad=class ad{static linearToGamma(t){return ob(t)}static gammaToLinear(t){return Bc(t)}static rgbmEncode(t,e){const i=2.82842712,n=Math.sqrt(t.r)/i,s=Math.sqrt(t.g)/i,a=Math.sqrt(t.b)/i;let l=Math.max(Math.max(n,s),a);l=Yi(l,1/255,1),l=Math.ceil(l*255)/255,e.set(n/l,s/l,a/l,1-l)}static ycocgmEncode(t,e,i){const a=(b,g)=>{const x=Math.max(Math.abs(b),Math.abs(g));return x<.03125?16:x<.0625?8:x<.125?4:x<.25?2:1};let l=.25*t.r+.5*t.g+.25*t.b,c=.5*t.r-.5*t.b,h=-.25*t.r+.5*t.g-.25*t.b;l*=1/8,c*=1/8,h*=1/8;const d=a(c,h);l=Math.sqrt(l),c=c*d+.5,h=h*d+.5;let u,f;if(l<i)u=l*(1/i),f=16-1;else{u=(l-i)*(1/(1-i));const b=u*(16-3);f=b|0,u=b-f,f++}const m=(16-16/d|0)+f*16;e.set(u,c,h,m*(1/255))}static combineColorWithOpacity(t,e){if(e>=1)return t;const i=ad._tempColor;i.setStyle(t);const n=s=>s*255|0;return"rgba("+n(i.r)+","+n(i.g)+","+n(i.b)+","+e+")"}};o(ad,"_tempColor",new _e);let cr=ad;const mn=class mn{constructor(){o(this,"elements",new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]))}set(t,e,i,n,s,a,l,c,h,d,u,f,p,m,b,g){const x=this.elements;return x[0]=t,x[4]=e,x[8]=i,x[12]=n,x[1]=s,x[5]=a,x[9]=l,x[13]=c,x[2]=h,x[6]=d,x[10]=u,x[14]=f,x[3]=p,x[7]=m,x[11]=b,x[15]=g,this}setZero(){return this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}copyFrom(t){return this.elements.set(t.elements),this}copyPosition(t){const e=this.elements,i=t.elements;return e[12]=i[12],e[13]=i[13],e[14]=i[14],this}extractBasis(t,e,i){const n=this.elements;return t.set(n[0],n[1],n[2]),e.set(n[4],n[5],n[6]),i.set(n[8],n[9],n[10]),this}makeBasis(t,e,i){return this.set(t.x,e.x,i.x,0,t.y,e.y,i.y,0,t.z,e.z,i.z,0,0,0,0,1),this}extractRotation(t){const e=mn._tempVec3A,i=this.elements,n=t.elements,s=1/e.set(n[0],n[1],n[2]).length(),a=1/e.set(n[4],n[5],n[6]).length(),l=1/e.set(n[8],n[9],n[10]).length();return i[0]=n[0]*s,i[1]=n[1]*s,i[2]=n[2]*s,i[4]=n[4]*a,i[5]=n[5]*a,i[6]=n[6]*a,i[8]=n[8]*l,i[9]=n[9]*l,i[10]=n[10]*l,this}makeRotationFromQuaternion(t){const e=this.elements,i=t.x,n=t.y,s=t.z,a=t.w,l=i+i,c=n+n,h=s+s,d=i*l,u=i*c,f=i*h,p=n*c,m=n*h,b=s*h,g=a*l,x=a*c,w=a*h;return e[0]=1-(p+b),e[4]=u-w,e[8]=f+x,e[1]=u+w,e[5]=1-(d+b),e[9]=m-g,e[2]=f-x,e[6]=m+g,e[10]=1-(d+p),e[3]=0,e[7]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}lookAt(t,e,i){const n=mn._tempVec3A,s=mn._tempVec3B,a=mn._tempVec3C,l=this.elements;return a.subVectors(t,e).normalize(),a.length()===0&&(a.z=1),n.crossVectors(i,a).normalize(),n.length()===0&&(a.x+=1e-4,n.crossVectors(i,a).normalize()),s.crossVectors(a,n),l[0]=n.x,l[4]=s.x,l[8]=a.x,l[1]=n.y,l[5]=s.y,l[9]=a.y,l[2]=n.z,l[6]=s.z,l[10]=a.z,this}multiply(t){return this.multiplyMatrices(this,t)}multiplyMatrices(t,e){const i=t.elements,n=e.elements,s=this.elements,a=i[0],l=i[4],c=i[8],h=i[12],d=i[1],u=i[5],f=i[9],p=i[13],m=i[2],b=i[6],g=i[10],x=i[14],w=i[3],C=i[7],M=i[11],D=i[15],W=n[0],z=n[4],$=n[8],Z=n[12],ne=n[1],Me=n[5],Xe=n[9],xe=n[13],Le=n[2],B=n[6],Y=n[10],re=n[14],le=n[3],ge=n[7],pe=n[11],Ae=n[15];return s[0]=a*W+l*ne+c*Le+h*le,s[4]=a*z+l*Me+c*B+h*ge,s[8]=a*$+l*Xe+c*Y+h*pe,s[12]=a*Z+l*xe+c*re+h*Ae,s[1]=d*W+u*ne+f*Le+p*le,s[5]=d*z+u*Me+f*B+p*ge,s[9]=d*$+u*Xe+f*Y+p*pe,s[13]=d*Z+u*xe+f*re+p*Ae,s[2]=m*W+b*ne+g*Le+x*le,s[6]=m*z+b*Me+g*B+x*ge,s[10]=m*$+b*Xe+g*Y+x*pe,s[14]=m*Z+b*xe+g*re+x*Ae,s[3]=w*W+C*ne+M*Le+D*le,s[7]=w*z+C*Me+M*B+D*ge,s[11]=w*$+C*Xe+M*Y+D*pe,s[15]=w*Z+C*xe+M*re+D*Ae,this}multiplyScalar(t){const e=this.elements;return e[0]*=t,e[4]*=t,e[8]*=t,e[12]*=t,e[1]*=t,e[5]*=t,e[9]*=t,e[13]*=t,e[2]*=t,e[6]*=t,e[10]*=t,e[14]*=t,e[3]*=t,e[7]*=t,e[11]*=t,e[15]*=t,this}getTranslation(t=new L){return t.x=this.elements[12],t.y=this.elements[13],t.z=this.elements[14],t}affineTransformPoint3(t){this.isApproxAffine();const e=t.x,i=t.y,n=t.z,s=this.elements;return t.x=s[0]*e+s[4]*i+s[8]*n+s[12],t.y=s[1]*e+s[5]*i+s[9]*n+s[13],t.z=s[2]*e+s[6]*i+s[10]*n+s[14],t}transformPoint3(t){const e=t.x,i=t.y,n=t.z,s=this.elements,a=1/(s[3]*e+s[7]*i+s[11]*n+s[15]);return t.x=(s[0]*e+s[4]*i+s[8]*n+s[12])*a,t.y=(s[1]*e+s[5]*i+s[9]*n+s[13])*a,t.z=(s[2]*e+s[6]*i+s[10]*n+s[14])*a,t}transformVector3(t){this.isApproxAffine();const e=t.x,i=t.y,n=t.z,s=this.elements;return t.x=s[0]*e+s[4]*i+s[8]*n,t.y=s[1]*e+s[5]*i+s[9]*n,t.z=s[2]*e+s[6]*i+s[10]*n,t.normalize(),t}affineTransformPoint3Array(t,e=0,i=t.length){const n=mn._tempVec3A;for(let s=0,a=e;s<i;s+=3,a+=3)n.x=t[a],n.y=t[a+1],n.z=t[a+2],this.affineTransformPoint3(n),t[a]=n.x,t[a+1]=n.y,t[a+2]=n.z}determinant(){const t=this.elements,e=t[0],i=t[4],n=t[8],s=t[12],a=t[1],l=t[5],c=t[9],h=t[13],d=t[2],u=t[6],f=t[10],p=t[14],m=t[3],b=t[7],g=t[11],x=t[15];return m*(+s*c*u-n*h*u-s*l*f+i*h*f+n*l*p-i*c*p)+b*(+e*c*p-e*h*f+s*a*f-n*a*p+n*h*d-s*c*d)+g*(+e*h*u-e*l*p-s*a*u+i*a*p+s*l*d-i*h*d)+x*(-n*l*d-e*c*u+e*l*f+n*a*u-i*a*f+i*c*d)}transpose(){const t=this.elements;let e;return e=t[1],t[1]=t[4],t[4]=e,e=t[2],t[2]=t[8],t[8]=e,e=t[6],t[6]=t[9],t[9]=e,e=t[3],t[3]=t[12],t[12]=e,e=t[7],t[7]=t[13],t[13]=e,e=t[11],t[11]=t[14],t[14]=e,this}setPosition(t){const e=this.elements;return e[12]=t.x,e[13]=t.y,e[14]=t.z,this}invert(){const t=mn._tempMatrix4;return t.getInverse(this),this.copyFrom(t),this}getInverse(t,e=!1){const i=this.elements,n=t.elements,s=n[0],a=n[4],l=n[8],c=n[12],h=n[1],d=n[5],u=n[9],f=n[13],p=n[2],m=n[6],b=n[10],g=n[14],x=n[3],w=n[7],C=n[11],M=n[15];i[0]=u*g*w-f*b*w+f*m*C-d*g*C-u*m*M+d*b*M,i[4]=c*b*w-l*g*w-c*m*C+a*g*C+l*m*M-a*b*M,i[8]=l*f*w-c*u*w+c*d*C-a*f*C-l*d*M+a*u*M,i[12]=c*u*m-l*f*m-c*d*b+a*f*b+l*d*g-a*u*g,i[1]=f*b*x-u*g*x-f*p*C+h*g*C+u*p*M-h*b*M,i[5]=l*g*x-c*b*x+c*p*C-s*g*C-l*p*M+s*b*M,i[9]=c*u*x-l*f*x-c*h*C+s*f*C+l*h*M-s*u*M,i[13]=l*f*p-c*u*p+c*h*b-s*f*b-l*h*g+s*u*g,i[2]=d*g*x-f*m*x+f*p*w-h*g*w-d*p*M+h*m*M,i[6]=c*m*x-a*g*x-c*p*w+s*g*w+a*p*M-s*m*M,i[10]=a*f*x-c*d*x+c*h*w-s*f*w-a*h*M+s*d*M,i[14]=c*d*p-a*f*p-c*h*m+s*f*m+a*h*g-s*d*g,i[3]=u*m*x-d*b*x-u*p*w+h*b*w+d*p*C-h*m*C,i[7]=a*b*x-l*m*x+l*p*w-s*b*w-a*p*C+s*m*C,i[11]=l*d*x-a*u*x-l*h*w+s*u*w+a*h*C-s*d*C,i[15]=a*u*p-l*d*p+l*h*m-s*u*m-a*h*b+s*d*b;const D=s*i[0]+h*i[4]+p*i[8]+x*i[12];if(D==0){const W="Matrix4.getInverse(): can't invert matrix, determinant is 0";if(e)throw new Error(W);return console.warn(W),this.identity(),this}return this.multiplyScalar(1/D),this}scale(t){const e=this.elements,i=t.x,n=t.y,s=t.z;return e[0]*=i,e[4]*=n,e[8]*=s,e[1]*=i,e[5]*=n,e[9]*=s,e[2]*=i,e[6]*=n,e[10]*=s,e[3]*=i,e[7]*=n,e[11]*=s,this}getMaxScaleOnAxis(){const t=this.elements,e=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],i=t[4]*t[4]+t[5]*t[5]+t[6]*t[6],n=t[8]*t[8]+t[9]*t[9]+t[10]*t[10];return Math.sqrt(Math.max(e,Math.max(i,n)))}makeTranslation(t,e,i){return this.set(1,0,0,t,0,1,0,e,0,0,1,i,0,0,0,1),this}makeRotationX(t){const e=Math.cos(t),i=Math.sin(t);return this.set(1,0,0,0,0,e,-i,0,0,i,e,0,0,0,0,1),this}makeRotationY(t){const e=Math.cos(t),i=Math.sin(t);return this.set(e,0,i,0,0,1,0,0,-i,0,e,0,0,0,0,1),this}makeRotationZ(t){const e=Math.cos(t),i=Math.sin(t);return this.set(e,-i,0,0,i,e,0,0,0,0,1,0,0,0,0,1),this}makeRotationAxis(t,e){const i=Math.cos(e),n=Math.sin(e),s=1-i,a=t.x,l=t.y,c=t.z,h=s*a,d=s*l;return this.set(h*a+i,h*l-n*c,h*c+n*l,0,h*l+n*c,d*l+i,d*c-n*a,0,h*c-n*l,d*c+n*a,s*c*c+i,0,0,0,0,1),this}makeScale(t,e,i){return this.set(t,0,0,0,0,e,0,0,0,0,i,0,0,0,0,1),this}compose(t,e,i){return this.makeRotationFromQuaternion(e),this.scale(i),this.setPosition(t),this}decompose(t,e,i){const n=mn._tempVec3A,s=mn._tempMatrix4,a=this.elements;let l=n.set(a[0],a[1],a[2]).length();const c=n.set(a[4],a[5],a[6]).length(),h=n.set(a[8],a[9],a[10]).length();this.determinant()<0&&(l=-l),t.x=a[12],t.y=a[13],t.z=a[14],s.elements.set(this.elements);const u=1/l,f=1/c,p=1/h;return s.elements[0]*=u,s.elements[1]*=u,s.elements[2]*=u,s.elements[4]*=f,s.elements[5]*=f,s.elements[6]*=f,s.elements[8]*=p,s.elements[9]*=p,s.elements[10]*=p,e.setFromRotationMatrix(s),i.x=l,i.y=c,i.z=h,this}makeFrustum(t,e,i,n,s,a){const l=this.elements,c=2*s/(e-t),h=2*s/(n-i),d=(e+t)/(e-t),u=(n+i)/(n-i),f=-(a+s)/(a-s),p=-2*a*s/(a-s);return l[0]=c,l[4]=0,l[8]=d,l[12]=0,l[1]=0,l[5]=h,l[9]=u,l[13]=0,l[2]=0,l[6]=0,l[10]=f,l[14]=p,l[3]=0,l[7]=0,l[11]=-1,l[15]=0,this}makePerspective(t,e,i,n){const s=i*Math.tan(Ai(t*.5)),a=-s,l=a*e,c=s*e;return this.makeFrustum(l,c,a,s,i,n)}makeOrthographic(t,e,i,n,s,a){const l=this.elements,c=e-t,h=i-n,d=a-s,u=(e+t)/c,f=(i+n)/h,p=(a+s)/d;return l[0]=2/c,l[4]=0,l[8]=0,l[12]=-u,l[1]=0,l[5]=2/h,l[9]=0,l[13]=-f,l[2]=0,l[6]=0,l[10]=-2/d,l[14]=-p,l[3]=0,l[7]=0,l[11]=0,l[15]=1,this}fromArray(t){return this.elements.set(t),this}toArray(){return Array.from(this.elements)}clone(){return new mn().fromArray(this.elements)}isApproxAffine(t=1e-4){const e=this.elements;return Oi(e[3],0,t)&&Oi(e[7],0,t)&&Oi(e[11],0,t)&&Oi(e[15],1,t)}hasNaNs(){for(let t=0;t<this.elements.length;t++)if(isNaN(this.elements[t]))return!0;return!1}};o(mn,"_tempVec3A",new L),o(mn,"_tempVec3B",new L),o(mn,"_tempVec3C",new L),o(mn,"_tempMatrix4",new mn);let Ue=mn;const lc=class lc{constructor(t=0,e=0,i=0,n=1){o(this,"x");o(this,"y");o(this,"z");o(this,"w");this.x=t,this.y=e,this.z=i,this.w=n}set(t,e,i,n){return this.x=t,this.y=e,this.z=i,this.w=n,this}copyFrom(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this}setFromAxisAngle(t,e){const i=e/2,n=Math.sin(i);return this.x=t.x*n,this.y=t.y*n,this.z=t.z*n,this.w=Math.cos(i),this}setFromRotationMatrix(t){const e=t.elements,i=e[0],n=e[4],s=e[8],a=e[1],l=e[5],c=e[9],h=e[2],d=e[6],u=e[10],f=i+l+u;let p;return f>0?(p=.5/Math.sqrt(f+1),this.w=.25/p,this.x=(d-c)*p,this.y=(s-h)*p,this.z=(a-n)*p):i>l&&i>u?(p=2*Math.sqrt(1+i-l-u),this.w=(d-c)/p,this.x=.25*p,this.y=(n+a)/p,this.z=(s+h)/p):l>u?(p=2*Math.sqrt(1+l-i-u),this.w=(s-h)/p,this.x=(n+a)/p,this.y=.25*p,this.z=(c+d)/p):(p=2*Math.sqrt(1+u-i-l),this.w=(a-n)/p,this.x=(s+h)/p,this.y=(c+d)/p,this.z=.25*p),this}setFromUnitVectors(t,e){const n=lc._tempVec3;let s=t.dot(e)+1;return s<1e-6?(s=0,Math.abs(t.x)>Math.abs(t.z)?n.set(-t.y,t.x,0):n.set(0,-t.z,t.y)):n.crossVectors(t,e),this.x=n.x,this.y=n.y,this.z=n.z,this.w=s,this.normalize(),this}inverse(){return this.conjugate().normalize(),this}conjugate(){return this.x*=-1,this.y*=-1,this.z*=-1,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}normalize(){let t=this.length();return t===0?(this.x=0,this.y=0,this.z=0,this.w=1):(t=1/t,this.x=this.x*t,this.y=this.y*t,this.z=this.z*t,this.w=this.w*t),this}multiply(t){return this.multiplyQuaternions(this,t)}multiplyQuaternions(t,e){const i=t.x,n=t.y,s=t.z,a=t.w,l=e.x,c=e.y,h=e.z,d=e.w;return this.x=i*d+a*l+n*h-s*c,this.y=n*d+a*c+s*l-i*h,this.z=s*d+a*h+i*c-n*l,this.w=a*d-i*l-n*c-s*h,this}slerp(t,e){if(e===0)return this;if(e===1)return this.copyFrom(t);const i=this.x,n=this.y,s=this.z,a=this.w;let l=a*t.w+i*t.x+n*t.y+s*t.z;if(l<0?(this.w=-t.w,this.x=-t.x,this.y=-t.y,this.z=-t.z,l=-l):this.copyFrom(t),l>=1)return this.w=a,this.x=i,this.y=n,this.z=s,this;const c=Math.acos(l),h=Math.sqrt(1-l*l);if(Math.abs(h)<.001)return this.w=.5*(a+this.w),this.x=.5*(i+this.x),this.y=.5*(n+this.y),this.z=.5*(s+this.z),this;const d=Math.sin((1-e)*c)/h,u=Math.sin(e*c)/h;return this.w=a*d+this.w*u,this.x=i*d+this.x*u,this.y=n*d+this.y*u,this.z=s*d+this.z*u,this}static slerp(t,e,i,n){return i.copyFrom(t).slerp(e,n)}equals(t){return t.x===this.x&&t.y===this.y&&t.z===this.z&&t.w===this.w}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this.z=t[e+2],this.w=t[e+3],this}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t[e+3]=this.w,t}applyToVector3(t){const e=t.x,i=t.y,n=t.z,s=this.x,a=this.y,l=this.z,c=this.w,h=c*e+a*n-l*i,d=c*i+l*e-s*n,u=c*n+s*i-a*e,f=-s*e-a*i-l*n;return t.x=h*c+f*-s+d*-l-u*-a,t.y=d*c+f*-a+u*-s-h*-l,t.z=u*c+f*-l+h*-a-d*-s,t}clone(){return new lc(this.x,this.y,this.z,this.w)}};o(lc,"_tempVec3");let bi=lc;var ys=(r=>(r[r.XYZ=0]="XYZ",r[r.YZX=1]="YZX",r[r.ZXY=2]="ZXY",r[r.XZY=3]="XZY",r[r.YXZ=4]="YXZ",r[r.ZYX=5]="ZYX",r))(ys||{});const Ir=class Ir{constructor(t=0,e=0,i=0,n=2){o(this,"x");o(this,"y");o(this,"z");o(this,"order");this.x=e,this.y=i,this.z=t,this.order=n}set(t,e,i,n){return this.x=t,this.y=e,this.z=i,n!==void 0&&(this.order=n),this}copyFrom(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.order=t.order,this}setFromRotationMatrix(t,e){const i=t.elements,n=i[0],s=i[4],a=i[8],l=i[1],c=i[5],h=i[9],d=i[2],u=i[6],f=i[10];return e=e||this.order,e===0?(this.y=Math.asin(Yi(a,-1,1)),Math.abs(a)<.99999?(this.x=Math.atan2(-h,f),this.z=Math.atan2(-s,n)):(this.x=Math.atan2(u,c),this.z=0)):e===4?(this.x=Math.asin(-Yi(h,-1,1)),Math.abs(h)<.99999?(this.y=Math.atan2(a,f),this.z=Math.atan2(l,c)):(this.y=Math.atan2(-d,n),this.z=0)):e===2?(this.x=Math.asin(Yi(u,-1,1)),Math.abs(u)<.99999?(this.y=Math.atan2(-d,f),this.z=Math.atan2(-s,c)):(this.y=0,this.z=Math.atan2(l,n))):e===5?(this.y=Math.asin(-Yi(d,-1,1)),Math.abs(d)<.99999?(this.x=Math.atan2(u,f),this.z=Math.atan2(l,n)):(this.x=0,this.z=Math.atan2(-s,c))):e===1?(this.z=Math.asin(Yi(l,-1,1)),Math.abs(l)<.99999?(this.x=Math.atan2(-h,c),this.y=Math.atan2(-d,n)):(this.x=0,this.y=Math.atan2(a,f))):e===3&&(this.z=Math.asin(-Yi(s,-1,1)),Math.abs(s)<.99999?(this.x=Math.atan2(u,c),this.y=Math.atan2(a,n)):(this.x=Math.atan2(-h,f),this.y=0)),this.order=e,this}setFromQuaternion(t,e){return Ir._tempMatrix4.makeRotationFromQuaternion(t),this.setFromRotationMatrix(Ir._tempMatrix4,e),this}setFromVector3(t,e){return this.set(t.x,t.y,t.z,e!=null?e:this.order)}equals(t){return t.x===this.x&&t.y===this.y&&t.z===this.z&&t.order===this.order}fromArray(t){return this.x=t[0],this.y=t[1],this.z=t[2],t[3]!==void 0&&(this.order=t[3]),this}toArray(t,e=0){return t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t[e+3]=this.order,t}toVector3(){return new L(this.x,this.y,this.z)}applyToVector3(t){return this.toQuaternion(Ir._tempQuat),Ir._tempQuat.applyToVector3(t)}clone(){return new Ir(this.x,this.y,this.z,this.order)}get pitch(){return this.x}set pitch(t){this.x=t}get roll(){return this.y}set roll(t){this.y=t}get yaw(){return this.z}set yaw(t){this.z=t}get pitchDeg(){return Wn(this.pitch)}set pitchDeg(t){this.pitch=Ai(t)}get rollDeg(){return Wn(this.roll)}set rollDeg(t){this.roll=Ai(t)}get yawDeg(){return Wn(this.yaw)}set yawDeg(t){this.yaw=Ai(t)}setFromDegTriple(t){const e=Ai(t[0]),i=Ai(t[1]),n=Ai(t[2]);return this.set(i,n,e),this}toDegTriple(){return[this.yawDeg,this.pitchDeg,this.rollDeg]}setFromDirection(t){const e=Math.atan2(-t.x,t.y),i=Math.asin(t.z),n=0;return this.set(i,n,e),this}toQuaternion(t=new bi){const e=Math.cos(this.x/2),i=Math.cos(this.y/2),n=Math.cos(this.z/2),s=Math.sin(this.x/2),a=Math.sin(this.y/2),l=Math.sin(this.z/2);return this.order===0?t.set(s*i*n+e*a*l,e*a*n-s*i*l,e*i*l+s*a*n,e*i*n-s*a*l):this.order===4?t.set(s*i*n+e*a*l,e*a*n-s*i*l,e*i*l-s*a*n,e*i*n+s*a*l):this.order===2?t.set(s*i*n-e*a*l,e*a*n+s*i*l,e*i*l+s*a*n,e*i*n-s*a*l):this.order===5?t.set(s*i*n-e*a*l,e*a*n+s*i*l,e*i*l-s*a*n,e*i*n+s*a*l):this.order===1?t.set(s*i*n+e*a*l,e*a*n+s*i*l,e*i*l-s*a*n,e*i*n-s*a*l):this.order===3&&t.set(s*i*n-e*a*l,e*a*n-s*i*l,e*i*l+s*a*n,e*i*n+s*a*l),t}toRotationMatrix(t=new Ue){const e=t.elements,i=Math.cos(this.x),n=Math.sin(this.x),s=Math.cos(this.y),a=Math.sin(this.y),l=Math.cos(this.z),c=Math.sin(this.z);if(this.order===0){const h=i*l,d=i*c,u=n*l,f=n*c;e[0]=s*l,e[4]=-s*c,e[8]=a,e[1]=d+u*a,e[5]=h-f*a,e[9]=-n*s,e[2]=f-h*a,e[6]=u+d*a,e[10]=i*s}else if(this.order===4){const h=s*l,d=s*c,u=a*l,f=a*c;e[0]=h+f*n,e[4]=u*n-d,e[8]=i*a,e[1]=i*c,e[5]=i*l,e[9]=-n,e[2]=d*n-u,e[6]=f+h*n,e[10]=i*s}else if(this.order===2){const h=s*l,d=s*c,u=a*l,f=a*c;e[0]=h-f*n,e[4]=-i*c,e[8]=u+d*n,e[1]=d+u*n,e[5]=i*l,e[9]=f-h*n,e[2]=-i*a,e[6]=n,e[10]=i*s}else if(this.order===5){const h=i*l,d=i*c,u=n*l,f=n*c;e[0]=s*l,e[4]=u*a-d,e[8]=h*a+f,e[1]=s*c,e[5]=f*a+h,e[9]=d*a-u,e[2]=-a,e[6]=n*s,e[10]=i*s}else if(this.order===1){const h=i*s,d=i*a,u=n*s,f=n*a;e[0]=s*l,e[4]=f-h*c,e[8]=u*c+d,e[1]=c,e[5]=i*l,e[9]=-n*l,e[2]=-a*l,e[6]=d*c+u,e[10]=h-f*c}else if(this.order===3){const h=i*s,d=i*a,u=n*s,f=n*a;e[0]=s*l,e[4]=-c,e[8]=a*l,e[1]=h*c+f,e[5]=i*l,e[9]=d*c-u,e[2]=u*c-d,e[6]=n*l,e[10]=f*c+h}return e[3]=0,e[7]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,t}};o(Ir,"_tempQuat",new bi),o(Ir,"_tempMatrix4",new Ue);let Fi=Ir;const cc=class cc{constructor(){o(this,"elements",new Float32Array([1,0,0,0,1,0,0,0,1]))}set(t,e,i,n,s,a,l,c,h){const d=this.elements;return d[0]=t,d[3]=e,d[6]=i,d[1]=n,d[4]=s,d[7]=a,d[2]=l,d[5]=c,d[8]=h,this}identity(){return this.set(1,0,0,0,1,0,0,0,1),this}copyFrom(t){const e=t.elements;return this.set(e[0],e[3],e[6],e[1],e[4],e[7],e[2],e[5],e[8]),this}transformVector3(t){const e=t.x,i=t.y,n=t.z,s=this.elements;return t.x=s[0]*e+s[3]*i+s[6]*n,t.y=s[1]*e+s[4]*i+s[7]*n,t.z=s[2]*e+s[5]*i+s[8]*n,t}transformVector3Array(t,e=0,i=t.length){const n=cc._tempVec3;for(let s=0,a=e;s<i;s+=3,a+=3)n.x=t[a+0],n.y=t[a+1],n.z=t[a+2],this.transformVector3(n),t[a+0]=n.x,t[a+1]=n.y,t[a+2]=n.z}multiplyScalar(t){const e=this.elements;return e[0]*=t,e[3]*=t,e[6]*=t,e[1]*=t,e[4]*=t,e[7]*=t,e[2]*=t,e[5]*=t,e[8]*=t,this}determinant(){const t=this.elements;return t[0]*t[4]*t[8]-t[0]*t[5]*t[7]-t[1]*t[3]*t[8]+t[1]*t[5]*t[6]+t[2]*t[3]*t[7]-t[2]*t[4]*t[6]}getInverse(t,e=!1){const i=t.elements,n=this.elements;n[0]=+i[10]*i[5]-i[6]*i[9],n[1]=-i[10]*i[1]+i[2]*i[9],n[2]=+i[6]*i[1]-i[2]*i[5],n[3]=-i[10]*i[4]+i[6]*i[8],n[4]=+i[10]*i[0]-i[2]*i[8],n[5]=-i[6]*i[0]+i[2]*i[4],n[6]=+i[9]*i[4]-i[5]*i[8],n[7]=-i[9]*i[0]+i[1]*i[8],n[8]=+i[5]*i[0]-i[1]*i[4];const s=i[0]*n[0]+i[1]*n[3]+i[2]*n[6];if(s===0){const a="Matrix3.getInverse(): can't invert matrix, determinant is 0";if(e)throw new Error(a);return console.warn(a),this.identity(),this}return this.multiplyScalar(1/s),this}transpose(){const t=this.elements;let e=t[1];return t[1]=t[3],t[3]=e,e=t[2],t[2]=t[6],t[6]=e,e=t[5],t[5]=t[7],t[7]=e,this}getNormalMatrix(t){return this.getInverse(t).transpose(),this}fromArray(t){return this.elements.set(t),this}toArray(){const t=this.elements;return[t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8]]}fromMat4(t){const e=t.elements;this.set(e[0],e[1],e[2],e[4],e[5],e[6],e[8],e[9],e[10])}clone(){return new cc().fromArray(this.elements)}};o(cc,"_tempVec3",new L);let Eo=cc;const ms=class ms{constructor(t=new L,e=0){o(this,"normal");o(this,"constant");this.normal=t,this.constant=e}set(t,e){return this.normal.copyFrom(t),this.constant=e,this}setComponents(t,e,i,n){return this.normal.set(t,e,i),this.constant=n,this}setFromNormalAndCoplanarPoint(t,e){return this.normal.copyFrom(t),this.constant=-e.dot(this.normal),this}setFromCoplanarPoints(t,e,i){const n=ms._tempVec3A,s=ms._tempVec3B,a=n.subVectors(i,e).cross(s.subVectors(t,e)).normalize();return this.setFromNormalAndCoplanarPoint(a,t),this}copyFrom(t){return this.normal.copyFrom(t.normal),this.constant=t.constant,this}normalize(){const t=1/this.normal.length();return this.normal.multiplyScalar(t),this.constant*=t,this}negate(){return this.constant*=-1,this.normal.negate(),this}distanceToPoint(t){return this.normal.dot(t)+this.constant}distanceToSphere(t){return this.distanceToPoint(t.center)-t.radius}projectPoint(t,e=new L){return this.orthoPoint(t,e).sub(t).negate()}orthoPoint(t,e=new L){const i=this.distanceToPoint(t);return e.copyFrom(this.normal).multiplyScalar(i)}isIntersectionLine(t){const e=this.distanceToPoint(t.start),i=this.distanceToPoint(t.end);return e<0&&i>0||i<0&&e>0}intersectLine(t,e=new L){const i=ms._tempVec3A,n=e,s=t.delta(i),a=this.normal.dot(s);if(a==0)return this.distanceToPoint(t.start)==0?n.copyFrom(t.start):void 0;const l=-(t.start.dot(this.normal)+this.constant)/a;if(!(l<0||l>1))return n.copyFrom(s).multiplyScalar(l).add(t.start)}coplanarPoint(t=new L){return t.copyFrom(this.normal).multiplyScalar(-this.constant)}applyMatrix4(t,e){const i=ms._tempVec3A,n=ms._tempVec3B,s=ms._tempMatrix3,l=(e!=null?e:s.getNormalMatrix(t)).transformVector3(i.copyFrom(this.normal)),c=this.coplanarPoint(n);return t.affineTransformPoint3(c),this.setFromNormalAndCoplanarPoint(l,c),this}translate(t){return this.constant=this.constant-t.dot(this.normal),this}equals(t){return t.normal.equals(this.normal)&&t.constant===this.constant}clone(){return new ms().copyFrom(this)}};o(ms,"_tempVec3A",new L),o(ms,"_tempVec3B",new L),o(ms,"_tempMatrix3",new Eo);let kr=ms;const Dr=class Dr{constructor(){o(this,"planes",[new kr,new kr,new kr,new kr,new kr,new kr])}setFromMatrix(t){const e=t.elements,i=this.planes;return i[0].setComponents(e[3]-e[0],e[7]-e[4],e[11]-e[8],e[15]-e[12]).normalize(),i[1].setComponents(e[3]+e[0],e[7]+e[4],e[11]+e[8],e[15]+e[12]).normalize(),i[2].setComponents(e[3]+e[1],e[7]+e[5],e[11]+e[9],e[15]+e[13]).normalize(),i[3].setComponents(e[3]-e[1],e[7]-e[5],e[11]-e[9],e[15]-e[13]).normalize(),i[4].setComponents(e[3]-e[2],e[7]-e[6],e[11]-e[10],e[15]-e[14]).normalize(),i[5].setComponents(e[3]+e[2],e[7]+e[6],e[11]+e[10],e[15]+e[14]).normalize(),this}intersectsObject(t){const e=t.geometry;let i;return e.boundingSphere===null&&e.computeBoundingSphere(),t.matrixWorld?(i=Dr._tempSphere,i.copyFrom(e.boundingSphere),i.applyMatrix4(t.matrixWorld)):i=e.boundingSphere,this.intersectsSphere(i)}nearPlaneDistanceToCenter(t){const e=t.geometry;let i;const n=this.planes[5];return t.matrixWorld?(i=Dr._tempSphere,i.copyFrom(e.boundingSphere),i.applyMatrix4(t.matrixWorld)):i=e.boundingSphere,n.distanceToPoint(i.center)}nearPlaneDistanceToPoint(t){return this.planes[5].distanceToPoint(t)}intersectsSphere(t){const e=this.planes,i=t.center,n=-t.radius;for(let s=0;s<6;s+=1)if(e[s].distanceToPoint(i)<n)return!1;return!0}intersectsBox(t){const e=Dr._tempVec3A,i=Dr._tempVec3B,n=this.planes;for(const s of n){e.x=s.normal.x>0?t.min.x:t.max.x,i.x=s.normal.x>0?t.max.x:t.min.x,e.y=s.normal.y>0?t.min.y:t.max.y,i.y=s.normal.y>0?t.max.y:t.min.y,e.z=s.normal.z>0?t.min.z:t.max.z,i.z=s.normal.z>0?t.max.z:t.min.z;const a=s.distanceToPoint(e),l=s.distanceToPoint(i);if(a<0&&l<0)return!1}return!0}containsPoint(t){return this.planes.every(e=>e.distanceToPoint(t)>=0)}};o(Dr,"_tempSphere",new os),o(Dr,"_tempVec3A",new L),o(Dr,"_tempVec3B",new L);let fa=Dr;const Jo=class Jo{constructor(t=new L,e=new L){o(this,"start");o(this,"end");this.start=t,this.end=e}set(t,e){return this.start.copyFrom(t),this.end.copyFrom(e),this}copyFrom(t){return this.start.copyFrom(t.start),this.end.copyFrom(t.end),this}center(t=new L){return t.addVectors(this.start,this.end).multiplyScalar(.5)}delta(t=new L){return t.subVectors(this.end,this.start)}distanceSq(){return this.start.distanceToSquared(this.end)}distance(){return this.start.distanceTo(this.end)}at(t,e=new L){const i=e;return this.delta(i).multiplyScalar(t).add(this.start)}closestPointToPointParameter(t,e=!1){const i=Jo._tempVec3A,n=Jo._tempVec3B;i.subVectors(t,this.start),n.subVectors(this.end,this.start);const s=n.dot(n);let l=n.dot(i)/s;return e&&(l=Yi(l,0,1)),l}closestPointToPoint(t,e=!1,i=new L){const n=this.closestPointToPointParameter(t,e),s=i;return this.delta(s).multiplyScalar(n).add(this.start)}applyMatrix4(t){return t.affineTransformPoint3(this.start),t.affineTransformPoint3(this.end),this}equals(t){return t.start.equals(this.start)&&t.end.equals(this.end)}clone(){return new Jo().copyFrom(this)}};o(Jo,"_tempVec3A",new L),o(Jo,"_tempVec3B",new L);let Md=Jo;const lb=Math.PI/180;class pa extends Ue{setOrthographic(t,e,i,n,s,a){const l=1/(e-t),c=1/(i-n),h=1/(a-s),d=(e+t)*l,u=(i+n)*c,f=(a+s)*h;return this.setZero(),this.elements[0]=2*l,this.elements[4]=0,this.elements[8]=0,this.elements[12]=-d,this.elements[1]=0,this.elements[5]=2*c,this.elements[9]=0,this.elements[13]=-u,this.elements[2]=0,this.elements[6]=0,this.elements[10]=-2*h,this.elements[14]=-f,this.elements[3]=0,this.elements[7]=0,this.elements[11]=0,this.elements[15]=1,this}setPerspective(t,e,i,n){const s=Math.tan(lb*.5*t),a=i*s,l=2*a,c=e*l,h=-c/2,d=h+c,u=a-l,f=2*i/(d-h),p=2*i/(a-u),m=(d+h)/(d-h),b=(a+u)/(a-u),g=-(n+i)/(n-i),x=-2*n*i/(n-i);return this.setZero(),this.elements[0]=f,this.elements[4]=0,this.elements[8]=m,this.elements[12]=0,this.elements[1]=0,this.elements[5]=p,this.elements[9]=b,this.elements[13]=0,this.elements[2]=0,this.elements[6]=0,this.elements[10]=g,this.elements[14]=x,this.elements[3]=0,this.elements[7]=0,this.elements[11]=-1,this.elements[15]=0,this}copyFrom(t){return super.copyFrom(t)}}const _n=class _n{constructor(){o(this,"histograms");o(this,"indices");o(this,"tmpIndices")}sort(t,e=!1){let i=null;e?(i=t instanceof Float32Array?new Float32Array(t.length):new Int32Array(t.length),i.set(t)):i=t,this.histograms=new Int32Array(_n._max*Math.ceil(64/11));let n=new Int32Array(i.buffer,i.byteOffset,i.byteLength>>2);const s=Math.ceil(i.BYTES_PER_ELEMENT*8/11),a=_n._max*(s-1),l=1<<(i.BYTES_PER_ELEMENT*8-1)%11,c=(l<<1)-1;let h=null,d=new Int32Array(n.length);this.indices=new Uint32Array(n.length),this.tmpIndices=new Uint32Array(n.length);const u=_n._max*s;for(let f=0;f<u;f++)this.histograms[f]=0;this.initHistograms(n,a,c);for(let f=0;f<=a;f+=_n._max){let p=0;for(let m=f;m<f+_n._max;m++){const b=this.histograms[m]+p;this.histograms[m]=p-1,p=b}}return this.lsbPass(n,d),h=d,d=n,n=h,this.pass(n,d),h=d,d=n,n=h,this.msbPass(n,d,l),{array:new Float32Array(d.buffer,d.byteOffset,i.length),indices:this.indices}}lsbPass(t,e){Ce(this.histograms);for(let i=0,n=t.length;i<n;i++){let s=t[i];const a=s>>31;s^=a|2147483648;const l=++this.histograms[s&_n._mask];this.indices[l]=i,e[l]=s}}pass(t,e){const i=t.length;Ce(this.tmpIndices&&this.indices&&this.histograms);for(let n=0;n<i;n++){const s=t[n],a=++this.histograms[_n._max+(s>>>11&_n._mask)];this.tmpIndices[a]=this.indices[n],e[a]=s}this.indices.set(this.tmpIndices)}msbPass(t,e,i){Ce(this.tmpIndices&&this.indices&&this.histograms);const n=(i<<1)-1,s=t.length,a=2*_n._max;for(let l=0;l<s;l++){const c=t[l],h=c>>31,d=++this.histograms[a+(c>>>22&n)];this.tmpIndices[d]=this.indices[l],e[d]=c^(~h|2147483648)}this.indices.set(this.tmpIndices)}initHistograms(t,e,i){Ce(this.histograms);const n=t.length;for(let s=0;s<n;s++){let a=t[s];const l=a>>31;a^=l|2147483648;let c=0,h=0;for(;c<e;c+=_n._max,h+=11)this.histograms[c+(a>>>h&_n._mask)]++;this.histograms[c+(a>>>h&i)]++}}};o(_n,"_max",2048),o(_n,"_mask",_n._max-1);let Ap=_n;const Cn=class Cn{constructor(t=new L,e=new L){o(this,"origin");o(this,"direction");this.origin=t,this.direction=e}set(t,e){return this.origin.copyFrom(t),this.direction.copyFrom(e),this}copyFrom(t){return this.origin.copyFrom(t.origin),this.direction.copyFrom(t.direction),this}at(t,e=new L){return e.copyFrom(this.direction).multiplyScalar(t).add(this.origin)}recast(t){const e=Cn._tempVec3A;return this.origin.copyFrom(this.at(t,e)),this}closestPointToPoint(t,e=new L){const i=e;i.subVectors(t,this.origin);const n=i.dot(this.direction);return n<0?i.copyFrom(this.origin):i.copyFrom(this.direction).multiplyScalar(n).add(this.origin)}distanceToPoint(t){const e=Cn._tempVec3A,i=e.subVectors(t,this.origin).dot(this.direction);return i<0?this.origin.distanceTo(t):(e.copyFrom(this.direction).multiplyScalar(i).add(this.origin),e.distanceTo(t))}isIntersectionSphere(t){return this.distanceToPoint(t.center)<=t.radius}intersectSphere(t,e=new L){const i=Cn._tempVec3A;i.subVectors(t.center,this.origin);const n=i.dot(this.direction),s=i.dot(i)-n*n,a=t.radius*t.radius;if(s>a)return;const l=Math.sqrt(a-s),c=n-l,h=n+l;if(!(c<0&&h<0))return c<0?this.at(h,e):this.at(c,e)}isIntersectionPlane(t){const e=t.distanceToPoint(this.origin);return e===0||t.normal.dot(this.direction)*e<0}distanceToPlane(t){const e=t.normal.dot(this.direction);if(e==0)return t.distanceToPoint(this.origin)==0?0:void 0;const i=-(this.origin.dot(t.normal)+t.constant)/e;return i>=0?i:void 0}intersectPlane(t,e=new L){const i=this.distanceToPlane(t);if(i!==void 0)return this.at(i,e)}isIntersectionBox(t){const e=Cn._tempVec3A;return this.intersectBox(t,e)!==void 0}intersectBox(t,e=new L){let i,n,s,a,l,c;const h=1/this.direction.x,d=1/this.direction.y,u=1/this.direction.z,f=this.origin;if(h>=0?(i=(t.min.x-f.x)*h,n=(t.max.x-f.x)*h):(i=(t.max.x-f.x)*h,n=(t.min.x-f.x)*h),d>=0?(s=(t.min.y-f.y)*d,a=(t.max.y-f.y)*d):(s=(t.max.y-f.y)*d,a=(t.min.y-f.y)*d),!(i>a||s>n)&&((s>i||i!==i)&&(i=s),(a<n||n!==n)&&(n=a),u>=0?(l=(t.min.z-f.z)*u,c=(t.max.z-f.z)*u):(l=(t.max.z-f.z)*u,c=(t.min.z-f.z)*u),!(i>c||l>n)&&((l>i||i!==i)&&(i=l),(c<n||n!==n)&&(n=c),!(n<0))))return this.at(i>=0?i:n,e)}intersectTriangle(t,e,i,n=!1,s=new L){const a=Cn._tempVec3A,l=Cn._tempVec3B,c=Cn._tempVec3C,h=Cn._tempVec3D;l.subVectors(e,t),c.subVectors(i,t),h.crossVectors(l,c);let d=this.direction.dot(h),u;if(d>0){if(n)return;u=1}else if(d<0)u=-1,d=-d;else return;a.subVectors(this.origin,t);const f=u*this.direction.dot(c.crossVectors(a,c));if(f<0)return;const p=u*this.direction.dot(l.cross(a));if(p<0||f+p>d)return;const m=-u*a.dot(h);if(!(m<0))return this.at(m/d,s)}applyMatrix4(t){return t.affineTransformPoint3(this.direction.add(this.origin)),t.affineTransformPoint3(this.origin),this.direction.sub(this.origin),this.direction.normalize(),this}equals(t){return t.origin.equals(this.origin)&&t.direction.equals(this.direction)}clone(){return new Cn().copyFrom(this)}};o(Cn,"_tempVec3A",new L),o(Cn,"_tempVec3B",new L),o(Cn,"_tempVec3C",new L),o(Cn,"_tempVec3D",new L);let Pd=Cn;class We{constructor(t=0,e=0,i=0,n=1){o(this,"x");o(this,"y");o(this,"z");o(this,"w");this.x=t,this.y=e,this.z=i,this.w=n}set(t,e,i,n){return this.x=t,this.y=e,this.z=i,this.w=n,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setZ(t){return this.z=t,this}setW(t){return this.w=t,this}setComponent(t,e){t==0?this.x=e:t==1?this.y=e:t==2?this.z=e:this.w=e}getComponent(t){return t==0?this.x:t==1?this.y:t==2?this.z:this.w}copyFrom(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w!==void 0?t.w:1,this}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w,this}addScalar(t){return this.x+=t,this.y+=t,this.z+=t,this.w+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this.w=t.w+e.w,this}sub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this.w-=t.w,this}subScalar(t){return this.x-=t,this.y-=t,this.z-=t,this.w-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this.w=t.w-e.w,this}multiplyScalar(t){return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this}applyMatrix4(t){const e=this.x,i=this.y,n=this.z,s=this.w,a=t.elements;return this.x=a[0]*e+a[4]*i+a[8]*n+a[12]*s,this.y=a[1]*e+a[5]*i+a[9]*n+a[13]*s,this.z=a[2]*e+a[6]*i+a[10]*n+a[14]*s,this.w=a[3]*e+a[7]*i+a[11]*n+a[15]*s,this}divideScalar(t){if(t!==0){const e=1/t;this.x*=e,this.y*=e,this.z*=e,this.w*=e}else this.x=0,this.y=0,this.z=0,this.w=1;return this}min(t){return this.x=this.x>t.x?t.x:this.x,this.y=this.y>t.y?t.y:this.y,this.z=this.z>t.z?t.z:this.z,this.w=this.w>t.w?t.w:this.w,this}max(t){return this.x=this.x<t.x?t.x:this.x,this.y=this.y<t.y?t.y:this.y,this.z=this.z<t.z?t.z:this.z,this.w=this.w<t.w?t.w:this.w,this}clamp(t,e){return this.x=this.x<t.x?t.x:this.x>e.x?e.x:this.x,this.y=this.y<t.y?t.y:this.y>e.y?e.y:this.y,this.z=this.z<t.z?t.z:this.z>e.z?e.z:this.z,this.w=this.w<t.w?t.w:this.w>e.w?e.w:this.w,this}clampScalar(t,e){return this.x=this.x<t?t:this.x>e?e:this.x,this.y=this.y<t?t:this.y>e?e:this.y,this.z=this.z<t?t:this.z>e?e:this.z,this.w=this.w<t?t:this.w>e?e:this.w,this}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this.w=this.w<0?Math.ceil(this.w):Math.floor(this.w),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthManhattan(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)}normalize(){return this.divideScalar(this.length())}setLength(t){const e=this.length();return e!==0&&t!==e&&this.multiplyScalar(t/e),this}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this.w+=(t.w-this.w)*e,this}lerpVectors(t,e,i){return this.subVectors(e,t).multiplyScalar(i).add(t),this}equals(t){return t.x===this.x&&t.y===this.y&&t.z===this.z&&t.w===this.w}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this.z=t[e+2],this.w=t[e+3],this}toArray(){return[this.x,this.y,this.z,this.w]}clone(){return new We(this.x,this.y,this.z,this.w)}}class Ka{static vertexNormals(t,e){t.length%3;const i=t.length/3;e?e.length%3:i%3;const n=e?e.length/3:i/3,s=new Float32Array(t.length),a=new L,l=new L,c=new L,h=new L,d=new L;for(let u=0;u<n;u++){const f=e?e[u*3+0]*3:u*9+0,p=e?e[u*3+1]*3:u*9+3,m=e?e[u*3+2]*3:u*9+6;a.fromArray(t,f),l.fromArray(t,p),c.fromArray(t,m),h.subVectors(a,l),d.subVectors(c,l),d.cross(h),d.addToArray(s,f),d.addToArray(s,p),d.addToArray(s,m)}return Ka.normalizeVectors(s),s}static normalizeVectors(t){const e=new L;for(let i=0;i<t.length;i+=3)e.fromArray(t,i),e.normalize(),e.fillArray(t,i)}static normalsToSpherical(t,e=!1){t.length%3;const i=t.length/3,n=e?new Int16Array(i*2):new Int8Array(i*2);for(let s=0;s<i;s+=1){const a=t[s*3+0],l=t[s*3+1],c=t[s*3+2],h=(Math.acos(c)/Math.PI-.5)*2,d=Math.atan2(l,a)/Math.PI;n[s*2+0]=Oc(h),n[s*2+1]=Oc(d)}return n}}function Cd(){return yo(window.location.hash)}function it(r){return r in Cd()}function Ao(r){const t=Cd();if(!(r in t))return null;const e=t[r];return e!==void 0?decodeURI(e):null}function cb(r){const t=Cd();return Object.keys(t).filter(e=>e!==r).map(function(e){const i=t[e];return e+(i===void 0?"":"="+i)}).join("&")}function hb(r){return r in yo(window.location.search)}var Tp=(r=>(r.EDIT_MODE="editor",r.NO_SCREENSHOTS="noscreenshots",r.NO_COLLISIONS="no_collisions",r.DEBUG="debug",r.DEBUG_WEBGL="debugwebgl",r.DEBUG_WEBGL_ERROR="debugwebgl_error",r.DEBUG_WEBGL_CALL="debugwebgl_call",r.DEBUG_SPECTOR="debugspector",r.DEBUG_UI="debugui",r.BENCHMARK="benchmark",r.BENCHMARK_OUTPUT="benchmark_output",r.BENCHMARK_MEASUREMENTS="benchmark_measurements",r.BENCHMARK_LIST_ALL="benchmark_list_all",r.DEBUG_SHARED_BUFFERS="debugbuffers",r.DEBUG_CAMERA_PATH="debugcamerapath",r.DEBUG_GEOMETRY_MERGING="debugmerge",r.FORCE_AUTO_EXPOSURE="force_auto_exposure",r.PUPPETEER_TEST="puppeteer_test",r.SHOW_INTERNAL_VIEWS="internalviews",r.UNIVERSAL_MATERIAL_GLTF_PBR="gltf_pbr",r.ALWAYS_RENDER="alwaysrender",r.WEAK_REFLECTION_SHADOW="weak_reflection_shadow",r.LOG_INFO="log",r.LOG_TO_SERVER="savelog",r.LOG_FPS="log_fps",r.LOG_FPS_SKIP_INITIAL_SEC="log_fps_skip",r.FORCE_FXAA="fxaa",r.FORCE_MOTION_BLUR="motionblur",r.NO_MOVE_TARGET="nomovetarget",r.REFLECTION_PROBES_RES="reflection_probes_res",r.CUBEMAP_FILTER_SAMPLES="cubemap_filter_samples",r.NO_MERGE_TRANSPARENT="nomergetransparent",r.FLIP_MOUSE="flipmouse",r.AUTO_PLAY="autoplay",r.HIDE_PLAY="hideplay",r.SHOW_HELP_ON_LOAD="help",r.GAZE_IN_POINTER_LOCK="gazeinpointerlock",r.NO_GAZE_TELEPORT="nogazeteleport",r.VR_LO="vrlo",r.VR_HI="vrhi",r.MOBILE_HI="mobilehi",r.NO_BASIS="nobasis",r.NO_BRDFLUT="nobrdflut",r.NO_REFLECTION_PROBES="no_reflection_probes",r.NO_REFLECTION_PROBE_BOXES="no_reflection_probe_boxes",r.AUTO_EXPOSURE="autoexposure",r.NO_BUILTIN_AA="no_builtin_aa",r.NO_GPU_INFO="no_gpu_info",r.HIGH_PERFORMANCE_POWER_PREFERENCE="high_performance_power_preference",r.DEV_NEW_RENDERER="dev_new_renderer",r.DEV_NEW_SCENE="dev_new_scene",r.DEV_MATERIALX="dev_materialx",r.GPU_COLLIDER="gpu_collider",r.PROFILER="profiler",r.PROFILER_EXPANDED_LOG="profiler_expanded_log",r.PROFILER_ID_TO_LOG="profiler_id_to_log",r))(Tp||{});(()=>{const r=Object.values(Tp),t={};for(const e of r)t[e]=!0;return e=>{var i;return(i=t[e])!=null?i:!1}})();const T={ASSETS_URL:"./",EDIT_MODE:hb("editor"),NO_SCREENSHOTS:it("noscreenshots"),NO_COLLISIONS:it("no_collisions"),DEBUG:it("debug")||it("benchmark"),DEBUG_WEBGL:it("debugwebgl"),DEBUG_WEBGL_ERROR:it("debugwebgl_error"),DEBUG_WEBGL_CALL:it("debugwebgl_call"),DEBUG_SPECTOR:it("debugspector"),DEBUG_UI:it("debugui"),BENCHMARK:it("benchmark"),BENCHMARK_OUTPUT:Ao("benchmark_output"),BENCHMARK_MEASUREMENTS:Ao("benchmark_measurements"),BENCHMARK_LIST_ALL:it("benchmark_list_all"),DEBUG_SHARED_BUFFERS:it("debugbuffers"),DEBUG_CAMERA_PATH:it("debugcamerapath"),DEBUG_GEOMETRY_MERGING:it("debugmerge"),FORCE_AUTO_EXPOSURE:it("force_auto_exposure"),DEBUG_VIEW_MODES:!1,PUPPETEER_TEST:it("puppeteer_test"),SHOW_INTERNAL_VIEWS:it("internalviews"),UNIVERSAL_MATERIAL_GLTF_PBR:it("gltf_pbr"),ALWAYS_RENDER:it("alwaysrender"),WEAK_REFLECTION_SHADOW:it("weak_reflection_shadow"),LOG_INFO:it("log")||it("savelog"),LOG_TO_SERVER:it("savelog"),LOG_TIME:!1,LOG_FPS:it("log_fps"),LOG_FPS_SKIP_INITIAL_SEC:(w0=Ao("log_fps_skip"))!=null?w0:"10",PROGRESSIVE_LOADER_AFTER_SEC:30,CONTEXT_LOST_RESTORE_LIMIT:4,RETRIES_ON_LOAD_ERROR:3,FORCE_FXAA:it("fxaa"),FORCE_MOTION_BLUR:it("motionblur"),FONT_FAMILIES_TO_LOAD:[],MAX_TWO_POINTERS_IN_LINE_DIFF:40,CAMERA_WALK_NEAR:.01,CAMERA_ORBIT_NEAR_FROM_1M:.01,CAMERA_MIN_FAR:100,SKY_DISTANCE_TO_SCENE:100,CAMERA_DEFAULT_FOV:70,CAMERA_ORTHO_FRUSTUM_SIZE:20,CAMERA_DEFAULT_MOVE_MAX_SPEED:1.11,CAMERA_MOVE_MAX_SPEED_SHIFT_FACTOR:2,CAMERA_LOOK_SPEED:Math.PI/1500,CAMERA_LOOK_SMOOTHING:.1,CAMERA_ARROWS_TURN_SPEED:Math.PI/2,CAMERA_SCROLL_SPEED:.5,CAMERA_FULL_ACCELERATION_TIME:.5,CAMERA_FULL_DECELERATION_TIME:.166,CAMERA_MAX_PER_FRAME_LINEAR_DISTANCE:1,CAMERA_FIXED_HEIGHT:null,MAX_GROUND_SEARCH_DEPTH:5.5,MATERIAL_PICKER_BALL_MAX_SIZE:.1,COVER_JSON_URL:"./cover.json",AUTO_TOUR_IN_VIEW_STILL_TIME_MS:3e3,CLICK_MOVE_MIN_DISTANCE_TO_OBSTACLE:.7,CLICK_MOVE_SHOW_TARGET_INDICATOR:!it("nomovetarget"),KEY_MOVE_MIN_DISTANCE_TO_OBSTACLE:.1,MIN_DISTANCE_TO_CEILING:.1,LIGHT_PROBE_MIRROR_SIZE:512,CUSTOM_LIGHT_PROBE_MAX_MIP_SIZE:it("reflection_probes_res"),CUBEMAP_FILTER_SHADER_SAMPLES_COUNT:parseInt((S0=Ao("cubemap_filter_samples"))!=null?S0:"128",10),LIGHT_PROBE_MAX_MIP_SIZE:parseInt((M0=Ao("reflection_probes_res"))!=null?M0:"128",10),LIGHT_PROBE_MIN_MIP_SIZE:4,DEBUG_LIGHT_PROBE_MIPS:!1,EDITOR_COVER_WIDTH:1920,EDITOR_COVER_HEIGHT:1080,MAX_PANORAMA_SIZE:8192,OBJECT_VISIBILITY_TARGET_SIZE:128,DEFAULT_SKY_NAME:"default",EDITOR_CONTROLLED_SKY_NAME:"sky0",EDITOR_SELECTION_COLOR:new _e(5021401).convertGammaToLinear(),ALLOW_MOBILE_VR:!0,FALLBACK_CAMERA_HEIGHT:1.6,LOAD_PRIORITY:{CORE_RESOURCE:0,COLORMAP:1,UV0:1,DIFFUSE:2,LIGHTMAP:3,SKY:4,SPECULARITY:5,VIDEO:6},MERGE_TRANSPARENT_DISABLED:it("nomergetransparent"),urlHashContains:it,urlHashGetArgument:Ao,urlHashRemoveArgument:cb,TELEPORT_TO_VIEW_MAX_TIME:3,TELEPORT_TO_POINT_MAX_TIME:4.5,TELEPORT_PATH_MAX_TIME:6,TELEPORT_TO_VIEW_ACCELERATION:4,TELEPORT_TO_POINT_ACCELERATION:2,TELEPORT_PATH_ACCELERATION:2,GAZE_POINTER_SHOW_LOADING_AFTER_S:2.5,GAZE_POINTER_ACTIVATE_AFTER_S:4.5,SPRITE_ANCHOR_FONT_SIZE:128,POINTER_PRIORITY:{TRANSFORM_CONTROLS:1,EDITOR_SELECTOR:2,INTERACTION_DISPATCHER:3},AVATAR_COLORS:["#f44336","#e81e63","#9c27b0","#673ab7","#3f51b5","#2196f3","#03a9f4","#00bcd4","#009688","#4caf50","#8bc34a","#cddc39","#ffeb3b","#ffc107","#ff9800","#ff5722","#795548","#9e9e9e","#607d8b","#ff5084"],STRINGS:{},DEFAULT_LANGUAGE:"English",ENABLE_MINIMAP:!0,FLIP_MOUSE:it("flipmouse"),AUTO_PLAY:it("autoplay"),HIDE_PLAY:it("hideplay"),SHOW_HELP_ON_LOAD:it("help"),GAZE_IN_POINTER_LOCK:it("gazeinpointerlock"),NO_GAZE_TELEPORT:it("nogazeteleport"),VR_LO:it("vrlo"),VR_HI:it("vrhi"),MOBILE_HI:it("mobilehi"),NO_BASIS:it("nobasis"),NO_BRDFLUT:it("nobrdflut"),NO_REFLECTION_PROBES:it("no_reflection_probes"),NO_REFLECTION_PROBE_BOXES:it("no_reflection_probe_boxes"),ENABLE_REFLECTION_PROBES_BLENDING:!0,MAX_BLENDED_REFLECTION_PROBES:3,AUTO_EXPOSURE:it("autoexposure"),NO_BUILTIN_AA:it("no_builtin_aa")||it("dev_new_renderer"),NO_GPU_INFO:it("no_gpu_info"),HIGH_PERFORMANCE_POWER_PREFERENCE:it("high_performance_power_preference"),DEV_NEW_RENDER_ARCHITECTURE:it("dev_new_renderer"),DEV_DISABLE_UNIFORM_BUFFERS:!it("dev_new_renderer"),DEV_NEW_SCENE:it("dev_new_scene"),DEV_MATERIALX:it("dev_materialx"),CPU_COLLIDER:!it("gpu_collider")||it("dev_new_renderer"),PROFILER:it("profiler"),PROFILER_EXPANDED_LOG:it("profiler_expanded_log"),PROFILER_ID_TO_LOG:(C0=parseInt((P0=Ao("profiler_id_to_log"))!=null?P0:"NaN",10))!=null?C0:void 0,LIGHT_PROBE_MIPS_COUNT:0,DEV_NEW_PIPELINE_STATES:!0,DEV_DISABLE_INTERPOLATION:!0};T.LIGHT_PROBE_MIPS_COUNT=rb(T.LIGHT_PROBE_MIN_MIP_SIZE,T.LIGHT_PROBE_MAX_MIP_SIZE);class db{constructor(t=!0){o(this,"_startTime",0);o(this,"_oldTime",0);o(this,"_elapsedTime",0);o(this,"_running",!1);o(this,"_autoStart");o(this,"_timer");this._autoStart=t,this._timer=self.performance!==void 0&&self.performance.now!==void 0?self.performance:Date}isRunning(){return this._running}start(){this._startTime=this._timer.now(),this._oldTime=this._startTime,this._running=!0}stop(){this.getElapsedTime(),this._running=!1}getElapsedTime(){return this.getDelta(),this._elapsedTime}getDelta(){let t=0;if(this._autoStart&&!this._running&&this.start(),this._running){const e=this._timer.now();t=.001*(e-this._oldTime),this._oldTime=e,this._elapsedTime+=t}return t}}const ub=1320;function fb(){const r=new Date,t=(e,i)=>e.toString().padStart(i,"0");return`${t(r.getHours(),2)}:${t(r.getMinutes(),2)}:${t(r.getSeconds(),2)},${t(r.getMilliseconds(),3)}`}const Ga=class Ga{constructor(){o(this,"log",(...t)=>{});o(this,"_logsToSend",new Array);o(this,"_logLinesRemovedCount",0);o(this,"_lastMessage");o(this,"_lastMessageDuplicates",0);T.LOG_INFO&&(this.log=(...t)=>{console.log(...t)}),T.LOG_TO_SERVER&&this.initLoggingToServer(!0)}_handleLastMessageDuplicates(){this._lastMessageDuplicates!==0&&(this._logsToSend[this._logsToSend.length-1]+=` [${this._lastMessageDuplicates+1} copies]`,this._lastMessageDuplicates=0)}_addLogToSendQueue(t,e,i){if(this._lastMessage===i){this._lastMessageDuplicates+=1;return}if(this._logsToSend.length>=Ga.maxLogsToSend-1){this._logLinesRemovedCount+=1;return}this._handleLastMessageDuplicates(),this._lastMessage=i;const n=t+e.toUpperCase()+" "+i;this._logsToSend.push(n),this._logsToSend.length==1&&setTimeout(this._sendLogs.bind(this),Ga.sendIntervalMs)}_sendLogs(){this._handleLastMessageDuplicates(),this._logLinesRemovedCount>0&&this._logsToSend.push(`[truncated, removed lines ${this._logLinesRemovedCount}]`),Vr("./logs","application/json",JSON.stringify({logs:this._logsToSend})),this._logsToSend.length=0,this._lastMessage=void 0,this._logLinesRemovedCount=0,this._lastMessageDuplicates=0}_wrapConsole(t){const e=console[t].bind(console);console[t]=(...i)=>{const n=i.join(" "),s=T.LOG_TIME?fb()+" ":"";this._addLogToSendQueue(s,t,n),e(s+n)}}_addOnErrorHandler(){window.onerror=(t,e,i,n,s)=>{const a=i?i.toString():"?",l=n?n.toString():"?";return console.error(`Error occured: ${t} (${e}#${a}:${l}/${s})`),!1}}initLoggingToServer(t){t&&(this._wrapConsole("log"),this._wrapConsole("info")),this._wrapConsole("warn"),this._wrapConsole("error"),this._addOnErrorHandler()}};o(Ga,"maxLogsToSend",500),o(Ga,"sendIntervalMs",5e3);let Rd=Ga;const Re=new Rd;class pb{constructor(){o(this,"https");o(this,"localhost");o(this,"ipad");o(this,"mobile");o(this,"ios");o(this,"android");o(this,"facebookApp");o(this,"whatsApp");o(this,"inCrossOriginIframe");o(this,"firefox");o(this,"opera");o(this,"ie");o(this,"edge");o(this,"safari");o(this,"mac");o(this,"chromeVersion");o(this,"browserName");o(this,"basisDecodeWorkers");o(this,"webp",!0);o(this,"_gl");o(this,"_gpuInfo",null);this._asyncDetectGpuSupport(),this._asyncDetectWebpSupport(),this.https=window.location.protocol==="https:",this.localhost=window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1",this.ipad=/iPad/.test(navigator.userAgent)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1,this.mobile=/mobile|ip(hone|od)|android|silk/i.test(navigator.userAgent)||this.ipad||T.urlHashContains("mobile"),this.ios=/iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream||this.ipad,this.android=/Android/.test(navigator.userAgent),this.facebookApp=/FBAN|FBAV/.test(navigator.userAgent),this.whatsApp=/WhatsApp/.test(navigator.userAgent);function t(a){const l=document.createElement("a");return l.href=a,l.protocol+"//"+l.host}this.inCrossOriginIframe=function(){const a=window.self!==window.top,l=t(document.referrer),c=t(window.location.href);return a&&l!==c}();function e(a,l){const c=a.toLowerCase(),h=l.toLowerCase();return c.indexOf(h)!==-1}function i(a){return!navigator||!navigator.userAgent?!1:e(navigator.userAgent,a)}function n(a){return!navigator||!navigator.appVersion?!1:e(navigator.appVersion,a)}this.firefox=i("firefox"),this.opera=i("opera")||i("OPR/"),this.ie=i("msie")||n("trident/"),this.edge=i("edge/"),this.safari=i("safari/")&&!(i("chrome/")||i("chromium/")),this.mac=i("macintosh")&&!this.ipad;const s=navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./);this.chromeVersion=s?parseInt(s[2],10):void 0,this.browserName=this.firefox?"firefox":this.opera?"opera":this.ie?"ie":"chrome",this.browserName=this.edge?"edge":this.safari?"safari":this.browserName,this.basisDecodeWorkers=this.safari||this.ios?0:Math.min(4,navigator.hardwareConcurrency||4)}get gl(){return this._gl,this._gl}_asyncDetectGpuSupport(){const t=navigator.gpu;if(T.NO_GPU_INFO||!t)return;const e=i=>{if(i){if("requestAdapterInfo"in i)i.requestAdapterInfo().then(n=>this._gpuInfo=n);else if("info"in i){const n=i;this._gpuInfo=n.info}}};t.requestAdapter({powerPreference:"high-performance"}).then(e)}_asyncDetectWebpSupport(){const t="UklGRkoAAABXRUJQVlA4WAoAAAAQAAAAAAAAAAAAQUxQSAwAAAARBxAR/Q9ERP8DAABWUDggGAAAABQBAJ0BKgEAAQAAAP4AAA3AAP7mtQAAAA==",e=new Image;e.onload=()=>this.webp=e.width>0&&e.height>0,e.onerror=()=>this.webp=!1,e.src="data:image/webp;base64,"+t}isLongShaderExecutionProblematicDevice(){if(!this.ios)return!1;if(this.ipad)return!0;const e=navigator.userAgent.match(/OS (\d+)_/);if(!e||e.length===0||parseInt(e[1])<18)return!1;const n=window.devicePixelRatio||1,s=Math.min(window.screen.width,window.screen.height),a=Math.max(window.screen.width,window.screen.height),l=`${s}x${a}x${n}`,c={"390x844x3":"iPhone 12/12 Pro/13/13 Pro/14/15","428x926x3":"iPhone 12 Pro Max/13 Pro Max/14 Plus","393x852x3":"iPhone 14 Pro/15 Pro/16","430x932x3":"iPhone 14 Pro Max/15 Plus/15 Pro Max/16 Plus","402x874x3":"iPhone 16 Pro","440x956x3":"iPhone 16 Pro Max"};return!Object.prototype.hasOwnProperty.call(c,l)}fullScreenSupported(){const t=document;if(t.fullscreenEnabled!==void 0||t.webkitFullscreenEnabled!==void 0||t.mozFullScreenEnabled!==void 0||t.msFullscreenEnabled!==void 0)return!!(t.fullscreenEnabled||t.webkitFullscreenEnabled||t.mozFullScreenEnabled||t.msFullscreenEnabled);const e=document.body;return e.mozRequestFullScreen!==void 0||e.webkitRequestFullscreen!==void 0||e.msRequestFullscreen!==void 0||e.requestFullscreen!==void 0}pointerLockSupported(){const t=document;return!this.mobile&&!this.opera&&(document.pointerLockElement!==void 0||t.mozPointerLockElement!==void 0||t.webkitPointerLockElement!==void 0)}resetGlDetector(t){this._gl=new mb(t,this)}getPlatformInfo(){const e=function(s,a){return s.length>a&&(s=s.substring(0,a)),s=s.replace(/[^0-9a-zA-Z() .]/gi,""),encodeURI(s)},i=navigator.connection,n=this._gpuInfo;return{renderApi:n?3:this.gl.webgl2?2:1,webglVendor:this.gl.vendor?e(this.gl.vendor,32):"",webglRenderer:this.gl.renderer?e(this.gl.renderer,128):"",webgpuVendor:n?e(n.vendor,32):"",webgpuArch:n?e(n.architecture,64):"",width:Math.round(window.innerWidth/10)*10,height:Math.round(window.innerHeight/10)*10,dpr:window.devicePixelRatio,cpuCores:navigator.hardwareConcurrency,webp:this.webp?1:0,version:ub,browser:this.browserName,chromeVersion:this.chromeVersion,downloadSpeed:i==null?void 0:i.downlink,roundTripTime:i==null?void 0:i.rtt}}missingCapabilities(){this._gl;let t=null;const e=i=>{t=t?t+", "+i:i};return this._gl.webgl2||e("WebGL2 is not supported"),this._gl.maxTextureSize<4096&&e("4096x4096 textures are not supported"),this.webp||e("WebP format is not supported"),t?`Your GPU/browser does not have sufficient capabilities: ${t}.<br>Try opening this page on a different device.`:null}}class mb{constructor(t,e){o(this,"webgl2");o(this,"antialiasNative");o(this,"antialiasSamples");o(this,"antialiasPostprocess");o(this,"maxAnisotropy");o(this,"fragmentPrecision");o(this,"maxTextureSize");o(this,"maxRenderBufferSize");o(this,"vendor");o(this,"renderer");o(this,"dxtTextures");o(this,"pvrtcTextures");o(this,"etc1Textures");o(this,"astcTextures");o(this,"disableTextureSlotReuse");o(this,"_extensionCache",new Map);o(this,"_glCtx");var s;this._glCtx=t;const i=typeof WebGL2RenderingContext!="undefined"&&t instanceof WebGL2RenderingContext;this.webgl2=i,this.antialiasNative=!!((s=t.getContextAttributes())!=null&&s.antialias&&t.getParameter(t.SAMPLES)>1),this.antialiasSamples=t.getParameter(t.SAMPLES),this.antialiasPostprocess=!e.mobile;const n=this.extension("EXT_texture_filter_anisotropic");if(this.maxAnisotropy=n!==void 0?t.getParameter(n.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,this.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),this.fragmentPrecision=(()=>{if(t.getShaderPrecisionFormat===void 0)return"highp";const a=t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.HIGH_FLOAT);if(a&&a.precision>0)return"highp";const l=t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.MEDIUM_FLOAT);return l&&l.precision>0?"mediump":"lowp"})(),this.maxRenderBufferSize=t.getParameter(t.MAX_RENDERBUFFER_SIZE),this.vendor=t.getParameter(t.VENDOR),this.renderer=t.getParameter(t.RENDERER),!e.firefox){const a=t.getExtension("WEBGL_debug_renderer_info");a&&(this.vendor=t.getParameter(a.UNMASKED_VENDOR_WEBGL),this.renderer=t.getParameter(a.UNMASKED_RENDERER_WEBGL))}this.dxtTextures=(()=>{if(T.urlHashContains("nodxt"))return!1;const a=this.extension("WEBGL_compressed_texture_s3tc"),l=t.getParameter(t.COMPRESSED_TEXTURE_FORMATS);let c=!1,h=!1;if(a)for(let d=0;d<l.length;d+=1)c=c||l[d]===a.COMPRESSED_RGB_S3TC_DXT1_EXT,h=h||l[d]===a.COMPRESSED_RGBA_S3TC_DXT5_EXT;return c&&h})(),this.pvrtcTextures=(()=>T.urlHashContains("nopvr")?!1:!!this.extension("WEBGL_compressed_texture_pvrtc"))(),this.etc1Textures=(()=>T.urlHashContains("noetc1")?!1:!!this.extension("WEBGL_compressed_texture_etc1")&&e.mobile)(),this.astcTextures=(()=>!1)(),this.disableTextureSlotReuse=e.mac||e.chromeVersion===83}extension(t){let e=this._extensionCache.get(t);if(e!==void 0)return e;switch(t){case"EXT_texture_filter_anisotropic":e=this._glCtx.getExtension("EXT_texture_filter_anisotropic")||this._glCtx.getExtension("MOZ_EXT_texture_filter_anisotropic")||this._glCtx.getExtension("WEBKIT_EXT_texture_filter_anisotropic");break;case"WEBGL_compressed_texture_s3tc":e=this._glCtx.getExtension("WEBGL_compressed_texture_s3tc")||this._glCtx.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||this._glCtx.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");break;case"WEBGL_compressed_texture_pvrtc":e=this._glCtx.getExtension("WEBGL_compressed_texture_pvrtc")||this._glCtx.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");break;default:e=this._glCtx.getExtension(t)}return e===null&&(e=void 0),e!==void 0&&this._extensionCache.set(t,e),e}reportToConsole(){const t="WebGL"+(this.webgl2?"2":"");Re.log(t+"; "+this.fragmentPrecision+" fragment precision."),this.dxtTextures||Re.log("DXT textures not supported."),this.antialiasNative?Re.log("Native anti-aliasing supported with "+this.antialiasSamples+" samples."):Re.log("Native anti-aliasing not supported"),this.disableTextureSlotReuse&&Re.log("WebGL texture slot reuse disabled.")}}const $e=new pb;class ci{constructor(){o(this,"_typeToListeners",new Map)}addEventListener(t,e){this._typeToListeners.has(t)||this._typeToListeners.set(t,[]);const i=this._typeToListeners.get(t);i.indexOf(e)===-1&&i.push(e)}hasEventListener(t,e){const i=this._typeToListeners.get(t);return i!==void 0&&i.includes(e)}removeEventListener(t,e){const i=this._typeToListeners.get(t);if(i!==void 0){const n=i.indexOf(e);n!==-1&&i.splice(n,1)}}dispatchEvent(t){const e=this._typeToListeners.get(t.type);if(e===void 0)return;t.target=this;const i=[],n=e.length;for(let s=0;s<n;s++)i[s]=e[s];for(let s=0;s<n;s++)i[s].call(this,t)}}/*!
 * Copyright (C) 2014-present Shapespark
 */function Nc(r,t){if(r.length!==t.length)return!1;for(let e=0;e<r.length;e+=1)if(r[e]!==t[e])return!1;return!0}function Uc(r){setTimeout(r,0)}function Id(r,t){if(r.length===0)return;let e=0,i=t(r[0]);for(let n=1;n<r.length;n+=1){const s=t(r[n]);s>i&&(e=n,i=s)}return e}function Qi(r,t){const e=t.indexOf(r);return console.assert(e!==-1),t.splice(e,1)}function _b(r,t){const e=t.indexOf(r);return e!==-1?t.splice(e,1):[]}function kc(r,t,e){const i=r.indexOf(t),n=e>i?1:-1;for(let s=i;s!==e;s+=n)r[s]=r[s+n];r[e]=t}function Dd(r,t,e){for(let i=0;i<t.length;i+=1){const n=t[i],s=r[n];s!==void 0&&(e[n]=s)}}const Ld=Math.PI*2;function Zt(r){return r%=Ld,r>Math.PI?-Ld+r:r<-Math.PI?Ld+r:r}function wp(r,t){return Math.atan2(-(t.x-r.x),t.y-r.y)}function ma(r,t){r.textContent!==void 0?r.textContent=t:console.warn("textContent and innerText properties are missing")}function Sp(r){return r.ctrlKey||r.altKey||r.metaKey}function Vc(r){const t=new Image;return t.src=r,t}function Mp(r,t){if(r.readyState>=r.HAVE_CURRENT_DATA){t(r);return}function e(){r.readyState>=r.HAVE_CURRENT_DATA&&(r.removeEventListener("playing",e),r.removeEventListener("timeupdate",e),t(r))}r.addEventListener("playing",e),r.addEventListener("timeupdate",e)}function as(r){return JSON.parse(JSON.stringify(r))}function $a(r){return typeof r=="object"?Object.freeze(as(r)):r}function Za(r,t){if(r===t)return!0;if(typeof r!="object"||r===null||typeof t!="object"||t===null||Object.keys(r).length!==Object.keys(t).length)return!1;for(const e of Object.keys(r))if(!Object.prototype.hasOwnProperty.call(t,e)||!Za(r[e],t[e]))return!1;return!0}function gb(){const r=document.getElementsByTagName("script");for(const t of r)if(t.src.includes("walk.min.js"))return t.src.split("/").slice(0,-1).join("/")+"/";return console.error("Cannot determine webwalk URL."),"/webwalk/"}function yi(r){return gb()+r}const Od={FontAwesomeSolid:"",FontAwesomeRegular:"",FontAwesomeBrands:""};function Pp(r,t,e){if(r.length===0){t();return}const i={};r.forEach(l=>{nt(Od[l],"Font "+JSON.stringify(l)+" is not supported."),i[l]=Od[l]});let n=0,s=0;function a(l){l?++n:++s,n+s===r.length&&(s===0?t():e&&e())}WebFont.load({custom:{families:r,testStrings:i},timeout:1e4,fontactive:function(){a(!0)},fontinactive:function(l){console.error("Cannot load font: "+l),a(!1)}})}function Ja(r){return r.startsWith("extra-assets/")?T.ASSETS_URL+r:T.ASSETS_URL+"extra-assets/"+r}function zc(...r){}const Fd=()=>({lineColor:new _e(0),highlightColor:T.EDITOR_SELECTION_COLOR,lightmapResolutionLineColor:new _e(170),autoLightmapResolutionLineColor:new _e(43690),meshSelectedLineColor:new _e(47872),meshSelectedSecondaryLineColor:new _e(13404160),wireframeModeClearColor:new _e(16777215)});function hr(r){return window.TouchEvent&&r instanceof TouchEvent}function Cp(r){let t=0,e,i;for(const n of r)for(e=0;e<n.length;e++)i=n.charCodeAt(e),t=(t<<5)-t+i,t|=0;return t}function Rp(r){return r.length===0?r:r.charAt(0).toUpperCase()+r.slice(1)}/*!
 * Copyright (C) 2021-present Shapespark
 */const Ci={help:{basic:"BASIC",advanced:"ADVANCED",mouse:"Mouse",or:"or",keyboard:"Keyboard",vrTeleport:"VR teleport",holdLeftButton:"Hold the left button",clickLeftButton:"Click the left button",lookAround:"Look around",walkToClickedPlace:"Walk to the clicked place",selectMaterialLightObject:"Select material, light, object",scroll:"Scroll",walkStraight:"Walk straight",walkStraightAndLookAround:"Walk straight and look around",walkStraightAndSideways:"Walk straight and sideways",changeHeight:"Change height",switchView:"Switch view",screenshot:"Screenshot",illuminationPreview:"Illumination preview",hideShowMenu:"Hide/show menu",hideShowMousePointer:"Hide/show mouse pointer",vrMode:"VR Mode",gazeAtFixedPlace:"Gaze at a fixed place",clickControllerButton:"Click a controller button",teleport:"Teleport",touch:"Touch",interactiveDesktop:"Click and drag to look around",interactiveMobile:"Drag to look around"},meetings:{and:"and",close:"Close",cancel:"Cancel",error:"Error",join3dMeeting:"Join 3D meeting",name:"Name",camera:"Camera",microphone:"Microphone",networkIssuesDetected:"Network issues detected.",diagnoseConnection:"Diagnose your connection.",byJoiningYouAgreeTo:"By joining, you agree to the",termsOfService:"Terms of Service",privacyPolicy:"Privacy Policy",infrastructureProvidedUnderTos:"The 3D meeting infrastructure is provided by Shapespark under the following Terms of Service",infrastructureProvidedUnderPp:"The 3D meeting infrastructure is provided by Shapespark under the following Privacy Policy",testCamera:"Test camera",join:"Join",devicesNotFound:{microphone:"Microphone not found",camera:"Camera not found",microphoneAndCamera:"Microphone and camera not found"},devicesBlocked:{microphone:"Microphone blocked",camera:"Camera blocked",microphoneAndCamera:"Microphone and camera blocked"},devicesNotAvailable:{microphone:"Microphone not available",camera:"Camera not available",microphoneAndCamera:"Microphone and camera not available"},checkIfDevicesConnected:{microphone:"Check if your microphone is properly connected.",camera:"Check if your camera is properly connected.",microphoneAndCamera:"Check if your microphone and camera are properly connected."},unblockDevices:{byButtons:{oneDevice:{beforeIcons:"Unblock it by clicking the",afterIcons:"button."},twoDevices:{beforeIcons:"Unblock them by clicking",afterIcons:"buttons."}},inBrowserSettings:{oneDevice:"Unblock it in the browser settings for this webpage.",twoDevices:"Unblock them in the browser settings for this webpage."},byButtonInAddressBar:{oneDevice:{beforeIcon:"Unblock it by clicking the",afterIcon:"button in the browser's address bar and refresh the webpage."},twoDevices:{beforeIcon:"Unblock them by clicking the",afterIcon:"button in the browser's address bar and refresh the webpage."}}},browserDoesNotSupportMeetings:"Your browser doesn't support video meetings. Open the meeting link in another browser.",ifConnectedCloseAppsAndRefresh:{oneDevice:"If it is connected, close all other applications using it and refresh the webpage.",twoDevices:"If they are connected, close all other applications using them and refresh the webpage."},me:"me",pointPlace:"Point a place by clicking.",doYouWantToLeaveMeeting:"Do you want to leave this meeting?",leaveMeeting:"Leave meeting",youHaveLeftMeeting:"You have left the meeting",joinAgain:"Join again",connectionLost:"Meeting connection lost.",code:"Code",meetingEnded:"The meeting has ended.",meetingEndedMaximumDurationReached:"The meeting has ended. Maximum duration of meeting reached.",failedToLoadMeeting:"Failed to load the meeting",failedToJoinMeeting:"Failed to join the meeting. Is your link valid?"}};/*!
 * Copyright (C) 2021-present Shapespark
 */const vb={help:Rn(si({},Ci.help),{basic:"基本",advanced:"高级",mouse:"滑鼠",or:"或",keyboard:"键盘",vrTeleport:"VR 传送",holdLeftButton:"按住左键",clickLeftButton:"单按左键",lookAround:"调整视角",walkToClickedPlace:"走去指定地点",selectMaterialLightObject:"选择材质，灯光，物体",scroll:"滑轮",walkStraight:"直走",walkStraightAndLookAround:"调整视角",walkStraightAndSideways:"移动",changeHeight:"调整高度",switchView:"移动至指定视角",screenshot:"截图",illuminationPreview:"照明预览",hideShowMenu:"隐藏/显示菜单",hideShowMousePointer:"隐藏/显示鼠标",vrMode:"VR 模式",gazeAtFixedPlace:"凝视一个固定的地方",clickControllerButton:"单击控制器按钮",teleport:"传送",touch:"触碰"}),meetings:si({},Ci.meetings)};/*!
 * Copyright (C) 2021-present Shapespark
 */const bb={help:Rn(si({},Ci.help),{basic:"GRUNDLAGEN",advanced:"ERWEITERT",mouse:"Maus",or:"oder",keyboard:"Tastatur",vrTeleport:"VR-Teleport",holdLeftButton:"Linke Maustaste gedrückt halten",clickLeftButton:"Klick auf die linke Maustaste",lookAround:"Umschauen",walkToClickedPlace:"Zum angeklickten Punkt bewegen",selectMaterialLightObject:"Material, Licht, Objekt auswählen",scroll:"Mausrad",walkStraight:"Geradeaus gehen",walkStraightAndLookAround:"Geradeaus gehen und umsehen",walkStraightAndSideways:"Geradeaus und seitwärts gehen",changeHeight:"Höhe ändern",switchView:"Ansicht wechseln",screenshot:"Bildschirmfoto",illuminationPreview:"Beleuchtungsvorschau",hideShowMenu:"Menü aus- / einblenden",hideShowMousePointer:"Mauszeiger aus-/einblenden",vrMode:"VR-Modus",gazeAtFixedPlace:"Blick auf einem Punkt fixieren",clickControllerButton:"Controller Taste drücken",teleport:"Teleportieren",touch:"Tippen"}),meetings:si({},Ci.meetings)};/*!
 * Copyright (C) 2021-present Shapespark
 */const yb={help:Rn(si({},Ci.help),{basic:"BÁSICO",advanced:"AVANZADO",mouse:"Ratón",or:"o",keyboard:"Teclado",vrTeleport:"Teletransporte VR",holdLeftButton:"Mantén presionado el botón izquierdo",clickLeftButton:"Haz clic en el botón izquierdo",lookAround:"Mira a tu alrededor",walkToClickedPlace:"Camina hasta el lugar donde hiciste clic",selectMaterialLightObject:"Selecciona material, luz, objeto",scroll:"Desplázate",walkStraight:"Camina en línea recta",walkStraightAndLookAround:"Camina en línea recta y mira a tu alrededor",walkStraightAndSideways:"Camina recto y de lado",changeHeight:"Cambiar altura",switchView:"Cambiar vista",screenshot:"Captura de pantalla",illuminationPreview:"Vista previa de iluminación",hideShowMenu:"Ocultar / mostrar menú",hideShowMousePointer:"Ocultar / mostrar el puntero del ratón",vrMode:"Modo VR",gazeAtFixedPlace:"Mira a un punto fijo",clickControllerButton:"Pulsa un botón del mando",teleport:"Teletransporte",touch:"Tocar"}),meetings:si({},Ci.meetings)};/*!
 * Copyright (C) 2023-present Shapespark
 */const xb={help:Rn(si({},Ci.help),{basic:"PERUS",advanced:"EDISTYNYT",mouse:"Hiiri",or:"tai",keyboard:"Näppäimistö",vrTeleport:"VR-teleportti",holdLeftButton:"Pidä vasenta painiketta alhaalla",clickLeftButton:"Klikkaa vasenta painiketta",lookAround:"Katso ympärillesi",walkToClickedPlace:"Kävele klikattuun paikkaan",selectMaterialLightObject:"Valitse materiaali, valo, objekti",scroll:"Vieritä",walkStraight:"Kävele suoraan",walkStraightAndLookAround:"Kävele suoraan ja katso ympärillesi",walkStraightAndSideways:"Kävele suoraan ja sivuttain",changeHeight:"Muuta korkeutta",switchView:"Vaihda näkymää",screenshot:"Kuvankaappaus",illuminationPreview:"Valaistuksen esikatselu",hideShowMenu:"Piilota/näytä valikko",hideShowMousePointer:"Piilota/näytä hiiren osoitin",vrMode:"VR-tila",gazeAtFixedPlace:"Tuijota kiinteään paikkaan",clickControllerButton:"Klikkaa ohjaimen painiketta",teleport:"Teleporttaus",touch:"Kosketa",interactiveDesktop:"Klikkaa ja raahaa katsellaksesi ympäri",interactiveMobile:"Raahaa katsellaksesi ympäri"}),meetings:Rn(si({},Ci.meetings),{and:"ja",close:"Sulje",cancel:"Peruuta",error:"Virhe",join3dMeeting:"Astu sisään virtuaalitilaan",name:"Nimi",camera:"Kamera",microphone:"Mikrofoni",networkIssuesDetected:"Verkkoyhteysongelmia havaittu.",diagnoseConnection:"Diagnosoi yhteytesi.",byJoiningYouAgreeTo:"Astuessasi sisään hyväksyt seuraavat:",termsOfService:"Käyttöehdot",privacyPolicy:"Tietosuojakäytäntö",infrastructureProvidedUnderTos:"3D-kokousinfrastruktuurin tarjoaa Shapespark seuraavien käyttöehtojen mukaisesti",infrastructureProvidedUnderPp:"3D-kokousinfrastruktuurin tarjoaa Shapespark tietosuojakäytännön mukaisesti",testCamera:"Testaa kamera",join:"Astu sisään",devicesNotFound:{microphone:"Mikrofonia ei löytynyt",camera:"Kameraa ei löytynyt",microphoneAndCamera:"Mikrofonia ja kameraa ei löytynyt"},devicesBlocked:{microphone:"Mikrofoni on estetty",camera:"Kamera on estetty",microphoneAndCamera:"Mikrofoni ja kamera ovat estetty"},devicesNotAvailable:{microphone:"Mikrofoni ei ole käytettävissä",camera:"Kamera ei ole käytettävissä",microphoneAndCamera:"Mikrofoni ja kamera eivät ole käytettävissä"},checkIfDevicesConnected:{microphone:"Varmista, että mikrofoni on kytketty oikein.",camera:"Varmista, että kamera on kytketty oikein.",microphoneAndCamera:"Varmista, että mikrofoni ja kamera ovat kytketty oikein."},unblockDevices:{byButtons:{oneDevice:{beforeIcons:"Poista esto napsauttamalla",afterIcons:"-painiketta."},twoDevices:{beforeIcons:"Poista niiden estot napsauttamalla",afterIcons:"-painikkeita."}},inBrowserSettings:{oneDevice:"Salli se selaimen asetuksista tälle verkkosivulle.",twoDevices:"Salli ne selaimen asetuksista tälle verkkosivulle."},byButtonInAddressBar:{oneDevice:{beforeIcon:"Salli se napsauttamalla",afterIcon:"-painiketta selaimen osoiterivillä ja päivitä verkkosivu."},twoDevices:{beforeIcon:"Salli ne napsauttamalla",afterIcon:"-painiketta selaimen osoiterivillä ja päivitä verkkosivu."}}},browserDoesNotSupportMeetings:"Selaimesi ei tue videotilaisuuksia. Avaa tilaisuuden linkki toisessa selaimessa.",ifConnectedCloseAppsAndRefresh:{oneDevice:"Jos se on käytössä, sulje kaikki muut sitä käyttävät sovellukset ja päivitä verkkosivu.",twoDevices:"Jos ne ovat käytössä, sulje kaikki muut niitä käyttävät sovellukset ja päivitä verkkosivu."},me:"minä",pointPlace:"Valitse paikka napsauttamalla.",doYouWantToLeaveMeeting:"Haluatko poistua tästä tilaisuudesta?",leaveMeeting:"Poistu tilaisuudesta",youHaveLeftMeeting:"Olet poistunut tilaisuudesta",joinAgain:"Liity uudelleen",connectionLost:"Yhteys tilaisuuteen katkesi.",code:"Koodi",meetingEnded:"Tilaisuus on päättynyt.",meetingEndedMaximumDurationReached:"Tilaisuus on päättynyt. Tilaisuuden enimmäiskesto on saavutettu.",failedToLoadMeeting:"Tilaisuuden lataaminen epäonnistui",failedToJoinMeeting:"Tilaisuuteen liittyminen epäonnistui. Onko linkkisi voimassa?"})};/*!
 * Copyright (C) 2021-present Shapespark
 */const Eb={help:Rn(si({},Ci.help),{basic:"BASIQUES",advanced:"AVANCÉS",mouse:"Souris",or:"ou",keyboard:"Clavier",vrTeleport:"Téléportation VR",holdLeftButton:"Maintenez le bouton gauche",clickLeftButton:"Cliquez sur le bouton gauche",lookAround:"Regardez autour",walkToClickedPlace:"Déplacez-vous jusqu’à l’endroit cliqué",selectMaterialLightObject:"Sélectionnez le matériel, la lumière, l’objet",scroll:"Défilement",walkStraight:"Allez tout droit",walkStraightAndLookAround:"Allez tout droit et regardez autour",walkStraightAndSideways:"Allez tout droit et de côté",changeHeight:"Changez la hauteur",switchView:"Changez de vue",screenshot:"Capture d’écran",illuminationPreview:"Aperçu de l’éclairage",hideShowMenu:"Masquer / Afficher le menu",hideShowMousePointer:"Masquer / Afficher le pointeur de la souris",vrMode:"Mode RV",gazeAtFixedPlace:"Fixez un endroit précis",clickControllerButton:"Appuyez sur un bouton du contrôleur",teleport:"Téléportation",touch:"Touchez"}),meetings:si({},Ci.meetings)};/*!
 * Copyright (C) 2022-present Shapespark
 */const Ab={help:Rn(si({},Ci.help),{basic:"基本操作",advanced:"詳細操作",mouse:"マウス",or:"or",keyboard:"キーボード",vrTeleport:"VR テレポート",holdLeftButton:"左ボタンを長押し",lookAround:"見回す",clickLeftButton:"左ボタン",walkToClickedPlace:"クリックした場所に移動する",selectMaterialLightObject:"マテリアル、ライト、オブジェクトを選択",scroll:"スクロール",walkStraight:"前後移動",walkStraightAndLookAround:"前後移動して見回す",walkStraightAndSideways:"前後左右移動",changeHeight:"高さ調整",switchView:"ビュー切り替え",screenshot:"スクリーンショット",illuminationPreview:"イルミネーションプレビュー",hideShowMenu:"メニュー 表示/非表示",hideShowMousePointer:"マウスカーソル 表示/非表示",vrMode:"VR モード",gazeAtFixedPlace:"特定の場所を見る",clickControllerButton:"コントローラーボタンをクリックする",teleport:"テレポート",touch:"触る",interactiveDesktop:"クリック＆ドラッグして見回す",interactiveMobile:"ドラッグして見回す"}),meetings:si({},Ci.meetings)};/*!
 * Copyright (C) 2022-present Shapespark
 */const Tb={help:Rn(si({},Ci.help),{basic:"기본 조작법",advanced:"상세 조작법",mouse:"마우스",or:"혹은",keyboard:"키보드",vrTeleport:"VR 이동",holdLeftButton:"좌측 버튼 드래그",clickLeftButton:"좌측 버튼 클릭",lookAround:"주변 둘러보기",walkToClickedPlace:"클릭한 곳으로 이동",selectMaterialLightObject:"재질, 조명, 사물 선택",scroll:"스크롤",walkStraight:"직진 이동",walkStraightAndLookAround:"직진 이동 / 주변 둘러보기",walkStraightAndSideways:"직진 이동 / 옆으로 이동",changeHeight:"높이 조절",switchView:"뷰 선택",screenshot:"스크린샷",illuminationPreview:"일루미네이션 프리뷰",hideShowMenu:"메뉴 On/Off",hideShowMousePointer:"마우스 포인터 On/Off",vrMode:"VR 모드",gazeAtFixedPlace:"특정 장소 바라보기",clickControllerButton:"컨트롤러 버튼 클릭",teleport:"텔레포트",touch:"터치"}),meetings:si({},Ci.meetings)};/*!
 * Copyright (C) 2021-present Shapespark
 */const wb={help:Rn(si({},Ci.help),{basic:"PODSTAWOWE",advanced:"ZAAWANSOWANE",mouse:"Myszka",or:"lub",keyboard:"Klawiatura",vrTeleport:"Teleportacja VR",holdLeftButton:"Przytrzymaj lewy przycisk",clickLeftButton:"Naciśnij lewy przycisk",lookAround:"Rozglądaj się",walkToClickedPlace:"Idź do naciśniętego miejsca",selectMaterialLightObject:"Wybierz materiał, światło, obiekt",scroll:"Przewiń",walkStraight:"Idź prosto",walkStraightAndLookAround:"Idź prosto i rozglądaj się",walkStraightAndSideways:"Idź prosto i na boki",changeHeight:"Zmień wysokość",switchView:"Zmień widok",screenshot:"Zrzut ekranu",illuminationPreview:"Podgląd oświetlenia",hideShowMenu:"Schowaj/pokaż menu",hideShowMousePointer:"Schowaj/pokaż kursor myszki",vrMode:"Tryb VR",gazeAtFixedPlace:"Patrz w ustalone miejsce",clickControllerButton:"Naciśnij przycisk kontrolera",teleport:"Teleportacja",touch:"Dotyk",interactiveDesktop:"Klikaj i przeciągaj, aby się rozglądać",interactiveMobile:"Przeciągaj, aby się rozglądać"}),meetings:si({},Ci.meetings)};/*!
 * Copyright (C) 2021-present Shapespark
 */const Sb={help:Rn(si({},Ci.help),{basic:"BÁSICO",advanced:"AVANÇADO",mouse:"Mouse",or:"ou",keyboard:"Teclado",vrTeleport:"Teletransporte VR",holdLeftButton:"Mantenha pressionado o botão esquerdo",clickLeftButton:"Clique com o botão esquerdo",lookAround:"Olhe ao redor",walkToClickedPlace:"Ande até o lugar que foi clicado",selectMaterialLightObject:"Selecione material, luz, objeto",scroll:"Rolagem",walkStraight:"Ande em frente",walkStraightAndLookAround:"Ande em frente e olhe ao redor",walkStraightAndSideways:"Ande em frente e para os lados",changeHeight:"Variar altura",switchView:"Alternar entre cenas",screenshot:"Captura de imagem",illuminationPreview:"Visualização de iluminação",hideShowMenu:"Ocultar/mostrar menu",hideShowMousePointer:"Ocultar/mostrar a seta do mouse",vrMode:"Modo VR",gazeAtFixedPlace:"Olhe para um lugar fixo",clickControllerButton:"Clique num botão controlador",teleport:"Teletransporte",touch:"Toque",interactiveDesktop:"Clique e arraste para olhar ao redor",interactiveMobile:"Arraste para olhar ao redor"}),meetings:si({},Ci.meetings)};/*!
 * Copyright (C) 2021-present Shapespark
 */const Mb={help:Rn(si({},Ci.help),{basic:"Basit",advanced:"İleri Düzey",mouse:"Fare",or:"veya",keyboard:"Klavye",vrTeleport:"VR Işınlanma",holdLeftButton:"Sol tuşa basılı tut",clickLeftButton:"Sol tuşa tıkla",lookAround:"Çevrene bak",walkToClickedPlace:"Tıkladığın alana yürü",selectMaterialLightObject:"Materyal, ışık veya obje seç",scroll:"Aşağı kaydır",walkStraight:"Düz yürü",walkStraightAndLookAround:"Düz yürü ve çevrene bakın",walkStraightAndSideways:"Düz ve yanlana doğru yürü",changeHeight:"Yükseklik değiştir",switchView:"Görünüm değiştir",screenshot:"Ekran Görüntüsü",illuminationPreview:"Aydınlatma önizlemesi",hideShowMenu:"Menüyü göster/gizle",hideShowMousePointer:"İmleci göster/gizle",vrMode:"VR Modu",gazeAtFixedPlace:"Bir noktaya kitlenerek bak",clickControllerButton:"Kumanda butonuna tıkla",teleport:"Işınlan",touch:"Dokun"}),meetings:si({},Ci.meetings)};/*!
 * Copyright (C) 2023-present Shapespark
 */const Bd={Chinese:vb,German:bb,English:Ci,Finnish:xb,French:Eb,Japanese:Ab,Korean:Tb,Polish:wb,Portuguese:Sb,Spanish:yb,Turkish:Mb};/*!
 * Copyright (C) 2021-present Shapespark
 */const Nd=as(Bd[T.DEFAULT_LANGUAGE]);function Bt(r){return`<span data-strings="${r}"></span>`}function Pb(r){const t=r.split(".");let e=Nd;for(const i of t){if(!e||typeof e=="string")return;e=e[i]}if(typeof e=="string")return e}function Ud(r){const t=r.querySelectorAll("[data-strings]");for(let e=0;e<t.length;++e){const i=t.item(e),n=i.getAttribute("data-strings");if(!n)return;const s=Pb(n);s&&(i.textContent=s)}}function To(r,t){r.innerHTML=t,Ud(r)}function Ip(r){function t(e,i,n){Object.entries(i).forEach(([s,a])=>{const l=n===""?s:`${n}.${s}`,c=e[s];if(c===void 0){console.warn(`Viewer string ${l} doesn’t exist`);return}if(a==null){console.error(`${l} must be defined`);return}if(typeof c!=typeof a){console.error(`${l} should be ${typeof c}`);return}switch(typeof a){case"string":e[s]=a;break;case"object":t(e[s],a,l);break}})}t(Nd,r,""),Ud(document)}Ud(document);function Cb(){return $a(Nd)}/*!
 * Copyright (C) 2014-present Shapespark
 */const Rb=15*1e3;class Ib{constructor(){}hideInfo(){const t=document.getElementById("info-message");t.style.display="none"}info(t,e){const i=document.getElementById("info-message");To(i,t),i.style.display="",setTimeout(this.hideInfo,e||Rb),console.info(t)}error(t,e){const i=document.getElementById("error-message"),n=e?`
      <p>${t}</p>
      <button id="toggle-error-details" style="background: none; cursor: pointer;
        border: none; text-decoration: underline;" onclick="
        const details = document.getElementById('error-details');
        if (details.style.display === 'none') {
          details.style.display = 'block';
          this.textContent = '▲ Hide Details';
        } else {
          details.style.display = 'none';
          this.textContent = '▼ Show Details';
        }
        ">
        ▼ Show Details
      </button>
      <div id="error-details" style="display: none; margin-top: 10px; padding: 10px;
        word-wrap: break-word; font-size: smaller; overflow-wrap: break-word;">
        ${e}
      </div>`:t;To(i,n),i.style.display="",console.error(t)}errorWithQr(t){const e=document.getElementById("error-message");e.innerHTML=t+'<div><canvas id="qr-code-inner-canvas" height="180" width="180"></canvas></div>';const i=()=>{const n=document.getElementById("qr-code-inner-canvas");QRCode.toCanvas(n,window.location.toString()),e.style.display="",console.error(t)};So(yi("lib/qrcode.js"),i,()=>ii.error(t))}sceneLoadError(t){const e=$e.missingCapabilities();if(e){ii.errorWithQr(e);return}let i="Scene failed to load. Reload the page to retry.";const n=$e.whatsApp?"WhatsApp":$e.facebookApp?"Facebook app":void 0;n&&(i=`Scene failed to load. Open the scene outside of ${n} by copying the link to the native web browser: <div class='message-scrollable-line'><a href='${window.location}' target='_blank'>${window.location}</a></div>`),this.error(i,t)}}const ii=new Ib;let kd=!1,Dp=!1;function Db(){Dp=!0}const wo={NOT_NEEDED:0,TEST_NEEDED:1,NEEDED:2};function Lb(){const r=new Set,t=new Map;function e(a){try{a()}catch(l){console.log(l)}}function i(a,l,c){const h=document.createElement("script");h.onload=l,h.onerror=c,h.src=a,h.type="text/javascript",h.crossOrigin="anonymous",document.body.appendChild(h)}function n(a){r.add(a);const l=t.get(a);t.delete(a),l.forEach(c=>e(c.onSuccess))}function s(a){const l=t.get(a);t.delete(a),console.error("Can't load script : "+a),l.forEach(function(c){c.onError!==void 0&&e(c.onError.bind(null,a))})}return function(a,l,c){r.has(a)?l():t.has(a)?t.get(a).push({onSuccess:l,onError:c}):(t.set(a,[{onSuccess:l,onError:c}]),i(a,n.bind(this,a),s.bind(this,a)))}}const So=Lb();function Ob(){const r=[],t=[];let e=1/0;function i(){let a=0;for(let l in T.LOAD_PRIORITY)T.LOAD_PRIORITY.hasOwnProperty(l)&&(a=Math.max(a,T.LOAD_PRIORITY[l]));for(let l=0;l<=a;l+=1)r[l]=[],t[l]=0}i();function n(a){Uc(a)}function s(){for(e=e+1;e<r.length;e+=1){const a=r[e];if(a.length>0){for(let l=0;l<a.length;l+=1)t[e]+=1,n(a[l]);a.length=0;break}}}this.add=function(a,l){a<=e?(t[a]+=1,e=a,n(l)):(r[a].push(l),t[e]===0&&s())},this.finished=function(a){t[a]-=1;const l=t[a];console.assert(l>=0),a===e&&l===0&&s()}}const Gc=new Ob;function Fb(r){const t={"https://cdn0.shapespark.com/":"https://cdn0-jsbr.shapespark.com/","https://cdn0.dev.shapespark.com/":"https://cdn0-jsbr.dev.shapespark.com/","https://cdn0-shapespark-cn-dev.oss-accelerate.aliyuncs.com/":"https://cdn0-jsbr-cn-dev.shapespark.com.cn/","https://cdn0-shapespark-cn.oss-accelerate.aliyuncs.com/":"https://cdn0-jsbr.shapespark.com.cn/","https://cdncn0-shapespark.oss-accelerate.aliyuncs.com/":"https://cdncn0-jsbr.shapespark.com.cn/"};for(let[e,i]of Object.entries(t))if(r.startsWith(e))return r.replace(e,i);return r}function Bb(){let r=[],t=[],e,i=!1,n=new XMLHttpRequest;function s(d){const u=new Int8Array(d);return new BrotliDecode(u).buffer}function a(d){e=d;for(let u=0;u<r.length;u+=1)r[u](d);r=null}function l(d){if(i){d();return}t.push(d),t.length===1&&So(yi("lib/brotli.min.js"),()=>{i=!0;for(let u=0;u<t.length;u+=1)t[u]();t=null},()=>ii.error("Cannot load required library"))}function c(){200<=n.status&&n.status<300||n.status===0?a(n.responseText==="SSSSSS"):(console.error("br.buf response",n.status),a(!0))}function h(d){if(e!==void 0){d(e);return}r.push(d),r.length===1&&(n.addEventListener("load",c,!1),n.open("GET",yi("3dassets/br.buf"),!0),n.send())}this.decode=function(d,u,f){u?l(()=>{f(s(d))}):h(p=>{p?f(d):l(()=>{f(s(d))})})}}const Nb=new Bb;function _a(r,t){return function(e){Gc.finished(r),t(e)}}function ga(r){this.method=r,this.binaryResult=!1,this.data=null,this.dataContentType=null,r==="GET"?(this.retriesLeft=T.RETRIES_ON_LOAD_ERROR,this.retryDelayMs=1e3+Math.random()*1e3):(this.retriesLeft=0,this.retryDelayMs=0)}ga.prototype={constructor:ga,retryScheduled:function(){console.assert(this.retriesLeft>0),this.retriesLeft-=1,this.retryDelayMs*=2}};function Ub(r,t,e,i,n,s){setTimeout(function(){Vd(r,t,e,i,n,s)},t.retryDelayMs),t.retryScheduled()}function Vd(r,t,e,i,n,s){let a=new XMLHttpRequest;function l(){const p=a.status||0;return t.method==="GET"&&(p>=500||p===0)?t.retriesLeft!==0:!1}function c(){return!s||Dp!==!0?wo.NOT_NEEDED:a.getAllResponseHeaders().toLowerCase().indexOf("js-content-encoding:")>=0?wo.NEEDED:a.getResponseHeader("content-encoding")==="br"?wo.TEST_NEEDED:wo.NOT_NEEDED}function h(p,m){const b=c();b===wo.NOT_NEEDED?m(p):Nb.decode(p,b===wo.NEEDED,m)}function d(){const p=l();if(console.warn("Failed to "+t.method+": "+r+" ("+a.status+")"+(p?", retrying in "+t.retryDelayMs/1e3+"s":"")),p)s&&!kd&&(console.warn("Switch to jsbr hosts."),kd=!0),Ub(r,t,e,i,n,s);else if(i!==void 0){let m;try{m=JSON.parse(a.responseText).message}catch(b){m=void 0}i(a.status,m)}a=null,t=null}function u(){const p=(m,b)=>{let g;if(b===null){let x="application/json";try{g=JSON.parse(m)}catch(w){g=m,x="text/plain"}console.warn(`content-type not defined for ${r} request's response. Assuming it's ${x}`)}else g=b.includes("text/plain")?m:JSON.parse(m);e(g)};if(e!==void 0)if(t.binaryResult)h(a.response,e);else{const m=a.getResponseHeader("content-type"),b=a.responseText;b?h(b,g=>p(g,m)):e()}a=null,t=null}function f(){200<=a.status&&a.status<300||a.status===0?u():d()}n!==void 0&&a.addEventListener("progress",n,!1),a.addEventListener("load",f,!1),a.addEventListener("error",d,!1),a.addEventListener("abort",d,!1),s&&kd&&(r=Fb(r)),a.open(t.method,r,!0),t.binaryResult&&(a.responseType="arraybuffer"),t.dataContentType&&a.setRequestHeader("Content-Type",t.dataContentType),t.method==="POST"&&a.setRequestHeader("X-Requested-By","Shapespark"),a.send(t.data)}function Hc(r,t,e,i,n,s=!1){const a=new ga("GET");a.binaryResult=t,Vd(r,a,e,i,n,s)}function Mo(r,t,e,i,n,s,a=!1){Gc.add(r,function(){Hc(t,e,_a(r,i),_a(r,n),s,a)})}function Vr(r,t,e,i,n,s){const a=new ga("POST");a.data=e,a.dataContentType=t,Vd(r,a,i,n,s)}function Lp(r,t,e,i,n){function s(){r(t,e,i,n)}return function(){console.warn("Failed to get: "+t+(s?", retrying in "+e.retryDelayMs/1e3+"s":"")),e.retriesLeft>0?(setTimeout(s,e.retryDelayMs),e.retryScheduled()):n()}}function Op(r,t,e,i){let n=new Image;n.onload=function(){e(n),n=null},n.onerror=Lp(Op,r,t,e,i),n.crossOrigin="anonymous",n.src=r}function Fp(r,t,e,i){Gc.add(r,function(){const n=new ga("GET");Op(t,n,_a(r,e),_a(r,i))})}function Bp(r,t,e,i){let n=document.createElement("video");n.muted=!0,n.loop=!0,n.setAttribute("playsinline",""),n.setAttribute("webkit-playsinline",""),n.crossOrigin="anonymous",n.onerror=Lp(Bp,r,t,e,i),Mp(n,function(){n.onerror=void 0,e(n),n=null}),n.src=r,n.play().catch(function(a){a.message.includes("video-only background media was paused to save power.")||i()})}function kb(r,t,e,i){Gc.add(r,function(){const n=new ga("GET");Bp(t,n,_a(r,e),_a(r,i))})}function Vb(r,t,e){function i(a){return new Promise((l,c)=>{So(a,l,c)})}function n(a){e!==void 0&&e(a)}const s=r.map(a=>i(a));Promise.all(s).then(t).catch(n)}function Np(r){return new Promise((t,e)=>{So(r,t,e)})}const zb=new Event("debugUi"),ea=class ea extends EventTarget{constructor(){super();o(this,"_registeredUiCallbacks",new Map)}static instance(){return ea._instance||(ea._instance=new ea),ea._instance}loadImGui(){return $t(this,null,function*(){yield ImGui.default(),ImGui.CreateContext(),ImGui.StyleColorsDark();const e=document.getElementById("walk-canvas");Ce(e instanceof HTMLCanvasElement),ImGui_Impl.Init(e);const i=s=>{ImGui.GetIO().WantCaptureMouse&&s.stopPropagation()},n=s=>{ImGui.GetIO().WantCaptureKeyboard&&s.stopPropagation()};for(const s of["mousedown","mouseup","mousemove","wheel"])e.addEventListener(s,i,!0);for(const s of["keydown","keyup"])e.addEventListener(s,n)})}beginFrame(e){if(ImGui_Impl.NewFrame(e),ImGui.NewFrame(),this._registeredUiCallbacks.size>1){if(ImGui.BeginMainMenuBar()){for(const[i,n]of this._registeredUiCallbacks)ImGui.MenuItem(i,null,n.enabled)&&(n.enabled=!n.enabled,n.enabled?this.addEventListener("debugUi",n.func):this.removeEventListener("debugUi",n.func));ImGui.EndMainMenuBar()}}else if(this._registeredUiCallbacks.size===1){const i=this._registeredUiCallbacks.values().next().value;i.enabled||(i.enabled=!0,this.addEventListener("debugUi",i.func))}this.dispatchEvent(zb)}endFrame(){ImGui.EndFrame()}registerCallback(e,i){T.DEBUG_UI&&this._registeredUiCallbacks.set(e,{func:i,enabled:!1})}};o(ea,"_instance");let va=ea,ls;class In{static setDebugMarker(t){ls&&ls.setMarker(t)}static clearDebugMarker(){ls&&ls.clearMarker()}static captureNextFrame(t){ls&&ls.captureNextFrame(t)}static startCapture(t,e=5e4){ls&&ls.startCapture(t,e)}static stopCapture(){ls&&ls.stopCapture()}static loadSpector(){return $t(this,null,function*(){try{yield Np(yi("lib/spector.bundle.js"))}catch(t){console.error("Cannot load SpectorJS library");return}console.info("SpectorJS loaded"),ls=new SPECTOR.Spector,ls.displayUI()})}static loadWebglDebug(){return $t(this,null,function*(){try{yield Np(yi("lib/webgl-debug.js")),console.info("WebGLDebugUtils loaded")}catch(t){console.error("Cannot load WebGLDebugUtils library")}})}static throwOnGLError(t,e){throw new Error(`${WebGLDebugUtils.glEnumToString(t)} was caused by call to: ${e}`)}static logGLCall(t,e){t!=="shaderSource"&&console.log(`gl.${t}(${WebGLDebugUtils.glFunctionArgsToString(t,e)})`)}static validateNoneOfTheArgsAreUndefined(t,e){Array.from(e).filter(i=>i===void 0).forEach(i=>{const n=WebGLDebugUtils.glFunctionArgToString(t,i);console.error(`undefined passed to gl.${t}(${n})`)})}static logAndValidate(t,e){In.logGLCall(t,e),In.validateNoneOfTheArgsAreUndefined(t,e)}static wrapWebglDebug(t){const e=T.DEBUG_WEBGL_ERROR?In.throwOnGLError:void 0,i=T.DEBUG_WEBGL_CALL?In.logAndValidate:void 0;try{return WebGLDebugUtils.makeDebugContext(t,e,i,void 0)}catch(n){return console.error("WebGLDebugUtils library not loaded"),t}}}function Gb(){return $t(this,null,function*(){T.DEBUG_UI&&(yield va.instance().loadImGui()),T.DEBUG_SPECTOR&&(yield In.loadSpector()),T.DEBUG_WEBGL&&(yield In.loadWebglDebug())})}function Wc(r,t,e){const i=new Uint8Array(18);i[2]=2,i[7]=32,i[12]=r&255,i[13]=r>>8,i[14]=t&255,i[15]=t>>8,i[16]=32,i[17]=8;const n=new Uint8Array(i.length+e.length);return n.set(i),n.set(e,i.length),n}const H={REPEAT:10497,CLAMP_TO_EDGE:33071,MIRRORED_REPEAT:33648,NEAREST:9728,LINEAR:9729,NEAREST_MIPMAP_NEAREST:9984,LINEAR_MIPMAP_NEAREST:9985,NEAREST_MIPMAP_LINEAR:9986,LINEAR_MIPMAP_LINEAR:9987,BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,INT:5124,UNSIGNED_INT:5125,FLOAT:5126,UNSIGNED_SHORT_4_4_4_4:32819,UNSIGNED_SHORT_5_5_5_1:32820,UNSIGNED_SHORT_5_6_5:33635,DEPTH_COMPONENT:6402,RGB:6407,RGBA:6408,HALF_FLOAT:5131,RGB8:32849,RGBA8:32856,RGBA32F:34836,RGB32F:34837,RGBA16F:34842,RGB16F:34843,DEPTH_COMPONENT24:33190,DEPTH24_STENCIL8:35056,DEPTH_COMPONENT32F:36012,FUNC_ADD:32774,FUNC_SUBTRACT:32778,FUNC_REVERSE_SUBTRACT:32779,NONE:0,COMPARE_REF_TO_TEXTURE:34894,NEVER:512,LESS:513,EQUAL:514,LEQUAL:515,GREATER:516,NOTEQUAL:517,GEQUAL:518,ALWAYS:519,ZERO:0,ONE:1,SRC_COLOR:768,ONE_MINUS_SRC_COLOR:769,SRC_ALPHA:770,ONE_MINUS_SRC_ALPHA:771,DST_ALPHA:772,ONE_MINUS_DST_ALPHA:773,DST_COLOR:774,ONE_MINUS_DST_COLOR:775,SRC_ALPHA_SATURATE:776,CONSTANT_COLOR:32769,ONE_MINUS_CONSTANT_COLOR:32770,CONSTANT_ALPHA:32771,ONE_MINUS_CONSTANT_ALPHA:32772,COMPRESSED_RGB_S3TC_DXT1_EXT:33776,COMPRESSED_RGBA_S3TC_DXT1_EXT:33777,COMPRESSED_RGBA_S3TC_DXT3_EXT:33778,COMPRESSED_RGBA_S3TC_DXT5_EXT:33779,COMPRESSED_RGB_PVRTC_4BPPV1_IMG:35840,COMPRESSED_RGBA_PVRTC_4BPPV1_IMG:35842,COMPRESSED_RGB_PVRTC_2BPPV1_IMG:35841,COMPRESSED_RGBA_PVRTC_2BPPV1_IMG:35843,COMPRESSED_RGB_ETC1_WEBGL:36196,COMPRESSED_RGBA_ASTC_4x4_KHR:37808,SAMPLER_2D:35678,SAMPLER_3D:35679,SAMPLER_CUBE:35680,SAMPLER_2D_SHADOW:35682,SAMPLER_2D_ARRAY:36289,SAMPLER_2D_ARRAY_SHADOW:36292,SAMPLER_CUBE_SHADOW:36293,INT_SAMPLER_2D:36298,INT_SAMPLER_3D:36299,INT_SAMPLER_CUBE:36300,INT_SAMPLER_2D_ARRAY:36303,UNSIGNED_INT_SAMPLER_2D:36306,UNSIGNED_INT_SAMPLER_3D:36307,UNSIGNED_INT_SAMPLER_CUBE:36308,UNSIGNED_INT_SAMPLER_2D_ARRAY:36311,MAX_SAMPLES:36183,SAMPLER_BINDING:35097,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,INT_VEC2:35667,INT_VEC3:35668,INT_VEC4:35669,BOOL:35670,BOOL_VEC2:35671,BOOL_VEC3:35672,BOOL_VEC4:35673,FLOAT_MAT2:35674,FLOAT_MAT3:35675,FLOAT_MAT4:35676,TEXTURE_2D:3553,TEXTURE_CUBE_MAP:34067,ARRAY_BUFFER:34962,ELEMENT_ARRAY_BUFFER:34963,KEEP:7680,REPLACE:7681,INCR:7682,DECR:7683,INVERT:5386,INCR_WRAP:34055,DECR_WRAP:34056};var Hb=globalThis&&globalThis.t||function(){var r=function(t,e){return r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(i,n){i.__proto__=n}||function(i,n){for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(i[s]=n[s])},r(t,e)};return function(t,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");r(t,e);function i(){this.constructor=t}t.prototype=e===null?Object.create(e):(i.prototype=e.prototype,new i)}}(),Up=function(){function r(t){t===void 0&&(t=0),this.iteratorType=t}return r.prototype.equals=function(t){return this.o===t.o},r}(),Wb=function(){function r(){this.i=0}return Object.defineProperty(r.prototype,"length",{get:function(){return this.i},enumerable:!1,configurable:!0}),r.prototype.size=function(){return this.i},r.prototype.empty=function(){return this.i===0},r}(),kp=function(r){Hb(t,r);function t(){return r!==null&&r.apply(this,arguments)||this}return t}(Wb),jb=globalThis&&globalThis.t||function(){var r=function(t,e){return r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(i,n){i.__proto__=n}||function(i,n){for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(i[s]=n[s])},r(t,e)};return function(t,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");r(t,e);function i(){this.constructor=t}t.prototype=e===null?Object.create(e):(i.prototype=e.prototype,new i)}}(),Xb=function(r){jb(t,r);function t(){return r!==null&&r.apply(this,arguments)||this}return t}(kp);const qb=Xb;function cs(){throw new RangeError("Iterator access denied!")}var Yb=globalThis&&globalThis.t||function(){var r=function(t,e){return r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(i,n){i.__proto__=n}||function(i,n){for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(i[s]=n[s])},r(t,e)};return function(t,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");r(t,e);function i(){this.constructor=t}t.prototype=e===null?Object.create(e):(i.prototype=e.prototype,new i)}}(),Qb=function(r){Yb(t,r);function t(e,i){var n=r.call(this,i)||this;return n.o=e,n.iteratorType===0?(n.pre=function(){return this.o===0&&cs(),this.o-=1,this},n.next=function(){return this.o===this.container.size()&&cs(),this.o+=1,this}):(n.pre=function(){return this.o===this.container.size()-1&&cs(),this.o+=1,this},n.next=function(){return this.o===-1&&cs(),this.o-=1,this}),n}return Object.defineProperty(t.prototype,"pointer",{get:function(){return this.container.getElementByPos(this.o)},set:function(e){this.container.setElementByPos(this.o,e)},enumerable:!1,configurable:!0}),t.prototype.isAccessible=function(){return this.o!==this.container.size()},t}(Up);function Vp(r,t){return Math.floor((r+t-1)/t)}var Kb=Math.floor,zp=globalThis&&globalThis.t||function(){var r=function(t,e){return r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(i,n){i.__proto__=n}||function(i,n){for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(i[s]=n[s])},r(t,e)};return function(t,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");r(t,e);function i(){this.constructor=t}t.prototype=e===null?Object.create(e):(i.prototype=e.prototype,new i)}}(),$b=globalThis&&globalThis.h||function(r,t){var e={label:0,sent:function(){if(s[0]&1)throw s[1];return s[1]},trys:[],ops:[]},i,n,s,a;return a={next:l(0),throw:l(1),return:l(2)},typeof Symbol=="function"&&(a[Symbol.iterator]=function(){return this}),a;function l(h){return function(d){return c([h,d])}}function c(h){if(i)throw new TypeError("Generator is already executing.");for(;e;)try{if(i=1,n&&(s=h[0]&2?n.return:h[0]?n.throw||((s=n.return)&&s.call(n),0):n.next)&&!(s=s.call(n,h[1])).done)return s;switch(n=0,s&&(h=[h[0]&2,s.value]),h[0]){case 0:case 1:s=h;break;case 4:return e.label++,{value:h[1],done:!1};case 5:e.label++,n=h[1],h=[0];continue;case 7:h=e.ops.pop(),e.trys.pop();continue;default:if(s=e.trys,!(s=s.length>0&&s[s.length-1])&&(h[0]===6||h[0]===2)){e=0;continue}if(h[0]===3&&(!s||h[1]>s[0]&&h[1]<s[3])){e.label=h[1];break}if(h[0]===6&&e.label<s[1]){e.label=s[1],s=h;break}if(s&&e.label<s[2]){e.label=s[2],e.ops.push(h);break}s[2]&&e.ops.pop(),e.trys.pop();continue}h=t.call(r,e)}catch(d){h=[6,d],n=0}finally{i=s=0}if(h[0]&5)throw h[1];return{value:h[0]?h[1]:void 0,done:!0}}},Zb=globalThis&&globalThis.P||function(r,t){var e=typeof Symbol=="function"&&r[Symbol.iterator];if(!e)return r;var i=e.call(r),n,s=[],a;try{for(;(t===void 0||t-- >0)&&!(n=i.next()).done;)s.push(n.value)}catch(l){a={error:l}}finally{try{n&&!n.done&&(e=i.return)&&e.call(i)}finally{if(a)throw a.error}}return s},Jb=globalThis&&globalThis.A||function(r,t,e){if(e||arguments.length===2)for(var i=0,n=t.length,s;i<n;i++)(s||!(i in t))&&(s||(s=Array.prototype.slice.call(t,0,i)),s[i]=t[i]);return r.concat(s||Array.prototype.slice.call(t))},el=function(r){zp(t,r);function t(e,i,n){var s=r.call(this,e,n)||this;return s.container=i,s}return t.prototype.copy=function(){return new t(this.o,this.container,this.iteratorType)},t}(Qb),ey=function(r){zp(t,r);function t(e,i){e===void 0&&(e=[]),i===void 0&&(i=4096);var n=r.call(this)||this;n.C=0,n.q=0,n.D=0,n.R=0,n.N=0,n.G=[];var s=function(){if(typeof e.length=="number")return e.length;if(typeof e.size=="number")return e.size;if(typeof e.size=="function")return e.size();throw new TypeError("Cannot get the length or size of the container")}();n.F=i,n.N=Vp(s,n.F)||1;for(var a=0;a<n.N;++a)n.G.push(new Array(n.F));var l=Vp(s,n.F);n.C=n.D=(n.N>>1)-(l>>1),n.q=n.R=n.F-s%n.F>>1;var c=n;return e.forEach(function(h){c.pushBack(h)}),n}return t.prototype.J=function(e){for(var i=[],n=e||this.N>>1||1,s=0;s<n;++s)i[s]=new Array(this.F);for(var s=this.C;s<this.N;++s)i[i.length]=this.G[s];for(var s=0;s<this.D;++s)i[i.length]=this.G[s];i[i.length]=Jb([],Zb(this.G[this.D]),!1),this.C=n,this.D=i.length-1;for(var s=0;s<n;++s)i[i.length]=new Array(this.F);this.G=i,this.N=i.length},t.prototype.K=function(e){var i,n,s=this.q+e;return i=this.C+Kb(s/this.F),i>=this.N&&(i-=this.N),n=(s+1)%this.F-1,n<0&&(n=this.F-1),{curNodeBucketIndex:i,curNodePointerIndex:n}},t.prototype.clear=function(){this.G=[new Array(this.F)],this.N=1,this.C=this.D=this.i=0,this.q=this.R=this.F>>1},t.prototype.begin=function(){return new el(0,this)},t.prototype.end=function(){return new el(this.i,this)},t.prototype.rBegin=function(){return new el(this.i-1,this,1)},t.prototype.rEnd=function(){return new el(-1,this,1)},t.prototype.front=function(){if(this.i!==0)return this.G[this.C][this.q]},t.prototype.back=function(){if(this.i!==0)return this.G[this.D][this.R]},t.prototype.pushBack=function(e){return this.i&&(this.R<this.F-1?this.R+=1:this.D<this.N-1?(this.D+=1,this.R=0):(this.D=0,this.R=0),this.D===this.C&&this.R===this.q&&this.J()),this.i+=1,this.G[this.D][this.R]=e,this.i},t.prototype.popBack=function(){if(this.i!==0){var e=this.G[this.D][this.R];return this.i!==1&&(this.R>0?this.R-=1:this.D>0?(this.D-=1,this.R=this.F-1):(this.D=this.N-1,this.R=this.F-1)),this.i-=1,e}},t.prototype.pushFront=function(e){return this.i&&(this.q>0?this.q-=1:this.C>0?(this.C-=1,this.q=this.F-1):(this.C=this.N-1,this.q=this.F-1),this.C===this.D&&this.q===this.R&&this.J()),this.i+=1,this.G[this.C][this.q]=e,this.i},t.prototype.popFront=function(){if(this.i!==0){var e=this.G[this.C][this.q];return this.i!==1&&(this.q<this.F-1?this.q+=1:this.C<this.N-1?(this.C+=1,this.q=0):(this.C=0,this.q=0)),this.i-=1,e}},t.prototype.getElementByPos=function(e){if(e<0||e>this.i-1)throw new RangeError;var i=this.K(e),n=i.curNodeBucketIndex,s=i.curNodePointerIndex;return this.G[n][s]},t.prototype.setElementByPos=function(e,i){if(e<0||e>this.i-1)throw new RangeError;var n=this.K(e),s=n.curNodeBucketIndex,a=n.curNodePointerIndex;this.G[s][a]=i},t.prototype.insert=function(e,i,n){n===void 0&&(n=1);var s=this.i;if(e<0||e>s)throw new RangeError;if(e===0)for(;n--;)this.pushFront(i);else if(e===this.i)for(;n--;)this.pushBack(i);else{for(var a=[],l=e;l<this.i;++l)a.push(this.getElementByPos(l));this.cut(e-1);for(var l=0;l<n;++l)this.pushBack(i);for(var l=0;l<a.length;++l)this.pushBack(a[l])}return this.i},t.prototype.cut=function(e){if(e<0)return this.clear(),0;var i=this.K(e),n=i.curNodeBucketIndex,s=i.curNodePointerIndex;return this.D=n,this.R=s,this.i=e+1,this.i},t.prototype.eraseElementByPos=function(e){if(e<0||e>this.i-1)throw new RangeError;if(e===0)this.popFront();else if(e===this.i-1)this.popBack();else{for(var i=this.i-1,n=this.K(e),s=n.curNodeBucketIndex,a=n.curNodePointerIndex,l=e;l<i;++l){var c=this.K(e+1),h=c.curNodeBucketIndex,d=c.curNodePointerIndex;this.G[s][a]=this.G[h][d],s=h,a=d}this.popBack()}return this.i},t.prototype.eraseElementByValue=function(e){var i=this.i;if(i===0)return 0;for(var n=0,s=0;n<i;){var a=this.getElementByPos(n);a!==e&&(this.setElementByPos(s,a),s+=1),n+=1}return this.cut(s-1),this.i},t.prototype.eraseElementByIterator=function(e){var i=e.o;return this.eraseElementByPos(i),e=e.next(),e},t.prototype.find=function(e){for(var i=0;i<this.i;++i)if(this.getElementByPos(i)===e)return new el(i,this);return this.end()},t.prototype.reverse=function(){this.G.reverse().forEach(function(l){l.reverse()});var e=this,i=e.C,n=e.D,s=e.q,a=e.R;return this.C=this.N-n-1,this.D=this.N-i-1,this.q=this.F-a-1,this.R=this.F-s-1,this},t.prototype.unique=function(){if(this.i<=1)return this.i;for(var e=1,i=this.getElementByPos(0),n=1;n<this.i;++n){var s=this.getElementByPos(n);s!==i&&(i=s,this.setElementByPos(e++,s))}return this.cut(e-1),this.i},t.prototype.sort=function(e){for(var i=[],n=0;n<this.i;++n)i.push(this.getElementByPos(n));i.sort(e);for(var n=0;n<this.i;++n)this.setElementByPos(n,i[n]);return this},t.prototype.shrinkToFit=function(){if(this.i!==0){var e=[];if(this.C!==this.D){if(this.C<this.D)for(var i=this.C;i<=this.D;++i)e.push(this.G[i]);else{for(var i=this.C;i<this.N;++i)e.push(this.G[i]);for(var i=0;i<=this.D;++i)e.push(this.G[i])}this.C=0,this.D=e.length-1,this.G=e}}},t.prototype.forEach=function(e){for(var i=0;i<this.i;++i)e(this.getElementByPos(i),i,this)},t.prototype[Symbol.iterator]=function(){var e;return $b(this,function(i){switch(i.label){case 0:e=0,i.label=1;case 1:return e<this.i?[4,this.getElementByPos(e)]:[3,4];case 2:i.sent(),i.label=3;case 3:return++e,[3,1];case 4:return[2]}})},t}(qb);const Gp=ey;var ty=globalThis&&globalThis.t||function(){var r=function(t,e){return r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(i,n){i.__proto__=n}||function(i,n){for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(i[s]=n[s])},r(t,e)};return function(t,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");r(t,e);function i(){this.constructor=t}t.prototype=e===null?Object.create(e):(i.prototype=e.prototype,new i)}}(),Hp=function(){function r(t,e,i){i===void 0&&(i=1),this.Y=void 0,this.Z=void 0,this.tt=void 0,this.p=t,this.H=e,this.ee=i}return r.prototype.L=function(){var t=this,e=t.tt.tt===t;if(e&&t.ee===1)t=t.Z;else if(t.Y)for(t=t.Y;t.Z;)t=t.Z;else{if(e)return t.tt;for(var i=t.tt;i.Y===t;)t=i,i=t.tt;t=i}return t},r.prototype.m=function(){var t=this;if(t.Z){for(t=t.Z;t.Y;)t=t.Y;return t}else{for(var e=t.tt;e.Z===t;)t=e,e=t.tt;return t.Z!==e?e:t}},r.prototype.te=function(){var t=this.tt,e=this.Z,i=e.Y;return t.tt===this?t.tt=e:t.Y===this?t.Y=e:t.Z=e,e.tt=t,e.Y=this,this.tt=e,this.Z=i,i&&(i.tt=this),e},r.prototype.ne=function(){var t=this.tt,e=this.Y,i=e.Z;return t.tt===this?t.tt=e:t.Y===this?t.Y=e:t.Z=e,e.tt=t,e.Z=this,this.tt=e,this.Y=i,i&&(i.tt=this),e},r}(),iy=function(r){ty(t,r);function t(){var e=r!==null&&r.apply(this,arguments)||this;return e.rt=1,e}return t.prototype.te=function(){var e=r.prototype.te.call(this);return this.ie(),e.ie(),e},t.prototype.ne=function(){var e=r.prototype.ne.call(this);return this.ie(),e.ie(),e},t.prototype.ie=function(){this.rt=1,this.Y&&(this.rt+=this.Y.rt),this.Z&&(this.rt+=this.Z.rt)},t}(Hp),ny=globalThis&&globalThis.t||function(){var r=function(t,e){return r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(i,n){i.__proto__=n}||function(i,n){for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(i[s]=n[s])},r(t,e)};return function(t,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");r(t,e);function i(){this.constructor=t}t.prototype=e===null?Object.create(e):(i.prototype=e.prototype,new i)}}(),sy=function(r){ny(t,r);function t(e,i){e===void 0&&(e=function(s,a){return s<a?-1:s>a?1:0}),i===void 0&&(i=!1);var n=r.call(this)||this;return n.rr=void 0,n.j=e,n.enableIndex=i,n.re=i?iy:Hp,n.u=new n.re,n}return t.prototype.$=function(e,i){for(var n=this.u;e;){var s=this.j(e.p,i);if(s<0)e=e.Z;else if(s>0)n=e,e=e.Y;else return e}return n},t.prototype.tr=function(e,i){for(var n=this.u;e;){var s=this.j(e.p,i);s<=0?e=e.Z:(n=e,e=e.Y)}return n},t.prototype.er=function(e,i){for(var n=this.u;e;){var s=this.j(e.p,i);if(s<0)n=e,e=e.Z;else if(s>0)e=e.Y;else return e}return n},t.prototype.nr=function(e,i){for(var n=this.u;e;){var s=this.j(e.p,i);s<0?(n=e,e=e.Z):e=e.Y}return n},t.prototype.se=function(e){for(;;){var i=e.tt;if(i===this.u)return;if(e.ee===1){e.ee=0;return}if(e===i.Y){var n=i.Z;if(n.ee===1)n.ee=0,i.ee=1,i===this.rr?this.rr=i.te():i.te();else if(n.Z&&n.Z.ee===1){n.ee=i.ee,i.ee=0,n.Z.ee=0,i===this.rr?this.rr=i.te():i.te();return}else n.Y&&n.Y.ee===1?(n.ee=1,n.Y.ee=0,n.ne()):(n.ee=1,e=i)}else{var n=i.Y;if(n.ee===1)n.ee=0,i.ee=1,i===this.rr?this.rr=i.ne():i.ne();else if(n.Y&&n.Y.ee===1){n.ee=i.ee,i.ee=0,n.Y.ee=0,i===this.rr?this.rr=i.ne():i.ne();return}else n.Z&&n.Z.ee===1?(n.ee=1,n.Z.ee=0,n.te()):(n.ee=1,e=i)}}},t.prototype.U=function(e){if(this.i===1){this.clear();return}for(var i=e;i.Y||i.Z;){if(i.Z)for(i=i.Z;i.Y;)i=i.Y;else i=i.Y;var n=e.p;e.p=i.p,i.p=n;var s=e.H;e.H=i.H,i.H=s,e=i}this.u.Y===i?this.u.Y=i.tt:this.u.Z===i&&(this.u.Z=i.tt),this.se(i);var a=i.tt;if(i===a.Y?a.Y=void 0:a.Z=void 0,this.i-=1,this.rr.ee=0,this.enableIndex)for(;a!==this.u;)a.rt-=1,a=a.tt},t.prototype.ir=function(e){for(var i=typeof e=="number"?e:void 0,n=typeof e=="function"?e:void 0,s=typeof e=="undefined"?[]:void 0,a=0,l=this.rr,c=[];c.length||l;)if(l)c.push(l),l=l.Y;else{if(l=c.pop(),a===i)return l;s&&s.push(l),n&&n(l,a,this),a+=1,l=l.Z}return s},t.prototype.fe=function(e){for(;;){var i=e.tt;if(i.ee===0)return;var n=i.tt;if(i===n.Y){var s=n.Z;if(s&&s.ee===1){if(s.ee=i.ee=0,n===this.rr)return;n.ee=1,e=n;continue}else if(e===i.Z){if(e.ee=0,e.Y&&(e.Y.tt=i),e.Z&&(e.Z.tt=n),i.Z=e.Y,n.Y=e.Z,e.Y=i,e.Z=n,n===this.rr)this.rr=e,this.u.tt=e;else{var a=n.tt;a.Y===n?a.Y=e:a.Z=e}e.tt=n.tt,i.tt=e,n.tt=e,n.ee=1}else{i.ee=0,n===this.rr?this.rr=n.ne():n.ne(),n.ee=1;return}}else{var s=n.Y;if(s&&s.ee===1){if(s.ee=i.ee=0,n===this.rr)return;n.ee=1,e=n;continue}else if(e===i.Y){if(e.ee=0,e.Y&&(e.Y.tt=n),e.Z&&(e.Z.tt=i),n.Z=e.Y,i.Y=e.Z,e.Y=n,e.Z=i,n===this.rr)this.rr=e,this.u.tt=e;else{var a=n.tt;a.Y===n?a.Y=e:a.Z=e}e.tt=n.tt,i.tt=e,n.tt=e,n.ee=1}else{i.ee=0,n===this.rr?this.rr=n.te():n.te(),n.ee=1;return}}this.enableIndex&&(i.ie(),n.ie(),e.ie());return}},t.prototype.v=function(e,i,n){if(this.rr===void 0)return this.i+=1,this.rr=new this.re(e,i,0),this.rr.tt=this.u,this.u.tt=this.u.Y=this.u.Z=this.rr,this.i;var s,a=this.u.Y,l=this.j(a.p,e);if(l===0)return a.H=i,this.i;if(l>0)a.Y=new this.re(e,i),a.Y.tt=a,s=a.Y,this.u.Y=s;else{var c=this.u.Z,h=this.j(c.p,e);if(h===0)return c.H=i,this.i;if(h<0)c.Z=new this.re(e,i),c.Z.tt=c,s=c.Z,this.u.Z=s;else{if(n!==void 0){var d=n.o;if(d!==this.u){var u=this.j(d.p,e);if(u===0)return d.H=i,this.i;if(u>0){var f=d.L(),p=this.j(f.p,e);if(p===0)return f.H=i,this.i;p<0&&(s=new this.re(e,i),f.Z===void 0?(f.Z=s,s.tt=f):(d.Y=s,s.tt=d))}}}if(s===void 0)for(s=this.rr;;){var m=this.j(s.p,e);if(m>0){if(s.Y===void 0){s.Y=new this.re(e,i),s.Y.tt=s,s=s.Y;break}s=s.Y}else if(m<0){if(s.Z===void 0){s.Z=new this.re(e,i),s.Z.tt=s,s=s.Z;break}s=s.Z}else return s.H=i,this.i}}}if(this.enableIndex)for(var b=s.tt;b!==this.u;)b.rt+=1,b=b.tt;return this.fe(s),this.i+=1,this.i},t.prototype.ar=function(e,i){for(;e;){var n=this.j(e.p,i);if(n<0)e=e.Z;else if(n>0)e=e.Y;else return e}return e||this.u},t.prototype.clear=function(){this.i=0,this.rr=void 0,this.u.tt=void 0,this.u.Y=this.u.Z=void 0},t.prototype.updateKeyByIterator=function(e,i){var n=e.o;if(n===this.u&&cs(),this.i===1)return n.p=i,!0;var s=n.m().p;if(n===this.u.Y)return this.j(s,i)>0?(n.p=i,!0):!1;var a=n.L().p;return n===this.u.Z?this.j(a,i)<0?(n.p=i,!0):!1:this.j(a,i)>=0||this.j(s,i)<=0?!1:(n.p=i,!0)},t.prototype.eraseElementByPos=function(e){if(e<0||e>this.i-1)throw new RangeError;var i=this.ir(e);return this.U(i),this.i},t.prototype.eraseElementByKey=function(e){if(this.i===0)return!1;var i=this.ar(this.rr,e);return i===this.u?!1:(this.U(i),!0)},t.prototype.eraseElementByIterator=function(e){var i=e.o;i===this.u&&cs();var n=i.Z===void 0,s=e.iteratorType===0;return s?n&&e.next():(!n||i.Y===void 0)&&e.next(),this.U(i),e},t.prototype.getHeight=function(){if(this.i===0)return 0;function e(i){return i?Math.max(e(i.Y),e(i.Z))+1:0}return e(this.rr)},t}(kp);const Wp=sy;var ry=globalThis&&globalThis.t||function(){var r=function(t,e){return r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(i,n){i.__proto__=n}||function(i,n){for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(i[s]=n[s])},r(t,e)};return function(t,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");r(t,e);function i(){this.constructor=t}t.prototype=e===null?Object.create(e):(i.prototype=e.prototype,new i)}}(),oy=function(r){ry(t,r);function t(e,i,n){var s=r.call(this,n)||this;return s.o=e,s.u=i,s.iteratorType===0?(s.pre=function(){return this.o===this.u.Y&&cs(),this.o=this.o.L(),this},s.next=function(){return this.o===this.u&&cs(),this.o=this.o.m(),this}):(s.pre=function(){return this.o===this.u.Z&&cs(),this.o=this.o.m(),this},s.next=function(){return this.o===this.u&&cs(),this.o=this.o.L(),this}),s}return Object.defineProperty(t.prototype,"index",{get:function(){var e=this.o,i=this.u.tt;if(e===this.u)return i?i.rt-1:0;var n=0;for(e.Y&&(n+=e.Y.rt);e!==i;){var s=e.tt;e===s.Z&&(n+=1,s.Y&&(n+=s.Y.rt)),e=s}return n},enumerable:!1,configurable:!0}),t.prototype.isAccessible=function(){return this.o!==this.u},t}(Up);const jp=oy;var Xp=globalThis&&globalThis.t||function(){var r=function(t,e){return r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(i,n){i.__proto__=n}||function(i,n){for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(i[s]=n[s])},r(t,e)};return function(t,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");r(t,e);function i(){this.constructor=t}t.prototype=e===null?Object.create(e):(i.prototype=e.prototype,new i)}}(),ay=globalThis&&globalThis.h||function(r,t){var e={label:0,sent:function(){if(s[0]&1)throw s[1];return s[1]},trys:[],ops:[]},i,n,s,a;return a={next:l(0),throw:l(1),return:l(2)},typeof Symbol=="function"&&(a[Symbol.iterator]=function(){return this}),a;function l(h){return function(d){return c([h,d])}}function c(h){if(i)throw new TypeError("Generator is already executing.");for(;e;)try{if(i=1,n&&(s=h[0]&2?n.return:h[0]?n.throw||((s=n.return)&&s.call(n),0):n.next)&&!(s=s.call(n,h[1])).done)return s;switch(n=0,s&&(h=[h[0]&2,s.value]),h[0]){case 0:case 1:s=h;break;case 4:return e.label++,{value:h[1],done:!1};case 5:e.label++,n=h[1],h=[0];continue;case 7:h=e.ops.pop(),e.trys.pop();continue;default:if(s=e.trys,!(s=s.length>0&&s[s.length-1])&&(h[0]===6||h[0]===2)){e=0;continue}if(h[0]===3&&(!s||h[1]>s[0]&&h[1]<s[3])){e.label=h[1];break}if(h[0]===6&&e.label<s[1]){e.label=s[1],s=h;break}if(s&&e.label<s[2]){e.label=s[2],e.ops.push(h);break}s[2]&&e.ops.pop(),e.trys.pop();continue}h=t.call(r,e)}catch(d){h=[6,d],n=0}finally{i=s=0}if(h[0]&5)throw h[1];return{value:h[0]?h[1]:void 0,done:!0}}},dr=function(r){Xp(t,r);function t(e,i,n,s){var a=r.call(this,e,i,s)||this;return a.container=n,a}return Object.defineProperty(t.prototype,"pointer",{get:function(){return this.o===this.u&&cs(),this.o.p},enumerable:!1,configurable:!0}),t.prototype.copy=function(){return new t(this.o,this.u,this.container,this.iteratorType)},t}(jp),ly=function(r){Xp(t,r);function t(e,i,n){e===void 0&&(e=[]);var s=r.call(this,i,n)||this,a=s;return e.forEach(function(l){a.insert(l)}),s}return t.prototype.begin=function(){return new dr(this.u.Y||this.u,this.u,this)},t.prototype.end=function(){return new dr(this.u,this.u,this)},t.prototype.rBegin=function(){return new dr(this.u.Z||this.u,this.u,this,1)},t.prototype.rEnd=function(){return new dr(this.u,this.u,this,1)},t.prototype.front=function(){return this.u.Y?this.u.Y.p:void 0},t.prototype.back=function(){return this.u.Z?this.u.Z.p:void 0},t.prototype.lowerBound=function(e){var i=this.$(this.rr,e);return new dr(i,this.u,this)},t.prototype.upperBound=function(e){var i=this.tr(this.rr,e);return new dr(i,this.u,this)},t.prototype.reverseLowerBound=function(e){var i=this.er(this.rr,e);return new dr(i,this.u,this)},t.prototype.reverseUpperBound=function(e){var i=this.nr(this.rr,e);return new dr(i,this.u,this)},t.prototype.forEach=function(e){this.ir(function(i,n,s){e(i.p,n,s)})},t.prototype.insert=function(e,i){return this.v(e,void 0,i)},t.prototype.getElementByPos=function(e){if(e<0||e>this.i-1)throw new RangeError;var i=this.ir(e);return i.p},t.prototype.find=function(e){var i=this.ar(this.rr,e);return new dr(i,this.u,this)},t.prototype.union=function(e){var i=this;return e.forEach(function(n){i.insert(n)}),this.i},t.prototype[Symbol.iterator]=function(){var e,i,n;return ay(this,function(s){switch(s.label){case 0:e=this.i,i=this.ir(),n=0,s.label=1;case 1:return n<e?[4,i[n].p]:[3,4];case 2:s.sent(),s.label=3;case 3:return++n,[3,1];case 4:return[2]}})},t}(Wp);const cy=ly;var qp=globalThis&&globalThis.t||function(){var r=function(t,e){return r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(i,n){i.__proto__=n}||function(i,n){for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(i[s]=n[s])},r(t,e)};return function(t,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");r(t,e);function i(){this.constructor=t}t.prototype=e===null?Object.create(e):(i.prototype=e.prototype,new i)}}(),hy=globalThis&&globalThis.h||function(r,t){var e={label:0,sent:function(){if(s[0]&1)throw s[1];return s[1]},trys:[],ops:[]},i,n,s,a;return a={next:l(0),throw:l(1),return:l(2)},typeof Symbol=="function"&&(a[Symbol.iterator]=function(){return this}),a;function l(h){return function(d){return c([h,d])}}function c(h){if(i)throw new TypeError("Generator is already executing.");for(;e;)try{if(i=1,n&&(s=h[0]&2?n.return:h[0]?n.throw||((s=n.return)&&s.call(n),0):n.next)&&!(s=s.call(n,h[1])).done)return s;switch(n=0,s&&(h=[h[0]&2,s.value]),h[0]){case 0:case 1:s=h;break;case 4:return e.label++,{value:h[1],done:!1};case 5:e.label++,n=h[1],h=[0];continue;case 7:h=e.ops.pop(),e.trys.pop();continue;default:if(s=e.trys,!(s=s.length>0&&s[s.length-1])&&(h[0]===6||h[0]===2)){e=0;continue}if(h[0]===3&&(!s||h[1]>s[0]&&h[1]<s[3])){e.label=h[1];break}if(h[0]===6&&e.label<s[1]){e.label=s[1],s=h;break}if(s&&e.label<s[2]){e.label=s[2],e.ops.push(h);break}s[2]&&e.ops.pop(),e.trys.pop();continue}h=t.call(r,e)}catch(d){h=[6,d],n=0}finally{i=s=0}if(h[0]&5)throw h[1];return{value:h[0]?h[1]:void 0,done:!0}}},ur=function(r){qp(t,r);function t(e,i,n,s){var a=r.call(this,e,i,s)||this;return a.container=n,a}return Object.defineProperty(t.prototype,"pointer",{get:function(){this.o===this.u&&cs();var e=this;return new Proxy([],{get:function(i,n){return n==="0"?e.o.p:n==="1"?e.o.H:(i[0]=e.o.p,i[1]=e.o.H,i[n])},set:function(i,n,s){if(n!=="1")throw new TypeError("prop must be 1");return e.o.H=s,!0}})},enumerable:!1,configurable:!0}),t.prototype.copy=function(){return new t(this.o,this.u,this.container,this.iteratorType)},t}(jp),dy=function(r){qp(t,r);function t(e,i,n){e===void 0&&(e=[]);var s=r.call(this,i,n)||this,a=s;return e.forEach(function(l){a.setElement(l[0],l[1])}),s}return t.prototype.begin=function(){return new ur(this.u.Y||this.u,this.u,this)},t.prototype.end=function(){return new ur(this.u,this.u,this)},t.prototype.rBegin=function(){return new ur(this.u.Z||this.u,this.u,this,1)},t.prototype.rEnd=function(){return new ur(this.u,this.u,this,1)},t.prototype.front=function(){if(this.i!==0){var e=this.u.Y;return[e.p,e.H]}},t.prototype.back=function(){if(this.i!==0){var e=this.u.Z;return[e.p,e.H]}},t.prototype.lowerBound=function(e){var i=this.$(this.rr,e);return new ur(i,this.u,this)},t.prototype.upperBound=function(e){var i=this.tr(this.rr,e);return new ur(i,this.u,this)},t.prototype.reverseLowerBound=function(e){var i=this.er(this.rr,e);return new ur(i,this.u,this)},t.prototype.reverseUpperBound=function(e){var i=this.nr(this.rr,e);return new ur(i,this.u,this)},t.prototype.forEach=function(e){this.ir(function(i,n,s){e([i.p,i.H],n,s)})},t.prototype.setElement=function(e,i,n){return this.v(e,i,n)},t.prototype.getElementByPos=function(e){if(e<0||e>this.i-1)throw new RangeError;var i=this.ir(e);return[i.p,i.H]},t.prototype.find=function(e){var i=this.ar(this.rr,e);return new ur(i,this.u,this)},t.prototype.getElementByKey=function(e){var i=this.ar(this.rr,e);return i.H},t.prototype.union=function(e){var i=this;return e.forEach(function(n){i.setElement(n[0],n[1])}),this.i},t.prototype[Symbol.iterator]=function(){var e,i,n,s;return hy(this,function(a){switch(a.label){case 0:e=this.i,i=this.ir(),n=0,a.label=1;case 1:return n<e?(s=i[n],[4,[s.p,s.H]]):[3,4];case 2:a.sent(),a.label=3;case 3:return++n,[3,1];case 4:return[2]}})},t}(Wp);const Yp=dy;class Qp{constructor(t){o(this,"context");o(this,"ext",null);o(this,"activeQuery",null);o(this,"isRunning",!1);o(this,"eventsPendingTimestamps",[]);o(this,"resolvedEvents",[]);o(this,"namedContextStack",[]);this.context=t,this.ext=t.getExtension("EXT_disjoint_timer_query_webgl2")}isProfilerRunning(){return this.isRunning}start(){if(this.ext==null)throw new Error("EXT_disjoint_timer_query WebGL extension is not available. Cannot start profiler.");if(this.isRunning)throw new Error("Profiler is already running");const t=this.context.getExtension("WEBGL_debug_renderer_info");if(t!=null){const e=this.context.getParameter(t.UNMASKED_RENDERER_WEBGL);if(e.indexOf("NVIDIA GeForce GT 750M")!==-1)throw new Error(`${e} cards seem to have a buggy implementation of EXT_disjoint_timer_query. Refusing to record to avoid misleading results.`)}this.isRunning=!0,this.eventsPendingTimestamps=[],this.resolvedEvents=[],this.activeQuery=this.context.createQuery(),this.context.beginQuery(this.ext.TIME_ELAPSED_EXT,this.activeQuery),this.pushContext("profile")}stop(){if(this.ext!=null){if(!this.isRunning)throw new Error("Profiler is already stopped");this.isRunning=!1,this.popContext("profile"),this.activeQuery=null,this.context.endQuery(this.ext.TIME_ELAPSED_EXT)}}pushContext(t){this.markAction({type:0,name:t}),this.namedContextStack.push(t)}popContext(t){if(this.namedContextStack.length===0)throw new Error("Tried to pop a context when the context stack is empty!");const e=this.namedContextStack.pop();if(e!==t)throw new Error(`Expected popContext to be called with ${e}, but it was called with ${t}`);this.markAction({type:1,name:t})}withContext(t,e){this.pushContext(t),e(),this.popContext(t)}isReady(){return this.eventsPendingTimestamps.length>0&&this.resolveEventsIfPossible(),this.eventsPendingTimestamps.length===0}getResolvedEvents(){return this.resolvedEvents}exportSpeedscopeProfile(){return $t(this,null,function*(){for(;this.eventsPendingTimestamps.length>0;)this.resolveEventsIfPossible(),yield new Promise(t=>requestAnimationFrame(t));return this.toSpeedscopeProfile()})}downloadWhenReady(){return $t(this,null,function*(){const t=yield this.exportSpeedscopeProfile(),e=document.createElement("a");e.href=URL.createObjectURL(new Blob([t],{type:"application/json"})),e.download=`gpuprofile-${+new Date}.speedscope.json`,document.body.appendChild(e),e.click(),document.body.removeChild(e)})}stopAndDownload(){return $t(this,null,function*(){this.stop(),yield this.downloadWhenReady()})}markAction(t){if(this.ext==null)return;if(this.activeQuery==null)throw new Error("Cannot mark actions while no profile is active");const e=this.context,i=this.activeQuery;this.activeQuery=e.createQuery(),e.endQuery(this.ext.TIME_ELAPSED_EXT),e.beginQuery(this.ext.TIME_ELAPSED_EXT,this.activeQuery),this.eventsPendingTimestamps.push({action:t,query:i})}resolveEventsIfPossible(){if(this.ext==null)return;let t=0;const e=this.context;for(;t<this.eventsPendingTimestamps.length;){let s=this.eventsPendingTimestamps[t],a=s.query;if(!e.getQueryParameter(a,e.QUERY_RESULT_AVAILABLE))break;if(e.getParameter(this.ext.GPU_DISJOINT_EXT))throw new Error("GPU_DISJOINT_EXT");const l=this.context.getQueryParameter(a,e.QUERY_RESULT);e.deleteQuery(a);var i=this.resolvedEvents.length===0?0:this.resolvedEvents[this.resolvedEvents.length-1].timestamp,n=i+l;this.resolvedEvents.push({action:s.action,timestamp:n}),t++}t>0&&(this.eventsPendingTimestamps=this.eventsPendingTimestamps.slice(t))}toSpeedscopeProfile(){const t=[],e=[];if(this.resolvedEvents.length===0)throw new Error("Profile is empty");const i={type:"evented",name:"GPU Profile",unit:"nanoseconds",startValue:0,endValue:this.resolvedEvents[this.resolvedEvents.length-1].timestamp,events:e},n={$schema:"https://www.Speedscopeapp/file-format-schema.json",shared:{frames:t},profiles:[i]},s={};function a(l){return l in s||(s[l]=t.length,t.push({name:l})),s[l]}for(let l of this.resolvedEvents)e.push({type:l.action.type==0?"O":"C",frame:a(l.action.name),at:l.timestamp});return JSON.stringify(n)}}var zd=(r=>(r[r.OPEN_FRAME=0]="OPEN_FRAME",r[r.CLOSE_FRAME=1]="CLOSE_FRAME",r))(zd||{});const Hn=class Hn{static registerIfEnabled(t,e=T.DEBUG){if(T.DEBUG_UI&&e&&"onDebugUi"in t){const i=t.onDebugUi;va.instance().registerCallback(t.constructor.name,i.bind(t))}}static beginWindow(t,e,i,n=!1,s=!0){ImGui.SetNextWindowPos(new ImGui.ImVec2(e.x,e.y),s?ImGui.Cond.FirstUseEver:0),ImGui.SetNextWindowSize(new ImGui.ImVec2(i.x,i.y),ImGui.Cond.FirstUseEver);const a=n?ImGui.WindowFlags.NoDecoration|ImGui.WindowFlags.AlwaysAutoResize|ImGui.WindowFlags.NoSavedSettings|ImGui.WindowFlags.NoFocusOnAppearing|ImGui.WindowFlags.NoNav:0;return ImGui.Begin(t,void 0,a)}static endWindow(){ImGui.End()}static header(t){return ImGui.CollapsingHeader(t,ImGui.TreeNodeFlags.DefaultOpen)}static editObject(t){Hn.tryToHandleObject(!0,t)||Hn.editProperties(t)}static getDisplayString(t,e){if(typeof t[e]=="number")return`${t[e]}`;if(t[e]instanceof ye){const i=t[e];return`${i.x.toFixed(3)} ${i.y.toFixed(3)}`}else if(t[e]instanceof L){const i=t[e];return`${i.x.toFixed(3)} ${i.y.toFixed(3)} ${i.z.toFixed(3)}`}else if(typeof t[e]=="boolean")return`${t[e]}`}static displayProperty(t,e,i){i=i!=null?i:e.toString();const n=Hn.getDisplayString(t,e);return n?(ImGui.Text(`${i}: ${n}`),!0):!1}static editProperty(t,e,i){var a;const n=e.toString()+Hn.DebugEditPropSuffix,s=(a=i==null?void 0:i.label)!=null?a:e.toString();if(n in t)Dc(t,n)(t);else{if(typeof t[e]=="number")return i!=null&&i.comboItems?ImGui.Combo(s,(l=t[e])=>t[e]=l,i.comboItems,i.comboItems.length):i!=null&&i.asInteger?ImGui.DragInt(s,(l=t[e])=>t[e]=l,i==null?void 0:i.speed,i==null?void 0:i.min,i==null?void 0:i.max):(i==null?void 0:i.min)!==void 0&&(i==null?void 0:i.max)!==void 0?ImGui.SliderFloat(s,(l=t[e])=>t[e]=l,i.min,i.max):ImGui.DragFloat(s,(l=t[e])=>t[e]=l,i==null?void 0:i.speed,i==null?void 0:i.min,i==null?void 0:i.max);if(t[e]instanceof L){const l=t[e];return ImGui.DragFloat3(s,l)}else if(typeof t[e]=="boolean")return ImGui.Checkbox(s,(l=t[e])=>t[e]=l)}return!1}static editProperties(t){let e;for(e in t)if(Object.prototype.hasOwnProperty.call(t,e)){if(typeof t[e]=="object"&&Hn.tryToHandleObject(!0,t[e],e))continue;Hn.editProperty(t,e)}}static displayObject(t,e){if(Hn.tryToHandleObject(!1,t))return;const i=e!=null?e:t.constructor.name;ImGui.CollapsingHeader(i,ImGui.TreeNodeFlags.DefaultOpen)&&Hn.displayProperties(t,i)}static displayProperties(t,e,i){let n,s=!1,a=0;const l=ImGui.TableFlags.Borders|ImGui.TableFlags.SizingFixedFit|ImGui.TableFlags.RowBg;if(ImGui.BeginTable(e,2,l)){i&&(ImGui.TableSetupColumn(i),ImGui.TableHeader(i),ImGui.TableHeadersRow());for(n in t)if(Object.prototype.hasOwnProperty.call(t,n)){const c=Hn.getDisplayString(t,n);c?(s&&(ImGui.BeginTable(`${e}${a++}`,2,l),s=!1),ImGui.TableNextRow(),ImGui.TableNextColumn(),ImGui.Text(n.toString()),ImGui.TableNextColumn(),ImGui.Text(c)):typeof t[n]=="object"&&(s||(s=!0,ImGui.EndTable()),Hn.displayProperties(t[n],e+n.toString(),n.toString()))}s||ImGui.EndTable()}}static tryToHandleObject(t,e,i){const s=(t?tl.customEditClasses:tl.customDisplayClasses).get(e.constructor.name);return s?(i&&ImGui.BulletText(i),ImGui.Indent(),s(e),ImGui.Unindent(),!0):!1}};o(Hn,"DebugEditPropSuffix","ImGuiPropEdit"),o(Hn,"DebugAccessPropSuffix","ImGuiPropAccess");let ct=Hn;class uy{constructor(){o(this,"mouseScroll",new ImGui.Vec2);o(this,"scale",new ImGui.Vec2(1,1));o(this,"scaleSensitivity",.01);o(this,"allowScaleInX",!0);o(this,"allowScaleInY",!0);o(this,"minScale",.1);o(this,"maxScale",25)}renderCanvas(){const t=ImGui.GetCursorScreenPos(),e=ImGui.GetContentRegionAvail();e.x=Math.max(50,e.x),e.y=Math.max(50,e.y);const i=new ImGui.Vec2(t.x+e.x,t.y+e.y),n=ImGui.GetIO(),s=ImGui.GetWindowDrawList();s.AddRectFilled(t,i,ImGui.COL32(50,50,50,255)),s.AddRect(t,i,ImGui.COL32(255,255,255,255)),ImGui.InvisibleButton("canvas",e,ImGui.ButtonFlags.MouseButtonLeft|ImGui.ButtonFlags.MouseButtonRight);const a=ImGui.IsItemActive(),l=new ImGui.Vec2(t.x+this.mouseScroll.x,t.y+this.mouseScroll.y),c=-1;a&&ImGui.IsMouseDragging(ImGui.MouseButton.Right,c)&&(this.mouseScroll.x+=n.MouseDelta.x,this.mouseScroll.y+=n.MouseDelta.y),(this.allowScaleInX||this.allowScaleInY)&&a&&ImGui.IsMouseDragging(ImGui.MouseButton.Left,-1)&&(this.allowScaleInX&&(this.scale.x+=n.MouseDelta.x*this.scaleSensitivity,this.scale.x=Math.min(Math.max(this.minScale,this.scale.x),this.maxScale)),this.allowScaleInY&&(this.scale.y+=n.MouseDelta.y*this.scaleSensitivity,this.scale.y=Math.min(Math.max(this.minScale,this.scale.y),this.maxScale)));const h=ImGui.GetMouseDragDelta(ImGui.MouseButton.Right);ImGui.IsMouseReleased(ImGui.MouseButton.Right)&&h.x===0&&h.y===0&&ImGui.OpenPopupOnItemClick("context"),ImGui.BeginPopup("context")&&(ImGui.Button("Reset view")&&(this.scale.x=1,this.scale.y=1,this.mouseScroll.x=0,this.mouseScroll.y=0),ImGui.EndPopup()),s.PushClipRect(t,i,!0);const d=64,u=this.scale;for(let f=this.mouseScroll.x%(d*u.x);f<e.x;f+=d*u.x)s.AddLine(new ImGui.Vec2(t.x+f,t.y),new ImGui.Vec2(t.x+f,i.y),ImGui.COL32(200,200,200,40));for(let f=this.mouseScroll.y%(d*u.y);f<e.y;f+=d*u.y)s.AddLine(new ImGui.Vec2(t.x,t.y+f),new ImGui.Vec2(i.x,t.y+f),ImGui.COL32(200,200,200,40));return l}}const ho=class ho{static ZeroToOne(t,e){if(!T.DEBUG_UI)return;const i=e,n=i+ct.DebugEditPropSuffix;t&&Object.defineProperty(t,n,{value:s=>{ImGui.DragFloat(i,(a=s[i])=>s[i]=a,.025,0,1)}})}static ImGuiClassPropAccess(t=!0,e=!0){function i(n,s){T.DEBUG_UI&&(t&&ho.customDisplayClasses.set(n.name,a=>{ct.displayProperties(a,n.name)}),e&&ho.customEditClasses.set(n.name,a=>{ct.editProperties(a)}))}return i}static ImGuiCustomDisplay(t){function e(i,n){T.DEBUG_UI&&ho.customDisplayClasses.set(i.name,t)}return e}static ImGuiCustomEdit(t){function e(i,n){T.DEBUG_UI&&ho.customEditClasses.set(i.name,t)}return e}};o(ho,"customDisplayClasses",new Map),o(ho,"customEditClasses",new Map);let tl=ho;const Ws=.01;class fy{constructor(){o(this,"_canvas",new uy);o(this,"_tableFlags",ImGui.TableFlags.Borders|ImGui.TableFlags.RowBg|ImGui.TableFlags.Resizable|ImGui.TableFlags.Sortable|ImGui.TableFlags.ScrollY);o(this,"currentFrameIndex",0);o(this,"displaySectionsData",!0);this._canvas.allowScaleInY=!1,this._canvas.maxScale=100}drawUi(t){ImGui.SetNextWindowPos(new ImGui.ImVec2(350,20),ImGui.Cond.FirstUseEver),ImGui.SetNextWindowSize(new ImGui.ImVec2(1200,1e3),ImGui.Cond.FirstUseEver),ImGui.Begin("Profiler"),ImGui.Button(t.profilerActive?"Pause profiler":"Start profiler")&&(t.profilerActive=!t.profilerActive),ImGui.SameLine(),ImGui.Button(this.displaySectionsData?"Display frame graphs":"Display sections data")&&(this.displaySectionsData=!this.displaySectionsData),this.displaySectionsData?this._drawProfilerSectionsData(t):this._drawFrameGraphs(t),ImGui.End()}_drawFrameGraphs(t){const e=Array.from(t.namedFrames.keys());t.profileHistory.forEach((n,s)=>e.push(`Frame ${s+1}`)),ImGui.Combo("Current frame",(n=this.currentFrameIndex)=>this.currentFrameIndex=n,e,e.length);let i;if(this.currentFrameIndex<t.namedFrames.size?i=t.namedFrames.get(e[this.currentFrameIndex]):i=t.profileHistory.getElementByPos(this.currentFrameIndex-t.namedFrames.size),i){ImGui.BeginTable("Profiler",2,this._tableFlags),ImGui.TableSetupColumn("Sections",ImGui.TableColumnFlags.None,.5),ImGui.TableSetupColumn("Call graph",ImGui.TableColumnFlags.WidthStretch,.5),ImGui.TableNextRow(),ImGui.TableNextColumn(),this._drawProfilerSectionsGraphs(i.frameId,t),ImGui.TableNextColumn();const n=this._canvas.renderCanvas(),s=ImGui.GetWindowDrawList();s.AddText(n,ImGui.COL32_WHITE,"GPU call graph:"),n.y+=20,this.drawCallGraph(t,i.gpuSections,n,this._canvas.scale),s.AddText(n,ImGui.COL32_WHITE,"CPU call graph:"),n.y+=20,this.drawCallGraph(t,i.cpuSections,n,this._canvas.scale),ImGui.EndTable()}}_drawProfilerSectionsData(t){ImGui.BeginTable("Profiler sections",7,this._tableFlags),ImGui.TableSetupColumn("Name",ImGui.TableColumnFlags.WidthStretch,.4);const e=ImGui.TableColumnFlags.DefaultSort|ImGui.TableColumnFlags.PreferSortDescending|ImGui.TableColumnFlags.WidthStretch;ImGui.TableSetupColumn("CPU total",e,.2),ImGui.TableSetupColumn("CPU counter",ImGui.TableColumnFlags.WidthStretch,.2),ImGui.TableSetupColumn("CPU average",ImGui.TableColumnFlags.WidthStretch,.2),ImGui.TableSetupColumn("GPU total",e,.2),ImGui.TableSetupColumn("GPU counter",ImGui.TableColumnFlags.WidthStretch,.2),ImGui.TableSetupColumn("GPU average",ImGui.TableColumnFlags.WidthStretch,.2),ImGui.TableHeadersRow();let i=1,n=!0;const s=ImGui.TableGetSortSpecs();s&&(i=s.Specs[0].ColumnIndex,n=s.Specs[0].SortDirection===ImGui.SortDirection.Descending);const a=Array.from(t.sectionsInfo.values()).sort((l,c)=>{switch(i){case 0:return c.name.localeCompare(l.name);case 1:{const h=c.cpuData.total-l.cpuData.total;if(Math.abs(h)>Ws)return n?-h:h;break}case 2:{const h=c.cpuData.measureCounter-l.cpuData.measureCounter;if(Math.abs(h)>Ws)return n?-h:h;break}case 3:{const h=c.cpuData.average-l.cpuData.average;if(Math.abs(h)>Ws)return n?-h:h;break}case 4:{const h=c.gpuData.total-l.gpuData.total;if(Math.abs(h)>Ws)return n?-h:h;break}case 5:{const h=c.gpuData.measureCounter-l.gpuData.measureCounter;if(Math.abs(h)>Ws)return n?-h:h;break}case 6:{const h=c.gpuData.average-l.gpuData.average;if(Math.abs(h)>Ws)return n?-h:h;break}}return c.index-l.index});for(const l of a)ImGui.TableNextRow(),ImGui.TableNextColumn(),ImGui.TextUnformatted(l.name),ImGui.TableNextColumn(),ImGui.TextUnformatted(`${l.cpuData.total.toFixed(2)} ms`),ImGui.TableNextColumn(),ImGui.TextUnformatted(`${l.cpuData.measureCounter}`),ImGui.TableNextColumn(),ImGui.TextUnformatted(`${l.cpuData.average.toFixed(2)} ms`),ImGui.TableNextColumn(),ImGui.TextUnformatted(`${l.gpuData.total.toFixed(2)} ms`),ImGui.TableNextColumn(),ImGui.TextUnformatted(`${l.gpuData.measureCounter.toFixed(2)}`),ImGui.TableNextColumn(),ImGui.TextUnformatted(`${l.gpuData.average.toFixed(2)} ms`);ImGui.EndTable()}_drawProfilerSectionsGraphs(t,e){ImGui.BeginTable("Frame sections",3,this._tableFlags),ImGui.TableSetupColumn("Name",ImGui.TableColumnFlags.None,.2),ImGui.TableSetupColumn("GPU average",ImGui.TableColumnFlags.DefaultSort|ImGui.TableColumnFlags.PreferSortDescending|ImGui.TableColumnFlags.WidthStretch,.4),ImGui.TableSetupColumn("CPU average",ImGui.TableColumnFlags.WidthStretch,.4),ImGui.TableHeadersRow();let i=0,n=0,s=1,a=!0;const l=ImGui.TableGetSortSpecs();l&&(s=l.Specs[0].ColumnIndex,a=l.Specs[0].SortDirection===ImGui.SortDirection.Descending);const c=Array.from(e.sectionsInfo.values()).filter(h=>h.lastFrameId>=t).sort((h,d)=>{i=Math.max(i,Math.max(h.gpuData.movingAverage,d.gpuData.movingAverage));let u=d.gpuData.movingAverage-h.gpuData.movingAverage;n=Math.max(n,Math.max(h.cpuData.movingAverage,d.cpuData.movingAverage));let f=d.cpuData.movingAverage-h.cpuData.movingAverage;if(a||(u=-u,f=-f),s===0)return d.name.localeCompare(h.name);if(s===1){if(Math.abs(u)>Ws)return u;if(Math.abs(f)>Ws)return f}else if(s===2){if(Math.abs(f)>Ws)return f;if(Math.abs(u)>Ws)return u}return d.index-h.index});for(const h of c){ImGui.TableNextRow(),ImGui.TableNextColumn(),ImGui.TextUnformatted(h.name),ImGui.TableNextColumn();const d=`${h.gpuData.movingAverage.toFixed(2)}`;this.plotProfilerSectionData(h.gpuData.samples.buffer,d,ImGui.GetColumnWidth(1),i),ImGui.TableNextColumn();const u=`${h.cpuData.movingAverage.toFixed(2)}`;this.plotProfilerSectionData(h.cpuData.samples.buffer,u,ImGui.GetColumnWidth(2),n)}ImGui.EndTable()}drawCallGraph(t,e,i,n){if(e.length===0)return;const s=ImGui.GetWindowDrawList(),a=ImGui.GetContentRegionAvail(),l=16*n.y,c=new ImGui.Vec2(i.x,i.y),h=a.x*n.x,d=e[0].duration,u=e[0].timestamp,f=h/d,p=3,m=1,b=20,g=5,x=1,w=new ImGui.Vec2,C=new ImGui.Vec2;for(const M of e){const D=t.sectionsInfo.get(M.name),W=M.duration*f;w.x=c.x+(M.timestamp-u)*f,C.x=w.x+W-m,w.y=c.y+(l+p)*M.stackIndex,C.y=w.y+l;const z=D?D.color:ImGui.COL32_WHITE;s.AddRectFilled(w,C,z);const $=M.duration.toFixed(2),Z=ImGui.GetMousePos();C.x=Math.ceil(C.x);const ne=Z.x>=w.x&&Z.x<=C.x&&Z.y>=w.y&&Z.y<=C.y;W>b&&(w.x+=g,w.y+=x,s.AddText(w,ImGui.COL32_BLACK,M.name+` (${$} ms)`)),ne&&(ImGui.BeginTooltip(),ImGui.PushTextWrapPos(ImGui.GetFontSize()*35),ImGui.TextUnformatted(`${M.name}: ${$} ms`),D&&(this.displaySectionMeasureData("Section CPU data",D.cpuData),D.gpuData.measureCounter>0&&this.displaySectionMeasureData("Section GPU data",D.gpuData)),ImGui.PopTextWrapPos(),ImGui.EndTooltip())}i.y=C.y+l}displaySectionMeasureData(t,e){ImGui.Separator(),ImGui.TextUnformatted(t),ImGui.Indent(),ImGui.TextUnformatted(`Average: ${e.average.toFixed(2)} ms`),ImGui.TextUnformatted(`Min: ${e.min.toFixed(2)} ms`),ImGui.TextUnformatted(`Max: ${e.max.toFixed(2)} ms`),ImGui.TextUnformatted(`Total: ${e.total.toFixed(2)} ms`),ImGui.TextUnformatted(`Counter: ${e.measureCounter}`),ImGui.Unindent()}plotProfilerSectionData(t,e,i,n){ImGui.PlotHistogram("",t.buffer,t.buffer.length,t.getPointer(),e,void 0,n,new ImGui.Vec2(i,20))}}class py{constructor(t,e){o(this,"_buffer");o(this,"_pointer",0);this._buffer=new Array(t),this._buffer.fill(e)}get buffer(){return this._buffer}getPointer(){return this._pointer}get(t){return this._buffer[t!=null?t:this._pointer]}set(t,e){return this._buffer[e!=null?e:this._pointer]=t}add(t){this._buffer[this._pointer]=t,this.incrementIndexPointer()}incrementIndexPointer(){this._pointer=(this._pointer+1)%this._buffer.length}}const Gd=60;function Vt(r){return function(t,e,i){if(!T.PROFILER)return i;const n=i.value;return i.value=function(...s){var l;const a=(l=r==null?void 0:r.name)!=null?l:n.name;mt.instance().onSectionBegin(a,r==null?void 0:r.log,r==null?void 0:r.checkGlError,r==null?void 0:r.color);try{return n.apply(this,s)}finally{mt.instance().onSectionEnd(a,r==null?void 0:r.log,r==null?void 0:r.checkGlError)}},i}}class my{constructor(){o(this,"_buffer",new py(Gd,0))}get buffer(){return this._buffer}clearCurrentSample(){this._buffer.set(0)}addToCurrentSample(t){this._buffer.set(this._buffer.get()+t)}incrementIndexPointer(){this._buffer.incrementIndexPointer()}}class Kp{constructor(){o(this,"samples",new my);o(this,"average",0);o(this,"movingAverage",0);o(this,"min",Number.MAX_VALUE);o(this,"max",Number.MIN_VALUE);o(this,"total",0);o(this,"measureCounter",0)}onSampleMeasured(t){this.samples.addToCurrentSample(t),this.measureCounter++,this.total+=t,this.min=Math.min(this.min,t),this.max=Math.max(this.max,t),this.average=this.total/this.measureCounter,this.movingAverage=(this.movingAverage*(Gd-1)+t)/Gd}}class _y{constructor(t,e,i){o(this,"gpuSections",new Array);o(this,"webGLProfiler");o(this,"cpuSections",new Array);o(this,"cpuStackIndices",new Array);o(this,"frameId");o(this,"profilerFrameArgs");o(this,"_gpuEventsResolved",!1);this.webGLProfiler=e,this.frameId=t,this.profilerFrameArgs=i}start(){var t,e,i;(t=this.webGLProfiler)!=null&&t.isReady()&&this.webGLProfiler.start(),this.beginSection(`ProfilerFrame ${(i=(e=this.profilerFrameArgs)==null?void 0:e.name)!=null?i:this.frameId.toString()}`)}beginSection(t){var i;const e=this.cpuSections.length;this.cpuStackIndices.push(e),this.cpuSections.push({name:t,timestamp:performance.now(),duration:0,stackIndex:this.cpuStackIndices.length-1}),(i=this.webGLProfiler)!=null&&i.isProfilerRunning()&&this.webGLProfiler.pushContext(t)}endSection(t,e){var a;this.cpuStackIndices.length>0;const i=this.cpuStackIndices.pop(),n=this.cpuSections[i];n.duration=performance.now()-n.timestamp;const s=e.get(t);s&&(s.cpuData.onSampleMeasured(n.duration),s.lastFrameId=Math.max(this.frameId,s.lastFrameId)),(a=this.webGLProfiler)!=null&&a.isProfilerRunning()&&this.webGLProfiler.popContext(t)}end(t){var e,i,n;this.endSection(`ProfilerFrame ${(i=(e=this.profilerFrameArgs)==null?void 0:e.name)!=null?i:this.frameId.toString()}`,t),(n=this.webGLProfiler)!=null&&n.isProfilerRunning()&&this.webGLProfiler.stop()}tryResolveFrame(t){var e;return this._gpuEventsResolved||!this.webGLProfiler?!0:((e=this.webGLProfiler)!=null&&e.isReady()&&(this._copyGpuResolvedEvents(t),this._gpuEventsResolved=!0),this._gpuEventsResolved)}_copyGpuResolvedEvents(t){const e=[];for(const i of this.webGLProfiler.getResolvedEvents())if(i.action.type===zd.OPEN_FRAME){const n=this.gpuSections.length;e.push(n),this.gpuSections.push({name:i.action.name,timestamp:i.timestamp*1e-6,duration:0,stackIndex:e.length-1})}else if(i.action.type===zd.CLOSE_FRAME){const n=e.pop(),s=this.gpuSections[n];s.duration=i.timestamp*1e-6-s.timestamp;const a=t.get(i.action.name);a&&(a.gpuData.onSampleMeasured(s.duration),a.lastFrameId=Math.max(this.frameId,a.lastFrameId))}for(const i of t.values())i.gpuData.samples.incrementIndexPointer(),i.gpuData.samples.clearCurrentSample()}_exportSectionsAsText(t){var n,s;if(t.length===0)return`No sections to export.
`;let e="";const i=(s=(n=this.profilerFrameArgs)==null?void 0:n.minSectionDuration)!=null?s:1;for(let a=0;a<t.length;a++){const l=t[a];if(l.duration<i)continue;const h=`${"  ".repeat(l.stackIndex)} ${l.name}: ${l.duration.toFixed(2)} ms
`;e+=h}return e}exportLogAsText(){var i,n;let t="";const e=`${this.frameId} ${(n=(i=this.profilerFrameArgs)==null?void 0:i.name)!=null?n:""}`;return console.log(`***** Profiler Frame ${e} ${T.DEV_NEW_RENDER_ARCHITECTURE?"(new renderer)":"(old renderer)"} *****`),t+=`***** Profiler Frame ${e} *****
`,t+=`CPU Sections:
`,t+=this._exportSectionsAsText(this.cpuSections),t+=`GPU Sections:
`,t+=this._exportSectionsAsText(this.gpuSections),t+=`***** End of Profiler Frame ${e} *****
`,t}_logSectionsToConsole(t){var l,c,h,d;if(t.length===0){console.log("No sections to log.");return}let e=0;const i=(c=(l=this.profilerFrameArgs)==null?void 0:l.minSectionDuration)!=null?c:1,n=(d=(h=this.profilerFrameArgs)==null?void 0:h.firstCollapsedStackIndex)!=null?d:1;for(let u=0;u<t.length-1;u++){const f=t[u];if(f.duration<i)continue;for(;e>f.stackIndex;)console.groupEnd(),e--;const p=t[u+1].stackIndex,m=f.stackIndex<p,b=`${f.name}: ${f.duration.toFixed(2)} ms`;if(m){const g=f.stackIndex<n;for(;e<p;)e++,g?console.groupCollapsed(b):console.group(b)}else console.log(b)}const s=t[t.length-1],a=`${s.name}: ${s.duration.toFixed(2)} ms`;for(console.log(a);e>0;)console.groupEnd(),e--}logToConsole(){var e,i;const t=`${this.frameId} ${(i=(e=this.profilerFrameArgs)==null?void 0:e.name)!=null?i:""}`;console.log(`***** Profiler Frame ${t} ${T.DEV_NEW_RENDER_ARCHITECTURE?"(new renderer)":"(old renderer)"} *****`),console.log("CPU Sections:"),this._logSectionsToConsole(this.cpuSections),console.log("GPU Sections:"),this._logSectionsToConsole(this.gpuSections),console.log(`***** End of Profiler Frame ${t} *****`),T.PROFILER_EXPANDED_LOG&&console.log(this.exportLogAsText())}}const on=class on{constructor(){o(this,"sectionsInfo",new Map);o(this,"profilerActive",!0);o(this,"profilerUi");o(this,"_colors",[Hs.blueviolet,Hs.darkorange,Hs.darkgreen,Hs.darkred,Hs.darkslateblue,Hs.darkslategray,Hs.darkturquoise,Hs.darkviolet,Hs.deepskyblue]);o(this,"_defaultAlpha",200);o(this,"currentSectionColorIndex",0);o(this,"glRenderContext");o(this,"profiledFrame");o(this,"pendingFrames",new Gp);o(this,"profileHistory",new Gp);o(this,"namedFrames",new Map);o(this,"maxHistorySize",60);o(this,"currentFrameId",0);ct.registerIfEnabled(this,T.PROFILER),this.profilerUi=new fy}static instance(){return T.PROFILER,on._instance||(on._instance=new on,console.log("Profiling enabled.")),on._instance}static createNewProfileFrame(t){var i;if(!T.PROFILER)return;const e=on.instance().profiledFrame;e&&on.instance().onProfilingEnd((i=e.profilerFrameArgs)==null?void 0:i.name),on.instance().onProfilingBegin(t)}static beginProfiling(t){T.PROFILER&&on.instance().onProfilingBegin(t)}static endProfiling(t){T.PROFILER&&on.instance().onProfilingEnd(t)}static beginSection(t,e=!1,i=!1,n){T.PROFILER&&on.instance().onSectionBegin(t,e,i,n)}static endSection(t,e=!1,i=!1){T.PROFILER&&on.instance().onSectionEnd(t,e,i)}static setWebGLContext(t){T.PROFILER&&(on.instance().glRenderContext=t,!$e.ios&&on.instance().profiledFrame&&(on.instance().profiledFrame.webGLProfiler=new Qp(t)))}logSectionsDataToConsole(){console.log("Profiler sections data:");for(const[t,e]of this.sectionsInfo.entries()){const i=e.cpuData,n=e.gpuData;console.log(`${t}:`),i.measureCounter>0&&console.log(`CPU - Total: ${i.total.toFixed(2)}, Counter: ${i.measureCounter}, `,`Moving Avg: ${i.movingAverage.toFixed(2)} ms, `,`Total Avg: ${i.average.toFixed(2)} ms, Min: ${i.min.toFixed(2)} ms, `,`Max: ${i.max.toFixed(2)} ms`),n.measureCounter>0&&console.log(`GPU - Total: ${n.total.toFixed(2)}, Counter: ${n.measureCounter}, `,`Moving Avg: ${i.movingAverage.toFixed(2)} ms, `,`Total Avg: ${n.average.toFixed(2)} ms, Min: ${n.min.toFixed(2)} ms, `,`Max: ${n.max.toFixed(2)} ms`)}}onProfilingBegin(t){var e,i,n;if(this.profilerActive){this.profiledFrame&&(console.warn("Profiler frame is still active, ending it before starting a new one."),this.onProfilingEnd((e=this.profiledFrame.profilerFrameArgs)==null?void 0:e.name));for(const s of this.sectionsInfo.values())s.cpuData.samples.clearCurrentSample();for(;this.pendingFrames.back()&&this.pendingFrames.back().tryResolveFrame(this.sectionsInfo);){const s=this.pendingFrames.popBack();(i=s.profilerFrameArgs)!=null&&i.name?this.namedFrames.set(s.profilerFrameArgs.name,s):this.profileHistory.pushFront(s),((n=s.profilerFrameArgs)!=null&&n.log||s.frameId===T.PROFILER_ID_TO_LOG)&&(s.logToConsole(),T.PROFILER_EXPANDED_LOG&&this.logSectionsDataToConsole())}for(;this.profileHistory.length>this.maxHistorySize;)this.profileHistory.popBack();this.profiledFrame=new _y(this.currentFrameId++,this.glRenderContext&&!$e.ios?new Qp(this.glRenderContext):void 0,t),this.profiledFrame.start()}}onProfilingEnd(t){var e;if(this.profilerActive){this.profiledFrame,this.profiledFrame.end(this.sectionsInfo),(e=this.profiledFrame.profilerFrameArgs)==null||e.name,this.pendingFrames.pushFront(this.profiledFrame);for(const i of this.sectionsInfo.values())i.cpuData.samples.incrementIndexPointer();this.profiledFrame=void 0}}onSectionBegin(t,e=!1,i=!1,n){if(this.profilerActive){if(e&&console.log(`Begin section: ${t}`),i&&this.checkGlError(),!this.sectionsInfo.has(t)){let s;if(n===void 0){const a=this.currentSectionColorIndex++%this._colors.length;s=this._defaultAlpha<<24|this._colors[a]}else s=n;this.sectionsInfo.set(t,{color:s,gpuData:new Kp,cpuData:new Kp,index:this.sectionsInfo.size,name:t,lastFrameId:this.currentFrameId})}this.profiledFrame.beginSection(t)}}onSectionEnd(t,e=!1,i=!1){this.profilerActive&&(this.profiledFrame.endSection(t,this.sectionsInfo),e&&console.log(`End section: ${t}`),i&&this.checkGlError())}checkGlError(){const t=this.glRenderContext.getError();t!==this.glRenderContext.NO_ERROR&&console.error(`GL error! ${t}`)}onDebugUi(){this.profilerUi.drawUi(this)}};o(on,"_instance");let mt=on;var xs=(r=>(r[r.NONE=0]="NONE",r[r.FXAA=1]="FXAA",r[r.TAA_AND_FXAA=2]="TAA_AND_FXAA",r[r.TAA=3]="TAA",r))(xs||{});class gy{constructor(){o(this,"historyWeightOnStaticCamera",.99);o(this,"historyWeightOnDynamicCamera",.95);o(this,"dynamicTaaHistoryMultiplier",.75);o(this,"jitterSpread",.9);o(this,"samplesCount",16);o(this,"dynamicWeightFramesCount",5)}copyFrom(t){this.historyWeightOnStaticCamera=t.historyWeightOnStaticCamera,this.historyWeightOnDynamicCamera=t.historyWeightOnDynamicCamera,this.dynamicTaaHistoryMultiplier=t.dynamicTaaHistoryMultiplier,this.jitterSpread=t.jitterSpread,this.samplesCount=t.samplesCount}}class vy{constructor(){o(this,"enabled",T.FORCE_MOTION_BLUR);o(this,"intensity",.5)}copyFrom(t){this.enabled=t.enabled,this.intensity=t.intensity}}const ld=class ld{constructor(){o(this,"defaultExposure",0);o(this,"exposure",0);o(this,"defaultGamma",1);o(this,"gamma",1);o(this,"autoExposure",!1);o(this,"autoExposureLumaTarget",ld.defaultAutoExposureLumaTarget);o(this,"colorMap");o(this,"toneMapping");o(this,"colorMapIntensity",1)}copyFrom(t){this.defaultExposure=t.defaultExposure,this.exposure=t.exposure,this.defaultGamma=t.defaultGamma,this.gamma=t.gamma,this.autoExposure=t.autoExposure,this.autoExposureLumaTarget=t.autoExposureLumaTarget,this.colorMap=t.colorMap,this.toneMapping=t.toneMapping,this.colorMapIntensity=t.colorMapIntensity}};o(ld,"defaultAutoExposureLumaTarget",.65);let Hd=ld;class Dn{constructor(t,e){o(this,"temporalAaConfig",new gy);o(this,"motionBlurConfig",new vy);o(this,"filmicConfig",new Hd);o(this,"antialiasingType");this.antialiasingType=t!=null?t:0,this.motionBlurConfig.enabled=e!=null?e:!1}isPostprocessDoneInAdditionalStep(){return this.antialiasingType!==0||this.motionBlurConfig.enabled}copyFrom(t){this.temporalAaConfig.copyFrom(t.temporalAaConfig),this.motionBlurConfig.copyFrom(t.motionBlurConfig),this.filmicConfig.copyFrom(t.filmicConfig),this.antialiasingType=t.antialiasingType}isTaaEnabled(){return[3,2].includes(this.antialiasingType)}}class en{constructor(){o(this,"_viewportSize",new ye(1,1));o(this,"_aspect",1);o(this,"projectionJitterOffset",new ye(0,0));o(this,"near",1);o(this,"far",250);o(this,"isPerspective",!0);o(this,"fov",60);o(this,"left",1);o(this,"right",1);o(this,"top",1);o(this,"bottom",1)}get viewportSize(){return this._viewportSize}set viewportSize(t){t.x>0&&t.y>0,this._viewportSize.copyFrom(t),this._aspect=t.x/t.y}get aspect(){return this._aspect}setOrthoFrustumSize(t){this.left=t*this._aspect/-2,this.right=t*this._aspect/2,this.top=t/2,this.bottom=t/-2}}class zr{constructor(){o(this,"simStateAlpha",0);o(this,"timeDelta",0);o(this,"vrPose");o(this,"baseLayer")}}class $p{constructor(){o(this,"renderTarget");o(this,"position",new L);o(this,"near",1);o(this,"far",100);o(this,"dumpDebugName")}}class Zp{constructor(){o(this,"position",new L);o(this,"near",1);o(this,"far",100);o(this,"visibilityMaterial");o(this,"visibleObjects")}}class Jp{constructor(){o(this,"projectionComp",new en);o(this,"cameraPosition",new L);o(this,"cameraRotation",new bi);o(this,"resultBuffer");o(this,"asyncCallback")}}class Wd extends Jp{constructor(){super(...arguments);o(this,"overrideMaterial");o(this,"entityFilter");o(this,"entityPrepare");o(this,"entityCleanup");o(this,"postprocessComp",new Dn);o(this,"debugSpectorCapture",!1);o(this,"dumpDebugName")}}class em extends Jp{constructor(){super(...arguments);o(this,"renderIncidentLuma",!1);o(this,"debugSpectorCapture",!1)}}const Ha=class Ha{constructor(){o(this,"_renderParamsToPipelines",new Map);Ha._instance=this,this.verifyProperFlagsUsage()}static get(){return Ha._instance}init(t){}setMainScene(t){}close(){for(const t of this._renderParamsToPipelines.values())t.unload();this.onClose(),Ha._instance=void 0}removeEntity(t){}updateEntityVisibility(t,e){}addEntity(t,e){}updateEntityState(t,e,i){}updateEntityStateById(t,e,i){}hasComponent(t,e){return!1}updateMaterialForEntity(t,e){}markTransformUpdated(t){}unuseMeshUsedByObject(t){}onViewportResize(t,e){this._renderParamsToPipelines.get(zr.name).onResize(new ye(t,e))}onSceneLoaded(){}uploadTexture(t){}onLogicUpdateBegin(){}onLogicUpdateEnd(){}enableVrMode(t){}disableVrMode(){}render(t){const e=`render ${t.constructor.name}`;mt.beginSection(e);const i=this._renderParamsToPipelines.get(t.constructor.name);i.updateResources(),i.render(t),mt.endSection(e)}getActiveCamera(){return this._renderParamsToPipelines.get(zr.name).camera}setWireframeMode(t){}reloadShaders(){}refreshReflectionProbesAssignment(){}checkGpuErrors(){}_registerRenderPipeline(t){const e=t.renderParamsName;this._renderParamsToPipelines.has(e),this._renderParamsToPipelines.set(e,t)}};o(Ha,"_instance");let pt=Ha;/*!
 * Copyright (C) 2024-present Shapespark
 */class xn{constructor(t){o(this,"_object");this._object=t||{}}hasChild(t){const e=this._object[t];return xn._isObject(e)}child(t){const e=this._object[t],i=typeof e=="object"&&!Array.isArray(e)&&e!==null?e:void 0;return new xn(i)}keys(){return Object.keys(this._object)}parseBoolean(t,e){if(Object.hasOwn(this._object,t)){const i=this._object[t];if(i===!0||i==="true"||i===1)return!0;if(i===!1||i==="false"||i===0)return!1}return e}parseNumber(t,e){if(Object.hasOwn(this._object,t)){const i=this._object[t];if(typeof i=="number"&&isFinite(i))return i}return e}parseString(t,e){if(Object.hasOwn(this._object,t)){const i=this._object[t];if(typeof i=="string")return i}return e}parseEnum(t,e,i){if(Object.hasOwn(this._object,t)){const n=this._object[t];if(typeof n=="string"&&Object.values(e).includes(n))return n}return i}parseObject(t,e){if(Object.hasOwn(this._object,t)){const i=this._object[t];if(xn._isObject(i))return i}return e}parseStrings(t){if(Object.hasOwn(this._object,t)){const e=this._object[t];if(Array.isArray(e)&&e.every(i=>typeof i=="string"))return e}return[]}parseNumbers(t){if(Object.hasOwn(this._object,t)){const e=this._object[t];if(Array.isArray(e)&&e.every(i=>typeof i=="number"))return e}return[]}parseObjects(t){if(Object.hasOwn(this._object,t)){const e=this._object[t];if(Array.isArray(e)&&e.every(i=>xn._isObject(i)))return e}return[]}static _isObject(t){return typeof t=="object"&&!Array.isArray(t)&&t!==null}}var Ke=(r=>(r[r.RGB8=H.RGB8]="RGB8",r[r.RGBA8=H.RGBA8]="RGBA8",r[r.DEPTH24=H.DEPTH_COMPONENT24]="DEPTH24",r[r.DEPTH24_STENCIL8=H.DEPTH24_STENCIL8]="DEPTH24_STENCIL8",r[r.DEPTH32F=H.DEPTH_COMPONENT32F]="DEPTH32F",r[r.RGBA32F=H.RGBA32F]="RGBA32F",r[r.RGB32F=H.RGB32F]="RGB32F",r[r.RGBA16F=H.RGBA16F]="RGBA16F",r[r.RGB16F=H.RGB16F]="RGB16F",r[r.RGB_DXT1=H.COMPRESSED_RGB_S3TC_DXT1_EXT]="RGB_DXT1",r[r.RGBA_DXT1=H.COMPRESSED_RGBA_S3TC_DXT1_EXT]="RGBA_DXT1",r[r.RGBA_DXT3=H.COMPRESSED_RGBA_S3TC_DXT3_EXT]="RGBA_DXT3",r[r.RGBA_DXT5=H.COMPRESSED_RGBA_S3TC_DXT5_EXT]="RGBA_DXT5",r[r.RGB_PVRTC_4BPPV1=H.COMPRESSED_RGB_PVRTC_4BPPV1_IMG]="RGB_PVRTC_4BPPV1",r[r.RGBA_PVRTC_4BPPV1=H.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG]="RGBA_PVRTC_4BPPV1",r[r.RGB_PVRTC_2BPPV1=H.COMPRESSED_RGB_PVRTC_2BPPV1_IMG]="RGB_PVRTC_2BPPV1",r[r.RGBA_PVRTC_2BPPV1=H.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG]="RGBA_PVRTC_2BPPV1",r[r.RGB_ETC1=H.COMPRESSED_RGB_ETC1_WEBGL]="RGB_ETC1",r[r.RGBA_ASTC_4X4=H.COMPRESSED_RGBA_ASTC_4x4_KHR]="RGBA_ASTC_4X4",r))(Ke||{});function Gr(r){return r>=Ke.RGB_DXT1&&r<=Ke.RGBA_DXT5||r>=Ke.RGB_PVRTC_4BPPV1&&r<=Ke.RGBA_PVRTC_2BPPV1||r==Ke.RGB_ETC1||r==Ke.RGBA_ASTC_4X4}function tm(r){return r==Ke.DEPTH24||r==Ke.DEPTH24_STENCIL8||r==Ke.DEPTH32F}function by(r){return r===Ke.DEPTH24_STENCIL8}function jd(r){return Gr(r),r==Ke.RGB8||r==Ke.RGB32F||r==Ke.RGB16F?H.RGB:r==Ke.RGBA8||r==Ke.RGBA32F||r==Ke.RGBA16F?H.RGBA:tm(r)?H.DEPTH_COMPONENT:r}function Xd(r){return Gr(r),r==Ke.RGB8||r==Ke.RGBA8?H.UNSIGNED_BYTE:r==Ke.RGBA32F||r==Ke.RGB32F?H.FLOAT:r==Ke.RGBA16F||r==Ke.RGB16F?H.HALF_FLOAT:r==Ke.DEPTH24||r==Ke.DEPTH24_STENCIL8?H.UNSIGNED_INT:r==Ke.DEPTH32F?H.FLOAT:H.UNSIGNED_BYTE}var Hr=(r=>(r.RGBM="rgbm",r.YCOCGM="ycocgm",r))(Hr||{}),En=(r=>(r[r.NONE=0]="NONE",r[r.GENERATE_MIPS=1]="GENERATE_MIPS",r[r.PAUSE_LOADED_VIDEO=2]="PAUSE_LOADED_VIDEO",r[r.REPEAT_WRAPPING=4]="REPEAT_WRAPPING",r[r.DEFAULT=3]="DEFAULT",r))(En||{}),fr=(r=>(r[r.NOT_LOADED=0]="NOT_LOADED",r[r.POSTPONED=1]="POSTPONED",r[r.IN_PROGRESS=2]="IN_PROGRESS",r[r.COMPLETED=3]="COMPLETED",r))(fr||{});class Wr{constructor(){o(this,"id");o(this,"name");o(this,"url");o(this,"stdExt");o(this,"rawExt");o(this,"webFormats",new Array);o(this,"alpha");o(this,"encoding");o(this,"passphrase");o(this,"video");o(this,"importGpuCompress");o(this,"importAutoScale")}static parse(t,e=new Wr){const i=new xn(t);return e.id=i.parseString("id"),e.name=i.parseString("name"),e.url=i.parseString("url"),e.stdExt=i.parseString("stdExt"),e.rawExt=i.parseString("rawExt"),e.webFormats=i.parseStrings("webFormats"),e.alpha=i.parseBoolean("alpha"),e.encoding=i.parseEnum("encoding",Hr),!e.encoding&&i.parseBoolean("rgbm")==!0&&(e.encoding="rgbm"),e.passphrase=i.parseString("passphrase"),e.video=i.parseBoolean("video"),e.importGpuCompress=i.parseBoolean("importGpuCompress"),e.importAutoScale=i.parseBoolean("importAutoScale"),e}}class jc extends Wr{constructor(){super(...arguments);o(this,"atlasId");o(this,"atlasScale");o(this,"atlasOffset")}static parse(e){const i=new jc,n=new xn(e);Wr.parse(e,i),i.atlasId=n.parseString("atlasId");const s=n.parseNumbers("atlasScale"),a=n.parseNumbers("atlasOffset");return s.length==2&&a.length==2&&(i.atlasScale=s,i.atlasOffset=a),i}}class Xc{constructor(t,e,i,n,s,a,l){o(this,"id");o(this,"name");o(this,"parentTexture");o(this,"rawExt");o(this,"stdExt");o(this,"uvOffsetScale");o(this,"isCutout",!1);o(this,"importGpuCompress",!0);o(this,"importAutoScale",!0);this.id=t,this.name=e,this.parentTexture=i,this.uvOffsetScale=new We(n,s,a,l)}addLoadedListener(t){this.parentTexture.addLoadedListener(t)}get loaded(){return this.parentTexture&&this.parentTexture.loaded}get hasAlpha(){return this.parentTexture.hasAlpha}serialize(){return{id:this.id,name:this.name,atlasId:this.parentTexture.id,atlasOffset:[this.uvOffsetScale.x,this.uvOffsetScale.y],atlasScale:[this.uvOffsetScale.z,this.uvOffsetScale.w],rawExt:this.rawExt,stdExt:this.stdExt,webFormats:[],alpha:this.hasAlpha,importGpuCompress:this.importGpuCompress,importAutoScale:this.importAutoScale}}}class pr{constructor(t,e=0,i=0){o(this,"data");o(this,"width");o(this,"height");this.data=t,this.width=e,this.height=i}}var im=(r=>(r.DISPOSED="textureDisposed",r.NEEDS_UPDATE="needsUpdate",r))(im||{});const _s=class _s extends ci{constructor(e=void 0,i=H.CLAMP_TO_EDGE,n=H.CLAMP_TO_EDGE,s=H.LINEAR,a=H.LINEAR_MIPMAP_LINEAR,l=Ke.RGBA8,c=_s.DEFAULT_ANISOTROPY){super();o(this,"id");o(this,"name");o(this,"url");o(this,"rawExt");o(this,"stdExt");o(this,"webFormats",[]);o(this,"isCube",!1);o(this,"image");o(this,"width");o(this,"height");o(this,"mipmaps",new Array);o(this,"wrapS");o(this,"wrapT");o(this,"magFilter");o(this,"minFilter");o(this,"anisotropy",_s.DEFAULT_ANISOTROPY);o(this,"isAnimated",!1);o(this,"hasAlpha",!1);o(this,"isCutout",!1);o(this,"encoding");o(this,"ycocgmThreshold",0);o(this,"format");o(this,"generateMipmaps",!0);o(this,"premultiplyAlpha",!1);o(this,"flipY",!0);o(this,"unpackAlignment",4);o(this,"releaseOnLoadedToGpu",!0);o(this,"loadingStatus",0);o(this,"importGpuCompress",!0);o(this,"importAutoScale",!0);o(this,"passphrase");o(this,"_atlasEntries");o(this,"_needsUpdate",!1);o(this,"_loadedListeners",new Array);o(this,"_isDisposed",!1);o(this,"webglTexture",null);o(this,"webglSlot",null);this.image=e,this.width=e?e.width:0,this.height=e?e.height:0,this.wrapS=i,this.wrapT=n,this.magFilter=s,this.minFilter=a,this.anisotropy=c,this.format=l}get loaded(){return this.loadingStatus==3}initFromJson(e,i){Ce(e.id&&e.name),this.hasAlpha=!!e.alpha,this.encoding=e.encoding,bo(i,4)&&(this.wrapS=H.REPEAT,this.wrapT=H.REPEAT),bo(i,1)&&!e.video?(this.minFilter=H.LINEAR_MIPMAP_LINEAR,this.generateMipmaps=!0):(this.minFilter=H.LINEAR,this.generateMipmaps=!1),this.id=e.id,this.name=e.name,this.url=e.url,this.webFormats=e.webFormats,this.passphrase=e.passphrase,this.rawExt=e.rawExt,this.stdExt=e.stdExt,this.importGpuCompress=e.importGpuCompress!==!1,this.importAutoScale=e.importAutoScale!==!1}static newDataTexture(e=void 0,i=0,n=0,s=Ke.RGBA8,a=H.CLAMP_TO_EDGE,l=H.CLAMP_TO_EDGE,c=H.LINEAR,h=H.LINEAR_MIPMAP_LINEAR,d=_s.NO_ANISOTROPY){const u=new pr(e,i,n),f=new _s(u,a,l,c,h,s,d);return f.loadingStatus=3,f}get isPlaying(){return Ce(!1),!1}play(){Ce(!1)}pause(){Ce(!1)}rewind(){Ce(!1)}sleepAnimation(){nt(!1)}wakeAnimation(){nt(!1)}get needsUpdate(){return this._needsUpdate}set needsUpdate(e){this._needsUpdate=e,this._needsUpdate&&this.dispatchEvent({type:_s.eventType.NEEDS_UPDATE})}isAtlas(){return this._atlasEntries!==void 0}enableAtlas(){console.assert(!this.isAtlas()),this._atlasEntries={}}getAtlasEntry(e,i,n,s,a,l){Ce(this._atlasEntries);let c=this._atlasEntries[i];return c||(Ce(this.loadingStatus!=3),c=new Xc(e,i,this,n,s,a,l),this._atlasEntries[i]=c,c)}forEachAtlasEntry(e){Ce(this._atlasEntries);for(const i in this._atlasEntries)Object.prototype.hasOwnProperty.call(this._atlasEntries,i)&&e(this._atlasEntries[i])}clone(e){return e===void 0&&(e=new _s),e.isCube=this.isCube,e.image=this.image,this.mipmaps&&(e.mipmaps=this.mipmaps.slice(0)),e.wrapS=this.wrapS,e.wrapT=this.wrapT,e.magFilter=this.magFilter,e.minFilter=this.minFilter,e.anisotropy=this.anisotropy,e.isCutout=this.isCutout,e.isAnimated=this.isAnimated,e.hasAlpha=this.hasAlpha,e.format=this.format,e.generateMipmaps=this.generateMipmaps,e.premultiplyAlpha=this.premultiplyAlpha,e.flipY=this.flipY,e.unpackAlignment=this.unpackAlignment,e.passphrase=this.passphrase,e}serialize(){return{id:this.id,name:this.name,stdExt:this.stdExt,webFormats:this.webFormats,alpha:this.hasAlpha,importGpuCompress:this.importGpuCompress,importAutoScale:this.importAutoScale,passphrase:this.passphrase,rawExt:this.rawExt,encoding:this.encoding}}dispose(){this._loadedListeners=[],this.dispatchEvent({type:_s.eventType.DISPOSED}),this._isDisposed=!0}isDisposed(){return this._isDisposed}addLoadedListener(e){this.loaded?e():this._loadedListeners.push(e)}notifyLoaded(){this.loadingStatus=3;for(const e of this._loadedListeners)e();this._loadedListeners=[]}};o(_s,"eventType",im),o(_s,"DEFAULT_ANISOTROPY",4),o(_s,"NO_ANISOTROPY",1);let st=_s;const Wa=class Wa{static createSingleColorLightmap(t,e,i=0){const n=Wa._tempVector4;e===Hr.RGBM?cr.rgbmEncode(t,n):e===Hr.YCOCGM?cr.ycocgmEncode(t,n,i):zs();const s=new Uint8Array(4);s[0]=Math.round(n.x*255),s[1]=Math.round(n.y*255),s[2]=Math.round(n.z*255),s[3]=Math.round(n.w*255);const a=st.newDataTexture(s,1,1);return a.magFilter=H.NEAREST,a.minFilter=H.NEAREST,a.anisotropy=st.NO_ANISOTROPY,a.hasAlpha=!0,a.encoding=e,a.ycocgmThreshold=i,a.needsUpdate=!0,a}static createSphereLightmapTexture(t,e,i,n=new _e(1,1,1),s=0,a=new L(.577,.577,.577).normalize()){const l=new Uint8Array(t*e*4),c=new _e(0,0,0),h=new L,d=Wa._tempVector4;for(let f=0;f<e;f++){const m=(1-f/(e-1))*Math.PI;for(let b=0;b<t;b++){const x=b/(t-1)*Math.PI*2;h.x=Math.sin(m)*Math.cos(x),h.y=Math.cos(m),h.z=Math.sin(m)*Math.sin(x);const w=Math.max(0,h.dot(a));c.r=n.r*w,c.g=n.g*w,c.b=n.b*w,i===Hr.RGBM?cr.rgbmEncode(c,d):i===Hr.YCOCGM?cr.ycocgmEncode(c,d,s):zs();const C=(f*t+b)*4;for(const M of[0,1,2,3])l[C+M]=Math.round(d.getComponent(M)*255)}}const u=st.newDataTexture(l,t,e);return u.magFilter=H.LINEAR,u.minFilter=H.LINEAR_MIPMAP_LINEAR,u.anisotropy=st.NO_ANISOTROPY,u.hasAlpha=!0,u.encoding=i,u.ycocgmThreshold=s,u.needsUpdate=!0,u}static createSingleColorCubemap(t){const e=Wa._tempVector4;cr.rgbmEncode(t,e);const i=new Uint8Array(4);i[0]=Math.round(e.x*255),i[1]=Math.round(e.y*255),i[2]=Math.round(e.z*255),i[3]=Math.round(e.w*255);const n=new pr(i,1,1),s=st.newDataTexture(i,1,1);return s.isCube=!0,s.image=[n,n,n,n,n,n],s.magFilter=H.NEAREST,s.minFilter=H.NEAREST,s.anisotropy=st.NO_ANISOTROPY,s.hasAlpha=!0,s.needsUpdate=!0,s}};o(Wa,"_tempVector4",new We);let il=Wa;class jr extends st{constructor(){super();o(this,"_isPlaying",!0);o(this,"_isSleeping",!1);o(this,"_pauseRequested",!1);o(this,"_videoSrc",new Td(""));o(this,"_pausedTime",0);o(this,"_interruptible",!0);o(this,"_resizedListeners",new Array);o(this,"pauseWhenLoaded",!1);o(this,"_handlePaused",()=>{this._pauseRequested?this._pauseRequested=!1:this._isSleeping=!0,!this._isPlaying&&this._interruptible&&(Ce(this.video instanceof HTMLVideoElement),this.video.src="")});o(this,"_handleEnded",()=>{this._isPlaying=!1,this._isSleeping=!1});o(this,"_notifyResized",()=>{Ce(this.video instanceof HTMLVideoElement),this.width=this.video.videoWidth,this.height=this.video.videoHeight;for(let e=0;e<this._resizedListeners.length;e+=1)this._resizedListeners[e]()});this.generateMipmaps=!1,this.isAnimated=!0,this.releaseOnLoadedToGpu=!1}initFromJson(e,i){super.initFromJson(e,i),this.pauseWhenLoaded=bo(i,En.PAUSE_LOADED_VIDEO)}_srcAtPausedPosition(){return this._videoSrc.addHash("t",this._pausedTime.toString()),this._videoSrc.getFullUrl()}_pauseVideo(){Ce(this.video instanceof HTMLVideoElement),this._pausedTime=this.video.currentTime,this.video.pause()}rewind(){Ce(this.video instanceof HTMLVideoElement),this._pausedTime=0,this.video.currentTime=0}get video(){return Ce(this.image instanceof HTMLVideoElement||this.image==null),this.image}set video(e){Ce(this.image===void 0,"Video already attached to texture."),Ce(e instanceof HTMLVideoElement),this.image=e,this._videoSrc=new Td(e.src);const i=this._videoSrc.getHashValue("t");this._pausedTime=i?Number.parseFloat(i):0,(isNaN(this._pausedTime)||!isFinite(this._pausedTime))&&(this._pausedTime=0),this._isPlaying=!e.paused&&!e.ended,e.addEventListener("pause",this._handlePaused),e.addEventListener("ended",this._handleEnded),e.addEventListener("resize",this._notifyResized),this._isSleeping&&this._isPlaying&&this._pauseVideo()}get muted(){return Ce(this.video instanceof HTMLVideoElement),this.video.muted}set muted(e){Ce(this.video instanceof HTMLVideoElement),this.video.muted=e}get loop(){return Ce(this.video instanceof HTMLVideoElement),this.video.loop}set loop(e){Ce(this.video instanceof HTMLVideoElement),this.video.loop=e}get isPlaying(){return!this._isSleeping&&this._isPlaying}play(){if(this._isPlaying)return;if(this._isSleeping){this._isPlaying=!0;return}Ce(this.video instanceof HTMLVideoElement);const e=this.video;this._interruptible&&(e.src=this._srcAtPausedPosition());const i=e.play();this._isPlaying=!0,i.catch(n=>{console.log("Can't play video texture: "+n),this._isPlaying=!1})}pause(){!this._isPlaying||!this.video||(this._isPlaying=!1,this._isSleeping||(this._pauseRequested=!0,this._pauseVideo()))}sleepAnimation(){this._isSleeping||(this._isPlaying&&this.video&&this._pauseVideo(),this._isSleeping=!0)}wakeAnimation(){this._isSleeping&&(this._isPlaying&&this.video&&(this._interruptible&&(this.video.src=this._srcAtPausedPosition()),this.video.play().catch(i=>{})),this._isSleeping=!1)}dispose(){st.prototype.dispose.call(this),this._isPlaying&&this.pause(),Ce(this.video instanceof HTMLVideoElement);const e=this.video;this.image=void 0,this._videoSrc=new Td(""),this._isPlaying=!1,e.src="",e.removeEventListener("pause",this._handlePaused),e.removeEventListener("ended",this._handleEnded),e.removeEventListener("resize",this._notifyResized),this._resizedListeners.length=0}addResizedListener(e){this._resizedListeners.push(e)}serialize(){const e=st.prototype.serialize.call(this);return e.video=!0,e}get needsUpdate(){return this._needsUpdate||!!(this.isPlaying&&this.video&&this.video.seeking!==!0&&this.video.readyState>=this.video.HAVE_CURRENT_DATA)}set needsUpdate(e){super.needsUpdate=e}}var qc=(r=>(r[r.LIVE=1]="LIVE",r[r.BAKED=0]="BAKED",r[r.BASIC=-1]="BASIC",r))(qc||{}),nm=(r=>(r.UPDATED="liveLightmapUpdated",r))(nm||{});const hc=class hc extends ci{constructor(){super();o(this,"_texture");o(this,"_mode",-1)}get mode(){return this._mode}set mode(e){this._mode!==e&&(this._mode=e,this.dispatchEvent({type:hc.eventType.UPDATED}))}get texture(){return this._texture}set(e){if(e===void 0){this._texture=void 0,this.mode=0;return}const i=new Float32Array(e,0,e.byteLength/4),n=i[1],s=i[2],a=i.subarray(3);n*s,a.length/3;const l=new pr(a,n,s);this._texture?(this._texture.image=l,this._texture.needsUpdate=!0):(this._texture=new st(l,H.CLAMP_TO_EDGE,H.CLAMP_TO_EDGE,H.NEAREST,H.NEAREST,Ke.RGB32F,0),this._texture.loadingStatus=fr.COMPLETED,this._texture.generateMipmaps=!1,this._texture.flipY=!1,T.DEV_NEW_RENDER_ARCHITECTURE&&pt.get().uploadTexture(this._texture)),this.mode=1,this.dispatchEvent({type:hc.eventType.UPDATED})}};o(hc,"eventType",nm);let Yc=hc;var oe=(r=>(r[r.GLOBAL=0]="GLOBAL",r[r.CAMERA=1]="CAMERA",r[r.MATERIAL=2]="MATERIAL",r[r.LIGHT=3]="LIGHT",r[r.OBJECT=4]="OBJECT",r))(oe||{});class yy{constructor(t,e){o(this,"type");o(this,"blockOffset");this.type=t,this.blockOffset=e}}class sm{constructor(t,e,i){o(this,"name");o(this,"binding");o(this,"blockIndex");o(this,"uniforms",new Map);o(this,"size",-1);this.name=t,this.binding=e,this.blockIndex=i}getUniformOffsetInBytes(t){return this.uniforms.get(t).blockOffset}hasUniform(t){return this.uniforms.has(t)}}const mr={0:0,1:1,2:2,3:3,4:4},Vi={0:"GlobalBuffer",1:"CameraBuffer",2:"MaterialBuffer",3:"LightBuffer",4:"ObjectBuffer"},xy={GlobalBuffer:0,CameraBuffer:1,MaterialBuffer:2,LightBuffer:3,ObjectBuffer:4};class js{constructor(t){o(this,"value",0);this.value=t}}class rm{constructor(t){o(this,"value",0);this.value=t}}class Dt{constructor(t,e,i,n=!1){o(this,"array");o(this,"itemSize");o(this,"needsUpdate",!1);o(this,"length");o(this,"releaseOnLoadedToGpu",!1);o(this,"divisor");o(this,"buffer");o(this,"glType");o(this,"glTypeSize",0);this.array=t,this.itemSize=e,this.length=t.length,this.divisor=i||0,this.releaseOnLoadedToGpu=n,this.buffer=null,this.glType=null}set(t,e=0){return this.array.set(t,e),this}}class qd{constructor(){o(this,"uv0");o(this,"uv1");o(this,"uv1Mod");o(this,"t0");o(this,"t1");o(this,"t2");o(this,"sphericalNormal")}}class Ey{constructor(){o(this,"index");o(this,"position");o(this,"uv0");o(this,"uv1");o(this,"uv1Mod");o(this,"t0");o(this,"t1");o(this,"t2");o(this,"normal");o(this,"sphericalNormal")}}const dt=class dt extends ci{constructor(){super();o(this,"id");o(this,"name","");o(this,"parent");o(this,"children",new Array);o(this,"up",dt.DEFAULT_UP);o(this,"position",new L);o(this,"rotation",new Fi(0,0,0,ys.XYZ));o(this,"scale",new L(1,1,1));o(this,"matrix",new Ue);o(this,"_matrixWorld",new Ue);o(this,"matrixAutoUpdate",!0);o(this,"matrixWorldNeedsUpdate",!1);o(this,"_visible",!0);o(this,"castShadow",!1);o(this,"receiveShadow",!1);o(this,"frustumCulled",!0);o(this,"userData",{});o(this,"entityId",-1);this.id=dt._idCount++}get matrixWorld(){return this._matrixWorld}set matrixWorld(e){this._matrixWorld=e}get visible(){return this._visible}set visible(e){this._visible!==e&&(this._visible=e,T.DEV_NEW_RENDER_ARCHITECTURE&&this.entityId!==-1&&pt.get().updateEntityVisibility(this.entityId,e))}applyMatrix(e){this.matrix.multiplyMatrices(e,this.matrix),this.matrix.decompose(this.position,dt._tempQuatA,this.scale),this.rotation.setFromQuaternion(dt._tempQuatA)}setRotationFromAxisAngle(e,i){dt._tempQuatA.setFromAxisAngle(e,i),this.rotation.setFromQuaternion(dt._tempQuatA)}setRotationFromEuler(e){this.rotation.copyFrom(e)}setRotationFromMatrix(e){this.rotation.setFromRotationMatrix(e)}setRotationFromQuaternion(e){this.rotation.setFromQuaternion(e)}rotateOnAxis(e,i){return dt._tempQuatA.setFromAxisAngle(e,i),this.rotation.toQuaternion(dt._tempQuatB),dt._tempQuatB.multiply(dt._tempQuatA),this.rotation.setFromQuaternion(dt._tempQuatB),this}rotateX(e){return this.rotateOnAxis(dt._tempVec3A.set(1,0,0),e)}rotateY(e){return this.rotateOnAxis(dt._tempVec3A.set(0,1,0),e)}rotateZ(e){return this.rotateOnAxis(dt._tempVec3A.set(0,0,1),e)}translateOnAxis(e,i){return this.rotation.toQuaternion(dt._tempQuatA),dt._tempVec3A.copyFrom(e),dt._tempQuatA.applyToVector3(dt._tempVec3A),this.position.add(dt._tempVec3A.multiplyScalar(i)),this}translateX(e){return this.translateOnAxis(dt._tempVec3B.set(1,0,0),e)}translateY(e){return this.translateOnAxis(dt._tempVec3B.set(0,1,0),e)}translateZ(e){return this.translateOnAxis(dt._tempVec3B.set(0,0,1),e)}localToWorld(e){return this.matrixWorld.affineTransformPoint3(e)}worldToLocal(e){return dt._tempMatrix4.getInverse(this.matrixWorld),dt._tempMatrix4.affineTransformPoint3(e)}lookAt(e){const i=dt._tempMatrix4;i.lookAt(e,this.position,this.up),this.rotation.setFromRotationMatrix(i)}shouldAddToNewRenderer(){return this.parent?this.parent.shouldAddToNewRenderer():!1}add(e){return nt(e!==this),e.parent!==void 0&&e.parent.remove(e),e.parent=this,e.dispatchEvent({type:"added"}),this.children.push(e),e.entityId,dt.onAdd(e),T.DEV_NEW_RENDER_ARCHITECTURE&&this.shouldAddToNewRenderer()&&pt.get().addEntity(e,this),this}remove(e){const i=this.children.indexOf(e);i!==-1&&(T.DEV_NEW_RENDER_ARCHITECTURE&&(e.entityId!==-1&&(pt.get().removeEntity(e.entityId),e.entityId=-1),pt.get().unuseMeshUsedByObject(e)),e.parent=void 0,e.dispatchEvent({type:"removed"}),this.children.splice(i,1))}getObjectById(e){return this.getObjectByProperty("id",e)}getObjectByName(e){return this.getObjectByProperty("name",e)}getObjectByProperty(e,i){if(this[e]===i)return this;for(const n of this.children){const s=n.getObjectByProperty(e,i);if(s!==void 0)return s}}getWorldPosition(e=new L){return this.updateMatrixWorld(!0),this.matrixWorld.getTranslation(e)}getWorldQuaternion(e=new bi){return this.updateMatrixWorld(!0),this.matrixWorld.decompose(dt._tempVec3A,e,dt._tempVec3B),e}getWorldRotation(e=new Fi(0,0,0,ys.XYZ)){return this.getWorldQuaternion(dt._tempQuatA),e.setFromQuaternion(dt._tempQuatA,this.rotation.order)}getWorldScale(e=new L){return this.updateMatrixWorld(!0),this.matrixWorld.decompose(dt._tempVec3A,dt._tempQuatA,e),e}getWorldDirection(e=new L){return this.getWorldQuaternion(dt._tempQuatA),e.set(0,0,1),dt._tempQuatA.applyToVector3(e)}traverse(e){e(this);for(const i of this.children)i.traverse(e)}traverseVisible(e){if(this.visible){e(this);for(const i of this.children)i.traverseVisible(e)}}traverseAncestors(e){this.parent&&(e(this.parent),this.parent.traverseAncestors(e))}updateMatrix(){this.rotation.toQuaternion(dt._tempQuatA),this.matrix.compose(this.position,dt._tempQuatA,this.scale),this.matrixWorldNeedsUpdate=!0}updateMatrixWorld(e=!1){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||e)&&(this.parent===void 0?this.matrixWorld.copyFrom(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1,e=!0,T.DEV_NEW_RENDER_ARCHITECTURE&&this.entityId!==-1&&pt.get().markTransformUpdated(this.entityId));for(const i of this.children)i.updateMatrixWorld(e)}clone(e=new dt,i=!0){if(e.name=this.name,e.up.copyFrom(this.up),e.position.copyFrom(this.position),e.scale.copyFrom(this.scale),e.matrix.copyFrom(this.matrix),e.matrixWorld.copyFrom(this.matrixWorld),e.matrixAutoUpdate=this.matrixAutoUpdate,e.matrixWorldNeedsUpdate=this.matrixWorldNeedsUpdate,e.visible=this.visible,e.castShadow=this.castShadow,e.receiveShadow=this.receiveShadow,e.frustumCulled=this.frustumCulled,e.userData=JSON.parse(JSON.stringify(this.userData)),i)for(const n of this.children)e.add(n.clone());return e}};o(dt,"DEFAULT_UP",new L(0,1,0)),o(dt,"_idCount",0),o(dt,"onAdd",e=>{}),o(dt,"_tempQuatA",new bi),o(dt,"_tempQuatB",new bi),o(dt,"_tempVec3A",new L),o(dt,"_tempVec3B",new L),o(dt,"_tempMatrix4",new Ue);let yt=dt;const Ns=class Ns extends yt{constructor(){super();o(this,"matrixWorldInverse",new Ue);o(this,"projectionMatrix",new Ue)}getWorldDirection(){const e=new L(0,0,-1);return this.getWorldQuaternion(Ns._tempQuat),Ns._tempQuat.applyToVector3(e)}lookAt(e){Ns._tempMatrix4A.lookAt(this.position,e,this.up),this.setRotationFromMatrix(Ns._tempMatrix4A)}clone(e=new Ns){return yt.prototype.clone.call(this,e),e.matrixWorldInverse.copyFrom(this.matrixWorldInverse),e.projectionMatrix.copyFrom(this.projectionMatrix),e}projectVector(e){const i=Ns._tempMatrix4A;return i.multiplyMatrices(this.projectionMatrix,i.getInverse(this.matrixWorld)),i.transformPoint3(e)}unprojectVector(e){const i=Ns._tempMatrix4A;return i.multiplyMatrices(this.matrixWorld,i.getInverse(this.projectionMatrix)),i.transformPoint3(e)}};o(Ns,"_tempQuat",new bi),o(Ns,"_tempMatrix4A",new Ue);let Po=Ns;function om(r){const t=new L;r[0].up.set(0,-1,0),t.set(1,0,0),r[0].lookAt(t),r[1].up.set(0,-1,0),t.set(-1,0,0),r[1].lookAt(t),r[2].up.set(0,0,1),t.set(0,1,0),r[2].lookAt(t),r[3].up.set(0,0,-1),t.set(0,-1,0),r[3].lookAt(t),r[4].up.set(0,-1,0),t.set(0,0,1),r[4].lookAt(t),r[5].up.set(0,-1,0),t.set(0,0,-1),r[5].lookAt(t)}class Yd extends yt{constructor(e,i){super();o(this,"sideCameras",[]);for(let n=0;n<6;n++){const s=new Xs(90,1,e,i);this.add(s),this.sideCameras.push(s)}om(this.sideCameras)}}class Ay extends yt{constructor(e,i){super();o(this,"sideCameras",[]);for(let n=0;n<6;n++){const s=new An(-1,1,1,-1,e,i);this.add(s),this.sideCameras.push(s)}om(this.sideCameras)}}class An extends Po{constructor(e,i,n,s,a=.1,l=2e3){super();o(this,"zoom",1);o(this,"left");o(this,"right");o(this,"top");o(this,"bottom");o(this,"near");o(this,"far");this.left=e,this.right=i,this.top=n,this.bottom=s,this.near=a,this.far=l,this.updateProjectionMatrix()}static createNDC(e=0,i=1){return new An(-1,1,1,-1,e,i)}updateProjectionMatrix(){const e=(this.right-this.left)/(2*this.zoom),i=(this.top-this.bottom)/(2*this.zoom),n=(this.right+this.left)/2,s=(this.top+this.bottom)/2;this.projectionMatrix.makeOrthographic(n-e,n+e,s+i,s-i,this.near,this.far)}clone(e=new An(0,0,0,0)){return Po.prototype.clone.call(this,e),e.zoom=this.zoom,e.left=this.left,e.right=this.right,e.top=this.top,e.bottom=this.bottom,e.near=this.near,e.far=this.far,e.projectionMatrix.copyFrom(this.projectionMatrix),e}}class Xs extends Po{constructor(e=50,i=1,n=.1,s=2e3){super();o(this,"zoom",1);o(this,"fov");o(this,"aspectRatio");o(this,"near");o(this,"far");this.fov=e,this.aspectRatio=i,this.near=n,this.far=s,this.updateProjectionMatrix()}setLens(e,i=24){this.fov=2*Wn(Math.atan(i/(e*2))),this.updateProjectionMatrix()}updateProjectionMatrix(){const e=Wn(2*Math.atan(Math.tan(Ai(this.fov)*.5)/this.zoom));this.projectionMatrix.makePerspective(e,this.aspectRatio,this.near,this.far)}clone(e=new Xs){return Po.prototype.clone.call(this,e),e.zoom=this.zoom,e.fov=this.fov,e.aspectRatio=this.aspectRatio,e.near=this.near,e.far=this.far,e.projectionMatrix.copyFrom(this.projectionMatrix),e}}const nl={HABLE:1,UNREAL:2,UCHIMURA:3},am=nl.UNREAL;var lm=(r=>(r.UPDATED="cameraUpdated",r.PHYSICAL_DIMENSIONS_CHANGED="physicalDimensionsChanged",r.EXPOSURE_UPDATED="exposureUpdated",r.GAMMA_UPDATED="gammaUpdated",r.COLOR_MAP_UPDATED="colorMapUpdated",r.TONE_MAPPING_UPDATED="toneMappingUpdated",r.MOTION_BLUR_UPDATED="motionBlurUpdated",r.PROJECTION_TYPE_UPDATED="projectionTypeUpdated",r.POSITION_CHANGED="positionChanged",r.ROTATION_CHANGED="rotationChanged",r))(lm||{});const Zi=class Zi extends Po{constructor(){super();o(this,"perspectiveCamera");o(this,"orthographicCamera");o(this,"current");o(this,"_physicalWidth",1);o(this,"_physicalHeight",1);o(this,"_defaultFov",T.CAMERA_DEFAULT_FOV);o(this,"_orthoFrustumSize",T.CAMERA_ORTHO_FRUSTUM_SIZE);o(this,"_postprocessComp",new Dn(xs.TAA));o(this,"_moveMaxSpeed",T.CAMERA_DEFAULT_MOVE_MAX_SPEED);o(this,"_autoPath",!1);o(this,"_autoClimb",!1);o(this,"_fixedHeight",T.CAMERA_FIXED_HEIGHT);o(this,"_updated");this.perspectiveCamera=new Xs(this._defaultFov,this.aspectRatio,T.CAMERA_WALK_NEAR,T.CAMERA_MIN_FAR),this.orthographicCamera=An.createNDC(T.CAMERA_WALK_NEAR,T.CAMERA_MIN_FAR),this.adjustProjectionProperties(),this.add(this.perspectiveCamera),this.add(this.orthographicCamera),this.current=this.perspectiveCamera,this._updated=()=>this.dispatchEvent({type:Zi.eventType.UPDATED})}onNewPosition(e){this.dispatchEvent({type:Zi.eventType.POSITION_CHANGED,newPosition:e})}onNewRotation(e){this.dispatchEvent({type:Zi.eventType.ROTATION_CHANGED,newRotation:e})}adjustProjectionProperties(){this.perspectiveCamera.aspectRatio=this.aspectRatio,this.orthographicCamera.left=this._orthoFrustumSize*this.aspectRatio/-2,this.orthographicCamera.right=this._orthoFrustumSize*this.aspectRatio/2,this.orthographicCamera.top=this._orthoFrustumSize/2,this.orthographicCamera.bottom=this._orthoFrustumSize/-2}updateProjectionMatrix(){this.perspectiveCamera.updateProjectionMatrix(),this.orthographicCamera.updateProjectionMatrix(),this.projectionMatrix=this.current.projectionMatrix,this._updated()}isPerspective(){return this.current===this.perspectiveCamera}isOrthographic(){return this.current===this.orthographicCamera}setPerspective(){this.current=this.perspectiveCamera,this.updateProjectionMatrix(),this.dispatchEvent({type:Zi.eventType.PROJECTION_TYPE_UPDATED})}setOrthographic(){this.current=this.orthographicCamera,this.updateProjectionMatrix(),this.dispatchEvent({type:Zi.eventType.PROJECTION_TYPE_UPDATED})}createProjectionMatrix(e,i){const n=new Ue;return e?n.makeOrthographic(i*this.aspectRatio/-2,i*this.aspectRatio/2,i/2,i/-2,this.near,this.far):n.makePerspective(this.fov,this.aspectRatio,this.near,this.far),n}getCurrent(){return this.current}get aspectRatio(){return this._physicalWidth/this._physicalHeight}get physicalWidth(){return this._physicalWidth}get physicalHeight(){return this._physicalHeight}set physicalWidth(e){this._physicalWidth=e,this.adjustProjectionProperties(),this.dispatchEvent({type:Zi.eventType.PHYSICAL_DIMENSIONS_CHANGED}),this._updated()}set physicalHeight(e){this._physicalHeight=e,this.adjustProjectionProperties(),this.dispatchEvent({type:Zi.eventType.PHYSICAL_DIMENSIONS_CHANGED}),this._updated()}get orthoFrustumSize(){return this._orthoFrustumSize}set orthoFrustumSize(e){this._orthoFrustumSize=e,this.adjustProjectionProperties(),this._updated()}get near(){return this.current.near}set near(e){this.perspectiveCamera.near=e,this.orthographicCamera.near=e,this.updateProjectionMatrix(),this._updated()}get far(){return this.current.far}set far(e){this.perspectiveCamera.far=e,this.orthographicCamera.far=e,this.updateProjectionMatrix(),this._updated()}get fov(){return this.perspectiveCamera.fov}set fov(e){this.perspectiveCamera.fov=e,this._updated()}get left(){return Ce(this.current instanceof An),this.current.left}get right(){return Ce(this.current instanceof An),this.current.right}get top(){return Ce(this.current instanceof An),this.current.top}get bottom(){return Ce(this.current instanceof An),this.current.bottom}get defaultFov(){return this._defaultFov}set defaultFov(e){this._defaultFov=e,this.perspectiveCamera.fov=e,this._updated()}get colorMap(){var e;return(e=this._postprocessComp.filmicConfig.colorMap)!=null?e:null}set colorMap(e){this._postprocessComp.filmicConfig.colorMap=e!=null?e:void 0,e&&!e.loaded&&e.addLoadedListener(()=>this.dispatchEvent({type:Zi.eventType.COLOR_MAP_UPDATED})),this.dispatchEvent({type:Zi.eventType.COLOR_MAP_UPDATED})}get colorMapIntensity(){return this._postprocessComp.filmicConfig.colorMapIntensity}set colorMapIntensity(e){this._postprocessComp.filmicConfig.colorMapIntensity=e,this.dispatchEvent({type:Zi.eventType.COLOR_MAP_UPDATED})}get toneMapping(){return this._postprocessComp.filmicConfig.toneMapping}set toneMapping(e){const i=this._postprocessComp.filmicConfig;i.toneMapping!==e&&(i.toneMapping=e,this.dispatchEvent({type:Zi.eventType.TONE_MAPPING_UPDATED}))}get toneMappingModes(){return nl}get antialiasingType(){return this._postprocessComp.antialiasingType}set antialiasingType(e){this._postprocessComp.antialiasingType!==e&&(this._postprocessComp.antialiasingType=e,this._updated())}get motionBlurEnabled(){return this._postprocessComp.motionBlurConfig.enabled}set motionBlurEnabled(e){const i=this._postprocessComp.motionBlurConfig;i.enabled!==e&&(i.enabled=e,this.dispatchEvent({type:Zi.eventType.MOTION_BLUR_UPDATED}))}get motionBlurIntensity(){return this._postprocessComp.motionBlurConfig.intensity}set motionBlurIntensity(e){const i=this._postprocessComp.motionBlurConfig;i.intensity!==e&&(i.intensity=e,this.dispatchEvent({type:Zi.eventType.MOTION_BLUR_UPDATED}))}colorMapReady(){const e=this._postprocessComp.filmicConfig.colorMap;return!!(e&&e.loaded)}get defaultExposure(){return this._postprocessComp.filmicConfig.defaultExposure}set defaultExposure(e){const i=this._postprocessComp.filmicConfig;i.defaultExposure=e,this._updated()}get exposure(){return this._postprocessComp.filmicConfig.exposure}set exposure(e){const i=this._postprocessComp.filmicConfig;i.exposure!==e&&(i.exposure=e,this.dispatchEvent({type:Zi.eventType.EXPOSURE_UPDATED}))}get defaultGamma(){return this._postprocessComp.filmicConfig.defaultGamma}set defaultGamma(e){const i=this._postprocessComp.filmicConfig;i.defaultGamma=e,this._updated()}get gamma(){return this._postprocessComp.filmicConfig.gamma}set gamma(e){const i=this._postprocessComp.filmicConfig;i.gamma!==e&&(i.gamma=e,this.dispatchEvent({type:Zi.eventType.GAMMA_UPDATED}))}get autoExposure(){return this._postprocessComp.filmicConfig.autoExposure}set autoExposure(e){const i=this._postprocessComp.filmicConfig;i.autoExposure!==e&&(i.autoExposure=e,this.exposure=i.defaultExposure,this._updated())}get moveMaxSpeed(){return this._moveMaxSpeed}set moveMaxSpeed(e){this._moveMaxSpeed=e,this._updated()}get autoPath(){return this._autoPath}set autoPath(e){this._autoPath=e,this._updated()}get autoClimb(){return this._autoClimb}set autoClimb(e){this._autoClimb=e,this._updated()}get autoExposureLumaTarget(){return this._postprocessComp.filmicConfig.autoExposureLumaTarget}set autoExposureLumaTarget(e){const i=this._postprocessComp.filmicConfig;i.autoExposureLumaTarget=e,this._updated()}get fixedHeight(){return this._fixedHeight}set fixedHeight(e){this._fixedHeight=e,this._updated()}get postprocessComp(){return this._postprocessComp}serialize(){return{fov:this.defaultFov,autoExposure:this.autoExposure,autoExposureLumaTarget:this.autoExposureLumaTarget,exposure:this.defaultExposure,gamma:this.defaultGamma,lutTexture:this.colorMap?this.colorMap.serialize():null,lutIntensity:this.colorMapIntensity,toneMapping:this.toneMapping,autoPath:this.autoPath,autoClimb:this.autoClimb,moveMaxSpeed:this.moveMaxSpeed,fixedHeight:this._fixedHeight,motionBlurEnabled:this.motionBlurEnabled||null,motionBlurIntensity:this.motionBlurEnabled?this.motionBlurIntensity:null}}setFromJson(e){if(!e)return;const i=new xn(e);this.defaultFov=i.parseNumber("fov",this.defaultFov),this.defaultExposure=i.parseNumber("exposure",this.defaultExposure),this.defaultGamma=i.parseNumber("gamma",this.defaultGamma),this.colorMapIntensity=i.parseNumber("lutIntensity",this.colorMapIntensity);const n=i.parseNumber("toneMapping");n!==void 0&&(this.toneMapping=n),this.autoPath=i.parseBoolean("autoPath",this.autoPath),this.autoClimb=i.parseBoolean("autoClimb",this.autoClimb),this.autoExposure=T.AUTO_EXPOSURE||i.parseBoolean("autoExposure",this.autoExposure);const s=i.parseNumber("fixedHeight");s!==void 0&&(this.fixedHeight=s),this.motionBlurEnabled=i.parseBoolean("motionBlurEnabled",this.motionBlurEnabled),this.motionBlurIntensity=i.parseNumber("motionBlurIntensity",this.motionBlurIntensity),this.autoExposureLumaTarget=i.parseNumber("autoExposureLumaTarget",this.autoExposureLumaTarget),this.moveMaxSpeed=i.parseNumber("moveMaxSpeed",this.moveMaxSpeed),this.updateProjectionMatrix()}};o(Zi,"eventType",lm);let At=Zi;var cm=(r=>(r.UPDATED="fogUpdated",r))(cm||{});const cd=class cd extends ci{constructor(e={}){var i,n,s,a,l,c,h;super();o(this,"_distanceEnabled");o(this,"_distanceDensity");o(this,"_distanceStart");o(this,"_heightEnabled");o(this,"_heightDensity");o(this,"_heightStart");o(this,"_color");o(this,"_updated");this._distanceEnabled=(i=e.distanceEnabled)!=null?i:!1,this._distanceDensity=(n=e.distanceDensity)!=null?n:.01,this._distanceStart=(s=e.distanceStart)!=null?s:0,this._heightEnabled=(a=e.heightEnabled)!=null?a:!1,this._heightDensity=(l=e.heightDensity)!=null?l:.01,this._heightStart=(c=e.heightStart)!=null?c:0,this._color=new _e().fromArray((h=e.color)!=null?h:[.5,.5,.5]),this._updated=()=>this.dispatchEvent({type:cd.eventType.UPDATED,target:this})}get distanceEnabled(){return this._distanceEnabled}set distanceEnabled(e){this._distanceEnabled=e,this._updated()}get distanceDensity(){return this._distanceDensity}set distanceDensity(e){this._distanceDensity=e,this._updated()}get distanceStart(){return this._distanceStart}set distanceStart(e){this._distanceStart=e,this._updated()}get heightEnabled(){return this._heightEnabled}set heightEnabled(e){this._heightEnabled=e,this._updated()}get heightDensity(){return this._heightDensity}set heightDensity(e){this._heightDensity=e,this._updated()}get heightStart(){return this._heightStart}set heightStart(e){this._heightStart=e,this._updated()}get color(){return this._color}get colorArray(){return this._color.toArray()}set colorArray(e){this._color.fromArray(e),this._updated()}enabled(){return this._distanceEnabled||this.heightEnabled}serialize(){return{distanceEnabled:this._distanceEnabled,distanceDensity:this._distanceDensity,distanceStart:this._distanceStart,heightEnabled:this._heightEnabled,heightDensity:this._heightDensity,heightStart:this._heightStart,color:this._color.toArray()}}};o(cd,"eventType",cm);let Qc=cd;var hm=(r=>(r.UPDATED="sharedMaterialStateUpdated",r))(hm||{});class sl extends ci{constructor(e,i){super();o(this,"weakReflectionShadow");o(this,"_emissiveMaterialsLightEnabled",!0);o(this,"_liveLightmap");o(this,"_fog");o(this,"_camera");o(this,"_hdrOutput",!1);o(this,"_brdfLUT");o(this,"_lightmapEncoding");o(this,"_defaultLightmaps",new Array);o(this,"_defaultCubemap");o(this,"_updated",()=>this.dispatchEvent({type:"sharedMaterialStateUpdated"}));this.weakReflectionShadow=T.WEAK_REFLECTION_SHADOW,this._camera=e,this._liveLightmap=i,this._liveLightmap.addEventListener(Yc.eventType.UPDATED,this._updated),e.addEventListener(At.eventType.TONE_MAPPING_UPDATED,this._updated),e.addEventListener(At.eventType.COLOR_MAP_UPDATED,this._updated),e.addEventListener(At.eventType.EXPOSURE_UPDATED,this._updated),e.addEventListener(At.eventType.GAMMA_UPDATED,this._updated)}get physicalWidth(){return this._camera.physicalWidth}get physicalHeight(){return this._camera.physicalHeight}get liveLightmap(){return this._liveLightmap}get fog(){return this._fog}set fog(e){this._fog=e,this._fog.addEventListener(Qc.eventType.UPDATED,this._updated),this._updated()}get hdrOutput(){return this._hdrOutput}set hdrOutput(e){this._hdrOutput!==e&&(this._hdrOutput=e,this._updated())}get toneMapping(){var e;return(e=this._camera.toneMapping)!=null?e:null}get colorMap(){return this._camera.colorMapReady()?this._camera.colorMap:null}get colorMapIntensity(){return this._camera.colorMapIntensity}get cameraExposure(){return this._camera.exposure}get cameraGamma(){return this._camera.gamma}set brdfLUT(e){this._brdfLUT=e,this._updated()}get brdfLUT(){return this._brdfLUT}set lightmapEncoding(e){this._lightmapEncoding=e,this._updated()}get lightmapEncoding(){return this._lightmapEncoding}get lightmapEnabled(){return!!this._lightmapEncoding}get emissiveMaterialsLightEnabled(){return this._emissiveMaterialsLightEnabled}set emissiveMaterialsLightEnabled(e){this._emissiveMaterialsLightEnabled=e,this._updated()}getDefaultLightmap(e){let i=this._defaultLightmaps.find(n=>n.ycocgmThreshold===e);return i||(this._lightmapEncoding,i=il.createSingleColorLightmap(new _e(.8,.8,.8),this._lightmapEncoding,e),this._defaultLightmaps.push(i)),i}getDefaultCubemap(){return this._defaultCubemap||(this._defaultCubemap=il.createSingleColorCubemap(new _e(0,0,0))),this._defaultCubemap}clearDefaultLightmaps(){this._defaultLightmaps.length=0}}o(sl,"eventType",hm);/*!
 * Copyright (C) 2024-present Shapespark
 */var rl=(r=>(r[r.OPAQUE=0]="OPAQUE",r[r.MASK=1]="MASK",r[r.BLEND=2]="BLEND",r))(rl||{}),Yt=(r=>(r[r.DISABLED=0]="DISABLED",r[r.NORMAL=1]="NORMAL",r[r.ADDITIVE=2]="ADDITIVE",r[r.SUBTRACTIVE=3]="SUBTRACTIVE",r[r.MULTIPLY=4]="MULTIPLY",r[r.CUSTOM=5]="CUSTOM",r))(Yt||{}),Ti=(r=>(r[r.FRONT=0]="FRONT",r[r.BACK=1]="BACK",r[r.DOUBLE=2]="DOUBLE",r))(Ti||{}),hs=(r=>(r.UNIVERSAL="universal",r.STANDARD="standard",r.WATER="water",r.GRASS="grass",r))(hs||{});const dm={"aabb_query_fragment.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform CameraBuffer {
mat4 projectionMatrix;
mat4 viewProjMatrix;
mat4 viewMatrix;
mat4 invViewMatrix;
vec4 cameraPosition_pad;
};
#define uCameraPosition cameraPosition_pad.xyz
#endif
in vec3 vPositionW;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform int axis;
#endif
vec4 encodeFloat(in float x) {
float xabs = abs(x);
float r = floor(xabs);
float g = fract(xabs);
return vec4(r / 255.0, g, 0.0, 0.0);
}
void main() {
vec3 viewW = uCameraPosition - vPositionW;
if (axis == 0) {
fragColor = encodeFloat(viewW.x);
} else if (axis == 1) {
fragColor = encodeFloat(viewW.y);
} else if (axis == 2) {
fragColor = encodeFloat(viewW.z);
}
}
`,"aabb_query_vertex.glsl":`vec4 transformPosition() {
return vec4(t0.x * position.x + t0.y * position.y + t0.z * position.z + t0.w,
t1.x * position.x + t1.y * position.y + t1.z * position.z + t1.w,
t2.x * position.x + t2.y * position.y + t2.z * position.z + t2.w, 1.0);
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform CameraBuffer {
mat4 projectionMatrix;
mat4 viewProjMatrix;
mat4 viewMatrix;
mat4 invViewMatrix;
vec4 cameraPosition_pad;
};
#define uCameraPosition cameraPosition_pad.xyz
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#define INSERT_MODEL_VIEW_MATRIX
#define MODEL_MATRIX
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = projectionMatrix * modelViewMatrix * worldPos;
}
#else  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec4 worldPos) {
#ifdef MODEL_MATRIX
gl_Position = viewProjMatrix * modelMatrix * worldPos;
#else
gl_Position = viewProjMatrix * worldPos;
#endif  // MODEL_MATRIX
}
#ifdef MODEL_MATRIX
#define INSERT_MODEL_VIEW_MATRIX mat4 modelViewMatrix = viewMatrix * modelMatrix;
#else
#define INSERT_MODEL_VIEW_MATRIX mat4 modelViewMatrix = viewMatrix;
#endif  // MODEL_MATRIX
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec3 worldPos) {
setClipPositionFromWorldPos(vec4(worldPos, 1.0));
}
void setClipPositionFromViewPos(in vec4 viewPos) {
gl_Position = projectionMatrix * viewPos;
}
void setClipPositionFromViewPos(in vec3 viewPos) {
setClipPositionFromViewPos(vec4(viewPos, 1.0));
}
vec3 multiplyPositionByModelMatrix(in vec4 position) {
#ifdef MODEL_MATRIX
return (modelMatrix * position).xyz;
#else
return position.xyz;
#endif
}
vec3 multiplyPositionByModelMatrix(in vec3 position) {
return multiplyPositionByModelMatrix(vec4(position, 1.0));
}
vec3 multiplyDirectionByModelMatrix(in vec3 direction) {
#ifdef MODEL_MATRIX
return (modelMatrix * vec4(direction, 0.0)).xyz;
#else
return direction;
#endif
}
out vec3 vPositionW;
void main() {
vec4 transformedPosition = transformPosition();
vPositionW = multiplyPositionByModelMatrix(transformedPosition);
setClipPositionFromWorldPos(transformedPosition);
}
`,"accumulate_fragment.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float weight;
#endif
uniform sampler2D inputBuffer;
in vec2 vUv0;
void main() {
vec3 inputColor = texture(inputBuffer, vUv0).rgb;
fragColor = vec4(inputColor, weight);
}
`,"accumulate_vertex.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform CameraBuffer {
mat4 projectionMatrix;
mat4 viewProjMatrix;
mat4 viewMatrix;
mat4 invViewMatrix;
vec4 cameraPosition_pad;
};
#define uCameraPosition cameraPosition_pad.xyz
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#define INSERT_MODEL_VIEW_MATRIX
#define MODEL_MATRIX
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = projectionMatrix * modelViewMatrix * worldPos;
}
#else  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec4 worldPos) {
#ifdef MODEL_MATRIX
gl_Position = viewProjMatrix * modelMatrix * worldPos;
#else
gl_Position = viewProjMatrix * worldPos;
#endif  // MODEL_MATRIX
}
#ifdef MODEL_MATRIX
#define INSERT_MODEL_VIEW_MATRIX mat4 modelViewMatrix = viewMatrix * modelMatrix;
#else
#define INSERT_MODEL_VIEW_MATRIX mat4 modelViewMatrix = viewMatrix;
#endif  // MODEL_MATRIX
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec3 worldPos) {
setClipPositionFromWorldPos(vec4(worldPos, 1.0));
}
void setClipPositionFromViewPos(in vec4 viewPos) {
gl_Position = projectionMatrix * viewPos;
}
void setClipPositionFromViewPos(in vec3 viewPos) {
setClipPositionFromViewPos(vec4(viewPos, 1.0));
}
vec3 multiplyPositionByModelMatrix(in vec4 position) {
#ifdef MODEL_MATRIX
return (modelMatrix * position).xyz;
#else
return position.xyz;
#endif
}
vec3 multiplyPositionByModelMatrix(in vec3 position) {
return multiplyPositionByModelMatrix(vec4(position, 1.0));
}
vec3 multiplyDirectionByModelMatrix(in vec3 direction) {
#ifdef MODEL_MATRIX
return (modelMatrix * vec4(direction, 0.0)).xyz;
#else
return direction;
#endif
}
out vec2 vUv0;
void main() {
vUv0 = uv0;
setClipPositionFromWorldPos(position);
}
`,"alpha_stats_combine_fragment.glsl":`uniform sampler2D map;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec2 mapUvStep;
uniform vec2 mapUvScale;
#endif
in vec2 vUv0;
void main() {
vec2 corner = vUv0 * mapUvScale - mapUvStep;
vec2 uv = corner + 0.5 * mapUvStep;
vec4 p0 = texture(map, uv);
vec4 p1 = texture(map, uv + vec2(0.0, mapUvStep.y));
vec4 p2 = texture(map, uv + vec2(mapUvStep.x, 0.0));
vec4 p3 = texture(map, uv + vec2(mapUvStep.x, mapUvStep.y));
fragColor = vec4((p0.r + p1.r + p2.r + p3.r) / 4.0, (p0.g + p1.g + p2.g + p3.g) / 4.0, 0.0, 1.0);
return;
}
`,"alpha_stats_fragment.glsl":`uniform sampler2D map;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec2 mapUvStep;
uniform vec4 mapUvOffsetScale;
#endif
in vec2 vUv0;
void main() {
vec2 corner = vUv0 * mapUvOffsetScale.zw + mapUvOffsetScale.xy - mapUvStep;
vec2 uv = corner + 0.5 * mapUvStep;
const float bias = -1.0;
float a0 = texture(map, uv, bias).a;
float a1 = texture(map, uv + vec2(0.0, mapUvStep.y), bias).a;
float a2 = texture(map, uv + vec2(mapUvStep.x, 0.0), bias).a;
float a3 = texture(map, uv + vec2(mapUvStep.x, mapUvStep.y), bias).a;
float fully_transparent_count = step(0.0, -a0) + step(0.0, -a1) + step(0.0, -a2) + step(0.0, -a3);
float partialy_transparent_count =
step(0.0, -abs(clamp(a0, 0.05, 0.95) - a0)) + step(0.0, -abs(clamp(a1, 0.05, 0.95) - a1)) +
step(0.0, -abs(clamp(a2, 0.05, 0.95) - a2)) + step(0.0, -abs(clamp(a3, 0.05, 0.95) - a3));
fragColor = vec4(step(4.0, partialy_transparent_count), fully_transparent_count / 4.0, 0.0, 1.0);
return;
}
`,"alpha_stats_vertex.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform CameraBuffer {
mat4 projectionMatrix;
mat4 viewProjMatrix;
mat4 viewMatrix;
mat4 invViewMatrix;
vec4 cameraPosition_pad;
};
#define uCameraPosition cameraPosition_pad.xyz
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#define INSERT_MODEL_VIEW_MATRIX
#define MODEL_MATRIX
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = projectionMatrix * modelViewMatrix * worldPos;
}
#else  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec4 worldPos) {
#ifdef MODEL_MATRIX
gl_Position = viewProjMatrix * modelMatrix * worldPos;
#else
gl_Position = viewProjMatrix * worldPos;
#endif  // MODEL_MATRIX
}
#ifdef MODEL_MATRIX
#define INSERT_MODEL_VIEW_MATRIX mat4 modelViewMatrix = viewMatrix * modelMatrix;
#else
#define INSERT_MODEL_VIEW_MATRIX mat4 modelViewMatrix = viewMatrix;
#endif  // MODEL_MATRIX
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec3 worldPos) {
setClipPositionFromWorldPos(vec4(worldPos, 1.0));
}
void setClipPositionFromViewPos(in vec4 viewPos) {
gl_Position = projectionMatrix * viewPos;
}
void setClipPositionFromViewPos(in vec3 viewPos) {
setClipPositionFromViewPos(vec4(viewPos, 1.0));
}
vec3 multiplyPositionByModelMatrix(in vec4 position) {
#ifdef MODEL_MATRIX
return (modelMatrix * position).xyz;
#else
return position.xyz;
#endif
}
vec3 multiplyPositionByModelMatrix(in vec3 position) {
return multiplyPositionByModelMatrix(vec4(position, 1.0));
}
vec3 multiplyDirectionByModelMatrix(in vec3 direction) {
#ifdef MODEL_MATRIX
return (modelMatrix * vec4(direction, 0.0)).xyz;
#else
return direction;
#endif
}
out vec2 vUv0;
void main() {
vUv0 = uv0;
setClipPositionFromWorldPos(position);
}
`,"anchor_vertex.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform CameraBuffer {
mat4 projectionMatrix;
mat4 viewProjMatrix;
mat4 viewMatrix;
mat4 invViewMatrix;
vec4 cameraPosition_pad;
};
#define uCameraPosition cameraPosition_pad.xyz
#endif
const float PI = 3.14159265358979;
const float RECIPROCAL_PI2 = 0.15915494;
float saturate(in float a) {
return clamp(a, 0.0, 1.0);
}
vec3 inverseTransformDirection(in vec3 normal, in mat4 matrix) {
return normalize((vec4(normal, 0.0) * matrix).xyz);
}
vec3 sphericalDecode(in vec2 spNormal) {
float theta = (spNormal.x / 254.0 + 0.5) * PI;
float phi = spNormal.y * (PI / 127.0);
float sinTheta = sin(theta);
return vec3(sinTheta * cos(phi), sinTheta * sin(phi), cos(theta));
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#define INSERT_MODEL_VIEW_MATRIX
#define MODEL_MATRIX
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = projectionMatrix * modelViewMatrix * worldPos;
}
#else  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec4 worldPos) {
#ifdef MODEL_MATRIX
gl_Position = viewProjMatrix * modelMatrix * worldPos;
#else
gl_Position = viewProjMatrix * worldPos;
#endif  // MODEL_MATRIX
}
#ifdef MODEL_MATRIX
#define INSERT_MODEL_VIEW_MATRIX mat4 modelViewMatrix = viewMatrix * modelMatrix;
#else
#define INSERT_MODEL_VIEW_MATRIX mat4 modelViewMatrix = viewMatrix;
#endif  // MODEL_MATRIX
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec3 worldPos) {
setClipPositionFromWorldPos(vec4(worldPos, 1.0));
}
void setClipPositionFromViewPos(in vec4 viewPos) {
gl_Position = projectionMatrix * viewPos;
}
void setClipPositionFromViewPos(in vec3 viewPos) {
setClipPositionFromViewPos(vec4(viewPos, 1.0));
}
vec3 multiplyPositionByModelMatrix(in vec4 position) {
#ifdef MODEL_MATRIX
return (modelMatrix * position).xyz;
#else
return position.xyz;
#endif
}
vec3 multiplyPositionByModelMatrix(in vec3 position) {
return multiplyPositionByModelMatrix(vec4(position, 1.0));
}
vec3 multiplyDirectionByModelMatrix(in vec3 direction) {
#ifdef MODEL_MATRIX
return (modelMatrix * vec4(direction, 0.0)).xyz;
#else
return direction;
#endif
}
#if defined(USE_BASE_COLOR_TEXTURE) || defined(USE_ROUGHNESS_TEXTURE) || \\
defined(USE_METALLIC_TEXTURE) || defined(USE_BUMP_TEXTURE)
out vec2 vUv0;
#endif
#if defined(USE_BUMP_TEXTURE) || defined(USE_FOG)
out vec3 vPositionV;
#endif
#ifdef USE_BUMP_TEXTURE
out vec3 vNormalV;
#endif
#if defined(USE_ENVMAP) || defined(USE_HEADLIGHT) || defined(USE_FOG) || defined(LIVE_LIGHTMAP)
out vec3 vPositionW;
#endif
#if defined(USE_ENVMAP) || defined(USE_HEADLIGHT) || defined(LIVE_LIGHTMAP)
out vec3 vNormalW;
#endif
void main() {
#if defined(USE_BASE_COLOR_TEXTURE) || defined(USE_ROUGHNESS_TEXTURE) || \\
defined(USE_METALLIC_TEXTURE) || defined(USE_ENVMAP) || defined(USE_HEADLIGHT)
vec3 positionW = multiplyPositionByModelMatrix(position);
vec3 normal = sphericalDecode(sphericalNormal);
vec3 normalW = multiplyDirectionByModelMatrix(normal);
normalW = normalize(normalW);
#endif
INSERT_MODEL_VIEW_MATRIX
#if defined(USE_BASE_COLOR_TEXTURE) || defined(USE_ROUGHNESS_TEXTURE) || \\
defined(USE_METALLIC_TEXTURE)
#ifdef MODEL_MATRIX
vec3 anchorCenterW = vec3(modelMatrix[3].xyz);
#else
vec3 anchorCenterW = vec3(0.0);
#endif
vec3 cameraUpW = vec3(modelViewMatrix[0].y, modelViewMatrix[1].y, modelViewMatrix[2].y);
vec3 forwardW = normalize(anchorCenterW - uCameraPosition);
vec3 rightW = cross(forwardW, cameraUpW);
rightW.z = 0.0;
rightW = normalize(rightW);
vec3 upW = cross(rightW, forwardW);
vUv0 = vec2(dot(normalW, rightW) * 0.5 + 0.5, dot(normalW, upW) * 0.5 + 0.5);
#endif
vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);
#if defined(USE_BUMP_TEXTURE) || defined(USE_FOG)
vPositionV = -mvPosition.xyz;
#endif
#if defined(USE_BUMP_TEXTURE)
#if defined(NON_UNIFORM_SCALE)
vNormalV = normalize(mat3(normalMatrix) * normal);
#else
vNormalV = normalize(mat3(modelViewMatrix) * normal);
#endif
#endif
#if defined(USE_ENVMAP) || defined(USE_HEADLIGHT) || defined(USE_FOG) || defined(LIVE_LIGHTMAP)
vPositionW = positionW;
#endif
#if defined(USE_ENVMAP) || defined(USE_HEADLIGHT) || defined(LIVE_LIGHTMAP)
vNormalW = normalW;
#endif
setClipPositionFromViewPos(mvPosition);
}
`,"brdf_fragment.glsl":`vec4 encodeNormalizedFloatsToRGBA8(float value1, float value2) {
float scaledValue1 = value1 * 65535.0;
float scaledValue2 = value2 * 65535.0;
vec4 encoded;
encoded.r = floor(scaledValue1 / 256.0) / 255.0;                 // High byte
encoded.g = floor(fract(scaledValue1 / 256.0) * 256.0) / 255.0;  // Low byte
encoded.b = floor(scaledValue2 / 256.0) / 255.0;                 // High byte
encoded.a = floor(fract(scaledValue2 / 256.0) * 256.0) / 255.0;  // Low byte
return encoded;
}
precision highp float;
in vec2 vUv0;
uniform float integrateBrdfNumSamples;
const float PI = 3.1415926;
float radicalInverseVDC(int n) {
float base = 2.0;
float invBase = 1.0 / base;
float result = 0.0;
float denom;
for (int i = 0; i < 32; i++) {
if (n > 0) {
denom = mod(float(n), base);
result += denom * invBase;
invBase = invBase / base;
n = int(float(n) / base);
}
}
return result;
}
vec2 hammersley(int i, int N) {
return vec2(float(i) / float(N), radicalInverseVDC(i));
}
vec3 importanceSampleGGX(vec2 xi, vec3 N, float roughness) {
float a = roughness * roughness;
float phi = 2.0 * PI * xi.x;
float cosTheta = sqrt((1.0 - xi.y) / (1.0 + (a * a - 1.0) * xi.y));
float sinTheta = sqrt(1.0 - cosTheta * cosTheta);
vec3 H = vec3(sinTheta * cos(phi), sinTheta * sin(phi), cosTheta);
vec3 upVector = abs(N.z) < 0.999 ? vec3(0.0, 0.0, 1.0) : vec3(1.0, 0.0, 0.0);
vec3 tangentX = normalize(cross(upVector, N));
vec3 tangentY = cross(N, tangentX);
return tangentX * H.x + tangentY * H.y + N * H.z;
}
float geometrySchlickGGX(float NdotV, float roughness) {
float k = (roughness * roughness) / 2.0;
float nom = NdotV;
float denom = NdotV * (1.0 - k) + k;
return nom / denom;
}
float geometrySmith(vec3 N, vec3 V, vec3 L, float roughness) {
float NdotV = max(dot(N, V), 0.0);
float NdotL = max(dot(N, L), 0.0);
float ggx2 = geometrySchlickGGX(NdotV, roughness);
float ggx1 = geometrySchlickGGX(NdotL, roughness);
return ggx1 * ggx2;
}
vec2 integrateBrdf(float roughness, float NdotV) {
vec3 V = vec3(sqrt(1.0 - NdotV * NdotV), 0.0, NdotV);
vec3 N = vec3(0.0, 0.0, 1.0);
float A = 0.0;
float B = 0.0;
int NumSamples = int(integrateBrdfNumSamples);
for (int i = 0; i < NumSamples; i++) {
vec2 xi = hammersley(i, NumSamples);
vec3 H = importanceSampleGGX(xi, N, roughness);
vec3 L = 2.0 * dot(V, H) * H - V;
float NdotL = clamp(L.z, 0.0, 1.0);
float NdotH = clamp(H.z, 0.0, 1.0);
float VdotH = clamp(dot(V, H), 0.0, 1.0);
if (NdotL > 0.0) {
float G = geometrySmith(N, V, L, roughness);
float G_Vis = G * VdotH / (NdotH * NdotV);
float Fc = pow(1.0 - VdotH, 5.0);
A += (1.0 - Fc) * G_Vis;
B += Fc * G_Vis;
}
}
return vec2(A, B) / float(NumSamples);
}
void main() {
vec2 brdf = integrateBrdf(vUv0.y, vUv0.x);
fragColor = encodeNormalizedFloatsToRGBA8(brdf.x, brdf.y);
}
`,"brdf_vertex.glsl":`out vec2 vUv0;
void main() {
vUv0 = uv0;
gl_Position = vec4(position, 1.0);
}
`,"copy_texture_fragment.glsl":`#ifdef DEV_NEW_RENDER_ARCHITECTURE
#else
uniform sampler2D tDiffuse;
#endif
in vec2 vUv0;
void main() {
#ifdef COPY_ALPHA
fragColor = texture(tDiffuse, vUv0);
#else
fragColor = vec4(texture(tDiffuse, vUv0).rgb, 1.0);
#endif
}
`,"copy_texture_vertex.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform CameraBuffer {
mat4 projectionMatrix;
mat4 viewProjMatrix;
mat4 viewMatrix;
mat4 invViewMatrix;
vec4 cameraPosition_pad;
};
#define uCameraPosition cameraPosition_pad.xyz
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#define INSERT_MODEL_VIEW_MATRIX
#define MODEL_MATRIX
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = projectionMatrix * modelViewMatrix * worldPos;
}
#else  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec4 worldPos) {
#ifdef MODEL_MATRIX
gl_Position = viewProjMatrix * modelMatrix * worldPos;
#else
gl_Position = viewProjMatrix * worldPos;
#endif  // MODEL_MATRIX
}
#ifdef MODEL_MATRIX
#define INSERT_MODEL_VIEW_MATRIX mat4 modelViewMatrix = viewMatrix * modelMatrix;
#else
#define INSERT_MODEL_VIEW_MATRIX mat4 modelViewMatrix = viewMatrix;
#endif  // MODEL_MATRIX
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec3 worldPos) {
setClipPositionFromWorldPos(vec4(worldPos, 1.0));
}
void setClipPositionFromViewPos(in vec4 viewPos) {
gl_Position = projectionMatrix * viewPos;
}
void setClipPositionFromViewPos(in vec3 viewPos) {
setClipPositionFromViewPos(vec4(viewPos, 1.0));
}
vec3 multiplyPositionByModelMatrix(in vec4 position) {
#ifdef MODEL_MATRIX
return (modelMatrix * position).xyz;
#else
return position.xyz;
#endif
}
vec3 multiplyPositionByModelMatrix(in vec3 position) {
return multiplyPositionByModelMatrix(vec4(position, 1.0));
}
vec3 multiplyDirectionByModelMatrix(in vec3 direction) {
#ifdef MODEL_MATRIX
return (modelMatrix * vec4(direction, 0.0)).xyz;
#else
return direction;
#endif
}
out vec2 vUv0;
void main() {
vUv0 = uv0;
#ifdef DEV_NEW_RENDER_ARCHITECTURE
gl_Position = vec4(position, 1.0);
#else
setClipPositionFromWorldPos(position);
#endif
}
`,"cubemap_filter_fragment.glsl":`const float PI = 3.14159265358979;
const float RECIPROCAL_PI2 = 0.15915494;
float saturate(in float a) {
return clamp(a, 0.0, 1.0);
}
vec3 inverseTransformDirection(in vec3 normal, in mat4 matrix) {
return normalize((vec4(normal, 0.0) * matrix).xyz);
}
float rnd(vec2 uv) {
return fract(sin(dot(uv, vec2(12.9898, 78.233) * 2.0)) * 43758.5453);
}
mat3 matrixFromVector(vec3 n) {  // frisvad
float a = 1.0 / (1.0 + n.z);
float b = -n.x * n.y * a;
vec3 b1 = vec3(1.0 - n.x * n.x * a, b, -n.x);
vec3 b2 = vec3(b, 1.0 - n.y * n.y * a, -n.y);
return mat3(b1, b2, n);
}
float distributionGGX(vec3 N, vec3 H, float roughness) {
const float PI = 3.14159265359;
float a = roughness * roughness;
float a2 = a * a;
float NdotH = max(dot(N, H), 0.0);
float NdotH2 = NdotH * NdotH;
float nom = a2;
float denom = (NdotH2 * (a2 - 1.0) + 1.0);
denom = PI * denom * denom;
return nom / denom;
}
float radicalInverseVDC(int n) {
float base = 2.0;
float invBase = 1.0 / base;
float result = 0.0;
float denom;
for (int i = 0; i < 32; i++) {
if (n > 0) {
denom = mod(float(n), base);
result += denom * invBase;
invBase = invBase / base;
n = int(float(n) / base);
}
}
return result;
}
vec2 hammersley(int i, int N) {
return vec2(float(i) / float(N), radicalInverseVDC(i));
}
vec3 importanceSampleGGX(vec2 Xi, vec3 N, float roughness) {
float a = roughness * roughness;
float phi = 2.0 * PI * Xi.x;
float cosTheta = sqrt((1.0 - Xi.y) / (1.0 + (a * a - 1.0) * Xi.y));
float sinTheta = sqrt(1.0 - cosTheta * cosTheta);
vec3 H;
H.x = cos(phi) * sinTheta;
H.y = sin(phi) * sinTheta;
H.z = cosTheta;
vec3 up = abs(N.z) < 0.999 ? vec3(0.0, 0.0, 1.0) : vec3(1.0, 0.0, 0.0);
vec3 tangent = normalize(cross(up, N));
vec3 bitangent = cross(N, tangent);
vec3 sampleVec = tangent * H.x + bitangent * H.y + N * H.z;
return normalize(sampleVec);
}
vec4 cubic(in float v) {
vec4 n = vec4(1.0, 2.0, 3.0, 4.0) - v;
vec4 s = n * n * n;
float x = s.x;
float y = s.y - 4.0 * s.x;
float z = s.z - 4.0 * s.y + 6.0 * s.x;
float w = 6.0 - x - y - z;
return vec4(x, y, z, w) * (1.0 / 6.0);
}
vec3 hdrDecodeRgbm(in vec4 rgbm) {
const float rgbmScale = 2.82842712;  // sqrt(8)
float m = 1.0 - rgbm.a;
vec3 r = rgbm.rgb * (rgbmScale * m);
return r * r;
}
vec3 hdrDecodeYcocgm(in vec4 ycocgm, in vec2 threshold) {
const float ycocgmLumaRange = 16.0;
float m = ycocgm.w * (16.0 * 255.0 / 256.0) - 1.0;
float chroma_scale_factor = fract(m);
float y_factor = m - chroma_scale_factor;
chroma_scale_factor = 1.0 - chroma_scale_factor;
float factor = y_factor == ycocgmLumaRange - 2.0 ? 0.0 : 1.0;
float y = mix(ycocgm.x * threshold.x, (y_factor + ycocgm.x) * threshold.y + threshold.x, factor);
float co = (ycocgm.y - 0.5) * chroma_scale_factor;
float cg = (ycocgm.z - 0.5) * chroma_scale_factor;
return vec3(y, co, cg);
}
vec3 ycocgToRgb(in vec3 ycocg) {
float y = ycocg.x, co = ycocg.y, cg = ycocg.z;
y = y * y;
float r = saturate(y + co - cg);
float g = saturate(y + cg);
float b = saturate(y - co - cg);
return vec3(r, g, b) * 8.0;
}
/*vec3 hdrDecodeYcocgmBicubic(in sampler2D ycocgmSampler, in vec2 texSize, in vec2 invTexSize,
in vec2 threshold, in vec2 texCoords) {
vec2 texCoordsScaled = texCoords * texSize - 0.5;
vec2 fxy = fract(texCoordsScaled);
texCoordsScaled -= fxy;
vec4 xcubic = cubic(fxy.x), ycubic = cubic(fxy.y);
vec4 c = texCoordsScaled.xxyy + vec2(-0.5, +1.5).xyxy;
vec4 s = vec4(xcubic.xz + xcubic.yw, ycubic.xz + ycubic.yw);
vec4 offset = (c + vec4 (xcubic.yw, ycubic.yw) / s) * invTexSize.xxyy;
vec3 sample0 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.xz), threshold);
vec3 sample1 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.yz), threshold);
vec3 sample2 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.xw), threshold);
vec3 sample3 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.yw), threshold);
float sx = s.x / (s.x + s.y), sy = s.z / (s.z + s.w);
return mix(mix(sample3, sample2, sx), mix(sample1, sample0, sx), sy);
}*/
vec3 hdrDecodeYcocgmBilinear(in sampler2D ycocgmSampler, in vec2 texSize, in vec2 invTexSize,
in vec2 threshold, in vec2 texCoords) {
vec2 texCoordsScaled = texCoords * texSize - 0.5;
vec2 fxy = fract(texCoordsScaled);
texCoordsScaled -= fxy;
vec4 c = texCoordsScaled.xxyy + vec2(-0.5, +0.5).xyxy;
vec4 offset = c + vec4(1.0);
float sx = 1.0 - fxy.x;
float sy = 1.0 - fxy.y;
offset *= invTexSize.xxyy;
vec3 sample0 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.xz), threshold);
vec3 sample1 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.yz), threshold);
vec3 sample2 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.xw), threshold);
vec3 sample3 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.yw), threshold);
return mix(mix(sample3, sample2, sx), mix(sample1, sample0, sx), sy);
}
/*vec3 hdrDecodeRgbmBicubic(in sampler2D rgbmSampler, in vec2 texSize,
in vec2 invTexSize, in vec2 texCoords) {
vec2 texCoordsScaled = texCoords * texSize - 0.5;
vec2 fxy = fract(texCoordsScaled);
texCoordsScaled -= fxy;
vec4 xcubic = cubic(fxy.x), ycubic = cubic(fxy.y);
vec4 c = texCoordsScaled.xxyy + vec2(-0.5, +1.5).xyxy;
vec4 s = vec4(xcubic.xz + xcubic.yw, ycubic.xz + ycubic.yw);
vec4 offset = (c + vec4 (xcubic.yw, ycubic.yw) / s) * invTexSize.xxyy;
vec3 sample0 = hdrDecodeRgbm(texture(rgbmSampler, offset.xz));
vec3 sample1 = hdrDecodeRgbm(texture(rgbmSampler, offset.yz));
vec3 sample2 = hdrDecodeRgbm(texture(rgbmSampler, offset.xw));
vec3 sample3 = hdrDecodeRgbm(texture(rgbmSampler, offset.yw));
float sx = s.x / (s.x + s.y), sy = s.z / (s.z + s.w);
return mix(mix(sample3, sample2, sx), mix(sample1, sample0, sx), sy);
}*/
vec3 hdrDecodeRgbmBilinear(in sampler2D rgbmSampler, in vec2 texSize, in vec2 invTexSize,
in vec2 texCoords) {
vec2 texCoordsScaled = texCoords * texSize - 0.5;
vec2 fxy = fract(texCoordsScaled);
texCoordsScaled -= fxy;
vec4 c = texCoordsScaled.xxyy + vec2(-0.5, +0.5).xyxy;
vec4 offset = c + vec4(1.0);
float sx = 1.0 - fxy.x;
float sy = 1.0 - fxy.y;
offset *= invTexSize.xxyy;
vec3 sample0 = hdrDecodeRgbm(texture(rgbmSampler, offset.xz));
vec3 sample1 = hdrDecodeRgbm(texture(rgbmSampler, offset.yz));
vec3 sample2 = hdrDecodeRgbm(texture(rgbmSampler, offset.xw));
vec3 sample3 = hdrDecodeRgbm(texture(rgbmSampler, offset.yw));
return mix(mix(sample3, sample2, sx), mix(sample1, sample0, sx), sy);
}
vec4 hdrEncode(in vec3 rgb) {
const float rgbmScale = 2.82842712;  // sqrt(8)
vec3 r = sqrt(rgb) / rgbmScale;
float m = max(max(r.r, r.g), r.b);
m = clamp(m, 1.0 / 255.0, 1.0);
m = ceil(m * 255.0) / 255.0;
r /= m;
return vec4(r.r, r.g, r.b, (1.0 - m));
}
uniform samplerCube envMap;
uniform samplerCube envMapFiltered;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float mipSize;
uniform float face;
uniform float roughness;
uniform int integrationNumSamples;
#endif
void main(void) {
vec2 st = 2.0 * floor(gl_FragCoord.xy) / (mipSize - 1.0) - 1.0;
vec3 vec;
if (face == 0.0) {
vec = vec3(1, -st.y, -st.x);
} else if (face == 1.0) {
vec = vec3(-1, -st.y, st.x);
} else if (face == 2.0) {
vec = vec3(st.x, 1, st.y);
} else if (face == 3.0) {
vec = vec3(st.x, -1, -st.y);
} else if (face == 4.0) {
vec = vec3(st.x, -st.y, 1);
} else {
vec = vec3(-st.x, -st.y, -1);
}
mat3 vecSpace = matrixFromVector(normalize(vec));
vec3 color = vec3(0.0);
float totalWeight = 0.0;
vec3 N = normalize(vec);
vec3 R = N;
vec3 V = R;
for (int i = 0; i < integrationNumSamples; i++) {
vec2 xi = hammersley(i, integrationNumSamples);
vec3 H = importanceSampleGGX(xi, N, roughness);
vec3 L = normalize(2.0 * dot(V, H) * H - V);
float NdotL = max(dot(N, L), 0.0);
if (NdotL > 0.0) {
color += hdrDecodeRgbm(texture(envMap, L)) * NdotL;
totalWeight += NdotL;
}
}
color /= totalWeight;
fragColor = hdrEncode(color);
}
`,"cubemap_filter_vertex.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform CameraBuffer {
mat4 projectionMatrix;
mat4 viewProjMatrix;
mat4 viewMatrix;
mat4 invViewMatrix;
vec4 cameraPosition_pad;
};
#define uCameraPosition cameraPosition_pad.xyz
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#define INSERT_MODEL_VIEW_MATRIX
#define MODEL_MATRIX
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = projectionMatrix * modelViewMatrix * worldPos;
}
#else  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec4 worldPos) {
#ifdef MODEL_MATRIX
gl_Position = viewProjMatrix * modelMatrix * worldPos;
#else
gl_Position = viewProjMatrix * worldPos;
#endif  // MODEL_MATRIX
}
#ifdef MODEL_MATRIX
#define INSERT_MODEL_VIEW_MATRIX mat4 modelViewMatrix = viewMatrix * modelMatrix;
#else
#define INSERT_MODEL_VIEW_MATRIX mat4 modelViewMatrix = viewMatrix;
#endif  // MODEL_MATRIX
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec3 worldPos) {
setClipPositionFromWorldPos(vec4(worldPos, 1.0));
}
void setClipPositionFromViewPos(in vec4 viewPos) {
gl_Position = projectionMatrix * viewPos;
}
void setClipPositionFromViewPos(in vec3 viewPos) {
setClipPositionFromViewPos(vec4(viewPos, 1.0));
}
vec3 multiplyPositionByModelMatrix(in vec4 position) {
#ifdef MODEL_MATRIX
return (modelMatrix * position).xyz;
#else
return position.xyz;
#endif
}
vec3 multiplyPositionByModelMatrix(in vec3 position) {
return multiplyPositionByModelMatrix(vec4(position, 1.0));
}
vec3 multiplyDirectionByModelMatrix(in vec3 direction) {
#ifdef MODEL_MATRIX
return (modelMatrix * vec4(direction, 0.0)).xyz;
#else
return direction;
#endif
}
void main() {
setClipPositionFromWorldPos(position);
}
`,"cube_to_equirect_fragment.glsl":`const float PI = 3.14159265358979;
const float RECIPROCAL_PI2 = 0.15915494;
float saturate(in float a) {
return clamp(a, 0.0, 1.0);
}
vec3 inverseTransformDirection(in vec3 normal, in mat4 matrix) {
return normalize((vec4(normal, 0.0) * matrix).xyz);
}
uniform samplerCube panoramaCube;
in vec2 vUv0;
void main() {
vec2 uv = vUv0;
float longitude = uv.x * 2. * PI;
float latitude = uv.y * PI;
vec3 dir = vec3(sin(longitude) * sin(latitude), cos(longitude) * sin(latitude), cos(latitude));
fragColor = texture(panoramaCube, normalize(dir));
}
`,"cube_to_equirect_vertex.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform CameraBuffer {
mat4 projectionMatrix;
mat4 viewProjMatrix;
mat4 viewMatrix;
mat4 invViewMatrix;
vec4 cameraPosition_pad;
};
#define uCameraPosition cameraPosition_pad.xyz
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#define INSERT_MODEL_VIEW_MATRIX
#define MODEL_MATRIX
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = projectionMatrix * modelViewMatrix * worldPos;
}
#else  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec4 worldPos) {
#ifdef MODEL_MATRIX
gl_Position = viewProjMatrix * modelMatrix * worldPos;
#else
gl_Position = viewProjMatrix * worldPos;
#endif  // MODEL_MATRIX
}
#ifdef MODEL_MATRIX
#define INSERT_MODEL_VIEW_MATRIX mat4 modelViewMatrix = viewMatrix * modelMatrix;
#else
#define INSERT_MODEL_VIEW_MATRIX mat4 modelViewMatrix = viewMatrix;
#endif  // MODEL_MATRIX
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec3 worldPos) {
setClipPositionFromWorldPos(vec4(worldPos, 1.0));
}
void setClipPositionFromViewPos(in vec4 viewPos) {
gl_Position = projectionMatrix * viewPos;
}
void setClipPositionFromViewPos(in vec3 viewPos) {
setClipPositionFromViewPos(vec4(viewPos, 1.0));
}
vec3 multiplyPositionByModelMatrix(in vec4 position) {
#ifdef MODEL_MATRIX
return (modelMatrix * position).xyz;
#else
return position.xyz;
#endif
}
vec3 multiplyPositionByModelMatrix(in vec3 position) {
return multiplyPositionByModelMatrix(vec4(position, 1.0));
}
vec3 multiplyDirectionByModelMatrix(in vec3 direction) {
#ifdef MODEL_MATRIX
return (modelMatrix * vec4(direction, 0.0)).xyz;
#else
return direction;
#endif
}
out vec2 vUv0;
void main() {
vUv0 = vec2(uv0.x, uv0.y - 1.0);
setClipPositionFromWorldPos(position);
}
`,"debug_fragment.glsl":`vec2 decodeNormalizedFloatsFromRGBA8(vec4 encoded) {
float value1 = (encoded.r * 255.0 * 256.0) + (encoded.g * 255.0);
float value2 = (encoded.b * 255.0 * 256.0) + (encoded.a * 255.0);
value1 /= 65535.0;
value2 /= 65535.0;
return vec2(value1, value2);
}
in vec2 vUv0;
void main() {
vec4 encodedUv = texture(tReprojectedUvResult, vUv0);
vec2 reprojectedUv = decodeNormalizedFloatsFromRGBA8(encodedUv);
vec4 sceneColor = texture(tColorResult, vUv0);
fragColor = mix(sceneColor, vec4(reprojectedUv, 0.0, 0.0), 0.0);
}
`,"editor_light_fragment.glsl":`float _l2g(in float x) {
return (x <= 0.0031308) ? x * 12.92 : pow(x, 1.0 / 2.4) * 1.055 - 0.055;
}
vec3 linearToGamma(in vec3 rgb) {
return vec3(_l2g(rgb.r), _l2g(rgb.g), _l2g(rgb.b));
}
vec3 hable(in vec3 rgb) {
float A = 0.15;  // shoulderStrength
float B = 0.50;  // linearStrength
float C = 0.10;  // linearAngle
float D = 0.20;  // toeStrength
float E = 0.02;  // toeNumerator
float F = 0.30;  // toeDenominator
return ((rgb * (A * rgb + C * B) + D * E) / (rgb * (A * rgb + B) + D * F)) - E / F;
}
vec3 toneMappingHable(in vec3 rgb) {
float exposure = 11.2;
float exposureBias = 2.0;
vec3 current = hable(exposureBias * rgb);
vec3 whiteScale = 1.0 / hable(vec3(exposure));
return pow(current * whiteScale, vec3(1.0 / 2.2));
}
vec3 uchimura(in vec3 x, in float P, in float a, in float m, in float l, in float c, in float b) {
float l0 = ((P - m) * l) / a;
float L0 = m - m / a;
float L1 = m + (1.0 - m) / a;
float S0 = m + l0;
float S1 = m + a * l0;
float C2 = (a * P) / (P - S1);
float CP = -C2 / P;
vec3 w0 = vec3(1.0 - smoothstep(0.0, m, x));
vec3 w2 = vec3(step(m + l0, x));
vec3 w1 = vec3(1.0 - w0 - w2);
vec3 T = vec3(m * pow(x / m, vec3(c)) + b);
vec3 S = vec3(P - (P - S1) * exp(CP * (x - S0)));
vec3 L = vec3(m + a * (x - m));
return T * w0 + L * w1 + S * w2;
}
vec3 toneMappingUchimura(in vec3 rgb) {
float P = 1.0;   // max display brightness
float a = 1.0;   // contrast
float m = 0.22;  // linear section start
float l = 0.4;   // linear section length
float c = 1.45;  // black
float b = 0.0;   // pedestal
return pow(uchimura(rgb, P, a, m, l, c, b), vec3(1.0 / 2.2));
}
vec3 toneMappingUnreal(in vec3 rgb) {
return rgb / (rgb + 0.187) * 1.035;
}
vec3 linearToGammaToneMapped(in vec3 rgb) {
#ifdef TONE_MAPPING_UNREAL
return toneMappingUnreal(rgb);
#endif
#ifdef TONE_MAPPING_HABLE
return toneMappingHable(rgb);
#endif
#ifdef TONE_MAPPING_UCHIMURA
return toneMappingUchimura(rgb);
#endif
return toneMappingUnreal(rgb);
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec3 uColor;
uniform vec3 uHighlight;
uniform float highlightMix;
#endif
in vec3 vNormal;
in vec3 vViewPosition;
void main() {
vec3 lVector = normalize(vViewPosition.xyz);
float pointDiffuse = max(dot(normalize(vNormal), lVector), 0.0);
vec3 lightColor = uColor * pointDiffuse;
lightColor = mix(lightColor, uHighlight, highlightMix);
fragColor = vec4(min(linearToGamma(lightColor), 1.0), 1.0);
}
`,"editor_light_vertex.glsl":`const float PI = 3.14159265358979;
const float RECIPROCAL_PI2 = 0.15915494;
float saturate(in float a) {
return clamp(a, 0.0, 1.0);
}
vec3 inverseTransformDirection(in vec3 normal, in mat4 matrix) {
return normalize((vec4(normal, 0.0) * matrix).xyz);
}
vec3 sphericalDecode(in vec2 spNormal) {
float theta = (spNormal.x / 254.0 + 0.5) * PI;
float phi = spNormal.y * (PI / 127.0);
float sinTheta = sin(theta);
return vec3(sinTheta * cos(phi), sinTheta * sin(phi), cos(theta));
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform CameraBuffer {
mat4 projectionMatrix;
mat4 viewProjMatrix;
mat4 viewMatrix;
mat4 invViewMatrix;
vec4 cameraPosition_pad;
};
#define uCameraPosition cameraPosition_pad.xyz
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#define INSERT_MODEL_VIEW_MATRIX
#define MODEL_MATRIX
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = projectionMatrix * modelViewMatrix * worldPos;
}
#else  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec4 worldPos) {
#ifdef MODEL_MATRIX
gl_Position = viewProjMatrix * modelMatrix * worldPos;
#else
gl_Position = viewProjMatrix * worldPos;
#endif  // MODEL_MATRIX
}
#ifdef MODEL_MATRIX
#define INSERT_MODEL_VIEW_MATRIX mat4 modelViewMatrix = viewMatrix * modelMatrix;
#else
#define INSERT_MODEL_VIEW_MATRIX mat4 modelViewMatrix = viewMatrix;
#endif  // MODEL_MATRIX
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec3 worldPos) {
setClipPositionFromWorldPos(vec4(worldPos, 1.0));
}
void setClipPositionFromViewPos(in vec4 viewPos) {
gl_Position = projectionMatrix * viewPos;
}
void setClipPositionFromViewPos(in vec3 viewPos) {
setClipPositionFromViewPos(vec4(viewPos, 1.0));
}
vec3 multiplyPositionByModelMatrix(in vec4 position) {
#ifdef MODEL_MATRIX
return (modelMatrix * position).xyz;
#else
return position.xyz;
#endif
}
vec3 multiplyPositionByModelMatrix(in vec3 position) {
return multiplyPositionByModelMatrix(vec4(position, 1.0));
}
vec3 multiplyDirectionByModelMatrix(in vec3 direction) {
#ifdef MODEL_MATRIX
return (modelMatrix * vec4(direction, 0.0)).xyz;
#else
return direction;
#endif
}
out vec3 vNormal;
out vec3 vViewPosition;
void main() {
INSERT_MODEL_VIEW_MATRIX
vec3 normal = sphericalDecode(sphericalNormal);
#if defined(NON_UNIFORM_SCALE)
vNormal = normalize(mat3(normalMatrix) * normal);
#else
vNormal = normalize(mat3(modelViewMatrix) * normal);
#endif
vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);
vViewPosition = -mvPosition.xyz;
setClipPositionFromViewPos(mvPosition);
}
`,"equirect_sky_fragment.glsl":`const float PI = 3.14159265358979;
const float RECIPROCAL_PI2 = 0.15915494;
float saturate(in float a) {
return clamp(a, 0.0, 1.0);
}
vec3 inverseTransformDirection(in vec3 normal, in mat4 matrix) {
return normalize((vec4(normal, 0.0) * matrix).xyz);
}
float _g2l(in float x) {
return (x <= 0.04045) ? x / 12.92 : pow((x + 0.055) / 1.055, 2.4);
}
vec3 gammaToLinear(in vec3 rgb) {
return vec3(_g2l(rgb.r), _g2l(rgb.g), _g2l(rgb.b));
}
float _l2g(in float x) {
return (x <= 0.0031308) ? x * 12.92 : pow(x, 1.0 / 2.4) * 1.055 - 0.055;
}
vec3 linearToGamma(in vec3 rgb) {
return vec3(_l2g(rgb.r), _l2g(rgb.g), _l2g(rgb.b));
}
vec3 hable(in vec3 rgb) {
float A = 0.15;  // shoulderStrength
float B = 0.50;  // linearStrength
float C = 0.10;  // linearAngle
float D = 0.20;  // toeStrength
float E = 0.02;  // toeNumerator
float F = 0.30;  // toeDenominator
return ((rgb * (A * rgb + C * B) + D * E) / (rgb * (A * rgb + B) + D * F)) - E / F;
}
vec3 toneMappingHable(in vec3 rgb) {
float exposure = 11.2;
float exposureBias = 2.0;
vec3 current = hable(exposureBias * rgb);
vec3 whiteScale = 1.0 / hable(vec3(exposure));
return pow(current * whiteScale, vec3(1.0 / 2.2));
}
vec3 uchimura(in vec3 x, in float P, in float a, in float m, in float l, in float c, in float b) {
float l0 = ((P - m) * l) / a;
float L0 = m - m / a;
float L1 = m + (1.0 - m) / a;
float S0 = m + l0;
float S1 = m + a * l0;
float C2 = (a * P) / (P - S1);
float CP = -C2 / P;
vec3 w0 = vec3(1.0 - smoothstep(0.0, m, x));
vec3 w2 = vec3(step(m + l0, x));
vec3 w1 = vec3(1.0 - w0 - w2);
vec3 T = vec3(m * pow(x / m, vec3(c)) + b);
vec3 S = vec3(P - (P - S1) * exp(CP * (x - S0)));
vec3 L = vec3(m + a * (x - m));
return T * w0 + L * w1 + S * w2;
}
vec3 toneMappingUchimura(in vec3 rgb) {
float P = 1.0;   // max display brightness
float a = 1.0;   // contrast
float m = 0.22;  // linear section start
float l = 0.4;   // linear section length
float c = 1.45;  // black
float b = 0.0;   // pedestal
return pow(uchimura(rgb, P, a, m, l, c, b), vec3(1.0 / 2.2));
}
vec3 toneMappingUnreal(in vec3 rgb) {
return rgb / (rgb + 0.187) * 1.035;
}
vec3 linearToGammaToneMapped(in vec3 rgb) {
#ifdef TONE_MAPPING_UNREAL
return toneMappingUnreal(rgb);
#endif
#ifdef TONE_MAPPING_HABLE
return toneMappingHable(rgb);
#endif
#ifdef TONE_MAPPING_UCHIMURA
return toneMappingUchimura(rgb);
#endif
return toneMappingUnreal(rgb);
}
vec4 cubic(in float v) {
vec4 n = vec4(1.0, 2.0, 3.0, 4.0) - v;
vec4 s = n * n * n;
float x = s.x;
float y = s.y - 4.0 * s.x;
float z = s.z - 4.0 * s.y + 6.0 * s.x;
float w = 6.0 - x - y - z;
return vec4(x, y, z, w) * (1.0 / 6.0);
}
vec3 hdrDecodeRgbm(in vec4 rgbm) {
const float rgbmScale = 2.82842712;  // sqrt(8)
float m = 1.0 - rgbm.a;
vec3 r = rgbm.rgb * (rgbmScale * m);
return r * r;
}
vec3 hdrDecodeYcocgm(in vec4 ycocgm, in vec2 threshold) {
const float ycocgmLumaRange = 16.0;
float m = ycocgm.w * (16.0 * 255.0 / 256.0) - 1.0;
float chroma_scale_factor = fract(m);
float y_factor = m - chroma_scale_factor;
chroma_scale_factor = 1.0 - chroma_scale_factor;
float factor = y_factor == ycocgmLumaRange - 2.0 ? 0.0 : 1.0;
float y = mix(ycocgm.x * threshold.x, (y_factor + ycocgm.x) * threshold.y + threshold.x, factor);
float co = (ycocgm.y - 0.5) * chroma_scale_factor;
float cg = (ycocgm.z - 0.5) * chroma_scale_factor;
return vec3(y, co, cg);
}
vec3 ycocgToRgb(in vec3 ycocg) {
float y = ycocg.x, co = ycocg.y, cg = ycocg.z;
y = y * y;
float r = saturate(y + co - cg);
float g = saturate(y + cg);
float b = saturate(y - co - cg);
return vec3(r, g, b) * 8.0;
}
/*vec3 hdrDecodeYcocgmBicubic(in sampler2D ycocgmSampler, in vec2 texSize, in vec2 invTexSize,
in vec2 threshold, in vec2 texCoords) {
vec2 texCoordsScaled = texCoords * texSize - 0.5;
vec2 fxy = fract(texCoordsScaled);
texCoordsScaled -= fxy;
vec4 xcubic = cubic(fxy.x), ycubic = cubic(fxy.y);
vec4 c = texCoordsScaled.xxyy + vec2(-0.5, +1.5).xyxy;
vec4 s = vec4(xcubic.xz + xcubic.yw, ycubic.xz + ycubic.yw);
vec4 offset = (c + vec4 (xcubic.yw, ycubic.yw) / s) * invTexSize.xxyy;
vec3 sample0 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.xz), threshold);
vec3 sample1 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.yz), threshold);
vec3 sample2 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.xw), threshold);
vec3 sample3 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.yw), threshold);
float sx = s.x / (s.x + s.y), sy = s.z / (s.z + s.w);
return mix(mix(sample3, sample2, sx), mix(sample1, sample0, sx), sy);
}*/
vec3 hdrDecodeYcocgmBilinear(in sampler2D ycocgmSampler, in vec2 texSize, in vec2 invTexSize,
in vec2 threshold, in vec2 texCoords) {
vec2 texCoordsScaled = texCoords * texSize - 0.5;
vec2 fxy = fract(texCoordsScaled);
texCoordsScaled -= fxy;
vec4 c = texCoordsScaled.xxyy + vec2(-0.5, +0.5).xyxy;
vec4 offset = c + vec4(1.0);
float sx = 1.0 - fxy.x;
float sy = 1.0 - fxy.y;
offset *= invTexSize.xxyy;
vec3 sample0 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.xz), threshold);
vec3 sample1 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.yz), threshold);
vec3 sample2 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.xw), threshold);
vec3 sample3 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.yw), threshold);
return mix(mix(sample3, sample2, sx), mix(sample1, sample0, sx), sy);
}
/*vec3 hdrDecodeRgbmBicubic(in sampler2D rgbmSampler, in vec2 texSize,
in vec2 invTexSize, in vec2 texCoords) {
vec2 texCoordsScaled = texCoords * texSize - 0.5;
vec2 fxy = fract(texCoordsScaled);
texCoordsScaled -= fxy;
vec4 xcubic = cubic(fxy.x), ycubic = cubic(fxy.y);
vec4 c = texCoordsScaled.xxyy + vec2(-0.5, +1.5).xyxy;
vec4 s = vec4(xcubic.xz + xcubic.yw, ycubic.xz + ycubic.yw);
vec4 offset = (c + vec4 (xcubic.yw, ycubic.yw) / s) * invTexSize.xxyy;
vec3 sample0 = hdrDecodeRgbm(texture(rgbmSampler, offset.xz));
vec3 sample1 = hdrDecodeRgbm(texture(rgbmSampler, offset.yz));
vec3 sample2 = hdrDecodeRgbm(texture(rgbmSampler, offset.xw));
vec3 sample3 = hdrDecodeRgbm(texture(rgbmSampler, offset.yw));
float sx = s.x / (s.x + s.y), sy = s.z / (s.z + s.w);
return mix(mix(sample3, sample2, sx), mix(sample1, sample0, sx), sy);
}*/
vec3 hdrDecodeRgbmBilinear(in sampler2D rgbmSampler, in vec2 texSize, in vec2 invTexSize,
in vec2 texCoords) {
vec2 texCoordsScaled = texCoords * texSize - 0.5;
vec2 fxy = fract(texCoordsScaled);
texCoordsScaled -= fxy;
vec4 c = texCoordsScaled.xxyy + vec2(-0.5, +0.5).xyxy;
vec4 offset = c + vec4(1.0);
float sx = 1.0 - fxy.x;
float sy = 1.0 - fxy.y;
offset *= invTexSize.xxyy;
vec3 sample0 = hdrDecodeRgbm(texture(rgbmSampler, offset.xz));
vec3 sample1 = hdrDecodeRgbm(texture(rgbmSampler, offset.yz));
vec3 sample2 = hdrDecodeRgbm(texture(rgbmSampler, offset.xw));
vec3 sample3 = hdrDecodeRgbm(texture(rgbmSampler, offset.yw));
return mix(mix(sample3, sample2, sx), mix(sample1, sample0, sx), sy);
}
vec4 hdrEncode(in vec3 rgb) {
const float rgbmScale = 2.82842712;  // sqrt(8)
vec3 r = sqrt(rgb) / rgbmScale;
float m = max(max(r.r, r.g), r.b);
m = clamp(m, 1.0 / 255.0, 1.0);
m = ceil(m * 255.0) / 255.0;
r /= m;
return vec4(r.r, r.g, r.b, (1.0 - m));
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform GlobalBuffer {
mat4 unjitteredInvProjMatrix;
mat4 unjitteredPrevViewProjMatrix;
vec4 viewSpaceFrustumRayDirections[4];
vec4 viewSpaceFrustumRayOrigins[4];
vec2 zNear_zFar;
vec4 fogDistStart_DistDensity_HeightStart_HeightDensity;
vec4 fogColor;
vec4 camera_exposure_gamma;
float colorMapIntensity;
float time;
vec2 texelSize;
vec2 renderTargetSize;
float deltaTime;
float velocityFactor;
vec2 jitterOffset;
float temporalAaHistoryWeight;
bool allTaaSamplesAccumulated;
vec2 neighbourhoodTexelOffsets[8];
float accumulatedStaticTaaSamples;
vec4 screenResolution;
float lightmapMode;
float dynamicTaaHistoryMultiplier;
};
#define uFogColor fogColor.xyz
#endif
#ifdef USE_FOG
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec4 fogDistStart_DistDensity_HeightStart_HeightDensity;
uniform vec3 uFogColor;
#endif
const float LOG2 = 1.442695;
vec3 addFog(in vec3 colorIn, in float distance, in vec3 positionW) {
float distanceValue = max(0.0, distance - fogDistStart_DistDensity_HeightStart_HeightDensity.x);
float distanceDensity = fogDistStart_DistDensity_HeightStart_HeightDensity.y;
float distanceFogExp =
1.0 - exp2(-distanceDensity * distanceDensity * distanceValue * distanceValue * LOG2);
float heightValue = max(0.0, -positionW.z + fogDistStart_DistDensity_HeightStart_HeightDensity.z);
float heightDensity = fogDistStart_DistDensity_HeightStart_HeightDensity.w;
float heightFogExp =
1.0 - exp2(-heightDensity * heightDensity * heightValue * heightValue * LOG2);
float fogAmount = min(1.0, distanceFogExp + heightFogExp);
return mix(colorIn, uFogColor.xyz, fogAmount);
}
#endif
uniform sampler2D map;
in vec2 vUv0;
#ifdef USE_FOG
in vec3 vPositionW;
in vec3 vPositionV;
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec4 camera_exposure_gamma;
#endif
#ifdef USE_COLORMAP
vec3 colormap(in sampler2D lut, in vec3 color, in float intensity) {
const float resolution = 16.0;
const float maxValueIndex = resolution - 1.0;
const float sliceWidth = 1.0 / resolution;
const float slicePixelWidth = sliceWidth / resolution;
const float sliceMarginWidth = 0.5 * slicePixelWidth;
const float sliceInnerWidth = sliceWidth - slicePixelWidth;
const float slicePixelHeight = 1.0 / resolution;
const float sliceMarginHeight = 0.5 * slicePixelHeight;
const float sliceInnerHeight = 1.0 - slicePixelHeight;
float bSlice0 = min(floor(color.b * maxValueIndex), maxValueIndex - 1.0);
float bSlice1 = bSlice0 + 1.0;
float bOffset = color.b * maxValueIndex - bSlice0;
float rSlicePos = sliceMarginWidth + color.r * sliceInnerWidth;
float gSlicePos = sliceMarginHeight + color.g * sliceInnerHeight;
float rPos0 = rSlicePos + (bSlice0 * sliceWidth);
float rPos1 = rSlicePos + (bSlice1 * sliceWidth);
vec3 color0 = texture(lut, vec2(rPos0, gSlicePos)).rgb;
vec3 color1 = texture(lut, vec2(rPos1, gSlicePos)).rgb;
return mix(color, mix(color0, color1, bOffset), intensity);
}
uniform sampler2D colorMap;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float colorMapIntensity;
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
#endif    // USE_COLORMAP
void main() {
#ifdef USE_RGBM_MAP
vec4 colorRgbm = texture(map, vUv0);
vec3 colorLinear = hdrDecodeRgbm(colorRgbm);
#else
vec3 colorLinear = gammaToLinear(texture(map, vUv0).xyz);
#endif
#ifdef USE_FOG
float distance = length(vPositionV);
colorLinear = addFog(colorLinear, distance, vPositionW);
#endif
#ifdef HDR_OUTPUT
#ifdef USE_RGBM_MAP
fragColor = colorRgbm;
#else
fragColor = hdrEncode(10.0 * colorLinear);
#endif
#else
vec3 colorExposed = pow(camera_exposure_gamma.x * colorLinear, vec3(camera_exposure_gamma.y));
vec3 colorGamma = linearToGammaToneMapped(colorExposed);
#ifdef USE_COLORMAP
fragColor = vec4(colormap(colorMap, colorGamma, colorMapIntensity), 1.0);
#else
fragColor = vec4(colorGamma, 1.0);
#endif
#endif
}
`,"equirect_sky_vertex.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform CameraBuffer {
mat4 projectionMatrix;
mat4 viewProjMatrix;
mat4 viewMatrix;
mat4 invViewMatrix;
vec4 cameraPosition_pad;
};
#define uCameraPosition cameraPosition_pad.xyz
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#define INSERT_MODEL_VIEW_MATRIX
#define MODEL_MATRIX
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = projectionMatrix * modelViewMatrix * worldPos;
}
#else  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec4 worldPos) {
#ifdef MODEL_MATRIX
gl_Position = viewProjMatrix * modelMatrix * worldPos;
#else
gl_Position = viewProjMatrix * worldPos;
#endif  // MODEL_MATRIX
}
#ifdef MODEL_MATRIX
#define INSERT_MODEL_VIEW_MATRIX mat4 modelViewMatrix = viewMatrix * modelMatrix;
#else
#define INSERT_MODEL_VIEW_MATRIX mat4 modelViewMatrix = viewMatrix;
#endif  // MODEL_MATRIX
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec3 worldPos) {
setClipPositionFromWorldPos(vec4(worldPos, 1.0));
}
void setClipPositionFromViewPos(in vec4 viewPos) {
gl_Position = projectionMatrix * viewPos;
}
void setClipPositionFromViewPos(in vec3 viewPos) {
setClipPositionFromViewPos(vec4(viewPos, 1.0));
}
vec3 multiplyPositionByModelMatrix(in vec4 position) {
#ifdef MODEL_MATRIX
return (modelMatrix * position).xyz;
#else
return position.xyz;
#endif
}
vec3 multiplyPositionByModelMatrix(in vec3 position) {
return multiplyPositionByModelMatrix(vec4(position, 1.0));
}
vec3 multiplyDirectionByModelMatrix(in vec3 direction) {
#ifdef MODEL_MATRIX
return (modelMatrix * vec4(direction, 0.0)).xyz;
#else
return direction;
#endif
}
out vec2 vUv0;
#ifdef USE_FOG
out vec3 vPositionW;
out vec3 vPositionV;
#endif
void main() {
vUv0 = uv0;
INSERT_MODEL_VIEW_MATRIX
vec3 vPos = (modelViewMatrix * vec4(position, 1.0)).xyz;
#ifdef USE_FOG
vPositionW = multiplyPositionByModelMatrix(position);
vPositionV = -vPos;
#endif
setClipPositionFromViewPos(vPos);
}
`,"fxaa_fragment.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform GlobalBuffer {
mat4 unjitteredInvProjMatrix;
mat4 unjitteredPrevViewProjMatrix;
vec4 viewSpaceFrustumRayDirections[4];
vec4 viewSpaceFrustumRayOrigins[4];
vec2 zNear_zFar;
vec4 fogDistStart_DistDensity_HeightStart_HeightDensity;
vec4 fogColor;
vec4 camera_exposure_gamma;
float colorMapIntensity;
float time;
vec2 texelSize;
vec2 renderTargetSize;
float deltaTime;
float velocityFactor;
vec2 jitterOffset;
float temporalAaHistoryWeight;
bool allTaaSamplesAccumulated;
vec2 neighbourhoodTexelOffsets[8];
float accumulatedStaticTaaSamples;
vec4 screenResolution;
float lightmapMode;
float dynamicTaaHistoryMultiplier;
};
#define uFogColor fogColor.xyz
#endif
#ifdef DEV_NEW_RENDER_ARCHITECTURE
in vec2 vUv0;
#else
uniform sampler2D tDiffuse;
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec2 texelSize;
#endif
#define FXAA_REDUCE_MIN (1.0 / 128.0)
#define FXAA_REDUCE_MUL (1.0 / 8.0)
#define FXAA_SPAN_MAX 8.0
void main() {
#ifdef DEV_NEW_RENDER_ARCHITECTURE
vec3 rgbNW = texture(tDiffuse, vUv0 + vec2(-texelSize.x, -texelSize.y)).xyz;
vec3 rgbNE = texture(tDiffuse, vUv0 + vec2(texelSize.x, -texelSize.y)).xyz;
vec3 rgbSW = texture(tDiffuse, vUv0 + vec2(-texelSize.x, texelSize.y)).xyz;
vec3 rgbSE = texture(tDiffuse, vUv0 + vec2(texelSize.x, texelSize.y)).xyz;
vec4 rgbaM = texture(tDiffuse, vUv0);
#else
vec3 rgbNW = texture(tDiffuse, (gl_FragCoord.xy + vec2(-1.0, -1.0)) * texelSize).xyz;
vec3 rgbNE = texture(tDiffuse, (gl_FragCoord.xy + vec2(1.0, -1.0)) * texelSize).xyz;
vec3 rgbSW = texture(tDiffuse, (gl_FragCoord.xy + vec2(-1.0, 1.0)) * texelSize).xyz;
vec3 rgbSE = texture(tDiffuse, (gl_FragCoord.xy + vec2(1.0, 1.0)) * texelSize).xyz;
vec4 rgbaM = texture(tDiffuse, gl_FragCoord.xy * texelSize);
#endif
vec3 rgbM = rgbaM.xyz;
vec3 luma = vec3(0.299, 0.587, 0.114);
float lumaNW = dot(rgbNW, luma);
float lumaNE = dot(rgbNE, luma);
float lumaSW = dot(rgbSW, luma);
float lumaSE = dot(rgbSE, luma);
float lumaM = dot(rgbM, luma);
float lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));
float lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));
vec2 dir;
dir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));
dir.y = ((lumaNW + lumaSW) - (lumaNE + lumaSE));
float dirReduce =
max((lumaNW + lumaNE + lumaSW + lumaSE) * (0.25 * FXAA_REDUCE_MUL), FXAA_REDUCE_MIN);
float rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);
dir = min(vec2(FXAA_SPAN_MAX, FXAA_SPAN_MAX),
max(vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX), dir * rcpDirMin)) *
texelSize;
#ifdef DEV_NEW_RENDER_ARCHITECTURE
vec4 rgbA = (1.0 / 2.0) * (texture(tDiffuse, vUv0 + dir * (1.0 / 3.0 - 0.5)) +
texture(tDiffuse, vUv0 + dir * (2.0 / 3.0 - 0.5)));
vec4 rgbB =
rgbA * (1.0 / 2.0) + (1.0 / 4.0) * (texture(tDiffuse, vUv0 + dir * (0.0 / 3.0 - 0.5)) +
texture(tDiffuse, vUv0 + dir * (3.0 / 3.0 - 0.5)));
#else
vec4 rgbA =
(1.0 / 2.0) * (texture(tDiffuse, gl_FragCoord.xy * texelSize + dir * (1.0 / 3.0 - 0.5)) +
texture(tDiffuse, gl_FragCoord.xy * texelSize + dir * (2.0 / 3.0 - 0.5)));
vec4 rgbB =
rgbA * (1.0 / 2.0) +
(1.0 / 4.0) * (texture(tDiffuse, gl_FragCoord.xy * texelSize + dir * (0.0 / 3.0 - 0.5)) +
texture(tDiffuse, gl_FragCoord.xy * texelSize + dir * (3.0 / 3.0 - 0.5)));
#endif
float lumaB = dot(rgbB, vec4(luma, 0.0));
if ((lumaB < lumaMin) || (lumaB > lumaMax)) {
fragColor = rgbA;
} else {
fragColor = rgbB;
}
}
`,"fxaa_vertex.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform CameraBuffer {
mat4 projectionMatrix;
mat4 viewProjMatrix;
mat4 viewMatrix;
mat4 invViewMatrix;
vec4 cameraPosition_pad;
};
#define uCameraPosition cameraPosition_pad.xyz
#endif
#ifdef DEV_NEW_RENDER_ARCHITECTURE
out vec2 vUv0;
#endif
void main() {
#ifdef DEV_NEW_RENDER_ARCHITECTURE
vUv0 = uv0;
#endif
gl_Position = vec4(position, 1.0);
}
`,"gaze_pointer_fragment.glsl":`const float PI = 3.14159265358979;
const float RECIPROCAL_PI2 = 0.15915494;
float saturate(in float a) {
return clamp(a, 0.0, 1.0);
}
vec3 inverseTransformDirection(in vec3 normal, in mat4 matrix) {
return normalize((vec4(normal, 0.0) * matrix).xyz);
}
const float pointRadius = 0.01;
const float pointBorder = 0.005;
const float timerRadius = 0.04;
const float timerBorder = 0.02;
const vec3 timerColor = vec3(0.298, 0.619, 0.851);
in vec2 coords;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float circleSpan;
#endif
void main() {
float dist = sqrt(dot(coords, coords));
if (dist < pointRadius) {
float a = 1.0 - smoothstep(pointRadius - pointBorder, pointRadius, dist);
fragColor = vec4(1.0, 1.0, 1.0, a);
} else if (-atan(coords.x, -coords.y) < circleSpan) {
float a2 = smoothstep(timerRadius - timerBorder, timerRadius, dist) -
smoothstep(timerRadius, timerRadius + timerBorder, dist);
fragColor = vec4(timerColor, a2);
} else {
discard;
}
}
`,"gaze_pointer_vertex.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform CameraBuffer {
mat4 projectionMatrix;
mat4 viewProjMatrix;
mat4 viewMatrix;
mat4 invViewMatrix;
vec4 cameraPosition_pad;
};
#define uCameraPosition cameraPosition_pad.xyz
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#define INSERT_MODEL_VIEW_MATRIX
#define MODEL_MATRIX
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = projectionMatrix * modelViewMatrix * worldPos;
}
#else  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec4 worldPos) {
#ifdef MODEL_MATRIX
gl_Position = viewProjMatrix * modelMatrix * worldPos;
#else
gl_Position = viewProjMatrix * worldPos;
#endif  // MODEL_MATRIX
}
#ifdef MODEL_MATRIX
#define INSERT_MODEL_VIEW_MATRIX mat4 modelViewMatrix = viewMatrix * modelMatrix;
#else
#define INSERT_MODEL_VIEW_MATRIX mat4 modelViewMatrix = viewMatrix;
#endif  // MODEL_MATRIX
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec3 worldPos) {
setClipPositionFromWorldPos(vec4(worldPos, 1.0));
}
void setClipPositionFromViewPos(in vec4 viewPos) {
gl_Position = projectionMatrix * viewPos;
}
void setClipPositionFromViewPos(in vec3 viewPos) {
setClipPositionFromViewPos(vec4(viewPos, 1.0));
}
vec3 multiplyPositionByModelMatrix(in vec4 position) {
#ifdef MODEL_MATRIX
return (modelMatrix * position).xyz;
#else
return position.xyz;
#endif
}
vec3 multiplyPositionByModelMatrix(in vec3 position) {
return multiplyPositionByModelMatrix(vec4(position, 1.0));
}
vec3 multiplyDirectionByModelMatrix(in vec3 direction) {
#ifdef MODEL_MATRIX
return (modelMatrix * vec4(direction, 0.0)).xyz;
#else
return direction;
#endif
}
out vec2 coords;
void main() {
coords = vec2(position.x, position.y);
setClipPositionFromWorldPos(position);
gl_Position.z = -0.1;
}
`,"grass_fragment.glsl":`#ifdef USE_HEIGHT_TEXTURE
uniform sampler2D heightTexture;
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float currentStep;
uniform float renderSteps;
#endif
vec3 addSpecularHook(in vec3 baseColor, in vec3 totalIntensity, inout float opacity) {
return baseColor * totalIntensity;
}
float easeOutCubic(in float x) {
return 1.0 - pow(1.0 - x, 3.0);
}
vec3 getBaseColorHook(out float alpha) {
float alphaDiscard = 0.5;
#ifdef USE_HEIGHT_TEXTURE
float heightAmount = textureWithOptionalAntiTiling(heightTexture, vUv0).r;
alpha = currentStep > 0.0 ? easeOutCubic(heightAmount) : 1.0;
alphaDiscard = (1.0 / renderSteps) * currentStep;
if (alpha < alphaDiscard) {
discard;
}
#endif
#ifdef USE_BASE_COLOR_TEXTURE
vec2 uv = vUv0;
#ifdef USE_BASE_COLOR_TEXTURE_ATLAS_REPEAT
vec2 uvScaled = uv * baseColorAtlasUvMod.zw;
vec2 dfdx = dFdx(uvScaled);
vec2 dfdy = dFdy(uvScaled);
uv = fract(uv) * baseColorAtlasUvMod.zw + baseColorAtlasUvMod.xy;
vec4 baseColorGamma = textureGrad(baseColorTexture, uv, dfdx, dfdy);
#else
vec4 baseColorGamma = textureWithOptionalAntiTiling(baseColorTexture, uv);
#endif
vec3 resultColor =
applyBaseColorCorrection(gammaToLinear(baseColorGamma.rgb), baseColorCorrection);
#else
vec3 resultColor = uBaseColor;
#endif
float offset = min(0.35, 0.35 * (renderSteps - 1.0));
float baseColorMultiplier = mix(1.0 - offset, 1.0 + offset, alphaDiscard);
return resultColor * baseColorMultiplier;
}
`,"grass_vertex.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float grassOffsetScaled;
uniform float grassDirectionality;
#endif
void modifyMvPositionHook(inout vec4 mvPosition, in vec3 mvNormal) {
vec3 vector = mix(vec3(0, 1, 0), mvNormal, grassDirectionality);
mvPosition.xyz += vector * grassOffsetScaled;
}
`,"imgui_fragment.glsl":`in vec2 vUv;
in vec4 vColor;
void main() {
fragColor = vColor * texture(tColor, vUv);
}
`,"imgui_vertex.glsl":`out vec2 vUv;
out vec4 vColor;
void main() {
vUv = uv0;
vColor = color;
gl_Position = uImGuiProjMatrix * vec4(position.xy, 0.0, 1.0);
}
`,"luma_fragment.glsl":`const float PI = 3.14159265358979;
const float RECIPROCAL_PI2 = 0.15915494;
float saturate(in float a) {
return clamp(a, 0.0, 1.0);
}
vec3 inverseTransformDirection(in vec3 normal, in mat4 matrix) {
return normalize((vec4(normal, 0.0) * matrix).xyz);
}
vec4 cubic(in float v) {
vec4 n = vec4(1.0, 2.0, 3.0, 4.0) - v;
vec4 s = n * n * n;
float x = s.x;
float y = s.y - 4.0 * s.x;
float z = s.z - 4.0 * s.y + 6.0 * s.x;
float w = 6.0 - x - y - z;
return vec4(x, y, z, w) * (1.0 / 6.0);
}
vec3 hdrDecodeRgbm(in vec4 rgbm) {
const float rgbmScale = 2.82842712;  // sqrt(8)
float m = 1.0 - rgbm.a;
vec3 r = rgbm.rgb * (rgbmScale * m);
return r * r;
}
vec3 hdrDecodeYcocgm(in vec4 ycocgm, in vec2 threshold) {
const float ycocgmLumaRange = 16.0;
float m = ycocgm.w * (16.0 * 255.0 / 256.0) - 1.0;
float chroma_scale_factor = fract(m);
float y_factor = m - chroma_scale_factor;
chroma_scale_factor = 1.0 - chroma_scale_factor;
float factor = y_factor == ycocgmLumaRange - 2.0 ? 0.0 : 1.0;
float y = mix(ycocgm.x * threshold.x, (y_factor + ycocgm.x) * threshold.y + threshold.x, factor);
float co = (ycocgm.y - 0.5) * chroma_scale_factor;
float cg = (ycocgm.z - 0.5) * chroma_scale_factor;
return vec3(y, co, cg);
}
vec3 ycocgToRgb(in vec3 ycocg) {
float y = ycocg.x, co = ycocg.y, cg = ycocg.z;
y = y * y;
float r = saturate(y + co - cg);
float g = saturate(y + cg);
float b = saturate(y - co - cg);
return vec3(r, g, b) * 8.0;
}
/*vec3 hdrDecodeYcocgmBicubic(in sampler2D ycocgmSampler, in vec2 texSize, in vec2 invTexSize,
in vec2 threshold, in vec2 texCoords) {
vec2 texCoordsScaled = texCoords * texSize - 0.5;
vec2 fxy = fract(texCoordsScaled);
texCoordsScaled -= fxy;
vec4 xcubic = cubic(fxy.x), ycubic = cubic(fxy.y);
vec4 c = texCoordsScaled.xxyy + vec2(-0.5, +1.5).xyxy;
vec4 s = vec4(xcubic.xz + xcubic.yw, ycubic.xz + ycubic.yw);
vec4 offset = (c + vec4 (xcubic.yw, ycubic.yw) / s) * invTexSize.xxyy;
vec3 sample0 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.xz), threshold);
vec3 sample1 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.yz), threshold);
vec3 sample2 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.xw), threshold);
vec3 sample3 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.yw), threshold);
float sx = s.x / (s.x + s.y), sy = s.z / (s.z + s.w);
return mix(mix(sample3, sample2, sx), mix(sample1, sample0, sx), sy);
}*/
vec3 hdrDecodeYcocgmBilinear(in sampler2D ycocgmSampler, in vec2 texSize, in vec2 invTexSize,
in vec2 threshold, in vec2 texCoords) {
vec2 texCoordsScaled = texCoords * texSize - 0.5;
vec2 fxy = fract(texCoordsScaled);
texCoordsScaled -= fxy;
vec4 c = texCoordsScaled.xxyy + vec2(-0.5, +0.5).xyxy;
vec4 offset = c + vec4(1.0);
float sx = 1.0 - fxy.x;
float sy = 1.0 - fxy.y;
offset *= invTexSize.xxyy;
vec3 sample0 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.xz), threshold);
vec3 sample1 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.yz), threshold);
vec3 sample2 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.xw), threshold);
vec3 sample3 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.yw), threshold);
return mix(mix(sample3, sample2, sx), mix(sample1, sample0, sx), sy);
}
/*vec3 hdrDecodeRgbmBicubic(in sampler2D rgbmSampler, in vec2 texSize,
in vec2 invTexSize, in vec2 texCoords) {
vec2 texCoordsScaled = texCoords * texSize - 0.5;
vec2 fxy = fract(texCoordsScaled);
texCoordsScaled -= fxy;
vec4 xcubic = cubic(fxy.x), ycubic = cubic(fxy.y);
vec4 c = texCoordsScaled.xxyy + vec2(-0.5, +1.5).xyxy;
vec4 s = vec4(xcubic.xz + xcubic.yw, ycubic.xz + ycubic.yw);
vec4 offset = (c + vec4 (xcubic.yw, ycubic.yw) / s) * invTexSize.xxyy;
vec3 sample0 = hdrDecodeRgbm(texture(rgbmSampler, offset.xz));
vec3 sample1 = hdrDecodeRgbm(texture(rgbmSampler, offset.yz));
vec3 sample2 = hdrDecodeRgbm(texture(rgbmSampler, offset.xw));
vec3 sample3 = hdrDecodeRgbm(texture(rgbmSampler, offset.yw));
float sx = s.x / (s.x + s.y), sy = s.z / (s.z + s.w);
return mix(mix(sample3, sample2, sx), mix(sample1, sample0, sx), sy);
}*/
vec3 hdrDecodeRgbmBilinear(in sampler2D rgbmSampler, in vec2 texSize, in vec2 invTexSize,
in vec2 texCoords) {
vec2 texCoordsScaled = texCoords * texSize - 0.5;
vec2 fxy = fract(texCoordsScaled);
texCoordsScaled -= fxy;
vec4 c = texCoordsScaled.xxyy + vec2(-0.5, +0.5).xyxy;
vec4 offset = c + vec4(1.0);
float sx = 1.0 - fxy.x;
float sy = 1.0 - fxy.y;
offset *= invTexSize.xxyy;
vec3 sample0 = hdrDecodeRgbm(texture(rgbmSampler, offset.xz));
vec3 sample1 = hdrDecodeRgbm(texture(rgbmSampler, offset.yz));
vec3 sample2 = hdrDecodeRgbm(texture(rgbmSampler, offset.xw));
vec3 sample3 = hdrDecodeRgbm(texture(rgbmSampler, offset.yw));
return mix(mix(sample3, sample2, sx), mix(sample1, sample0, sx), sy);
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform GlobalBuffer {
mat4 unjitteredInvProjMatrix;
mat4 unjitteredPrevViewProjMatrix;
vec4 viewSpaceFrustumRayDirections[4];
vec4 viewSpaceFrustumRayOrigins[4];
vec2 zNear_zFar;
vec4 fogDistStart_DistDensity_HeightStart_HeightDensity;
vec4 fogColor;
vec4 camera_exposure_gamma;
float colorMapIntensity;
float time;
vec2 texelSize;
vec2 renderTargetSize;
float deltaTime;
float velocityFactor;
vec2 jitterOffset;
float temporalAaHistoryWeight;
bool allTaaSamplesAccumulated;
vec2 neighbourhoodTexelOffsets[8];
float accumulatedStaticTaaSamples;
vec4 screenResolution;
float lightmapMode;
float dynamicTaaHistoryMultiplier;
};
#define uFogColor fogColor.xyz
#endif
struct ReflectionProbe {
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
vec3 boxMin;
vec3 boxMax;
vec3 posW;
#else
vec4 boxMin;
vec4 boxMax;
vec4 posW;
#endif
};
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform LightBuffer {
vec4 lightmapSize;
vec4 lightmapThreshold;
ReflectionProbe reflectionProbes[3];
int reflectionProbesCount;
};
#endif
#ifdef LIVE_LIGHTMAP
uniform sampler2D liveLightmap;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float lightmapMode;
uniform vec4 screenResolution;
#endif
#endif
#ifdef USE_LIGHTMAP
centroid in vec2 vUv1;
uniform sampler2D lightmap;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec4 lightmapSize;
uniform vec2 lightmapThreshold;
#endif
#endif  // NOT USE_LIGHTMAP
vec3 getLightIntensity() {
#ifdef LIVE_LIGHTMAP
if (lightmapMode == 1.0)
return texture(liveLightmap, gl_FragCoord.xy / screenResolution.xy).xyz;
if (lightmapMode == -1.0)
return vec3(1.0);
#endif
#ifdef USE_LIGHTMAP
vec2 uv = vec2(vUv1.x, vUv1.y);
#ifdef LIGHTMAP_YCOCGM
return ycocgToRgb(hdrDecodeYcocgmBilinear(lightmap, lightmapSize.xy, lightmapSize.zw,
lightmapThreshold.xy, uv));
#else  // LIGHTMAP_RGBM
return hdrDecodeRgbmBilinear(lightmap, lightmapSize.xy, lightmapSize.zw, uv);
#endif
#else  // ifndef USE_LIGHTMAP
return vec3(1.0);
#endif
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec3 uColor;
#endif
const float maxLuminance = 8.0;
const float rangeScale = 256.0 / maxLuminance;
const float fltMin = uintBitsToFloat(0x2F800000u);
void main() {
vec3 receivedLight = getLightIntensity();
vec3 diffuseLight = receivedLight * uColor;
float luma = 0.299 * diffuseLight.r + 0.587 * diffuseLight.g + 0.114 * diffuseLight.b;
fragColor.r = max(fract(luma * rangeScale), fltMin);
fragColor.g = floor(luma * rangeScale) / 255.0;
}
`,"minimap_add_alpha_fragment.glsl":`uniform sampler2D tColor;
#ifdef USE_ALPHA_FROM_COLOR
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec3 uColorFill;
#endif
#else
uniform sampler2D tAlpha;
#endif
in vec2 vUv0;
void main() {
vec4 color = texture(tColor, vUv0);
#ifdef USE_ALPHA_FROM_COLOR
float alphaFromColor = (color.r + color.g + color.b) / 3.0;
fragColor = vec4(uColorFill, alphaFromColor);
#else
float alpha = vec4(texture(tAlpha, vUv0)).a;
fragColor = vec4(color.rgb, alpha);
#endif
}
`,"minimap_add_alpha_vertex.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform CameraBuffer {
mat4 projectionMatrix;
mat4 viewProjMatrix;
mat4 viewMatrix;
mat4 invViewMatrix;
vec4 cameraPosition_pad;
};
#define uCameraPosition cameraPosition_pad.xyz
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#define INSERT_MODEL_VIEW_MATRIX
#define MODEL_MATRIX
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = projectionMatrix * modelViewMatrix * worldPos;
}
#else  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec4 worldPos) {
#ifdef MODEL_MATRIX
gl_Position = viewProjMatrix * modelMatrix * worldPos;
#else
gl_Position = viewProjMatrix * worldPos;
#endif  // MODEL_MATRIX
}
#ifdef MODEL_MATRIX
#define INSERT_MODEL_VIEW_MATRIX mat4 modelViewMatrix = viewMatrix * modelMatrix;
#else
#define INSERT_MODEL_VIEW_MATRIX mat4 modelViewMatrix = viewMatrix;
#endif  // MODEL_MATRIX
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec3 worldPos) {
setClipPositionFromWorldPos(vec4(worldPos, 1.0));
}
void setClipPositionFromViewPos(in vec4 viewPos) {
gl_Position = projectionMatrix * viewPos;
}
void setClipPositionFromViewPos(in vec3 viewPos) {
setClipPositionFromViewPos(vec4(viewPos, 1.0));
}
vec3 multiplyPositionByModelMatrix(in vec4 position) {
#ifdef MODEL_MATRIX
return (modelMatrix * position).xyz;
#else
return position.xyz;
#endif
}
vec3 multiplyPositionByModelMatrix(in vec3 position) {
return multiplyPositionByModelMatrix(vec4(position, 1.0));
}
vec3 multiplyDirectionByModelMatrix(in vec3 direction) {
#ifdef MODEL_MATRIX
return (modelMatrix * vec4(direction, 0.0)).xyz;
#else
return direction;
#endif
}
out vec2 vUv0;
void main() {
vUv0 = uv0;
setClipPositionFromWorldPos(position);
}
`,"motion_blur_fragment.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform GlobalBuffer {
mat4 unjitteredInvProjMatrix;
mat4 unjitteredPrevViewProjMatrix;
vec4 viewSpaceFrustumRayDirections[4];
vec4 viewSpaceFrustumRayOrigins[4];
vec2 zNear_zFar;
vec4 fogDistStart_DistDensity_HeightStart_HeightDensity;
vec4 fogColor;
vec4 camera_exposure_gamma;
float colorMapIntensity;
float time;
vec2 texelSize;
vec2 renderTargetSize;
float deltaTime;
float velocityFactor;
vec2 jitterOffset;
float temporalAaHistoryWeight;
bool allTaaSamplesAccumulated;
vec2 neighbourhoodTexelOffsets[8];
float accumulatedStaticTaaSamples;
vec4 screenResolution;
float lightmapMode;
float dynamicTaaHistoryMultiplier;
};
#define uFogColor fogColor.xyz
#endif
#ifdef DEV_NEW_RENDER_ARCHITECTURE
vec2 decodeNormalizedFloatsFromRGBA8(vec4 encoded) {
float value1 = (encoded.r * 255.0 * 256.0) + (encoded.g * 255.0);
float value2 = (encoded.b * 255.0 * 256.0) + (encoded.a * 255.0);
value1 /= 65535.0;
value2 /= 65535.0;
return vec2(value1, value2);
}
in vec2 vUv0;
#else
uniform sampler2D tDepth;
uniform sampler2D tDiffuse;
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float velocityFactor;
uniform vec2 texelSize;
uniform mat4 invViewProjMatrix;
uniform mat4 prevViewProjMatrix;
#endif
void main() {
#ifdef DEV_NEW_RENDER_ARCHITECTURE
vec4 encodedPrevFrameUv = texture(tReprojectedUv, vUv0);
vec2 prevFrameUv = decodeNormalizedFloatsFromRGBA8(encodedPrevFrameUv);
vec2 borderCheck = abs(prevFrameUv * 2.0 - vec2(1.0));
float velocityBorderMultiplier = (borderCheck.x >= 1.0 || borderCheck.y >= 1.0) ? 0.0 : 1.0;
vec2 velocity = velocityBorderMultiplier * velocityFactor *
clamp((vUv0 - prevFrameUv), vec2(-0.01), vec2(0.01));
vec2 coord = vUv0;
#else
vec2 coord = gl_FragCoord.xy * texelSize;
float zOverW = texture(tDepth, coord).r;
vec4 H = vec4(coord.x * 2.0 - 1.0, (1.0 - coord.y) * 2.0 - 1.0, zOverW, 1.0);
vec4 D = H * invViewProjMatrix;
vec4 worldPos = D / D.w;
vec4 currentPos = H;
vec4 previousPos = worldPos * prevViewProjMatrix;
previousPos /= previousPos.w;
vec2 velocity =
velocityFactor * clamp((currentPos.xy - previousPos.xy) / 2.0, vec2(-0.01), vec2(0.01));
#endif  // DEV_NEW_RENDER_ARCHITECTURE
vec4 color = texture(tDiffuse, coord);
const int samples = 20;
vec2 offset = vec2(0.0);
vec4 finalColor = color;
if (velocity.x > 0.0 || velocity.y > 0.0) {
for (int i = 1; i < samples; i++) {
offset = velocity * (float(i) / (float(samples) - 1.0) - 0.5);
vec4 currentColor = texture(tDiffuse, coord + offset);
color += currentColor;
}
finalColor = color / float(samples);
}
fragColor = vec4(finalColor.rgb, 1.0);
}
`,"motion_blur_vertex.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform CameraBuffer {
mat4 projectionMatrix;
mat4 viewProjMatrix;
mat4 viewMatrix;
mat4 invViewMatrix;
vec4 cameraPosition_pad;
};
#define uCameraPosition cameraPosition_pad.xyz
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#define INSERT_MODEL_VIEW_MATRIX
#define MODEL_MATRIX
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = projectionMatrix * modelViewMatrix * worldPos;
}
#else  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec4 worldPos) {
#ifdef MODEL_MATRIX
gl_Position = viewProjMatrix * modelMatrix * worldPos;
#else
gl_Position = viewProjMatrix * worldPos;
#endif  // MODEL_MATRIX
}
#ifdef MODEL_MATRIX
#define INSERT_MODEL_VIEW_MATRIX mat4 modelViewMatrix = viewMatrix * modelMatrix;
#else
#define INSERT_MODEL_VIEW_MATRIX mat4 modelViewMatrix = viewMatrix;
#endif  // MODEL_MATRIX
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec3 worldPos) {
setClipPositionFromWorldPos(vec4(worldPos, 1.0));
}
void setClipPositionFromViewPos(in vec4 viewPos) {
gl_Position = projectionMatrix * viewPos;
}
void setClipPositionFromViewPos(in vec3 viewPos) {
setClipPositionFromViewPos(vec4(viewPos, 1.0));
}
vec3 multiplyPositionByModelMatrix(in vec4 position) {
#ifdef MODEL_MATRIX
return (modelMatrix * position).xyz;
#else
return position.xyz;
#endif
}
vec3 multiplyPositionByModelMatrix(in vec3 position) {
return multiplyPositionByModelMatrix(vec4(position, 1.0));
}
vec3 multiplyDirectionByModelMatrix(in vec3 direction) {
#ifdef MODEL_MATRIX
return (modelMatrix * vec4(direction, 0.0)).xyz;
#else
return direction;
#endif
}
void main() {
setClipPositionFromWorldPos(position);
}
`,"object_distance_vertex.glsl":`vec4 transformPosition() {
return vec4(t0.x * position.x + t0.y * position.y + t0.z * position.z + t0.w,
t1.x * position.x + t1.y * position.y + t1.z * position.z + t1.w,
t2.x * position.x + t2.y * position.y + t2.z * position.z + t2.w, 1.0);
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform CameraBuffer {
mat4 projectionMatrix;
mat4 viewProjMatrix;
mat4 viewMatrix;
mat4 invViewMatrix;
vec4 cameraPosition_pad;
};
#define uCameraPosition cameraPosition_pad.xyz
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#define INSERT_MODEL_VIEW_MATRIX
#define MODEL_MATRIX
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = projectionMatrix * modelViewMatrix * worldPos;
}
#else  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec4 worldPos) {
#ifdef MODEL_MATRIX
gl_Position = viewProjMatrix * modelMatrix * worldPos;
#else
gl_Position = viewProjMatrix * worldPos;
#endif  // MODEL_MATRIX
}
#ifdef MODEL_MATRIX
#define INSERT_MODEL_VIEW_MATRIX mat4 modelViewMatrix = viewMatrix * modelMatrix;
#else
#define INSERT_MODEL_VIEW_MATRIX mat4 modelViewMatrix = viewMatrix;
#endif  // MODEL_MATRIX
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec3 worldPos) {
setClipPositionFromWorldPos(vec4(worldPos, 1.0));
}
void setClipPositionFromViewPos(in vec4 viewPos) {
gl_Position = projectionMatrix * viewPos;
}
void setClipPositionFromViewPos(in vec3 viewPos) {
setClipPositionFromViewPos(vec4(viewPos, 1.0));
}
vec3 multiplyPositionByModelMatrix(in vec4 position) {
#ifdef MODEL_MATRIX
return (modelMatrix * position).xyz;
#else
return position.xyz;
#endif
}
vec3 multiplyPositionByModelMatrix(in vec3 position) {
return multiplyPositionByModelMatrix(vec4(position, 1.0));
}
vec3 multiplyDirectionByModelMatrix(in vec3 direction) {
#ifdef MODEL_MATRIX
return (modelMatrix * vec4(direction, 0.0)).xyz;
#else
return direction;
#endif
}
out vec3 vPositionW;
void main() {
vec4 transformedPosition = transformPosition();
vPositionW = multiplyPositionByModelMatrix(transformedPosition);
setClipPositionFromWorldPos(transformedPosition);
}
`,"object_id_distance_fragment.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform CameraBuffer {
mat4 projectionMatrix;
mat4 viewProjMatrix;
mat4 viewMatrix;
mat4 invViewMatrix;
vec4 cameraPosition_pad;
};
#define uCameraPosition cameraPosition_pad.xyz
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform int objectId;
#endif
in vec3 vPositionW;
void main(void) {
float cameraDistance = min(distance(uCameraPosition, vPositionW), 255.0);
int x = objectId / 256;
int y = objectId - 256 * x;
float z = floor(cameraDistance);
float a = fract(cameraDistance);
fragColor = vec4(float(x) / 255.0, float(y) / 255.0, z / 255.0, a);
}
`,"object_id_fragment.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform int objectId;
#endif
in vec3 vPositionW;
void main(void) {
int x = objectId / (256 * 256);
int y = (objectId - 256 * 256 * x) / 256;
int z = (objectId - 256 * 256 * x - 256 * y);
fragColor = vec4(float(x) / 255.0, float(y) / 255.0, float(z) / 255.0, 0);
}
`,"outline_fragment.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec3 uColor;
#endif
void main() {
fragColor = vec4(uColor, 1.0);
}
`,"outline_vertex.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform CameraBuffer {
mat4 projectionMatrix;
mat4 viewProjMatrix;
mat4 viewMatrix;
mat4 invViewMatrix;
vec4 cameraPosition_pad;
};
#define uCameraPosition cameraPosition_pad.xyz
#endif
vec4 transformPosition() {
return vec4(t0.x * position.x + t0.y * position.y + t0.z * position.z + t0.w,
t1.x * position.x + t1.y * position.y + t1.z * position.z + t1.w,
t2.x * position.x + t2.y * position.y + t2.z * position.z + t2.w, 1.0);
}
const float PI = 3.14159265358979;
const float RECIPROCAL_PI2 = 0.15915494;
float saturate(in float a) {
return clamp(a, 0.0, 1.0);
}
vec3 inverseTransformDirection(in vec3 normal, in mat4 matrix) {
return normalize((vec4(normal, 0.0) * matrix).xyz);
}
vec3 sphericalDecode(in vec2 spNormal) {
float theta = (spNormal.x / 254.0 + 0.5) * PI;
float phi = spNormal.y * (PI / 127.0);
float sinTheta = sin(theta);
return vec3(sinTheta * cos(phi), sinTheta * sin(phi), cos(theta));
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#define INSERT_MODEL_VIEW_MATRIX
#define MODEL_MATRIX
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = projectionMatrix * modelViewMatrix * worldPos;
}
#else  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec4 worldPos) {
#ifdef MODEL_MATRIX
gl_Position = viewProjMatrix * modelMatrix * worldPos;
#else
gl_Position = viewProjMatrix * worldPos;
#endif  // MODEL_MATRIX
}
#ifdef MODEL_MATRIX
#define INSERT_MODEL_VIEW_MATRIX mat4 modelViewMatrix = viewMatrix * modelMatrix;
#else
#define INSERT_MODEL_VIEW_MATRIX mat4 modelViewMatrix = viewMatrix;
#endif  // MODEL_MATRIX
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec3 worldPos) {
setClipPositionFromWorldPos(vec4(worldPos, 1.0));
}
void setClipPositionFromViewPos(in vec4 viewPos) {
gl_Position = projectionMatrix * viewPos;
}
void setClipPositionFromViewPos(in vec3 viewPos) {
setClipPositionFromViewPos(vec4(viewPos, 1.0));
}
vec3 multiplyPositionByModelMatrix(in vec4 position) {
#ifdef MODEL_MATRIX
return (modelMatrix * position).xyz;
#else
return position.xyz;
#endif
}
vec3 multiplyPositionByModelMatrix(in vec3 position) {
return multiplyPositionByModelMatrix(vec4(position, 1.0));
}
vec3 multiplyDirectionByModelMatrix(in vec3 direction) {
#ifdef MODEL_MATRIX
return (modelMatrix * vec4(direction, 0.0)).xyz;
#else
return direction;
#endif
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float thickness;
#endif
void main() {
vec3 n = sphericalDecode(sphericalNormal);
vec3 normal = vec3(t0.x * n.x + t0.y * n.y + t0.z * n.z, t1.x * n.x + t1.y * n.y + t1.z * n.z,
t2.x * n.x + t2.y * n.y + t2.z * n.z);
vec4 transformedPosition = transformPosition();
float distToCamera = uCameraPosition.z - transformedPosition.z;
vec4 movedPosition = vec4(transformedPosition.x - distToCamera * thickness * normal.x,
transformedPosition.y - distToCamera * thickness * normal.y,
transformedPosition.z, transformedPosition.w);
setClipPositionFromWorldPos(movedPosition);
}
`,"position_only_vertex.glsl":`vec4 transformPosition() {
return vec4(t0.x * position.x + t0.y * position.y + t0.z * position.z + t0.w,
t1.x * position.x + t1.y * position.y + t1.z * position.z + t1.w,
t2.x * position.x + t2.y * position.y + t2.z * position.z + t2.w, 1.0);
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform CameraBuffer {
mat4 projectionMatrix;
mat4 viewProjMatrix;
mat4 viewMatrix;
mat4 invViewMatrix;
vec4 cameraPosition_pad;
};
#define uCameraPosition cameraPosition_pad.xyz
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#define INSERT_MODEL_VIEW_MATRIX
#define MODEL_MATRIX
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = projectionMatrix * modelViewMatrix * worldPos;
}
#else  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec4 worldPos) {
#ifdef MODEL_MATRIX
gl_Position = viewProjMatrix * modelMatrix * worldPos;
#else
gl_Position = viewProjMatrix * worldPos;
#endif  // MODEL_MATRIX
}
#ifdef MODEL_MATRIX
#define INSERT_MODEL_VIEW_MATRIX mat4 modelViewMatrix = viewMatrix * modelMatrix;
#else
#define INSERT_MODEL_VIEW_MATRIX mat4 modelViewMatrix = viewMatrix;
#endif  // MODEL_MATRIX
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec3 worldPos) {
setClipPositionFromWorldPos(vec4(worldPos, 1.0));
}
void setClipPositionFromViewPos(in vec4 viewPos) {
gl_Position = projectionMatrix * viewPos;
}
void setClipPositionFromViewPos(in vec3 viewPos) {
setClipPositionFromViewPos(vec4(viewPos, 1.0));
}
vec3 multiplyPositionByModelMatrix(in vec4 position) {
#ifdef MODEL_MATRIX
return (modelMatrix * position).xyz;
#else
return position.xyz;
#endif
}
vec3 multiplyPositionByModelMatrix(in vec3 position) {
return multiplyPositionByModelMatrix(vec4(position, 1.0));
}
vec3 multiplyDirectionByModelMatrix(in vec3 direction) {
#ifdef MODEL_MATRIX
return (modelMatrix * vec4(direction, 0.0)).xyz;
#else
return direction;
#endif
}
void main() {
setClipPositionFromWorldPos(transformPosition());
}
`,"postprocess_vertex.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform GlobalBuffer {
mat4 unjitteredInvProjMatrix;
mat4 unjitteredPrevViewProjMatrix;
vec4 viewSpaceFrustumRayDirections[4];
vec4 viewSpaceFrustumRayOrigins[4];
vec2 zNear_zFar;
vec4 fogDistStart_DistDensity_HeightStart_HeightDensity;
vec4 fogColor;
vec4 camera_exposure_gamma;
float colorMapIntensity;
float time;
vec2 texelSize;
vec2 renderTargetSize;
float deltaTime;
float velocityFactor;
vec2 jitterOffset;
float temporalAaHistoryWeight;
bool allTaaSamplesAccumulated;
vec2 neighbourhoodTexelOffsets[8];
float accumulatedStaticTaaSamples;
vec4 screenResolution;
float lightmapMode;
float dynamicTaaHistoryMultiplier;
};
#define uFogColor fogColor.xyz
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform CameraBuffer {
mat4 projectionMatrix;
mat4 viewProjMatrix;
mat4 viewMatrix;
mat4 invViewMatrix;
vec4 cameraPosition_pad;
};
#define uCameraPosition cameraPosition_pad.xyz
#endif
out vec2 vUv0;
out vec3 vWorldRayDir;
out vec3 vWorldRayOrigin;
void main() {
gl_Position = vec4(position, 1.0);
vUv0 = uv0;
vec4 nearHomogenousCorner = vec4(position.x, position.y, -1.0, 1.0);
vec4 farHomogenousCorner = vec4(position.x, position.y, 1.0, 1.0);
vec4 nearPos = unjitteredInvProjMatrix * nearHomogenousCorner;
vec4 farPos = unjitteredInvProjMatrix * farHomogenousCorner;
nearPos /= nearPos.w;
farPos /= farPos.w;
vWorldRayDir = vec3(farPos - nearPos);
vWorldRayDir /= vWorldRayDir.z;
vWorldRayOrigin = nearPos.xyz - vWorldRayDir * nearPos.z;
vWorldRayDir = vec3(invViewMatrix * vec4(vWorldRayDir, 0.0));
vWorldRayOrigin = vec3(invViewMatrix * vec4(vWorldRayOrigin, 1.0));
}
`,"procedural_sky_fragment.glsl":`const float PI = 3.14159265358979;
const float RECIPROCAL_PI2 = 0.15915494;
float saturate(in float a) {
return clamp(a, 0.0, 1.0);
}
vec3 inverseTransformDirection(in vec3 normal, in mat4 matrix) {
return normalize((vec4(normal, 0.0) * matrix).xyz);
}
float _g2l(in float x) {
return (x <= 0.04045) ? x / 12.92 : pow((x + 0.055) / 1.055, 2.4);
}
vec3 gammaToLinear(in vec3 rgb) {
return vec3(_g2l(rgb.r), _g2l(rgb.g), _g2l(rgb.b));
}
float _l2g(in float x) {
return (x <= 0.0031308) ? x * 12.92 : pow(x, 1.0 / 2.4) * 1.055 - 0.055;
}
vec3 linearToGamma(in vec3 rgb) {
return vec3(_l2g(rgb.r), _l2g(rgb.g), _l2g(rgb.b));
}
vec3 hable(in vec3 rgb) {
float A = 0.15;  // shoulderStrength
float B = 0.50;  // linearStrength
float C = 0.10;  // linearAngle
float D = 0.20;  // toeStrength
float E = 0.02;  // toeNumerator
float F = 0.30;  // toeDenominator
return ((rgb * (A * rgb + C * B) + D * E) / (rgb * (A * rgb + B) + D * F)) - E / F;
}
vec3 toneMappingHable(in vec3 rgb) {
float exposure = 11.2;
float exposureBias = 2.0;
vec3 current = hable(exposureBias * rgb);
vec3 whiteScale = 1.0 / hable(vec3(exposure));
return pow(current * whiteScale, vec3(1.0 / 2.2));
}
vec3 uchimura(in vec3 x, in float P, in float a, in float m, in float l, in float c, in float b) {
float l0 = ((P - m) * l) / a;
float L0 = m - m / a;
float L1 = m + (1.0 - m) / a;
float S0 = m + l0;
float S1 = m + a * l0;
float C2 = (a * P) / (P - S1);
float CP = -C2 / P;
vec3 w0 = vec3(1.0 - smoothstep(0.0, m, x));
vec3 w2 = vec3(step(m + l0, x));
vec3 w1 = vec3(1.0 - w0 - w2);
vec3 T = vec3(m * pow(x / m, vec3(c)) + b);
vec3 S = vec3(P - (P - S1) * exp(CP * (x - S0)));
vec3 L = vec3(m + a * (x - m));
return T * w0 + L * w1 + S * w2;
}
vec3 toneMappingUchimura(in vec3 rgb) {
float P = 1.0;   // max display brightness
float a = 1.0;   // contrast
float m = 0.22;  // linear section start
float l = 0.4;   // linear section length
float c = 1.45;  // black
float b = 0.0;   // pedestal
return pow(uchimura(rgb, P, a, m, l, c, b), vec3(1.0 / 2.2));
}
vec3 toneMappingUnreal(in vec3 rgb) {
return rgb / (rgb + 0.187) * 1.035;
}
vec3 linearToGammaToneMapped(in vec3 rgb) {
#ifdef TONE_MAPPING_UNREAL
return toneMappingUnreal(rgb);
#endif
#ifdef TONE_MAPPING_HABLE
return toneMappingHable(rgb);
#endif
#ifdef TONE_MAPPING_UCHIMURA
return toneMappingUchimura(rgb);
#endif
return toneMappingUnreal(rgb);
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform GlobalBuffer {
mat4 unjitteredInvProjMatrix;
mat4 unjitteredPrevViewProjMatrix;
vec4 viewSpaceFrustumRayDirections[4];
vec4 viewSpaceFrustumRayOrigins[4];
vec2 zNear_zFar;
vec4 fogDistStart_DistDensity_HeightStart_HeightDensity;
vec4 fogColor;
vec4 camera_exposure_gamma;
float colorMapIntensity;
float time;
vec2 texelSize;
vec2 renderTargetSize;
float deltaTime;
float velocityFactor;
vec2 jitterOffset;
float temporalAaHistoryWeight;
bool allTaaSamplesAccumulated;
vec2 neighbourhoodTexelOffsets[8];
float accumulatedStaticTaaSamples;
vec4 screenResolution;
float lightmapMode;
float dynamicTaaHistoryMultiplier;
};
#define uFogColor fogColor.xyz
#endif
#ifdef USE_FOG
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec4 fogDistStart_DistDensity_HeightStart_HeightDensity;
uniform vec3 uFogColor;
#endif
const float LOG2 = 1.442695;
vec3 addFog(in vec3 colorIn, in float distance, in vec3 positionW) {
float distanceValue = max(0.0, distance - fogDistStart_DistDensity_HeightStart_HeightDensity.x);
float distanceDensity = fogDistStart_DistDensity_HeightStart_HeightDensity.y;
float distanceFogExp =
1.0 - exp2(-distanceDensity * distanceDensity * distanceValue * distanceValue * LOG2);
float heightValue = max(0.0, -positionW.z + fogDistStart_DistDensity_HeightStart_HeightDensity.z);
float heightDensity = fogDistStart_DistDensity_HeightStart_HeightDensity.w;
float heightFogExp =
1.0 - exp2(-heightDensity * heightDensity * heightValue * heightValue * LOG2);
float fogAmount = min(1.0, distanceFogExp + heightFogExp);
return mix(colorIn, uFogColor.xyz, fogAmount);
}
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec3 uTopColor;
uniform vec3 uBottomColor;
uniform float sinBottomAngle;
uniform float exponent;
uniform vec4 camera_exposure_gamma;
#endif
in vec3 vWorldDirection;
#ifdef USE_FOG
in vec3 vPositionW;
in vec3 vPositionV;
#endif
#ifdef HDR_OUTPUT
vec4 hdrEncode(in vec3 rgb) {
const float rgbmScale = 2.82842712;  // sqrt(8)
vec3 r = sqrt(rgb) / rgbmScale;
float m = max(max(r.r, r.g), r.b);
m = clamp(m, 1.0 / 255.0, 1.0);
m = ceil(m * 255.0) / 255.0;
r /= m;
return vec4(r.r, r.g, r.b, (1.0 - m));
}
#endif
#ifdef USE_COLORMAP
vec3 colormap(in sampler2D lut, in vec3 color, in float intensity) {
const float resolution = 16.0;
const float maxValueIndex = resolution - 1.0;
const float sliceWidth = 1.0 / resolution;
const float slicePixelWidth = sliceWidth / resolution;
const float sliceMarginWidth = 0.5 * slicePixelWidth;
const float sliceInnerWidth = sliceWidth - slicePixelWidth;
const float slicePixelHeight = 1.0 / resolution;
const float sliceMarginHeight = 0.5 * slicePixelHeight;
const float sliceInnerHeight = 1.0 - slicePixelHeight;
float bSlice0 = min(floor(color.b * maxValueIndex), maxValueIndex - 1.0);
float bSlice1 = bSlice0 + 1.0;
float bOffset = color.b * maxValueIndex - bSlice0;
float rSlicePos = sliceMarginWidth + color.r * sliceInnerWidth;
float gSlicePos = sliceMarginHeight + color.g * sliceInnerHeight;
float rPos0 = rSlicePos + (bSlice0 * sliceWidth);
float rPos1 = rSlicePos + (bSlice1 * sliceWidth);
vec3 color0 = texture(lut, vec2(rPos0, gSlicePos)).rgb;
vec3 color1 = texture(lut, vec2(rPos1, gSlicePos)).rgb;
return mix(color, mix(color0, color1, bOffset), intensity);
}
uniform sampler2D colorMap;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float colorMapIntensity;
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
#endif
void main() {
float sinDirection = normalize(vWorldDirection).z;
float w = max(0.0, (sinDirection - sinBottomAngle) / (1.0 - sinBottomAngle));
vec3 colorGamma = mix(uBottomColor, uTopColor, pow(w, exponent));
vec3 colorLinear = gammaToLinear(colorGamma);
#ifdef USE_FOG
float distance = length(vPositionV);
colorLinear = addFog(colorLinear, distance, vPositionW);
#endif
#ifdef HDR_OUTPUT
fragColor = hdrEncode(10.0 * colorLinear);
#else
#ifdef USE_FOG
vec3 colorExposed = pow(camera_exposure_gamma.x * colorLinear, vec3(camera_exposure_gamma.y));
colorGamma = linearToGammaToneMapped(colorExposed);
#endif
#ifdef USE_COLORMAP
fragColor = vec4(colormap(colorMap, colorGamma, colorMapIntensity), 1.0);
#else
fragColor = vec4(colorGamma, 1.0);
#endif
#endif
}
`,"procedural_sky_vertex.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform CameraBuffer {
mat4 projectionMatrix;
mat4 viewProjMatrix;
mat4 viewMatrix;
mat4 invViewMatrix;
vec4 cameraPosition_pad;
};
#define uCameraPosition cameraPosition_pad.xyz
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#define INSERT_MODEL_VIEW_MATRIX
#define MODEL_MATRIX
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = projectionMatrix * modelViewMatrix * worldPos;
}
#else  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec4 worldPos) {
#ifdef MODEL_MATRIX
gl_Position = viewProjMatrix * modelMatrix * worldPos;
#else
gl_Position = viewProjMatrix * worldPos;
#endif  // MODEL_MATRIX
}
#ifdef MODEL_MATRIX
#define INSERT_MODEL_VIEW_MATRIX mat4 modelViewMatrix = viewMatrix * modelMatrix;
#else
#define INSERT_MODEL_VIEW_MATRIX mat4 modelViewMatrix = viewMatrix;
#endif  // MODEL_MATRIX
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec3 worldPos) {
setClipPositionFromWorldPos(vec4(worldPos, 1.0));
}
void setClipPositionFromViewPos(in vec4 viewPos) {
gl_Position = projectionMatrix * viewPos;
}
void setClipPositionFromViewPos(in vec3 viewPos) {
setClipPositionFromViewPos(vec4(viewPos, 1.0));
}
vec3 multiplyPositionByModelMatrix(in vec4 position) {
#ifdef MODEL_MATRIX
return (modelMatrix * position).xyz;
#else
return position.xyz;
#endif
}
vec3 multiplyPositionByModelMatrix(in vec3 position) {
return multiplyPositionByModelMatrix(vec4(position, 1.0));
}
vec3 multiplyDirectionByModelMatrix(in vec3 direction) {
#ifdef MODEL_MATRIX
return (modelMatrix * vec4(direction, 0.0)).xyz;
#else
return direction;
#endif
}
#ifdef USE_FOG
out vec3 vPositionW;
out vec3 vPositionV;
#endif
out vec3 vWorldDirection;
void main() {
vec3 positionW = multiplyPositionByModelMatrix(position);
vWorldDirection = positionW - uCameraPosition;
#ifdef USE_FOG
INSERT_MODEL_VIEW_MATRIX
vPositionW = positionW;
vPositionV = -(modelViewMatrix * vec4(position, 1.0)).xyz;
setClipPositionFromViewPos(-vPositionV);
#else
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
#else
gl_Position = viewProjMatrix * vec4(positionW, 1.0);
#endif
#endif
}
`,"reprojected_position_fragment.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform GlobalBuffer {
mat4 unjitteredInvProjMatrix;
mat4 unjitteredPrevViewProjMatrix;
vec4 viewSpaceFrustumRayDirections[4];
vec4 viewSpaceFrustumRayOrigins[4];
vec2 zNear_zFar;
vec4 fogDistStart_DistDensity_HeightStart_HeightDensity;
vec4 fogColor;
vec4 camera_exposure_gamma;
float colorMapIntensity;
float time;
vec2 texelSize;
vec2 renderTargetSize;
float deltaTime;
float velocityFactor;
vec2 jitterOffset;
float temporalAaHistoryWeight;
bool allTaaSamplesAccumulated;
vec2 neighbourhoodTexelOffsets[8];
float accumulatedStaticTaaSamples;
vec4 screenResolution;
float lightmapMode;
float dynamicTaaHistoryMultiplier;
};
#define uFogColor fogColor.xyz
#endif
vec4 encodeNormalizedFloatsToRGBA8(float value1, float value2) {
float scaledValue1 = value1 * 65535.0;
float scaledValue2 = value2 * 65535.0;
vec4 encoded;
encoded.r = floor(scaledValue1 / 256.0) / 255.0;                 // High byte
encoded.g = floor(fract(scaledValue1 / 256.0) * 256.0) / 255.0;  // Low byte
encoded.b = floor(scaledValue2 / 256.0) / 255.0;                 // High byte
encoded.a = floor(fract(scaledValue2 / 256.0) * 256.0) / 255.0;  // Low byte
return encoded;
}
in vec4 vPrevPosition;
void main() {
vec2 prevPos = vPrevPosition.xy / vPrevPosition.w;
prevPos = prevPos * 0.5 + vec2(0.5, 0.5);
reprojectedUvResult = encodeNormalizedFloatsToRGBA8(prevPos.x, prevPos.y);
}
`,"reprojected_position_vertex.glsl":`vec4 transformPosition() {
return vec4(t0.x * position.x + t0.y * position.y + t0.z * position.z + t0.w,
t1.x * position.x + t1.y * position.y + t1.z * position.z + t1.w,
t2.x * position.x + t2.y * position.y + t2.z * position.z + t2.w, 1.0);
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform CameraBuffer {
mat4 projectionMatrix;
mat4 viewProjMatrix;
mat4 viewMatrix;
mat4 invViewMatrix;
vec4 cameraPosition_pad;
};
#define uCameraPosition cameraPosition_pad.xyz
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#define INSERT_MODEL_VIEW_MATRIX
#define MODEL_MATRIX
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = projectionMatrix * modelViewMatrix * worldPos;
}
#else  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec4 worldPos) {
#ifdef MODEL_MATRIX
gl_Position = viewProjMatrix * modelMatrix * worldPos;
#else
gl_Position = viewProjMatrix * worldPos;
#endif  // MODEL_MATRIX
}
#ifdef MODEL_MATRIX
#define INSERT_MODEL_VIEW_MATRIX mat4 modelViewMatrix = viewMatrix * modelMatrix;
#else
#define INSERT_MODEL_VIEW_MATRIX mat4 modelViewMatrix = viewMatrix;
#endif  // MODEL_MATRIX
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec3 worldPos) {
setClipPositionFromWorldPos(vec4(worldPos, 1.0));
}
void setClipPositionFromViewPos(in vec4 viewPos) {
gl_Position = projectionMatrix * viewPos;
}
void setClipPositionFromViewPos(in vec3 viewPos) {
setClipPositionFromViewPos(vec4(viewPos, 1.0));
}
vec3 multiplyPositionByModelMatrix(in vec4 position) {
#ifdef MODEL_MATRIX
return (modelMatrix * position).xyz;
#else
return position.xyz;
#endif
}
vec3 multiplyPositionByModelMatrix(in vec3 position) {
return multiplyPositionByModelMatrix(vec4(position, 1.0));
}
vec3 multiplyDirectionByModelMatrix(in vec3 direction) {
#ifdef MODEL_MATRIX
return (modelMatrix * vec4(direction, 0.0)).xyz;
#else
return direction;
#endif
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform GlobalBuffer {
mat4 unjitteredInvProjMatrix;
mat4 unjitteredPrevViewProjMatrix;
vec4 viewSpaceFrustumRayDirections[4];
vec4 viewSpaceFrustumRayOrigins[4];
vec2 zNear_zFar;
vec4 fogDistStart_DistDensity_HeightStart_HeightDensity;
vec4 fogColor;
vec4 camera_exposure_gamma;
float colorMapIntensity;
float time;
vec2 texelSize;
vec2 renderTargetSize;
float deltaTime;
float velocityFactor;
vec2 jitterOffset;
float temporalAaHistoryWeight;
bool allTaaSamplesAccumulated;
vec2 neighbourhoodTexelOffsets[8];
float accumulatedStaticTaaSamples;
vec4 screenResolution;
float lightmapMode;
float dynamicTaaHistoryMultiplier;
};
#define uFogColor fogColor.xyz
#endif
out vec4 vPrevPosition;
void main() {
vec4 worldPos = transformPosition();
setClipPositionFromWorldPos(worldPos);
vPrevPosition = unjitteredPrevViewProjMatrix * prevModelMatrix * worldPos;
}
`,"reprojected_uv_fragment.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform GlobalBuffer {
mat4 unjitteredInvProjMatrix;
mat4 unjitteredPrevViewProjMatrix;
vec4 viewSpaceFrustumRayDirections[4];
vec4 viewSpaceFrustumRayOrigins[4];
vec2 zNear_zFar;
vec4 fogDistStart_DistDensity_HeightStart_HeightDensity;
vec4 fogColor;
vec4 camera_exposure_gamma;
float colorMapIntensity;
float time;
vec2 texelSize;
vec2 renderTargetSize;
float deltaTime;
float velocityFactor;
vec2 jitterOffset;
float temporalAaHistoryWeight;
bool allTaaSamplesAccumulated;
vec2 neighbourhoodTexelOffsets[8];
float accumulatedStaticTaaSamples;
vec4 screenResolution;
float lightmapMode;
float dynamicTaaHistoryMultiplier;
};
#define uFogColor fogColor.xyz
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform CameraBuffer {
mat4 projectionMatrix;
mat4 viewProjMatrix;
mat4 viewMatrix;
mat4 invViewMatrix;
vec4 cameraPosition_pad;
};
#define uCameraPosition cameraPosition_pad.xyz
#endif
in vec2 vUv0;
in vec3 vWorldRayDir;
in vec3 vWorldRayOrigin;
float getLinearDepth(float depth) {
float zNdc = depth * 2.0 - 1.0;
float m22 = projectionMatrix[2][2];
float m23 = projectionMatrix[2][3];
float m32 = projectionMatrix[3][2];
float m33 = projectionMatrix[3][3];
return -(zNdc * m33 - m32) / (zNdc * m23 - m22);
}
vec3 getWorldPosFromDepth(float depth) {
float linearDepth = getLinearDepth(depth);
return vWorldRayOrigin + vWorldRayDir * linearDepth;
}
vec2 getPrevFrameReprojectedUv(float depth) {
vec3 worldPos = getWorldPosFromDepth(depth);
vec4 prevPos = unjitteredPrevViewProjMatrix * vec4(worldPos, 1.0);
return vec2(prevPos.xy / prevPos.w) * 0.5 + 0.5;
}
vec4 encodeNormalizedFloatsToRGBA8(float value1, float value2) {
float scaledValue1 = value1 * 65535.0;
float scaledValue2 = value2 * 65535.0;
vec4 encoded;
encoded.r = floor(scaledValue1 / 256.0) / 255.0;                 // High byte
encoded.g = floor(fract(scaledValue1 / 256.0) * 256.0) / 255.0;  // Low byte
encoded.b = floor(scaledValue2 / 256.0) / 255.0;                 // High byte
encoded.a = floor(fract(scaledValue2 / 256.0) * 256.0) / 255.0;  // Low byte
return encoded;
}
vec2 getReprojectedUv(vec2 uv) {
float currentDepth = texture(tDepth, uv).r;
vec2 reprojectedUv = getPrevFrameReprojectedUv(currentDepth);
return reprojectedUv;
}
void main() {
vec2 reprojectedUv = getReprojectedUv(vUv0);
vec4 encodedUv = encodeNormalizedFloatsToRGBA8(reprojectedUv.x, reprojectedUv.y);
reprojectedUvResult = encodedUv;
}
`,"rotate_gizmo_material_fragment.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform CameraBuffer {
mat4 projectionMatrix;
mat4 viewProjMatrix;
mat4 viewMatrix;
mat4 invViewMatrix;
vec4 cameraPosition_pad;
};
#define uCameraPosition cameraPosition_pad.xyz
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec3 uColor;
uniform float opacity;
uniform vec3 uGizmoPosition;
uniform float sphereRadius;
#endif
in vec4 mPosition;
void discardIfRayIntersectsSphere(vec3 r0, vec3 rd, vec3 s0, float sr) {
float a = dot(rd, rd);
vec3 s0_r0 = r0 - s0;
float b = 2.0 * dot(rd, s0_r0);
float c = dot(s0_r0, s0_r0) - (sr * sr);
float delta = b * b - 4.0 * a * c;
if (delta >= 0.0 && -b - sqrt(delta) > 0.0) {
discard;
}
}
void main() {
vec4 outColor;
outColor.rgb = uColor;
outColor.a = opacity;
vec3 toCamera = normalize(uCameraPosition - uGizmoPosition);
discardIfRayIntersectsSphere(mPosition.xyz, toCamera, uGizmoPosition, sphereRadius);
fragColor = outColor;
}
`,"rotate_gizmo_material_vertex.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform CameraBuffer {
mat4 projectionMatrix;
mat4 viewProjMatrix;
mat4 viewMatrix;
mat4 invViewMatrix;
vec4 cameraPosition_pad;
};
#define uCameraPosition cameraPosition_pad.xyz
#endif
vec4 transformPosition() {
return vec4(t0.x * position.x + t0.y * position.y + t0.z * position.z + t0.w,
t1.x * position.x + t1.y * position.y + t1.z * position.z + t1.w,
t2.x * position.x + t2.y * position.y + t2.z * position.z + t2.w, 1.0);
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#define INSERT_MODEL_VIEW_MATRIX
#define MODEL_MATRIX
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = projectionMatrix * modelViewMatrix * worldPos;
}
#else  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec4 worldPos) {
#ifdef MODEL_MATRIX
gl_Position = viewProjMatrix * modelMatrix * worldPos;
#else
gl_Position = viewProjMatrix * worldPos;
#endif  // MODEL_MATRIX
}
#ifdef MODEL_MATRIX
#define INSERT_MODEL_VIEW_MATRIX mat4 modelViewMatrix = viewMatrix * modelMatrix;
#else
#define INSERT_MODEL_VIEW_MATRIX mat4 modelViewMatrix = viewMatrix;
#endif  // MODEL_MATRIX
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec3 worldPos) {
setClipPositionFromWorldPos(vec4(worldPos, 1.0));
}
void setClipPositionFromViewPos(in vec4 viewPos) {
gl_Position = projectionMatrix * viewPos;
}
void setClipPositionFromViewPos(in vec3 viewPos) {
setClipPositionFromViewPos(vec4(viewPos, 1.0));
}
vec3 multiplyPositionByModelMatrix(in vec4 position) {
#ifdef MODEL_MATRIX
return (modelMatrix * position).xyz;
#else
return position.xyz;
#endif
}
vec3 multiplyPositionByModelMatrix(in vec3 position) {
return multiplyPositionByModelMatrix(vec4(position, 1.0));
}
vec3 multiplyDirectionByModelMatrix(in vec3 direction) {
#ifdef MODEL_MATRIX
return (modelMatrix * vec4(direction, 0.0)).xyz;
#else
return direction;
#endif
}
out vec4 mPosition;
void main() {
mPosition = vec4(multiplyPositionByModelMatrix(position), 1.0);
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);
gl_Position = projectionMatrix * mvPosition;
#else
gl_Position = viewProjMatrix * mPosition;
#endif
}
`,"screen_space_uv_fragment.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform GlobalBuffer {
mat4 unjitteredInvProjMatrix;
mat4 unjitteredPrevViewProjMatrix;
vec4 viewSpaceFrustumRayDirections[4];
vec4 viewSpaceFrustumRayOrigins[4];
vec2 zNear_zFar;
vec4 fogDistStart_DistDensity_HeightStart_HeightDensity;
vec4 fogColor;
vec4 camera_exposure_gamma;
float colorMapIntensity;
float time;
vec2 texelSize;
vec2 renderTargetSize;
float deltaTime;
float velocityFactor;
vec2 jitterOffset;
float temporalAaHistoryWeight;
bool allTaaSamplesAccumulated;
vec2 neighbourhoodTexelOffsets[8];
float accumulatedStaticTaaSamples;
vec4 screenResolution;
float lightmapMode;
float dynamicTaaHistoryMultiplier;
};
#define uFogColor fogColor.xyz
#endif
vec4 encodeNormalizedFloatsToRGBA8(float value1, float value2) {
float scaledValue1 = value1 * 65535.0;
float scaledValue2 = value2 * 65535.0;
vec4 encoded;
encoded.r = floor(scaledValue1 / 256.0) / 255.0;                 // High byte
encoded.g = floor(fract(scaledValue1 / 256.0) * 256.0) / 255.0;  // Low byte
encoded.b = floor(scaledValue2 / 256.0) / 255.0;                 // High byte
encoded.a = floor(fract(scaledValue2 / 256.0) * 256.0) / 255.0;  // Low byte
return encoded;
}
void main() {
vec2 uv = gl_FragCoord.xy * texelSize;
vec4 encodedUv = encodeNormalizedFloatsToRGBA8(uv.x, uv.y);
reprojectedUvResult = encodedUv;
}
`,"screen_space_uv_vertex.glsl":`vec4 transformPosition() {
return vec4(t0.x * position.x + t0.y * position.y + t0.z * position.z + t0.w,
t1.x * position.x + t1.y * position.y + t1.z * position.z + t1.w,
t2.x * position.x + t2.y * position.y + t2.z * position.z + t2.w, 1.0);
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform CameraBuffer {
mat4 projectionMatrix;
mat4 viewProjMatrix;
mat4 viewMatrix;
mat4 invViewMatrix;
vec4 cameraPosition_pad;
};
#define uCameraPosition cameraPosition_pad.xyz
#endif
void main() {
gl_Position = projectionMatrix * transformPosition();
}
`,"sprite_vertex.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform CameraBuffer {
mat4 projectionMatrix;
mat4 viewProjMatrix;
mat4 viewMatrix;
mat4 invViewMatrix;
vec4 cameraPosition_pad;
};
#define uCameraPosition cameraPosition_pad.xyz
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#define INSERT_MODEL_VIEW_MATRIX
#define MODEL_MATRIX
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = projectionMatrix * modelViewMatrix * worldPos;
}
#else  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec4 worldPos) {
#ifdef MODEL_MATRIX
gl_Position = viewProjMatrix * modelMatrix * worldPos;
#else
gl_Position = viewProjMatrix * worldPos;
#endif  // MODEL_MATRIX
}
#ifdef MODEL_MATRIX
#define INSERT_MODEL_VIEW_MATRIX mat4 modelViewMatrix = viewMatrix * modelMatrix;
#else
#define INSERT_MODEL_VIEW_MATRIX mat4 modelViewMatrix = viewMatrix;
#endif  // MODEL_MATRIX
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec3 worldPos) {
setClipPositionFromWorldPos(vec4(worldPos, 1.0));
}
void setClipPositionFromViewPos(in vec4 viewPos) {
gl_Position = projectionMatrix * viewPos;
}
void setClipPositionFromViewPos(in vec3 viewPos) {
setClipPositionFromViewPos(vec4(viewPos, 1.0));
}
vec3 multiplyPositionByModelMatrix(in vec4 position) {
#ifdef MODEL_MATRIX
return (modelMatrix * position).xyz;
#else
return position.xyz;
#endif
}
vec3 multiplyPositionByModelMatrix(in vec3 position) {
return multiplyPositionByModelMatrix(vec4(position, 1.0));
}
vec3 multiplyDirectionByModelMatrix(in vec3 direction) {
#ifdef MODEL_MATRIX
return (modelMatrix * vec4(direction, 0.0)).xyz;
#else
return direction;
#endif
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec3 uOffset;
#endif
#ifdef USE_FOG
out vec3 vPositionW;
out vec3 vPositionV;
#endif
out vec2 vUv0;
void main() {
vUv0 = uv0;
INSERT_MODEL_VIEW_MATRIX
vec4 mvPosition = modelViewMatrix * vec4(uOffset, 1.0);
vec2 scale;
#ifdef USE_FOG
vPositionW = multiplyPositionByModelMatrix(uOffset);
vPositionV = -mvPosition.xyz;
#endif
#ifdef MODEL_MATRIX
scale.x = length(modelMatrix[0].xyz);
scale.y = length(modelMatrix[1].xyz);
#else
scale = vec2(1.0);
#endif
vec2 alignedPosition = position.xy * scale;
mvPosition.xy += alignedPosition;
gl_Position = projectionMatrix * mvPosition;
}
`,"standard_material_fragment.glsl":`const float PI = 3.14159265358979;
const float RECIPROCAL_PI2 = 0.15915494;
float saturate(in float a) {
return clamp(a, 0.0, 1.0);
}
vec3 inverseTransformDirection(in vec3 normal, in mat4 matrix) {
return normalize((vec4(normal, 0.0) * matrix).xyz);
}
float _g2l(in float x) {
return (x <= 0.04045) ? x / 12.92 : pow((x + 0.055) / 1.055, 2.4);
}
vec3 gammaToLinear(in vec3 rgb) {
return vec3(_g2l(rgb.r), _g2l(rgb.g), _g2l(rgb.b));
}
float _l2g(in float x) {
return (x <= 0.0031308) ? x * 12.92 : pow(x, 1.0 / 2.4) * 1.055 - 0.055;
}
vec3 linearToGamma(in vec3 rgb) {
return vec3(_l2g(rgb.r), _l2g(rgb.g), _l2g(rgb.b));
}
vec3 hable(in vec3 rgb) {
float A = 0.15;  // shoulderStrength
float B = 0.50;  // linearStrength
float C = 0.10;  // linearAngle
float D = 0.20;  // toeStrength
float E = 0.02;  // toeNumerator
float F = 0.30;  // toeDenominator
return ((rgb * (A * rgb + C * B) + D * E) / (rgb * (A * rgb + B) + D * F)) - E / F;
}
vec3 toneMappingHable(in vec3 rgb) {
float exposure = 11.2;
float exposureBias = 2.0;
vec3 current = hable(exposureBias * rgb);
vec3 whiteScale = 1.0 / hable(vec3(exposure));
return pow(current * whiteScale, vec3(1.0 / 2.2));
}
vec3 uchimura(in vec3 x, in float P, in float a, in float m, in float l, in float c, in float b) {
float l0 = ((P - m) * l) / a;
float L0 = m - m / a;
float L1 = m + (1.0 - m) / a;
float S0 = m + l0;
float S1 = m + a * l0;
float C2 = (a * P) / (P - S1);
float CP = -C2 / P;
vec3 w0 = vec3(1.0 - smoothstep(0.0, m, x));
vec3 w2 = vec3(step(m + l0, x));
vec3 w1 = vec3(1.0 - w0 - w2);
vec3 T = vec3(m * pow(x / m, vec3(c)) + b);
vec3 S = vec3(P - (P - S1) * exp(CP * (x - S0)));
vec3 L = vec3(m + a * (x - m));
return T * w0 + L * w1 + S * w2;
}
vec3 toneMappingUchimura(in vec3 rgb) {
float P = 1.0;   // max display brightness
float a = 1.0;   // contrast
float m = 0.22;  // linear section start
float l = 0.4;   // linear section length
float c = 1.45;  // black
float b = 0.0;   // pedestal
return pow(uchimura(rgb, P, a, m, l, c, b), vec3(1.0 / 2.2));
}
vec3 toneMappingUnreal(in vec3 rgb) {
return rgb / (rgb + 0.187) * 1.035;
}
vec3 linearToGammaToneMapped(in vec3 rgb) {
#ifdef TONE_MAPPING_UNREAL
return toneMappingUnreal(rgb);
#endif
#ifdef TONE_MAPPING_HABLE
return toneMappingHable(rgb);
#endif
#ifdef TONE_MAPPING_UCHIMURA
return toneMappingUchimura(rgb);
#endif
return toneMappingUnreal(rgb);
}
vec4 cubic(in float v) {
vec4 n = vec4(1.0, 2.0, 3.0, 4.0) - v;
vec4 s = n * n * n;
float x = s.x;
float y = s.y - 4.0 * s.x;
float z = s.z - 4.0 * s.y + 6.0 * s.x;
float w = 6.0 - x - y - z;
return vec4(x, y, z, w) * (1.0 / 6.0);
}
vec3 hdrDecodeRgbm(in vec4 rgbm) {
const float rgbmScale = 2.82842712;  // sqrt(8)
float m = 1.0 - rgbm.a;
vec3 r = rgbm.rgb * (rgbmScale * m);
return r * r;
}
vec3 hdrDecodeYcocgm(in vec4 ycocgm, in vec2 threshold) {
const float ycocgmLumaRange = 16.0;
float m = ycocgm.w * (16.0 * 255.0 / 256.0) - 1.0;
float chroma_scale_factor = fract(m);
float y_factor = m - chroma_scale_factor;
chroma_scale_factor = 1.0 - chroma_scale_factor;
float factor = y_factor == ycocgmLumaRange - 2.0 ? 0.0 : 1.0;
float y = mix(ycocgm.x * threshold.x, (y_factor + ycocgm.x) * threshold.y + threshold.x, factor);
float co = (ycocgm.y - 0.5) * chroma_scale_factor;
float cg = (ycocgm.z - 0.5) * chroma_scale_factor;
return vec3(y, co, cg);
}
vec3 ycocgToRgb(in vec3 ycocg) {
float y = ycocg.x, co = ycocg.y, cg = ycocg.z;
y = y * y;
float r = saturate(y + co - cg);
float g = saturate(y + cg);
float b = saturate(y - co - cg);
return vec3(r, g, b) * 8.0;
}
/*vec3 hdrDecodeYcocgmBicubic(in sampler2D ycocgmSampler, in vec2 texSize, in vec2 invTexSize,
in vec2 threshold, in vec2 texCoords) {
vec2 texCoordsScaled = texCoords * texSize - 0.5;
vec2 fxy = fract(texCoordsScaled);
texCoordsScaled -= fxy;
vec4 xcubic = cubic(fxy.x), ycubic = cubic(fxy.y);
vec4 c = texCoordsScaled.xxyy + vec2(-0.5, +1.5).xyxy;
vec4 s = vec4(xcubic.xz + xcubic.yw, ycubic.xz + ycubic.yw);
vec4 offset = (c + vec4 (xcubic.yw, ycubic.yw) / s) * invTexSize.xxyy;
vec3 sample0 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.xz), threshold);
vec3 sample1 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.yz), threshold);
vec3 sample2 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.xw), threshold);
vec3 sample3 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.yw), threshold);
float sx = s.x / (s.x + s.y), sy = s.z / (s.z + s.w);
return mix(mix(sample3, sample2, sx), mix(sample1, sample0, sx), sy);
}*/
vec3 hdrDecodeYcocgmBilinear(in sampler2D ycocgmSampler, in vec2 texSize, in vec2 invTexSize,
in vec2 threshold, in vec2 texCoords) {
vec2 texCoordsScaled = texCoords * texSize - 0.5;
vec2 fxy = fract(texCoordsScaled);
texCoordsScaled -= fxy;
vec4 c = texCoordsScaled.xxyy + vec2(-0.5, +0.5).xyxy;
vec4 offset = c + vec4(1.0);
float sx = 1.0 - fxy.x;
float sy = 1.0 - fxy.y;
offset *= invTexSize.xxyy;
vec3 sample0 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.xz), threshold);
vec3 sample1 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.yz), threshold);
vec3 sample2 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.xw), threshold);
vec3 sample3 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.yw), threshold);
return mix(mix(sample3, sample2, sx), mix(sample1, sample0, sx), sy);
}
/*vec3 hdrDecodeRgbmBicubic(in sampler2D rgbmSampler, in vec2 texSize,
in vec2 invTexSize, in vec2 texCoords) {
vec2 texCoordsScaled = texCoords * texSize - 0.5;
vec2 fxy = fract(texCoordsScaled);
texCoordsScaled -= fxy;
vec4 xcubic = cubic(fxy.x), ycubic = cubic(fxy.y);
vec4 c = texCoordsScaled.xxyy + vec2(-0.5, +1.5).xyxy;
vec4 s = vec4(xcubic.xz + xcubic.yw, ycubic.xz + ycubic.yw);
vec4 offset = (c + vec4 (xcubic.yw, ycubic.yw) / s) * invTexSize.xxyy;
vec3 sample0 = hdrDecodeRgbm(texture(rgbmSampler, offset.xz));
vec3 sample1 = hdrDecodeRgbm(texture(rgbmSampler, offset.yz));
vec3 sample2 = hdrDecodeRgbm(texture(rgbmSampler, offset.xw));
vec3 sample3 = hdrDecodeRgbm(texture(rgbmSampler, offset.yw));
float sx = s.x / (s.x + s.y), sy = s.z / (s.z + s.w);
return mix(mix(sample3, sample2, sx), mix(sample1, sample0, sx), sy);
}*/
vec3 hdrDecodeRgbmBilinear(in sampler2D rgbmSampler, in vec2 texSize, in vec2 invTexSize,
in vec2 texCoords) {
vec2 texCoordsScaled = texCoords * texSize - 0.5;
vec2 fxy = fract(texCoordsScaled);
texCoordsScaled -= fxy;
vec4 c = texCoordsScaled.xxyy + vec2(-0.5, +0.5).xyxy;
vec4 offset = c + vec4(1.0);
float sx = 1.0 - fxy.x;
float sy = 1.0 - fxy.y;
offset *= invTexSize.xxyy;
vec3 sample0 = hdrDecodeRgbm(texture(rgbmSampler, offset.xz));
vec3 sample1 = hdrDecodeRgbm(texture(rgbmSampler, offset.yz));
vec3 sample2 = hdrDecodeRgbm(texture(rgbmSampler, offset.xw));
vec3 sample3 = hdrDecodeRgbm(texture(rgbmSampler, offset.yw));
return mix(mix(sample3, sample2, sx), mix(sample1, sample0, sx), sy);
}
struct ReflectionProbe {
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
vec3 boxMin;
vec3 boxMax;
vec3 posW;
#else
vec4 boxMin;
vec4 boxMax;
vec4 posW;
#endif
};
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform LightBuffer {
vec4 lightmapSize;
vec4 lightmapThreshold;
ReflectionProbe reflectionProbes[3];
int reflectionProbesCount;
};
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform GlobalBuffer {
mat4 unjitteredInvProjMatrix;
mat4 unjitteredPrevViewProjMatrix;
vec4 viewSpaceFrustumRayDirections[4];
vec4 viewSpaceFrustumRayOrigins[4];
vec2 zNear_zFar;
vec4 fogDistStart_DistDensity_HeightStart_HeightDensity;
vec4 fogColor;
vec4 camera_exposure_gamma;
float colorMapIntensity;
float time;
vec2 texelSize;
vec2 renderTargetSize;
float deltaTime;
float velocityFactor;
vec2 jitterOffset;
float temporalAaHistoryWeight;
bool allTaaSamplesAccumulated;
vec2 neighbourhoodTexelOffsets[8];
float accumulatedStaticTaaSamples;
vec4 screenResolution;
float lightmapMode;
float dynamicTaaHistoryMultiplier;
};
#define uFogColor fogColor.xyz
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform CameraBuffer {
mat4 projectionMatrix;
mat4 viewProjMatrix;
mat4 viewMatrix;
mat4 invViewMatrix;
vec4 cameraPosition_pad;
};
#define uCameraPosition cameraPosition_pad.xyz
#endif
#ifdef USE_FOG
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec4 fogDistStart_DistDensity_HeightStart_HeightDensity;
uniform vec3 uFogColor;
#endif
const float LOG2 = 1.442695;
vec3 addFog(in vec3 colorIn, in float distance, in vec3 positionW) {
float distanceValue = max(0.0, distance - fogDistStart_DistDensity_HeightStart_HeightDensity.x);
float distanceDensity = fogDistStart_DistDensity_HeightStart_HeightDensity.y;
float distanceFogExp =
1.0 - exp2(-distanceDensity * distanceDensity * distanceValue * distanceValue * LOG2);
float heightValue = max(0.0, -positionW.z + fogDistStart_DistDensity_HeightStart_HeightDensity.z);
float heightDensity = fogDistStart_DistDensity_HeightStart_HeightDensity.w;
float heightFogExp =
1.0 - exp2(-heightDensity * heightDensity * heightValue * heightValue * LOG2);
float fogAmount = min(1.0, distanceFogExp + heightFogExp);
return mix(colorIn, uFogColor.xyz, fogAmount);
}
#endif
#if defined(USE_ENVMAP) || defined(USE_HEADLIGHT) || defined(USE_FOG) || defined(LIVE_LIGHTMAP)
in vec3 vPositionW;
#endif
#if defined(USE_ENVMAP) || defined(USE_HEADLIGHT) || defined(LIVE_LIGHTMAP)
in vec3 vNormalW;
#endif
#if defined(USE_BASE_COLOR_TEXTURE) || defined(USE_ROUGHNESS_TEXTURE) ||                         \\
defined(USE_METALLIC_TEXTURE) || defined(USE_BUMP_TEXTURE) || defined(USE_HEIGHT_TEXTURE) || \\
defined(USE_NORMAL_TEXTURE)
in vec2 vUv0;
#endif
#if defined(USE_BUMP_TEXTURE) || defined(USE_FOG)
in vec3 vPositionV;
#endif
vec3 rgbToHsl(vec3 rgb) {
vec3 hsl = vec3(0.0);
float fMin = min(min(rgb.r, rgb.g), rgb.b);
float fMax = max(max(rgb.r, rgb.g), rgb.b);
float delta = fMax - fMin;
hsl.z = (fMax + fMin) / 2.0;  // Luminance
if (delta == 0.0) {
return hsl;
}
hsl.y = delta / ((hsl.z <= 0.5) ? (fMax + fMin) : (2.0 - fMax - fMin));
float denom = 6.0 * delta;
if (rgb.r == fMax) {
hsl.x = (rgb.g - rgb.b) / denom;
} else if (rgb.g == fMax) {
hsl.x = (rgb.b - rgb.r) / denom + (1.0 / 3.0);
} else if (rgb.b == fMax) {
hsl.x = (rgb.r - rgb.g) / denom + (2.0 / 3.0);
}
if (hsl.x < 0.0) {
hsl.x += 1.0;
}
if (hsl.x > 1.0) {
hsl.x -= 1.0;
}
return hsl;
}
float hueToRgb(float p, float q, float hue) {
if (hue < 0.0) {
hue += 1.0;
}
if (hue > 1.0) {
hue -= 1.0;
}
float res;
if (6.0 * hue < 1.0) {
res = p + (q - p) * 6.0 * hue;
} else if (2.0 * hue < 1.0) {
res = q;
} else if (3.0 * hue < 2.0) {
res = p + (q - p) * ((2.0 / 3.0) - hue) * 6.0;
} else {
res = p;
}
return res;
}
vec3 hslToRgb(vec3 hsl) {
vec3 rgb;
if (hsl.y == 0.0) {
return vec3(hsl.z);
}
float q = hsl.z < 0.5 ? hsl.z * (1.0 + hsl.y) : (hsl.z + hsl.y) - (hsl.y * hsl.z);
float p = 2.0 * hsl.z - q;
rgb.r = hueToRgb(p, q, hsl.x + (1.0 / 3.0));
rgb.g = hueToRgb(p, q, hsl.x);
rgb.b = hueToRgb(p, q, hsl.x - (1.0 / 3.0));
return rgb;
}
vec3 adjustContrast(vec3 col, float contrast) {
float factor = (1.0 + contrast);
return clamp(vec3(factor * (col.r - 0.5) + 0.5, factor * (col.g - 0.5) + 0.5,
factor * (col.b - 0.5) + 0.5),
vec3(0.0), vec3(1.0));
}
float modOne(float x) {
if (x < 0.0) {
return 1.0 - (float(int(x)) - x);
}
return x - float(int(x));
}
float adjustComponent(float component, float adjustment) {
return clamp(component * (1.0 + adjustment), 0.0, 1.0);
}
float adjustContrastInComponent(float component, float contrast) {
return clamp((1.0 + contrast) * (component - 0.5) + 0.5, 0.0, 1.0);
}
vec3 applyBaseColorCorrection(vec3 color, vec4 colorCorrection) {
if (colorCorrection.x != 0.0 || colorCorrection.y != 0.0 || colorCorrection.z != 0.0) {
vec3 colorInHSL = rgbToHsl(color);
colorInHSL = vec3(modOne(colorInHSL.x + colorCorrection.x),
adjustComponent(colorInHSL.y, colorCorrection.y),
adjustComponent(colorInHSL.z, colorCorrection.z));
color = hslToRgb(colorInHSL);
}
if (colorCorrection.a == 0.0)
return color;
return adjustContrast(color, colorCorrection.a);
}
float desaturate(vec4 color) {
float minComp = min(min(color.r, color.g), color.b);
float maxComp = max(max(color.r, color.g), color.b);
return minComp * 0.5 + maxComp * 0.5;
}
float applyMapCorrection(vec4 color, vec4 correction) {
float value = desaturate(color);
float inversion = correction.r;
float scale = correction.g;
float contrast = correction.b;
value = clamp(scale * value + inversion, 0.0, 1.0);
if (contrast == 0.0)
return value;
value = adjustContrastInComponent(value, contrast);
return value;
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#ifdef ANTI_TILING_REGULAR
uniform float antiTilingRegularStepX;
uniform float antiTilingRegularStepY;
uniform float antiTilingRegularMaxOffsetX;
uniform float antiTilingRegularMaxOffsetY;
#endif
#endif
float hash(vec2 p) {
vec3 p3 = fract(vec3(p.xyx) * 0.13);
p3 += dot(p3, p3.yzx + 3.333);
return fract((p3.x + p3.y) * p3.z);
}
float noise2d(vec2 x) {
vec2 i = floor(x);
vec2 f = fract(x);
float a = hash(i);
float b = hash(i + vec2(1.0, 0.0));
float c = hash(i + vec2(0.0, 1.0));
float d = hash(i + vec2(1.0, 1.0));
vec2 u = f * f * (3.0 - 2.0 * f);
return mix(a, b, u.x) + (c - a) * u.y * (1.0 - u.x) + (d - b) * u.x * u.y;
}
float sum(vec3 v) {
return v.x + v.y + v.z;
}
vec4 textureNoTileOrganic(sampler2D sampler, in vec2 x) {
float k = noise2d(x);
vec2 duvdx = dFdx(x);
vec2 duvdy = dFdy(x);
float l = k * 8.0;
float f = fract(l);
float ia = floor(l + 0.5);
float ib = floor(l);
f = min(f, 1.0 - f) * 2.0;
vec2 offa = sin(vec2(3.0, 7.0) * ia);
vec2 offb = sin(vec2(3.0, 7.0) * ib);
vec3 cola = textureGrad(sampler, x + offa, duvdx, duvdy).xyz;
vec3 colb = textureGrad(sampler, x + offb, duvdx, duvdy).xyz;
vec3 res = mix(cola, colb, smoothstep(0.1, 0.9, f - 0.1 * sum(cola - colb)));
return vec4(res.x, res.y, res.z, texture(sampler, x).a);
}
float toStepX(float x) {
#ifdef ANTI_TILING_REGULAR
float stepVal = antiTilingRegularStepX;
return floor(x * antiTilingRegularMaxOffsetX / stepVal) * stepVal;
#else
return floor(x);
#endif
}
float toStepY(float x) {
#ifdef ANTI_TILING_REGULAR
float stepVal = antiTilingRegularStepY;
return floor(x * antiTilingRegularMaxOffsetY / stepVal) * stepVal;
#else
return floor(x);
#endif
}
vec4 hash4(vec2 p) {
return fract(tan(vec4(1.0 + dot(p, vec2(37.0, 17.0)), 2.0 + dot(p, vec2(11.0, 47.0)),
3.0 + dot(p, vec2(41.0, 29.0)), 4.0 + dot(p, vec2(23.0, 31.0)))) *
103.0);
}
vec4 textureNoTilerRegular(sampler2D samp, in vec2 uv) {
vec2 iuv = floor(uv);
vec2 fuv = fract(uv);
vec4 ofa = hash4(iuv + vec2(0.0, 0.0));
vec4 ofb = hash4(iuv + vec2(1.0, 0.0));
vec4 ofc = hash4(iuv + vec2(0.0, 1.0));
vec4 ofd = hash4(iuv + vec2(1.0, 1.0));
vec2 ddx = dFdx(uv);
vec2 ddy = dFdy(uv);
#ifdef ANTI_TILING_REGULAR_MIRROR_X
ofa.z = sign(ofa.z - 0.5);
ofb.z = sign(ofb.z - 0.5);
ofc.z = sign(ofc.z - 0.5);
ofd.z = sign(ofd.z - 0.5);
#else
ofa.z = 1.0;
ofb.z = 1.0;
ofc.z = 1.0;
ofd.z = 1.0;
#endif
#ifdef ANTI_TILING_REGULAR_MIRROR_Y
ofa.w = sign(ofa.w - 0.5);
ofb.w = sign(ofb.w - 0.5);
ofc.w = sign(ofc.w - 0.5);
ofd.w = sign(ofd.w - 0.5);
#else
ofa.w = 1.0;
ofb.w = 1.0;
ofc.w = 1.0;
ofd.w = 1.0;
#endif
vec2 uva = uv * ofa.zw + vec2(toStepX(ofa.x), toStepY(ofa.y));
vec2 ddxa = ddx * ofa.zw;
vec2 ddya = ddy * ofa.zw;
vec2 uvb = uv * ofb.zw + vec2(toStepX(ofb.x), toStepY(ofb.y));
vec2 ddxb = ddx * ofb.zw;
vec2 ddyb = ddy * ofb.zw;
vec2 uvc = uv * ofc.zw + vec2(toStepX(ofc.x), toStepY(ofc.y));
vec2 ddxc = ddx * ofc.zw;
vec2 ddyc = ddy * ofc.zw;
vec2 uvd = uv * ofd.zw + vec2(toStepX(ofd.x), toStepY(ofd.y));
vec2 ddxd = ddx * ofd.zw;
vec2 ddyd = ddy * ofd.zw;
vec2 b = smoothstep(0.45, 0.55, fuv);
return mix(mix(textureGrad(samp, uva, ddxa, ddya), textureGrad(samp, uvb, ddxb, ddyb), b.x),
mix(textureGrad(samp, uvc, ddxc, ddyc), textureGrad(samp, uvd, ddxd, ddyd), b.x), b.y);
}
vec4 textureWithOptionalAntiTiling(sampler2D text, in vec2 uv) {
#ifdef ANTI_TILING_ORGANIC
return textureNoTileOrganic(text, uv);
#else
#ifdef ANTI_TILING_REGULAR
return textureNoTilerRegular(text, uv);
#else
return texture(text, uv);
#endif
#endif
}
#if defined(USE_BUMP_TEXTURE)
in vec3 vNormalV;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec4 bumpCorrection;
uniform float bumpScale;
#endif
uniform sampler2D bumpTexture;
float bumpTextureCorrected(vec2 coord) {
return applyMapCorrection(textureWithOptionalAntiTiling(bumpTexture, coord), bumpCorrection);
}
vec2 dBumpdxy() {
vec2 texdx = dFdx(vUv0);
vec2 texdy = dFdy(vUv0);
float Hll = bumpScale * bumpTextureCorrected(vUv0);
float dBx = bumpScale * bumpTextureCorrected(vUv0 + texdx) - Hll;
float dBy = bumpScale * bumpTextureCorrected(vUv0 + texdy) - Hll;
return vec2(dBx, dBy);
}
vec3 perturbNormal(in vec3 surfPos, in vec3 surfNorm) {
vec2 dBdxy = dBumpdxy();
vec3 vSigmaX = dFdx(surfPos);
vec3 vSigmaY = dFdy(surfPos);
vec3 R1 = cross(vSigmaY, surfNorm);
vec3 R2 = cross(surfNorm, vSigmaX);
float fDet = dot(vSigmaX, R1);
vec3 vGrad = sign(fDet) * (dBdxy.x * R1 + dBdxy.y * R2);
return normalize(abs(fDet) * surfNorm - vGrad);
}
#endif
#ifdef USE_BASE_COLOR_TEXTURE
uniform sampler2D baseColorTexture;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec4 baseColorAtlasUvMod;
uniform float alphaDiscardThreshold;
#endif
#else
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec3 uBaseColor;
#endif
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float opacity;
#ifdef USE_CUTOUT_MASK
uniform float cutoutMaskThreshold;
#endif
uniform vec4 baseColorCorrection;
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
vec3 getBaseColorHook(out float alpha);
vec3 getBaseColor(out float alpha) {
#ifdef USE_BASE_COLOR_TEXTURE
vec2 uv = vUv0;
#ifdef USE_BASE_COLOR_TEXTURE_ATLAS_REPEAT
vec2 uvScaled = uv * baseColorAtlasUvMod.zw;
vec2 dfdx = dFdx(uvScaled);
vec2 dfdy = dFdy(uvScaled);
uv = fract(uv) * baseColorAtlasUvMod.zw + baseColorAtlasUvMod.xy;
vec4 baseColorGamma = textureGrad(baseColorTexture, uv, dfdx, dfdy);
float textureAlpha = baseColorGamma.a;
#else
uv = uv * baseColorAtlasUvMod.zw + baseColorAtlasUvMod.xy;
#ifdef USE_ALPHA_IN_LOWER_HALF
vec4 baseColorGamma = textureWithOptionalAntiTiling(baseColorTexture, vec2(uv.x, .5 + .5 * uv.y));
float textureAlpha = texture(baseColorTexture, vec2(uv.x, .5 * uv.y)).r;
#else
vec4 baseColorGamma = textureWithOptionalAntiTiling(baseColorTexture, uv);
float textureAlpha = baseColorGamma.a;
#endif
#endif
vec3 baseColor = gammaToLinear(baseColorGamma.rgb);
#ifdef USE_CUTOUT_MASK
alpha = step(cutoutMaskThreshold, textureAlpha);
if (alpha == 0.0)
discard;
#else
alpha = opacity * textureAlpha;
#endif
vec3 resultBaseColor = applyBaseColorCorrection(baseColor, baseColorCorrection);
#else  // NOT USE_BASE_COLOR_TEXTURE
alpha = opacity;
vec3 resultBaseColor = uBaseColor;
#endif
return resultBaseColor;
}
#ifdef LIVE_LIGHTMAP
uniform sampler2D liveLightmap;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float lightmapMode;
uniform vec4 screenResolution;
#endif
#endif
#ifdef USE_LIGHTMAP
centroid in vec2 vUv1;
uniform sampler2D lightmap;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec4 lightmapSize;
uniform vec2 lightmapThreshold;
#endif
#endif  // NOT USE_LIGHTMAP
vec3 getLightIntensity() {
#ifdef LIVE_LIGHTMAP
if (lightmapMode == 1.0)
return texture(liveLightmap, gl_FragCoord.xy / screenResolution.xy).xyz;
if (lightmapMode == -1.0)
return vec3(1.0);
#endif
#ifdef USE_LIGHTMAP
vec2 uv = vec2(vUv1.x, vUv1.y);
#ifdef LIGHTMAP_YCOCGM
return ycocgToRgb(hdrDecodeYcocgmBilinear(lightmap, lightmapSize.xy, lightmapSize.zw,
lightmapThreshold.xy, uv));
#else  // LIGHTMAP_RGBM
return hdrDecodeRgbmBilinear(lightmap, lightmapSize.xy, lightmapSize.zw, uv);
#endif
#else  // ifndef USE_LIGHTMAP
return vec3(1.0);
#endif
}
#if defined(USE_ENVMAP)
#define USE_NORMAL_MAPPING_FUNCS
uniform sampler2D roughnessTexture;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec4 roughnessCorrection;
uniform float roughness;
#endif
float getRoughness() {
#ifdef USE_ROUGHNESS_TEXTURE
return applyMapCorrection(textureWithOptionalAntiTiling(roughnessTexture, vUv0),
roughnessCorrection);
#else
return roughness;
#endif
}
uniform sampler2D metallicTexture;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec4 metallicCorrection;
uniform float metallic;
#endif
float getMetallic() {
#ifdef USE_METALLIC_TEXTURE
return applyMapCorrection(textureWithOptionalAntiTiling(metallicTexture, vUv0),
metallicCorrection);
#else
return metallic;
#endif
}
#ifdef USE_BRDF_TEXTURE
vec2 decodeNormalizedFloatsFromRGBA8(vec4 encoded) {
float value1 = (encoded.r * 255.0 * 256.0) + (encoded.g * 255.0);
float value2 = (encoded.b * 255.0 * 256.0) + (encoded.a * 255.0);
value1 /= 65535.0;
value2 /= 65535.0;
return vec2(value1, value2);
}
uniform sampler2D brdfLUT;
#endif
vec3 envBRDFApprox(vec3 specularColor, float roughness, float NoV) {
const vec4 c0 = vec4(-1, -0.0275, -0.572, 0.022);
const vec4 c1 = vec4(1, 0.0425, 1.04, -0.04);
vec4 r = roughness * c0 + c1;
float a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;
vec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;
return specularColor * AB.x + AB.y;
}
vec3 getBrdf(float roughness, vec3 fresnel, float clampCosnv, vec3 specularColor) {
#ifdef USE_BRDF_TEXTURE
vec4 brdfEncoded = texture(brdfLUT, vec2(clampCosnv, roughness)).rgba;
vec2 brdf = decodeNormalizedFloatsFromRGBA8(brdfEncoded);
return fresnel * brdf.x + brdf.y;
#else
return envBRDFApprox(specularColor, roughness, clampCosnv);
#endif
}
uniform samplerCube envMap[MAX_REFLECTION_PROBES];
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float envMipsCount;
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform ReflectionProbe reflectionProbes[MAX_REFLECTION_PROBES];
#ifdef USE_REFLECTION_PROBE_BLENDING
uniform int reflectionProbesCount;
#endif  // USE_REFLECTION_PROBE_BLENDING
#endif    // DEV_DISABLE_UNIFORM_BUFFERS
struct EnvMapLevel {
float mipLevel0;
float mipLevel1;
float mipMixFactor;
};
EnvMapLevel getEnvMapLevel(float roughness) {
EnvMapLevel result;
float maxMipLevel = envMipsCount - 1.0;
float mipSelector = roughness * maxMipLevel;
result.mipLevel0 = floor(mipSelector);
result.mipLevel1 = min(result.mipLevel0 + 1.0, maxMipLevel);
result.mipMixFactor = fract(mipSelector);
return result;
}
const vec3 infBox = vec3(1000.0);
vec3 cubeMapProject(vec3 reflectionW, in ReflectionProbe reflectionProbe) {
vec3 firstPlaneIntersect = (reflectionProbe.boxMax.xyz - vPositionW) / reflectionW;
vec3 secondPlaneIntersect = (reflectionProbe.boxMin.xyz - vPositionW) / reflectionW;
vec3 furthestPlane = max(firstPlaneIntersect, secondPlaneIntersect);
vec3 furthestPlaneNonNeg = step(0.0, -furthestPlane) * infBox + abs(furthestPlane);
float distance = min(min(furthestPlaneNonNeg.x, furthestPlaneNonNeg.y), furthestPlaneNonNeg.z);
vec3 intersectionPosW = vPositionW + reflectionW * distance;
return intersectionPosW - reflectionProbe.posW.xyz;
}
float signedDistanceBox(vec3 p, vec3 b, float offset) {
vec3 q = abs(p) - b;
return length(max(q, 0.0)) + min(max(q.x, max(q.y, q.z)), 0.0) - offset;
}
float getSignedDistanceField(in ReflectionProbe probe) {
vec3 halfBox = vec3(probe.boxMax - probe.boxMin) * vec3(0.5);
vec3 boxPos = vec3(probe.boxMax + probe.boxMin) * vec3(0.5);
vec3 localPos = boxPos - vPositionW;
const float offset = 0.1;
return signedDistanceBox(localPos, halfBox, offset);
}
vec3 sampleEnvMap(in EnvMapLevel envMapLevel, in vec3 reflectionW, samplerCube envMap,
int probeIndex) {
#ifdef USE_ENVMAP_PROJECT
ReflectionProbe reflectionProbe = reflectionProbes[probeIndex];
if (reflectionProbe.boxMin.x != reflectionProbe.boxMax.x)
reflectionW = cubeMapProject(reflectionW, reflectionProbe);
#endif
vec4 cubeColorRaw0 = textureLod(envMap, reflectionW, envMapLevel.mipLevel0);
vec3 cubeColor0 = hdrDecodeRgbm(cubeColorRaw0);
vec4 cubeColorRaw1 = textureLod(envMap, reflectionW, envMapLevel.mipLevel1);
vec3 cubeColor1 = hdrDecodeRgbm(cubeColorRaw1);
return mix(cubeColor0, cubeColor1, envMapLevel.mipMixFactor);
}
vec3 sampleEnvMapBlended(in EnvMapLevel envMapLevel, in vec3 reflectionW) {
#ifdef USE_REFLECTION_PROBE_BLENDING
float weight[MAX_REFLECTION_PROBES];
#ifdef USE_ENVMAP_PROJECT
for (int i = 0; i < reflectionProbesCount; i++) {
weight[i] = max(-getSignedDistanceField(reflectionProbes[i]), 0.0);
weight[i] = smoothstep(0.0, 1.0, weight[i]);
}
float weightSum = 0.0;
for (int i = 0; i < reflectionProbesCount; i++) {
weightSum += weight[i];
}
if (weightSum == 0.0) {
weight[0] = 1.0;
} else {
for (int i = 0; i < reflectionProbesCount; i++) weight[i] /= weightSum;
}
#else
for (int i = 0; i < reflectionProbesCount; i++) weight[i] = 1.0;
#endif
vec3 envColor = vec3(0.0, 0.0, 0.0);
if (weight[0] > 0.0)
envColor += sampleEnvMap(envMapLevel, reflectionW, envMap[0], 0) * weight[0];
if (reflectionProbesCount >= 2 && weight[1] > 0.0)
envColor += sampleEnvMap(envMapLevel, reflectionW, envMap[1], 1) * weight[1];
if (reflectionProbesCount >= 3 && weight[2] > 0.0)
envColor += sampleEnvMap(envMapLevel, reflectionW, envMap[2], 2) * weight[2];
#else  // not USE_REFLECTION_PROBE_BLENDING
vec3 envColor = sampleEnvMap(envMapLevel, reflectionW, envMap[0], 0);
#endif
return envColor;
}
#endif
#ifdef USE_NORMAL_TEXTURE
uniform sampler2D normalTexture;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float normalScale;
#endif
#endif
#ifdef USE_NORMAL_MAPPING_FUNCS
vec3 computeTangent(vec2 texCoord, vec3 normalW) {
vec2 uvDiff1 = vec2(dFdx(texCoord.x), dFdy(texCoord.x));
vec2 uvDiff2 = vec2(dFdx(texCoord.y), dFdy(texCoord.y));
vec3 denormTangent = uvDiff1.x * dFdy(vPositionW) - dFdx(vPositionW) * uvDiff1.y;
vec3 tangent = denormTangent - normalW * dot(normalW, denormTangent);
float lenSq = dot(tangent, tangent);
tangent = lenSq < 1e-6 ? vec3(normalW.z, normalW.x, normalW.y) : tangent * inversesqrt(lenSq);
return tangent;
}
vec3 computeNormal() {
float faceSign = gl_FrontFacing ? 1.0 : -1.0;
#ifdef USE_NORMAL_TEXTURE
vec3 normalW = normalize(vNormalW);
vec3 tangentW = computeTangent(vUv0, normalW);
vec3 bitangentW = cross(normalW, tangentW);
vec3 value = texture(normalTexture, vUv0).xyz;
value = (value == vec3(0.0)) ? vec3(0.0, 0.0, 1.0) : value * 2.0 - 1.0;
value = tangentW * value.x * normalScale + bitangentW * value.y * normalScale + normalW * value.z;
return normalize(value) * faceSign;
#elif defined(USE_BUMP_TEXTURE)
vec3 normalPerturbedV = perturbNormal(-vPositionV, normalize(vNormalV));
return normalize(inverseTransformDirection(normalPerturbedV, viewMatrix)) * faceSign;
#else
return normalize(vNormalW) * faceSign;
#endif
}
#endif
float getEnvMapFresnel(float roughness) {
float roughness2 = roughness * roughness;
return (roughness2 - 2.0 * roughness + 1.0);
}
vec3 fresnelSchlickEnv(in vec3 specularColor, in float envMapFresnel, in float clampCosnv,
inout float opacity) {
float fresnel = 1.0 - clampCosnv;
float fresnel2 = fresnel * fresnel;
fresnel *= fresnel2 * fresnel2;
fresnel *= envMapFresnel;
opacity = opacity + (1.0 - opacity) * fresnel;
return specularColor + (1.0 - specularColor) * fresnel;
}
vec3 getSpecularColor(in vec3 baseColor, float metalic) {
const float dielectricF0 = 0.04;
return mix(vec3(dielectricF0), baseColor, metalic);
}
float getLuminance(in vec3 color) {
return 0.2126 * color.r + 0.7152 * color.g + 0.0722 * color.b;
}
#if defined(USE_ENVMAP)
vec3 addSpecular(in vec3 baseColor, in vec3 totalIntensity, inout float opacity, float metallic,
float roughness) {
vec3 totalSpec = vec3(0.0, 0.0, 0.0);
vec3 diffuseIntensity = totalIntensity * (1.0 - mix(0.04, 1.0, metallic));
vec3 viewW = normalize(uCameraPosition - vPositionW);
vec3 normalW = computeNormal();
float clampCosnv = saturate(dot(normalW, viewW));
vec3 reflectionW = normalize(reflect(-viewW, normalW));
vec3 specularColor = getSpecularColor(baseColor, metallic);
EnvMapLevel envMapLevel = getEnvMapLevel(roughness);
vec3 envColor = sampleEnvMapBlended(envMapLevel, reflectionW);
float envMapFresnel = roughness * roughness - 2.0 * roughness + 1.0;
vec3 fresnel = fresnelSchlickEnv(specularColor, envMapFresnel, clampCosnv, opacity);
float luminance = getLuminance(totalIntensity);
totalSpec = envColor * getBrdf(roughness, fresnel, clampCosnv, specularColor);
#if defined(WEAK_REFLECTION_SHADOW)
float shadowingFactor = mix(0.4, 1.0, luminance);
#else
float shadowingFactor = mix(0.4, 1.0, luminance) * mix(min(luminance, 1.0), 1.0, metallic);
#endif
return baseColor * diffuseIntensity + totalSpec * shadowingFactor;
}
vec3 addSpecular(in vec3 baseColor, in vec3 totalIntensity, inout float opacity) {
float metallic = getMetallic();
float roughness = getRoughness();
return addSpecular(baseColor, totalIntensity, opacity, metallic, roughness);
}
#else  // NOT USE_ENVMAP
vec3 addSpecular(in vec3 baseColor, in vec3 lightIntensity, in float opacity, float metallic,
float roughness) {
return baseColor * lightIntensity;
}
vec3 addSpecular(vec3 baseColor, in vec3 lightIntensity, in float opacity) {
return baseColor * lightIntensity;
}
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#ifdef USE_HIGHLIGHT
uniform vec3 uHighlight;
uniform float highlightMix;
#endif
#endif
#if defined(HDR_OUTPUT)
vec4 hdrEncode(in vec3 rgb) {
const float rgbmScale = 2.82842712;  // sqrt(8)
vec3 r = sqrt(rgb) / rgbmScale;
float m = max(max(r.r, r.g), r.b);
m = clamp(m, 1.0 / 255.0, 1.0);
m = ceil(m * 255.0) / 255.0;
r /= m;
return vec4(r.r, r.g, r.b, (1.0 - m));
}
#endif
#ifdef USE_COLORMAP
vec3 colormap(in sampler2D lut, in vec3 color, in float intensity) {
const float resolution = 16.0;
const float maxValueIndex = resolution - 1.0;
const float sliceWidth = 1.0 / resolution;
const float slicePixelWidth = sliceWidth / resolution;
const float sliceMarginWidth = 0.5 * slicePixelWidth;
const float sliceInnerWidth = sliceWidth - slicePixelWidth;
const float slicePixelHeight = 1.0 / resolution;
const float sliceMarginHeight = 0.5 * slicePixelHeight;
const float sliceInnerHeight = 1.0 - slicePixelHeight;
float bSlice0 = min(floor(color.b * maxValueIndex), maxValueIndex - 1.0);
float bSlice1 = bSlice0 + 1.0;
float bOffset = color.b * maxValueIndex - bSlice0;
float rSlicePos = sliceMarginWidth + color.r * sliceInnerWidth;
float gSlicePos = sliceMarginHeight + color.g * sliceInnerHeight;
float rPos0 = rSlicePos + (bSlice0 * sliceWidth);
float rPos1 = rSlicePos + (bSlice1 * sliceWidth);
vec3 color0 = texture(lut, vec2(rPos0, gSlicePos)).rgb;
vec3 color1 = texture(lut, vec2(rPos1, gSlicePos)).rgb;
return mix(color, mix(color0, color1, bOffset), intensity);
}
uniform sampler2D colorMap;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float colorMapIntensity;
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
#endif
#ifdef USE_CHROMA_KEY
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec3 uChromaKeyColor;
uniform vec3 uChromaKeyDeltaCoeff;
#endif
const float k32 = sqrt(3.0) / 2.0;
vec3 rgb2abi(vec3 color) {
float r = color.r;
float g = color.g;
float b = color.b;
return vec3(r - 0.5 * g - 0.5 * b, k32 * (g - b), 0.3333 * (r + g + b));
}
const float IPI2 = 0.5 / 3.1415926538;
vec3 rgb2hci(vec3 color) {
vec3 abi = rgb2abi(color);
return vec3(atan(abi.y, abi.x) * IPI2, length(abi.xy), abi.z);
}
float chromaKeyShapeFn(vec3 delta, vec3 color, vec3 key) {
vec3 diff = color - key;
vec3 v = delta * vec3(
0.5 - abs(abs(diff.x) - 0.5), abs(diff.y), abs(diff.z));
float x = max(v.r, max(v.g, v.b));
return x * x;
}
float chromaKeyEdgeFn(float a) {
return clamp(.2 / .5 * (a - 1.0), 0.0, 1.0);
}
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float emissionStrength;
#ifdef USE_EXPOSURE_AND_GAMMA
uniform vec4 camera_exposure_gamma;
#else
const vec4 camera_exposure_gamma = vec4(1.0, 1.0, 0.0, 0.0);
#endif
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
vec3 addSpecularHook(in vec3 baseColor, in vec3 totalIntensity, inout float opacity);
void main() {
float alpha;
vec3 baseColor = getBaseColorHook(alpha);
#ifdef USE_CHROMA_KEY
float dist = chromaKeyShapeFn(uChromaKeyDeltaCoeff, rgb2hci(baseColor), rgb2hci(uChromaKeyColor));
alpha *= chromaKeyEdgeFn(dist);
#endif
#if defined(USE_BASE_COLOR_TEXTURE)
if (alpha < alphaDiscardThreshold) {
discard;
}
#endif
vec3 lightIntensity = getLightIntensity();
#ifdef USE_HIGHLIGHT
#if defined(DEV_DISABLE_UNIFORM_BUFFERS) || defined(OBJECT_HAS_HIGHLIGHT)
baseColor = mix(baseColor, uHighlight, highlightMix);
alpha = mix(alpha, 1.0, highlightMix);
#endif
#endif
vec3 diffuseSpecular = addSpecularHook(baseColor, lightIntensity, alpha);
#if defined(LIVE_LIGHTMAP) || defined(USE_HEADLIGHT)
#ifdef LIVE_LIGHTMAP
if (lightmapMode == -1.0)
#endif
{
vec3 lightW = normalize(uCameraPosition - vPositionW.xyz);
vec3 normalW = vNormalW * (gl_FrontFacing ? 1.0 : -1.0);
float pointDiffuse = max(dot(normalize(normalW), lightW), 0.0);
diffuseSpecular *= pointDiffuse;
}
#endif
vec3 diffuseSpecularEmissive = diffuseSpecular + baseColor * emissionStrength;
#ifdef USE_FOG
float distance = length(vPositionV);
diffuseSpecularEmissive = addFog(diffuseSpecularEmissive, distance, vPositionW);
#endif
#ifdef HDR_OUTPUT
if (alpha < 0.5) {
discard;
}
fragColor = hdrEncode(diffuseSpecularEmissive);
#else  // no HDR_OUTPUT
vec3 exposedColor =
pow(camera_exposure_gamma.x * diffuseSpecularEmissive.xyz, vec3(camera_exposure_gamma.y));
vec3 gammaColor = linearToGammaToneMapped(exposedColor);
#ifdef USE_COLORMAP
fragColor = vec4(colormap(colorMap, min(gammaColor, 1.0), colorMapIntensity), alpha);
#else
fragColor = vec4(gammaColor, alpha);
#endif
#endif  // no HDR_OUTPUT
}
`,"standard_material_fragment_hooks.glsl":`vec3 addSpecularHook(in vec3 baseColor, in vec3 totalIntensity, inout float opacity) {
return addSpecular(baseColor, totalIntensity, opacity);
}
vec3 getBaseColorHook(out float alpha) {
return getBaseColor(alpha);
}
`,"standard_material_vertex.glsl":`const float PI = 3.14159265358979;
const float RECIPROCAL_PI2 = 0.15915494;
float saturate(in float a) {
return clamp(a, 0.0, 1.0);
}
vec3 inverseTransformDirection(in vec3 normal, in mat4 matrix) {
return normalize((vec4(normal, 0.0) * matrix).xyz);
}
vec3 sphericalDecode(in vec2 spNormal) {
float theta = (spNormal.x / 254.0 + 0.5) * PI;
float phi = spNormal.y * (PI / 127.0);
float sinTheta = sin(theta);
return vec3(sinTheta * cos(phi), sinTheta * sin(phi), cos(theta));
}
vec4 transformPosition() {
return vec4(t0.x * position.x + t0.y * position.y + t0.z * position.z + t0.w,
t1.x * position.x + t1.y * position.y + t1.z * position.z + t1.w,
t2.x * position.x + t2.y * position.y + t2.z * position.z + t2.w, 1.0);
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform CameraBuffer {
mat4 projectionMatrix;
mat4 viewProjMatrix;
mat4 viewMatrix;
mat4 invViewMatrix;
vec4 cameraPosition_pad;
};
#define uCameraPosition cameraPosition_pad.xyz
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#define INSERT_MODEL_VIEW_MATRIX
#define MODEL_MATRIX
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = projectionMatrix * modelViewMatrix * worldPos;
}
#else  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec4 worldPos) {
#ifdef MODEL_MATRIX
gl_Position = viewProjMatrix * modelMatrix * worldPos;
#else
gl_Position = viewProjMatrix * worldPos;
#endif  // MODEL_MATRIX
}
#ifdef MODEL_MATRIX
#define INSERT_MODEL_VIEW_MATRIX mat4 modelViewMatrix = viewMatrix * modelMatrix;
#else
#define INSERT_MODEL_VIEW_MATRIX mat4 modelViewMatrix = viewMatrix;
#endif  // MODEL_MATRIX
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec3 worldPos) {
setClipPositionFromWorldPos(vec4(worldPos, 1.0));
}
void setClipPositionFromViewPos(in vec4 viewPos) {
gl_Position = projectionMatrix * viewPos;
}
void setClipPositionFromViewPos(in vec3 viewPos) {
setClipPositionFromViewPos(vec4(viewPos, 1.0));
}
vec3 multiplyPositionByModelMatrix(in vec4 position) {
#ifdef MODEL_MATRIX
return (modelMatrix * position).xyz;
#else
return position.xyz;
#endif
}
vec3 multiplyPositionByModelMatrix(in vec3 position) {
return multiplyPositionByModelMatrix(vec4(position, 1.0));
}
vec3 multiplyDirectionByModelMatrix(in vec3 direction) {
#ifdef MODEL_MATRIX
return (modelMatrix * vec4(direction, 0.0)).xyz;
#else
return direction;
#endif
}
#if defined(USE_BASE_COLOR_TEXTURE) || defined(USE_ROUGHNESS_TEXTURE) ||                         \\
defined(USE_METALLIC_TEXTURE) || defined(USE_BUMP_TEXTURE) || defined(USE_HEIGHT_TEXTURE) || \\
defined(USE_NORMAL_TEXTURE)
out vec2 vUv0;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec4 uvMod0;
#endif
#endif
#ifdef USE_LIGHTMAP
centroid out vec2 vUv1;
#endif
#if defined(USE_BUMP_TEXTURE) || defined(USE_FOG)
out vec3 vPositionV;
#endif
#if defined(USE_ENVMAP) || defined(USE_HEADLIGHT) || defined(USE_FOG) || defined(LIVE_LIGHTMAP)
out vec3 vPositionW;
#endif
#if defined(USE_ENVMAP) || defined(USE_HEADLIGHT) || defined(LIVE_LIGHTMAP)
out vec3 vNormalW;
#endif
#if defined(USE_BUMP_TEXTURE) || defined(USE_HEIGHT_TEXTURE) || defined(USE_ENVMAP) || \\
defined(USE_HEADLIGHT) || defined(LIVE_LIGHTMAP)
#define MV_NORMAL_REQUIRED
void modifyMvPositionHook(inout vec4 mvPosition, in vec3 normal);
#endif
#ifdef MV_NORMAL_REQUIRED
out vec3 vNormalV;
#endif
void main() {
#if defined(USE_BASE_COLOR_TEXTURE) || defined(USE_ROUGHNESS_TEXTURE) ||                         \\
defined(USE_METALLIC_TEXTURE) || defined(USE_BUMP_TEXTURE) || defined(USE_HEIGHT_TEXTURE) || \\
defined(USE_NORMAL_TEXTURE)
vUv0 = uv0 * uvMod0.zw + uvMod0.xy;
#endif
vec4 transformedPosition = transformPosition();
INSERT_MODEL_VIEW_MATRIX
vec4 mvPosition = modelViewMatrix * transformedPosition;
#ifdef USE_LIGHTMAP
float zeroOrOne = min(uv1.x + uv1.y, 1.0);
vUv1 = uv1 * uv1Mod.zw + uv1Mod.xy * zeroOrOne;
#endif
#if defined(MV_NORMAL_REQUIRED)
vec3 n = sphericalDecode(sphericalNormal);
vec3 normal = vec3(dot(t0.xyz, n), dot(t1.xyz, n), dot(t2.xyz, n));
#if defined(NON_UNIFORM_SCALE)
vNormalV = normalize(mat3(normalMatrix) * normal);
#else
vNormalV = normalize(mat3(modelViewMatrix) * normal);
#endif
modifyMvPositionHook(mvPosition, vNormalV);
#endif
#if defined(USE_BUMP_TEXTURE) || defined(USE_FOG)
vPositionV = -mvPosition.xyz;
#endif
#if defined(USE_ENVMAP) || defined(USE_HEADLIGHT) || defined(USE_FOG) || defined(LIVE_LIGHTMAP)
vPositionW = multiplyPositionByModelMatrix(transformedPosition);
#endif
#if defined(USE_ENVMAP) || defined(USE_HEADLIGHT) || defined(LIVE_LIGHTMAP)
vNormalW = multiplyDirectionByModelMatrix(normal);
vNormalW = normalize(vNormalW);
#endif
gl_Position = projectionMatrix * mvPosition;
}
`,"standard_material_vertex_hooks.glsl":`void modifyMvPositionHook(inout vec4 mvPosition, in vec3 normal) {}
`,"static_render_fragment.glsl":`float _l2g(in float x) {
return (x <= 0.0031308) ? x * 12.92 : pow(x, 1.0 / 2.4) * 1.055 - 0.055;
}
vec3 linearToGamma(in vec3 rgb) {
return vec3(_l2g(rgb.r), _l2g(rgb.g), _l2g(rgb.b));
}
vec3 hable(in vec3 rgb) {
float A = 0.15;  // shoulderStrength
float B = 0.50;  // linearStrength
float C = 0.10;  // linearAngle
float D = 0.20;  // toeStrength
float E = 0.02;  // toeNumerator
float F = 0.30;  // toeDenominator
return ((rgb * (A * rgb + C * B) + D * E) / (rgb * (A * rgb + B) + D * F)) - E / F;
}
vec3 toneMappingHable(in vec3 rgb) {
float exposure = 11.2;
float exposureBias = 2.0;
vec3 current = hable(exposureBias * rgb);
vec3 whiteScale = 1.0 / hable(vec3(exposure));
return pow(current * whiteScale, vec3(1.0 / 2.2));
}
vec3 uchimura(in vec3 x, in float P, in float a, in float m, in float l, in float c, in float b) {
float l0 = ((P - m) * l) / a;
float L0 = m - m / a;
float L1 = m + (1.0 - m) / a;
float S0 = m + l0;
float S1 = m + a * l0;
float C2 = (a * P) / (P - S1);
float CP = -C2 / P;
vec3 w0 = vec3(1.0 - smoothstep(0.0, m, x));
vec3 w2 = vec3(step(m + l0, x));
vec3 w1 = vec3(1.0 - w0 - w2);
vec3 T = vec3(m * pow(x / m, vec3(c)) + b);
vec3 S = vec3(P - (P - S1) * exp(CP * (x - S0)));
vec3 L = vec3(m + a * (x - m));
return T * w0 + L * w1 + S * w2;
}
vec3 toneMappingUchimura(in vec3 rgb) {
float P = 1.0;   // max display brightness
float a = 1.0;   // contrast
float m = 0.22;  // linear section start
float l = 0.4;   // linear section length
float c = 1.45;  // black
float b = 0.0;   // pedestal
return pow(uchimura(rgb, P, a, m, l, c, b), vec3(1.0 / 2.2));
}
vec3 toneMappingUnreal(in vec3 rgb) {
return rgb / (rgb + 0.187) * 1.035;
}
vec3 linearToGammaToneMapped(in vec3 rgb) {
#ifdef TONE_MAPPING_UNREAL
return toneMappingUnreal(rgb);
#endif
#ifdef TONE_MAPPING_HABLE
return toneMappingHable(rgb);
#endif
#ifdef TONE_MAPPING_UCHIMURA
return toneMappingUchimura(rgb);
#endif
return toneMappingUnreal(rgb);
}
uniform sampler2D staticRender;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec2 sizeInv;
#endif
void main() {
vec3 colorLinear = texture(staticRender, gl_FragCoord.xy * sizeInv).rgb;
fragColor = vec4(linearToGammaToneMapped(colorLinear), 1.0);
}
`,"static_render_vertex.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#define INSERT_MODEL_VIEW_MATRIX
#define MODEL_MATRIX
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = projectionMatrix * modelViewMatrix * worldPos;
}
#else  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec4 worldPos) {
#ifdef MODEL_MATRIX
gl_Position = viewProjMatrix * modelMatrix * worldPos;
#else
gl_Position = viewProjMatrix * worldPos;
#endif  // MODEL_MATRIX
}
#ifdef MODEL_MATRIX
#define INSERT_MODEL_VIEW_MATRIX mat4 modelViewMatrix = viewMatrix * modelMatrix;
#else
#define INSERT_MODEL_VIEW_MATRIX mat4 modelViewMatrix = viewMatrix;
#endif  // MODEL_MATRIX
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec3 worldPos) {
setClipPositionFromWorldPos(vec4(worldPos, 1.0));
}
void setClipPositionFromViewPos(in vec4 viewPos) {
gl_Position = projectionMatrix * viewPos;
}
void setClipPositionFromViewPos(in vec3 viewPos) {
setClipPositionFromViewPos(vec4(viewPos, 1.0));
}
vec3 multiplyPositionByModelMatrix(in vec4 position) {
#ifdef MODEL_MATRIX
return (modelMatrix * position).xyz;
#else
return position.xyz;
#endif
}
vec3 multiplyPositionByModelMatrix(in vec3 position) {
return multiplyPositionByModelMatrix(vec4(position, 1.0));
}
vec3 multiplyDirectionByModelMatrix(in vec3 direction) {
#ifdef MODEL_MATRIX
return (modelMatrix * vec4(direction, 0.0)).xyz;
#else
return direction;
#endif
}
void main() {
INSERT_MODEL_VIEW_MATRIX
gl_Position = modelViewMatrix * vec4(position, 1.0);
}
`,"taa_dynamic_mask_fragment.glsl":`void main() {
reprojectedUvResult = vec4(1.0, 1.0, 1.0, 1.0);
}
`,"temporal_aa_fragment.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform GlobalBuffer {
mat4 unjitteredInvProjMatrix;
mat4 unjitteredPrevViewProjMatrix;
vec4 viewSpaceFrustumRayDirections[4];
vec4 viewSpaceFrustumRayOrigins[4];
vec2 zNear_zFar;
vec4 fogDistStart_DistDensity_HeightStart_HeightDensity;
vec4 fogColor;
vec4 camera_exposure_gamma;
float colorMapIntensity;
float time;
vec2 texelSize;
vec2 renderTargetSize;
float deltaTime;
float velocityFactor;
vec2 jitterOffset;
float temporalAaHistoryWeight;
bool allTaaSamplesAccumulated;
vec2 neighbourhoodTexelOffsets[8];
float accumulatedStaticTaaSamples;
vec4 screenResolution;
float lightmapMode;
float dynamicTaaHistoryMultiplier;
};
#define uFogColor fogColor.xyz
#endif
vec2 decodeNormalizedFloatsFromRGBA8(vec4 encoded) {
float value1 = (encoded.r * 255.0 * 256.0) + (encoded.g * 255.0);
float value2 = (encoded.b * 255.0 * 256.0) + (encoded.a * 255.0);
value1 /= 65535.0;
value2 /= 65535.0;
return vec2(value1, value2);
}
in vec2 vUv0;
#define COLOR_EPSILON 0.0001
void getNeighbourhoodMinMax(vec2 uv, inout vec3 minColor, inout vec3 maxColor) {
for (int i = 0; i < 8; i++) {
vec3 color = texture(tColor, uv + neighbourhoodTexelOffsets[i]).xyz;
minColor = min(minColor, color);
maxColor = max(maxColor, color);
}
}
vec4 clipToMinMax(vec3 minColor, vec3 maxColor, vec4 currentColor, vec4 prevColor) {
vec3 pClip = (maxColor + minColor) * 0.5;
vec3 eClip = (maxColor - minColor) * 0.5;
if (dot(eClip, vec3(1.0)) < COLOR_EPSILON)
return vec4(minColor, currentColor.w);
vec4 vClip = prevColor - vec4(pClip, currentColor.w);
vec3 vUnit = vClip.xyz / eClip;
vec3 aUnit = abs(vUnit);
float maxUnit = max(aUnit.x, max(aUnit.y, aUnit.z));
if (maxUnit > 1.0)
return vec4(pClip, currentColor.w) + vClip / maxUnit;
else
return prevColor;
}
vec4 getDynamicTaaResult(vec4 currentColor, vec2 uv) {
vec4 encodedPrevFrameUv = texture(tReprojectedUv, uv);
vec2 prevFrameUv = decodeNormalizedFloatsFromRGBA8(encodedPrevFrameUv);
float temporalAaHistoryMultiplier = 1.0;
vec2 borderCheck = abs(prevFrameUv * 2.0 - vec2(1.0));
if (borderCheck.x >= 1.0 || borderCheck.y >= 1.0) {
if (borderCheck.x == 1.0 && borderCheck.y == 1.0) {
prevFrameUv = uv;
temporalAaHistoryMultiplier = dynamicTaaHistoryMultiplier;
} else
return currentColor;
}
vec3 minColor = currentColor.xyz;
vec3 maxColor = currentColor.xyz;
getNeighbourhoodMinMax(uv, minColor, maxColor);
vec4 centerSample = texture(tColorPrev, prevFrameUv);
vec4 clippedPrevColor = clipToMinMax(minColor, maxColor, currentColor, centerSample);
return mix(currentColor, clippedPrevColor, temporalAaHistoryWeight * temporalAaHistoryMultiplier);
}
void main() {
vec4 currentColor = texture(tColor, vUv0 - jitterOffset * 0.5);
vec4 prevColor = vec4(0.0);
if (accumulatedStaticTaaSamples > 0.0) {
prevColor = texture(tColorPrev, vUv0);
if (!allTaaSamplesAccumulated) {
fragColor = (prevColor * accumulatedStaticTaaSamples + currentColor) /
(accumulatedStaticTaaSamples + 1.0);
} else {
fragColor = prevColor;
}
} else {
fragColor = getDynamicTaaResult(currentColor, vUv0);
}
}
`,"universal_material_fragment.glsl":`const float PI = 3.14159265358979;
const float RECIPROCAL_PI2 = 0.15915494;
float saturate(in float a) {
return clamp(a, 0.0, 1.0);
}
vec3 inverseTransformDirection(in vec3 normal, in mat4 matrix) {
return normalize((vec4(normal, 0.0) * matrix).xyz);
}
float _g2l(in float x) {
return (x <= 0.04045) ? x / 12.92 : pow((x + 0.055) / 1.055, 2.4);
}
vec3 gammaToLinear(in vec3 rgb) {
return vec3(_g2l(rgb.r), _g2l(rgb.g), _g2l(rgb.b));
}
float _l2g(in float x) {
return (x <= 0.0031308) ? x * 12.92 : pow(x, 1.0 / 2.4) * 1.055 - 0.055;
}
vec3 linearToGamma(in vec3 rgb) {
return vec3(_l2g(rgb.r), _l2g(rgb.g), _l2g(rgb.b));
}
vec3 hable(in vec3 rgb) {
float A = 0.15;  // shoulderStrength
float B = 0.50;  // linearStrength
float C = 0.10;  // linearAngle
float D = 0.20;  // toeStrength
float E = 0.02;  // toeNumerator
float F = 0.30;  // toeDenominator
return ((rgb * (A * rgb + C * B) + D * E) / (rgb * (A * rgb + B) + D * F)) - E / F;
}
vec3 toneMappingHable(in vec3 rgb) {
float exposure = 11.2;
float exposureBias = 2.0;
vec3 current = hable(exposureBias * rgb);
vec3 whiteScale = 1.0 / hable(vec3(exposure));
return pow(current * whiteScale, vec3(1.0 / 2.2));
}
vec3 uchimura(in vec3 x, in float P, in float a, in float m, in float l, in float c, in float b) {
float l0 = ((P - m) * l) / a;
float L0 = m - m / a;
float L1 = m + (1.0 - m) / a;
float S0 = m + l0;
float S1 = m + a * l0;
float C2 = (a * P) / (P - S1);
float CP = -C2 / P;
vec3 w0 = vec3(1.0 - smoothstep(0.0, m, x));
vec3 w2 = vec3(step(m + l0, x));
vec3 w1 = vec3(1.0 - w0 - w2);
vec3 T = vec3(m * pow(x / m, vec3(c)) + b);
vec3 S = vec3(P - (P - S1) * exp(CP * (x - S0)));
vec3 L = vec3(m + a * (x - m));
return T * w0 + L * w1 + S * w2;
}
vec3 toneMappingUchimura(in vec3 rgb) {
float P = 1.0;   // max display brightness
float a = 1.0;   // contrast
float m = 0.22;  // linear section start
float l = 0.4;   // linear section length
float c = 1.45;  // black
float b = 0.0;   // pedestal
return pow(uchimura(rgb, P, a, m, l, c, b), vec3(1.0 / 2.2));
}
vec3 toneMappingUnreal(in vec3 rgb) {
return rgb / (rgb + 0.187) * 1.035;
}
vec3 linearToGammaToneMapped(in vec3 rgb) {
#ifdef TONE_MAPPING_UNREAL
return toneMappingUnreal(rgb);
#endif
#ifdef TONE_MAPPING_HABLE
return toneMappingHable(rgb);
#endif
#ifdef TONE_MAPPING_UCHIMURA
return toneMappingUchimura(rgb);
#endif
return toneMappingUnreal(rgb);
}
vec4 cubic(in float v) {
vec4 n = vec4(1.0, 2.0, 3.0, 4.0) - v;
vec4 s = n * n * n;
float x = s.x;
float y = s.y - 4.0 * s.x;
float z = s.z - 4.0 * s.y + 6.0 * s.x;
float w = 6.0 - x - y - z;
return vec4(x, y, z, w) * (1.0 / 6.0);
}
vec3 hdrDecodeRgbm(in vec4 rgbm) {
const float rgbmScale = 2.82842712;  // sqrt(8)
float m = 1.0 - rgbm.a;
vec3 r = rgbm.rgb * (rgbmScale * m);
return r * r;
}
vec3 hdrDecodeYcocgm(in vec4 ycocgm, in vec2 threshold) {
const float ycocgmLumaRange = 16.0;
float m = ycocgm.w * (16.0 * 255.0 / 256.0) - 1.0;
float chroma_scale_factor = fract(m);
float y_factor = m - chroma_scale_factor;
chroma_scale_factor = 1.0 - chroma_scale_factor;
float factor = y_factor == ycocgmLumaRange - 2.0 ? 0.0 : 1.0;
float y = mix(ycocgm.x * threshold.x, (y_factor + ycocgm.x) * threshold.y + threshold.x, factor);
float co = (ycocgm.y - 0.5) * chroma_scale_factor;
float cg = (ycocgm.z - 0.5) * chroma_scale_factor;
return vec3(y, co, cg);
}
vec3 ycocgToRgb(in vec3 ycocg) {
float y = ycocg.x, co = ycocg.y, cg = ycocg.z;
y = y * y;
float r = saturate(y + co - cg);
float g = saturate(y + cg);
float b = saturate(y - co - cg);
return vec3(r, g, b) * 8.0;
}
/*vec3 hdrDecodeYcocgmBicubic(in sampler2D ycocgmSampler, in vec2 texSize, in vec2 invTexSize,
in vec2 threshold, in vec2 texCoords) {
vec2 texCoordsScaled = texCoords * texSize - 0.5;
vec2 fxy = fract(texCoordsScaled);
texCoordsScaled -= fxy;
vec4 xcubic = cubic(fxy.x), ycubic = cubic(fxy.y);
vec4 c = texCoordsScaled.xxyy + vec2(-0.5, +1.5).xyxy;
vec4 s = vec4(xcubic.xz + xcubic.yw, ycubic.xz + ycubic.yw);
vec4 offset = (c + vec4 (xcubic.yw, ycubic.yw) / s) * invTexSize.xxyy;
vec3 sample0 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.xz), threshold);
vec3 sample1 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.yz), threshold);
vec3 sample2 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.xw), threshold);
vec3 sample3 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.yw), threshold);
float sx = s.x / (s.x + s.y), sy = s.z / (s.z + s.w);
return mix(mix(sample3, sample2, sx), mix(sample1, sample0, sx), sy);
}*/
vec3 hdrDecodeYcocgmBilinear(in sampler2D ycocgmSampler, in vec2 texSize, in vec2 invTexSize,
in vec2 threshold, in vec2 texCoords) {
vec2 texCoordsScaled = texCoords * texSize - 0.5;
vec2 fxy = fract(texCoordsScaled);
texCoordsScaled -= fxy;
vec4 c = texCoordsScaled.xxyy + vec2(-0.5, +0.5).xyxy;
vec4 offset = c + vec4(1.0);
float sx = 1.0 - fxy.x;
float sy = 1.0 - fxy.y;
offset *= invTexSize.xxyy;
vec3 sample0 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.xz), threshold);
vec3 sample1 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.yz), threshold);
vec3 sample2 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.xw), threshold);
vec3 sample3 = hdrDecodeYcocgm(texture(ycocgmSampler, offset.yw), threshold);
return mix(mix(sample3, sample2, sx), mix(sample1, sample0, sx), sy);
}
/*vec3 hdrDecodeRgbmBicubic(in sampler2D rgbmSampler, in vec2 texSize,
in vec2 invTexSize, in vec2 texCoords) {
vec2 texCoordsScaled = texCoords * texSize - 0.5;
vec2 fxy = fract(texCoordsScaled);
texCoordsScaled -= fxy;
vec4 xcubic = cubic(fxy.x), ycubic = cubic(fxy.y);
vec4 c = texCoordsScaled.xxyy + vec2(-0.5, +1.5).xyxy;
vec4 s = vec4(xcubic.xz + xcubic.yw, ycubic.xz + ycubic.yw);
vec4 offset = (c + vec4 (xcubic.yw, ycubic.yw) / s) * invTexSize.xxyy;
vec3 sample0 = hdrDecodeRgbm(texture(rgbmSampler, offset.xz));
vec3 sample1 = hdrDecodeRgbm(texture(rgbmSampler, offset.yz));
vec3 sample2 = hdrDecodeRgbm(texture(rgbmSampler, offset.xw));
vec3 sample3 = hdrDecodeRgbm(texture(rgbmSampler, offset.yw));
float sx = s.x / (s.x + s.y), sy = s.z / (s.z + s.w);
return mix(mix(sample3, sample2, sx), mix(sample1, sample0, sx), sy);
}*/
vec3 hdrDecodeRgbmBilinear(in sampler2D rgbmSampler, in vec2 texSize, in vec2 invTexSize,
in vec2 texCoords) {
vec2 texCoordsScaled = texCoords * texSize - 0.5;
vec2 fxy = fract(texCoordsScaled);
texCoordsScaled -= fxy;
vec4 c = texCoordsScaled.xxyy + vec2(-0.5, +0.5).xyxy;
vec4 offset = c + vec4(1.0);
float sx = 1.0 - fxy.x;
float sy = 1.0 - fxy.y;
offset *= invTexSize.xxyy;
vec3 sample0 = hdrDecodeRgbm(texture(rgbmSampler, offset.xz));
vec3 sample1 = hdrDecodeRgbm(texture(rgbmSampler, offset.yz));
vec3 sample2 = hdrDecodeRgbm(texture(rgbmSampler, offset.xw));
vec3 sample3 = hdrDecodeRgbm(texture(rgbmSampler, offset.yw));
return mix(mix(sample3, sample2, sx), mix(sample1, sample0, sx), sy);
}
vec4 hdrEncode(in vec3 rgb) {
const float rgbmScale = 2.82842712;  // sqrt(8)
vec3 r = sqrt(rgb) / rgbmScale;
float m = max(max(r.r, r.g), r.b);
m = clamp(m, 1.0 / 255.0, 1.0);
m = ceil(m * 255.0) / 255.0;
r /= m;
return vec4(r.r, r.g, r.b, (1.0 - m));
}
struct ReflectionProbe {
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
vec3 boxMin;
vec3 boxMax;
vec3 posW;
#else
vec4 boxMin;
vec4 boxMax;
vec4 posW;
#endif
};
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform LightBuffer {
vec4 lightmapSize;
vec4 lightmapThreshold;
ReflectionProbe reflectionProbes[3];
int reflectionProbesCount;
};
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform GlobalBuffer {
mat4 unjitteredInvProjMatrix;
mat4 unjitteredPrevViewProjMatrix;
vec4 viewSpaceFrustumRayDirections[4];
vec4 viewSpaceFrustumRayOrigins[4];
vec2 zNear_zFar;
vec4 fogDistStart_DistDensity_HeightStart_HeightDensity;
vec4 fogColor;
vec4 camera_exposure_gamma;
float colorMapIntensity;
float time;
vec2 texelSize;
vec2 renderTargetSize;
float deltaTime;
float velocityFactor;
vec2 jitterOffset;
float temporalAaHistoryWeight;
bool allTaaSamplesAccumulated;
vec2 neighbourhoodTexelOffsets[8];
float accumulatedStaticTaaSamples;
vec4 screenResolution;
float lightmapMode;
float dynamicTaaHistoryMultiplier;
};
#define uFogColor fogColor.xyz
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform CameraBuffer {
mat4 projectionMatrix;
mat4 viewProjMatrix;
mat4 viewMatrix;
mat4 invViewMatrix;
vec4 cameraPosition_pad;
};
#define uCameraPosition cameraPosition_pad.xyz
#endif
#ifdef USE_FOG
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec4 fogDistStart_DistDensity_HeightStart_HeightDensity;
uniform vec3 uFogColor;
#endif
const float LOG2 = 1.442695;
vec3 addFog(in vec3 colorIn, in float distance, in vec3 positionW) {
float distanceValue = max(0.0, distance - fogDistStart_DistDensity_HeightStart_HeightDensity.x);
float distanceDensity = fogDistStart_DistDensity_HeightStart_HeightDensity.y;
float distanceFogExp =
1.0 - exp2(-distanceDensity * distanceDensity * distanceValue * distanceValue * LOG2);
float heightValue = max(0.0, -positionW.z + fogDistStart_DistDensity_HeightStart_HeightDensity.z);
float heightDensity = fogDistStart_DistDensity_HeightStart_HeightDensity.w;
float heightFogExp =
1.0 - exp2(-heightDensity * heightDensity * heightValue * heightValue * LOG2);
float fogAmount = min(1.0, distanceFogExp + heightFogExp);
return mix(colorIn, uFogColor.xyz, fogAmount);
}
#endif
in vec3 vPositionW;
in vec3 vNormalW;
in vec2 vUv0;
#if defined(USE_BUMP_TEXTURE) || defined(USE_FOG)
in vec3 vPositionV;
#endif
vec3 rgbToHsl(vec3 rgb) {
vec3 hsl = vec3(0.0);
float fMin = min(min(rgb.r, rgb.g), rgb.b);
float fMax = max(max(rgb.r, rgb.g), rgb.b);
float delta = fMax - fMin;
hsl.z = (fMax + fMin) / 2.0;  // Luminance
if (delta == 0.0) {
return hsl;
}
hsl.y = delta / ((hsl.z <= 0.5) ? (fMax + fMin) : (2.0 - fMax - fMin));
float denom = 6.0 * delta;
if (rgb.r == fMax) {
hsl.x = (rgb.g - rgb.b) / denom;
} else if (rgb.g == fMax) {
hsl.x = (rgb.b - rgb.r) / denom + (1.0 / 3.0);
} else if (rgb.b == fMax) {
hsl.x = (rgb.r - rgb.g) / denom + (2.0 / 3.0);
}
if (hsl.x < 0.0) {
hsl.x += 1.0;
}
if (hsl.x > 1.0) {
hsl.x -= 1.0;
}
return hsl;
}
float hueToRgb(float p, float q, float hue) {
if (hue < 0.0) {
hue += 1.0;
}
if (hue > 1.0) {
hue -= 1.0;
}
float res;
if (6.0 * hue < 1.0) {
res = p + (q - p) * 6.0 * hue;
} else if (2.0 * hue < 1.0) {
res = q;
} else if (3.0 * hue < 2.0) {
res = p + (q - p) * ((2.0 / 3.0) - hue) * 6.0;
} else {
res = p;
}
return res;
}
vec3 hslToRgb(vec3 hsl) {
vec3 rgb;
if (hsl.y == 0.0) {
return vec3(hsl.z);
}
float q = hsl.z < 0.5 ? hsl.z * (1.0 + hsl.y) : (hsl.z + hsl.y) - (hsl.y * hsl.z);
float p = 2.0 * hsl.z - q;
rgb.r = hueToRgb(p, q, hsl.x + (1.0 / 3.0));
rgb.g = hueToRgb(p, q, hsl.x);
rgb.b = hueToRgb(p, q, hsl.x - (1.0 / 3.0));
return rgb;
}
vec3 adjustContrast(vec3 col, float contrast) {
float factor = (1.0 + contrast);
return clamp(vec3(factor * (col.r - 0.5) + 0.5, factor * (col.g - 0.5) + 0.5,
factor * (col.b - 0.5) + 0.5),
vec3(0.0), vec3(1.0));
}
float modOne(float x) {
if (x < 0.0) {
return 1.0 - (float(int(x)) - x);
}
return x - float(int(x));
}
float adjustComponent(float component, float adjustment) {
return clamp(component * (1.0 + adjustment), 0.0, 1.0);
}
float adjustContrastInComponent(float component, float contrast) {
return clamp((1.0 + contrast) * (component - 0.5) + 0.5, 0.0, 1.0);
}
vec3 applyBaseColorCorrection(vec3 color, vec4 colorCorrection) {
if (colorCorrection.x != 0.0 || colorCorrection.y != 0.0 || colorCorrection.z != 0.0) {
vec3 colorInHSL = rgbToHsl(color);
colorInHSL = vec3(modOne(colorInHSL.x + colorCorrection.x),
adjustComponent(colorInHSL.y, colorCorrection.y),
adjustComponent(colorInHSL.z, colorCorrection.z));
color = hslToRgb(colorInHSL);
}
if (colorCorrection.a == 0.0)
return color;
return adjustContrast(color, colorCorrection.a);
}
float desaturate(vec4 color) {
float minComp = min(min(color.r, color.g), color.b);
float maxComp = max(max(color.r, color.g), color.b);
return minComp * 0.5 + maxComp * 0.5;
}
float applyMapCorrection(vec4 color, vec4 correction) {
float value = desaturate(color);
float inversion = correction.r;
float scale = correction.g;
float contrast = correction.b;
value = clamp(scale * value + inversion, 0.0, 1.0);
if (contrast == 0.0)
return value;
value = adjustContrastInComponent(value, contrast);
return value;
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#ifdef ANTI_TILING_REGULAR
uniform float antiTilingRegularStepX;
uniform float antiTilingRegularStepY;
uniform float antiTilingRegularMaxOffsetX;
uniform float antiTilingRegularMaxOffsetY;
#endif
#endif
float hash(vec2 p) {
vec3 p3 = fract(vec3(p.xyx) * 0.13);
p3 += dot(p3, p3.yzx + 3.333);
return fract((p3.x + p3.y) * p3.z);
}
float noise2d(vec2 x) {
vec2 i = floor(x);
vec2 f = fract(x);
float a = hash(i);
float b = hash(i + vec2(1.0, 0.0));
float c = hash(i + vec2(0.0, 1.0));
float d = hash(i + vec2(1.0, 1.0));
vec2 u = f * f * (3.0 - 2.0 * f);
return mix(a, b, u.x) + (c - a) * u.y * (1.0 - u.x) + (d - b) * u.x * u.y;
}
float sum(vec3 v) {
return v.x + v.y + v.z;
}
vec4 textureNoTileOrganic(sampler2D sampler, in vec2 x) {
float k = noise2d(x);
vec2 duvdx = dFdx(x);
vec2 duvdy = dFdy(x);
float l = k * 8.0;
float f = fract(l);
float ia = floor(l + 0.5);
float ib = floor(l);
f = min(f, 1.0 - f) * 2.0;
vec2 offa = sin(vec2(3.0, 7.0) * ia);
vec2 offb = sin(vec2(3.0, 7.0) * ib);
vec3 cola = textureGrad(sampler, x + offa, duvdx, duvdy).xyz;
vec3 colb = textureGrad(sampler, x + offb, duvdx, duvdy).xyz;
vec3 res = mix(cola, colb, smoothstep(0.1, 0.9, f - 0.1 * sum(cola - colb)));
return vec4(res.x, res.y, res.z, texture(sampler, x).a);
}
float toStepX(float x) {
#ifdef ANTI_TILING_REGULAR
float stepVal = antiTilingRegularStepX;
return floor(x * antiTilingRegularMaxOffsetX / stepVal) * stepVal;
#else
return floor(x);
#endif
}
float toStepY(float x) {
#ifdef ANTI_TILING_REGULAR
float stepVal = antiTilingRegularStepY;
return floor(x * antiTilingRegularMaxOffsetY / stepVal) * stepVal;
#else
return floor(x);
#endif
}
vec4 hash4(vec2 p) {
return fract(tan(vec4(1.0 + dot(p, vec2(37.0, 17.0)), 2.0 + dot(p, vec2(11.0, 47.0)),
3.0 + dot(p, vec2(41.0, 29.0)), 4.0 + dot(p, vec2(23.0, 31.0)))) *
103.0);
}
vec4 textureNoTilerRegular(sampler2D samp, in vec2 uv) {
vec2 iuv = floor(uv);
vec2 fuv = fract(uv);
vec4 ofa = hash4(iuv + vec2(0.0, 0.0));
vec4 ofb = hash4(iuv + vec2(1.0, 0.0));
vec4 ofc = hash4(iuv + vec2(0.0, 1.0));
vec4 ofd = hash4(iuv + vec2(1.0, 1.0));
vec2 ddx = dFdx(uv);
vec2 ddy = dFdy(uv);
#ifdef ANTI_TILING_REGULAR_MIRROR_X
ofa.z = sign(ofa.z - 0.5);
ofb.z = sign(ofb.z - 0.5);
ofc.z = sign(ofc.z - 0.5);
ofd.z = sign(ofd.z - 0.5);
#else
ofa.z = 1.0;
ofb.z = 1.0;
ofc.z = 1.0;
ofd.z = 1.0;
#endif
#ifdef ANTI_TILING_REGULAR_MIRROR_Y
ofa.w = sign(ofa.w - 0.5);
ofb.w = sign(ofb.w - 0.5);
ofc.w = sign(ofc.w - 0.5);
ofd.w = sign(ofd.w - 0.5);
#else
ofa.w = 1.0;
ofb.w = 1.0;
ofc.w = 1.0;
ofd.w = 1.0;
#endif
vec2 uva = uv * ofa.zw + vec2(toStepX(ofa.x), toStepY(ofa.y));
vec2 ddxa = ddx * ofa.zw;
vec2 ddya = ddy * ofa.zw;
vec2 uvb = uv * ofb.zw + vec2(toStepX(ofb.x), toStepY(ofb.y));
vec2 ddxb = ddx * ofb.zw;
vec2 ddyb = ddy * ofb.zw;
vec2 uvc = uv * ofc.zw + vec2(toStepX(ofc.x), toStepY(ofc.y));
vec2 ddxc = ddx * ofc.zw;
vec2 ddyc = ddy * ofc.zw;
vec2 uvd = uv * ofd.zw + vec2(toStepX(ofd.x), toStepY(ofd.y));
vec2 ddxd = ddx * ofd.zw;
vec2 ddyd = ddy * ofd.zw;
vec2 b = smoothstep(0.45, 0.55, fuv);
return mix(mix(textureGrad(samp, uva, ddxa, ddya), textureGrad(samp, uvb, ddxb, ddyb), b.x),
mix(textureGrad(samp, uvc, ddxc, ddyc), textureGrad(samp, uvd, ddxd, ddyd), b.x), b.y);
}
vec4 textureWithOptionalAntiTiling(sampler2D text, in vec2 uv) {
#ifdef ANTI_TILING_ORGANIC
return textureNoTileOrganic(text, uv);
#else
#ifdef ANTI_TILING_REGULAR
return textureNoTilerRegular(text, uv);
#else
return texture(text, uv);
#endif
#endif
}
#if defined(USE_BUMP_TEXTURE)
in vec3 vNormalV;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec4 bumpCorrection;
uniform float bumpScale;
#endif
uniform sampler2D bumpTexture;
float bumpTextureCorrected(vec2 coord) {
return applyMapCorrection(textureWithOptionalAntiTiling(bumpTexture, coord), bumpCorrection);
}
vec2 dBumpdxy() {
vec2 texdx = dFdx(vUv0);
vec2 texdy = dFdy(vUv0);
float Hll = bumpScale * bumpTextureCorrected(vUv0);
float dBx = bumpScale * bumpTextureCorrected(vUv0 + texdx) - Hll;
float dBy = bumpScale * bumpTextureCorrected(vUv0 + texdy) - Hll;
return vec2(dBx, dBy);
}
vec3 perturbNormal(in vec3 surfPos, in vec3 surfNorm) {
vec2 dBdxy = dBumpdxy();
vec3 vSigmaX = dFdx(surfPos);
vec3 vSigmaY = dFdy(surfPos);
vec3 R1 = cross(vSigmaY, surfNorm);
vec3 R2 = cross(surfNorm, vSigmaX);
float fDet = dot(vSigmaX, R1);
vec3 vGrad = sign(fDet) * (dBdxy.x * R1 + dBdxy.y * R2);
return normalize(abs(fDet) * surfNorm - vGrad);
}
#endif
#ifdef USE_BASE_COLOR_TEXTURE
uniform sampler2D baseColorTexture;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec4 baseColorAtlasUvMod;
uniform float alphaDiscardThreshold;
#endif
#else
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec3 uBaseColor;
#endif
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float opacity;
#ifdef USE_CUTOUT_MASK
uniform float cutoutMaskThreshold;
#endif
uniform vec4 baseColorCorrection;
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
vec3 getBaseColorHook(out float alpha);
vec3 getBaseColor(out float alpha) {
#ifdef USE_BASE_COLOR_TEXTURE
vec2 uv = vUv0;
#ifdef USE_BASE_COLOR_TEXTURE_ATLAS_REPEAT
vec2 uvScaled = uv * baseColorAtlasUvMod.zw;
vec2 dfdx = dFdx(uvScaled);
vec2 dfdy = dFdy(uvScaled);
uv = fract(uv) * baseColorAtlasUvMod.zw + baseColorAtlasUvMod.xy;
vec4 baseColorGamma = textureGrad(baseColorTexture, uv, dfdx, dfdy);
float textureAlpha = baseColorGamma.a;
#else
uv = uv * baseColorAtlasUvMod.zw + baseColorAtlasUvMod.xy;
#ifdef USE_ALPHA_IN_LOWER_HALF
vec4 baseColorGamma = textureWithOptionalAntiTiling(baseColorTexture, vec2(uv.x, .5 + .5 * uv.y));
float textureAlpha = texture(baseColorTexture, vec2(uv.x, .5 * uv.y)).r;
#else
vec4 baseColorGamma = textureWithOptionalAntiTiling(baseColorTexture, uv);
float textureAlpha = baseColorGamma.a;
#endif
#endif
vec3 baseColor = gammaToLinear(baseColorGamma.rgb);
#ifdef USE_CUTOUT_MASK
alpha = step(cutoutMaskThreshold, textureAlpha);
if (alpha == 0.0)
discard;
#else
alpha = opacity * textureAlpha;
#endif
vec3 resultBaseColor = applyBaseColorCorrection(baseColor, baseColorCorrection);
#else  // NOT USE_BASE_COLOR_TEXTURE
alpha = opacity;
vec3 resultBaseColor = uBaseColor;
#endif
return resultBaseColor;
}
#ifdef LIVE_LIGHTMAP
uniform sampler2D liveLightmap;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float lightmapMode;
uniform vec4 screenResolution;
#endif
#endif
#ifdef USE_LIGHTMAP
centroid in vec2 vUv1;
uniform sampler2D lightmap;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec4 lightmapSize;
uniform vec2 lightmapThreshold;
#endif
#endif  // NOT USE_LIGHTMAP
vec3 getLightIntensity() {
#ifdef LIVE_LIGHTMAP
if (lightmapMode == 1.0)
return texture(liveLightmap, gl_FragCoord.xy / screenResolution.xy).xyz;
if (lightmapMode == -1.0)
return vec3(1.0);
#endif
#ifdef USE_LIGHTMAP
vec2 uv = vec2(vUv1.x, vUv1.y);
#ifdef LIGHTMAP_YCOCGM
return ycocgToRgb(hdrDecodeYcocgmBilinear(lightmap, lightmapSize.xy, lightmapSize.zw,
lightmapThreshold.xy, uv));
#else  // LIGHTMAP_RGBM
return hdrDecodeRgbmBilinear(lightmap, lightmapSize.xy, lightmapSize.zw, uv);
#endif
#else  // ifndef USE_LIGHTMAP
return vec3(1.0);
#endif
}
#if defined(USE_ENVMAP)
#define USE_NORMAL_MAPPING_FUNCS
uniform sampler2D roughnessTexture;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec4 roughnessCorrection;
uniform float roughness;
#endif
float getRoughness() {
#ifdef USE_ROUGHNESS_TEXTURE
return applyMapCorrection(textureWithOptionalAntiTiling(roughnessTexture, vUv0),
roughnessCorrection);
#else
return roughness;
#endif
}
uniform sampler2D metallicTexture;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec4 metallicCorrection;
uniform float metallic;
#endif
float getMetallic() {
#ifdef USE_METALLIC_TEXTURE
return applyMapCorrection(textureWithOptionalAntiTiling(metallicTexture, vUv0),
metallicCorrection);
#else
return metallic;
#endif
}
#ifdef USE_BRDF_TEXTURE
vec2 decodeNormalizedFloatsFromRGBA8(vec4 encoded) {
float value1 = (encoded.r * 255.0 * 256.0) + (encoded.g * 255.0);
float value2 = (encoded.b * 255.0 * 256.0) + (encoded.a * 255.0);
value1 /= 65535.0;
value2 /= 65535.0;
return vec2(value1, value2);
}
uniform sampler2D brdfLUT;
#endif
vec3 envBRDFApprox(vec3 specularColor, float roughness, float NoV) {
const vec4 c0 = vec4(-1, -0.0275, -0.572, 0.022);
const vec4 c1 = vec4(1, 0.0425, 1.04, -0.04);
vec4 r = roughness * c0 + c1;
float a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;
vec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;
return specularColor * AB.x + AB.y;
}
vec3 getBrdf(float roughness, vec3 fresnel, float clampCosnv, vec3 specularColor) {
#ifdef USE_BRDF_TEXTURE
vec4 brdfEncoded = texture(brdfLUT, vec2(clampCosnv, roughness)).rgba;
vec2 brdf = decodeNormalizedFloatsFromRGBA8(brdfEncoded);
return fresnel * brdf.x + brdf.y;
#else
return envBRDFApprox(specularColor, roughness, clampCosnv);
#endif
}
uniform samplerCube envMap[MAX_REFLECTION_PROBES];
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float envMipsCount;
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform ReflectionProbe reflectionProbes[MAX_REFLECTION_PROBES];
#ifdef USE_REFLECTION_PROBE_BLENDING
uniform int reflectionProbesCount;
#endif  // USE_REFLECTION_PROBE_BLENDING
#endif    // DEV_DISABLE_UNIFORM_BUFFERS
struct EnvMapLevel {
float mipLevel0;
float mipLevel1;
float mipMixFactor;
};
EnvMapLevel getEnvMapLevel(float roughness) {
EnvMapLevel result;
float maxMipLevel = envMipsCount - 1.0;
float mipSelector = roughness * maxMipLevel;
result.mipLevel0 = floor(mipSelector);
result.mipLevel1 = min(result.mipLevel0 + 1.0, maxMipLevel);
result.mipMixFactor = fract(mipSelector);
return result;
}
const vec3 infBox = vec3(1000.0);
vec3 cubeMapProject(vec3 reflectionW, in ReflectionProbe reflectionProbe) {
vec3 firstPlaneIntersect = (reflectionProbe.boxMax.xyz - vPositionW) / reflectionW;
vec3 secondPlaneIntersect = (reflectionProbe.boxMin.xyz - vPositionW) / reflectionW;
vec3 furthestPlane = max(firstPlaneIntersect, secondPlaneIntersect);
vec3 furthestPlaneNonNeg = step(0.0, -furthestPlane) * infBox + abs(furthestPlane);
float distance = min(min(furthestPlaneNonNeg.x, furthestPlaneNonNeg.y), furthestPlaneNonNeg.z);
vec3 intersectionPosW = vPositionW + reflectionW * distance;
return intersectionPosW - reflectionProbe.posW.xyz;
}
float signedDistanceBox(vec3 p, vec3 b, float offset) {
vec3 q = abs(p) - b;
return length(max(q, 0.0)) + min(max(q.x, max(q.y, q.z)), 0.0) - offset;
}
float getSignedDistanceField(in ReflectionProbe probe) {
vec3 halfBox = vec3(probe.boxMax - probe.boxMin) * vec3(0.5);
vec3 boxPos = vec3(probe.boxMax + probe.boxMin) * vec3(0.5);
vec3 localPos = boxPos - vPositionW;
const float offset = 0.1;
return signedDistanceBox(localPos, halfBox, offset);
}
vec3 sampleEnvMap(in EnvMapLevel envMapLevel, in vec3 reflectionW, samplerCube envMap,
int probeIndex) {
#ifdef USE_ENVMAP_PROJECT
ReflectionProbe reflectionProbe = reflectionProbes[probeIndex];
if (reflectionProbe.boxMin.x != reflectionProbe.boxMax.x)
reflectionW = cubeMapProject(reflectionW, reflectionProbe);
#endif
vec4 cubeColorRaw0 = textureLod(envMap, reflectionW, envMapLevel.mipLevel0);
vec3 cubeColor0 = hdrDecodeRgbm(cubeColorRaw0);
vec4 cubeColorRaw1 = textureLod(envMap, reflectionW, envMapLevel.mipLevel1);
vec3 cubeColor1 = hdrDecodeRgbm(cubeColorRaw1);
return mix(cubeColor0, cubeColor1, envMapLevel.mipMixFactor);
}
vec3 sampleEnvMapBlended(in EnvMapLevel envMapLevel, in vec3 reflectionW) {
#ifdef USE_REFLECTION_PROBE_BLENDING
float weight[MAX_REFLECTION_PROBES];
#ifdef USE_ENVMAP_PROJECT
for (int i = 0; i < reflectionProbesCount; i++) {
weight[i] = max(-getSignedDistanceField(reflectionProbes[i]), 0.0);
weight[i] = smoothstep(0.0, 1.0, weight[i]);
}
float weightSum = 0.0;
for (int i = 0; i < reflectionProbesCount; i++) {
weightSum += weight[i];
}
if (weightSum == 0.0) {
weight[0] = 1.0;
} else {
for (int i = 0; i < reflectionProbesCount; i++) weight[i] /= weightSum;
}
#else
for (int i = 0; i < reflectionProbesCount; i++) weight[i] = 1.0;
#endif
vec3 envColor = vec3(0.0, 0.0, 0.0);
if (weight[0] > 0.0)
envColor += sampleEnvMap(envMapLevel, reflectionW, envMap[0], 0) * weight[0];
if (reflectionProbesCount >= 2 && weight[1] > 0.0)
envColor += sampleEnvMap(envMapLevel, reflectionW, envMap[1], 1) * weight[1];
if (reflectionProbesCount >= 3 && weight[2] > 0.0)
envColor += sampleEnvMap(envMapLevel, reflectionW, envMap[2], 2) * weight[2];
#else  // not USE_REFLECTION_PROBE_BLENDING
vec3 envColor = sampleEnvMap(envMapLevel, reflectionW, envMap[0], 0);
#endif
return envColor;
}
#endif
#ifdef USE_NORMAL_TEXTURE
uniform sampler2D normalTexture;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float normalScale;
#endif
#endif
#ifdef USE_NORMAL_MAPPING_FUNCS
vec3 computeTangent(vec2 texCoord, vec3 normalW) {
vec2 uvDiff1 = vec2(dFdx(texCoord.x), dFdy(texCoord.x));
vec2 uvDiff2 = vec2(dFdx(texCoord.y), dFdy(texCoord.y));
vec3 denormTangent = uvDiff1.x * dFdy(vPositionW) - dFdx(vPositionW) * uvDiff1.y;
vec3 tangent = denormTangent - normalW * dot(normalW, denormTangent);
float lenSq = dot(tangent, tangent);
tangent = lenSq < 1e-6 ? vec3(normalW.z, normalW.x, normalW.y) : tangent * inversesqrt(lenSq);
return tangent;
}
vec3 computeNormal() {
float faceSign = gl_FrontFacing ? 1.0 : -1.0;
#ifdef USE_NORMAL_TEXTURE
vec3 normalW = normalize(vNormalW);
vec3 tangentW = computeTangent(vUv0, normalW);
vec3 bitangentW = cross(normalW, tangentW);
vec3 value = texture(normalTexture, vUv0).xyz;
value = (value == vec3(0.0)) ? vec3(0.0, 0.0, 1.0) : value * 2.0 - 1.0;
value = tangentW * value.x * normalScale + bitangentW * value.y * normalScale + normalW * value.z;
return normalize(value) * faceSign;
#elif defined(USE_BUMP_TEXTURE)
vec3 normalPerturbedV = perturbNormal(-vPositionV, normalize(vNormalV));
return normalize(inverseTransformDirection(normalPerturbedV, viewMatrix)) * faceSign;
#else
return normalize(vNormalW) * faceSign;
#endif
}
#endif
float getEnvMapFresnel(float roughness) {
float roughness2 = roughness * roughness;
return (roughness2 - 2.0 * roughness + 1.0);
}
vec3 fresnelSchlickEnv(in vec3 specularColor, in float envMapFresnel, in float clampCosnv,
inout float opacity) {
float fresnel = 1.0 - clampCosnv;
float fresnel2 = fresnel * fresnel;
fresnel *= fresnel2 * fresnel2;
fresnel *= envMapFresnel;
opacity = opacity + (1.0 - opacity) * fresnel;
return specularColor + (1.0 - specularColor) * fresnel;
}
vec3 getSpecularColor(in vec3 baseColor, float metalic) {
const float dielectricF0 = 0.04;
return mix(vec3(dielectricF0), baseColor, metalic);
}
float getLuminance(in vec3 color) {
return 0.2126 * color.r + 0.7152 * color.g + 0.0722 * color.b;
}
#if defined(USE_ENVMAP)
vec3 addSpecular(in vec3 baseColor, in vec3 totalIntensity, inout float opacity, float metallic,
float roughness) {
vec3 totalSpec = vec3(0.0, 0.0, 0.0);
vec3 diffuseIntensity = totalIntensity * (1.0 - mix(0.04, 1.0, metallic));
vec3 viewW = normalize(uCameraPosition - vPositionW);
vec3 normalW = computeNormal();
float clampCosnv = saturate(dot(normalW, viewW));
vec3 reflectionW = normalize(reflect(-viewW, normalW));
vec3 specularColor = getSpecularColor(baseColor, metallic);
EnvMapLevel envMapLevel = getEnvMapLevel(roughness);
vec3 envColor = sampleEnvMapBlended(envMapLevel, reflectionW);
float envMapFresnel = roughness * roughness - 2.0 * roughness + 1.0;
vec3 fresnel = fresnelSchlickEnv(specularColor, envMapFresnel, clampCosnv, opacity);
float luminance = getLuminance(totalIntensity);
totalSpec = envColor * getBrdf(roughness, fresnel, clampCosnv, specularColor);
#if defined(WEAK_REFLECTION_SHADOW)
float shadowingFactor = mix(0.4, 1.0, luminance);
#else
float shadowingFactor = mix(0.4, 1.0, luminance) * mix(min(luminance, 1.0), 1.0, metallic);
#endif
return baseColor * diffuseIntensity + totalSpec * shadowingFactor;
}
vec3 addSpecular(in vec3 baseColor, in vec3 totalIntensity, inout float opacity) {
float metallic = getMetallic();
float roughness = getRoughness();
return addSpecular(baseColor, totalIntensity, opacity, metallic, roughness);
}
#else  // NOT USE_ENVMAP
vec3 addSpecular(in vec3 baseColor, in vec3 lightIntensity, in float opacity, float metallic,
float roughness) {
return baseColor * lightIntensity;
}
vec3 addSpecular(vec3 baseColor, in vec3 lightIntensity, in float opacity) {
return baseColor * lightIntensity;
}
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#ifdef USE_HIGHLIGHT
uniform vec3 uHighlight;
uniform float highlightMix;
#endif
#endif
#ifdef USE_COLORMAP
vec3 colormap(in sampler2D lut, in vec3 color, in float intensity) {
const float resolution = 16.0;
const float maxValueIndex = resolution - 1.0;
const float sliceWidth = 1.0 / resolution;
const float slicePixelWidth = sliceWidth / resolution;
const float sliceMarginWidth = 0.5 * slicePixelWidth;
const float sliceInnerWidth = sliceWidth - slicePixelWidth;
const float slicePixelHeight = 1.0 / resolution;
const float sliceMarginHeight = 0.5 * slicePixelHeight;
const float sliceInnerHeight = 1.0 - slicePixelHeight;
float bSlice0 = min(floor(color.b * maxValueIndex), maxValueIndex - 1.0);
float bSlice1 = bSlice0 + 1.0;
float bOffset = color.b * maxValueIndex - bSlice0;
float rSlicePos = sliceMarginWidth + color.r * sliceInnerWidth;
float gSlicePos = sliceMarginHeight + color.g * sliceInnerHeight;
float rPos0 = rSlicePos + (bSlice0 * sliceWidth);
float rPos1 = rSlicePos + (bSlice1 * sliceWidth);
vec3 color0 = texture(lut, vec2(rPos0, gSlicePos)).rgb;
vec3 color1 = texture(lut, vec2(rPos1, gSlicePos)).rgb;
return mix(color, mix(color0, color1, bOffset), intensity);
}
uniform sampler2D colorMap;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float colorMapIntensity;
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
#endif
#ifdef USE_CHROMA_KEY
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec3 uChromaKeyColor;
uniform vec3 uChromaKeyDeltaCoeff;
#endif
const float k32 = sqrt(3.0) / 2.0;
vec3 rgb2abi(vec3 color) {
float r = color.r;
float g = color.g;
float b = color.b;
return vec3(r - 0.5 * g - 0.5 * b, k32 * (g - b), 0.3333 * (r + g + b));
}
const float IPI2 = 0.5 / 3.1415926538;
vec3 rgb2hci(vec3 color) {
vec3 abi = rgb2abi(color);
return vec3(atan(abi.y, abi.x) * IPI2, length(abi.xy), abi.z);
}
float chromaKeyShapeFn(vec3 delta, vec3 color, vec3 key) {
vec3 diff = color - key;
vec3 v = delta * vec3(
0.5 - abs(abs(diff.x) - 0.5), abs(diff.y), abs(diff.z));
float x = max(v.r, max(v.g, v.b));
return x * x;
}
float chromaKeyEdgeFn(float a) {
return clamp(.2 / .5 * (a - 1.0), 0.0, 1.0);
}
#endif
struct BSDF {
vec3 response;
vec3 throughput;
float ior;
};
struct SurfaceShader {
vec3 color;
float transparency;
};
struct LightShader {
vec3 intensity;
vec3 direction;
};
#define M_FLOAT_EPS 1e-8
BSDF combineBsdf(BSDF topLayer, BSDF bottomLayer) {
BSDF result = BSDF(vec3(0.0), vec3(1.0), 0.0);
result.response = topLayer.response + bottomLayer.response * topLayer.throughput;
result.throughput = topLayer.throughput * bottomLayer.throughput;
return result;
}
BSDF mixBsdf(BSDF x, BSDF y, float a) {
BSDF result = BSDF(vec3(0.0), vec3(1.0), 0.0);
result.response = mix(x.response, y.response, a);
result.throughput = mix(x.throughput, y.throughput, a);
return result;
}
float square(float x) {
return x * x;
}
vec2 square(vec2 x) {
return x * x;
}
vec3 square(vec3 x) {
return x * x;
}
#define DIRECTIONAL_ALBEDO_METHOD 0
#define MAX_LIGHT_SOURCES 9
#define M_PI 3.1415926535897932
#define M_PI_INV (1.0 / M_PI)
float pow5(float x) {
return square(square(x)) * x;
}
float fresnelSchlick(float cosTheta, float F0) {
float x = clamp(1.0 - cosTheta, 0.0, 1.0);
float x5 = pow5(x);
return F0 + (1.0 - F0) * x5;
}
vec3 fresnelSchlick(float cosTheta, vec3 F0) {
float x = clamp(1.0 - cosTheta, 0.0, 1.0);
float x5 = pow5(x);
return F0 + (1.0 - F0) * x5;
}
float fresnelSchlick(float cosTheta, float F0, float F90) {
float x = clamp(1.0 - cosTheta, 0.0, 1.0);
float x5 = pow5(x);
return mix(F0, F90, x5);
}
vec3 fresnelSchlick(float cosTheta, vec3 F0, vec3 F90) {
float x = clamp(1.0 - cosTheta, 0.0, 1.0);
float x5 = pow5(x);
return mix(F0, F90, x5);
}
float fresnelSchlick(float cosTheta, float F0, float F90, float exponent) {
float x = clamp(1.0 - cosTheta, 0.0, 1.0);
return mix(F0, F90, pow(x, exponent));
}
vec3 fresnelSchlick(float cosTheta, vec3 F0, vec3 F90, float exponent) {
float x = clamp(1.0 - cosTheta, 0.0, 1.0);
return mix(F0, F90, pow(x, exponent));
}
vec3 forwardFacingNormal(vec3 N, vec3 V) {
return (dot(N, V) < 0.0) ? -N : N;
}
float goldenRatioSequence(int i) {
const float GOLDEN_RATIO = 1.6180339887498948;
return fract((float(i) + 1.0) * GOLDEN_RATIO);
}
struct FresnelData {
float ior;  // Physical Fresnel
vec3 value;
};
float ggxNdf(vec3 H, vec2 alpha) {
vec2 He = H.xy / alpha;
float denom = dot(He, He) + square(H.z);
return 1.0 / (M_PI * alpha.x * alpha.y * square(denom));
}
float ggxSmithG2(float NdotL, float NdotV, float alpha) {
float alpha2 = square(alpha);
float lambdaL = sqrt(alpha2 + (1.0 - alpha2) * square(NdotL));
float lambdaV = sqrt(alpha2 + (1.0 - alpha2) * square(NdotV));
return 2.0 / (lambdaL / NdotL + lambdaV / NdotV);
}
vec3 ggxDirAlbedo(float NdotV, float alpha, vec3 F0, vec3 F90) {
float x = NdotV;
float y = alpha;
float x2 = square(x);
float y2 = square(y);
vec4 r = vec4(0.1003, 0.9345, 1.0, 1.0) + vec4(-0.6303, -2.323, -1.765, 0.2281) * x +
vec4(9.748, 2.229, 8.263, 15.94) * y + vec4(-2.038, -3.748, 11.53, -55.83) * x * y +
vec4(29.34, 1.424, 28.96, 13.08) * x2 + vec4(-8.245, -0.7684, -7.507, 41.26) * y2 +
vec4(-26.44, 1.436, -36.11, 54.9) * x2 * y + vec4(19.99, 0.2913, 15.86, 300.2) * x * y2 +
vec4(-5.448, 0.6286, 33.37, -285.1) * x2 * y2;
vec2 AB = clamp(r.xy / r.zw, 0.0, 1.0);
return F0 * AB.x + F90 * AB.y;
}
float ggxDirAlbedo(float NdotV, float alpha, float F0, float F90) {
return ggxDirAlbedo(NdotV, alpha, vec3(F0), vec3(F90)).x;
}
vec3 ggxEnergyCompensation(float NdotV, float alpha, vec3 Fss) {
float Ess = ggxDirAlbedo(NdotV, alpha, 1.0, 1.0);
return 1.0 + Fss * (1.0 - Ess) / Ess;
}
float ggxEnergyCompensation(float NdotV, float alpha, float Fss) {
return ggxEnergyCompensation(NdotV, alpha, vec3(Fss)).x;
}
float iorToF0(float ior) {
return square((ior - 1.0) / (ior + 1.0));
}
float f0ToIor(float F0) {
float sqrtF0 = sqrt(clamp(F0, 0.01, 0.99));
return (1.0 + sqrtF0) / (1.0 - sqrtF0);
}
float fresnelDielectricValue(float ior, float cosTheta) {
if (cosTheta < 0.0)
return 1.0;
float g = ior * ior + cosTheta * cosTheta - 1.0;
if (g < 0.0)
return 1.0;
g = sqrt(g);
float gmc = g - cosTheta;
float gpc = g + cosTheta;
float x = gmc / gpc;
float y = (gpc * cosTheta - 1.0) / (gmc * cosTheta + 1.0);
return 0.5 * x * x * (1.0 + y * y);
}
FresnelData fresnelDielectric(float ior, float cosTheta) {
return FresnelData(ior, vec3(fresnelDielectricValue(ior, cosTheta)));
}
FresnelData fresnelSchlick(vec3 F0, vec3 F90, float exponent, float cosTheta) {
return FresnelData(0.0, fresnelSchlick(cosTheta, F0, F90, exponent));
}
vec3 refractionSolidSphere(vec3 R, vec3 N, float ior) {
R = refract(R, N, 1.0 / ior);
vec3 N1 = normalize(R * dot(R, N) - N * 0.5);
return refract(R, N1, ior);
}
vec3 environmentRadianceSample(vec3 normalW, vec3 viewW, float roughness) {
#ifdef USE_ENVMAP
vec3 reflectionW = reflect(-viewW, normalW);
EnvMapLevel envMapLevel = getEnvMapLevel(roughness);
return sampleEnvMapBlended(envMapLevel, reflectionW);
#else
return vec3(0.0);
#endif
}
vec3 environmentRadianceCombine(vec3 normalW, vec3 viewW, vec3 envColor, float roughness,
vec3 fresnel) {
#ifdef USE_ENVMAP
float clampCosnv = saturate(dot(normalW, viewW));  // TODO: reuse ndotv
vec3 brdf = getBrdf(roughness, fresnel, clampCosnv, vec3(1.0));
return envColor * brdf;
#else
return vec3(0.0);
#endif
}
vec3 environmentRadianceRefracted(vec3 normalW, vec3 viewW, float roughness, FresnelData fresnel) {
#ifdef USE_ENVMAP
float clampCosnv = saturate(dot(normalW, viewW));  // TODO: reuse ndotv
vec3 reflectionW = refractionSolidSphere(-viewW, normalW, fresnel.ior);
EnvMapLevel envMapLevel = getEnvMapLevel(roughness);
vec3 envColor = sampleEnvMapBlended(envMapLevel, reflectionW);
vec3 brdf = getBrdf(roughness, fresnel.value, clampCosnv, vec3(1.0));
return envColor * (vec3(1.0) - brdf);
#else
return vec3(0.0);
#endif
}
void uniformEdf(vec3 N, vec3 L, vec3 color, out vec3 result) {
result = color;
}
void extractColor3(vec3 in1, int index, out float out1) {
float N_r_color3_out = in1.x;
float N_g_color3_out = in1.y;
float N_b_color3_out = in1.z;
float N_sw_color3_out = 0.0;
if (float(index) < float(1)) {
N_sw_color3_out = N_r_color3_out;
} else if (float(index) < float(2)) {
N_sw_color3_out = N_g_color3_out;
} else if (float(index) < float(3)) {
N_sw_color3_out = N_b_color3_out;
} else if (float(index) < float(4)) {
N_sw_color3_out = 0.000000;
} else if (float(index) < float(5)) {
N_sw_color3_out = 0.000000;
}
out1 = N_sw_color3_out;
}
float orenNayarDiffuse(vec3 L, vec3 V, vec3 N, float NdotL, float roughness) {
float LdotV = clamp(dot(L, V), M_FLOAT_EPS, 1.0);
float NdotV = clamp(dot(N, V), M_FLOAT_EPS, 1.0);
float s = LdotV - NdotL * NdotV;
float stinv = (s > 0.0f) ? s / max(NdotL, NdotV) : 0.0;
float sigma2 = square(roughness * M_PI);
float A = 1.0 - 0.5 * (sigma2 / (sigma2 + 0.33));
float B = 0.45 * sigma2 / (sigma2 + 0.09);
return A + B * stinv;
}
void orenNayarDiffuseBsdfReflectionLightmap(vec3 L, vec3 V, vec3 P, float occlusion, float weight,
vec3 color, float roughness, vec3 normal,
inout BSDF bsdf) {
bsdf.throughput = vec3(0.0);
if (weight < M_FLOAT_EPS)
return;
bsdf.response = color * occlusion * weight * M_PI_INV;
if (roughness > 0.0)
bsdf.response *= orenNayarDiffuse(L, V, normal, 1.0, roughness);
}
void dielectricBsdfIndirect(vec3 V, float weight, vec3 tint, float ior, float roughness,
float roughnessSq, vec3 N, int scatter_mode, inout BSDF bsdf) {
if (weight < M_FLOAT_EPS)
return;
float NdotV = clamp(dot(N, V), M_FLOAT_EPS, 1.0);
vec3 safeTint = max(tint, 0.0);
vec3 fresnel = fresnelDielectric(ior, NdotV).value;
float F0 = iorToF0(ior);
vec3 comp = ggxEnergyCompensation(NdotV, roughnessSq, fresnel);
vec3 dirAlbedo = ggxDirAlbedo(NdotV, roughnessSq, F0, 1.0) * comp;
bsdf.throughput = 1.0 - dirAlbedo * weight;
vec3 sampledRadiance = environmentRadianceSample(N, V, roughness);
vec3 Li = environmentRadianceCombine(N, V, sampledRadiance, roughness, fresnel);
bsdf.response = Li * safeTint * comp * weight;
}
void generalizedSchlickBsdfReflection(vec3 L, vec3 V, vec3 P, float occlusion, float weight,
vec3 color0, vec3 color90, float exponent, float roughnessSq,
vec3 N, vec3 X, int distribution, int scatter_mode,
inout BSDF bsdf) {
if (weight < M_FLOAT_EPS) {
return;
}
X = normalize(X - dot(X, N) * N);
vec3 Y = cross(N, X);
vec3 H = normalize(L + V);
float NdotL = clamp(dot(N, L), M_FLOAT_EPS, 1.0);
float NdotV = clamp(dot(N, V), M_FLOAT_EPS, 1.0);
float VdotH = clamp(dot(V, H), M_FLOAT_EPS, 1.0);
vec3 Ht = vec3(dot(H, X), dot(H, Y), dot(H, N));
vec3 safeColor0 = max(color0, 0.0);
vec3 safeColor90 = max(color90, 0.0);
FresnelData fresnel = fresnelSchlick(safeColor0, safeColor90, exponent, VdotH);
float D = ggxNdf(Ht, vec2(roughnessSq));
float G = ggxSmithG2(NdotL, NdotV, roughnessSq);
vec3 comp = ggxEnergyCompensation(NdotV, roughnessSq, fresnel.value);
vec3 dirAlbedo = ggxDirAlbedo(NdotV, roughnessSq, safeColor0, safeColor90) * comp;
float avgDirAlbedo = dot(dirAlbedo, vec3(1.0 / 3.0));
bsdf.throughput = vec3(1.0 - avgDirAlbedo * weight);
bsdf.response = D * fresnel.value * G * comp * occlusion * weight / (4.0 * NdotV);
}
void generalizedSchlickBsdfIndirect(vec3 V, vec3 color0, vec3 color90, float exponent,
float roughness, float roughnessSq, vec3 N,
vec3 sampledRadiance, inout BSDF bsdf) {
float NdotV = clamp(dot(N, V), M_FLOAT_EPS, 1.0);
vec3 safeColor0 = max(color0, 0.0);
vec3 safeColor90 = max(color90, 0.0);
vec3 fresnel = fresnelSchlick(safeColor0, safeColor90, exponent, NdotV).value;
vec3 comp = ggxEnergyCompensation(NdotV, roughnessSq, fresnel);
vec3 dirAlbedo = ggxDirAlbedo(NdotV, roughnessSq, safeColor0, safeColor90) * comp;
float avgDirAlbedo = dot(dirAlbedo, vec3(1.0 / 3.0));
bsdf.throughput = vec3(1.0 - avgDirAlbedo);
vec3 Li = environmentRadianceCombine(N, V, sampledRadiance, roughness, fresnel);
bsdf.response = Li * comp;
}
vec3 surfaceTransmission(vec3 N, vec3 V, float roughness, FresnelData fresnel, vec3 tint) {
bool refractionTwoSided = true;
if (refractionTwoSided)
tint = square(tint);
return environmentRadianceRefracted(N, V, roughness, fresnel) * tint;
}
void dielectricBsdfTransmission(vec3 V, float weight, vec3 tint, float ior, float roughness,
float roughnessSq, vec3 N, int scatter_mode, inout BSDF bsdf) {
if (weight < M_FLOAT_EPS)
return;
float NdotV = clamp(dot(N, V), M_FLOAT_EPS, 1.0);
vec3 safeTint = max(tint, 0.0);
FresnelData fresnel = fresnelDielectric(ior, NdotV);
float F0 = iorToF0(ior);
vec3 comp = ggxEnergyCompensation(NdotV, roughnessSq, fresnel.value);
vec3 dirAlbedo = ggxDirAlbedo(NdotV, roughnessSq, F0, 1.0) * comp;
bsdf.throughput = 1.0 - dirAlbedo * weight;
if (scatter_mode != 0)
bsdf.response = surfaceTransmission(N, V, roughness, fresnel, safeTint) * weight;
}
void generalizedSchlickBsdfTransmission(vec3 V, float weight, vec3 color0, vec3 color90,
float exponent, float roughness, float roughnessSq, vec3 N,
int scatter_mode, inout BSDF bsdf) {
if (weight < M_FLOAT_EPS)
return;
float NdotV = clamp(dot(N, V), M_FLOAT_EPS, 1.0);
vec3 safeColor0 = max(color0, 0.0);
vec3 safeColor90 = max(color90, 0.0);
FresnelData fresnel = fresnelSchlick(safeColor0, safeColor90, exponent, NdotV);
vec3 comp = ggxEnergyCompensation(NdotV, roughnessSq, fresnel.value);
vec3 dirAlbedo = ggxDirAlbedo(NdotV, roughnessSq, safeColor0, safeColor90) * comp;
float avgDirAlbedo = dot(dirAlbedo, vec3(1.0 / 3.0));
bsdf.throughput = vec3(1.0 - avgDirAlbedo * weight);
if (scatter_mode != 0) {
float avgF0 = dot(safeColor0, vec3(1.0 / 3.0));
fresnel.ior = f0ToIor(avgF0);
bsdf.response = surfaceTransmission(N, V, roughness, fresnel, safeColor0) * weight;
}
}
struct SheenConfig {
vec3 sheenColor;
float sheenRoughness;
};
struct SheenParams {
float sheenRoughness;
float sheenIntensity;
vec3 sheenColorNormalized;
};
SheenConfig defaultSheenConfig() {
return SheenConfig(vec3(0.0), 0.0);
}
SheenParams sheenParams(SheenConfig config) {
SheenParams params;
float r = 0.0, g = 0.0, b = 0.0;
extractColor3(config.sheenColor, 0, r);
extractColor3(config.sheenColor, 1, g);
extractColor3(config.sheenColor, 2, b);
params.sheenRoughness = config.sheenRoughness;
params.sheenIntensity = max(max(r, g), b);
params.sheenColorNormalized =
params.sheenIntensity > 0.0 ? config.sheenColor / params.sheenIntensity : config.sheenColor;
return params;
}
float imageworksSheenNdf(float NdotH, float roughness) {
float invRoughness = 1.0 / max(roughness, 0.005);
float cos2 = NdotH * NdotH;
float sin2 = 1.0 - cos2;
return (2.0 + invRoughness) * pow(sin2, invRoughness * 0.5) / (2.0 * M_PI);
}
float imageworksSheenBrdf(float NdotL, float NdotV, float NdotH, float roughness) {
float D = imageworksSheenNdf(NdotH, roughness);
float F = 1.0;
float G = 1.0;
return D * F * G / (4.0 * (NdotL + NdotV - NdotL * NdotV));
}
float imageworksSheenDirAlbedo(float NdotV, float roughness) {
vec2 r =
vec2(13.67300, 1.0) + vec2(-68.78018, 61.57746) * NdotV +
vec2(799.08825, 442.78211) * roughness + vec2(-905.00061, 2597.49308) * NdotV * roughness +
vec2(60.28956, 121.81241) * square(NdotV) + vec2(1086.96473, 3045.55075) * square(roughness);
return clamp(r.x / r.y, 0.0, 1.0);
}
BSDF sheenReflectionBsdf(SheenParams params, vec3 L, vec3 V, vec3 P, float occlusion, vec3 N) {
BSDF bsdf = BSDF(vec3(0.0), vec3(1.0), 0.0);
float weight = params.sheenIntensity;
vec3 color = params.sheenColorNormalized;
float roughness = params.sheenRoughness;
if (weight < M_FLOAT_EPS)
return bsdf;
vec3 H = normalize(L + V);
float NdotL = clamp(dot(N, L), M_FLOAT_EPS, 1.0);
float NdotV = clamp(dot(N, V), M_FLOAT_EPS, 1.0);
float NdotH = clamp(dot(N, H), M_FLOAT_EPS, 1.0);
vec3 fr = color * imageworksSheenBrdf(NdotL, NdotV, NdotH, roughness);
float dirAlbedo = imageworksSheenDirAlbedo(NdotV, roughness);
bsdf.throughput = vec3(1.0 - dirAlbedo * weight);
bsdf.response = fr * NdotL * occlusion * weight;
return bsdf;
}
struct ClearcoatConfig {
float clearcoat;
float clearcoatRoughness;
};
ClearcoatConfig defaultClearcoatConfig() {
return ClearcoatConfig(0.0, 0.0);
}
struct ClearcoatParams {
float clearcoat;
float clearcoatRoughness;
float clearcoatRoughnessSq;
};
ClearcoatParams clearcoatParams(ClearcoatConfig config) {
ClearcoatParams result = ClearcoatParams(config.clearcoat, config.clearcoatRoughness, 0.0);
result.clearcoatRoughnessSq =
clamp(config.clearcoatRoughness * config.clearcoatRoughness, M_FLOAT_EPS, 1.0);
return result;
}
BSDF clearcoatReflectionBsdf(ClearcoatParams params, vec3 L, vec3 V, vec3 P, float occlusion,
vec3 normal, vec3 tangent) {
BSDF result = BSDF(vec3(0.0), vec3(1.0), 0.0);
if (params.clearcoat < M_FLOAT_EPS)
return result;
tangent = normalize(tangent - dot(tangent, normal) * normal);
vec3 Y = cross(normal, tangent);
vec3 H = normalize(L + V);
float NdotL = clamp(dot(normal, L), M_FLOAT_EPS, 1.0);
float NdotV = clamp(dot(normal, V), M_FLOAT_EPS, 1.0);
float VdotH = clamp(dot(V, H), M_FLOAT_EPS, 1.0);
vec3 Ht = vec3(dot(H, tangent), dot(H, Y), dot(H, normal));
float ior = 1.5;
FresnelData fresnel = fresnelDielectric(ior, VdotH);
float D = ggxNdf(Ht, vec2(params.clearcoatRoughnessSq));
float G = ggxSmithG2(NdotL, NdotV, params.clearcoatRoughnessSq);
float F0 = iorToF0(ior);
vec3 comp = ggxEnergyCompensation(NdotV, params.clearcoatRoughnessSq, fresnel.value);
vec3 dirAlbedo = ggxDirAlbedo(NdotV, params.clearcoatRoughnessSq, F0, 1.0) * comp;
result.throughput = 1.0 - dirAlbedo * params.clearcoat;
result.response = D * fresnel.value * G * comp * occlusion * params.clearcoat / (4.0 * NdotV);
return result;
}
BSDF clearcoatIndirectBsdf(ClearcoatParams params, vec3 V, vec3 normal) {
BSDF result = BSDF(vec3(0.0), vec3(1.0), 0.0);
dielectricBsdfIndirect(V, params.clearcoat, vec3(1.0), 1.5, params.clearcoatRoughness,
params.clearcoatRoughnessSq, normal, 0, result);
return result;
}
BSDF clearcoatTransmissionBsdf(ClearcoatParams params, vec3 V, vec3 normal) {
BSDF result = BSDF(vec3(0.0), vec3(1.0), 0.0);
dielectricBsdfTransmission(V, params.clearcoat, vec3(1.0), 1.5, params.clearcoatRoughness,
params.clearcoatRoughnessSq, normal, 0, result);
return result;
}
struct SpecularConfig {
float specular;
vec3 specularColor;
};
SpecularConfig defaultSpecularConfig() {
return SpecularConfig(1.0, vec3(1.0));
}
struct PbrConfig {
vec3 baseColor;
float metallic;
float roughness;
float occlusion;
float transmission;
float alpha;
float alphaCutoff;
float ior;
vec3 emissionColor;
float emissionStrength;
ClearcoatConfig clearcoat;
SheenConfig sheen;
SpecularConfig specular;
vec3 surfaceNormal;
vec3 surfaceTangent;
};
struct PbrParams {
vec3 dielectricF90;
vec3 dielectricF0;
float roughness;
float roughnessSq;
};
PbrConfig defaultPbrConfig(vec3 baseColor, float metallic, float roughness, vec3 normal,
vec3 tangent) {
PbrConfig params;
params.baseColor = baseColor;
params.metallic = metallic;
params.roughness = roughness;
params.occlusion = 0.0;
params.transmission = 0.0;
params.ior = 1.5;
params.alpha = 1.0;
params.alphaCutoff = 0.5;
params.emissionColor = baseColor;
params.emissionStrength = 0.0;
params.clearcoat = defaultClearcoatConfig();
params.sheen = defaultSheenConfig();
params.specular = defaultSpecularConfig();
params.surfaceNormal = normal;
params.surfaceTangent = tangent;
return params;
}
#if CUSTOM_SHADER_VERSION == 0
PbrConfig defaultPbrConfig(vec3 baseColor, float metallic, float roughness) {
return defaultPbrConfig(baseColor, metallic, roughness, vec3(0.0, 0.0, 1.0), vec3(1.0, 0.0, 0.0));
}
#endif
PbrParams pbrParams(SpecularConfig specular, float roughness, float ior) {
PbrParams params;
const float one_minus_ior_in1_tmp = 1.000000;
float one_minus_ior = one_minus_ior_in1_tmp - ior;
const float one_plus_ior_in1_tmp = 1.000000;
float one_plus_ior = one_plus_ior_in1_tmp + ior;
const vec3 dielectric_f90_in1_tmp = vec3(1.000000, 1.000000, 1.000000);
params.dielectricF90 = dielectric_f90_in1_tmp * specular.specular;
params.roughness = roughness;
params.roughnessSq = clamp(roughness * roughness, M_FLOAT_EPS, 1.0);
float ior_div = one_minus_ior / one_plus_ior;
float dielectric_f0_from_ior = ior_div * ior_div;
vec3 dielectric_f0_from_ior_specular_color = specular.specularColor * dielectric_f0_from_ior;
const float clamped_dielectric_f0_from_ior_specular_color_in2_tmp = 1.000000;
vec3 clamped_dielectric_f0_from_ior_specular_color = min(
dielectric_f0_from_ior_specular_color, clamped_dielectric_f0_from_ior_specular_color_in2_tmp);
params.dielectricF0 = clamped_dielectric_f0_from_ior_specular_color * specular.specular;
return params;
}
void fixReflectionThroughput(inout BSDF bsdf, float transmission) {
float minThroughput = max(0.8 - transmission, 0.0);
bsdf.throughput = max(bsdf.throughput, vec3(minThroughput));
}
SurfaceShader gltfPbrSurfaceShader(PbrConfig config, vec3 lightIntensity, bool useEnvMap) {
ClearcoatParams clearcoat = clearcoatParams(config.clearcoat);
SheenParams sheen = sheenParams(config.sheen);
PbrParams pbr = pbrParams(config.specular, config.roughness, config.ior);
SurfaceShader result = SurfaceShader(vec3(0.0), 0.0);
float backContrib = 0.0;
float frontContrib = 0.0;
vec3 position = vPositionW;
vec3 view = normalize(uCameraPosition - position);
vec3 normal = forwardFacingNormal(config.surfaceNormal, view);
vec3 tangent = config.surfaceTangent;
{
float occlusion = 1.0;
const float lightmapMultiplier = 3.0;
if (true) {
vec3 baseSurfaceNormal = normalize(vNormalW);
LightShader lightShader = LightShader(lightIntensity, baseSurfaceNormal);
vec3 L = lightShader.direction;
BSDF metalBsdf = BSDF(vec3(0.0), vec3(1.0), 0.0);
generalizedSchlickBsdfReflection(L, view, position, occlusion, 1.000000, config.baseColor,
vec3(1.000000, 1.000000, 1.000000), 5.000000,
pbr.roughnessSq, normal, tangent, 0, 0, metalBsdf);
BSDF diffuseBsdf = BSDF(vec3(0.0), vec3(1.0), 0.0);
orenNayarDiffuseBsdfReflectionLightmap(L, view, position, occlusion, 1.000000,
config.baseColor, 0.000000, normal, diffuseBsdf);
BSDF reflectionBsdf = BSDF(vec3(0.0), vec3(1.0), 0.0);
generalizedSchlickBsdfReflection(L, view, position, occlusion, 1.000000, pbr.dielectricF0,
pbr.dielectricF90, 5.000000, pbr.roughnessSq, normal,
tangent, 0, 0, reflectionBsdf);
fixReflectionThroughput(reflectionBsdf, config.transmission);
BSDF dielectricBsdf = combineBsdf(reflectionBsdf, diffuseBsdf);
BSDF base_mix_out = mixBsdf(dielectricBsdf, metalBsdf, config.metallic);
#ifdef USE_SHEEN
BSDF sheenBsdf = sheenReflectionBsdf(sheen, L, view, position, occlusion, normal);
fixReflectionThroughput(sheenBsdf, config.transmission);
BSDF sheenLayer = combineBsdf(sheenBsdf, base_mix_out);
vec3 sheenThroughput = sheenBsdf.throughput;
#else
BSDF sheenLayer = base_mix_out;
vec3 sheenThroughput = vec3(1.0);
#endif
#ifdef USE_CLEARCOAT
BSDF clearcoatBsdf =
clearcoatReflectionBsdf(clearcoat, L, view, position, occlusion, normal, tangent);
BSDF clearcoatLayer = combineBsdf(clearcoatBsdf, sheenLayer);
vec3 clearcoatThroughput = clearcoatBsdf.throughput;
#else
BSDF clearcoatLayer = sheenLayer;
vec3 clearcoatThroughput = vec3(1.0);
#endif
result.color += lightShader.intensity * lightmapMultiplier * clearcoatLayer.response;
float transContrib =
config.transmission *
getLuminance(reflectionBsdf.throughput * sheenThroughput * clearcoatThroughput) *
(1.0 - config.metallic);
float lightContrib = getLuminance(lightShader.intensity) * lightmapMultiplier;
backContrib += lightContrib * transContrib;
frontContrib += lightContrib * (1.0 - transContrib);
}
{
float luminance = getLuminance(lightIntensity) * 0.75;
float shadowingFactor =
mix(0.4, 1.0, luminance) * mix(min(luminance, 1.0), 1.0, config.metallic);
occlusion = shadowingFactor;
}
if (useEnvMap) {
BSDF metalBsdf = BSDF(vec3(0.0), vec3(1.0), 0.0);
vec3 sampledRadiance = environmentRadianceSample(normal, view, config.roughness);
if (config.metallic > 0.0) {
generalizedSchlickBsdfIndirect(view, config.baseColor, vec3(1.0), 5.0, pbr.roughness,
pbr.roughnessSq, normal, sampledRadiance, metalBsdf);
}
BSDF reflectionBsdf = BSDF(vec3(0.0), vec3(1.0), 0.0);
generalizedSchlickBsdfIndirect(view, pbr.dielectricF0, pbr.dielectricF90, 5.0, pbr.roughness,
pbr.roughnessSq, normal, sampledRadiance, reflectionBsdf);
BSDF dielectricBsdf = reflectionBsdf;
BSDF base_mix_out = mixBsdf(dielectricBsdf, metalBsdf, config.metallic);
#ifdef USE_CLEARCOAT
BSDF clearcoatBsdf = clearcoatIndirectBsdf(clearcoat, view, normal);
BSDF clearcoatLayer = combineBsdf(clearcoatBsdf, base_mix_out);
vec3 clearcoatThroughput = clearcoatBsdf.throughput;
#else
BSDF clearcoatLayer = base_mix_out;
vec3 clearcoatThroughput = vec3(1.0);
#endif
result.color += occlusion * clearcoatLayer.response;
float transContrib = config.transmission *
getLuminance(reflectionBsdf.throughput * clearcoatThroughput) *
(1.0 - config.metallic);
backContrib += transContrib * occlusion;
frontContrib += (1.0 - transContrib) * occlusion;
}
if (true) {
vec3 emission_out = vec3(0.0);
uniformEdf(normal, view, config.emissionColor * config.emissionStrength, emission_out);
result.color += emission_out;
}
if (config.transmission > 0.0 && useEnvMap) {
BSDF metalBsdf = BSDF(vec3(0.0), vec3(1.0), 0.0);
generalizedSchlickBsdfTransmission(view, 1.000000, config.baseColor,
vec3(1.000000, 1.000000, 1.000000), 5.000000,
pbr.roughness, pbr.roughnessSq, normal, 0, metalBsdf);
BSDF diffuseBsdf = BSDF(vec3(0.0), vec3(1.0), 0.0);
BSDF reflectionBsdf = BSDF(vec3(0.0), vec3(1.0), 0.0);
generalizedSchlickBsdfTransmission(view, 1.000000, pbr.dielectricF0, pbr.dielectricF90,
5.000000, pbr.roughness, pbr.roughnessSq, normal, 0,
reflectionBsdf);
BSDF transmissionBsdf = BSDF(vec3(0.0), vec3(1.0), 0.0);
dielectricBsdfTransmission(view, 1.000000, config.baseColor, config.ior, pbr.roughness,
pbr.roughnessSq, normal, 1, transmissionBsdf);
BSDF transmission_mix_out = mixBsdf(diffuseBsdf, transmissionBsdf, config.transmission);
BSDF dielectricBsdf = combineBsdf(reflectionBsdf, transmission_mix_out);
BSDF base_mix_out = mixBsdf(dielectricBsdf, metalBsdf, config.metallic);
#ifdef USE_CLEARCOAT
BSDF clearcoatBsdf = clearcoatTransmissionBsdf(clearcoat, view, normal);
BSDF clearcoatLayer = combineBsdf(clearcoatBsdf, base_mix_out);
#else
BSDF clearcoatLayer = base_mix_out;
#endif
result.color += clearcoatLayer.response;
frontContrib += getLuminance(clearcoatLayer.response);
}
result.transparency = backContrib / (frontContrib + backContrib + 0.015);
}
return result;
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float emissionStrength;
#ifdef USE_EXPOSURE_AND_GAMMA
uniform vec4 camera_exposure_gamma;
#else
const vec4 camera_exposure_gamma = vec4(1.0, 1.0, 0.0, 0.0);
#endif
uniform int u_hdrOutput;
uniform int u_useEnvMap;
#ifndef CUSTOM_PBR_SHADER
uniform vec2 clearcoat;  // clearcoatStrength, clearcoatRoughness
uniform vec4 sheen;      // sheenColor (RGB), sheenRoughness
uniform vec4 specular;   // specularColor (RGB), specularStrength
#endif
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
float lengthSq(vec2 v) {
return dot(v, v);
}
vec3 computeTangentAdvanced(vec2 texCoord, vec3 normalW) {
#ifdef USES_TEX_COORDS
return computeTangent(texCoord, normalW);
#else
vec3 denormTangent = dFdx(vPositionW);
return normalize(denormTangent - normalW * dot(normalW, denormTangent));
#endif
}
void NG_shpk_wrapper(vec3 shpk_positionW, vec3 shpk_normalW, vec3 shpk_tangentW,
vec3 shpk_bitangentW, vec2 shpk_texcoordW, float shpk_time, out PbrConfig);
#define ALPHA_MODE_OPAQUE 0
#define ALPHA_MODE_MASK 1
#define ALPHA_MODE_BLEND 2
void main() {
vec2 texCoord = vUv0;
bool useEnvMap = false;
#ifdef USE_ENVMAP
useEnvMap = u_useEnvMap == 1;
#endif
#ifdef CUSTOM_PBR_SHADER
vec3 normalW = normalize((gl_FrontFacing ? 1.0 : -1.0) * vNormalW);
vec3 tangentW = computeTangentAdvanced(texCoord, normalW);
vec3 bitangentW = cross(normalW, tangentW);
PbrConfig pbr;
NG_shpk_wrapper(vPositionW, normalW, tangentW, bitangentW, texCoord, 0.0, pbr);
#if CUSTOM_SHADER_VERSION == 0
pbr.surfaceNormal = normalW;
pbr.surfaceTangent = tangentW;
#endif
if (ALPHA_MODE == ALPHA_MODE_MASK) {
if (pbr.alpha < pbr.alphaCutoff)
discard;
}
float alpha = ALPHA_MODE == 0 ? 1.0 : pbr.alpha;
#else
float alpha;
vec3 baseColor = getBaseColorHook(alpha);
vec3 normalW = computeNormal();
vec3 tangentW = computeTangentAdvanced(texCoord, normalW);
#ifdef USE_CHROMA_KEY
float dist = chromaKeyShapeFn(uChromaKeyDeltaCoeff, rgb2hci(baseColor), rgb2hci(uChromaKeyColor));
alpha *= chromaKeyEdgeFn(dist);
#endif
#if defined(USE_BASE_COLOR_TEXTURE)
if (alpha < alphaDiscardThreshold)
discard;
#endif
float roughness = 1.0;
float metallic = 0.0;
#ifdef USE_ENVMAP
if (useEnvMap) {
roughness = getRoughness();
metallic = getMetallic();
}
#endif
PbrConfig pbr = defaultPbrConfig(baseColor, metallic, roughness, normalW, tangentW);
pbr.emissionStrength = emissionStrength;
pbr.clearcoat.clearcoat = clearcoat.x;
pbr.clearcoat.clearcoatRoughness = clearcoat.y;
pbr.sheen.sheenColor = sheen.rgb;
pbr.sheen.sheenRoughness = sheen.w;
pbr.specular.specularColor = specular.rgb;
pbr.specular.specular = specular.w;
{
vec3 viewW = normalize(uCameraPosition - vPositionW);
float clampCosnv = saturate(dot(normalW, viewW));
float envMapFresnel = roughness * roughness - 2.0 * roughness + 1.0;
fresnelSchlickEnv(pbr.specular.specularColor, envMapFresnel, clampCosnv, alpha);
}
#endif  // !CUSTOM_PBR_SHADER
#ifdef USE_HIGHLIGHT
if (highlightMix != 0.0) {
pbr.baseColor = mix(pbr.baseColor, uHighlight, highlightMix);
alpha = mix(alpha, 1.0, highlightMix);
}
#endif
#ifdef USE_STANDARD_PBR_MODEL
vec3 lightIntensity = getLightIntensity();
if (ALPHA_MODE == ALPHA_MODE_BLEND && pbr.transmission > 0.0) {
pbr.metallic = min(pbr.metallic + 0.5, 1.0);
alpha = alpha * (1.0 - min(0.8, pbr.transmission));
}
vec3 result = addSpecular(pbr.baseColor, lightIntensity, alpha, pbr.metallic, pbr.roughness);
result = result + pbr.baseColor * pbr.emissionColor * pbr.emissionStrength;
if (pbr.metallic > 0.0) {
vec3 view = normalize(uCameraPosition - vPositionW);
vec3 normal = forwardFacingNormal(pbr.surfaceNormal, view);
BSDF metalBsdf = BSDF(vec3(0.0), vec3(1.0), 0.0);
float roughnessSq = clamp(pbr.roughness * pbr.roughness, M_FLOAT_EPS, 1.0);
generalizedSchlickBsdfReflection(normalize(vNormalW), view, vPositionW, 1.0, 1.0, pbr.baseColor,
vec3(1.0), 5.0, roughnessSq, normal, pbr.surfaceTangent, 0, 0,
metalBsdf);
result = result + metalBsdf.response * pbr.metallic;
}
#ifdef USE_SHEEN
SheenParams sheen = sheenParams(pbr.sheen);
if (sheen.sheenIntensity > 0.0) {
vec3 view = normalize(uCameraPosition - vPositionW);
vec3 normal = forwardFacingNormal(pbr.surfaceNormal, view);
BSDF sheenBsdf = sheenReflectionBsdf(sheen, normalize(vNormalW), view, vPositionW, 1.0, normal);
fixReflectionThroughput(sheenBsdf, pbr.transmission);
result = result * sheenBsdf.throughput + sheenBsdf.response;
}
#endif
#else
vec3 lightIntensity = getLightIntensity();
SurfaceShader resultFull = gltfPbrSurfaceShader(pbr, lightIntensity, useEnvMap);
vec3 result = resultFull.color;
if (ALPHA_MODE == ALPHA_MODE_BLEND && pbr.transmission > 0.0) {
alpha = alpha * (1.0 - resultFull.transparency);
}
#endif  // !USE_STANDARD_PBR_MODEL
#ifdef USE_FOG
float distance = length(vPositionV);
result = addFog(result, distance, vPositionW);
#endif
if (u_hdrOutput == 1) {
if (alpha < 0.5)
discard;
fragColor = hdrEncode(result);
} else {
vec3 exposedColor = pow(camera_exposure_gamma.x * result.xyz, vec3(camera_exposure_gamma.y));
vec3 gammaColor = linearToGammaToneMapped(exposedColor);
#ifdef USE_COLORMAP
fragColor = vec4(colormap(colorMap, min(gammaColor, 1.0), colorMapIntensity), alpha);
#else
fragColor = vec4(gammaColor, alpha);
#endif
}
}
`,"universal_material_vertex.glsl":`const float PI = 3.14159265358979;
const float RECIPROCAL_PI2 = 0.15915494;
float saturate(in float a) {
return clamp(a, 0.0, 1.0);
}
vec3 inverseTransformDirection(in vec3 normal, in mat4 matrix) {
return normalize((vec4(normal, 0.0) * matrix).xyz);
}
vec3 sphericalDecode(in vec2 spNormal) {
float theta = (spNormal.x / 254.0 + 0.5) * PI;
float phi = spNormal.y * (PI / 127.0);
float sinTheta = sin(theta);
return vec3(sinTheta * cos(phi), sinTheta * sin(phi), cos(theta));
}
vec4 transformPosition() {
return vec4(t0.x * position.x + t0.y * position.y + t0.z * position.z + t0.w,
t1.x * position.x + t1.y * position.y + t1.z * position.z + t1.w,
t2.x * position.x + t2.y * position.y + t2.z * position.z + t2.w, 1.0);
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform CameraBuffer {
mat4 projectionMatrix;
mat4 viewProjMatrix;
mat4 viewMatrix;
mat4 invViewMatrix;
vec4 cameraPosition_pad;
};
#define uCameraPosition cameraPosition_pad.xyz
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#define INSERT_MODEL_VIEW_MATRIX
#define MODEL_MATRIX
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = projectionMatrix * modelViewMatrix * worldPos;
}
#else  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec4 worldPos) {
#ifdef MODEL_MATRIX
gl_Position = viewProjMatrix * modelMatrix * worldPos;
#else
gl_Position = viewProjMatrix * worldPos;
#endif  // MODEL_MATRIX
}
#ifdef MODEL_MATRIX
#define INSERT_MODEL_VIEW_MATRIX mat4 modelViewMatrix = viewMatrix * modelMatrix;
#else
#define INSERT_MODEL_VIEW_MATRIX mat4 modelViewMatrix = viewMatrix;
#endif  // MODEL_MATRIX
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec3 worldPos) {
setClipPositionFromWorldPos(vec4(worldPos, 1.0));
}
void setClipPositionFromViewPos(in vec4 viewPos) {
gl_Position = projectionMatrix * viewPos;
}
void setClipPositionFromViewPos(in vec3 viewPos) {
setClipPositionFromViewPos(vec4(viewPos, 1.0));
}
vec3 multiplyPositionByModelMatrix(in vec4 position) {
#ifdef MODEL_MATRIX
return (modelMatrix * position).xyz;
#else
return position.xyz;
#endif
}
vec3 multiplyPositionByModelMatrix(in vec3 position) {
return multiplyPositionByModelMatrix(vec4(position, 1.0));
}
vec3 multiplyDirectionByModelMatrix(in vec3 direction) {
#ifdef MODEL_MATRIX
return (modelMatrix * vec4(direction, 0.0)).xyz;
#else
return direction;
#endif
}
out vec2 vUv0;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec4 uvMod0;
#endif
#ifdef USE_LIGHTMAP
centroid out vec2 vUv1;
#endif
#if defined(USE_BUMP_TEXTURE) || defined(USE_FOG)
out vec3 vPositionV;
#endif
#ifdef USE_BUMP_TEXTURE
out vec3 vNormalV;
#endif
out vec3 vPositionW;
out vec3 vNormalW;
void modifyMvPositionHook(inout vec4 mvPosition, in vec3 normal);
void main() {
vUv0 = uv0 * uvMod0.zw + uvMod0.xy;
vec4 transformedPosition = transformPosition();
INSERT_MODEL_VIEW_MATRIX
vec4 mvPosition = modelViewMatrix * transformedPosition;
#ifdef USE_LIGHTMAP
float zeroOrOne = min(uv1.x + uv1.y, 1.0);
vUv1 = uv1 * uv1Mod.zw + uv1Mod.xy * zeroOrOne;
#endif
vec3 n = sphericalDecode(sphericalNormal);
vec3 normal = vec3(dot(t0.xyz, n), dot(t1.xyz, n), dot(t2.xyz, n));
modifyMvPositionHook(mvPosition, normal);
#if defined(USE_BUMP_TEXTURE) || defined(USE_FOG)
vPositionV = -mvPosition.xyz;
#endif
#if defined(USE_BUMP_TEXTURE)
#if defined(NON_UNIFORM_SCALE)
vNormalV = normalize(mat3(normalMatrix) * normal);
#else
vNormalV = normalize(mat3(modelViewMatrix) * normal);
#endif
#endif
vPositionW = multiplyPositionByModelMatrix(transformedPosition);
vNormalW = multiplyDirectionByModelMatrix(normal);
vNormalW = normalize(vNormalW);
gl_Position = projectionMatrix * mvPosition;
}
`,"water.glsl":`#ifdef USE_NORMAL_TEXTURE
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float time;
uniform float wavesSpeed;
uniform float wavesScale;
uniform float refractionFactor;
#endif
vec4 getNoise(in vec2 uv, in float wavesTime) {
vec2 uv0 = (uv / 103.0) + vec2(wavesTime / 17.0, wavesTime / 29.0);
vec2 uv1 = uv / 107.0 - vec2(wavesTime / -19.0, wavesTime / 31.0);
vec2 uv2 = uv / vec2(897.0, 983.0) + vec2(wavesTime / 101.0, wavesTime / 97.0);
vec2 uv3 = uv / vec2(991.0, 877.0) - vec2(wavesTime / 109.0, wavesTime / -113.0);
vec4 noise = texture(normalTexture, uv0) + texture(normalTexture, uv1) +
texture(normalTexture, uv2) + texture(normalTexture, uv3);
return noise * 0.5 - 1.0;
}
vec3 addSpecularHook(in vec3 baseColor, in vec3 totalIntensity, inout float opacity) {
vec3 toEyeW = uCameraPosition - vPositionW;
vec3 viewW = normalize(toEyeW);
vec4 noise = getNoise(vPositionW.xy * wavesScale, time * wavesSpeed);
vec3 normalW = normalize(noise.xyz);
float clampCosnv = saturate(dot(normalW, viewW));
const float waterF0 = 0.02;
vec3 specularColor = vec3(waterF0);
vec3 reflectionW = reflect(-viewW, normalW);
vec3 refractionW = refract(-viewW, normalW, 0.75);
EnvMapLevel mirrorLevel = EnvMapLevel(0.0, 0.0, 0.0);
vec3 reflectedEnv = sampleEnvMap(mirrorLevel, normalize(reflectionW), envMap[0], 0);
vec3 refractedEnv =
refractionFactor * sampleEnvMap(mirrorLevel, normalize(refractionW), envMap[0], 0);
vec3 fresnel = fresnelSchlickEnv(specularColor, 1.0, clampCosnv, opacity);
vec3 totalSpec = reflectedEnv * fresnel + refractedEnv * (1.0 - fresnel);
vec3 diffuseIntensity = totalIntensity * 0.98;
float luminance = getLuminance(totalIntensity);
return totalSpec * mix(0.4, 1.0, luminance) + baseColor * diffuseIntensity;
}
#else  // NOT USE_NORMAL_TEXTURE
vec3 addSpecularHook(in vec3 baseColor, in vec3 totalIntensity, inout float opacity) {
return baseColor * totalIntensity;
}
#endif
vec3 getBaseColorHook(out float alpha) {
return getBaseColor(alpha);
}
`,"wireframe_fragment.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec3 uLineColor;
uniform float maxDistance;
uniform float lineThickness;
uniform float backsideLineThickness;
#endif
in vec3 vBaryCentric;
in vec3 vPositionV;
const float LOG2 = 1.442695;
const float maxOpacity = 0.9;
const float minOpacity = 0.4;
const float maxSize = 1.5;
const float minSize = 0.9;
const vec3 luma = vec3(0.299, 0.587, 0.114);
float edgeFactor(float size) {
vec3 d = fwidth(vBaryCentric);
vec3 r = smoothstep(vec3(0.0), d * size, vBaryCentric);
return min(min(r.x, r.y), r.z);
}
void main(void) {
float distanceSq = dot(vPositionV, vPositionV);
float distanceExp = 1.0 - exp2(-(1.0 / maxDistance) * distanceSq * LOG2);
float opacity = max(lineThickness, mix(maxOpacity, minOpacity, distanceExp));
float size = max(lineThickness, mix(maxSize, minSize, distanceExp));
#if defined(USE_TRANSPARENT_WIREFRAME)
vec3 color = uLineColor;
if (!gl_FrontFacing) {
opacity *= 0.5;
size = max(backsideLineThickness, mix(maxSize, minSize, distanceExp));
float luminance = dot(uLineColor, luma);
color = mix(uLineColor, vec3(luminance), 0.65);
}
float edge = edgeFactor(size);
if (edge < 1.0) {
fragColor = vec4(color, (1.0 - edge) * opacity);
} else {
discard;
}
#else
opacity = (1.0 - edgeFactor(size)) * opacity;
fragColor = vec4(mix(vec3(1.0), uLineColor, opacity), 1.0);
#endif
}
`,"wireframe_vertex.glsl":`vec4 transformPosition() {
return vec4(t0.x * position.x + t0.y * position.y + t0.z * position.z + t0.w,
t1.x * position.x + t1.y * position.y + t1.z * position.z + t1.w,
t2.x * position.x + t2.y * position.y + t2.z * position.z + t2.w, 1.0);
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform CameraBuffer {
mat4 projectionMatrix;
mat4 viewProjMatrix;
mat4 viewMatrix;
mat4 invViewMatrix;
vec4 cameraPosition_pad;
};
#define uCameraPosition cameraPosition_pad.xyz
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#define INSERT_MODEL_VIEW_MATRIX
#define MODEL_MATRIX
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = projectionMatrix * modelViewMatrix * worldPos;
}
#else  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec4 worldPos) {
#ifdef MODEL_MATRIX
gl_Position = viewProjMatrix * modelMatrix * worldPos;
#else
gl_Position = viewProjMatrix * worldPos;
#endif  // MODEL_MATRIX
}
#ifdef MODEL_MATRIX
#define INSERT_MODEL_VIEW_MATRIX mat4 modelViewMatrix = viewMatrix * modelMatrix;
#else
#define INSERT_MODEL_VIEW_MATRIX mat4 modelViewMatrix = viewMatrix;
#endif  // MODEL_MATRIX
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec3 worldPos) {
setClipPositionFromWorldPos(vec4(worldPos, 1.0));
}
void setClipPositionFromViewPos(in vec4 viewPos) {
gl_Position = projectionMatrix * viewPos;
}
void setClipPositionFromViewPos(in vec3 viewPos) {
setClipPositionFromViewPos(vec4(viewPos, 1.0));
}
vec3 multiplyPositionByModelMatrix(in vec4 position) {
#ifdef MODEL_MATRIX
return (modelMatrix * position).xyz;
#else
return position.xyz;
#endif
}
vec3 multiplyPositionByModelMatrix(in vec3 position) {
return multiplyPositionByModelMatrix(vec4(position, 1.0));
}
vec3 multiplyDirectionByModelMatrix(in vec3 direction) {
#ifdef MODEL_MATRIX
return (modelMatrix * vec4(direction, 0.0)).xyz;
#else
return direction;
#endif
}
out vec3 vBaryCentric;
out vec3 vPositionV;
void main() {
int order = gl_VertexID % 3;
if (order == 0) {
vBaryCentric = vec3(1.0, 0.0, 0.0);
} else if (order == 1) {
vBaryCentric = vec3(0.0, 1.0, 0.0);
} else {
vBaryCentric = vec3(0.0, 0.0, 1.0);
}
INSERT_MODEL_VIEW_MATRIX
vec4 transformedPosition = transformPosition();
vec4 mvPosition = modelViewMatrix * transformedPosition;
vPositionV = -mvPosition.xyz;
gl_Position = projectionMatrix * modelViewMatrix * transformedPosition;
}
`},ja=class ja{constructor(t,e){o(this,"id");o(this,"code");this.id=t,this.code=e}static get(t){const i=dm[t];return new ja(t,i)}static makeInline(t){const e=ja._inlineId++;return new ja("inline_"+e,t)}static reloadShaders(t){fetch(yi("shaders.js")).then(e=>{e.text().then(i=>{const n=i.split(`
`).splice(1).join(`
`),s=JSON.parse(n),a=dm;for(const l in s)Object.prototype.hasOwnProperty.call(s,l)&&(a[l]=s[l]);t()})})}hash(){let t=0;for(let e=0;e<this.code.length;e++){const i=this.code.charCodeAt(e);t=(t<<5)-t+i,t|=0}return t}equals(t){return this.id===t.id&&this.code===t.code}};o(ja,"_inlineId",0);let zi=ja;const Ty=Object.freeze((()=>{const r=new qd,t=new Float32Array([0,0]);return r.uv0=t,r.uv1=new Uint16Array([0,0]),r.uv1Mod=new Float32Array([0,0,1/65535,1/65535]),r.t0=new Float32Array([1,0,0,0]),r.t1=new Float32Array([0,1,0,0]),r.t2=new Float32Array([0,0,1,0]),r.sphericalNormal=t,r})()),wy=Object.freeze(["position","sphericalNormal","uv0","uv1","uv1Mod","t0","t1","t2"]),um=zi.makeInline(""),Sy=Object.keys(nl).map(r=>"TONE_MAPPING_"+r),My=r=>{r===null?r=am:Object.values(nl).includes(r)||(nt(!1,"Invalid tone mapping mode value"),r=am);for(const[t,e]of Object.entries(nl))if(e==r)return"TONE_MAPPING_"+t;return""};class Py{}var fm=(r=>(r.MAJOR_LIGHTING_PROPERTY_UPDATED="majorLightingPropertyUpdated",r.MATERIAL_UPDATED="materialUpdated",r.RECOMPILE_NEEDED="recompileNeeded",r.DISPOSED="materialDisposed",r))(fm||{});const Lr=class Lr extends ci{constructor(e){super();o(this,"name","");o(this,"attributes");o(this,"vertexShaderName");o(this,"_vertexShaderBody");o(this,"_vertexShaderHooks");o(this,"fragmentShaderName");o(this,"_fragmentShaderBody");o(this,"_fragmentShaderHooks");o(this,"shaderParams");o(this,"_updated");o(this,"side",Ti.FRONT);o(this,"doNotOverrideSide",!1);o(this,"_opacity",1);o(this,"transparent",!1);o(this,"transparentRenderOrder",0);o(this,"blending",Yt.DISABLED);o(this,"blendSrc",H.SRC_ALPHA);o(this,"blendDst",H.ONE_MINUS_SRC_ALPHA);o(this,"blendEquation",H.FUNC_ADD);o(this,"blendSrcAlpha",null);o(this,"blendDstAlpha",null);o(this,"blendEquationAlpha",null);o(this,"depthTest",!0);o(this,"depthWrite",!0);o(this,"colorWrite",!0);o(this,"_hideFromLightProbes",!1);o(this,"_defines",new Set);o(this,"_definesString",null);o(this,"_lightmapSize",new We);o(this,"_lightmapThreshold",new ye);o(this,"uniforms",{});o(this,"uniformBufferData");o(this,"defaultAttributeValues",Ty);o(this,"index0AttributeName");o(this,"visible",!0);o(this,"_programNeedsUpdate",!0);o(this,"program",null);o(this,"_sharedMaterialState",null);o(this,"lightmapSupported",!1);o(this,"fogSupported",!1);o(this,"hdrOutputSupported",!1);o(this,"colorMapSupported",!1);o(this,"exposureAndGammaSupported",!1);o(this,"toneMappingSupported",!1);o(this,"renderSteps",1);o(this,"renderResourceId",-1);o(this,"_onSharedMaterialStateUpdate",()=>{this._applySharedState(),T.DEV_NEW_RENDER_ARCHITECTURE||this._updated()});Lr._materialRenderResourceIdCount+=1,this.renderResourceId=Lr._materialRenderResourceIdCount,this.shaderParams=e,this.attributes=wy,e.vsName&&e.vsName,e.fsName&&e.fsName,this.vertexShaderName=e.vsName,this._vertexShaderBody=zi.get(e.vsName),this._vertexShaderHooks=e.vsHooks?zi.get(e.vsHooks):um,this.fragmentShaderName=e.fsName,this._fragmentShaderBody=zi.get(e.fsName),this._fragmentShaderHooks=e.fsHooksCode?zi.makeInline(e.fsHooksCode):e.fsHooks?zi.get(e.fsHooks):um,this._updated=()=>this.dispatchEvent({type:Lr.eventType.MATERIAL_UPDATED}),this.uniformBufferData=e.uniformBufferData}get isAnimated(){return!1}get isPlaying(){return!1}update(e){}notifyUpdated(){this._updated()}rewind(){console.assert(!1)}play(){console.assert(!1)}pause(){console.assert(!1)}get envMapMirror(){return!1}get hideFromLightProbes(){return this._hideFromLightProbes}set hideFromLightProbes(e){this._hideFromLightProbes=e}get programNeedsUpdate(){return this._programNeedsUpdate}fillMaterialUniformDataFromUniforms(){if(!T.DEV_NEW_RENDER_ARCHITECTURE||!this.uniformBufferData)return;const e=this.uniforms;for(const i in this.uniformBufferData)if(Object.prototype.hasOwnProperty.call(this.uniformBufferData,i)&&Object.prototype.hasOwnProperty.call(e,i)){const n=e[i].value;if(typeof n=="string"){const s=+n;ha(this.uniformBufferData,i,s)}else ha(this.uniformBufferData,i,n)}for(const i in e)if(Object.prototype.hasOwnProperty.call(e,i)){const n=e[i];n.uniformSourceType===oe.MATERIAL&&n.type!=="t"&&(Object.prototype.hasOwnProperty.call(this.uniformBufferData,i),void 0)}}set programNeedsUpdate(e){this._definesString=null,this._programNeedsUpdate=e,this.dispatchEvent({type:Lr.eventType.RECOMPILE_NEEDED})}get lightmapEnabled(){return this.lightmapSupported&&this.sharedMaterialState!==null&&this.sharedMaterialState.lightmapEnabled}get sharedMaterialState(){return this._sharedMaterialState}set sharedMaterialState(e){const i=this._sharedMaterialState;if(this._sharedMaterialState=e,this._sharedMaterialState===null){i==null||i.removeEventListener(sl.eventType.UPDATED,this._onSharedMaterialStateUpdate);return}this._sharedMaterialState.addEventListener(sl.eventType.UPDATED,this._onSharedMaterialStateUpdate),this._applySharedState()}hasDefine(e){return this._defines.has(e)}addDefine(e){this.hasDefine(e)||(this._defines.add(e),this.programNeedsUpdate=!0)}removeDefine(e){this.hasDefine(e)&&(this._defines.delete(e),this.programNeedsUpdate=!0)}removeDefines(e){let i=!1;for(const n of this._defines)e(n)&&(this._defines.delete(n),i=!0);return i&&(this.programNeedsUpdate=!0),i}condDefine(e,i){return e?this.addDefine(i):this.removeDefine(i),e}getDefines(){return this._defines}_getDefinesString(){if(this._definesString===null){const e=[];for(const i of this._defines)e.push("#define "+i);e.sort(),this._definesString=e.join(`
`)}return this._definesString}generateProgramId(){return[this._fragmentShaderBody.id,this._fragmentShaderHooks.id,this._getDefinesString(),this._vertexShaderBody.id,this._vertexShaderHooks.id].join("$")}tryToRefreshShaderCode(){const e=zi.get(this.vertexShaderName),i=zi.get(this.fragmentShaderName),n=!e.equals(this._vertexShaderBody)||!i.equals(this._fragmentShaderBody);return n&&(this._vertexShaderBody=e,this._fragmentShaderBody=i),n}generateVertexShader(e=`#define DEV_DISABLE_UNIFORM_BUFFERS 
 #define NON_UNIFORM_SCALE`,i=""){return["#version 300 es","precision highp float;","precision highp int;",this._getDefinesString(),e,"#ifdef DEV_DISABLE_UNIFORM_BUFFERS","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform mat3 normalMatrix;","uniform mat4 projectionMatrix;","uniform mat4 viewMatrix;","uniform vec3 uCameraPosition;","#else",i,"#endif","in vec3 position;","in vec2 sphericalNormal;","in vec2 uv0;","in vec2 uv1;","in vec4 uv1Mod;","in vec4 t0;","in vec4 t1;","in vec4 t2;",this._vertexShaderBody.code,this._vertexShaderHooks.code].join(`
`)}generateFragmentShader(e="#define DEV_DISABLE_UNIFORM_BUFFERS",i=""){return["#version 300 es","precision "+$e.gl.fragmentPrecision+" float;","precision "+$e.gl.fragmentPrecision+" int;",e,this._getDefinesString(),"#ifdef DEV_DISABLE_UNIFORM_BUFFERS","uniform mat4 viewMatrix;","uniform vec3 uCameraPosition;","#else",i,"#endif","out vec4 fragColor;",this._fragmentShaderBody.code,this._fragmentShaderHooks.code].join(`
`)}dispose(){this.dispatchEvent({type:Lr.eventType.DISPOSED})}setUniform(e,i,n,s=oe.MATERIAL){this.uniforms[e]={type:i,value:n,uniformSourceType:s},this.uniforms[e].uniformSourceType===oe.MATERIAL&&this.uniformBufferData&&Object.prototype.hasOwnProperty.call(this.uniformBufferData,e)&&ha(this.uniformBufferData,e,n)}propertyFromUniform(e){Object.defineProperty(this,e,{get:function(){return this.uniforms[e].value},set:function(i){this.uniforms[e].value=i}})}hash(){throw"canMerge not implemented"}updateRenderStep(e){}_applySharedState(){if(this.fogSupported){const n=this.sharedMaterialState.fog;if(this.condDefine(n!==void 0&&n.enabled(),"USE_FOG")&&n&&T.DEV_DISABLE_UNIFORM_BUFFERS){const s=n.distanceEnabled?n.distanceDensity:0,a=n.heightEnabled?n.heightDensity:0;this.setUniform("fogDistStart_DistDensity_HeightStart_HeightDensity","v4",new We(n.distanceStart,s,n.heightStart,a),oe.GLOBAL),this.setUniform("fogColor","c",n.color,oe.GLOBAL)}}if(this.condDefine(!!this._sharedMaterialState.liveLightmap.texture,"LIVE_LIGHTMAP")){nt(this._sharedMaterialState);const n=this._sharedMaterialState.liveLightmap;this.setUniform("screenResolution","v4",new We(this._sharedMaterialState.physicalWidth,this._sharedMaterialState.physicalHeight,0,0),oe.GLOBAL),this.setUniform("lightmapMode","f",n.mode,oe.GLOBAL),this.setUniform("liveLightmap","t",n.texture,oe.GLOBAL)}if(this.hdrOutputSupported&&this.condDefine(this.sharedMaterialState.hdrOutput,"HDR_OUTPUT"),this.colorMapSupported){const n=this.sharedMaterialState.colorMap,s=this.sharedMaterialState.colorMapIntensity,a=n!==null&&s>0;this.condDefine(a,"USE_COLORMAP")&&T.DEV_DISABLE_UNIFORM_BUFFERS&&(this.setUniform("colorMap","t",n,oe.GLOBAL),this.setUniform("colorMapIntensity","f",s,oe.GLOBAL))}if(this.exposureAndGammaSupported&&(this.addDefine("USE_EXPOSURE_AND_GAMMA"),T.DEV_DISABLE_UNIFORM_BUFFERS)){const n=Math.pow(2,this.sharedMaterialState.cameraExposure);this.setUniform("camera_exposure_gamma","v4",new We(n,this.sharedMaterialState.cameraGamma,0,0),oe.GLOBAL)}if(this.toneMappingSupported){const n=My(this.sharedMaterialState.toneMapping);this.hasDefine(n)||(Sy.forEach(s=>{this.removeDefine(s)}),this.addDefine(n))}const e=this.sharedMaterialState.brdfLUT;this.condDefine(e!==void 0,"USE_BRDF_TEXTURE")&&this.setUniform("brdfLUT","t",e,oe.GLOBAL),this.condDefine(this.sharedMaterialState.weakReflectionShadow,"WEAK_REFLECTION_SHADOW");const i=this.sharedMaterialState.lightmapEncoding;this.condDefine(this.lightmapEnabled&&i!==void 0,"USE_LIGHTMAP")&&i&&(this.addDefine("LIGHTMAP_"+i.toUpperCase()),this.setUniform("lightmap","t",null,oe.LIGHT),T.DEV_DISABLE_UNIFORM_BUFFERS&&(this.setUniform("lightmapSize","v4",this._lightmapSize,oe.LIGHT),this.setUniform("lightmapThreshold","v2",this._lightmapThreshold,oe.LIGHT)))}refreshPerObjectUniforms(e){const i=this.uniforms;let n=e.lightmap;return this.lightmapEnabled&&i.lightmap.value!==n?((!n||!n.loaded)&&(n=this.sharedMaterialState.getDefaultLightmap(n?n.ycocgmThreshold:0)),i.lightmap.value=n,T.DEV_DISABLE_UNIFORM_BUFFERS&&(i.lightmapSize.value.x=n.width,i.lightmapSize.value.y=n.height,i.lightmapSize.value.z=1/n.width,i.lightmapSize.value.w=1/n.height,i.lightmapThreshold.value.x=n.ycocgmThreshold,i.lightmapThreshold.value.y=(1-n.ycocgmThreshold)/(16-3)),!0):!1}};o(Lr,"eventType",fm),o(Lr,"_materialRenderResourceIdCount",0);let bt=Lr;const Cy="aabb_query_vertex.glsl",Ry="aabb_query_fragment.glsl";class Iy{constructor(){o(this,"axis",new js(0))}}class Dy extends bt{constructor(){super({vsName:Cy,fsName:Ry,uniformBufferData:new Iy}),this.side=Ti.DOUBLE,this.uniforms={axis:{type:"i",value:0,uniformSourceType:oe.MATERIAL}}}get axis(){return this.uniforms.axis.value}set axis(t){console.assert(t===0||t===1||t===2),this.uniforms.axis.value=t,this.uniformBufferData.axis=new js(t)}}class ol{constructor(){o(this,"highlightMix",0)}}class je extends yt{constructor(t,e){super(),this.geometry=t,this._material=e,this.materialOverride=null,this.lightProbes=[],this.lightmap=null,this.lightmapIdx=0,this.anchor=void 0,this.visibilityId=null}get material(){return this._material}set material(t){this._material=t,T.DEV_NEW_RENDER_ARCHITECTURE&&this.entityId!==-1&&pt.get().updateMaterialForEntity(this.entityId,this._material)}clone(t,e){return t===void 0&&(t=new je(this.geometry,this.material)),yt.prototype.clone.call(this,t,e),t}}class Tn extends je{constructor(t,e,i){super(e,i),this._visible=!0,this.node=t,this.originalMaterialId=void 0,this.autoLightmapResolution=-1,this.matrixAutoUpdate=!1,this.highlightMixValue=0,this.selected=!1,this.selectedSecondary=!1,this.cameraDistance=0,this.grassScaleOverride=void 0,this.matrix=this.matrixWorld=null,this._matrixWorld=null,this._mergedMesh=null}set highlightMix(t){T.DEV_NEW_RENDER_ARCHITECTURE&&this.entityId!==-1&&(t>0?pt.get().updateEntityStateById(this.entityId,ol,{highlightMix:t}):pt.get().updateEntityStateById(this.entityId,ol,void 0)),this.highlightMixValue=t}get highlightMix(){return this.highlightMixValue}clone(){Ce(!1)}updateMatrixWorld(){}get hideInViews(){return this.node.hideInViews}set hideInViews(t){console.assert(!1)}get visible(){return this._visible}set visible(t){t!==this._visible&&(this._visible=t,T.DEV_NEW_RENDER_ARCHITECTURE&&this.entityId!==-1&&pt.get().updateEntityVisibility(this.entityId,t),this._mergedMesh&&!T.EDIT_MODE&&(this._mergedMesh.visible=t))}get matrixWorld(){var t;return this._matrixWorld||((t=this.node)==null?void 0:t.animationMatrix)}set matrixWorld(t){this._matrixWorld=t}}class Co extends je{constructor(t,e){super(t,e),this._visible=!0,this.anyLogicalMeshHasUvs=!1,this.lightmap=null,this.matrixAutoUpdate=!1,this.hideInViews=null,this.matrixAutoUpdate=!1,this.center=null,this.cameraDistance=0,this.matrix=null,this.editableRootNode=null,this.logicalMeshes=[]}clone(){Ce(!1)}updateMatrixWorld(){}addLogicalMesh(t){this.logicalMeshes.push(t),t._mergedMesh=this}get visible(){return this._visible}set visible(t){if(t!==this._visible){this._visible=t,T.DEV_NEW_RENDER_ARCHITECTURE&&this.entityId!==-1&&pt.get().updateEntityVisibility(this.entityId,t);for(let e=0;e<this.logicalMeshes.length;e+=1){const i=this.logicalMeshes[e];i._visible=t,T.DEV_NEW_RENDER_ARCHITECTURE&&i.entityId!==-1&&pt.get().updateEntityVisibility(i.entityId,t)}}}get matrixWorld(){return this.editableRootNode?this.editableRootNode.mesh?this.editableRootNode.mesh.matrixWorld:this.editableRootNode.animationMatrix:null}set matrixWorld(t){nt(!1,"Cannot set matrixWorld for a merged mesh. ")}}class Ly{constructor(){o(this,"hslContrast",new We);o(this,"inversionScaleContrast",new We)}}class ba{constructor(){o(this,"contrast",0);o(this,"hslAdjustment",{h:0,s:0,l:0});o(this,"scale",0);o(this,"inversion",!1);o(this,"correctionTurnedOn",!1);o(this,"texture");o(this,"correctionUniforms",new Ly)}getUniformVectors(){if(this.texture&&this.correctionTurnedOn){this.correctionUniforms.hslContrast.set(this.hslAdjustment.h,this.hslAdjustment.s,this.hslAdjustment.l,this.contrast);const t=(this.inversion?-1:1)*(1+this.scale),e=this.inversion?1:0;this.correctionUniforms.inversionScaleContrast.set(e,t,this.contrast,0)}else this.correctionUniforms.hslContrast.set(0,0,0,0),this.correctionUniforms.inversionScaleContrast.set(0,1,0,0);return this.correctionUniforms}loadFromJson(t,e){if(!t)return;const i=new xn(t);this.correctionTurnedOn=!0,this.contrast=i.parseNumber("contrast",0);const n=t.hslAdjustment;if(n)this.hslAdjustment.h=n[0],this.hslAdjustment.s=n[1],this.hslAdjustment.l=n[2];else{const s=e.getHSL(),a=t.hslOffset;this.hslAdjustment.h=a[0],this.hslAdjustment.s=Math.max(-1,Math.min(a[1]/(s.s==0?1:s.s),4)),this.hslAdjustment.l=Math.max(-1,Math.min(a[2]/(s.l==0?1:s.l),4))}this.inversion=i.parseBoolean("inversion",!1),this.scale=i.parseNumber("scale",0)}equals(t){return this.texture===t.texture&&this.correctionTurnedOn===t.correctionTurnedOn&&this.contrast===t.contrast&&this.hslAdjustment.h===t.hslAdjustment.h&&this.hslAdjustment.s===t.hslAdjustment.s&&this.hslAdjustment.l===t.hslAdjustment.l&&this.inversion===t.inversion&&this.scale===t.scale}serializeCorrection(){return this.correctionTurnedOn?{contrast:this.contrast,hslAdjustment:[this.hslAdjustment.h,this.hslAdjustment.s,this.hslAdjustment.l],inversion:this.inversion,scale:this.scale}:null}}const Ro=new L(0,0,0),Kc=new We(0,0,1,1);var cn=(r=>(r.BASE_COLOR="baseColorTexture",r.BUMP="bumpTexture",r.METALLIC="metallicTexture",r.ROUGHNESS="roughnessTexture",r.HEIGHT="heightTexture",r.NORMAL="normalTexture",r))(cn||{});const Oy=["baseColorTexture","bumpTexture","metallicTexture","roughnessTexture","heightTexture","normalTexture"];var pm=(r=>(r.NONE="None",r.ORGANIC="Organic",r.REGULAR="Regular",r))(pm||{}),_r=(r=>(r.WEBWALK="webwalk",r.SCENE="scene",r.EDITOR="editor",r.MATERIAL_LIBRARY="materialLibrary",r))(_r||{});class mm{constructor(){o(this,"mirrorX",!1);o(this,"mirrorY",!1);o(this,"stepX",1);o(this,"stepY",1);o(this,"maxOffsetX",1);o(this,"maxOffsetY",1)}}class ya{constructor(){o(this,"baseColor",new _e);o(this,"baseColorCorrection",new We);o(this,"baseColorAtlasUvMod",new We);o(this,"alphaDiscardThreshold",0);o(this,"envMipsCount",1);o(this,"opacity",1);o(this,"cutoutMaskThreshold",.5);o(this,"roughness",1);o(this,"roughnessCorrection",new We);o(this,"metallic",0);o(this,"metallicCorrection",new We);o(this,"emissionStrength",1);o(this,"highlight",new _e);o(this,"antiTilingRegularStepX",1);o(this,"antiTilingRegularStepY",1);o(this,"antiTilingRegularMaxOffsetX",0);o(this,"antiTilingRegularMaxOffsetY",0);o(this,"chromaKeyColor",new _e);o(this,"chromaKeyDeltaCoeff",new L);o(this,"bumpScale",1);o(this,"normalScale",1);o(this,"bumpCorrection",new We);o(this,"uvMod0",new We)}}const gn=class gn extends bt{constructor(e){var i,n,s,a,l;super({vsName:(i=e==null?void 0:e.vsName)!=null?i:gn.vertexShaderName,fsName:(n=e==null?void 0:e.fsName)!=null?n:gn.fragmentShaderName,vsHooks:(s=e==null?void 0:e.vsHooks)!=null?s:gn.vertexShaderHooks,fsHooks:(a=e==null?void 0:e.fsHooks)!=null?a:gn.fragmentShaderHooks,fsHooksCode:e==null?void 0:e.fsHooksCode,uniformBufferData:(l=e==null?void 0:e.uniformBufferData)!=null?l:new ya});o(this,"_emitLiveLightmapRequestIfWarranted",()=>{this._emissive&&this.dispatchEvent({type:gn.eventType.MAJOR_LIGHTING_PROPERTY_UPDATED})});o(this,"merged",!1);o(this,"_opacity",1);o(this,"_cutoutMaskThreshold",.5);o(this,"_cutoutMode","autodetect");o(this,"baseColor",new _e(16777215));o(this,"_correctedBaseColorTexture",new ba);o(this,"_correctedRoughnessTexture",new ba);o(this,"_correctedMetallicTexture",new ba);o(this,"_correctedBumpTexture",new ba);o(this,"_correctedNormalTexture",new ba);o(this,"_antiTilingType");o(this,"antiTilingRegularParameters",new mm);o(this,"_emissive",!1);o(this,"_emissionStrength",1);o(this,"_reflective",!0);o(this,"_roughness",1);o(this,"_metallic",0);o(this,"cubeCameraIndex",null);o(this,"_lastUsedLightProbeIds",[]);o(this,"disableLightProbe",!1);o(this,"_envMapProject",!0);o(this,"_bumpScale",.001);o(this,"_normalScale",1);o(this,"_headLight");o(this,"_uvOffsetScale");o(this,"_repeatableTexturesRequired",!1);o(this,"highlight");o(this,"_highlightMix",0);o(this,"doNotImport");o(this,"_source");o(this,"_alphaInLowerHalf",!1);o(this,"_chromaKeyEnabled");o(this,"chromaKeyColor",new _e(0,.94,0));o(this,"chromaKeyDelta",new L(.1,.1,.1));o(this,"_chromaKeyDeltaCoeff",new L);o(this,"lightmapSupported",!0);o(this,"fogSupported",!0);o(this,"hdrOutputSupported",!0);o(this,"colorMapSupported",!0);o(this,"exposureAndGammaSupported",!0);o(this,"toneMappingSupported",!0);o(this,"name","");o(this,"materialLibraryHash");o(this,"_id");this.doNotImport={baseColor:!1,opacity:!1},T.EDIT_MODE&&(this.highlight=T.EDITOR_SELECTION_COLOR)}get id(){return this._id}set id(e){this._id,this._id=e}resetIdFromSceneMaterialManager(){this._id=void 0}get source(){return this._source===void 0?"webwalk":this._source}set source(e){this._source,this._source=e}get opacity(){return this._opacity}set opacity(e){e>.99?this._opacity=1:this._opacity=e,this.configureTransparency(),this.setUniforms(),this._updated(),this.dispatchEvent({type:gn.eventType.MAJOR_LIGHTING_PROPERTY_UPDATED})}get cutoutMaskThreshold(){return this._cutoutMaskThreshold}set cutoutMaskThreshold(e){this._cutoutMaskThreshold=e,this.setUniforms(),this._updated()}_useChromaKey(){return!!(this.isAnimated&&this.chromaKeyEnabled)}_useAlphaInLowerHalf(){return!!(this.isAnimated&&this.alphaInLowerHalf)}_useBaseColorTextureAsCutout(){const e=this._correctedBaseColorTexture.texture;return this.opacity===1&&(e&&e.isCutout||this._useAlphaInLowerHalf()||this._useChromaKey())}loadCorrection(e,i){var n;(n=this._getCorrectedTexture(e))==null||n.loadFromJson(i,this.baseColor)}configureTransparency(){const e=this._getTexture("baseColorTexture"),i=!!e&&(e.hasAlpha||this._useAlphaInLowerHalf()||this._useChromaKey());this.transparent=this.opacity<1||i;const n=!!(this._useBaseColorTextureAsCutout()&&this._cutoutMode==="autodetect"||this._cutoutMode==="enabled");this.transparent?(this.blending=Yt.NORMAL,n?this.transparentRenderOrder=0:this.transparentRenderOrder=1):this.blending=Yt.DISABLED,this.depthWrite=!this.transparent||n,this.condDefine(n,"USE_CUTOUT_MASK")}getCutoutMode(){return this._cutoutMode}setCutoutMode(e){this._cutoutMode=e,this.configureTransparency(),this.setUniforms(),this._updated()}setChromaKeyColorRGB(e,i,n){this.chromaKeyColor.setRGB(e,i,n),this.setUniforms(),this._updated()}getChromaKeyDeltaComponent(e){return this.chromaKeyDelta.getComponent(e)}setChromaKeyDeltaComponent(e,i){this.chromaKeyDelta.setComponent(e,i),this.setUniforms(),this._updated()}rewind(){this.baseColorTexture instanceof st,this.baseColorTexture.rewind()}play(){console.assert(this.isAnimated),this.baseColorTexture instanceof st;const e=this.baseColorTexture.isPlaying;this.baseColorTexture.play(),this.baseColorTexture.isPlaying!==e&&this._updated()}pause(){console.assert(this.isAnimated),this.baseColorTexture instanceof st;const e=this.baseColorTexture.isPlaying;this.baseColorTexture.pause(),this.baseColorTexture.isPlaying!==e&&this._updated()}sleepAnimation(){console.assert(this.isAnimated),this.baseColorTexture instanceof st,this.baseColorTexture.sleepAnimation()}wakeAnimation(){console.assert(this.isAnimated),this.baseColorTexture instanceof st,this.baseColorTexture.wakeAnimation()}getTextures(){const e=new Map;for(const i of Oy){const n=this._getTexture(i);n!==void 0&&e.set(i,n)}return e}getTextureMapCorrectionTurnedOn(e){var i,n;return(n=(i=this._getCorrectedTexture(e))==null?void 0:i.correctionTurnedOn)!=null?n:!1}setTextureMapCorrectionTurnedOn(e,i){const n=this._getCorrectedTexture(e);n&&this._doSetProperty(n,"correctionTurnedOn",i)}getTextureMapInversion(e){var i,n;return(n=(i=this._getCorrectedTexture(e))==null?void 0:i.inversion)!=null?n:!1}setTextureMapInversion(e,i){const n=this._getCorrectedTexture(e);n&&this._doSetProperty(n,"inversion",i)}getTextureMapContrast(e){var i,n;return(n=(i=this._getCorrectedTexture(e))==null?void 0:i.contrast)!=null?n:0}setTextureMapContrast(e,i){const n=this._getCorrectedTexture(e);n&&this._doSetProperty(n,"contrast",i)}getTextureMapScale(e){var i,n;return(n=(i=this._getCorrectedTexture(e))==null?void 0:i.scale)!=null?n:0}setTextureMapScale(e,i){const n=this._getCorrectedTexture(e);n&&this._doSetProperty(n,"scale",i)}getTextureMapHslAdjustment(e,i){var n,s;return(s=(n=this._getCorrectedTexture(e))==null?void 0:n.hslAdjustment[i])!=null?s:0}setTextureMapHslAdjustment(e,i,n){const s=this._getCorrectedTexture(e);s&&this._doSetProperty(s.hslAdjustment,i,n)}setAntiTilingRegularParameters(e,i){this._doSetProperty(this.antiTilingRegularParameters,e,i)}setDoNotImport(e,i){this._doSetProperty(this.doNotImport,e,i)}isLightProbeDisabled(){return this.disableLightProbe||!this.reflective}_setLightProbeUniforms(e=null){const i=T.ENABLE_REFLECTION_PROBES_BLENDING?T.MAX_BLENDED_REFLECTION_PROBES:1;for(let s=0;s<i;s++)this.setUniform(`envMap[${s}]`,"t",e,oe.LIGHT);this.addDefine(`MAX_REFLECTION_PROBES ${i}`);const n=this.envMapMirror?1:T.LIGHT_PROBE_MIPS_COUNT;if(this.setUniform("envMipsCount","f",n,oe.MATERIAL),this.condDefine(this.envMapProject,"USE_ENVMAP_PROJECT")&&(this.condDefine(T.ENABLE_REFLECTION_PROBES_BLENDING,"USE_REFLECTION_PROBE_BLENDING")&&this.setUniform("reflectionProbesCount","i",0,oe.LIGHT),T.DEV_DISABLE_UNIFORM_BUFFERS))for(let s=0;s<T.MAX_BLENDED_REFLECTION_PROBES;s++)this.setUniform(`reflectionProbes[${s}].boxMin`,"v3",Ro,oe.LIGHT),this.setUniform(`reflectionProbes[${s}].boxMax`,"v3",Ro,oe.LIGHT),this.setUniform(`reflectionProbes[${s}].posW`,"v3",Ro,oe.LIGHT);this._lastUsedLightProbeIds=[]}getUvOffsetAndScale(e){return e.copyFrom(this._uvOffsetScale||Kc)}_uvOffsetAndScaleModified(){this.ensureTexturesRepeatable(),this._updated()}setUvOffsetAndScale(e,i,n,s){this._uvOffsetScale||(this._uvOffsetScale=new We,this.setUniforms()),e instanceof We?this._uvOffsetScale.copyFrom(e):this._uvOffsetScale.set(e,i,n,s),this._uvOffsetAndScaleModified()}getUvOffsetAndScaleByProperty(e){return this._uvOffsetScale[e]}setUvOffsetAndScaleByProperty(e,i){this._uvOffsetScale[e]=i,this._uvOffsetAndScaleModified()}ensureTexturesRepeatable(){this._repeatableTexturesRequired=!0,this.baseColorTexture instanceof Xc&&this.baseColorTexture.loaded&&(this.addDefine("USE_BASE_COLOR_TEXTURE_ATLAS_REPEAT"),this.setUniforms())}forceEnableUv0(){return!1}_applySharedState(){super._applySharedState();const e=this.emissiveEnabled?this.emissionStrength:0;this.setUniform("emissionStrength","f",e,oe.MATERIAL)}setUniforms(){var b;this.setUniform("opacity","f",this.opacity,oe.MATERIAL),this.setUniform("cutoutMaskThreshold","f",this.cutoutMaskThreshold,oe.MATERIAL);const e=!this.isLightProbeDisabled();let i=this.forceEnableUv0();const n=this.roughnessTexture,s=!!n&&n.loaded&&e;this.condDefine(s,"USE_ROUGHNESS_TEXTURE")?(this.setUniform("roughnessTexture","t",n,oe.MATERIAL),i=!0):this.setUniform("roughness","f",this.roughness,oe.MATERIAL);const a=this.metallicTexture,l=!!a&&a.loaded&&e;this.condDefine(l,"USE_METALLIC_TEXTURE")?(this.setUniform("metallicTexture","t",a,oe.MATERIAL),i=!0):this.setUniform("metallic","f",this.metallic,oe.MATERIAL);const c=this.emissiveEnabled?this.emissionStrength:0;this.setUniform("emissionStrength","f",c,oe.MATERIAL),this.condDefine(this.antiTilingType==="Organic","ANTI_TILING_ORGANIC"),this.condDefine(this.antiTilingType==="Regular","ANTI_TILING_REGULAR")&&(this.condDefine(this.antiTilingRegularParameters.mirrorX,"ANTI_TILING_REGULAR_MIRROR_X"),this.condDefine(this.antiTilingRegularParameters.mirrorY,"ANTI_TILING_REGULAR_MIRROR_Y"),this.setUniform("antiTilingRegularStepX","f",this.antiTilingRegularParameters.stepX,oe.MATERIAL),this.setUniform("antiTilingRegularStepY","f",this.antiTilingRegularParameters.stepY,oe.MATERIAL),this.setUniform("antiTilingRegularMaxOffsetX","f",this.antiTilingRegularParameters.maxOffsetX,oe.MATERIAL),this.setUniform("antiTilingRegularMaxOffsetY","f",this.antiTilingRegularParameters.maxOffsetY,oe.MATERIAL));const h=this._correctedBaseColorTexture.getUniformVectors();this.setUniform("baseColorCorrection","v4",h.hslContrast,oe.MATERIAL);const d=this._correctedBumpTexture.getUniformVectors().inversionScaleContrast;if(this.setUniform("bumpCorrection","v4",d,oe.MATERIAL),s){const g=this._correctedRoughnessTexture.getUniformVectors().inversionScaleContrast;this.setUniform("roughnessCorrection","v4",g,oe.MATERIAL)}if(l){const g=this._correctedMetallicTexture.getUniformVectors().inversionScaleContrast;this.setUniform("metallicCorrection","v4",g,oe.MATERIAL)}let u=this._correctedBaseColorTexture.texture,f=Kc;if(u&&u instanceof Xc&&u.parentTexture&&(f=u.uvOffsetScale,u=u.parentTexture),this.condDefine(!!u&&u.loaded,"USE_BASE_COLOR_TEXTURE")?(this.setUniform("baseColorTexture","t",u,oe.MATERIAL),i=!0,this.setUniform("baseColorAtlasUvMod","v4",f,oe.MATERIAL),this._useBaseColorTextureAsCutout()?this.setUniform("alphaDiscardThreshold","f",.25,oe.MATERIAL):this.setUniform("alphaDiscardThreshold","f",0,oe.MATERIAL)):this.setUniform("baseColor","c",this.baseColor,oe.MATERIAL),this.condDefine(this._useAlphaInLowerHalf(),"USE_ALPHA_IN_LOWER_HALF"),this.condDefine(this._useChromaKey(),"USE_CHROMA_KEY")){this.setUniform("chromaKeyColor","c",this.chromaKeyColor,oe.MATERIAL);const g=1.22,x=this.chromaKeyDelta;this._chromaKeyDeltaCoeff.x=1/(g*x.x),this._chromaKeyDeltaCoeff.y=1/(g*x.y),this._chromaKeyDeltaCoeff.z=1/(g*x.z),this.setUniform("chromaKeyDeltaCoeff","v3",this._chromaKeyDeltaCoeff,oe.MATERIAL)}const p=this.bumpTexture,m=this.normalTexture;this.condDefine(!!m&&m.loaded&&e,"USE_NORMAL_TEXTURE")?(this.setUniform("normalTexture","t",m,oe.MATERIAL),this.setUniform("normalScale","f",this.normalScale,oe.MATERIAL),i=!0):this.condDefine(!!p&&p.loaded&&e,"USE_BUMP_TEXTURE")&&(this.setUniform("bumpTexture","t",p,oe.MATERIAL),this.setUniform("bumpScale","f",this.bumpScale,oe.MATERIAL),i=!0),i&&this.setUniform("uvMod0","v4",this._uvOffsetScale||Kc,oe.MATERIAL),this.condDefine(e,"USE_ENVMAP")&&this._setLightProbeUniforms(),this.condDefine(this.highlight!==void 0,"USE_HIGHLIGHT")&&(this.setUniform("highlight","c",this.highlight,oe.MATERIAL),this.setUniform("highlightMix","f",this.highlightMix,oe.OBJECT)),this.condDefine((b=this.headLight)!=null?b:!this.lightmapEnabled,"USE_HEADLIGHT"),this.fillMaterialUniformDataFromUniforms()}forceObjectUniformsRefresh(){this._lastUsedLightProbeIds=[]}textureNeedsUv0(e){return!0}get type(){return hs.STANDARD}hash(){return this.baseColorTexture?this.type+this.baseColorTexture.name:`${this.type}#${this.baseColor.r}:${this.baseColor.g}:${this.baseColor.b}`}_getCorrectedTexture(e){switch(e){case"baseColorTexture":return this._correctedBaseColorTexture;case"bumpTexture":return this._correctedBumpTexture;case"normalTexture":return this._correctedNormalTexture;case"metallicTexture":return this._correctedMetallicTexture;case"roughnessTexture":return this._correctedRoughnessTexture;case"heightTexture":return}zs(e,`Unknown type ${e}.`)}_getTexture(e){const i=this._getCorrectedTexture(e);return i?i.texture:this[e]}_setTexture(e,i){const n=this._getCorrectedTexture(e);n&&(n.texture=i,i&&!i.loaded?i.addLoadedListener(()=>{e=="baseColorTexture"&&this.configureTransparency(),this._repeatableTexturesRequired&&this.ensureTexturesRepeatable(),this.setUniforms(),this._updated()}):(this.setUniforms(),this._updated()))}canMerge(e){if(this.type!==e.type||this.opacity!==e.opacity)return!1;if(this._correctedBaseColorTexture.texture||e._correctedBaseColorTexture.texture){if(!gn.baseColorTexturesEqual(this,e)||!gn.antiTilingEqual(this,e))return!1}else if(!this.baseColor.equals(e.baseColor))return!1;if((this.emissive||e.emissive)&&(this.emissive!==e.emissive||this.emissionStrength!==e.emissionStrength))return!1;if(this.roughnessTexture||e.roughnessTexture){if(this.roughnessTexture!==e.roughnessTexture)return!1}else if(this.roughness!==e.roughness)return!1;if(this.metallicTexture||e.metallicTexture){if(this.metallicTexture!==e.metallicTexture)return!1}else if(this.metallic!==e.metallic)return!1;return!((this.bumpTexture||e.bumpTexture)&&(this.bumpTexture!==e.bumpTexture||this.bumpScale!==e.bumpScale)||(this.normalTexture||e.normalTexture)&&(this.normalTexture!==e.normalTexture||this.normalScale!==e.normalScale)||this.envMapProject!==e.envMapProject||this.doubleSided!==e.doubleSided||!gn.uvOffsetScaleEqual(this,e))}assignLightProbe(e,i){const n=this.uniforms,s=this.envMapMirror?e.getMirrorTexture():e.getFilteredTexture();n[`envMap[${i}]`].value=s,T.DEV_DISABLE_UNIFORM_BUFFERS&&this.envMapProject&&(e.isBoundingBoxEnabled()?(n[`reflectionProbes[${i}].posW`].value=e.position,n[`reflectionProbes[${i}].boxMin`].value=e.boxMin,n[`reflectionProbes[${i}].boxMax`].value=e.boxMax):(n[`reflectionProbes[${i}].boxMin`].value=Ro,n[`reflectionProbes[${i}].boxMax`].value=Ro))}refreshPerObjectUniforms(e){const i=this.uniforms;let n=super.refreshPerObjectUniforms(e);const s=e instanceof Tn&&e.selected?e.highlightMix:0;if(i.highlightMix!==void 0&&s!==i.highlightMix.value&&(i.highlightMix.value=s,n=!0),this.isLightProbeDisabled())return n;const a=[];if(e.lightProbes.forEach(c=>a.push(c.id)),Nc(this._lastUsedLightProbeIds,a))return n;n=!0,this._lastUsedLightProbeIds=[...a];const l=this.envMapMirror?1:T.LIGHT_PROBE_MIPS_COUNT;if(i.envMipsCount.value=l,T.ENABLE_REFLECTION_PROBES_BLENDING){const c=this.envMapMirror?1:e.lightProbes.length;for(let d=0;d<c;d++)this.assignLightProbe(e.lightProbes[d],d);i.reflectionProbesCount.value=c;const h=e.lightProbes[0].getFilteredTexture();for(let d=c;d<T.MAX_BLENDED_REFLECTION_PROBES;d+=1)i[`envMap[${d}]`].value=h,T.DEV_DISABLE_UNIFORM_BUFFERS&&(i[`reflectionProbes[${d}].boxMin`].value=Ro,i[`reflectionProbes[${d}].boxMax`].value=Ro)}else this.assignLightProbe(e.lightProbes[0],0);return n}setBaseColorRGB(e,i,n){this.baseColor.setRGB(e,i,n),this.setUniforms(),this._updated(),this._emitLiveLightmapRequestIfWarranted()}getTextureAndSettings(e){var n;const i=this._getTexture(e);return e==="bumpTexture"?[i,{bumpScale:this._bumpScale}]:e=="normalTexture"?[i,{normalScale:this._normalScale}]:e==="baseColorTexture"?[i,{correctionTurnedOn:this._correctedBaseColorTexture.correctionTurnedOn,correction:(n=this._correctedBaseColorTexture.serializeCorrection())!=null?n:void 0,antiTilingType:this.antiTilingType,antiTilingRegularParameters:si({},this.antiTilingRegularParameters),baseColor:this.baseColor.roundChannels().toArray()}]:[i,{}]}setTexture(e,i,n={}){var s,a,l,c,h,d,u,f,p,m,b,g;if(i===null&&(i=void 0),i){const x=this.baseColorTexture;x instanceof st&&(i.wrapS=x.wrapS,i.wrapT=x.wrapT,i.anisotropy=x.anisotropy)}this._getCorrectedTexture(e)!==void 0&&(this._setTexture(e,i),this._getCorrectedTexture(e).correctionTurnedOn=n.correctionTurnedOn||!1,this._getCorrectedTexture(e).contrast=((s=n.correction)==null?void 0:s.contrast)||0,this._getCorrectedTexture(e).hslAdjustment.h=((a=n.correction)==null?void 0:a.hslAdjustment[0])||0,this._getCorrectedTexture(e).hslAdjustment.s=((l=n.correction)==null?void 0:l.hslAdjustment[1])||0,this._getCorrectedTexture(e).hslAdjustment.l=((c=n.correction)==null?void 0:c.hslAdjustment[2])||0,e==="baseColorTexture"?(this.antiTilingType=n.antiTilingType||this.antiTilingType||"None",this.antiTilingRegularParameters.mirrorX=((h=n.antiTilingRegularParameters)==null?void 0:h.mirrorX)||!1,this.antiTilingRegularParameters.mirrorY=((d=n.antiTilingRegularParameters)==null?void 0:d.mirrorY)||!1,this.antiTilingRegularParameters.stepX=((u=n.antiTilingRegularParameters)==null?void 0:u.stepX)||1,this.antiTilingRegularParameters.stepY=((f=n.antiTilingRegularParameters)==null?void 0:f.stepY)||1,this.antiTilingRegularParameters.maxOffsetX=((p=n.antiTilingRegularParameters)==null?void 0:p.maxOffsetX)||1,this.antiTilingRegularParameters.maxOffsetY=((m=n.antiTilingRegularParameters)==null?void 0:m.maxOffsetY)||1,n.baseColor&&this.baseColor.fromArray(n.baseColor)):e==="bumpTexture"?this._bumpScale=(b=n.bumpScale)!=null?b:.001:e==="normalTexture"&&(this._normalScale=(g=n.normalScale)!=null?g:1))}serializeTextureProperties(e){const i=this._getCorrectedTexture(e);if(i!==void 0)return{correction:i.serializeCorrection(),texture:i.texture?i.texture.serialize():null}}serializeAntiTilingProperties(){if(!this.antiTiling)return;const e=this.antiTilingType;Ce(e);let i;return e==="Regular"&&(i=this.antiTilingRegularParameters),{antiTilingType:e,antiTilingRegularParameters:i}}serializeUvOffsetScale(){return this.uvOffsetAndScaleEnabled?this._uvOffsetScale.toArray():null}serialize(){var d;this.id,this.merged,this.source;const e=this.baseColor.roundChannels().toArray(),i=this.serializeTextureProperties("baseColorTexture"),n=this.serializeTextureProperties("roughnessTexture"),s=this.serializeTextureProperties("metallicTexture"),a=this.serializeTextureProperties("bumpTexture"),l=this.serializeTextureProperties("normalTexture"),c=this._chromaKeyEnabled!==void 0;return{name:this.name,id:this.id,materialLibraryHash:(d=this.materialLibraryHash)!=null?d:null,type:this.type,source:this.source!=="scene"?this.source:null,baseColor:e,baseColorTexture:i.texture,baseColorTextureCorrection:i.correction,alphaInLowerHalf:this.alphaInLowerHalf,chromaKeyEnabled:c?this.chromaKeyEnabled:null,chromaKeyColor:c?this.chromaKeyColor.roundChannels().toArray():null,chromaKeyDelta:c?this.chromaKeyDelta.toArray():null,opacity:this.opacity,cutoutMode:this._cutoutMode,cutoutMaskThreshold:this.cutoutMaskThreshold,emissive:this.emissive,emissionStrength:this.emissionStrength,reflective:this.reflective,roughness:this.roughness,metallic:this.metallic,envMapProject:this.envMapProject,bumpScale:a.texture?this.bumpScale:null,normalScale:l.texture?this.normalScale:null,doubleSided:this.doubleSided,doNotImport:this.doNotImport,roughnessTexture:n.texture,roughnessTextureCorrection:n.correction,metallicTexture:s.texture,metallicTextureCorrection:s.correction,bumpTexture:a.texture,bumpTextureCorrection:a.correction,normalTexture:l.texture,uvOffsetScale:this.serializeUvOffsetScale(),antiTiling:this.serializeAntiTilingProperties(),wavesSpeed:null,wavesScale:null}}_onTextureSet(e){e?e.addLoadedListener(()=>{this.setUniforms(),this._updated()}):(this.setUniforms(),this._updated())}get roughnessTexture(){return this._correctedRoughnessTexture.texture}set roughnessTexture(e){this._correctedRoughnessTexture.texture=e,this._onTextureSet(e)}get metallicTexture(){return this._correctedMetallicTexture.texture}set metallicTexture(e){this._correctedMetallicTexture.texture=e,this._onTextureSet(e)}get bumpTexture(){return this._correctedBumpTexture.texture}set bumpTexture(e){this._correctedBumpTexture.texture=e,this._onTextureSet(e)}get normalTexture(){return this._correctedNormalTexture.texture}set normalTexture(e){this._correctedNormalTexture.texture=e,this._onTextureSet(e)}get alphaInLowerHalf(){return this._alphaInLowerHalf}set alphaInLowerHalf(e){this._alphaInLowerHalf=e,this.configureTransparency(),this.setUniforms(),this._updated()}get chromaKeyEnabled(){return!!this._chromaKeyEnabled}set chromaKeyEnabled(e){this._chromaKeyEnabled=!!e,this.configureTransparency(),this.setUniforms(),this._updated()}get isAnimated(){const e=this.baseColorTexture;return e instanceof st&&e.isAnimated}get isPlaying(){const e=this.baseColorTexture;return e instanceof st&&e.isAnimated&&e.isPlaying}get doubleSided(){return this.side===Ti.DOUBLE}set doubleSided(e){this.side=e?Ti.DOUBLE:Ti.FRONT,this.setUniforms(),this._updated()}get antiTiling(){return this._antiTilingType!==void 0}get antiTilingType(){return this._antiTilingType}set antiTilingType(e){this._antiTilingType=e,this.setUniforms(),this._updated()}get envMapMirror(){return this.roughness===0&&!this.roughnessTexture}get highlightMix(){return this._highlightMix}set highlightMix(e){e!==this._highlightMix&&(this._highlightMix=e,this.uniforms.highlightMix.value=e)}get baseColorTexture(){return this._correctedBaseColorTexture.texture}set baseColorTexture(e){this._setTexture("baseColorTexture",e)}_doSetProperty(e,i,n){this.source,n!==e[i]&&(ha(e,i,n),this.setUniforms(),this._updated(),this._emitLiveLightmapRequestIfWarranted())}get emissive(){return this._emissive}get emissiveEnabled(){return this._emissive&&(!this.sharedMaterialState||this.sharedMaterialState.emissiveMaterialsLightEnabled)}set emissive(e){this._doSetProperty(this,"_emissive",e),this.dispatchEvent({type:gn.eventType.MAJOR_LIGHTING_PROPERTY_UPDATED})}get emissionStrength(){return this._emissionStrength}set emissionStrength(e){this._doSetProperty(this,"_emissionStrength",e)}get reflective(){return this._reflective}set reflective(e){this._doSetProperty(this,"_reflective",e)}get headLight(){return this._headLight}set headLight(e){this._doSetProperty(this,"_headLight",e)}get roughness(){return this._roughness}set roughness(e){this._doSetProperty(this,"_roughness",e)}get metallic(){return this._metallic}set metallic(e){this._doSetProperty(this,"_metallic",e)}get envMapProject(){return this._envMapProject}set envMapProject(e){this._doSetProperty(this,"_envMapProject",e)}get bumpScale(){return this._bumpScale}set bumpScale(e){this._doSetProperty(this,"_bumpScale",e)}get normalScale(){return this._normalScale}set normalScale(e){this._doSetProperty(this,"_normalScale",e)}get uvOffsetAndScaleEnabled(){return this._uvOffsetScale!==void 0}set uvOffsetAndScaleEnabled(e){e?this.setUvOffsetAndScale(Kc):(this._uvOffsetScale=void 0,this.setUniforms(),this._updated())}static baseColorTexturesEqual(e,i){return e._correctedBaseColorTexture.equals(i._correctedBaseColorTexture)&&e._useAlphaInLowerHalf()===i._useAlphaInLowerHalf()&&(e._useChromaKey()?i._useChromaKey()&&e.chromaKeyColor.equals(i.chromaKeyColor)&&e.chromaKeyDelta.equals(i.chromaKeyDelta):!i._useChromaKey())}static antiTilingEqual(e,i){return e.antiTilingType===i.antiTilingType&&e.antiTilingRegularParameters.mirrorX===i.antiTilingRegularParameters.mirrorX&&e.antiTilingRegularParameters.mirrorY===i.antiTilingRegularParameters.mirrorY&&e.antiTilingRegularParameters.stepX===i.antiTilingRegularParameters.stepX&&e.antiTilingRegularParameters.stepY===i.antiTilingRegularParameters.stepY&&e.antiTilingRegularParameters.maxOffsetX===i.antiTilingRegularParameters.maxOffsetX&&e.antiTilingRegularParameters.maxOffsetY===i.antiTilingRegularParameters.maxOffsetY}static uvOffsetScaleEqual(e,i){return e._uvOffsetScale&&i._uvOffsetScale?e._uvOffsetScale.equals(i._uvOffsetScale):!1}};o(gn,"vertexShaderName","standard_material_vertex.glsl"),o(gn,"fragmentShaderName","standard_material_fragment.glsl"),o(gn,"vertexShaderHooks","standard_material_vertex_hooks.glsl"),o(gn,"fragmentShaderHooks","standard_material_fragment_hooks.glsl");let Qt=gn;const Fy="anchor_vertex.glsl";class By extends Qt{constructor(){super({vsName:Fy,uniformBufferData:new ya}),this._metallic=.1,this._roughness=.5,this._bumpScale=.01,this.hideFromLightProbes=!0,this.lightmapSupported=!1}}const Ny="wireframe_vertex.glsl",Uy="wireframe_fragment.glsl",_m=100;class ky{constructor(){o(this,"maxDistance",_m)}}class Es extends bt{constructor(e,i=_m,n,s=!0){super({vsName:Ny,fsName:Uy,uniformBufferData:new ky});o(this,"lineColor");o(this,"lineThickness");o(this,"_customizationFunc");const a=Fd();this.lineColor=e||a.lineColor,this.lineThickness=0,this.setUniform("lineColor","c",this.lineColor,oe.OBJECT),this.setUniform("lineThickness","f",0,oe.OBJECT),this.setUniform("backsideLineThickness","f",0,oe.OBJECT),this.setUniform("maxDistance","f",i,oe.MATERIAL),this.condDefine(s,"USE_TRANSPARENT_WIREFRAME"),this.blending=Yt.NORMAL,this.depthTest=!0,this.depthWrite=!0,this.side=Ti.DOUBLE,this.transparent=s,this._customizationFunc=n,this.fillMaterialUniformDataFromUniforms()}get customizationFunc(){return this._customizationFunc}uniformsNeedUpdate(e,i,n){return this.uniforms.lineThickness.value!==e||this.uniforms.lineColor.value!==i||this.uniforms.backsideLineThickness.value!==n}refreshPerObjectUniforms(e){let i=this.lineColor,n=this.lineThickness,s=this.lineThickness;if(this._customizationFunc){const l=this._customizationFunc(e);i=l.lineColor||i,n=l.lineThickness||n,s=l.backsideLineThickness||s}const a=this.uniformsNeedUpdate(n,i,s);return this.uniforms.lineThickness.value=n,this.uniforms.lineColor.value=i,this.uniforms.backsideLineThickness.value=s,a}}function Qd(r=T.EDITOR_SELECTION_COLOR){const t=()=>({lineThickness:2,backsideLineThickness:2}),e=new Es(r,100,t);return e.depthTest=!0,e.depthWrite=!1,e.side=Ti.DOUBLE,e.hideFromLightProbes=!0,e.lineThickness=1.5,e}function Kd(r=T.EDITOR_SELECTION_COLOR){const t=new Qt;return t.hideFromLightProbes=!0,t.disableLightProbe=!0,t.lightmapSupported=!1,t.headLight=!1,t.reflective=!1,t.opacity=.2,t.transparent=!0,t.doubleSided=!1,t.baseColor=r,t.setUniforms(),t}class Vy extends Qt{constructor(){super({}),this.lightmapSupported=!1,this.headLight=!0,this.reflective=!1,this.setUniforms()}refreshPerObjectUniforms(t){const e=this.uniforms;return e.baseColor.value=_e.WHITE,!0}}const zy="equirect_sky_vertex.glsl",Gy="equirect_sky_fragment.glsl";class gm extends bt{constructor(){super({vsName:zy,fsName:Gy}),this.depthWrite=!1,this.side=Ti.FRONT,this.uniforms={map:{type:"t",value:null,uniformSourceType:oe.MATERIAL}},this.fogSupported=!0,this.hdrOutputSupported=!0,this.colorMapSupported=!0,this.exposureAndGammaSupported=!0,this.toneMappingSupported=!0}get map(){return this.uniforms.map.value}set map(t){this.uniforms.map.value=t,this.condDefine(this.map.encoding=="rgbm","USE_RGBM_MAP")}}class Hy{constructor(){o(this,"circleSpan",0)}}class Wy extends bt{constructor(){super({vsName:"gaze_pointer_vertex.glsl",fsName:"gaze_pointer_fragment.glsl",uniformBufferData:new Hy}),this.blending=Yt.NORMAL,this.transparent=!0,this.transparentRenderOrder=2,this.setUniform("circleSpan","f",0,oe.MATERIAL)}set circleSpan(t){console.assert(t<=1);const e=2*Math.PI*t-Math.PI;this.uniforms.circleSpan.value=e,this.uniformBufferData.circleSpan=e}}const $c={BY_NORMALS:"By normals",UP:"Up"},jy=new We(0,0,1,1);class Xy extends ya{constructor(){super(...arguments);o(this,"grassDirectionality",1);o(this,"renderSteps",0)}}class al extends Qt{constructor(){super({vsHooks:"grass_vertex.glsl",fsHooks:"grass_fragment.glsl",uniformBufferData:new Xy});o(this,"_grassHeight",.05);o(this,"_correctedHeightTexture",new ba);o(this,"_direction",$c.BY_NORMALS);o(this,"grassScale",1);o(this,"doNotImport",{baseColor:!0,baseColorTexture:!0});this._repeatableTexturesRequired=!0,this.renderSteps=8,this.doNotImport={baseColor:!0,baseColorTexture:!0},this.antiTilingType=pm.ORGANIC,this.setUniform("currentStep","f",0,oe.OBJECT),this.setUniform("grassOffsetScaled","f",0,oe.OBJECT),this.setUniform("grassDirectionality","f",1,oe.MATERIAL),this.setUniform("renderSteps","f",this.renderSteps,oe.MATERIAL)}_getCorrectedTexture(e){return e===cn.HEIGHT?this._correctedHeightTexture:super._getCorrectedTexture(e)}set grassHeight(e){this._grassHeight=e,this._updated()}get grassHeight(){return this._grassHeight}set grassLayers(e){this.renderSteps=e,this.uniforms.renderSteps.value=this.renderSteps,this._updated()}get grassLayers(){return this.renderSteps}get grassDirectionMode(){return $c}get grassDirection(){return this._direction}set grassDirection(e){this._direction=e,this.uniforms.grassDirectionality.value=this._direction===$c.UP?0:1,this._updated()}set heightTexture(e){this._correctedHeightTexture.texture=e,e.addLoadedListener(()=>{this.setUniform("heightTexture","t",this.heightTexture,oe.MATERIAL),this.condDefine(this.heightTexture!==void 0,"USE_HEIGHT_TEXTURE"),this.setUniform("uvMod0","v4",this._uvOffsetScale||jy,oe.MATERIAL),this._updated()})}get heightTexture(){return this._correctedHeightTexture.texture}_setTexture(e,i){if(e===cn.HEIGHT)this.heightTexture=i;else return super._setTexture(e,i)}get type(){return hs.GRASS}canMerge(e){return!1}configureTransparency(){this.blending=Yt.NORMAL}updateRenderStep(e){const i=this.grassHeight/this.renderSteps*e;this.uniforms.grassOffsetScaled.value=i*this.grassScale,this.uniforms.currentStep.value=e}refreshPerObjectUniforms(e){const i=this.uniforms;let n=bt.prototype.refreshPerObjectUniforms.call(this,e),s;if(e instanceof Tn){const a=e.selected?e.highlightMix:0;i.highlightMix!==void 0&&a!==i.highlightMix.value&&(i.highlightMix.value=a,n=!0),s=e.grassScaleOverride}return this.grassScale=s!=null?s:1,this._direction===$c.UP&&(i.grassDirectionality.value=s?1:0),n}serialize(){var n,s;this.id;const e=this.baseColor.roundChannels().toArray(),i=this.serializeTextureProperties(cn.BASE_COLOR);return{name:this.name,id:this.id,type:this.type,baseColor:e,baseColorTexture:i.texture,baseColorTextureCorrection:i.correction,heightTexture:(s=(n=this.heightTexture)==null?void 0:n.serialize())!=null?s:null,grassHeight:this.grassHeight,grassLayers:this.grassLayers,grassDirection:this.grassDirection,doNotImport:this.doNotImport,uvOffsetScale:this.serializeUvOffsetScale(),antiTiling:this.serializeAntiTilingProperties()}}}class qy{constructor(){o(this,"color",new _e);o(this,"highlight",new _e);o(this,"highlightMix",0)}}class $d extends bt{constructor(t){super({vsName:"editor_light_vertex.glsl",fsName:"editor_light_fragment.glsl",uniformBufferData:new qy}),this.setUniform("color","c",t.color,oe.MATERIAL),this.setUniform("highlight","c",T.EDITOR_SELECTION_COLOR,oe.MATERIAL),this.setUniform("highlightMix","f",0,oe.MATERIAL),this.propertyFromUniform("highlightMix")}}class Zd extends bt{constructor(e,i){super({vsName:Qt.vertexShaderName,vsHooks:Qt.vertexShaderHooks,fsName:"luma_fragment.glsl"});o(this,"_computeIncidentLuma");o(this,"_color");this.lightmapSupported=!0,this.sharedMaterialState=i,this._computeIncidentLuma=e,this._color=new _e(_e.WHITE),this.setUniform("color","c",this._color,oe.OBJECT)}get computeIncidentLuma(){return this._computeIncidentLuma}refreshPerObjectUniforms(e){let i=bt.prototype.refreshPerObjectUniforms.call(this,e);const n=this._computeIncidentLuma?_e.WHITE:e.material.baseColor;return n.equals(this._color)||(this._color.copyFrom(n),i=!0),i}}const Yy="object_distance_vertex.glsl",Qy="object_id_fragment.glsl",Ky="object_id_distance_fragment.glsl";class vm extends bt{constructor(t){super({vsName:Yy,fsName:t?Qy:Ky}),this.doNotOverrideSide=!0,this.uniforms={objectId:{type:"i",value:null,uniformSourceType:oe.OBJECT}}}refreshPerObjectUniforms(t){return this.uniforms.objectId.value=t.visibilityId,!0}}const $y="outline_vertex.glsl",Zy="outline_fragment.glsl";class Jy{constructor(){o(this,"color",new _e);o(this,"thickness",0)}}class ex extends bt{constructor(t,e){super({vsName:$y,fsName:Zy,uniformBufferData:new Jy}),this.side=Ti.DOUBLE,this.uniforms={color:{type:"c",value:t,uniformSourceType:oe.MATERIAL},thickness:{type:"f",value:e,uniformSourceType:oe.MATERIAL}},this.fillMaterialUniformDataFromUniforms()}}class tx{constructor(){o(this,"topColor",new _e);o(this,"bottomColor",new _e);o(this,"sinBottomAngle",0);o(this,"exponent",0)}}class ix extends bt{constructor(){super({vsName:"procedural_sky_vertex.glsl",fsName:"procedural_sky_fragment.glsl",uniformBufferData:new tx}),this.depthWrite=!1,this.side=Ti.BACK,this.uniforms={topColor:{type:"c",value:new _e(15135487),uniformSourceType:oe.MATERIAL},bottomColor:{type:"c",value:new _e(16777215),uniformSourceType:oe.MATERIAL},sinBottomAngle:{type:"f",value:Math.sin(Ai(-30)),uniformSourceType:oe.MATERIAL},exponent:{type:"f",value:.9,uniformSourceType:oe.MATERIAL}},this.fogSupported=!0,this.hdrOutputSupported=!0,this.colorMapSupported=!0,this.exposureAndGammaSupported=!0,this.toneMappingSupported=!0,this.fillMaterialUniformDataFromUniforms()}}const nx="rotate_gizmo_material_vertex.glsl",sx="rotate_gizmo_material_fragment.glsl";class rx{constructor(){o(this,"opacity",1);o(this,"color",new _e);o(this,"gizmoPosition",new L);o(this,"sphereRadius",0)}}class ox extends bt{constructor(e,i){super({vsName:nx,fsName:sx,uniformBufferData:new rx});o(this,"setUniforms",()=>{});this.blending=Yt.NORMAL,this.depthTest=!1,this.depthWrite=!1,this.transparent=!0,this.transparentRenderOrder=1e3,this.hideFromLightProbes=!0,this.uniforms={opacity:{type:"f",value:1,uniformSourceType:oe.MATERIAL},color:{type:"c",value:e,uniformSourceType:oe.MATERIAL},gizmoPosition:{type:"v3",value:new L(0,0,0),uniformSourceType:oe.MATERIAL},sphereRadius:{type:"f",value:1,uniformSourceType:oe.MATERIAL}},this.opacity=i,this.fillMaterialUniformDataFromUniforms()}get color(){return this.uniforms.color.value}get opacity(){return this.uniforms.opacity.value}set opacity(e){this.uniforms.opacity.value=e}get gizmoPosition(){return this.uniforms.gizmoPosition.value}get sphereRadius(){return this.uniforms.sphereRadius.value}set sphereRadius(e){this.uniforms.sphereRadius.value=e}}const Jd="sprite_vertex.glsl";class ax extends ya{constructor(){super(...arguments);o(this,"offset",new L)}}class bm extends Qt{constructor(){super({vsName:Jd,uniformBufferData:new ax}),this.vertexShaderName=Jd,this._vertexShaderBody=zi.get(Jd),this.hideFromLightProbes=!0,this.lightmapSupported=!1,this.setUniform("offset","v3",new L(0,0,0),oe.MATERIAL)}set offset(t){this.uniforms.offset.value=t,this.uniformBufferData.offset.copyFrom(t)}}const lx="universal_material_vertex.glsl",cx="universal_material_fragment.glsl";class hx extends ya{constructor(){super(...arguments);o(this,"clearcoat",new ye(0,0));o(this,"sheen",new We(0,0,0,0));o(this,"specular",new We(1,1,1,1));o(this,"highlightMix",0);o(this,"u_hdrOutput",new js(0));o(this,"u_useEnvMap",new js(0));o(this,"shpk_uniform0",new We(0,0,0,0));o(this,"shpk_uniform1",new We(0,0,0,0));o(this,"shpk_uniform2",new We(0,0,0,0));o(this,"shpk_uniform3",new We(0,0,0,0));o(this,"shpk_uniform4",new We(0,0,0,0));o(this,"shpk_uniform5",new We(0,0,0,0));o(this,"shpk_uniform6",new We(0,0,0,0));o(this,"shpk_uniform7",new We(0,0,0,0));o(this,"shpk_uniform8",new We(0,0,0,0));o(this,"shpk_uniform9",new We(0,0,0,0));o(this,"shpk_uniform10",new We(0,0,0,0));o(this,"shpk_uniform11",new We(0,0,0,0));o(this,"shpk_uniform12",new We(0,0,0,0));o(this,"shpk_uniform13",new We(0,0,0,0));o(this,"shpk_uniform14",new We(0,0,0,0));o(this,"shpk_uniform15",new We(0,0,0,0));o(this,"shpk_uniform16",new We(0,0,0,0));o(this,"shpk_uniform17",new We(0,0,0,0));o(this,"shpk_uniform18",new We(0,0,0,0));o(this,"shpk_uniform19",new We(0,0,0,0))}}class ym extends Qt{constructor(){super({vsName:lx,fsName:cx,uniformBufferData:new hx});o(this,"textures",new Array);o(this,"uniformVectors",new Array);o(this,"alphaMode",rl.OPAQUE);o(this,"usesTexCoords",!1);o(this,"clearcoatUnused",!1);o(this,"sheenUnused",!1);o(this,"_customShaderVersion",0);o(this,"_customShader");o(this,"_clearcoat",new ye(0,0));o(this,"_sheen",new We(0,0,0,0));o(this,"_specular",new We(1,1,1,1))}get customShaderVersion(){return this._customShaderVersion}set customShaderVersion(e){this.removeDefine(`CUSTOM_SHADER_VERSION ${this._customShaderVersion}`),this._customShaderVersion=e}get clearcoat(){return this._clearcoat.x}set clearcoat(e){this._clearcoat.x=e,this.setUniforms(),this._updated()}get clearcoatRoughness(){return this._clearcoat.y}set clearcoatRoughness(e){this._clearcoat.y=e,this.setUniforms(),this._updated()}get sheenColor(){return[this._sheen.x,this._sheen.y,this._sheen.z]}set sheenColor(e){this._sheen.x=e[0],this._sheen.y=e[1],this._sheen.z=e[2],this.setUniforms(),this._updated()}get sheenRoughness(){return this._sheen.w}set sheenRoughness(e){this._sheen.w=e,this.setUniforms(),this._updated()}get specularColor(){return[this._specular.x,this._specular.y,this._specular.z]}set specularColor(e){this._specular.x=e[0],this._specular.y=e[1],this._specular.z=e[2],this.setUniforms(),this._updated()}get specular(){return this._specular.w}set specular(e){this._specular.w=e,this.setUniforms(),this._updated()}setUniforms(){var c,h;super.setUniforms();const e=!!this._customShader;e||(this.setUniform("clearcoat","v2",this._clearcoat,oe.MATERIAL),this.setUniform("specular","v4",this._specular,oe.MATERIAL),this.setUniform("sheen","v4",this._sheen,oe.MATERIAL)),this.condDefine(!T.UNIVERSAL_MATERIAL_GLTF_PBR,"USE_STANDARD_PBR_MODEL"),this.condDefine(e,"CUSTOM_PBR_SHADER"),this.condDefine(this.usesTexCoords,"USES_TEX_COORDS"),this.addDefine("USE_NORMAL_MAPPING_FUNCS"),this.addDefine(`CUSTOM_SHADER_VERSION ${this._customShaderVersion}`);const i=d=>d.startsWith("USE_CLEARCOAT")||d.startsWith("USE_SHEEN")||d.startsWith("ALPHA_MODE");this.removeDefines(i);const n=e?!this.clearcoatUnused:this.clearcoat>0,s=Math.max(this._sheen.x,this._sheen.y,this._sheen.z),a=e?!this.sheenUnused:s>0;n&&this.addDefine("USE_CLEARCOAT"),a&&this.addDefine("USE_SHEEN"),this.addDefine(`ALPHA_MODE ${this.alphaMode}`),this.addDefine("HDR_OUTPUT");const l=(c=this.sharedMaterialState)!=null&&c.hdrOutput?1:0;if(this.setUniform("u_hdrOutput","i",T.DEV_NEW_RENDER_ARCHITECTURE?new js(l):l),this.reflective){const d=this.isLightProbeDisabled()?0:1;this.addDefine("USE_ENVMAP"),this.setUniform("u_useEnvMap","i",T.DEV_NEW_RENDER_ARCHITECTURE?new js(d):d),d||this._setLightProbeUniforms((h=this.sharedMaterialState)==null?void 0:h.getDefaultCubemap())}T.EDIT_MODE&&(this.addDefine("USE_HIGHLIGHT"),this.highlight&&this.setUniform("highlight","c",this.highlight,oe.MATERIAL),this.setUniform("highlightMix","f",this.highlight?this.highlightMix:0,oe.OBJECT));for(let d=0;d<this.textures.length;d++)this.setUniform(`texture${d}`,"t",this.textures[d],oe.MATERIAL);for(let d=0;d<this.uniformVectors.length;d++)this.setUniform(`shpk_uniform${d}`,"v4",this.uniformVectors[d],oe.MATERIAL)}_applySharedState(){super._applySharedState(),this.addDefine("HDR_OUTPUT")}forceEnableUv0(){return this.usesTexCoords}canMerge(e){return!1}set customShader(e){if(this._customShader=e,this._fragmentShaderHooks=e!=null?e:zi.get(Qt.fragmentShaderHooks),T.DEV_NEW_RENDER_ARCHITECTURE){const i=this._fragmentShaderHooks.code.replace(/uniform vec4 shpk_uniform\d+;/g,"");this.shaderParams.fsHooksCode=i}this.setUniforms(),this._updated()}get customShader(){return this._customShader}get type(){return hs.UNIVERSAL}configureTransparency(){this.transparent=this.customShader?this.alphaMode!=rl.OPAQUE:this.opacity!=1,this.blending=this.transparent?Yt.NORMAL:Yt.DISABLED,this.transparentRenderOrder=this.alphaMode==rl.MASK?0:1,this.depthWrite=this.alphaMode!=rl.BLEND}serialize(){const e=super.serialize(),i=!this._customShader;return e.clearcoat=i?this.clearcoat:null,e.clearcoatRoughness=i?this.clearcoatRoughness:null,e.sheenColor=i?this.sheenColor:null,e.sheenRoughness=i?this.sheenRoughness:null,e.specular=i?this.specular:null,e.specularColor=i?this.specularColor:null,i&&(e.shaderId=null),e}}const dx=.1;class ux extends ya{constructor(){super(...arguments);o(this,"wavesSpeed",0);o(this,"wavesScale",0);o(this,"refractionFactor",0)}}class fx extends Qt{constructor(){super({fsHooks:"water.glsl",uniformBufferData:new ux});o(this,"_isPlaying",!0);o(this,"_isSleeping",!1);o(this,"_wavesSpeed",1);o(this,"_wavesScale",1);o(this,"_refractionFactor",0);T.DEV_DISABLE_UNIFORM_BUFFERS&&this.setUniform("time","f",0,oe.GLOBAL),this.setUniform("wavesSpeed","f",0,oe.MATERIAL),this._roughness=0,this.baseColor=new _e(0),this.opacity=.2,this.doNotImport={baseColor:!0,baseColorTexture:!0,opacity:!0}}get hideFromLightProbes(){return this.opacity!==1&&this.refractionFactor!==0}set hideFromLightProbes(e){super.hideFromLightProbes=e}get isAnimated(){return!0}get isPlaying(){return!this._isSleeping&&this._isPlaying&&this.wavesSpeed>0}get refractionFactor(){return this._refractionFactor}set refractionFactor(e){this._doSetProperty(this,"_refractionFactor",e)}get wavesSpeed(){return this._wavesSpeed}set wavesSpeed(e){this._doSetProperty(this,"_wavesSpeed",e)}get wavesScale(){return this._wavesScale}set wavesScale(e){this._doSetProperty(this,"_wavesScale",e)}textureNeedsUv0(e){return!1}get type(){return hs.WATER}canMerge(e){if(this.type!==e.type)return!1;const i=e;return this.opacity===i.opacity&&this.baseColor.equals(i.baseColor)&&this.normalTexture===i.normalTexture&&this.wavesSpeed===i.wavesSpeed&&this.wavesScale===i.wavesScale&&this.refractionFactor===i.refractionFactor}setUniforms(){if(super.setUniforms(),this.normalTexture!==void 0&&this.normalTexture.loaded&&!this.isLightProbeDisabled()){this.setUniform("wavesScale","f",this.wavesScale,oe.MATERIAL);const e=this.opacity!==1?this.refractionFactor:0;this.setUniform("refractionFactor","f",e,oe.MATERIAL)}this.setUniform("wavesSpeed","f",this.wavesSpeed*dx,oe.MATERIAL),this.fillMaterialUniformDataFromUniforms()}play(){this._isPlaying=!0}pause(){this._isPlaying=!1}sleepAnimation(){this._isSleeping=!0}wakeAnimation(){this._isSleeping=!1}update(e){T.DEV_DISABLE_UNIFORM_BUFFERS&&(this.uniforms.time.value+=e)}serialize(){var e,i;return this.id,{name:this.name,id:this.id,type:this.type,baseColor:this.baseColor.roundChannels().toArray(),baseColorTexture:null,opacity:this.opacity,normalTexture:(i=(e=this.normalTexture)==null?void 0:e.serialize())!=null?i:null,wavesSpeed:this.wavesSpeed,wavesScale:this.wavesScale,refractionFactor:this.refractionFactor,doNotImport:this.doNotImport}}}class tn{constructor(){o(this,"id",NaN);o(this,"attributes",new Ey);o(this,"attributesKeys",new Array);o(this,"boundingBox",null);o(this,"boundingSphere",null);o(this,"_disableBoundingVolumesCompute",!1);o(this,"_onDispose")}addAttribute(t,e){this.attributes[t]=e,this.attributesKeys.indexOf(t)==-1&&this.attributesKeys.push(t)}getAttribute(t){return this.attributes[t]}hasAttribute(t){return this.attributesKeys.includes(t)}applyMatrix(t){const e=this.attributes.position;e!==void 0&&(Ce(e.array instanceof Float32Array),t.affineTransformPoint3Array(e.array),e.needsUpdate=!0);const i=this.attributes.normal;i!==void 0&&(Ce(i.array instanceof Float32Array),new Eo().getNormalMatrix(t).transformVector3Array(i.array),i.needsUpdate=!0),this.boundingBox!==null&&this.computeBoundingBox(),this.boundingSphere!==null&&this.computeBoundingSphere()}center(){nt(!this._disableBoundingVolumesCompute),this.computeBoundingBox();const t=this.boundingBox.center().negate();return this.applyMatrix(new Ue().setPosition(t)),t}computeBoundingBox(){if(this._disableBoundingVolumesCompute)return;nt(this.attributes.position);const t=new L;this.boundingBox===null&&(this.boundingBox=new li);const e=this.attributes.position.array;if(e){const i=this.boundingBox;i.makeEmpty();for(let n=0,s=e.length;n<s;n+=3)t.set(e[n],e[n+1],e[n+2]),i.expandByPoint(t)}else this.attributes.position.buffer&&console.warn("Computing bounding box for geometry with released position data");(!e||e.length===0)&&(this.boundingBox.min.set(0,0,0),this.boundingBox.max.set(0,0,0)),(isNaN(this.boundingBox.min.x)||isNaN(this.boundingBox.min.y)||isNaN(this.boundingBox.min.z))&&console.error('Computed bbox min/max have NaN values. The "position" attribute is likely to have NaN values.')}computeBoundingSphere(){if(this._disableBoundingVolumesCompute)return;nt(this.attributes.position);const t=new li,e=new L;this.boundingSphere===null&&(this.boundingSphere=new os);const i=this.attributes.position.array;if(i){t.makeEmpty();const n=this.boundingSphere.center;for(let a=0;a<i.length;a+=3)e.set(i[a],i[a+1],i[a+2]),t.expandByPoint(e);t.center(n);let s=0;for(let a=0;a<i.length;a+=3)e.set(i[a],i[a+1],i[a+2]),s=Math.max(s,n.distanceToSquared(e));this.boundingSphere.radius=Math.sqrt(s),isNaN(this.boundingSphere.radius)&&console.error('Computed bounding sphere radius is NaN. The "position" attribute is likely to have NaN values.')}else this.attributes.position.buffer&&console.warn("Computing bounding sphere for geometry with released position data")}computeVertexNormals(){var n;const t=this.attributes;if(!t.position)return;t.position.array instanceof Float32Array;const e=(n=t.index)==null?void 0:n.array,i=Ka.vertexNormals(t.position.array,e);t.normal===void 0?this.addAttribute("normal",new Dt(i,3)):t.normal.array=i,t.normal.needsUpdate=!0}normalizeNormals(){this.attributes.normal&&(this.attributes.normal.array instanceof Float32Array,Ka.normalizeVectors(this.attributes.normal.array))}setOnDispose(t){this._onDispose=t}dispose(){this._onDispose&&this._onDispose(this)}convertNormalsToSpherical(){nt(this.attributes.normal),nt(this.attributes.sphericalNormal===void 0),nt(this.attributes.normal.array);const t=this.attributes.normal.array,e=$e.ios,i=Ka.normalsToSpherical(t,e);delete this.attributes.normal;const n=this.attributesKeys.indexOf("normal");this.attributesKeys.splice(n,1),this.addAttribute("sphericalNormal",new Dt(i,2))}changePosition(t){nt(this.attributes.position);const e=this.attributes.position.length/3,i=this.attributes.position.array;for(let n=0;n<3*e;n+=3)i[n]+=t.x,i[n+1]+=t.y,i[n+2]+=t.z}}class ft{static createBox(t,e,i,n=1,s=1,a=1){for(const m of[n,s,a])console.assert(Number.isInteger(m)&&m>=1);const l=new Array,c=new Array,h=new Array,d=new Array;let u=0;function f(m,b,g,x,w,C,M,D,W,z){const $=C/W,Z=M/z,ne=C/2,Me=M/2,Xe=D/2,xe=W+1,Le=z+1;let B=0;const Y=new L;for(let re=0;re<Le;re++){const le=re*Z-Me;for(let ge=0;ge<xe;ge++){const pe=ge*$-ne;Y[m]=pe*x,Y[b]=le*w,Y[g]=Xe,c.push(Y.x,Y.y,Y.z),Y[m]=0,Y[b]=0,Y[g]=D>0?1:-1,h.push(Y.x,Y.y,Y.z),d.push(ge/W),d.push(1-re/z),B+=1}}for(let re=0;re<z;re++)for(let le=0;le<W;le++){const ge=u+le+xe*re,pe=u+le+xe*(re+1),Ae=u+(le+1)+xe*(re+1),Fe=u+(le+1)+xe*re;l.push(ge,pe,Fe),l.push(pe,Ae,Fe)}u+=B}f("z","y","x",-1,-1,i,e,t,a,s),f("z","y","x",1,-1,i,e,-t,a,s),f("x","z","y",1,1,t,i,e,n,a),f("x","z","y",1,-1,t,i,-e,n,a),f("x","y","z",1,-1,t,e,i,n,s),f("x","y","z",-1,-1,t,e,-i,n,s),console.assert(c.length<=65535+1);const p=new tn;return p.addAttribute("index",new Dt(new Uint16Array(l),1)),p.addAttribute("position",new Dt(new Float32Array(c),3)),p.addAttribute("normal",new Dt(new Float32Array(h),3)),p.addAttribute("uv0",new Dt(new Float32Array(d),2)),p}static createSphere(t=50,e=8,i=6,n=0,s=Math.PI*2,a=0,l=Math.PI){console.assert(e>=3&&Number.isInteger(e)),console.assert(i>=2&&Number.isInteger(i));const c=a+l;let h=0;const d=[],u=new L,f=new L,p=new Array,m=new Array,b=new Array,g=new Array;for(let w=0;w<=i;w++){const C=[],M=w/i;for(let D=0;D<=e;D++){const W=D/e;u.x=-t*Math.cos(n+W*s)*Math.sin(a+M*l),u.y=t*Math.cos(a+M*l),u.z=t*Math.sin(n+W*s)*Math.sin(a+M*l),m.push(u.x,u.y,u.z),f.set(u.x,u.y,u.z),f.normalize(),b.push(f.x,f.y,f.z),g.push(W,1-M),C.push(h++)}d.push(C)}for(let w=0;w<i;w++)for(let C=0;C<e;C++){const M=d[w][C+1],D=d[w][C],W=d[w+1][C],z=d[w+1][C+1];(w!==0||a>0)&&p.push(M,D,z),(w!==i-1||c<Math.PI)&&p.push(D,W,z)}console.assert(m.length<=65535+1);const x=new tn;return x.addAttribute("index",new Dt(new Uint16Array(p),1)),x.addAttribute("position",new Dt(new Float32Array(m),3)),x.addAttribute("normal",new Dt(new Float32Array(b),3)),x.addAttribute("uv0",new Dt(new Float32Array(g),2)),x}static createPlane(t,e,i=1,n=1){console.assert(i>=1&&Number.isInteger(i)),console.assert(n>=1&&Number.isInteger(n));const s=t/2,a=e/2,l=i,c=n,h=l+1,d=c+1,u=t/l,f=e/c,p=new Float32Array(h*d*3),m=new Float32Array(h*d*3),b=new Float32Array(h*d*2);let g=0,x=0;for(let M=0;M<d;M++){const D=M*f-a;for(let W=0;W<h;W++){const z=W*u-s;p[g]=z,p[g+1]=-D,m[g+2]=1,b[x]=W/l,b[x+1]=1-M/c,g+=3,x+=2}}g=0;const w=new(p.length/3>65535?Uint32Array:Uint16Array)(l*c*6);for(let M=0;M<c;M++)for(let D=0;D<l;D++){const W=D+h*M,z=D+h*(M+1),$=D+1+h*(M+1),Z=D+1+h*M;w[g]=W,w[g+1]=z,w[g+2]=Z,w[g+3]=z,w[g+4]=$,w[g+5]=Z,g+=6}const C=new tn;return C.addAttribute("index",new Dt(w,1)),C.addAttribute("position",new Dt(p,3)),C.addAttribute("normal",new Dt(m,3)),C.addAttribute("uv0",new Dt(b,2)),C}static createCylinder(t=20,e=20,i=100,n=8,s=1,a=!1,l=0,c=2*Math.PI){console.assert(n>=3&&Number.isInteger(n)),console.assert(s>=1&&Number.isInteger(s));const h=new Array,d=new Array,u=new Array,f=new Array;let p=0;const m=new Array,b=i/2;function g(){const C=new L,M=new L,D=(e-t)/i;for(let W=0;W<=s;W++){const z=[],$=W/s,Z=$*(e-t)+t;for(let ne=0;ne<=n;ne++){const Me=ne/n,Xe=Me*c+l,xe=Math.sin(Xe),Le=Math.cos(Xe);M.x=Z*xe,M.y=-$*i+b,M.z=Z*Le,d.push(M.x,M.y,M.z),C.set(xe,D,Le),C.normalize(),u.push(C.x,C.y,C.z),f.push(Me,1-$),z.push(p++)}m.push(z)}for(let W=0;W<n;W++)for(let z=0;z<s;z++){const $=m[z][W],Z=m[z+1][W],ne=m[z+1][W+1],Me=m[z][W+1];h.push($,Z,Me),h.push(Z,ne,Me)}}function x(C){const M=new ye,D=new L,W=C?t:e,z=C?1:-1,$=p;for(let ne=1;ne<=n;ne++)d.push(0,b*z,0),u.push(0,z,0),f.push(.5,.5),p++;const Z=p;for(let ne=0;ne<=n;ne++){const Xe=ne/n*c+l,xe=Math.cos(Xe),Le=Math.sin(Xe);D.x=W*Le,D.y=b*z,D.z=W*xe,d.push(D.x,D.y,D.z),u.push(0,z,0),M.x=xe*.5+.5,M.y=Le*.5*z+.5,f.push(M.x,M.y),p++}for(let ne=0;ne<n;ne++){const Me=$+ne,Xe=Z+ne;C===!0?h.push(Xe,Xe+1,Me):h.push(Xe+1,Xe,Me)}}g(),a||(t>0&&x(!0),e>0&&x(!1)),console.assert(d.length<=65535+1);const w=new tn;return w.addAttribute("index",new Dt(new Uint16Array(h),1)),w.addAttribute("position",new Dt(new Float32Array(d),3)),w.addAttribute("normal",new Dt(new Float32Array(u),3)),w.addAttribute("uv0",new Dt(new Float32Array(f),2)),w}static createTorus(t=1,e=.4,i=8,n=6,s=Math.PI*2){console.assert(i>=3&&Number.isInteger(i)),console.assert(n>=3&&Number.isInteger(n));const a=new Array,l=new Array,c=new Array,h=new Array,d=new L,u=new L,f=new L;for(let m=0;m<=i;m++)for(let b=0;b<=n;b++){const g=b/n*s,x=m/i*Math.PI*2;u.x=(t+e*Math.cos(x))*Math.cos(g),u.y=(t+e*Math.cos(x))*Math.sin(g),u.z=e*Math.sin(x),l.push(u.x,u.y,u.z),d.x=t*Math.cos(g),d.y=t*Math.sin(g),f.subVectors(u,d).normalize(),c.push(f.x,f.y,f.z),h.push(b/n),h.push(m/i)}for(let m=1;m<=i;m++)for(let b=1;b<=n;b++){const g=(n+1)*m+b-1,x=(n+1)*(m-1)+b-1,w=(n+1)*(m-1)+b,C=(n+1)*m+b;a.push(g,x,C),a.push(x,w,C)}console.assert(l.length<=65535+1);const p=new tn;return p.addAttribute("index",new Dt(new Uint16Array(a),1)),p.addAttribute("position",new Dt(new Float32Array(l),3)),p.addAttribute("normal",new Dt(new Float32Array(c),3)),p.addAttribute("uv0",new Dt(new Float32Array(h),2)),p}static createPolyhedron(t,e,i=1,n=0){const s=new Array,a=new Array;function l(m,b,g){const x=Math.pow(2,n),w=new Array;for(let M=0;M<=x;M++){w[M]=[];const D=m.clone().lerp(g,M/x),W=b.clone().lerp(g,M/x),z=x-M;for(let $=0;$<=z;$++)$===0&&M===x?w[M][$]=D:w[M][$]=D.clone().lerp(W,$/z)}const C=M=>s.push(M.x,M.y,M.z);for(let M=0;M<x;M++)for(let D=0;D<2*(x-M)-1;D++){const W=Math.floor(D/2);D%2===0?(C(w[M][W+1]),C(w[M+1][W]),C(w[M][W])):(C(w[M][W+1]),C(w[M+1][W+1]),C(w[M+1][W]))}}function c(){for(let m=0;m<a.length;m+=6){const b=a[m+0],g=a[m+2],x=a[m+4],w=Math.max(b,g,x),C=Math.min(b,g,x);w>.9&&C<.1&&(b<.2&&(a[m+0]+=1),g<.2&&(a[m+2]+=1),x<.2&&(a[m+4]+=1))}}function h(m,b){const g=m*3;b.x=t[g+0],b.y=t[g+1],b.z=t[g+2]}function d(){const m=new L,b=new L,g=new L,x=new L,w=new ye,C=new ye,M=new ye,D=(W,z,$,Z)=>{Z<0&&W.x===1&&(a[z]=W.x-1),$.x===0&&$.z===0&&(a[z]=Z/2/Math.PI+.5)};for(let W=0,z=0;W<s.length;W+=9,z+=6){m.set(s[W+0],s[W+1],s[W+2]),b.set(s[W+3],s[W+4],s[W+5]),g.set(s[W+6],s[W+7],s[W+8]),w.set(a[z+0],a[z+1]),C.set(a[z+2],a[z+3]),M.set(a[z+4],a[z+5]),x.copyFrom(m).add(b).add(g).divideScalar(3);const $=u(x);D(w,z+0,m,$),D(C,z+2,b,$),D(M,z+4,g,$)}}const u=m=>Math.atan2(m.z,-m.x),f=m=>Math.atan2(-m.y,Math.sqrt(m.x*m.x+m.z*m.z));{const m=new L,b=new L,g=new L;for(let x=0;x<e.length;x+=3)h(e[x+0],m),h(e[x+1],b),h(e[x+2],g),l(m,b,g)}{const m=new L;for(let b=0;b<s.length;b+=3)m.x=s[b+0],m.y=s[b+1],m.z=s[b+2],m.normalize().multiplyScalar(i),s[b+0]=m.x,s[b+1]=m.y,s[b+2]=m.z}{const m=new L;for(let b=0;b<s.length;b+=3){m.x=s[b+0],m.y=s[b+1],m.z=s[b+2];const g=u(m)/2/Math.PI+.5,x=f(m)/Math.PI+.5;a.push(g,1-x)}d(),c()}const p=new tn;return p.addAttribute("position",new Dt(new Float32Array(s),3)),p.addAttribute("normal",new Dt(new Float32Array(s.slice()),3)),p.addAttribute("uv0",new Dt(new Float32Array(a),2)),n===0?p.computeVertexNormals():p.normalizeNormals(),p}static createIcosahedron(t,e){const i=(1+Math.sqrt(5))/2,n=[-1,i,0,1,i,0,-1,-i,0,1,-i,0,0,-1,i,0,1,i,0,-1,-i,0,1,-i,i,0,-1,i,0,1,-i,0,-1,-i,0,1],s=[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1];return ft.createPolyhedron(n,s,t,e)}}function px(){const r=ft.createBox(2,2,2);return r.convertNormalsToSpherical(),r}function mx(){const r=ft.createIcosahedron(1,2);return r.convertNormalsToSpherical(),r}var Zc=(r=>(r.CUBE="cube",r.SPHERE="sphere",r))(Zc||{});const ll=new L,xm=new bi;var Em=(r=>(r.UPDATED="cameraVolumeTriggerUpdated",r.DISPOSED="cameraVolumeTriggerDisposed",r))(Em||{});const rr=class rr extends ci{constructor(e,i,n){super();o(this,"_enterCallbacks");o(this,"_exitCallbacks");o(this,"volumeType");o(this,"position");o(this,"rotation");o(this,"scale");o(this,"_inverse",new Ue);o(this,"_inverseCached",!1);o(this,"_inside",!1);o(this,"_cameraPosition");o(this,"_disposed",!1);this._enterCallbacks=e,this._exitCallbacks=i,this.volumeType=n.type,this.position=new L().fromArray(n.position),this.rotation=new Fi().setFromDegTriple(n.rotation),this.scale=new L().fromArray(n.scale),this.onCameraPositionUpdated=this.onCameraPositionUpdated.bind(this)}onCameraPositionUpdated(e){this._cameraPosition=e.newPosition,this.onUpdated()}onUpdated(){if(this._disposed||(this.dispatchEvent({type:rr.eventType.UPDATED}),!this._cameraPosition))return;const e=this.isPointInside(this._cameraPosition);e!==this._inside&&(this._inside=e,e?this._enterCallbacks.forEach(i=>i()):this._exitCallbacks.forEach(i=>i()))}getVolumeGeometry(){return this.volumeType==="sphere"?rr._sphereGeometry:rr._boxGeometry}setPosition(e,i,n){this.position.set(e,i,n),this._inverseCached=!1,this.onUpdated()}setRotation(e,i,n){this.rotation.yaw=Zt(e),this.rotation.pitch=Zt(i),this.rotation.roll=Zt(n),this._inverseCached=!1,this.onUpdated()}setRotationDeg(e,i,n){const s=Ai(e),a=Ai(i),l=Ai(n);this.setRotation(s,a,l)}setScale(e,i,n){this.scale.set(e,i,n),this._inverseCached=!1,this.onUpdated()}isPointInsideUnitSphere(e){return e.lengthSq()<=1}isPointInsideUnitCube(e){return Math.abs(ll.x)<=1&&Math.abs(e.y)<=1&&Math.abs(e.z)<=1}isPointInside(e){return this._inverseCached||(this.rotation.toQuaternion(xm),this._inverse.compose(this.position,xm,this.scale),this._inverse.getInverse(this._inverse),this._inverseCached=!0),ll.set(e.x,e.y,e.z),this._inverse.affineTransformPoint3(ll),this.volumeType==="sphere"?this.isPointInsideUnitSphere(ll):this.isPointInsideUnitCube(ll)}dispose(e=!1){this._disposed=!0,this._inside&&!e&&this._exitCallbacks.forEach(i=>i()),this._inside=!1,this.dispatchEvent({type:rr.eventType.DISPOSED})}reinstate(){this._disposed=!1,this.dispatchEvent({type:rr.eventType.UPDATED})}serialize(){return{type:this.volumeType,position:this.position.toArray(),rotation:this.rotation.toDegTriple(),scale:this.scale.toArray()}}};o(rr,"eventType",Em),o(rr,"_boxGeometry",px()),o(rr,"_sphereGeometry",mx());let jn=rr;class Jc{constructor(t,e,i){o(this,"light");o(this,"position");o(this,"rotation");this.light=t,this.position=e,this.rotation=i}get index(){const t=this.light.instances.indexOf(this);return console.assert(t!==-1,"Light instance not found"),t}setPosition(t,e,i){this.position.set(t,e,i),this.light.updated()}setRotation(t,e,i){this.rotation.yaw=Zt(t),this.rotation.pitch=Zt(e),this.rotation.roll=Zt(i),this.light.updated()}setRotationDeg(t,e,i){const n=Ai(t),s=Ai(e);this.setRotation(n,s,Ai(i))}serialize(){return{position:this.position.toArray(),rotation:this.rotation.toDegTriple()}}}var Ln=(r=>(r.POINT="point",r.SPOT="spot",r.AREA="area",r.SUN="sun",r))(Ln||{});const _x=["angle","color","height","photometricProfile","strength","size","type","width"];function gx(r){switch(r){case"point":case"spot":case"area":return 25;case"sun":return 8}zs(r,"Unknown LightType")}function vx(r){switch(r){case"point":case"spot":case"area":return new _e(1,.88,.799);case"sun":return new _e(1,.799,.658)}zs(r,"Unknown LightType")}function bx(r){switch(r){case"point":case"spot":case"area":return .1;case"sun":return .02}zs(r,"Unknown LightType")}var Am=(r=>(r.UPDATED="lightUpdated",r.INSTANCE_ADDED="instanceAdded",r.INSTANCE_REMOVED="instanceRemoved",r))(Am||{});const uo=class uo extends ci{constructor(e){var i,n,s,a,l,c,h;super();o(this,"_name");o(this,"_enabled");o(this,"_type");o(this,"_strength");o(this,"_color");o(this,"_size");o(this,"_width");o(this,"_height");o(this,"_angle");o(this,"_photometricProfile");o(this,"instances",new Array);o(this,"doNotImport");this._name=e.name,this._type=(i=e.type)!=null?i:"spot",this._strength=(n=e.strength)!=null?n:gx(this._type),this._color=e.color!==void 0?new _e().fromArray(e.color):vx(this._type),this._size=(s=e.size)!=null?s:bx(this._type),this._width=(a=e.width)!=null?a:.2,this._height=(l=e.height)!=null?l:.2,this._angle=(c=e.angle)!=null?c:140,this._photometricProfile=e.photometricProfile,this._enabled=(h=e.enabled)!=null?h:!0,e.doNotImport===!0?this.doNotImport=!0:(this.doNotImport={},e.doNotImport&&Dd(e.doNotImport,_x,this.doNotImport))}get fromEditor(){return this.doNotImport===!0}forEachLightInstance(e){for(let i=0;i<this.instances.length;i+=1)e(this.instances[i])}get name(){return this._name}set name(e){this._name=e,this.updated()}get enabled(){return this._enabled}set enabled(e){this._enabled=e,this.updated()}get type(){return this._type}set type(e){this._type=e,this.updated()}get size(){return this._size}set size(e){this._size=e,this.updated()}get width(){return this._width}set width(e){this._width=e,this.updated()}get height(){return this._height}set height(e){this._height=e,this.updated()}get angle(){return this._angle}set angle(e){this._angle=e,this.updated()}get color(){return this._color}setColorRGB(e,i,n){this._color.setRGB(e,i,n),this.updated()}get strength(){return this._strength}set strength(e){this._strength=e,this.updated()}get photometricProfile(){return this._photometricProfile}set photometricProfile(e){this._photometricProfile=e,this.updated()}setDoNotImport(e,i){this.doNotImport,this.doNotImport[e]=i,this.updated()}addCreatedInstance(e){Ce(e.light===this),this.instances.push(e),this.dispatchEvent({type:uo.eventType.INSTANCE_ADDED,instance:e})}addInstance(e,i=[0,-90,0]){const n=new L().fromArray(e),s=new Fi().setFromDegTriple(i);this.addCreatedInstance(new Jc(this,n,s))}removeInstance(e){Qi(e,this.instances),this.dispatchEvent({type:uo.eventType.INSTANCE_REMOVED,instance:e})}serialize(){return{name:this.name,type:this.type,angle:this.angle,strength:this.strength,photometricProfile:this.photometricProfile,size:this.size,width:this.width,height:this.height,color:this.color.roundChannels().toArray(),enabled:this.enabled,doNotImport:this.doNotImport,instances:this.instances.map(e=>e.serialize())}}updated(){this.dispatchEvent({type:uo.eventType.UPDATED,target:this})}static iterateLightInstances(e,i){let n=1;for(const s of e)for(const a of s.instances)i(s,a,n++)}static loadInstances(e,i){e.forEach(n=>i.addInstance(n.position,n.rotation))}static loadLights(e){const i=new Array;return e==null||e.forEach(function(n){const s=new uo(n);uo.loadInstances(n.instances,s),i.push(s)}),i}};o(uo,"eventType",Am);let On=uo;var Tm=(r=>(r.POSITION_UPDATED="positionUpdated",r.BOUNDS_UPDATED="boundsUpdated",r.BOUNDS_INIT="boundsInit",r))(Tm||{});const Or=class Or extends ci{constructor(e,i=!1){super();o(this,"id");o(this,"position");o(this,"boxMin",new L);o(this,"boxMax",new L);o(this,"_filteredCubeTexture");o(this,"_mirrorCubeTexture");o(this,"_boxEnabled");e.id,this.id=e.id,this.position=new L,e.position&&this.position.fromArray(e.position),this._boxEnabled=e.box?!("enabled"in e.box)||e.box.enabled:!1,e.box&&!i&&(this.boxMin.fromArray(e.box.min),this._setClampedBoxMax(...e.box.max))}setFilteredTexture(e){this._filteredCubeTexture&&this._filteredCubeTexture.dispose(),this._filteredCubeTexture=e}isBoundingBoxInitialized(){return!this.boxMin.equals(this.boxMax)}resetBoundingBox(){this.boxMin.set(0,0,0),this.boxMax.set(0,0,0)}isBoundingBoxEnabled(){return this._boxEnabled}disableBoundingBox(){this._boxEnabled=!1,this.dispatchEvent({type:Or.eventType.BOUNDS_UPDATED})}enableBoundingBox(){this._boxEnabled=!0,this.isBoundingBoxInitialized()||this.dispatchEvent({type:Or.eventType.BOUNDS_INIT}),this.dispatchEvent({type:Or.eventType.BOUNDS_UPDATED})}getFilteredTexture(){return this._filteredCubeTexture}setMirrorTexture(e){this._mirrorCubeTexture&&this._mirrorCubeTexture.dispose(),this._mirrorCubeTexture=e}setPosition(e,i,n){this.position.set(e,i,n),this.dispatchEvent({type:Or.eventType.POSITION_UPDATED})}texturesReady(){return!!(this._mirrorCubeTexture||this._filteredCubeTexture)}getMirrorTexture(){return this._mirrorCubeTexture||this._filteredCubeTexture}_setClampedBoxMin(e,i,n){e>this.boxMax.x-.1&&(e=this.boxMax.x-.1),i>this.boxMax.y-.1&&(i=this.boxMax.y-.1),n>this.boxMax.z-.1&&(n=this.boxMax.z-.1),this.boxMin.set(e,i,n)}setBoxMin(e,i,n){this._setClampedBoxMin(e,i,n),this.dispatchEvent({type:Or.eventType.BOUNDS_UPDATED})}_setClampedBoxMax(e,i,n){e<this.boxMin.x+.1&&(e=this.boxMin.x+.1),i<this.boxMin.y+.1&&(i=this.boxMin.y+.1),n<this.boxMin.z+.1&&(n=this.boxMin.z+.1),this.boxMax.set(e,i,n)}setBoxMax(e,i,n){this._setClampedBoxMax(e,i,n),this.dispatchEvent({type:Or.eventType.BOUNDS_UPDATED})}serialize(){const e={id:this.id,position:this.position.toArray()};return this.isBoundingBoxInitialized()&&(e.box={enabled:this._boxEnabled,min:this.boxMin.toArray(),max:this.boxMax.toArray()}),e}dispose(){this._filteredCubeTexture&&(this._filteredCubeTexture.dispose(),this._filteredCubeTexture=void 0),this._mirrorCubeTexture&&(this._mirrorCubeTexture.dispose(),this._mirrorCubeTexture=void 0)}};o(Or,"eventType",Tm);let nn=Or;class gr{static compareInstances(t,e){return t.compare(e)}}class wm{constructor(){o(this,"refCounter",0)}}class Io extends wm{constructor(){super(...arguments);o(this,"descriptor")}load(e){return!1}unload(e){}}class Kt{constructor(t){o(this,"_resource");t&&this.set(t)}get(){return this._resource}set(t,e){this._resource!==t&&(this._resource&&(this._resource.refCounter>=1,--this._resource.refCounter===0&&e.unuseResource(this._resource),this._resource=void 0),t&&(t.refCounter++,this._resource=t))}clone(){return new Kt(this._resource)}copyFrom(t,e){this.set(t._resource,e)}static compareResources(t,e){return t.get()===e.get()?0:t.get()?e.get()?gr.compareInstances(t.get().descriptor,e.get().descriptor):1:-1}}class Xr{constructor(t,e=!0){o(this,"osBoundingBox",new li);o(this,"wsBoundingBox",new li);o(this,"wsSphere",new os);o(this,"frustumCulled",!0);this.osBoundingBox.copyFrom(t),this.wsBoundingBox.copyFrom(this.osBoundingBox),this.wsBoundingBox.getBoundingSphere(this.wsSphere),this.frustumCulled=e}}const Sm="COLLIDER_TAG";var xt=(r=>(r[r.OPAQUE=0]="OPAQUE",r[r.GRASS=1]="GRASS",r[r.TRANSPARENT=2]="TRANSPARENT",r[r.SKY=3]="SKY",r[r.MESH_ANIMATION=4]="MESH_ANIMATION",r))(xt||{});const eu=5;class tu{constructor(){o(this,"meshDesc");o(this,"materialDesc");o(this,"lightBindingDesc");o(this,"entity")}}class qr{constructor(){o(this,"mesh",new Kt);o(this,"renderMaterial",new Kt);o(this,"activeMaterial");o(this,"lightDataBinding");o(this,"perObjectUniformBuffer");o(this,"entity");o(this,"boundsComp");o(this,"index",-1);o(this,"_flags",new xo)}static compare(t,e){const i=Kt.compareResources(t.renderMaterial,e.renderMaterial);if(i!==0)return i;const n=Kt.compareResources(t.mesh,e.mesh);if(n!==0)return n;if(t.lightDataBinding!==e.lightDataBinding){if(t.lightDataBinding){if(!e.lightDataBinding)return 1}else return-1;const s=Kt.compareResources(t.lightDataBinding,e.lightDataBinding);if(s!==0)return s}if(t.entity!==e.entity){if(t.entity){if(!e.entity)return 1}else return-1;if(t.entity.id!==e.entity.id)return t.entity.id<e.entity.id?-1:1}return 0}load(t,e){this.entity=e.entity,this.boundsComp=this.entity?this.entity.get(Xr):void 0;const i=e.materialDesc.material;this._flags.setFlag(0,this._flags.isFlagEnabled(0)&&i.visible),this.setMaterial(t,e.materialDesc),this.setLightDataBinding(t,e.lightBindingDesc),this.mesh=t.getResource(e.meshDesc),this._flags.setFlag(1,!0)}get visible(){return this._flags.isFlagEnabled(0)}getShader(){return this.renderMaterial.get(),this.renderMaterial.get().shader.get()}set visible(t){this._flags.setFlag(0,t)}set usesCameraJitter(t){this._flags.setFlag(3,t)}get usesCameraJitter(){return this._flags.isFlagEnabled(3)}get usesNormalMatrix(){return this._flags.isFlagEnabled(2)}get usesPerObjectBuffer(){return this._flags.isFlagEnabled(4)}setMaterial(t,e){this.activeMaterial=e.material,this.renderMaterial=t.getResource(e);const i=Vi[oe.OBJECT],n=this.getShader().uniformBlockDescriptors.get(i);this._flags.setFlag(4,n!==void 0),n&&this._flags.setFlag(2,n.hasUniform("normalMatrix"))}setLightDataBinding(t,e){e&&this.getShader().uniformBlockDescriptors.has("LightBuffer")?(this.lightDataBinding&&this.lightDataBinding.set(void 0,t),this.lightDataBinding=t.getResource(e)):this.lightDataBinding&&(this.lightDataBinding.set(void 0,t),this.lightDataBinding=void 0)}getPerObjectUniformOffset(t){const e=Vi[oe.OBJECT];return this.getShader().uniformBlockDescriptors.get(e).getUniformOffsetInBytes(t)}uploadPerObjectUniformSubData(t,e,i){this.perObjectUniformBuffer,this.perObjectUniformBuffer.uploadSubdataToGPU(e,this.getPerObjectUniformOffset(t),i)}render(t){const e=this.mesh.get();t.drawGeometry(e.itemsCount,e.indexBufferType,e.offset,e.instanced?e.instanceCount:void 0)}unload(t){this._flags.isFlagEnabled(1)&&(this._flags.disableFlag(1),this.mesh.set(void 0,t),this.renderMaterial.set(void 0,t),this.lightDataBinding&&this.lightDataBinding.set(void 0,t))}}class yx{constructor(){o(this,"_sortedList",new cy(void 0,qr.compare));o(this,"_needsReindexing",!1)}add(t){this._sortedList.size(),this._sortedList.insert(t),this._needsReindexing=!0}getSortedList(){return this._sortedList}remove(t){this._sortedList.eraseElementByKey(t),t.index=-1,this._needsReindexing=!0}reindexIfNeeded(){if(this._needsReindexing){this._needsReindexing=!1;let t=0;for(const e of this._sortedList)e.index=t++}}}class As{constructor(t){o(this,"matrix");o(this,"perObjectUniformBuffer");o(this,"motionDrawCall",new qr);this.matrix=t!=null&&t.matrix?t.matrix:new Ue}}var Mm=(r=>(r.UPDATED="nodeConfigUpdated",r))(Mm||{});function iu(r){return r!=null}class xx extends ci{constructor(e){var i,n,s,a,l,c;super();o(this,"nodes",new Array);o(this,"name");o(this,"overriddenMaterialId");o(this,"_editable");o(this,"_setsDisableCollisions");o(this,"_disableCollisions");o(this,"_setsHideInViews");o(this,"_hideInViews",null);o(this,"_setsLightmapResolution",!1);o(this,"_lightmapResolution",null);o(this,"_ground");o(this,"_faceCamera");o(this,"_rotate");o(this,"_rotationSpeed");o(this,"_isolateShadows");o(this,"_setsSimplificationParams",!1);o(this,"_simplificationParams",null);o(this,"_updated");this.name=e.name,this.overriddenMaterialId=e.overriddenMaterialId,this._editable=e.editable||!1,this._setsDisableCollisions=iu(e.disableCollisions),this._disableCollisions=(i=e.disableCollisions)!=null?i:!1,this._setsHideInViews=iu(e.hideInViews),e.hideInViews&&(this._hideInViews=e.hideInViews,this._hideInViews.sort()),iu(e.lightmapResolution)&&(this._setsLightmapResolution=!0,this._lightmapResolution=e.lightmapResolution),this._ground=(n=e.ground)!=null?n:!1,this._faceCamera=(s=e.faceCamera)!=null?s:null,this._rotate=(a=e.rotate)!=null?a:!1,this._rotationSpeed=(l=e.rotationSpeed)!=null?l:.1,this._isolateShadows=(c=e.isolateShadows)!=null?c:!1,e.simplificationParams&&(this._setsSimplificationParams=!0,this._simplificationParams=e.simplificationParams),this._updated=()=>this.dispatchEvent({type:"nodeConfigUpdated",target:this})}get hideInViews(){return this._hideInViews}_configUpdated(){this.nodes.forEach(e=>e.visitSubtree(i=>i.configure())),this._updated()}addNode(e){this.nodes.push(e)}isOnHideInViews(e){return this._hideInViews,this._hideInViews.indexOf(e)!==-1}setHideInViews(e){this._hideInViews=e,this._configUpdated()}addToHideInViews(...e){console.assert(this.setsHideInViews),this._hideInViews;for(const i of e)console.assert(!this.isOnHideInViews(i)),this._hideInViews.push(i);this._configUpdated()}removeFromHideInViews(e){this._hideInViews&&(this._hideInViews=this._hideInViews.filter(i=>i!==e),this._configUpdated())}serialize(){var i;const e=this.setsSimplificationParams?this.simplificationParams:null;return{name:this.name,disableCollisions:this.setsDisableCollisions?this.disableCollisions:null,hideInViews:this.setsHideInViews?this.hideInViews:null,lightmapResolution:this.setsLightmapResolution?this.lightmapResolution:null,ground:this.ground?!0:null,faceCamera:this.faceCamera,rotate:this.rotate?!0:null,rotationSpeed:this.rotate?this.rotationSpeed:null,isolateShadows:this.isolateShadows?!0:null,simplificationParams:e,overriddenMaterialId:(i=this.overriddenMaterialId)!=null?i:null}}get setsDisableCollisions(){return this._setsDisableCollisions}set setsDisableCollisions(e){this._setsDisableCollisions=e,this._configUpdated()}get disableCollisions(){return this._disableCollisions}set disableCollisions(e){console.assert(this._setsDisableCollisions),this._disableCollisions=e,this._configUpdated()}get editable(){return!!(this._editable||this.faceCamera||this.rotate)}set editable(e){this._editable=e,this._configUpdated()}get ground(){return this._ground}set ground(e){this._ground=e,this._configUpdated()}get faceCamera(){return this._faceCamera}set faceCamera(e){this._faceCamera=e,this._configUpdated()}get rotate(){return this._rotate}set rotate(e){this._rotate=e,this._configUpdated()}get rotationSpeed(){return this._rotationSpeed}set rotationSpeed(e){e===0&&(e=.01),this._rotationSpeed=e,this._configUpdated()}get setsLightmapResolution(){return this._setsLightmapResolution}set setsLightmapResolution(e){this._setsLightmapResolution=e,this._configUpdated()}get lightmapResolution(){return this._lightmapResolution}set lightmapResolution(e){console.assert(this._setsLightmapResolution),this._lightmapResolution=e,this._configUpdated()}get isolateShadows(){return this._isolateShadows}set isolateShadows(e){this._isolateShadows=e,this._configUpdated()}get setsSimplificationParams(){return this._setsSimplificationParams}set setsSimplificationParams(e){this._setsSimplificationParams=e,this._configUpdated()}get simplificationParams(){return this._simplificationParams}set simplificationParams(e){console.assert(this._setsSimplificationParams),this._simplificationParams=e,this._configUpdated()}get setsHideInViews(){return this._setsHideInViews}set setsHideInViews(e){this._setsHideInViews=e,this._hideInViews===null&&(this._hideInViews=[]),this._configUpdated()}}function Ex(r){const t=new Ue,e=new Ue;let i;const n=new L,s=new Fi;function a(){i=new L;const l=new li;r.visitSubtree(c=>{const h=c.mesh;h&&l.union(h.geometry.boundingBox)}),l.center(i),e.elements[12]=-i.x,e.elements[13]=-i.y,e.elements[14]=-i.z}return(l,c)=>(i||a(),r.animationMatrix,r.config.faceCamera?(n.copyFrom(c).sub(i).normalize(),s.setFromDirection(n),r.config.faceCamera==="yaw"&&(s.pitch=0),s.toRotationMatrix(t),r.animationMatrix.identity().setPosition(i).multiply(t).multiply(e),!1):(r.config.rotate,s.yaw=Zt(s.yaw+2*Math.PI*r.config.rotationSpeed*l),s.toRotationMatrix(t),r.animationMatrix.identity().setPosition(i).multiply(t).multiply(e),!0))}let Pm=class{constructor(t,e,i){o(this,"id");o(this,"parent");o(this,"config");o(this,"children",new Array);o(this,"mesh",null);o(this,"update",(t,e)=>!1);o(this,"initialLightProbeIds");o(this,"disableCollisions",null);o(this,"ground",null);o(this,"animationMatrix",null);o(this,"hideInViews",null);o(this,"lightmapResolution",null);o(this,"shadowsIsolatedWithin",null);o(this,"editable",!1);o(this,"editableRoot",null);o(this,"simplificationParams",null);o(this,"_facesCnt",null);o(this,"_originalFacesSubtreeCnt",null);o(this,"_originalFaceCnt");var n;this.id=i.id,this.initialLightProbeIds=(n=i.lightProbeIds)!=null?n:[],this.parent=t,this.config=e,this._originalFaceCnt=i.originalFaceCnt||0,this.hideInViews=null,this.lightmapResolution=null,e.addNode(this),this.configure()}configure(){if(this.config.setsDisableCollisions?this.disableCollisions=this.config.disableCollisions:this.parent?this.disableCollisions=this.parent.disableCollisions:this.disableCollisions=!1,this.ground=this.disableCollisions?!1:this.config.ground,this.isAnimatedRoot?(this.animationMatrix=new Ue,this.update=Ex(this)):this.parent?this.animationMatrix=this.parent.animationMatrix:this.animationMatrix=null,T.DEV_NEW_RENDER_ARCHITECTURE&&this.mesh){const t=this.mesh.entityId;this.animationMatrix?pt.get().updateEntityStateById(t,As,{matrix:this.animationMatrix}):pt.get().updateEntityStateById(t,As,void 0)}this.config.setsHideInViews?this.hideInViews=this.config.hideInViews:this.parent?this.hideInViews=this.parent.hideInViews:this.hideInViews=null,this.config.setsLightmapResolution?this.lightmapResolution=this.config.lightmapResolution:this.parent?this.lightmapResolution=this.parent.lightmapResolution:this.lightmapResolution=null,this.config.setsSimplificationParams?this.simplificationParams=this.config.simplificationParams:this.parent?this.simplificationParams=this.parent.simplificationParams:this.simplificationParams=null,this.config.isolateShadows?this.shadowsIsolatedWithin=this.config.name:this.parent&&this.parent.shadowsIsolatedWithin?this.shadowsIsolatedWithin=this.parent.shadowsIsolatedWithin:this.shadowsIsolatedWithin=null,this.editable=this.config.editable,this.editable?this.editableRoot=this:this.parent?this.editableRoot=this.parent.editableRoot:this.editableRoot=null}visitSubtree(t){var e;t(this),(e=this.children)==null||e.forEach(i=>i.visitSubtree(t))}facesInSubtree(){return this._facesCnt===null&&(this._facesCnt=0,this.visitSubtree(t=>{this._facesCnt,t.mesh&&(this._facesCnt+=t.mesh.geometry.vertexCnt/3)})),this._facesCnt}originalFacesInSubtree(){return this._originalFacesSubtreeCnt===null&&(this._originalFacesSubtreeCnt=0,this.visitSubtree(t=>{this._originalFacesSubtreeCnt,t.mesh&&(this._originalFacesSubtreeCnt+=t._originalFaceCnt)})),this._originalFacesSubtreeCnt}hide(){this.visitSubtree(t=>{t.mesh&&(t.mesh.visible=!1)})}show(){this.visitSubtree(t=>{t.mesh&&(t.mesh.visible=!0)})}get isAnimatedRoot(){return!!(this.config.faceCamera||this.config.rotate)}serialize(){const t={id:this.id,children:this.children.map(e=>e.serialize())};return this.mesh&&(t.lightProbeIds=this.mesh.lightProbes.map(e=>e.id),t.mesh=!0),t}get type(){return this.config.name}set highlightMix(t){this.visitSubtree(e=>{e.mesh&&(e.mesh.highlightMix=t)})}set selected(t){this.visitSubtree(e=>{e.mesh&&(e.mesh.selected=t)})}set selectedSecondary(t){this.visitSubtree(e=>{e.mesh&&(e.mesh.selectedSecondary=t)})}};function nu(r,t){let e;return r===hs.UNIVERSAL?e=new ym:r===hs.GRASS?e=new al:r===hs.WATER?e=new fx:e=T.DEV_MATERIALX?new ym:new Qt,e.source=t,e}class Ax{constructor(t,e,i,n,s,a){o(this,"materials",new Array);o(this,"_animatableAuxiliaryObjects");o(this,"_materialIdToMergedMaterial",new Map);o(this,"_lastGeneratedMaterialId",-1);o(this,"_materialIdToPreviousTypes",new Map);o(this,"_materialToOverriddenNodeConfigs",new Map);o(this,"_gpuMeshes");o(this,"_sharedMaterialState");o(this,"_lightProbesDisabled");o(this,"_onSceneUpdated");o(this,"_onLiveLightmapUpdateNeeded");o(this,"_materialUpdated",()=>{this._onSceneUpdated()});this._gpuMeshes=t,this._sharedMaterialState=e,this._lightProbesDisabled=i,this._animatableAuxiliaryObjects=n,this._onSceneUpdated=s,this._onLiveLightmapUpdateNeeded=a}_generateNewMaterialId(){for(this._lastGeneratedMaterialId++;this._materialIdToMergedMaterial.has(this._lastGeneratedMaterialId);)this._lastGeneratedMaterialId++;return this._lastGeneratedMaterialId}getMaterial(t){return this._materialIdToMergedMaterial.get(t)}getOverriddenConfigs(t){const e=this._materialToOverriddenNodeConfigs.get(t);return e?[...e]:[]}addMergedMaterial(t,e,i){T.EDIT_MODE,t.id,t.id=e,i.id!==void 0&&this._materialIdToMergedMaterial.has(i.id),t.id!==void 0&&this._materialIdToMergedMaterial.has(t.id),this._materialIdToMergedMaterial.set(t.id,i)}addMaterial(t,e){t.source,_r.WEBWALK,t.id,`${t.id}`,t.id=e!=null?e:this._generateNewMaterialId(),this._materialIdToMergedMaterial.has(t.id),`${t.id}`,this.materials.push(t),this._materialIdToMergedMaterial.set(t.id,t),this._hookMaterialToScene(t)}removeMaterial(t){T.EDIT_MODE,t.id,this._materialIdToMergedMaterial.has(t.id),`${t.id}`,t.source,_r.SCENE,this._removeMaterialOverride(t),Qi(t,this.materials),this._materialIdToMergedMaterial.delete(t.id),this._unhookMaterialFromScene(t),t.resetIdFromSceneMaterialManager(),this._removeMaterialOverride(t),this._onSceneUpdated()}removeMaterialOverrideForNodeType(t){var n;if(T.EDIT_MODE,t.overriddenMaterialId===void 0)return;const e=this.getMaterial(t.overriddenMaterialId);(n=this._materialToOverriddenNodeConfigs.get(e))==null||n.delete(t);let i=this.getMaterial(t.overriddenMaterialId).emissiveEnabled;t.overriddenMaterialId=void 0;for(const s of t.nodes){const a=s.mesh;a&&(a.material=this.getMaterial(a.originalMaterialId),a.material.emissiveEnabled&&(i=!0))}i&&this._onLiveLightmapUpdateNeeded(),this._onSceneUpdated()}initializeMaterialOverrides(t){for(const e of t){if(e.overriddenMaterialId===void 0)continue;const i=this.getMaterial(e.overriddenMaterialId);this.overrideMaterialForNodeType(e,i,!0)}}overrideMaterialForNodeType(t,e,i=!1){T.EDIT_MODE,e.id,t.overriddenMaterialId=e.id;let n=e.emissiveEnabled;this._materialToOverriddenNodeConfigs.has(e)||this._materialToOverriddenNodeConfigs.set(e,new Set),this._materialToOverriddenNodeConfigs.get(e).add(t);for(const s of t.nodes){const a=s.mesh;a&&(a.material.emissiveEnabled&&(n=!0),a.material=e)}i||(n&&this._onLiveLightmapUpdateNeeded(),e.setUniforms(),this._onSceneUpdated())}_removeMaterialOverride(t){for(const e of this.getOverriddenConfigs(t))this.removeMaterialOverrideForNodeType(e);this._materialToOverriddenNodeConfigs.delete(t)}_hookMaterialToScene(t){t.id,this._materialIdToPreviousTypes.has(t.id)||this._materialIdToPreviousTypes.set(t.id,new Map),this._materialIdToPreviousTypes.get(t.id).set(t.type,t),t.addEventListener(bt.eventType.MATERIAL_UPDATED,this._materialUpdated),t.addEventListener(Qt.eventType.MAJOR_LIGHTING_PROPERTY_UPDATED,this._onLiveLightmapUpdateNeeded),t.sharedMaterialState=this._sharedMaterialState,t.disableLightProbe=this._lightProbesDisabled()}_unhookMaterialFromScene(t){t.id,this._materialIdToPreviousTypes.has(t.id)&&this._materialIdToPreviousTypes.delete(t.id),t.removeEventListener(bt.eventType.MATERIAL_UPDATED,this._materialUpdated),t.removeEventListener(Qt.eventType.MAJOR_LIGHTING_PROPERTY_UPDATED,this._onLiveLightmapUpdateNeeded),t.sharedMaterialState=null}_replaceMaterial(t,e){const i=this.materials.findIndex(n=>n===t);t.id,this.materials[i]=e,this._materialIdToMergedMaterial.set(t.id,e),this._onSceneUpdated();for(let n=0;n<this._gpuMeshes.length;n+=1)this._gpuMeshes[n].material===t&&(this._gpuMeshes[n].material=e);return e.setUniforms(),e}changeMaterialType(t,e){T.EDIT_MODE,t.id;const i=this._materialIdToPreviousTypes.get(t.id);if(!i.has(e)){const s=nu(e,t.source);s.name=t.name,s.id=t.id,i.set(e,s)}const n=i.get(e);return this._hookMaterialToScene(n),this._replaceMaterial(t,n),n}getAnimatedMaterials(){const t=new Set;for(const i of this._animatableAuxiliaryObjects)i.traverse(n=>{if(n instanceof je){const s=n.material;s.isAnimated&&t.add(s)}});const e=this.materials.filter(i=>i.isAnimated);return[...t,...e]}serialize(){return T.EDIT_MODE,this.materials.map(t=>t.serialize())}}var qs=function(){var r="b9H79Tebbbe8Fv9Gbb9Gvuuuuueu9Giuuub9Geueu9Giuuueuikqbeeedddillviebeoweuec:q;iekr;leDo9TW9T9VV95dbH9F9F939H79T9F9J9H229F9Jt9VV7bb8A9TW79O9V9Wt9F9KW9J9V9KW9wWVtW949c919M9MWVbeY9TW79O9V9Wt9F9KW9J9V9KW69U9KW949c919M9MWVbdE9TW79O9V9Wt9F9KW9J9V9KW69U9KW949tWG91W9U9JWbiL9TW79O9V9Wt9F9KW9J9V9KWS9P2tWV9p9JtblK9TW79O9V9Wt9F9KW9J9V9KWS9P2tWV9r919HtbvL9TW79O9V9Wt9F9KW9J9V9KWS9P2tWVT949Wbol79IV9Rbrq;d8Yqdbk:yzeHu8Jjjjjbcj;eb9Rgv8Kjjjjbc9:hodnadcefal0mbcuhoaiRbbc:Ge9hmbavaialfgrad9Radz1jjjbhwcj;abad9UhlaicefhodnadTmbalc;WFbGglcjdalcjd6EhDcbhqinaqae9pmeaDaeaq9RaqaDfae6Egkcsfglcl4cifcd4hxdndndndnalc9WGgmTmbcbhPcehsawcjdfhzaohHinaraH9Rax6midnaraHaxfgo9RcK6mbczhlcbhOinalgic9WfgAawcj;cbffhldndndndndnaHaAco4fRbbaOcoG4ciGPlbedibkal9cb83ibalcwf9cb83ibxikalaoRblaoRbbgAco4gCaCciSgCE86bbawcj;cbfaifglcGfaoclfaCfgCRbbaAcl4ciGgXaXciSgXE86bbalcVfaCaXfgCRbbaAcd4ciGgXaXciSgXE86bbalc7faCaXfgCRbbaAciGgAaAciSgAE86bbalctfaCaAfgCRbbaoRbegAco4gXaXciSgXE86bbalc91faCaXfgCRbbaAcl4ciGgXaXciSgXE86bbalc4faCaXfgCRbbaAcd4ciGgXaXciSgXE86bbalc93faCaXfgCRbbaAciGgAaAciSgAE86bbalc94faCaAfgCRbbaoRbdgAco4gXaXciSgXE86bbalc95faCaXfgCRbbaAcl4ciGgXaXciSgXE86bbalc96faCaXfgCRbbaAcd4ciGgXaXciSgXE86bbalc97faCaXfgCRbbaAciGgAaAciSgAE86bbalc98faCaAfgARbbaoRbigoco4gCaCciSgCE86bbalc99faAaCfgARbbaocl4ciGgCaCciSgCE86bbalc9:faAaCfgARbbaocd4ciGgCaCciSgCE86bbalcufaAaCfglRbbaociGgoaociSgoE86bbalaofhoxdkalaoRbwaoRbbgAcl4gCaCcsSgCE86bbawcj;cbfaifglcGfaocwfaCfgCRbbaAcsGgAaAcsSgAE86bbalcVfaCaAfgARbbaoRbegCcl4gXaXcsSgXE86bbalc7faAaXfgARbbaCcsGgCaCcsSgCE86bbalctfaAaCfgARbbaoRbdgCcl4gXaXcsSgXE86bbalc91faAaXfgARbbaCcsGgCaCcsSgCE86bbalc4faAaCfgARbbaoRbigCcl4gXaXcsSgXE86bbalc93faAaXfgARbbaCcsGgCaCcsSgCE86bbalc94faAaCfgARbbaoRblgCcl4gXaXcsSgXE86bbalc95faAaXfgARbbaCcsGgCaCcsSgCE86bbalc96faAaCfgARbbaoRbvgCcl4gXaXcsSgXE86bbalc97faAaXfgARbbaCcsGgCaCcsSgCE86bbalc98faAaCfgARbbaoRbogCcl4gXaXcsSgXE86bbalc99faAaXfgARbbaCcsGgCaCcsSgCE86bbalc9:faAaCfgARbbaoRbrgocl4gCaCcsSgCE86bbalcufaAaCfglRbbaocsGgoaocsSgoE86bbalaofhoxekalao8Pbb83bbalcwfaocwf8Pbb83bbaoczfhokdnaiam9pmbaOcdfhOaiczfhlarao9RcL0mekkaiam6miaoTmidnakTmbawaPfRbbhOawcj;cbfhlazhiakhAinaialRbbgHce4cbaHceG9R7aOfgO86bbaiadfhialcefhlaAcufgAmbkkazcefhzaPcefgPad6hsaohHaPad9hmexvkkcbhoasceGmdxikaoaxad2fhXdnakTmbcbhmcehsawcjdfhCinarao9Rax6miaoTmdaoaxfhoawamfRbbhOawcj;cbfhlaChiakhAinaialRbbgHce4cbaHceG9R7aOfgO86bbaiadfhialcefhlaAcufgAmbkaCcefhCamcefgmad6hsamad9hmbkaXhoxikcbhlcehsinarao9Rax6mdaoTmeaoaxfhoalcefglad6hsadal9hmbkaXhoxdkcbhoasceGTmekc9:hoxikabaqad2fawcjdfakad2z1jjjb8Aawawcjdfakcufad2fadz1jjjb8Aakaqfhqaombkc9:hoxekcbc99arao9Radcaadca0ESEhokavcj;ebf8Kjjjjbaok;xzeHu8Jjjjjbc;ae9Rgv8Kjjjjbc9:hodnaeci9UgrcHfal0mbcuhoaiRbbgwc;WeGc;Ge9hmbawcsGgDce0mbavc;abfcFecjez:jjjjb8AavcUf9cu83ibavc8Wf9cu83ibavcyf9cu83ibavcaf9cu83ibavcKf9cu83ibavczf9cu83ibav9cu83iwav9cu83ibaialfc9WfhqaicefgwarfhodnaeTmbcmcsaDceSEhkcbhxcbhmcbhrcbhicbhlindnaoaq9nmbc9:hoxikdndnawRbbgDc;Ve0mbavc;abfalaDcu7gPcl4fcsGcitfgsydlhzasydbhHdnaDcsGgDak9pmbavaiaPfcsGcdtfydbaxaDEhsaDThDdndnadcd9hmbabarcetfgPaH87ebaPcdfaz87ebaPclfas87ebxekabarcdtfgPaHBdbaPclfazBdbaPcwfasBdbkaxaDfhxavc;abfalcitfgPasBdbaPazBdlavaicdtfasBdbavc;abfalcefcsGglcitfgPaHBdbaPasBdlaiaDfhialcefhlxdkdndnaDcsSmbamaDfaDc987fcefhmxekaocefhDao8SbbgscFeGhPdndnascu9mmbaDhoxekaocvfhoaPcFbGhPcrhsdninaD8SbbgOcFbGastaPVhPaOcu9kmeaDcefhDascrfgsc8J9hmbxdkkaDcefhokaPce4cbaPceG9R7amfhmkdndnadcd9hmbabarcetfgDaH87ebaDcdfaz87ebaDclfam87ebxekabarcdtfgDaHBdbaDclfazBdbaDcwfamBdbkavc;abfalcitfgDamBdbaDazBdlavaicdtfamBdbavc;abfalcefcsGglcitfgDaHBdbaDamBdlaicefhialcefhlxekdnaDcpe0mbaxcefgOavaiaqaDcsGfRbbgscl49RcsGcdtfydbascz6gPEhDavaias9RcsGcdtfydbaOaPfgzascsGgOEhsaOThOdndnadcd9hmbabarcetfgHax87ebaHcdfaD87ebaHclfas87ebxekabarcdtfgHaxBdbaHclfaDBdbaHcwfasBdbkavaicdtfaxBdbavc;abfalcitfgHaDBdbaHaxBdlavaicefgicsGcdtfaDBdbavc;abfalcefcsGcitfgHasBdbaHaDBdlavaiaPfcsGgicdtfasBdbavc;abfalcdfcsGglcitfgDaxBdbaDasBdlalcefhlaiaOfhiazaOfhxxekaxcbaoRbbgHEgAaDc;:eSgDfhzaHcsGhCaHcl4hXdndnaHcs0mbazcefhOxekazhOavaiaX9RcsGcdtfydbhzkdndnaCmbaOcefhxxekaOhxavaiaH9RcsGcdtfydbhOkdndnaDTmbaocefhDxekaocdfhDao8SbegPcFeGhsdnaPcu9kmbaocofhAascFbGhscrhodninaD8SbbgPcFbGaotasVhsaPcu9kmeaDcefhDaocrfgoc8J9hmbkaAhDxekaDcefhDkasce4cbasceG9R7amfgmhAkdndnaXcsSmbaDhsxekaDcefhsaD8SbbgocFeGhPdnaocu9kmbaDcvfhzaPcFbGhPcrhodninas8SbbgDcFbGaotaPVhPaDcu9kmeascefhsaocrfgoc8J9hmbkazhsxekascefhskaPce4cbaPceG9R7amfgmhzkdndnaCcsSmbashoxekascefhoas8SbbgDcFeGhPdnaDcu9kmbascvfhOaPcFbGhPcrhDdninao8SbbgscFbGaDtaPVhPascu9kmeaocefhoaDcrfgDc8J9hmbkaOhoxekaocefhokaPce4cbaPceG9R7amfgmhOkdndnadcd9hmbabarcetfgDaA87ebaDcdfaz87ebaDclfaO87ebxekabarcdtfgDaABdbaDclfazBdbaDcwfaOBdbkavc;abfalcitfgDazBdbaDaABdlavaicdtfaABdbavc;abfalcefcsGcitfgDaOBdbaDazBdlavaicefgicsGcdtfazBdbavc;abfalcdfcsGcitfgDaABdbaDaOBdlavaiaHcz6aXcsSVfgicsGcdtfaOBdbaiaCTaCcsSVfhialcifhlkawcefhwalcsGhlaicsGhiarcifgrae6mbkkcbc99aoaqSEhokavc;aef8Kjjjjbaok:flevu8Jjjjjbcz9Rhvc9:hodnaecvfal0mbcuhoaiRbbc;:eGc;qe9hmbav9cb83iwaicefhraialfc98fhwdnaeTmbdnadcdSmbcbhDindnaraw6mbc9:skarcefhoar8SbbglcFeGhidndnalcu9mmbaohrxekarcvfhraicFbGhicrhldninao8SbbgdcFbGaltaiVhiadcu9kmeaocefhoalcrfglc8J9hmbxdkkaocefhrkabaDcdtfaic8Etc8F91aicd47avcwfaiceGcdtVgoydbfglBdbaoalBdbaDcefgDae9hmbxdkkcbhDindnaraw6mbc9:skarcefhoar8SbbglcFeGhidndnalcu9mmbaohrxekarcvfhraicFbGhicrhldninao8SbbgdcFbGaltaiVhiadcu9kmeaocefhoalcrfglc8J9hmbxdkkaocefhrkabaDcetfaic8Etc8F91aicd47avcwfaiceGcdtVgoydbfgl87ebaoalBdbaDcefgDae9hmbkkcbc99arawSEhokaok:Lvoeue99dud99eud99dndnadcl9hmbaeTmeindndnabcdfgd8Sbb:Yab8Sbbgi:Ygl:l:tabcefgv8Sbbgo:Ygr:l:tgwJbb;:9cawawNJbbbbawawJbbbb9GgDEgq:mgkaqaicb9iEalMgwawNakaqaocb9iEarMgqaqNMM:r:vglNJbbbZJbbb:;aDEMgr:lJbbb9p9DTmbar:Ohixekcjjjj94hikadai86bbdndnaqalNJbbbZJbbb:;aqJbbbb9GEMgq:lJbbb9p9DTmbaq:Ohdxekcjjjj94hdkavad86bbdndnawalNJbbbZJbbb:;awJbbbb9GEMgw:lJbbb9p9DTmbaw:Ohdxekcjjjj94hdkabad86bbabclfhbaecufgembxdkkaeTmbindndnabclfgd8Ueb:Yab8Uebgi:Ygl:l:tabcdfgv8Uebgo:Ygr:l:tgwJb;:FSawawNJbbbbawawJbbbb9GgDEgq:mgkaqaicb9iEalMgwawNakaqaocb9iEarMgqaqNMM:r:vglNJbbbZJbbb:;aDEMgr:lJbbb9p9DTmbar:Ohixekcjjjj94hikadai87ebdndnaqalNJbbbZJbbb:;aqJbbbb9GEMgq:lJbbb9p9DTmbaq:Ohdxekcjjjj94hdkavad87ebdndnawalNJbbbZJbbb:;awJbbbb9GEMgw:lJbbb9p9DTmbaw:Ohdxekcjjjj94hdkabad87ebabcwfhbaecufgembkkk;siliui99iue99dnaeTmbcbhiabhlindndnJ;Zl81Zalcof8UebgvciV:Y:vgoal8Ueb:YNgrJb;:FSNJbbbZJbbb:;arJbbbb9GEMgw:lJbbb9p9DTmbaw:OhDxekcjjjj94hDkalclf8Uebhqalcdf8UebhkabaiavcefciGfcetfaD87ebdndnaoak:YNgwJb;:FSNJbbbZJbbb:;awJbbbb9GEMgx:lJbbb9p9DTmbax:Ohkxekcjjjj94hkkabaiavcdfciGfcetfak87ebdndnaoaq:YNgoJb;:FSNJbbbZJbbb:;aoJbbbb9GEMgx:lJbbb9p9DTmbax:Ohqxekcjjjj94hqkabaiavcufciGfcetfaq87ebdndnJbbjZararN:tawawN:taoaoN:tgrJbbbbarJbbbb9GE:rJb;:FSNJbbbZMgr:lJbbb9p9DTmbar:Ohqxekcjjjj94hqkabaiavciGfcetfaq87ebalcwfhlaiclfhiaecufgembkkk9mbdnadcd4ae2gdTmbinababydbgecwtcw91:Yaece91cjjj98Gcjjj;8if::NUdbabclfhbadcufgdmbkkk9teiucbcbydj1jjbgeabcifc98GfgbBdj1jjbdndnabZbcztgd9nmbcuhiabad9RcFFifcz4nbcuSmekaehikaik;LeeeudndnaeabVciGTmbabhixekdndnadcz9pmbabhixekabhiinaiaeydbBdbaiclfaeclfydbBdbaicwfaecwfydbBdbaicxfaecxfydbBdbaeczfheaiczfhiadc9Wfgdcs0mbkkadcl6mbinaiaeydbBdbaeclfheaiclfhiadc98fgdci0mbkkdnadTmbinaiaeRbb86bbaicefhiaecefheadcufgdmbkkabk;aeedudndnabciGTmbabhixekaecFeGc:b:c:ew2hldndnadcz9pmbabhixekabhiinaialBdbaicxfalBdbaicwfalBdbaiclfalBdbaiczfhiadc9Wfgdcs0mbkkadcl6mbinaialBdbaiclfhiadc98fgdci0mbkkdnadTmbinaiae86bbaicefhiadcufgdmbkkabkkkebcjwklz9Kbb",t="b9H79TebbbeKl9Gbb9Gvuuuuueu9Giuuub9Geueuikqbbebeedddilve9Weeeviebeoweuec:q;Aekr;leDo9TW9T9VV95dbH9F9F939H79T9F9J9H229F9Jt9VV7bb8A9TW79O9V9Wt9F9KW9J9V9KW9wWVtW949c919M9MWVbdY9TW79O9V9Wt9F9KW9J9V9KW69U9KW949c919M9MWVblE9TW79O9V9Wt9F9KW9J9V9KW69U9KW949tWG91W9U9JWbvL9TW79O9V9Wt9F9KW9J9V9KWS9P2tWV9p9JtboK9TW79O9V9Wt9F9KW9J9V9KWS9P2tWV9r919HtbrL9TW79O9V9Wt9F9KW9J9V9KWS9P2tWVT949Wbwl79IV9RbDq;b9tqlbzik9:evu8Jjjjjbcz9Rhbcbheincbhdcbhiinabcwfadfaicjuaead4ceGglE86bbaialfhiadcefgdcw9hmbkaec:q:yjjbfai86bbaecitc:q1jjbfab8Piw83ibaecefgecjd9hmbkk;e8JlHud97euo978Jjjjjbcj;kb9Rgv8Kjjjjbc9:hodnadcefal0mbcuhoaiRbbc:Ge9hmbavaialfgrad9Rad;8qbbcj;abad9UhoaicefhldnadTmbaoc;WFbGgocjdaocjd6EhwcbhDinaDae9pmeawaeaD9RaDawfae6Egqcsfgoc9WGgkci2hxakcethmaocl4cifcd4hPabaDad2fhscbhzdnincbhHalhOcbhAdninaraO9RaP6miavcj;cbfaAak2fhCaOaPfhlcbhidnakc;ab6mbaral9Rc;Gb6mbcbhoinaCaofhidndndndndnaOaoco4fRbbgXciGPlbedibkaipxbbbbbbbbbbbbbbbbpklbxikaialpbblalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklbalclfaYpQbfaKc:q:yjjbfRbbfhlxdkaialpbbwalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklbalcwfaYpQbfaKc:q:yjjbfRbbfhlxekaialpbbbpklbalczfhlkdndndndndnaXcd4ciGPlbedibkaipxbbbbbbbbbbbbbbbbpklzxikaialpbblalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklzalclfaYpQbfaKc:q:yjjbfRbbfhlxdkaialpbbwalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklzalcwfaYpQbfaKc:q:yjjbfRbbfhlxekaialpbbbpklzalczfhlkdndndndndnaXcl4ciGPlbedibkaipxbbbbbbbbbbbbbbbbpklaxikaialpbblalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklaalclfaYpQbfaKc:q:yjjbfRbbfhlxdkaialpbbwalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklaalcwfaYpQbfaKc:q:yjjbfRbbfhlxekaialpbbbpklaalczfhlkdndndndndnaXco4Plbedibkaipxbbbbbbbbbbbbbbbbpkl8WxikaialpbblalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgXcitc:q1jjbfpbibaXc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgXcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spkl8WalclfaYpQbfaXc:q:yjjbfRbbfhlxdkaialpbbwalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgXcitc:q1jjbfpbibaXc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgXcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spkl8WalcwfaYpQbfaXc:q:yjjbfRbbfhlxekaialpbbbpkl8Walczfhlkaoc;abfhiaocjefak0meaihoaral9Rc;Fb0mbkkdndnaiak9pmbaici4hoinaral9RcK6mdaCaifhXdndndndndnaOaico4fRbbaocoG4ciGPlbedibkaXpxbbbbbbbbbbbbbbbbpklbxikaXalpbblalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklbalclfaYpQbfaKc:q:yjjbfRbbfhlxdkaXalpbbwalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklbalcwfaYpQbfaKc:q:yjjbfRbbfhlxekaXalpbbbpklbalczfhlkaocdfhoaiczfgiak6mbkkalTmbaAcd0hHalhOaAcefgAclSmdxekkcbhlaHceGTmdkdnakTmbavcjdfazfhiavazfpbdbhYcbhXinaiavcj;cbfaXfgopblbgLcep9TaLpxeeeeeeeeeeeeeeeegQp9op9Hp9rgLaoakfpblbg8Acep9Ta8AaQp9op9Hp9rg8ApmbzeHdOiAlCvXoQrLgEaoamfpblbg3cep9Ta3aQp9op9Hp9rg3aoaxfpblbg5cep9Ta5aQp9op9Hp9rg5pmbzeHdOiAlCvXoQrLg8EpmbezHdiOAlvCXorQLgQaQpmbedibedibedibediaYp9UgYp9AdbbaiadfgoaYaQaQpmlvorlvorlvorlvorp9UgYp9AdbbaoadfgoaYaQaQpmwDqkwDqkwDqkwDqkp9UgYp9AdbbaoadfgoaYaQaQpmxmPsxmPsxmPsxmPsp9UgYp9AdbbaoadfgoaYaEa8EpmwDKYqk8AExm35Ps8E8FgQaQpmbedibedibedibedip9UgYp9AdbbaoadfgoaYaQaQpmlvorlvorlvorlvorp9UgYp9AdbbaoadfgoaYaQaQpmwDqkwDqkwDqkwDqkp9UgYp9AdbbaoadfgoaYaQaQpmxmPsxmPsxmPsxmPsp9UgYp9AdbbaoadfgoaYaLa8ApmwKDYq8AkEx3m5P8Es8FgLa3a5pmwKDYq8AkEx3m5P8Es8Fg8ApmbezHdiOAlvCXorQLgQaQpmbedibedibedibedip9UgYp9AdbbaoadfgoaYaQaQpmlvorlvorlvorlvorp9UgYp9AdbbaoadfgoaYaQaQpmwDqkwDqkwDqkwDqkp9UgYp9AdbbaoadfgoaYaQaQpmxmPsxmPsxmPsxmPsp9UgYp9AdbbaoadfgoaYaLa8ApmwDKYqk8AExm35Ps8E8FgQaQpmbedibedibedibedip9UgYp9AdbbaoadfgoaYaQaQpmlvorlvorlvorlvorp9UgYp9AdbbaoadfgoaYaQaQpmwDqkwDqkwDqkwDqkp9UgYp9AdbbaoadfgoaYaQaQpmxmPsxmPsxmPsxmPsp9UgYp9AdbbaoadfhiaXczfgXak6mbkkazclfgzad6mbkasavcjdfaqad2;8qbbavavcjdfaqcufad2fad;8qbbaqaDfhDc9:hoalmexikkc9:hoxekcbc99aral9Radcaadca0ESEhokavcj;kbf8Kjjjjbaokwbz:bjjjbk;tzeHu8Jjjjjbc;ae9Rgv8Kjjjjbc9:hodnaeci9UgrcHfal0mbcuhoaiRbbgwc;WeGc;Ge9hmbawcsGgDce0mbavc;abfcFecje;8kbavcUf9cu83ibavc8Wf9cu83ibavcyf9cu83ibavcaf9cu83ibavcKf9cu83ibavczf9cu83ibav9cu83iwav9cu83ibaialfc9WfhqaicefgwarfhodnaeTmbcmcsaDceSEhkcbhxcbhmcbhrcbhicbhlindnaoaq9nmbc9:hoxikdndnawRbbgDc;Ve0mbavc;abfalaDcu7gPcl4fcsGcitfgsydlhzasydbhHdnaDcsGgDak9pmbavaiaPfcsGcdtfydbaxaDEhsaDThDdndnadcd9hmbabarcetfgPaH87ebaPcdfaz87ebaPclfas87ebxekabarcdtfgPaHBdbaPclfazBdbaPcwfasBdbkaxaDfhxavc;abfalcitfgPasBdbaPazBdlavaicdtfasBdbavc;abfalcefcsGglcitfgPaHBdbaPasBdlaiaDfhialcefhlxdkdndnaDcsSmbamaDfaDc987fcefhmxekaocefhDao8SbbgscFeGhPdndnascu9mmbaDhoxekaocvfhoaPcFbGhPcrhsdninaD8SbbgOcFbGastaPVhPaOcu9kmeaDcefhDascrfgsc8J9hmbxdkkaDcefhokaPce4cbaPceG9R7amfhmkdndnadcd9hmbabarcetfgDaH87ebaDcdfaz87ebaDclfam87ebxekabarcdtfgDaHBdbaDclfazBdbaDcwfamBdbkavc;abfalcitfgDamBdbaDazBdlavaicdtfamBdbavc;abfalcefcsGglcitfgDaHBdbaDamBdlaicefhialcefhlxekdnaDcpe0mbaxcefgOavaiaqaDcsGfRbbgscl49RcsGcdtfydbascz6gPEhDavaias9RcsGcdtfydbaOaPfgzascsGgOEhsaOThOdndnadcd9hmbabarcetfgHax87ebaHcdfaD87ebaHclfas87ebxekabarcdtfgHaxBdbaHclfaDBdbaHcwfasBdbkavaicdtfaxBdbavc;abfalcitfgHaDBdbaHaxBdlavaicefgicsGcdtfaDBdbavc;abfalcefcsGcitfgHasBdbaHaDBdlavaiaPfcsGgicdtfasBdbavc;abfalcdfcsGglcitfgDaxBdbaDasBdlalcefhlaiaOfhiazaOfhxxekaxcbaoRbbgHEgAaDc;:eSgDfhzaHcsGhCaHcl4hXdndnaHcs0mbazcefhOxekazhOavaiaX9RcsGcdtfydbhzkdndnaCmbaOcefhxxekaOhxavaiaH9RcsGcdtfydbhOkdndnaDTmbaocefhDxekaocdfhDao8SbegPcFeGhsdnaPcu9kmbaocofhAascFbGhscrhodninaD8SbbgPcFbGaotasVhsaPcu9kmeaDcefhDaocrfgoc8J9hmbkaAhDxekaDcefhDkasce4cbasceG9R7amfgmhAkdndnaXcsSmbaDhsxekaDcefhsaD8SbbgocFeGhPdnaocu9kmbaDcvfhzaPcFbGhPcrhodninas8SbbgDcFbGaotaPVhPaDcu9kmeascefhsaocrfgoc8J9hmbkazhsxekascefhskaPce4cbaPceG9R7amfgmhzkdndnaCcsSmbashoxekascefhoas8SbbgDcFeGhPdnaDcu9kmbascvfhOaPcFbGhPcrhDdninao8SbbgscFbGaDtaPVhPascu9kmeaocefhoaDcrfgDc8J9hmbkaOhoxekaocefhokaPce4cbaPceG9R7amfgmhOkdndnadcd9hmbabarcetfgDaA87ebaDcdfaz87ebaDclfaO87ebxekabarcdtfgDaABdbaDclfazBdbaDcwfaOBdbkavc;abfalcitfgDazBdbaDaABdlavaicdtfaABdbavc;abfalcefcsGcitfgDaOBdbaDazBdlavaicefgicsGcdtfazBdbavc;abfalcdfcsGcitfgDaABdbaDaOBdlavaiaHcz6aXcsSVfgicsGcdtfaOBdbaiaCTaCcsSVfhialcifhlkawcefhwalcsGhlaicsGhiarcifgrae6mbkkcbc99aoaqSEhokavc;aef8Kjjjjbaok:flevu8Jjjjjbcz9Rhvc9:hodnaecvfal0mbcuhoaiRbbc;:eGc;qe9hmbav9cb83iwaicefhraialfc98fhwdnaeTmbdnadcdSmbcbhDindnaraw6mbc9:skarcefhoar8SbbglcFeGhidndnalcu9mmbaohrxekarcvfhraicFbGhicrhldninao8SbbgdcFbGaltaiVhiadcu9kmeaocefhoalcrfglc8J9hmbxdkkaocefhrkabaDcdtfaic8Etc8F91aicd47avcwfaiceGcdtVgoydbfglBdbaoalBdbaDcefgDae9hmbxdkkcbhDindnaraw6mbc9:skarcefhoar8SbbglcFeGhidndnalcu9mmbaohrxekarcvfhraicFbGhicrhldninao8SbbgdcFbGaltaiVhiadcu9kmeaocefhoalcrfglc8J9hmbxdkkaocefhrkabaDcetfaic8Etc8F91aicd47avcwfaiceGcdtVgoydbfgl87ebaoalBdbaDcefgDae9hmbkkcbc99arawSEhokaok:wPliuo97eue978Jjjjjbca9Rhiaec98Ghldndnadcl9hmbdnalTmbcbhvabhdinadadpbbbgocKp:RecKp:Sep;6egraocwp:RecKp:Sep;6earp;Geaoczp:RecKp:Sep;6egwp;Gep;Kep;LegDpxbbbbbbbbbbbbbbbbp:2egqarpxbbbjbbbjbbbjbbbjgkp9op9rp;Kegrpxbb;:9cbb;:9cbb;:9cbb;:9cararp;MeaDaDp;Meawaqawakp9op9rp;Kegrarp;Mep;Kep;Kep;Jep;Negwp;Mepxbbn0bbn0bbn0bbn0gqp;KepxFbbbFbbbFbbbFbbbp9oaopxbbbFbbbFbbbFbbbFp9op9qarawp;Meaqp;Kecwp:RepxbFbbbFbbbFbbbFbbp9op9qaDawp;Meaqp;Keczp:RepxbbFbbbFbbbFbbbFbp9op9qpkbbadczfhdavclfgval6mbkkalae9pmeaipxbbbbbbbbbbbbbbbbgqpklbaiabalcdtfgdaeciGglcdtgv;8qbbdnalTmbaiaipblbgocKp:RecKp:Sep;6egraocwp:RecKp:Sep;6earp;Geaoczp:RecKp:Sep;6egwp;Gep;Kep;LegDaqp:2egqarpxbbbjbbbjbbbjbbbjgkp9op9rp;Kegrpxbb;:9cbb;:9cbb;:9cbb;:9cararp;MeaDaDp;Meawaqawakp9op9rp;Kegrarp;Mep;Kep;Kep;Jep;Negwp;Mepxbbn0bbn0bbn0bbn0gqp;KepxFbbbFbbbFbbbFbbbp9oaopxbbbFbbbFbbbFbbbFp9op9qarawp;Meaqp;Kecwp:RepxbFbbbFbbbFbbbFbbp9op9qaDawp;Meaqp;Keczp:RepxbbFbbbFbbbFbbbFbp9op9qpklbkadaiav;8qbbskdnalTmbcbhvabhdinadczfgxaxpbbbgopxbbbbbbFFbbbbbbFFgkp9oadpbbbgDaopmlvorxmPsCXQL358E8FpxFubbFubbFubbFubbp9op;6eaDaopmbediwDqkzHOAKY8AEgoczp:Sep;6egrp;Geaoczp:Reczp:Sep;6egwp;Gep;Kep;Legopxb;:FSb;:FSb;:FSb;:FSawaopxbbbbbbbbbbbbbbbbp:2egqawpxbbbjbbbjbbbjbbbjgmp9op9rp;Kegwawp;Meaoaop;Mearaqaramp9op9rp;Kegoaop;Mep;Kep;Kep;Jep;Negrp;Mepxbbn0bbn0bbn0bbn0gqp;Keczp:Reawarp;Meaqp;KepxFFbbFFbbFFbbFFbbp9op9qgwaoarp;Meaqp;KepxFFbbFFbbFFbbFFbbp9ogopmwDKYqk8AExm35Ps8E8Fp9qpkbbadaDakp9oawaopmbezHdiOAlvCXorQLp9qpkbbadcafhdavclfgval6mbkkalae9pmbaiaeciGgvcitgdfcbcaad9R;8kbaiabalcitfglad;8qbbdnavTmbaiaipblzgopxbbbbbbFFbbbbbbFFgkp9oaipblbgDaopmlvorxmPsCXQL358E8FpxFubbFubbFubbFubbp9op;6eaDaopmbediwDqkzHOAKY8AEgoczp:Sep;6egrp;Geaoczp:Reczp:Sep;6egwp;Gep;Kep;Legopxb;:FSb;:FSb;:FSb;:FSawaopxbbbbbbbbbbbbbbbbp:2egqawpxbbbjbbbjbbbjbbbjgmp9op9rp;Kegwawp;Meaoaop;Mearaqaramp9op9rp;Kegoaop;Mep;Kep;Kep;Jep;Negrp;Mepxbbn0bbn0bbn0bbn0gqp;Keczp:Reawarp;Meaqp;KepxFFbbFFbbFFbbFFbbp9op9qgwaoarp;Meaqp;KepxFFbbFFbbFFbbFFbbp9ogopmwDKYqk8AExm35Ps8E8Fp9qpklzaiaDakp9oawaopmbezHdiOAlvCXorQLp9qpklbkalaiad;8qbbkk;4wllue97euv978Jjjjjbc8W9Rhidnaec98GglTmbcbhvabhoinaiaopbbbgraoczfgwpbbbgDpmlvorxmPsCXQL358E8Fgqczp:Segkclp:RepklbaopxbbjZbbjZbbjZbbjZpx;Zl81Z;Zl81Z;Zl81Z;Zl81Zakpxibbbibbbibbbibbbp9qp;6ep;NegkaraDpmbediwDqkzHOAKY8AEgrczp:Reczp:Sep;6ep;MegDaDp;Meakarczp:Sep;6ep;Megxaxp;Meakaqczp:Reczp:Sep;6ep;Megqaqp;Mep;Kep;Kep;Lepxbbbbbbbbbbbbbbbbp:4ep;Jepxb;:FSb;:FSb;:FSb;:FSgkp;Mepxbbn0bbn0bbn0bbn0grp;KepxFFbbFFbbFFbbFFbbgmp9oaxakp;Mearp;Keczp:Rep9qgxaqakp;Mearp;Keczp:ReaDakp;Mearp;Keamp9op9qgkpmbezHdiOAlvCXorQLgrp5baipblbpEb:T:j83ibaocwfarp5eaipblbpEe:T:j83ibawaxakpmwDKYqk8AExm35Ps8E8Fgkp5baipblbpEd:T:j83ibaocKfakp5eaipblbpEi:T:j83ibaocafhoavclfgval6mbkkdnalae9pmbaiaeciGgvcitgofcbcaao9R;8kbaiabalcitfgwao;8qbbdnavTmbaiaipblbgraipblzgDpmlvorxmPsCXQL358E8Fgqczp:Segkclp:RepklaaipxbbjZbbjZbbjZbbjZpx;Zl81Z;Zl81Z;Zl81Z;Zl81Zakpxibbbibbbibbbibbbp9qp;6ep;NegkaraDpmbediwDqkzHOAKY8AEgrczp:Reczp:Sep;6ep;MegDaDp;Meakarczp:Sep;6ep;Megxaxp;Meakaqczp:Reczp:Sep;6ep;Megqaqp;Mep;Kep;Kep;Lepxbbbbbbbbbbbbbbbbp:4ep;Jepxb;:FSb;:FSb;:FSb;:FSgkp;Mepxbbn0bbn0bbn0bbn0grp;KepxFFbbFFbbFFbbFFbbgmp9oaxakp;Mearp;Keczp:Rep9qgxaqakp;Mearp;Keczp:ReaDakp;Mearp;Keamp9op9qgkpmbezHdiOAlvCXorQLgrp5baipblapEb:T:j83ibaiarp5eaipblapEe:T:j83iwaiaxakpmwDKYqk8AExm35Ps8E8Fgkp5baipblapEd:T:j83izaiakp5eaipblapEi:T:j83iKkawaiao;8qbbkk:Pddiue978Jjjjjbc;ab9Rhidnadcd4ae2glc98GgvTmbcbheabhdinadadpbbbgocwp:Recwp:Sep;6eaocep:SepxbbjFbbjFbbjFbbjFp9opxbbjZbbjZbbjZbbjZp:Uep;Mepkbbadczfhdaeclfgeav6mbkkdnaval9pmbaialciGgecdtgdVcbc;abad9R;8kbaiabavcdtfgvad;8qbbdnaeTmbaiaipblbgocwp:Recwp:Sep;6eaocep:SepxbbjFbbjFbbjFbbjFp9opxbbjZbbjZbbjZbbjZp:Uep;Mepklbkavaiad;8qbbkk9teiucbcbydj1jjbgeabcifc98GfgbBdj1jjbdndnabZbcztgd9nmbcuhiabad9RcFFifcz4nbcuSmekaehikaikkkebcjwklz9Tbb",e=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]),i=new Uint8Array([32,0,65,2,1,106,34,33,3,128,11,4,13,64,6,253,10,7,15,116,127,5,8,12,40,16,19,54,20,9,27,255,113,17,42,67,24,23,146,148,18,14,22,45,70,69,56,114,101,21,25,63,75,136,108,28,118,29,73,115]);if(typeof WebAssembly!="object")return{supported:!1};var n=WebAssembly.validate(e)?t:r,s,a=WebAssembly.instantiate(l(n),{}).then(function(x){s=x.instance,s.exports.__wasm_call_ctors()});function l(x){for(var w=new Uint8Array(x.length),C=0;C<x.length;++C){var M=x.charCodeAt(C);w[C]=M>96?M-97:M>64?M-39:M+4}for(var D=0,C=0;C<x.length;++C)w[D++]=w[C]<60?i[w[C]]:(w[C]-60)*64+w[++C];return w.buffer.slice(0,D)}function c(x,w,C,M,D,W,z){var $=x.exports.sbrk,Z=M+3&-4,ne=$(Z*D),Me=$(W.length),Xe=new Uint8Array(x.exports.memory.buffer);Xe.set(W,Me);var xe=w(ne,M,D,Me,W.length);if(xe==0&&z&&z(ne,Z,D),C.set(Xe.subarray(ne,ne+M*D)),$(ne-$(0)),xe!=0)throw new Error("Malformed buffer data: "+xe)}var h={NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},d={ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"},u=[],f=0;function p(x){var w={object:new Worker(x),pending:0,requests:{}};return w.object.onmessage=function(C){var M=C.data;w.pending-=M.count,w.requests[M.id][M.action](M.value),delete w.requests[M.id]},w}function m(x){for(var w="self.ready = WebAssembly.instantiate(new Uint8Array(["+new Uint8Array(l(n))+"]), {}).then(function(result) { result.instance.exports.__wasm_call_ctors(); return result.instance; });self.onmessage = "+g.name+";"+c.toString()+g.toString(),C=new Blob([w],{type:"text/javascript"}),M=URL.createObjectURL(C),D=u.length;D<x;++D)u[D]=p(M);for(var D=x;D<u.length;++D)u[D].object.postMessage({});u.length=x,URL.revokeObjectURL(M)}function b(x,w,C,M,D){for(var W=u[0],z=1;z<u.length;++z)u[z].pending<W.pending&&(W=u[z]);return new Promise(function($,Z){var ne=new Uint8Array(C),Me=++f;W.pending+=x,W.requests[Me]={resolve:$,reject:Z},W.object.postMessage({id:Me,count:x,size:w,source:ne,mode:M,filter:D},[ne.buffer])})}function g(x){var w=x.data;if(!w.id)return self.close();self.ready.then(function(C){try{var M=new Uint8Array(w.count*w.size);c(C,C.exports[w.mode],M,w.count,w.size,w.source,C.exports[w.filter]),self.postMessage({id:w.id,count:w.count,action:"resolve",value:M},[M.buffer])}catch(D){self.postMessage({id:w.id,count:w.count,action:"reject",value:D})}})}return{ready:a,supported:!0,useWorkers:function(x){m(x)},decodeVertexBuffer:function(x,w,C,M,D){c(s,s.exports.meshopt_decodeVertexBuffer,x,w,C,M,s.exports[h[D]])},decodeIndexBuffer:function(x,w,C,M){c(s,s.exports.meshopt_decodeIndexBuffer,x,w,C,M)},decodeIndexSequence:function(x,w,C,M){c(s,s.exports.meshopt_decodeIndexSequence,x,w,C,M)},decodeGltfBuffer:function(x,w,C,M,D,W){c(s,s.exports[d[D]],x,w,C,M,s.exports[h[W]])},decodeGltfBufferAsync:function(x,w,C,M,D){return u.length>0?b(x,w,C,d[M],h[D]):a.then(function(){var W=new Uint8Array(x*w);return c(s,s.exports[d[M]],W,x,w,C,s.exports[h[D]]),W})}}}();typeof exports=="object"&&typeof module=="object"?module.exports=qs:typeof define=="function"&&define.amd?define([],function(){return qs}):typeof exports=="object"?exports.MeshoptDecoder=qs:(typeof self!="undefined"?self:globalThis).MeshoptDecoder=qs;function vr(r,t,e,i,n=0){r.addAttribute(t,new Dt(e,i,n,!0))}function Cm(r){if(r instanceof Ea)return Cm(r.parent);r instanceof xa?r.cleanupIndicesAndVertices():r instanceof eh&&(r.cleanupTransforms(),r.parent.cleanupIndicesAndVertices())}class xa extends tn{constructor(){super();o(this,"isInstanced",!1);o(this,"instanceCount",0);o(this,"index",null);o(this,"indexUint",!0);o(this,"vertices",null);o(this,"normals",null);o(this,"uvs0",null);o(this,"isUvs0Repeating",!1);o(this,"uvs1",null);o(this,"indexCnt",0);o(this,"indexOffset",0);o(this,"vertexCnt",0);o(this,"vertexOffset",0);o(this,"defaultAttributeValues");o(this,"gpuSize",0);o(this,"boundingBox",new li);o(this,"boundingSphere",new os);this._disableBoundingVolumesCompute=!0}allocateCoreBuffers(e){console.assert(!this.vertices),e&&(this.vertexCnt<=65535+1?(this.indexUint=!1,this.index=new Uint16Array(this.indexCnt),this.gpuSize+=this.indexCnt*2):(this.indexUint=!0,this.index=new Uint32Array(this.indexCnt),this.gpuSize+=this.indexCnt*4)),this.vertices=new Float32Array(this.vertexCnt*3),this.gpuSize+=this.vertexCnt*3*4,this.normals=$e.ios?new Int16Array(this.vertexCnt*2):new Int8Array(this.vertexCnt*2),this.gpuSize+=this.vertexCnt*2}addCoreAttributes(){nt(this.vertices),nt(this.normals),this.index&&vr(this,"index",this.index,1),vr(this,"position",this.vertices,3),vr(this,"sphericalNormal",this.normals,2),this.normals=null,T.CPU_COLLIDER||this.cleanupIndicesAndVertices()}cleanupIndicesAndVertices(){this.index=null,this.vertices=null}allocateUv0(){console.assert(!this.uvs0),this.uvs0=new Float32Array(this.vertexCnt*2),this.gpuSize+=this.vertexCnt*2*4}addUv0Attribute(){vr(this,"uv0",this.uvs0,2),this.uvs0=null}allocateUv1(){console.assert(!this.uvs1),this.uvs1=new Uint16Array(this.vertexCnt*2),this.gpuSize+=this.vertexCnt*2*2}addUv1Attribute(){vr(this,"uv1",this.uvs1,2),this.uvs1=null}}class eh extends tn{constructor(e,i){super();o(this,"parent");o(this,"ownsGpuBuffers");o(this,"isInstanced",!0);o(this,"instanceCount",0);o(this,"uvs1Mod",null);o(this,"transforms0",null);o(this,"transforms1",null);o(this,"transforms2",null);o(this,"indexOffset",0);o(this,"vertexOffset",0);o(this,"boundingBox",new li);o(this,"boundingSphere",new os);o(this,"_gpuSize",0);this.parent=e,this._disableBoundingVolumesCompute=!0,this.ownsGpuBuffers=i}allocateCoreBuffers(e){console.assert(!this.transforms0&&!this.transforms1&&!this.transforms2),this.parent.vertices||this.parent.allocateCoreBuffers(e);const i=this.instanceCount*4;this.transforms0=new Float32Array(i),this.transforms1=new Float32Array(i),this.transforms2=new Float32Array(i),this._gpuSize+=3*i*4}addCoreAttributes(){nt(this.transforms0&&this.transforms1&&this.transforms2),this.parent.attributes.position||this.parent.addCoreAttributes();for(const e of this.parent.attributesKeys)this.addAttribute(e,this.parent.attributes[e]);vr(this,"t0",this.transforms0,4,1),vr(this,"t1",this.transforms1,4,1),vr(this,"t2",this.transforms2,4,1),T.CPU_COLLIDER||this.cleanupTransforms()}cleanupTransforms(){this.transforms0=null,this.transforms1=null,this.transforms2=null}allocateUv0(){this.parent.uvs0||this.parent.allocateUv0()}addUv0Attribute(){this.parent.attributes.uv0||this.parent.addUv0Attribute(),this.addAttribute("uv0",this.parent.attributes.uv0)}allocateUv1(){console.assert(!this.uvs1Mod),this.parent.uvs1||this.parent.allocateUv1(),this.uvs1Mod=new Float32Array(this.instanceCount*4),this._gpuSize+=this.instanceCount*4*4}addUv1Attribute(){this.parent.attributes.uv1||this.parent.addUv1Attribute(),this.addAttribute("uv1",this.parent.attributes.uv1),vr(this,"uv1Mod",this.uvs1Mod,4,1),this.uvs1Mod=null}get index(){return this.parent.index}get vertices(){return this.parent.vertices}get normals(){return this.parent.normals}get uvs0(){return this.parent.uvs0}get uvs1(){return this.parent.uvs1}get indexUint(){return this.parent.indexUint}get vertexCnt(){return this.parent.vertexCnt}set vertexCnt(e){this.parent.vertexCnt=e}get indexCnt(){return this.parent.indexCnt}set indexCnt(e){this.parent.indexCnt=e}get gpuSize(){return this.ownsGpuBuffers?this._gpuSize+this.parent.gpuSize:this._gpuSize}get isUvs0Repeating(){return this.parent.isUvs0Repeating}set isUvs0Repeating(e){this.parent.isUvs0Repeating=e}}class Ea{constructor(t,e,i,n=void 0,s=void 0,a=null,l=null){o(this,"id",NaN);o(this,"indexCnt");o(this,"vertexCnt");o(this,"parent");o(this,"vertexOffset");o(this,"indexOffset");o(this,"vertexAttribOffset");o(this,"isInstanced");o(this,"instanceId",0);o(this,"instanceCount",1);o(this,"defaultAttributeValues");o(this,"boundingBox",null);o(this,"boundingSphere",null);this.indexCnt=t,this.vertexCnt=e,this.parent=i,this.vertexOffset=s,this.indexOffset=n,this.isInstanced=i.isInstanced,this.boundingBox=a,this.boundingSphere=l}get indexUint(){return this.parent.indexUint}get isUvs0Repeating(){return this.parent.isUvs0Repeating}get attributes(){return this.parent.attributes}get attributesKeys(){return this.parent.attributesKeys}hasAttribute(t){return this.parent.hasAttribute(t)}setOnDispose(t){this.parent.setOnDispose(t)}}let zt;function Tx(r,t){return $t(this,null,function*(){return new Promise(e=>{const i=s=>{zt=s,e()},n=window.document.createElement("script");n.addEventListener("load",function s(){n.removeEventListener("load",s),window.MeshIntersector_module({wasmBinary:t}).then(i)}),n.src=r,window.document.head.appendChild(n)})})}function wx(){return $t(this,null,function*(){const r=yi("lib/MeshIntersector_module.wasm"),t=yi("lib/MeshIntersector_module.js");return new Promise((e,i)=>{Hc(r,!0,a=>{Tx(t,a).then(()=>e())},(a,l)=>{i(new Error(`MeshIntersector loading failed err:${a} message:${l}`))})})})}class th{constructor(){o(this,"meshId",-1);o(this,"mesh");o(this,"distance",1/0);o(this,"numTestedMeshChunks",0);o(this,"numTestedNodes",0)}clear(){this.meshId=-1,this.mesh=void 0,this.distance=1/0,this.numTestedMeshChunks=0,this.numTestedNodes=0}}var Do=(r=>(r[r.NONE=0]="NONE",r[r.VISIBLE=1]="VISIBLE",r[r.GROUND=2]="GROUND",r[r.COLLIDER=4]="COLLIDER",r[r.DOUBLE_SIDED=8]="DOUBLE_SIDED",r))(Do||{});class Sx{constructor(t){o(this,"_scene");o(this,"_dynamicBoxes",new Array);this._scene=t}_visualizeBoxes(t,e,i){const n=t.length/6,s=new L,a=new L,l=new L,c=new Array;for(let h=0;h<n;h++){const d=new je(e,i);s.set(t[h*6+0],t[h*6+1],t[h*6+2]),a.set(t[h*6+3],t[h*6+4],t[h*6+5]),l.addVectors(s,a).multiplyScalar(.5),d.scale.subVectors(a,s),d.position.copyFrom(l),c.push(d)}return c}visualizeTree(t){const e=zt.getNodeBoxes(t),i=zt.getChunkBoxes(t),n=ft.createBox(1,1,1),s=new Es(new _e(65280)),a=new Es(new _e(16711680));let l=this._visualizeBoxes(e,n,s);l=l.concat(this._visualizeBoxes(i,n,a));for(const c of l)this._scene.add(c);return this._scene.updateMatrixWorld(),l}visualizeDynamicTree(t){for(const e of this._dynamicBoxes)this._scene.remove(e);this._dynamicBoxes=this.visualizeTree(t)}}const Zn=class Zn{constructor(t){o(this,"_staticIdToMesh",new Map);o(this,"_staticMeshToId",new Map);o(this,"_staticGeometryToId",new Map);o(this,"_staticTreeInitialized",!1);o(this,"_dynamicIdToMesh",new Map);o(this,"_dynamicMeshToId",new Map);o(this,"_dynamicGeometryToId",new Map);o(this,"_hasDynamicTransforms",!1);o(this,"_staticTreeId");o(this,"_dynamicTreeId");o(this,"_debugVisualizer");o(this,"_isDisposed",!1);o(this,"_sumTime",0);o(this,"_numSamples",0);o(this,"_dynamicIsect",new th);o(this,"_tempIsect",new th);Zn._instance&&Zn._instance._dispose(),Zn._instance=this,this._staticTreeId=zt.addTree(),this._dynamicTreeId=zt.addTree(),t&&(this._debugVisualizer=new Sx(t)),zt.performTests()}_dispose(){this._staticTreeId&&zt.removeTree(this._staticTreeId),this._dynamicTreeId&&zt.removeTree(this._dynamicTreeId),this._staticIdToMesh.clear(),this._staticMeshToId.clear(),this._staticGeometryToId.clear(),this._dynamicIdToMesh.clear(),this._dynamicMeshToId.clear(),this._dynamicGeometryToId.clear(),this._staticTreeInitialized=!1,this._hasDynamicTransforms=!1,this._debugVisualizer=void 0,this._tempIsect=new th,this._dynamicIsect=new th,this._isDisposed,this._isDisposed=!0,Zn._instance=void 0}static instance(){return Zn._instance===void 0&&new Zn,Zn._instance}buildStaticTree(t){var c;if(this._staticTreeInitialized,this._isDisposed)return;const e=performance.now();for(const h of t){const d=this._addMesh(this._staticTreeId,h,this._staticGeometryToId);this._staticIdToMesh.set(d,h),this._staticMeshToId.set(h,d)}const i=performance.now();zt.computeIntervals(this._staticTreeId);const n=performance.now();zt.optimizeLocality(this._staticTreeId);const s=performance.now();zt.computeChunks(this._staticTreeId);const a=performance.now();zt.rebuildTree(this._staticTreeId),this._staticTreeInitialized=!0;const l=performance.now();if(T.DEBUG){const h=(i-e).toFixed(2),d=(n-i).toFixed(2),u=(s-n).toFixed(2),f=(a-s).toFixed(2),p=(l-a).toFixed(2),m=(l-e).toFixed(2);console.log(`buildStaticTree time: ${m} (init: ${h} intervals: ${d} optimize: ${u} chunkize: ${f} buildTree: ${p})`),zt.printInfo()}(c=this._debugVisualizer)==null||c.visualizeTree(this._staticTreeId)}_removeUnusedDynamicGeometries(){const t=new Set;this._dynamicIdToMesh.forEach(i=>{t.add(this._meshToBaseGeometry(i))});const e=new Array;this._dynamicGeometryToId.forEach((i,n)=>e.push([n,i])),e.forEach(([i,n])=>{t.has(i)||(zt.removeGeometry(this._dynamicTreeId,n),this._dynamicGeometryToId.delete(i))})}updateDynamicTree(t,e){var s;if(this._isDisposed)return;const i=performance.now();for(const a of e){const l=this._dynamicMeshToId.get(a);l!==void 0&&(zt.removeMesh(this._dynamicTreeId,l),this._dynamicMeshToId.delete(a),this._dynamicIdToMesh.delete(l))}for(const a of t){const l=this._addMesh(this._dynamicTreeId,a,this._dynamicGeometryToId);this._dynamicMeshToId.set(a,l),this._dynamicIdToMesh.set(l,a)}this._removeUnusedDynamicGeometries(),zt.computeIntervals(this._dynamicTreeId),zt.optimizeLocality(this._dynamicTreeId),zt.computeChunks(this._dynamicTreeId),zt.rebuildTree(this._dynamicTreeId),this._hasDynamicTransforms=!1,this._dynamicMeshToId.forEach((a,l)=>{l.matrixWorld&&(this._hasDynamicTransforms=!0)});const n=performance.now();T.DEBUG&&console.log(`updateDynamicTree time: ${(n-i).toFixed(2)}`),(s=this._debugVisualizer)==null||s.visualizeDynamicTree(this._dynamicTreeId)}updateMeshVisibility(t){this._isDisposed||t.forEach(e=>{const i=this._staticMeshToId.get(e),n=this._dynamicMeshToId.get(e);i!==void 0&&zt.updateMeshFlags(this._staticTreeId,i,this._meshFlags(e)),n!==void 0&&zt.updateMeshFlags(this._dynamicTreeId,n,this._meshFlags(e))})}_loadMatrixWorld(t){if(!t.matrixWorld)return;const e=Zn._tempMatrix,i=t.matrixWorld.elements;for(let n=0;n<3;n++)for(let s=0;s<4;s++)e[n*4+s]=i[s*4+n];return e}_updateDynamicMeshTransforms(){var n;const t=performance.now();let e=!1;this._dynamicMeshToId.forEach((s,a)=>{if(a.matrixWorld){const l=this._loadMatrixWorld(a);zt.updateMeshTransform(this._dynamicTreeId,s,l)&&(e=!0)}}),e&&zt.rebuildTree(this._dynamicTreeId);const i=performance.now();T.DEBUG&&console.log(`updateDynamicMeshTransforms time: ${(i-t).toFixed(2)}`),e&&((n=this._debugVisualizer)==null||n.visualizeDynamicTree(this._dynamicTreeId))}_updateDynamicMeshes(){this._hasDynamicTransforms&&this._updateDynamicMeshTransforms(),this.updateMeshVisibility(Array.from(this._dynamicIdToMesh.values()))}_addGeometry(t,e,i){var d,u;let n=i.get(e);if(n!==void 0)return n;const s=e instanceof xa?e.vertices:(d=e.getAttribute("position"))==null?void 0:d.array,a=e instanceof xa?e.index:(u=e.getAttribute("index"))==null?void 0:u.array,l=a instanceof Uint16Array?2:a instanceof Uint32Array?4:0;s.length%3,a&&(a.length%3,void 0);const c=s.length/3,h=a?a.length/3:c/3;return n=zt.addGeometry(t,a,s,h,l),i.set(e,n),n}_meshToBaseGeometry(t){const e=t.geometry;if(e instanceof tn)return e;{let i=e.parent;return i instanceof eh&&(i=i.parent),i}}_meshFlags(t){var i;let e=(t.visible?1:0)|4;return t instanceof Tn&&t.node&&(t.node.ground&&(e|=2),t.node.disableCollisions&&(e&=-5)),(i=t.material)!=null&&i.doubleSided&&(e|=8),e}_addMesh(t,e,i){var h,d;const n=e.geometry;let s,a,l;if(n instanceof tn){s=this._loadMatrixWorld(e),l=0;const u=n.getAttribute("index"),f=n.getAttribute("position");a=u?u.length/3:f.length/9}else{const u=n.parent;if(u instanceof eh){s=Zn._tempMatrix;const f=n.instanceId*4;u.transforms0&&u.transforms1&&u.transforms2,s.set(u.transforms0.slice(f,f+4),0),s.set(u.transforms1.slice(f,f+4),4),s.set(u.transforms2.slice(f,f+4),8)}a=n.indexCnt?n.indexCnt/3:n.vertexCnt/3,l=n.indexCnt?((h=n.indexOffset)!=null?h:0)/3:((d=n.vertexOffset)!=null?d:0)/3}const c=this._addGeometry(t,this._meshToBaseGeometry(e),i);return zt.addMesh(t,c,l,a,this._meshFlags(e),s)}_intersectTree(t,e,i,n,s){zt.intersectTree(t,e.origin.x,e.origin.y,e.origin.z,e.direction.x,e.direction.y,e.direction.z,i,n,s)}intersect(t,e=1/0,i=0,n=this._tempIsect){if(this._staticTreeInitialized,this._isDisposed)return n;const s=performance.now();return this._intersectTree(this._staticTreeId,t,e,i,n),this._dynamicMeshToId.size>0&&(this._updateDynamicMeshes(),e=Math.min(e,n.distance),this._intersectTree(this._dynamicTreeId,t,e,i,this._dynamicIsect),this._dynamicIsect.distance<n.distance&&(n.distance=this._dynamicIsect.distance,n.meshId=this._dynamicIsect.meshId,n.mesh=this._dynamicIdToMesh.get(n.meshId)),n.numTestedNodes+=this._dynamicIsect.numTestedNodes,n.numTestedMeshChunks+=this._dynamicIsect.numTestedMeshChunks),n.meshId!=-1&&!n.mesh&&(n.mesh=this._staticIdToMesh.get(n.meshId)),T.DEBUG&&this._logIntersection(performance.now()-s,n),n}customIntersection(t,e,i=1/0,n=0,s=this._tempIsect){const a=performance.now();if(this._isDisposed)return s;const l=zt.addTree(),c=new Map;return t.forEach(h=>this._addMesh(l,h,c)),zt.computeIntervals(l),zt.computeChunks(l),zt.rebuildTree(l),this._intersectTree(l,e,i,n,s),zt.removeTree(l),s.meshId!=-1&&!s.mesh&&(s.mesh=t[s.meshId]),T.DEBUG&&this._logIntersection(performance.now()-a,s,"Custom intersection"),s}_logIntersection(t,e,i="Intersection"){this._sumTime+=t,this._numSamples++;const n=this._sumTime/this._numSamples,s=`node-tests:${e.numTestedNodes} mesh-chunk-tests:${e.numTestedMeshChunks}`,a=t.toFixed(2),l=n.toFixed(2),c=e.distance.toFixed(2);console.log(`${i} (${a} ms avg: ${l} ms; ${s}; hit:${c} hit-id:${e.meshId})`)}};o(Zn,"_instance"),o(Zn,"_tempMatrix",new Float32Array(4*4));let su=Zn;function br(r){let t,e,i,n;this.set=function(s,a,l){console.assert(t===void 0&&e===void 0&&i===void 0&&n===void 0),t=r.autoClear,e=r.autoClearColor,i=r.autoClearDepth,n=r.autoClearStencil,r.autoClear=s||a||l,r.autoClearColor=s,r.autoClearDepth=a,r.autoClearStencil=l},this.restore=function(){console.assert(t!==void 0&&e!==void 0&&i!==void 0&&n!==void 0),r.autoClear=t,r.autoClearColor=e,r.autoClearDepth=i,r.autoClearStencil=n,t=void 0,e=void 0,i=void 0,n=void 0}}function ih(r){const t=new _e;let e=null,i=!1;this.set=function(n,s=void 0){console.assert(!i),i=!0,t.copyFrom(r.getClearColor()),e=r.getClearAlpha(),r.setClearColor(n,s)},this.restore=function(){console.assert(i),i=!1,r.setClearColor(t,e)}}class Lo{constructor(){o(this,"ray",new Pd);o(this,"far",1/0);o(this,"obeyNodeDisableCollisions",!1);o(this,"onlyGroundCollisions",!1);o(this,"ignoreVisibility",!1)}}class yr{constructor(){o(this,"distance",1/0);o(this,"point",new L);o(this,"object",null)}}class Mx{constructor(t,e){o(this,"_camera");o(this,"_fakeNode",{disableCollisions:!1,ground:!1});o(this,"_autoClearAlter");o(this,"_clearColorAlter");o(this,"_visibilityMaterial",new vm(!1));o(this,"_targetBuf",new Uint8Array(4));o(this,"_rawRenderer");o(this,"_target");this._rawRenderer=t,this._target=t.createRenderTarget(1,1,{magFilter:H.NEAREST,minFilter:H.NEAREST,stencilBuffer:!1,depthBuffer:!0,generateMipmaps:!1}),this._camera=new Xs(1,1,e.near,e.far),this._autoClearAlter=new br(t),this._clearColorAlter=new ih(t)}_shouldRender(t,e){if(!e.ignoreVisibility&&!t.visible)return!1;const i=t instanceof Tn&&t.node||this._fakeNode;if(i.disableCollisions&&e.obeyNodeDisableCollisions||!i.ground&&e.onlyGroundCollisions)return!1;const n=e.ray;if(t.matrixWorld)return!0;const s=t.geometry.boundingSphere;if(s.distanceToPoint(n.origin)>e.far||!n.isIntersectionSphere(s))return!1;const a=t.geometry.boundingBox;return!(a.distanceToPoint(n.origin)>e.far||!n.isIntersectionBox(a))}closestIntersection(t,e,i){const n=[],s=[];for(let c=0;c<t.length;c+=1){const h=t[c];console.assert(h.visibilityId===null),this._shouldRender(h,e)&&(h.visibilityId=n.length,n.push(h),T.DEV_NEW_RENDER_ARCHITECTURE&&h.entityId!==-1&&s.push(h.entityId))}if(n.length===0)return!1;if(this._camera.position.set(0,0,0),this._camera.lookAt(e.ray.direction),this._camera.position.copyFrom(e.ray.origin),this._camera.updateMatrixWorld(),!T.DEV_NEW_RENDER_ARCHITECTURE){this._autoClearAlter.set(!0,!0,!1),this._clearColorAlter.set(_e.WHITE);const c=this._rawRenderer.sortObjects;this._rawRenderer.sortObjects=!1,this._rawRenderer.renderMeshes(n,this._visibilityMaterial,this._camera,this._target,!1,e.ignoreVisibility),this._rawRenderer.sortObjects=c,this._clearColorAlter.restore(),this._autoClearAlter.restore(),this._rawRenderer.readPixels(1,1,this._targetBuf),this._rawRenderer.setRenderTarget(null)}const a=this._targetBuf[0]*256+this._targetBuf[1],l=this._targetBuf[2]+this._targetBuf[3]/255;return n.forEach(c=>c.visibilityId=null),a===65535||l>e.far?!1:(console.assert(a<n.length),i.object=n[a],i.distance=l,i.point.copyFrom(e.ray.direction).multiplyScalar(l).add(e.ray.origin),!0)}}class Rm{constructor(){o(this,"debugScene");o(this,"depthMax",1/0);o(this,"objectsThreshold",8);o(this,"overlapPct",.15)}}const Jt=class Jt{constructor(t=new Rm){o(this,"indexOutsideMap",[{index:Jt.INDEX_OUTSIDE_POS_X,count:0,x:1,y:0,z:0},{index:Jt.INDEX_OUTSIDE_NEG_X,count:0,x:-1,y:0,z:0},{index:Jt.INDEX_OUTSIDE_POS_Y,count:0,x:0,y:1,z:0},{index:Jt.INDEX_OUTSIDE_NEG_Y,count:0,x:0,y:-1,z:0},{index:Jt.INDEX_OUTSIDE_POS_Z,count:0,x:0,y:0,z:1},{index:Jt.INDEX_OUTSIDE_NEG_Z,count:0,x:0,y:0,z:-1}]);o(this,"root");o(this,"nodeCount",0);o(this,"debugScene");o(this,"visualGeometry");o(this,"visualMaterial");o(this,"depthMax");o(this,"objectsThreshold");o(this,"overlapPct");o(this,"_tempVec3A",new L);o(this,"_tempVec3B",new L);this.debugScene=t.debugScene,this.debugScene&&(this.visualGeometry=ft.createBox(1,1,1),this.visualMaterial=new Es(new _e(65280))),this.depthMax=t.depthMax,this.objectsThreshold=t.objectsThreshold,this.overlapPct=t.overlapPct,this.root=new ru(this,void 0,new L,0)}add(t){t.geometry.boundingSphere;const e=t.geometry.boundingSphere.center,i=t.geometry.boundingSphere.radius;i!==0&&this.root.addObject(new Px(t,e,i))}search(t,e,i){const n=new Array;this.root.appendObjectsFromNode(n),i=this._tempVec3A.copyFrom(i).normalize();const s=this._tempVec3B.set(1,1,1).divide(i);for(const a of this.root.nodeIndices)this.root.nodes[a].search(t,e,i,s,n);return n}setRoot(t){this.root=t,this.root.updateProperties()}getDepthEnd(){return this.root.getDepthEnd()}getNodeCountEnd(){return this.root.getNodeCountEnd()}getObjectCountEnd(){return this.root.getObjectCountEnd()}toConsole(){this.root.toConsole()}};o(Jt,"INDEX_INSIDE_CROSS",-1),o(Jt,"INDEX_OUTSIDE_OFFSET",2),o(Jt,"INDEX_OUTSIDE_POS_X",0),o(Jt,"INDEX_OUTSIDE_NEG_X",1),o(Jt,"INDEX_OUTSIDE_POS_Y",2),o(Jt,"INDEX_OUTSIDE_NEG_Y",3),o(Jt,"INDEX_OUTSIDE_POS_Z",4),o(Jt,"INDEX_OUTSIDE_NEG_Z",5),o(Jt,"FLAG_POS_X",1<<Jt.INDEX_OUTSIDE_POS_X+1),o(Jt,"FLAG_NEG_X",1<<Jt.INDEX_OUTSIDE_NEG_X+1),o(Jt,"FLAG_POS_Y",1<<Jt.INDEX_OUTSIDE_POS_Y+1),o(Jt,"FLAG_NEG_Y",1<<Jt.INDEX_OUTSIDE_NEG_Y+1),o(Jt,"FLAG_POS_Z",1<<Jt.INDEX_OUTSIDE_POS_Z+1),o(Jt,"FLAG_NEG_Z",1<<Jt.INDEX_OUTSIDE_NEG_Z+1);let ri=Jt;class Px{constructor(t,e,i){o(this,"object");o(this,"position");o(this,"radius");o(this,"node");o(this,"indexOctant");this.object=t,this.position=e,this.radius=i}}const Jn=class Jn{constructor(t,e,i,n,s){o(this,"tree");o(this,"id");o(this,"parent");o(this,"position");o(this,"radius");o(this,"indexOctant");o(this,"depth");o(this,"overlap");o(this,"radiusOverlap");o(this,"left");o(this,"right");o(this,"bottom");o(this,"top");o(this,"back");o(this,"front");o(this,"objects",new Array);o(this,"nodeIndices",new Array);o(this,"nodes",{});o(this,"visual");this.tree=t,this.id=this.tree.nodeCount++,this.position=i,this.radius=n>0?n:1,this.indexOctant=s,this.depth=0,this.reset(),this.setParent(e),this.overlap=this.radius*this.tree.overlapPct,this.radiusOverlap=this.radius+this.overlap,this.left=this.position.x-this.radiusOverlap,this.right=this.position.x+this.radiusOverlap,this.bottom=this.position.y-this.radiusOverlap,this.top=this.position.y+this.radiusOverlap,this.back=this.position.z-this.radiusOverlap,this.front=this.position.z+this.radiusOverlap,this.tree.debugScene&&(this.visual=new je(this.tree.visualGeometry,this.tree.visualMaterial),this.visual.scale.set(this.radiusOverlap*2,this.radiusOverlap*2,this.radiusOverlap*2),this.visual.position.copyFrom(this.position),this.tree.debugScene.add(this.visual),this.tree.debugScene.updateMatrixWorld())}setParent(t){t!==this&&this.parent!==t&&(this.parent=t,this.updateProperties())}updateProperties(){let t,e;for(this.parent instanceof Jn?(this.tree=this.parent.tree,this.depth=this.parent.depth+1):this.depth=0,t=0,e=this.nodeIndices.length;t<e;t++)this.nodes[this.nodeIndices[t]].updateProperties()}reset(t=!1,e=!1){const i=this.nodeIndices||[],n=this.nodes;this.objects=[],this.nodeIndices=[],this.nodes={};for(const s of i){const a=n[s];a.setParent(void 0),t&&a.reset(t,e)}e&&this.visual&&this.visual.parent&&this.visual.parent.remove(this.visual)}addNode(t,e){t.indexOctant=e,this.nodeIndices.findIndex(i=>i===e)===-1&&this.nodeIndices.push(e),this.nodes[e]=t,t.parent!==this&&t.setParent(this)}removeNode(t,e){const i=this.nodeIndices.findIndex(n=>n===t);this.nodeIndices.splice(i,1),e=e!=null?e:this.nodes[t],delete this.nodes[t],e.parent===this&&e.setParent(void 0)}addObject(t){const e=this.getOctantIndex(t);e>-1&&this.nodeIndices.length>0?this.branch(e).addObject(t):e<-1&&this.parent instanceof Jn?this.parent.addObject(t):(this.objects.findIndex(n=>n===t)===-1&&this.objects.push(t),t.node=this,this.checkGrow())}addObjectWithoutCheck(t){for(let e=0,i=t.length;e<i;e++){const n=t[e];this.objects.push(n),n.node=this}}checkGrow(){this.objects.length>this.tree.objectsThreshold&&this.tree.objectsThreshold>0&&this.grow()}grow(){const t=[],e=[],i=[],n=[];let s=[];for(let a=0,l=this.objects.length;a<l;a++){const c=this.objects[a],h=this.getOctantIndex(c);h>-1?(i.push(c),n.push(h)):h<-1?(t.push(c),e.push(h)):s.push(c)}i.length>0&&(s=s.concat(this.split(i,n))),t.length>0&&(s=s.concat(this.expand(t,e))),this.objects=s,this.checkMerge()}split(t,e){let i;if(this.depth<this.tree.depthMax){i=[];for(let n=0,s=t.length;n<s;n++){const a=t[n],l=e[n];l>-1?this.branch(l).addObject(a):i.push(a)}t===this.objects&&(this.objects=i)}else i=this.objects;return i}branch(t){let e,i,n,s,a,l;return this.nodes[t]instanceof Jn?e=this.nodes[t]:(n=this.radiusOverlap*.5,i=n*this.tree.overlapPct,s=n-i,a=Jn._tempVec3A.set(t&1?s:-s,t&2?s:-s,t&4?s:-s),l=new L().addVectors(this.position,a),e=new Jn(this.tree,this,l,n,t),this.addNode(e,t)),e}expand(t,e){let i;if(this.tree.root.getDepthEnd()<this.tree.depthMax){t=t||this.objects,e=e||[],i=[];const n=[],s=Jn._tempVec3B,a=this.tree.indexOutsideMap;for(let l=0,c=a.length;l<c;l++)a[l].count=0;for(let l=0,c=t.length;l<c;l++){const h=t[l],d=e[l];if(d<-1){const u=-d-ri.INDEX_OUTSIDE_OFFSET;u&ri.FLAG_POS_X?a[ri.INDEX_OUTSIDE_POS_X].count++:u&ri.FLAG_NEG_X&&a[ri.INDEX_OUTSIDE_NEG_X].count++,u&ri.FLAG_POS_Y?a[ri.INDEX_OUTSIDE_POS_Y].count++:u&ri.FLAG_NEG_Y&&a[ri.INDEX_OUTSIDE_NEG_Y].count++,u&ri.FLAG_POS_Z?a[ri.INDEX_OUTSIDE_POS_Z].count++:u&ri.FLAG_NEG_Z&&a[ri.INDEX_OUTSIDE_NEG_Z].count++,n.push(h)}else i.push(h)}if(n.length>0){const l=a.slice(0);l.sort(function(Le,B){return B.count-Le.count});const c=l[0],h=c.index|1;let d=l[1],u=l[2];const f=(d.index|1)!==h?d:u,p=f.index|1;d=l[2],u=l[3];const m=l[4],b=d.index|1,g=u.index|1,x=b!==h&&b!==p?d:g!==h&&g!==p?u:m,w=c.x+f.x+x.x,C=c.y+f.y+x.y,M=c.z+f.z+x.z,D=this.getOctantIndexFromPosition(w,C,M),W=this.getOctantIndexFromPosition(-w,-C,-M),z=this.overlap,$=this.radius,Z=this.tree.overlapPct>0?z/(.5*this.tree.overlapPct*(1+this.tree.overlapPct)):$*2,ne=Z*this.tree.overlapPct,Me=Z+ne-($+z);s.set(D&1?Me:-Me,D&2?Me:-Me,D&4?Me:-Me);const Xe=new L().addVectors(this.position,s),xe=new Jn(this.tree,void 0,Xe,Z,void 0);xe.addNode(this,W),this.tree.setRoot(xe);for(let Le=0,B=n.length;Le<B;Le++)this.tree.root.addObject(n[Le])}t===this.objects&&(this.objects=i)}else i=t;return i}shrink(){this.checkMerge(),this.tree.root.checkContract()}checkMerge(){let t=this,e;for(;t.parent&&t.getObjectCountEnd()<this.tree.objectsThreshold;)e=t,t=t.parent;t!==this&&t.merge([e])}merge(t){var e;for(let i=0,n=t.length;i<n;i++){const s=t[i];this.addObjectWithoutCheck(s.getObjectsEnd()),s.reset(!0,!0),this.removeNode((e=s.indexOctant)!=null?e:-1,s)}this.checkMerge()}checkContract(){if(this.nodeIndices.length>0){let t=0,e=this.objects.length,i;for(let n=0,s=this.nodeIndices.length;n<s;n++){const a=this.nodes[this.nodeIndices[n]],l=a.getObjectCountEnd();e+=l,(!i||l>t)&&(i=a,t=l)}e-=t,e<this.tree.objectsThreshold&&i instanceof Jn&&this.contract(i)}}contract(t){for(let e=0,i=this.nodeIndices.length;e<i;e++){const n=this.nodes[this.nodeIndices[e]];n!==t&&(t.addObjectWithoutCheck(n.getObjectsEnd()),n.reset(!0,!0))}t.addObjectWithoutCheck(this.objects),this.reset(!1,!0),this.tree.setRoot(t),t.checkContract()}getOctantIndex(t){const e=this.position,i=this.radiusOverlap,n=this.overlap;let s=0;const a=t.radius,l=t.position,c=l.x-e.x,h=l.y-e.y,d=l.z-e.z,u=Math.abs(c),f=Math.abs(h),p=Math.abs(d);if(Math.max(u,f,p)+a>i)return u+a>i&&(s=s^(c>0?ri.FLAG_POS_X:ri.FLAG_NEG_X)),f+a>i&&(s=s^(h>0?ri.FLAG_POS_Y:ri.FLAG_NEG_Y)),p+a>i&&(s=s^(d>0?ri.FLAG_POS_Z:ri.FLAG_NEG_Z)),t.indexOctant=-s-ri.INDEX_OUTSIDE_OFFSET,t.indexOctant;if(c-a>-n)s=s|1;else if(!(c+a<n))return t.indexOctant=ri.INDEX_INSIDE_CROSS,t.indexOctant;if(h-a>-n)s=s|2;else if(!(h+a<n))return t.indexOctant=ri.INDEX_INSIDE_CROSS,t.indexOctant;if(d-a>-n)s=s|4;else if(!(d+a<n))return t.indexOctant=ri.INDEX_INSIDE_CROSS,t.indexOctant;return t.indexOctant=s,t.indexOctant}getOctantIndexFromPosition(t,e,i){let n=0;return t>0&&(n=n|1),e>0&&(n=n|2),i>0&&(n=n|4),n}appendObjectsFromNode(t){const e=this.objects;for(let i=0,n=e.length;i<n;i+=1)t.push(e[i].object)}search(t,e,i,n,s){if(this.intersectRay(t,e,n)){this.appendObjectsFromNode(s);for(let a=0,l=this.nodeIndices.length;a<l;a++)this.nodes[this.nodeIndices[a]].search(t,e,i,n,s)}}intersectRay(t,e,i){const n=(this.left-t.x)*i.x,s=(this.right-t.x)*i.x,a=(this.bottom-t.y)*i.y,l=(this.top-t.y)*i.y,c=(this.back-t.z)*i.z,h=(this.front-t.z)*i.z,d=Math.min(Math.min(Math.max(n,s),Math.max(a,l)),Math.max(c,h));if(d<0)return!1;const u=Math.max(Math.max(Math.min(n,s),Math.min(a,l)),Math.min(c,h));return!(u>d||u>e)}getDepthEnd(t=0){if(this.nodeIndices.length>0)for(let e=0,i=this.nodeIndices.length;e<i;e++)t=this.nodes[this.nodeIndices[e]].getDepthEnd(t);else t=this.depth>t?this.depth:t;return t}getNodeCountEnd(){return this.tree.root.getNodeCountRecursive()+1}getNodeCountRecursive(){let t,e,i=this.nodeIndices.length;for(t=0,e=this.nodeIndices.length;t<e;t++)i+=this.nodes[this.nodeIndices[t]].getNodeCountRecursive();return i}getObjectsEnd(t=new Array){t=t.concat(this.objects);for(let e=0,i=this.nodeIndices.length;e<i;e++)t=this.nodes[this.nodeIndices[e]].getObjectsEnd(t);return t}getObjectCountEnd(){let t,e,i=this.objects.length;for(t=0,e=this.nodeIndices.length;t<e;t++)i+=this.nodes[this.nodeIndices[t]].getObjectCountEnd();return i}getObjectCountStart(){let t=this.objects.length,e=this.parent;for(;e instanceof Jn;)t+=e.objects.length,e=e.parent;return t}toConsole(t="   "){console.log(this.parent?t+" octree NODE > ":" octree ROOT > ",this,` // id: ${this.id}`,` // indexOctant: ${this.indexOctant}`,` // position: ${this.position.x} ${this.position.y} ${this.position.z}`,` // radius: ${this.radius}`,` // depth: ${this.depth}`),console.log(this.parent?t+" ":" ",`+ objects (${this.objects.length}) `,this.objects),console.log(this.parent?t+" ":" ",`+ children (${this.nodeIndices.length})`,this.nodeIndices,this.nodes);for(const e of this.nodeIndices)this.nodes[e].toConsole(t+"   ")}};o(Jn,"_tempVec3A",new L),o(Jn,"_tempVec3B",new L);let ru=Jn;function Im(r,t,e){const i=new L;return i.copyFrom(r),i.sub(t).normalize(),i.multiplyScalar(e),r.sub(i)}function Cx(r,t){const e=r.x-t.x,i=r.y-t.y;return Math.sqrt(e*e+i*i)}const dc=class dc{constructor(t,e,i){o(this,"_dynamicObstacles",new Array);o(this,"_scene");o(this,"_octree");o(this,"_gpuRaycaster");o(this,"_distToGroundConfig",new Lo);o(this,"_distToObstacleConfig",new Lo);o(this,"_intersectionBelowConfig",new Lo);o(this,"_distanceToCeilingConfig",new Lo);o(this,"_defaultConfig",new Lo);o(this,"_rayIntersection",new yr);o(this,"_debugGeometry");o(this,"_debugMaterial");o(this,"_controls");o(this,"_camera");o(this,"_cameraPosition");o(this,"_meshIntersector");if(this._controls=i,this._camera=e.camera,this._cameraPosition=i.cameraWorldPosition(),this._scene=e,T.CPU_COLLIDER)this._meshIntersector=new su(void 0);else{this._gpuRaycaster=new Mx(t,e.camera);const n=new Rm;n.debugScene=void 0,this._octree=new ri(n)}this._distToGroundConfig.ray.direction.set(0,0,-1),this._distToGroundConfig.obeyNodeDisableCollisions=!0,this._distToGroundConfig.onlyGroundCollisions=this._camera.autoClimb,this._distToObstacleConfig.obeyNodeDisableCollisions=!0,this._distToObstacleConfig.onlyGroundCollisions=!1,this._intersectionBelowConfig.ray.direction.set(0,0,-1),this._intersectionBelowConfig.obeyNodeDisableCollisions=!1,this._distanceToCeilingConfig.ray.direction.set(0,0,1),this._distanceToCeilingConfig.obeyNodeDisableCollisions=!0}addStaticObstacles(t){if(T.CPU_COLLIDER){this._meshIntersector,this._meshIntersector.buildStaticTree(t);for(const e of t)Cm(e.geometry)}else{this._octree;for(const e of t)this._octree.add(e)}}addDynamicObstacles(t){if(T.CPU_COLLIDER)this._meshIntersector,this._meshIntersector.updateDynamicTree(t,[]);else for(const e of t)this._dynamicObstacles.push(e)}removeDynamicObstacles(t){if(T.CPU_COLLIDER)this._meshIntersector,this._meshIntersector.updateDynamicTree([],t);else for(const e of t)Qi(e,this._dynamicObstacles)}_debugPointAt(t){this._debugGeometry&&this._debugMaterial;const e=new je(this._debugGeometry,this._debugMaterial);e.position.copyFrom(t),this._scene.addAuxiliaryObject(e),e.updateMatrixWorld()}closestIntersection(t,e){var i;if(T.CPU_COLLIDER){this._meshIntersector;let n=Do.VISIBLE;t.ignoreVisibility&&(n=Do.NONE),t.onlyGroundCollisions&&(n|=Do.GROUND),t.obeyNodeDisableCollisions&&(n|=Do.COLLIDER);const s=this._meshIntersector.intersect(t.ray,t.far,n);return s.mesh?(e.distance=s.distance,e.object=(i=s.mesh)!=null?i:null,e.point=t.ray.at(s.distance),!0):!1}else{const n=performance.now();this._octree&&this._gpuRaycaster;const s=this._octree.search(t.ray.origin,t.far,t.ray.direction);for(const l of this._dynamicObstacles)s.push(l);const a=this._gpuRaycaster.closestIntersection(s,t,e);if(a&&dc.DEBUG&&this._debugPointAt(e.point),T.DEBUG){const l=(performance.now()-n).toFixed(2);console.log(`Intersection time: ${l}`)}return a}}distanceToClosestObstacle(t){return this.closestIntersection(t,this._rayIntersection)?this._rayIntersection.distance:1/0}distanceToGroundFrom(t,e){this._distToGroundConfig.ray.origin.copyFrom(t),this._distToGroundConfig.far=e;const i=this.distanceToClosestObstacle(this._distToGroundConfig);return this._camera.autoClimb||i>=1?i:1/0}distanceToObstacle(t){return this._distToObstacleConfig.ray.direction.copyFrom(this._camera.getWorldDirection()),this._distToObstacleConfig.ray.origin.copyFrom(this._cameraPosition),this._distToObstacleConfig.far=t,this.distanceToClosestObstacle(this._distToObstacleConfig)}distanceToGround(t){return this.distanceToGroundFrom(this._cameraPosition,t)}findIntersectionBelow(t,e,i){return this._intersectionBelowConfig.ray.origin.copyFrom(t),this._intersectionBelowConfig.far=e,this.closestIntersection(this._intersectionBelowConfig,i)}distanceToCeilingFrom(t,e){return this._distanceToCeilingConfig.ray.origin.copyFrom(t),this._distanceToCeilingConfig.far=e,this.distanceToClosestObstacle(this._distanceToCeilingConfig)}distanceToCeiling(t){return this.distanceToCeilingFrom(this._cameraPosition,t)}cameraHeightFromPoint(t){const e=this.distanceToGroundFrom(t,T.MAX_GROUND_SEARCH_DEPTH);return e===1/0?null:e}adjustPointToMatchCameraHeight(t){const e=this._camera.fixedHeight||T.CAMERA_FIXED_HEIGHT||this._controls.cameraHeight;if(e===null)return!1;const i=this.distanceToGroundFrom(t,T.MAX_GROUND_SEARCH_DEPTH);if(i===1/0)return!1;const n=e-i;return Math.abs(n)<.01||n>0&&this.distanceToCeilingFrom(t,n+T.MIN_DISTANCE_TO_CEILING)!==1/0?!1:(t.z+=n,!0)}_defaultRaycasterConfig(t,e){const i=this._defaultConfig;if(this._camera.isOrthographic()){const n=this._camera.getCurrent(),s=this._camera.getWorldQuaternion(new bi),a=t*(n.right-n.left)/2,l=e*(n.top-n.bottom)/2,c=new L(a,l,0);s.applyToVector3(c),i.ray.origin=this._cameraPosition.clone().add(c),i.ray.direction.copyFrom(this._camera.getWorldDirection())}else i.ray.origin=this._cameraPosition.clone(),this._camera.getCurrent().unprojectVector(i.ray.direction.set(t,e,1)),i.ray.direction.sub(this._cameraPosition).normalize();return i}findIntersectionAtPosition(t,e,i,n){const s=this._defaultRaycasterConfig(t,e);return s.ignoreVisibility=!1,s.obeyNodeDisableCollisions=i,this.closestIntersection(s,n)}findObstacleMeshAtPosition(t,e,i){return this.findIntersectionAtPosition(t,e,i,this._rayIntersection)?this._rayIntersection.object:null}findMeshFromListAtPosition(t,e,i,n=!1){var a;const s=this._defaultRaycasterConfig(e,i);if(s.ignoreVisibility=n,T.CPU_COLLIDER){this._meshIntersector;const l=n?Do.NONE:Do.VISIBLE;return(a=this._meshIntersector.customIntersection(t,s.ray,s.far,l).mesh)!=null?a:null}else return this._gpuRaycaster,this._gpuRaycaster.closestIntersection(t,s,this._rayIntersection)?this._rayIntersection.object:null}clickedPointToMoveTarget(t){const e=new Lo;e.obeyNodeDisableCollisions=!0;const i=e.ray.origin,n=e.ray.direction,s=new yr,a=new L,l=c=>{const h=Cx(i,a);if(e.far=h+T.CLICK_MOVE_MIN_DISTANCE_TO_OBSTACLE,n.x=a.x-i.x,n.y=a.y-i.y,!(Math.abs(n.x)<.01&&Math.abs(n.y)<.01))if(n.z=0,n.normalize(),this.closestIntersection(e,s)){let d=s.distance-T.CLICK_MOVE_MIN_DISTANCE_TO_OBSTACLE;d>0&&(c.x=i.x+n.x*d,c.y=i.y+n.y*d,c.z=i.z);const u=.01;if(d=Math.min(s.distance-u,h),i.x+=n.x*d,i.y+=n.y*d,this.adjustPointToMatchCameraHeight(i)){l(c);return}}else c.x=a.x,c.y=a.y,c.z=i.z};i.copyFrom(this._cameraPosition),a.copyFrom(t),t.copyFrom(this._cameraPosition),l(t),this.adjustPointToMatchCameraHeight(t)}movePointTowardsTheCamera(t,e){return Im(t,this._cameraPosition,e)}updateMeshVisibility(t){if(T.CPU_COLLIDER){this._meshIntersector,this._meshIntersector.updateMeshVisibility(t);const e=new Array;for(const i of t)i instanceof Co&&e.push(...i.logicalMeshes);e.length>0&&this._meshIntersector.updateMeshVisibility(e)}}handleCollisions(t){const e=new Lo;e.ray.origin=this._cameraPosition;const i=e.ray.direction,n=new Md,s=new L;let a=0;e.obeyNodeDisableCollisions=!0,e.far=5,nt(e.far>T.CAMERA_MAX_PER_FRAME_LINEAR_DISTANCE);const l=(d,u)=>{const f=n.start.distanceTo(d),p=n.end.distanceTo(d);return a-.02<f+p&&f+p<a+.02&&p>=u},c=d=>{if(this._controls.applyCameraYaw(i),i.normalize(),l(this._cameraPosition,d)&&s.equals(i))return!1;let u=this.distanceToClosestObstacle(e);return u===1/0&&(u=e.far),s.copyFrom(i),n.start.copyFrom(this._cameraPosition),n.end.copyFrom(i).multiplyScalar(u).add(this._cameraPosition),a=n.distance(),u<d},h=this._controls.maxFrameMoveLinearDistance(t)+T.KEY_MOVE_MIN_DISTANCE_TO_OBSTACLE;this._controls.movesForward()&&(i.set(0,1,0),c(h)&&this._controls.stopForward()),this._controls.movesBackward()&&(i.set(0,-1,0),c(h)&&this._controls.stopBackward()),this._controls.movesLeft()&&(i.set(-1,0,0),c(h)&&this._controls.stopLeft()),this._controls.movesRight()&&(i.set(1,0,0),c(h)&&this._controls.stopRight()),this._controls.movesDown()&&(i.set(0,0,-1),c(h)&&this._controls.stopDown()),this._controls.movesUp()&&(i.set(0,0,1),c(h)&&this._controls.stopUp())}};o(dc,"DEBUG",!1),o(dc,"DEBUG_OCTREE",!1);let ou=dc;class Rx{constructor(t,e,i){o(this,"_vrManager");o(this,"_animateCallback");o(this,"_animateIdleCallback");o(this,"_clock",new db);o(this,"_inAnimateCallback",!1);o(this,"_frameRequested",!1);o(this,"_callIdleCallback",!1);o(this,"_idleFrameCnt",0);o(this,"_enabled",!1);this._vrManager=t,this._animateCallback=e,this._animateIdleCallback=i}_animateVR(){this._animate(this._vrManager.vrEnabled())}_animateWindow(){this._animate(!1)}_doRequestFrame(){this._frameRequested||(this._inAnimateCallback||this._clock.getDelta(),this._frameRequested=!0,this._vrManager.vrEnabled()?this._vrManager.requestAnimationFrame(this._animateVR.bind(this)):requestAnimationFrame(this._animateWindow.bind(this)))}_animate(t){this._enabled&&(this._frameRequested=!1,this._callIdleCallback?(nt(!t),this._animateIdleCallback(this._clock.getDelta(),this._idleFrameCnt)?(this._idleFrameCnt+=1,this._doRequestFrame()):this._callIdleCallback=!1):(this._inAnimateCallback=!0,this._animateCallback(this._clock.getDelta(),t),T.ALWAYS_RENDER&&this.requestFrame(),this._inAnimateCallback=!1,this._frameRequested||(this._callIdleCallback=!0,this._idleFrameCnt=0,this._doRequestFrame())))}requestFrame(){this._enabled&&(this._callIdleCallback=!1,this._doRequestFrame())}disable(){this._enabled=!1}enable(){this._enabled=!0,this._frameRequested=!1,this.requestFrame()}isEnabled(){return this._enabled}}var Dm=(r=>(r.TOUR_STARTED="tourStarted",r.TOUR_STOPPED="tourStopped",r))(Dm||{});const uc=class uc extends ci{constructor(e){super();o(this,"_teleport");o(this,"_running");o(this,"_maxTeleportToViewTime");o(this,"_switchToView",()=>{this._running&&this._teleport.switchToNextVisibleView(this._maxTeleportToViewTime)});o(this,"_onTeleportDone",()=>{this._running&&setTimeout(this._switchToView,T.AUTO_TOUR_IN_VIEW_STILL_TIME_MS)});this._teleport=e,this._running=!1,this._maxTeleportToViewTime=4,this._teleport.addEventListener(ps.eventType.TELEPORT_DONE,this._onTeleportDone)}isRunning(){return this._running}start(){console.assert(!this._running),this._running=!0,this.dispatchEvent({type:uc.eventType.TOUR_STARTED}),this._switchToView()}stop(){console.assert(this._running),this._running=!1,this._teleport.switchToView(this._teleport.lastDestinationView,0),this.dispatchEvent({type:uc.eventType.TOUR_STOPPED})}};o(uc,"eventType",Dm);let cl=uc;const au=.2,Lm=.011,lu=.011,Ix=.047;function Dx(){const r=new Qt;return r.baseColor.setRGB(.298,.619,.851),r.highlight=new _e(.033,.125,.445),r.reflective=!1,r.lightmapSupported=!1,r.setUniforms(),r}function Lx(r){const t=ft.createCylinder(.05,.05,lu,32),e=ft.createCylinder(.05,.03,Lm,32,1,!1),i=ft.createCylinder(0,.05,au,32,1,!0),n=new Ue;n.makeRotationX(Math.PI/2),t.applyMatrix(n),t.convertNormalsToSpherical();const s=new je(t,r);s.position.z+=lu/2,n.makeTranslation(0,-(au/2+Lm/2),0),e.applyMatrix(n),e.convertNormalsToSpherical();const a=new je(e,r);i.convertNormalsToSpherical();const l=new je(i,r);l.add(a),l.rotateX(-Math.PI/2),l.position.z=lu+Ix+au/2;const c=new yt;return c.add(s),c.add(l),c}class Ox{constructor(t){o(this,"_scene");o(this,"_targetMaterial",Dx());o(this,"_targetObject",Lx(this._targetMaterial));o(this,"_baseMesh",this._targetObject.children[0]);o(this,"_visible",!1);o(this,"_highlightChangeSign",1);this._scene=t}hide(){this._visible&&(this._scene.removeAuxiliaryObject(this._targetObject),this._visible=!1)}isVisible(){return this._visible}showTargetAtPosition(t,e,i,n){this._visible||(this._scene.addAuxiliaryObject(this._targetObject),this._visible=!0),this._baseMesh.visible=n,this._targetObject.position.set(t,e,i),this._targetObject.updateMatrixWorld()}update(t){this._targetMaterial.highlightMix+=t*this._highlightChangeSign,this._targetMaterial.highlightMix>=1&&(this._targetMaterial.highlightMix=1,this._highlightChangeSign=-1),this._targetMaterial.highlightMix<=0&&(this._targetMaterial.highlightMix=0,this._highlightChangeSign=1)}}class Fx{constructor(t,e,i,n){o(this,"_collider");o(this,"_controls");o(this,"_teleport");o(this,"_targetIndicator");o(this,"_intersection",new yr);o(this,"_cancelTeleport");o(this,"_cancelTeleportInPointerLock");this._collider=e,this._controls=i,this._teleport=n,this._targetIndicator=new Ox(t),this._teleport.addEventListener(ps.eventType.TELEPORT_DONE,()=>this._targetIndicator.hide()),this._cancelTeleport=()=>{this._teleport.teleportingToPoint&&this._teleport.cancelSwitchToPoint()},this._cancelTeleportInPointerLock=()=>{!this._controls.mousePressLook&&this._teleport.teleportingToPoint&&this._teleport.cancelSwitchToPoint()},this._init()}onMeshClicked(t,e){if(this._shouldIgnoreClick())return;this._collider.clickedPointToMoveTarget(e);const i=e.x,n=e.y;let s=e.z,a=!1;if(this._collider.findIntersectionBelow(e,4,this._intersection)){s=this._intersection.point.z;const l=this._intersection.object.geometry.boundingBox;l&&s>l.max.z-.01&&(a=!0)}else s-=this._controls.cameraHeight||1.6;T.CLICK_MOVE_SHOW_TARGET_INDICATOR&&this._targetIndicator.showTargetAtPosition(i,n,s,a),this._teleport.switchToPoint(e)}update(t){this._targetIndicator.isVisible()&&this._targetIndicator.update(t)}dispose(){document.removeEventListener("keydown",this._cancelTeleport,!1),document.removeEventListener("mousedown",this._cancelTeleport,!1),document.removeEventListener("mousemove",this._cancelTeleportInPointerLock,!1),document.removeEventListener("touchstart",this._cancelTeleport,!1),document.removeEventListener("wheel",this._cancelTeleport,!1)}_shouldIgnoreClick(){return this._controls.isOrbitEnabled()||this._controls.isHandlingGesture()||this._controls.camera().moveMaxSpeed===0}_init(){document.addEventListener("keydown",this._cancelTeleport,!1),document.addEventListener("mousedown",this._cancelTeleport,!1),document.addEventListener("mousemove",this._cancelTeleportInPointerLock,!1),document.addEventListener("touchstart",this._cancelTeleport,!1),document.addEventListener("wheel",this._cancelTeleport,!1)}}const Oe={TRIGGER:0,BACKWARD:1,FORWARD:2,LEFT:3,RIGHT:4,DOWN:5,UP:6,PREVIOUS:7,NEXT:8},Om=.7,cu=-1,Bx=0,Nx=1,Ux=[{gamepadIdPattern:/^Spatial Controller \(Spatial Interaction Source\).*$/,axisMapping:new Map([[2,[Oe.PREVIOUS,Oe.NEXT]],[3,[Oe.UP,Oe.DOWN]],[0,[Oe.LEFT,Oe.RIGHT]],[1,[Oe.FORWARD,Oe.BACKWARD]]]),buttonMapping:new Map([[1,Oe.TRIGGER]])},{gamepadIdPattern:/Oculus Touch \(Left\)/,axisMapping:new Map([[0,[Oe.LEFT,Oe.RIGHT]],[1,[Oe.FORWARD,Oe.BACKWARD]]]),buttonMapping:new Map([[1,Oe.TRIGGER],[3,Oe.DOWN],[4,Oe.UP]])},{gamepadIdPattern:/Oculus Touch \(Right\)/,axisMapping:new Map([[0,[Oe.LEFT,Oe.RIGHT]],[1,[Oe.FORWARD,Oe.BACKWARD]]]),buttonMapping:new Map([[1,Oe.TRIGGER],[3,Oe.NEXT],[4,Oe.PREVIOUS]])},{gamepadIdPattern:/OpenVR (Gamepad|Controller)/,axisMapping:new Map([[0,[Oe.PREVIOUS,Oe.NEXT]],[1,[Oe.DOWN,Oe.UP]]]),buttonMapping:new Map([[1,Oe.TRIGGER]])},{gamepadIdPattern:/.*/,gamepadLayoutMappingId:"standard",axisMapping:new Map([[0,[Oe.LEFT,Oe.RIGHT]],[1,[Oe.FORWARD,Oe.BACKWARD]],[2,[Oe.LEFT,Oe.RIGHT]],[3,[Oe.FORWARD,Oe.BACKWARD]]]),buttonMapping:new Map([[0,Oe.DOWN],[1,Oe.NEXT],[2,Oe.PREVIOUS],[3,Oe.UP],[4,Oe.TRIGGER],[5,Oe.TRIGGER]])},{gamepadIdPattern:/.*/,axisMapping:new Map([[0,[Oe.PREVIOUS,Oe.NEXT]],[1,[Oe.UP,Oe.DOWN]]]),buttonMapping:new Map([[0,Oe.TRIGGER],[1,Oe.TRIGGER],[2,Oe.TRIGGER],[3,Oe.TRIGGER]])}],kx={axisMapping:new Map([[2,[Oe.LEFT,Oe.RIGHT]],[3,[Oe.FORWARD,Oe.BACKWARD]]]),buttonMapping:new Map([[0,Oe.TRIGGER],[4,Oe.DOWN],[5,Oe.UP]])},Fm={axisMapping:new Map([[2,[Oe.LEFT,Oe.RIGHT]],[3,[Oe.FORWARD,Oe.BACKWARD]]]),buttonMapping:new Map([[0,Oe.TRIGGER],[4,Oe.NEXT],[5,Oe.PREVIOUS]])};function Bm(r){return r<=-Om?Bx:r>=Om?Nx:cu}function Vx(r,t){return t.gamepadIdPattern.test(r.id)?t.gamepadLayoutMappingId!==void 0?r.mapping===t.gamepadLayoutMappingId:!0:!1}function zx(r,t){if(r.mapping==="xr-standard"){const e=r.hand?r.hand:t;return e==="left"?kx:Fm}for(let e of Ux)if(Vx(r,e))return e;return console.error("No matching action mapping for gamepad found",r.id),null}const hu=function(r,t){const e=zx(r,t);this.axisMapping=e.axisMapping,this.buttonMapping=e.buttonMapping,this.axisPosition=r.axes.map(Bm),this.buttonPressed=r.buttons.map(i=>i.pressed)},Oo={actionActivated:"actionActivated",actionDeactivated:"actionDeactivated"};class Gx extends ci{constructor(){super();const t=new Map,e=new Map,i=new Set,n=new Set,s={type:Oo.actionActivated,action:null},a={type:Oo.actionDeactivated,action:null};this.hasGamepads=function(){return t.size>0||e.size>0},this.update=function(){if(!this.hasGamepads())return;i.clear(),n.clear();function d(f,p){for(let m=0;m<p.axes.length;++m){const b=Bm(p.axes[m]),g=f.axisPosition[m];if(b!==g){const x=f.axisMapping.get(m);x!==void 0&&(g!==cu&&n.add(x[g]),b!==cu&&i.add(x[b]))}f.axisPosition[m]=b}for(let m=0;m<p.buttons.length;++m){const b=p.buttons[m].pressed,g=f.buttonPressed[m];if(b!==g){const x=f.buttonMapping.get(m);x!==void 0&&(g?n.add(x):i.add(x))}f.buttonPressed[m]=b}}const u=navigator.getGamepads?navigator.getGamepads():[];for(let f of u){if(!f)continue;const p=t.get(f.index);d(p,f)}for(let[f,p]of e)d(p,f);for(let f of n)a.action=f,this.dispatchEvent(a);for(let f of i)s.action=f,this.dispatchEvent(s)};function l(d){const u=d.gamepad,f=new hu(d.gamepad);t.set(u.index,f)}function c(d){t.delete(d.gamepad.index)}this.addXrGamepad=function(d,u){const f=new hu(d,u);e.set(d,f)},this.removeXrGamepad=function(d){e.delete(d)},this.removeAllXrGamepads=function(){e.clear()};function h(){if(navigator.getGamepads){window.addEventListener("gamepadconnected",l),window.addEventListener("gamepaddisconnected",c);for(let d of navigator.getGamepads())if(d){const u=new hu(d);t.set(d.index,u)}}}h()}}class Aa{constructor(t,e,i,n){o(this,"collider");o(this,"target",new L);o(this,"noZoom",!1);o(this,"mouseZoomToPointer",!0);o(this,"mouseZoomSpeed",.97);o(this,"keyZoomSpeed",.7);o(this,"minZoom",0);o(this,"maxZoom",1/0);o(this,"noRotate",!1);o(this,"noPitchRotate",!1);o(this,"mouseRotateSpeed",2*Math.PI);o(this,"keyYawRotateSpeed",T.CAMERA_ARROWS_TURN_SPEED);o(this,"keyPitchRotateSpeed",T.CAMERA_ARROWS_TURN_SPEED/2);o(this,"autoRotate",!1);o(this,"autoRotateSpeed",2);o(this,"keyPanSpeed",.25);o(this,"primaryMouseButton",0);o(this,"secondaryMouseButton",2);o(this,"mouseButtons",{ROTATE:this.primaryMouseButton,ZOOM:1,PAN:this.secondaryMouseButton});o(this,"getMinPitchAngle",()=>-Math.PI/2);o(this,"getMaxPitchAngle",()=>Math.PI/2);o(this,"getMinYawAngle",()=>-Math.PI);o(this,"getMaxYawAngle",()=>Math.PI);o(this,"getMinDistance",()=>0);o(this,"getMaxDistance",()=>1/0);o(this,"getNoPan",()=>!1);o(this,"getAutoRotateAngle",()=>2*Math.PI/60/60*this.autoRotateSpeed);o(this,"_camera");o(this,"_controls");o(this,"_domElement");o(this,"_animationController");o(this,"_enabled",!1);o(this,"_rayIntersection",new yr);o(this,"_rotateStart",new ye);o(this,"_rotateEnd",new ye);o(this,"_rotateDelta",new ye);o(this,"_panStart",new ye);o(this,"_panEnd",new ye);o(this,"_panDelta",new ye);o(this,"_panOffset",new L);o(this,"_dollyStart",new ye);o(this,"_dollyEnd",new ye);o(this,"_dollyDelta",new ye);o(this,"_dollyTarget",new L);o(this,"_cameraToTarget",new L);o(this,"_dollyTargetOffset",new L);o(this,"_yawDelta",0);o(this,"_pitchDelta",0);o(this,"_scale",1);o(this,"_panVector",new L);o(this,"_panPrimary",!1);o(this,"_keyDollyDir",0);o(this,"_keyYawRotateDir",0);o(this,"_keyPitchRotateDir",0);o(this,"_keyHorizontalPanDir",0);o(this,"_keyVerticalPanDir",0);o(this,"_state",-1);o(this,"_cancelMouseDown");o(this,"_onMouseMove",t=>{if(!this._enabled)return;t.preventDefault();const e=this._domElement instanceof Document?this._domElement.body:this._domElement;if(this._state===0){if(this.noRotate===!0)return;this._rotateEnd.set(t.clientX,t.clientY),this._rotateDelta.subVectors(this._rotateEnd,this._rotateStart),this._rotateLeft(this._rotateDelta.x/e.clientWidth*this.mouseRotateSpeed),this.noPitchRotate===!1&&this._rotateUp(this._rotateDelta.y/e.clientHeight*this.mouseRotateSpeed),this._rotateStart.copyFrom(this._rotateEnd)}else if(this._state===1){if(this.noZoom===!0)return;this._dollyEnd.set(t.clientX,t.clientY),this._dollyDelta.subVectors(this._dollyEnd,this._dollyStart),this._dollyDelta.y>0?this._dollyIn():this._dollyDelta.y<0&&this._dollyOut(),this._dollyStart.copyFrom(this._dollyEnd)}else if(this._state===2){if(this.getNoPan()===!0)return;this._panEnd.set(t.clientX,t.clientY),this._panDelta.subVectors(this._panEnd,this._panStart),this.pan(this._panDelta.x/e.clientHeight,this._panDelta.y/e.clientWidth),this._panStart.copyFrom(this._panEnd)}this._state!==-1&&this._update()});o(this,"_onMouseUp",t=>{this._enabled&&this._cancelMouseDown&&(this._cancelMouseDown(),this._cancelMouseDown=void 0)});o(this,"_onMouseDown",t=>{if(!this._enabled)return;if((this._domElement instanceof Document?this._domElement.body:this._domElement).focus(),t.preventDefault(),t.button===this.mouseButtons.ROTATE){if(this.noRotate===!0)return;this._state=0,this._rotateStart.set(t.clientX,t.clientY)}else if(t.button===this.mouseButtons.ZOOM){if(this.noZoom===!0)return;this._state=1,this._dollyStart.set(t.clientX,t.clientY),this._updateDollyTarget(t.clientX,t.clientY)}else if(t.button===this.mouseButtons.PAN){if(this.getNoPan()===!0)return;this._state=2,this._panStart.set(t.clientX,t.clientY)}this._state!==-1&&(document.addEventListener("mousemove",this._onMouseMove,!1),document.addEventListener("mouseup",this._onMouseUp,!1),this._cancelMouseDown=()=>{document.removeEventListener("mousemove",this._onMouseMove,!1),document.removeEventListener("mouseup",this._onMouseUp,!1),this._state=-1})});o(this,"_onMouseWheel",t=>{if(!this._enabled||this.noZoom||this._state!==-1)return;t.preventDefault();const e=-t.deltaY;this._updateDollyTarget(t.clientX,t.clientY),e>0?this._dollyOut():e<0&&this._dollyIn(),this._update()});o(this,"_touchStart",t=>{if(!this._enabled)return;const e=t.touches.length;if(t.preventDefault(),this._touchPanEvent(t.touches))this._state=5,this._panStart.set(t.touches[0].clientX,t.touches[0].clientY);else if(this._touchRotateEvent(e))this._state=3,this._rotateStart.set(t.touches[0].clientX,t.touches[0].clientY);else if(this._touchZoomEvent(e)){this._state=4;const i=t.touches[0].clientX-t.touches[1].clientX,n=t.touches[0].clientY-t.touches[1].clientY,s=Math.sqrt(i*i+n*n);this._dollyStart.set(0,s);const a=t.touches[0].clientX-i/2,l=t.touches[0].clientY-n/2;this._updateDollyTarget(a,l)}else this._state=-1});o(this,"_touchMove",t=>{if(!this._enabled)return;const e=t.touches.length;t.preventDefault();const i=this._domElement instanceof Document?this._domElement.body:this._domElement;if(this._touchPanEvent(t.touches)&&this._state===5)this._panEnd.set(t.touches[0].clientX,t.touches[0].clientY),this._panDelta.subVectors(this._panEnd,this._panStart),this.pan(this._panDelta.x/i.clientHeight,this._panDelta.y/i.clientWidth),this._panStart.copyFrom(this._panEnd),this._update();else if(this._touchRotateEvent(e)&&this._state===3)this._rotateEnd.set(t.touches[0].clientX,t.touches[0].clientY),this._rotateDelta.subVectors(this._rotateEnd,this._rotateStart),this._rotateLeft(this._rotateDelta.x/i.clientWidth*this.mouseRotateSpeed),this._rotateUp(this._rotateDelta.y/i.clientHeight*this.mouseRotateSpeed),this._rotateStart.copyFrom(this._rotateEnd),this._update();else if(this._touchZoomEvent(e)&&this._state===4){const n=t.touches[0].clientX-t.touches[1].clientX,s=t.touches[0].clientY-t.touches[1].clientY,a=Math.sqrt(n*n+s*s);this._dollyEnd.set(0,a),this._dollyDelta.subVectors(this._dollyEnd,this._dollyStart),this._dollyDelta.y>0?this._dollyOut():this._dollyDelta.y<0&&this._dollyIn(),this._dollyStart.copyFrom(this._dollyEnd),this._update()}else this._state=-1});o(this,"_touchEnd",t=>{this._enabled&&(this._state=-1)});o(this,"_onKeyDown",t=>{Sp(t)||this._onKey(t,!0)});o(this,"_onKeyUp",t=>{this._onKey(t,!1)});o(this,"_onFocusLost",t=>{this._stopAll()});this._camera=t,this._controls=e,this._domElement=i,this._animationController=n,this._domElement.addEventListener("mousedown",this._onMouseDown,!1),this._domElement.addEventListener("wheel",this._onMouseWheel,!1),this._domElement.addEventListener("touchstart",this._touchStart,!1),this._domElement.addEventListener("touchend",this._touchEnd,!1),this._domElement.addEventListener("touchmove",this._touchMove,!1),this._domElement.addEventListener("blur",this._onFocusLost,!1),this._domElement.addEventListener("keydown",this._onKeyDown,!1),this._domElement.addEventListener("keyup",this._onKeyUp,!1),!this._camera.isPerspective()&&!this._camera.isOrthographic()&&console.warn("WARNING: OrbitControls.js requires perspective or orthographic camers")}_determineDollyTarget(t,e){if(this.collider&&this.mouseZoomToPointer){const i=t/window.innerWidth*2-1,n=-(e/window.innerHeight)*2+1;if(this.collider.findIntersectionAtPosition(i,n,!0,this._rayIntersection)){this._dollyTarget.copyFrom(this._rayIntersection.point);return}}this._dollyTarget.copyFrom(this.target)}_updateDollyTarget(t,e){this.getNoPan()?this._dollyTarget.copyFrom(this.target):this._determineDollyTarget(t,e)}_updateDirection(t,e,i){return i===!0?e:t===e?0:t}_update(){let t=this._controls.getYawAngle(),e=this._controls.getPitchAngle();const i=this._controls.cameraWorldPosition();this.autoRotate&&this._state===-1&&this._rotateLeft(this.getAutoRotateAngle());const n=this.getMinYawAngle();let s=this.getMaxYawAngle();Math.abs(s-n)>=2*Math.PI-1e-6?t+=this._yawDelta:n===s?t=n:(n>s&&(s+=2*Math.PI,t<n&&(t+=2*Math.PI)),this._yawDelta<0?t=Math.min(Math.max(t+this._yawDelta,n),s):t=Math.max(Math.min(t+this._yawDelta,s),n)),e=Yi(e+this._pitchDelta,this.getMinPitchAngle(),this.getMaxPitchAngle()),this._cameraToTarget.copyFrom(this.target).sub(i);const a=this._cameraToTarget.length(),l=Yi(a*this._scale,this.getMinDistance(),this.getMaxDistance()),c=l/a;this._dollyTargetOffset.copyFrom(this._dollyTarget).sub(this.target).multiplyScalar(1-c),this.target.add(this._dollyTargetOffset),this.target.add(this._panVector),Aa.computeCameraPosition(i,this.target,t,e,l),this._controls.cameraPositionUpdated(),this._controls.setYawAngle(t),this._controls.setPitchAngle(e);const h=Aa.computeCameraNear(l);Math.abs(h-this._camera.near)>1e-6&&(this._camera.near=h,this._camera.updateProjectionMatrix()),this._yawDelta=0,this._pitchDelta=0,this._scale=1,this._panVector.set(0,0,0),this._animationController.requestFrame()}_stopAll(){this._keyDollyDir=0,this._keyYawRotateDir=this._keyPitchRotateDir=0,this._keyHorizontalPanDir=this._keyVerticalPanDir=0,this._cancelMouseDown&&(this._cancelMouseDown(),this._cancelMouseDown=void 0)}enable(){this._enabled=!0,this._update()}disable(){this._enabled=!1,this._stopAll()}isEnabled(){return this._enabled}setPanPrimary(t){this._panPrimary=t,this._panPrimary?(this.mouseButtons.PAN=this.primaryMouseButton,this.mouseButtons.ROTATE=this.secondaryMouseButton):(this.mouseButtons.ROTATE=this.primaryMouseButton,this.mouseButtons.PAN=this.secondaryMouseButton)}getCameraDistance(){const t=new L;return t.copyFrom(this._controls.cameraWorldPosition()).sub(this.target),t.length()}_rotateLeft(t){t===void 0&&(t=this.getAutoRotateAngle()),this._yawDelta-=t}_rotateUp(t){t===void 0&&(t=this.getAutoRotateAngle()),this._pitchDelta-=t}_panLeft(t){const e=this._camera.matrixWorld.elements;this._panOffset.set(e[0],e[1],e[2]),this._panOffset.multiplyScalar(-t),this._panVector.add(this._panOffset)}_panUp(t){const e=this._camera.matrixWorld.elements;this._panOffset.set(e[4],e[5],e[6]),this._panOffset.multiplyScalar(t),this._panVector.add(this._panOffset)}pan(t,e){if(this._camera.isPerspective()){let s=this._controls.cameraWorldPosition().clone().sub(this.target).length();s*=Math.tan(this._camera.fov/2*Math.PI/180),this._panLeft(2*t*s),this._panUp(2*e*s)}else this._camera.isOrthographic()&&(this._panLeft(t*(this._camera.right-this._camera.left)),this._panUp(e*(this._camera.top-this._camera.bottom)))}_dollyIn(t){t===void 0&&(t=this.mouseZoomSpeed),this._camera.isPerspective()?this._scale/=t:this._camera.isOrthographic()&&(this._camera.orthoFrustumSize/=t,this._camera.updateProjectionMatrix())}_dollyOut(t){t===void 0&&(t=this.mouseZoomSpeed),this._camera.isPerspective()?this._scale*=t:this._camera.isOrthographic()&&(this._camera.orthoFrustumSize*=t,this._camera.updateProjectionMatrix())}update(t){if(!this._enabled||!t)return;let e=!1;if(this._keyYawRotateDir!==0&&(this._rotateLeft(this._keyYawRotateDir*this.keyYawRotateSpeed*t),e=!0),this._keyPitchRotateDir!==0&&(this._rotateUp(this._keyPitchRotateDir*this.keyPitchRotateSpeed*t),e=!0),(this._keyHorizontalPanDir!==0||this._keyVerticalPanDir!==0)&&(this.pan(this._keyHorizontalPanDir*this.keyPanSpeed*t,this._keyVerticalPanDir*this.keyPanSpeed*t),e=!0),this._keyDollyDir!==0){const i=Math.pow(this.keyZoomSpeed,t);this._keyDollyDir===-1?this._dollyIn(i):this._dollyOut(i),e=!0}e&&this._update()}_upKey(t){return["w","ArrowUp"].includes(t.key)}_downKey(t){return["s","ArrowDown"].includes(t.key)}_leftKey(t){return["a","ArrowLeft"].includes(t.key)}_rightKey(t){return["d","ArrowRight"].includes(t.key)}_onKey(t,e){if(this._enabled===!1)return;let i=!1;if(this._panPrimary&&!this.getNoPan()?(i=!0,this._upKey(t)?this._keyVerticalPanDir=this._updateDirection(this._keyVerticalPanDir,1,e):this._downKey(t)?this._keyVerticalPanDir=this._updateDirection(this._keyVerticalPanDir,-1,e):this._leftKey(t)?this._keyHorizontalPanDir=this._updateDirection(this._keyHorizontalPanDir,1,e):this._rightKey(t)?this._keyHorizontalPanDir=this._updateDirection(this._keyHorizontalPanDir,-1,e):i=!1):!this._panPrimary&&!this.noRotate&&(i=!0,this._upKey(t)&&!this.noPitchRotate?this._keyPitchRotateDir=this._updateDirection(this._keyPitchRotateDir,1,e):this._downKey(t)&&!this.noPitchRotate?this._keyPitchRotateDir=this._updateDirection(this._keyPitchRotateDir,-1,e):this._leftKey(t)?this._keyYawRotateDir=this._updateDirection(this._keyYawRotateDir,1,e):this._rightKey(t)?this._keyYawRotateDir=this._updateDirection(this._keyYawRotateDir,-1,e):i=!1),!this.noZoom){let n;["=","+","e"].includes(t.key)?n=1:["-","q"].includes(t.key)&&(n=-1),n!==void 0&&(this._keyDollyDir=this._updateDirection(this._keyDollyDir,n,e),i=!0)}i&&(t.preventDefault(),this._animationController.requestFrame())}_touchPanEvent(t){return this.getNoPan()?!1:this._panPrimary&&t.length===1?!0:!this._panPrimary&&t.length===2?Math.abs(t[0].clientY-t[1].clientY)<=T.MAX_TWO_POINTERS_IN_LINE_DIFF:!1}_touchRotateEvent(t){return!this.noRotate&&!this._panPrimary&&t===1}_touchZoomEvent(t){return!this.noZoom&&t===2}static computeCameraPosition(t,e,i,n,s){const a=new L,l=i-Math.PI/2,c=n+Math.PI/2;a.x=s*Math.sin(c)*Math.cos(l),a.y=s*Math.sin(c)*Math.sin(l),a.z=s*Math.cos(c),t.copyFrom(e).add(a)}static computeCameraNear(t){return t*T.CAMERA_ORBIT_NEAR_FROM_1M}}var du=(r=>(r.WALK="fps",r.ORBIT="orbit",r))(du||{});const Hx=10,Wx=10,Nm=100,Um=.5,jx=Math.PI/12;class nh{constructor(t){o(this,"activeDirection",0);o(this,"activeSource",0);o(this,"speed",0);o(this,"_maxPerFrameDistance");this._maxPerFrameDistance=t}moves(){return this.activeDirection!==0||this.speed!==0}movesInDirection(t){return this.activeDirection===t||Math.sign(this.speed)===t}activateDirectionFromSource(t,e){this.activeDirection=t,this.activeSource=e}deactivateDirectionFromSource(t,e){this.activeDirection===t&&this.activeSource===e&&(this.activeDirection=0,this.activeSource=e)}deactivateSource(t){this.activeSource===t&&(this.activeDirection=0,this.activeSource=0)}stopInDirection(t){this.activeDirection===t&&(this.activeDirection=0,this.activeSource=0),Math.sign(this.speed)===t&&(this.speed=0)}update(t,e){if(!this.moves())return 0;const i=Math.sign(this.speed),n=this.activeDirection||-i;let s;i===n?s=t/T.CAMERA_FULL_ACCELERATION_TIME:s=t/T.CAMERA_FULL_DECELERATION_TIME;const a=e*n*s,l=e*(this.speed+a/2);return this.speed=Yi(this.speed+a,-t,t),!this.activeDirection&&Math.sign(this.speed)!==i&&(this.speed=0),Yi(l,-this._maxPerFrameDistance,this._maxPerFrameDistance)}}class Xx{constructor(t,e,i,n){o(this,"_camera");o(this,"_domElement");o(this,"_gamepadManager");o(this,"_animationController");o(this,"_enabled",!0);o(this,"_controlMode","fps");o(this,"_moveMaxSpeedFactor",1);o(this,"_moveX",new nh(T.CAMERA_MAX_PER_FRAME_LINEAR_DISTANCE));o(this,"_moveY",new nh(T.CAMERA_MAX_PER_FRAME_LINEAR_DISTANCE));o(this,"_moveZ",new nh(T.CAMERA_MAX_PER_FRAME_LINEAR_DISTANCE));o(this,"_rotationYaw",new nh(jx));o(this,"_pointers",[new ye(0,0),new ye(0,0)]);o(this,"_prevPointers",[new ye(0,0),new ye(0,0)]);o(this,"_scrollDelta",0);o(this,"_gesture",null);o(this,"_gestureStartPointers",[new ye(0,0),new ye(0,0)]);o(this,"_lastPinchTime",0);o(this,"_lastTwoPointerDragTime",0);o(this,"_mousePressed",!1);o(this,"_rollObject",new yt);o(this,"_pitchObject",new yt);o(this,"_yawObject",new yt);o(this,"_hmdResetSinceUpdate",!1);o(this,"_mouseRotation",new L(0,0,0));o(this,"_hmdRotation",new Fi(0,0,0,ys.XYZ));o(this,"_previousMouseRotation",new ye);o(this,"_currentMouseRotation",new ye);o(this,"_targetMouseRotation",new ye);o(this,"_prevCameraPosition",new L);o(this,"_prevCameraRotation",new bi);o(this,"_newCameraPosition",new L);o(this,"_newCameraRotation",new bi);o(this,"_scaleTemp",new L);o(this,"mousePressLook",!1);o(this,"flipMouseLook",!1);o(this,"mouseControlsPitch",!0);o(this,"restrictVerticalAngle",!0);o(this,"verticalAngleMin",-Math.PI/2);o(this,"verticalAngleMax",Math.PI/3);o(this,"arrowsTurn",!0);o(this,"orbit");o(this,"cameraHeight",null);o(this,"cameraPositionUpdated");o(this,"onHmdUpdate");o(this,"_onPointerMove",t=>{if(this._enabled){if(t.preventDefault(),this._savePointerPositions(t),this._gesture!==null){if(this._gesture===3||this._gesture===0&&!this._recognizeGesture())return;if(this._gesture===1){const e=this._prevPointers[1].distanceTo(this._prevPointers[0]),n=this._pointers[1].distanceTo(this._pointers[0])-e;Math.abs(n)>0&&(this._lastPinchTime=Date.now(),this._moveY.activateDirectionFromSource(Math.sign(n),2)),this._animationController.requestFrame()}else if(this._gesture===2&&this._arePointersInHorizontalLine(this._pointers)){const e=this._pointers[0].y-this._prevPointers[0].y;Math.abs(e)>0&&(this._lastTwoPointerDragTime=Date.now(),this._moveZ.activateDirectionFromSource(Math.sign(e),2)),this._animationController.requestFrame()}}else if(this._mouseLookEnabled()||this._isTouchLook(t)){const e=this._mouseMovementX(t),i=this._mouseMovementY(t),n=this.flipMouseLook||this._isTouchLook(t)?1:-1;this._targetMouseRotation.x+=n*e*T.CAMERA_LOOK_SPEED,this.mouseControlsPitch&&(this._targetMouseRotation.y+=n*i*T.CAMERA_LOOK_SPEED),this._animationController.requestFrame()}}});o(this,"_onMouseDown",t=>{this._enabled&&(this._domElement.focus(),t.preventDefault(),this._savePointerPositions(t),this._mousePressed=!0,this._animationController.requestFrame())});o(this,"_onTouchStart",t=>{this._enabled&&(t.preventDefault(),this._savePointerPositions(t),t.touches.length===2?(this._gesture=0,this._gestureStartPointers[0].copyFrom(this._pointers[0]),this._gestureStartPointers[1].copyFrom(this._pointers[1])):t.touches.length>2&&(this._gesture=3))});o(this,"_onMouseUp",t=>{this._enabled&&(t.preventDefault(),this._mousePressed=!1)});o(this,"_onTouchEnd",t=>{this._enabled&&(t.preventDefault(),t.touches.length===0?this._gesture=null:this._gesture=3)});o(this,"_onMouseWheel",t=>{if(!this._enabled||!this._hasFocus())return;t.preventDefault();const e=-t.deltaY/100;this._scrollDelta+=e*T.CAMERA_SCROLL_SPEED,this._scrollDelta=Yi(this._scrollDelta,-Um,Um),this._animationController.requestFrame()});o(this,"_onKeyDown",t=>{let e=!0;if(!(!this._enabled||Sp(t))){switch(this._setMoveMaxSpeedFactor(t.shiftKey),t.code){case"ArrowUp":case"Space":case"KeyW":this._moveY.activateDirectionFromSource(1,1);break;case"ArrowLeft":this.arrowsTurn?this._rotationYaw.activateDirectionFromSource(1,1):this._moveX.activateDirectionFromSource(-1,1);break;case"KeyA":this._moveX.activateDirectionFromSource(-1,1);break;case"ArrowDown":case"KeyS":this._moveY.activateDirectionFromSource(-1,1);break;case"ArrowRight":this.arrowsTurn?this._rotationYaw.activateDirectionFromSource(-1,1):this._moveX.activateDirectionFromSource(1,1);break;case"KeyD":this._moveX.activateDirectionFromSource(1,1);break;case"PageUp":case"KeyE":this._moveZ.activateDirectionFromSource(1,1);break;case"PageDown":case"KeyQ":this._moveZ.activateDirectionFromSource(-1,1);break;default:e=!1;break}e&&(t.preventDefault(),this._animationController.requestFrame())}});o(this,"_onKeyUp",t=>{let e=!0;if(this._enabled){switch(this._setMoveMaxSpeedFactor(t.shiftKey),t.code){case"ArrowUp":case"Space":case"KeyW":this._moveY.deactivateDirectionFromSource(1,1);break;case"ArrowLeft":case"KeyA":this._rotationYaw.deactivateDirectionFromSource(1,1),this._moveX.deactivateDirectionFromSource(-1,1);break;case"ArrowDown":case"KeyS":this._moveY.deactivateDirectionFromSource(-1,1);break;case"ArrowRight":case"KeyD":this._rotationYaw.deactivateDirectionFromSource(-1,1),this._moveX.deactivateDirectionFromSource(1,1);break;case"PageUp":case"KeyE":this._moveZ.deactivateDirectionFromSource(1,1);break;case"PageDown":case"KeyQ":this._moveZ.deactivateDirectionFromSource(-1,1);break;default:e=!1;break}e&&t.preventDefault()}});o(this,"_onGamepadActionActivated",t=>{if(this._enabled)switch(t.action){case Oe.BACKWARD:this._moveY.activateDirectionFromSource(-1,3);break;case Oe.FORWARD:this._moveY.activateDirectionFromSource(1,3);break;case Oe.LEFT:this.arrowsTurn?this._rotationYaw.activateDirectionFromSource(1,3):this._moveX.activateDirectionFromSource(-1,3);break;case Oe.RIGHT:this.arrowsTurn?this._rotationYaw.activateDirectionFromSource(-1,3):this._moveX.activateDirectionFromSource(1,3);break;case Oe.DOWN:this._moveZ.activateDirectionFromSource(-1,3);break;case Oe.UP:this._moveZ.activateDirectionFromSource(1,3);break}});o(this,"_onGamepadActionDeactivated",t=>{if(this._enabled)switch(t.action){case Oe.BACKWARD:this._moveY.deactivateDirectionFromSource(-1,3);break;case Oe.FORWARD:this._moveY.deactivateDirectionFromSource(1,3);break;case Oe.LEFT:this._moveX.deactivateDirectionFromSource(-1,3),this._rotationYaw.deactivateDirectionFromSource(1,3);break;case Oe.RIGHT:this._moveX.deactivateDirectionFromSource(1,3),this._rotationYaw.deactivateDirectionFromSource(-1,3);break;case Oe.DOWN:this._moveZ.deactivateDirectionFromSource(-1,3);break;case Oe.UP:this._moveZ.deactivateDirectionFromSource(1,3);break}});o(this,"_onMouseOut",t=>{this._onMouseUp(t)});o(this,"_onMouseEnter",t=>{t.buttons>0&&this._onMouseDown(t)});o(this,"_onFocusLost",t=>{this._stopAll()});o(this,"_disableContextMenu",t=>{t.preventDefault()});this._camera=t,this._domElement=e,this._gamepadManager=i,this._animationController=n,this._rollObject.add(this._camera),this._pitchObject.add(this._rollObject),this._yawObject.add(this._pitchObject),this.orbit=new Aa(this._camera,this,this._domElement,this._animationController),this._camera.rotation.set(0,0,0),this._camera.up.set(0,0,1),this._camera.lookAt(new L(0,1,0)),this._camera.matrixWorld.decompose(this._prevCameraPosition,this._prevCameraRotation,this._scaleTemp),this._registerEventListeners(),this.cameraPositionUpdated=()=>{this._yawObject.updateMatrixWorld(!0),this._camera.matrixWorld.decompose(this._newCameraPosition,this._newCameraRotation,this._scaleTemp),this._newCameraPosition.equals(this._prevCameraPosition)||(this._camera.onNewPosition(this._newCameraPosition),this._prevCameraPosition.copyFrom(this._newCameraPosition)),this._newCameraRotation.equals(this._prevCameraRotation)||(this._camera.onNewRotation(this._newCameraRotation),this._prevCameraRotation.copyFrom(this._newCameraRotation))},this.onHmdUpdate=(()=>{const s=new L,a=new L,l=new L,c=new L,h=new L;return(d,u)=>{this._enabled&&(this._hmdRotation.copyFrom(d),this._hmdResetSinceUpdate?this._mouseRotation.z-=this._hmdRotation.z:u&&(c.subVectors(u,l),s.set(Math.cos(this._mouseRotation.z),Math.sin(this._mouseRotation.z),0),a.set(-Math.sin(this._mouseRotation.z),Math.cos(this._mouseRotation.z),0),h.copyFrom(s.multiplyScalar(c.x)),h.add(a.multiplyScalar(c.y)),h.z=c.z,this._yawObject.position.add(h)),u&&l.copyFrom(u),this._hmdResetSinceUpdate=!1,this._updateRotation())}})()}isFpsEnabled(){return this._enabled}setControlMode(t){this._controlMode=t,t==="fps"?(this._enabled=!0,this._mousePressed=!1,this.orbit.disable()):(this._enabled=!1,this.orbit.enable())}isOrbitEnabled(){return this.orbit.isEnabled()}orbitModeEnable(){this._enabled=!1,this.orbit.enable()}camera(){return this._camera}applyCameraYaw(t){this._yawObject.rotation.applyToVector3(t)}cameraWorldPosition(){return this._yawObject.position}_updateYaw(){this._yawObject.rotation.z=Zt(this._hmdRotation.z+this._mouseRotation.z)}_updateRotation(){this._updateYaw(),this._pitchObject.rotation.x=Zt(this._hmdRotation.x+this._mouseRotation.x),this._rollObject.rotation.y=this._hmdRotation.y,this._yawObject.updateMatrixWorld(!0)}resetRollAngle(){this._rollObject.rotation.y!==0&&(this._hmdRotation.y=0,this._updateRotation())}getPitchAngle(){return this._pitchObject.rotation.x}setPitchAngle(t){t!==this._pitchObject.rotation.x&&(this._mouseRotation.x=t,this._hmdRotation.x=0,this._updateRotation())}resetPitchAngle(){this.setPitchAngle(0)}getYawAngle(){return this._yawObject.rotation.z}setYawAngle(t){t!==this._yawObject.rotation.z&&(this._mouseRotation.z=t,this._hmdRotation.z=0,this._updateRotation())}resetYawAngle(){this.setYawAngle(0)}isHandlingGesture(){return this._gesture!==null}_mouseLookEnabled(){return!this.mousePressLook||this._mousePressed}_isTouchLook(t){return!this._gesture&&hr(t)}_arePointersInHorizontalLine(t){return Math.abs(t[0].y-t[1].y)<=T.MAX_TWO_POINTERS_IN_LINE_DIFF}_recognizeGesture(){const t=this._gestureStartPointers[0].distanceTo(this._gestureStartPointers[1]),e=this._pointers[0].distanceTo(this._pointers[1]);return Math.abs(e-t)>=Hx?(this._gesture=1,!0):this._arePointersInHorizontalLine(this._pointers)&&this._arePointersInHorizontalLine(this._gestureStartPointers)&&Math.abs(this._pointers[0].y-this._gestureStartPointers[0].y)>=Wx?(this._gesture=2,!0):!1}_savePointerPositions(t){this._prevPointers[0].copyFrom(this._pointers[0]),this._prevPointers[1].copyFrom(this._pointers[1]),hr(t)?(this._pointers[0].set(t.touches[0].clientX,t.touches[0].clientY),t.touches.length===2?this._pointers[1].set(t.touches[1].clientX,t.touches[1].clientY):this._pointers[1].set(0,0)):(this._pointers[0].set(t.clientX,t.clientY),this._pointers[1].set(0,0))}_restrictVerticalAngle(t){t.x>this.verticalAngleMax?t.x=this.verticalAngleMax:t.x<this.verticalAngleMin&&(t.x=this.verticalAngleMin)}_mouseRotationNeedsUpdate(){return this._currentMouseRotation.distanceTo(this._targetMouseRotation)>1e-4}_updateMouseRotation(t){if(!this._mouseRotationNeedsUpdate()){this._previousMouseRotation.set(0,0),this._currentMouseRotation.set(0,0),this._targetMouseRotation.set(0,0);return}const e=Math.min(t/T.CAMERA_LOOK_SMOOTHING,1);this._currentMouseRotation.lerp(this._targetMouseRotation,e),this._mouseRotation.z+=this._currentMouseRotation.x-this._previousMouseRotation.x,this._mouseRotation.x+=this._currentMouseRotation.y-this._previousMouseRotation.y,this.restrictVerticalAngle&&this._restrictVerticalAngle(this._mouseRotation),this._updateRotation(),this._previousMouseRotation.copyFrom(this._currentMouseRotation),this._animationController.requestFrame()}_mouseMovementX(t){let e=hr(t)?void 0:t.movementX;return e===void 0&&(e=this._pointers[0].x-this._prevPointers[0].x),e}_mouseMovementY(t){let e=hr(t)?void 0:t.movementY;return e===void 0&&(e=this._pointers[0].y-this._prevPointers[0].y),e}hmdReset(){this._hmdResetSinceUpdate=!0,this.resetPitchAngle()}_hasFocus(){return document.hasFocus!==void 0?document.hasFocus():document.activeElement===this._domElement}_setMoveMaxSpeedFactor(t){t?this._moveMaxSpeedFactor=T.CAMERA_MOVE_MAX_SPEED_SHIFT_FACTOR:this._moveMaxSpeedFactor=1}_moveMaxSpeed(){return this._camera.moveMaxSpeed*this._moveMaxSpeedFactor}maxFrameMoveLinearDistance(t){return Math.min(t*this._moveMaxSpeed(),T.CAMERA_MAX_PER_FRAME_LINEAR_DISTANCE)}movesForward(){return this._moveY.movesInDirection(1)||this._scrollDelta>0}stopForward(){this._scrollDelta>0&&(this._scrollDelta=0),this._moveY.stopInDirection(1)}movesBackward(){return this._moveY.movesInDirection(-1)||this._scrollDelta<0}stopBackward(){this._scrollDelta<0&&(this._scrollDelta=0),this._moveY.stopInDirection(-1)}movesLeft(){return this._moveX.movesInDirection(-1)}stopLeft(){this._moveX.stopInDirection(-1)}movesRight(){return this._moveX.movesInDirection(1)}stopRight(){this._moveX.stopInDirection(1)}movesUp(){return this._moveZ.movesInDirection(1)}stopUp(){this._moveZ.stopInDirection(1)}movesDown(){return this._moveZ.movesInDirection(-1)}stopDown(){this._moveZ.stopInDirection(-1)}_stopTurnLeft(){this._rotationYaw.stopInDirection(1)}_stopTurnRight(){this._rotationYaw.stopInDirection(-1)}enable(){this._controlMode==="fps"?(this._enabled=!0,this._mousePressed=!1):this.orbit.enable()}_moves(){return this._moveX.moves()||this._moveY.moves()||this._moveZ.moves()||this._rotationYaw.moves()||this._scrollDelta!==0}_stopAll(){this.stopForward(),this.stopBackward(),this.stopLeft(),this.stopRight(),this.stopUp(),this.stopDown(),this._stopTurnLeft(),this._stopTurnRight()}_updateScroll(t,e){let i=0;if(e)return this._scrollDelta=0,e;if(this._scrollDelta){const n=this.maxFrameMoveLinearDistance(t);i=Yi(this._scrollDelta,-n,n),this._scrollDelta-=i}return i}disable(){this._controlMode==="fps"?this._enabled=!1:this.orbit.disable(),this._stopAll()}update(t){if(this._controlMode==="orbit"){this.orbit.update(t);return}this._updateMouseRotation(t),this._moveY.activeSource===2&&Date.now()-this._lastPinchTime>Nm&&this._moveY.deactivateSource(2),this._moveZ.activeSource===2&&Date.now()-this._lastTwoPointerDragTime>Nm&&this._moveZ.deactivateSource(2);const e=this._moveX.update(this._moveMaxSpeed(),t);let i=this._moveY.update(this._moveMaxSpeed(),t);const n=this._moveZ.update(this._moveMaxSpeed(),t);i=this._updateScroll(t,i),this._yawObject.translateX(e),this._yawObject.translateY(i),this._yawObject.translateZ(n);const s=this._rotationYaw.update(T.CAMERA_ARROWS_TURN_SPEED,t);this._mouseRotation.z+=s,this._updateYaw(),this._moves()&&this._animationController.requestFrame(),this.cameraPositionUpdated()}_registerEventListeners(){this._domElement.setAttribute("tabindex",-1),this._domElement.addEventListener("contextmenu",this._disableContextMenu,!1),this._domElement.addEventListener("mousedown",this._onMouseDown,!1),this._domElement.addEventListener("touchstart",this._onTouchStart,!1),this._domElement.addEventListener("mousemove",this._onPointerMove,!1),this._domElement.addEventListener("touchmove",this._onPointerMove,!1),this._domElement.addEventListener("mouseup",this._onMouseUp,!1),this._domElement.addEventListener("touchend",this._onTouchEnd,!1),this._domElement.addEventListener("keydown",this._onKeyDown,!1),this._domElement.addEventListener("keyup",this._onKeyUp,!1),this._domElement.addEventListener("mouseout",this._onMouseOut,!1),this._domElement.addEventListener("mouseenter",this._onMouseEnter,!1),this._domElement.addEventListener("wheel",this._onMouseWheel,!1),this._domElement.addEventListener("blur",this._onFocusLost,!1),this._gamepadManager.addEventListener(Oo.actionActivated,this._onGamepadActionActivated),this._gamepadManager.addEventListener(Oo.actionDeactivated,this._onGamepadActionDeactivated)}isEnabled(){return this._controlMode==="fps"?this._enabled:this.orbit.isEnabled()}}/*!
 * Copyright (C) 2020-present Shapespark
 */var km=(r=>(r.MODE_DISABLED="modeDisabled",r.MODE_ENABLED="modeEnabled",r))(km||{});const fc=class fc extends ci{constructor(){super();o(this,"modeEnabled");this.modeEnabled=!1}enableMode(){this.modeEnabled=!0,this.dispatchEvent({type:fc.eventType.MODE_ENABLED})}disableMode(){this.modeEnabled=!1,this.dispatchEvent({type:fc.eventType.MODE_DISABLED})}modeIsEnabled(){return this.modeEnabled}};o(fc,"eventType",km);let xr=fc;/*!
 * Copyright (C) 2017-present Shapespark
 */console.assert(T.GAZE_POINTER_SHOW_LOADING_AFTER_S<=T.GAZE_POINTER_ACTIVATE_AFTER_S);const Vm=Math.PI/60;function qx(){const r=new tn,t=new Float32Array(2*3*3);return r.addAttribute("position",new Dt(t,3)),t[0]=.05,t[1]=-.05,t[2]=-2,t[3]=.05,t[4]=.05,t[5]=-2,t[6]=-.05,t[7]=-.05,t[8]=-2,t[9]=.05,t[10]=.05,t[11]=-2,t[12]=-.05,t[13]=.05,t[14]=-2,t[15]=-.05,t[16]=-.05,t[17]=-2,r.computeBoundingSphere(),r}class Yx{constructor(t,e,i,n){o(this,"_scene");o(this,"_controls");o(this,"_requestFrame");o(this,"_gazePointerEnabled");o(this,"_startPitch");o(this,"_startYaw");o(this,"_gazeTime");o(this,"_gazeStarted");o(this,"_pointer");o(this,"_handleGazeStart");o(this,"_handleGazeEnd");o(this,"update",t=>{var n,s;if(!this._gazePointerEnabled)return;const e=this._controls.getPitchAngle(),i=this._controls.getYawAngle();if(this._startPitch===void 0)this._startPitch=e,this._startYaw=i;else if(Math.abs(this._startPitch-e)>Vm||Math.abs(this._startYaw-i)>Vm)this._resetUnconditionally();else{if(this._gazeTime,this._gazeTime+=t,this._gazeTime<T.GAZE_POINTER_SHOW_LOADING_AFTER_S)return;if(!this._gazeStarted)(n=this._handleGazeStart)!=null&&n.call(this)?this._gazeStarted=!0:this._resetUnconditionally();else{this._pointer;const a=T.GAZE_POINTER_ACTIVATE_AFTER_S-T.GAZE_POINTER_SHOW_LOADING_AFTER_S;this._pointer.setCircleSpan(Math.min((this._gazeTime-T.GAZE_POINTER_SHOW_LOADING_AFTER_S)/a,1)),this._gazeTime>=T.GAZE_POINTER_ACTIVATE_AFTER_S&&((s=this._handleGazeEnd)==null||s.call(this),this._resetUnconditionally())}}});this._scene=t,this._controls=e,this._requestFrame=i,this._gazePointerEnabled=n.modeIsEnabled(),n.addEventListener(xr.eventType.MODE_DISABLED,()=>{this._gazePointerEnabled=!1,this._reevaluateState()}),n.addEventListener(xr.eventType.MODE_ENABLED,()=>{this._gazePointerEnabled=!0,this._reevaluateState()}),this._reevaluateState()}setGazeHandlers(t,e){this._handleGazeStart=t,this._handleGazeEnd=e}_resetUnconditionally(){var t;this._startPitch=this._startYaw=void 0,this._gazeTime=0,this._gazeStarted=!1,(t=this._pointer)==null||t.setCircleSpan(0)}_reevaluateState(){var t;if(!this._gazePointerEnabled)this._resetUnconditionally();else if(!this._pointer){const e=new Wy,i=new je(qx(),e);this._scene.addAuxiliaryObject(i),i.frustumCulled=!1,i.matrixWorld=this._controls.camera().matrixWorld,this._pointer={setVisible:n=>{i.visible=n,this._requestFrame()},setCircleSpan:n=>{e.circleSpan=n,this._requestFrame()}},this._resetUnconditionally()}(t=this._pointer)==null||t.setVisible(this._gazePointerEnabled)}reset(){this._startPitch!==void 0&&this._resetUnconditionally()}}/*!
 * Copyright (C) 2018-present Shapespark
 */class Qx{constructor(t,e){o(this,"_scene");o(this,"_teleport");o(this,"_hashChanged",()=>{const t=T.urlHashGetArgument("view");if(t){const e=this._scene.findViewByName(t);e&&(this._teleport.switchToView(e),window.location.hash=T.urlHashRemoveArgument("view"))}});this._scene=t,this._teleport=e,window.addEventListener("hashchange",this._hashChanged,!1)}dispose(){window.removeEventListener("hashchange",this._hashChanged,!1)}}const zm=.03,Kx=500;class sh{constructor(t,e){o(this,"callbacks");o(this,"_pointerEventDispatcher");o(this,"_priority");o(this,"_isPotentialClick");o(this,"_pointerDownClip");o(this,"_lastClickClip");o(this,"_lastClickTime");o(this,"_enabled");o(this,"_onPointerDown",(t,e)=>{var n,s;const i=(s=(n=this.callbacks).onPointerDown)==null?void 0:s.call(n,t,e);return this._isPotentialClick=!0,this._pointerDownClip=[t,e],i});o(this,"_onPointerUp",(t,e,i)=>{var l,c,h,d;let n=(c=(l=this.callbacks).onPointerUp)==null?void 0:c.call(l,t,e);if(!this._isPotentialClick)return n;const s=Date.now();return this._lastClickTime!==void 0&&this._isWithinMaxClickMoveDiff(this._pointerDownClip,this._lastClickClip)&&this._isWithinMaxDoubleClickBreak(this._lastClickTime,s)&&this.callbacks.onDoubleClick?n=this.callbacks.onDoubleClick(t,e)||n:n=((d=(h=this.callbacks).onClick)==null?void 0:d.call(h,t,e,i))||n,this._lastClickTime=s,this._lastClickClip=[t,e],n});o(this,"_onPointerMove",(t,e)=>{var n,s;const i=(s=(n=this.callbacks).onPointerMove)==null?void 0:s.call(n,t,e);return this._isPotentialClick&&!this._isWithinMaxClickMoveDiff(this._pointerDownClip,[t,e])&&(this._isPotentialClick=!1,this._lastClickTime=void 0),i});this._pointerEventDispatcher=t,this._priority=e,this._isPotentialClick=!1,this._pointerDownClip=void 0,this._lastClickClip=void 0,this._lastClickTime=void 0,this._enabled=!1,this.callbacks={onClick:void 0,onDoubleClick:void 0,onPointerDown:void 0,onPointerUp:void 0,onPointerMove:void 0},this.enable()}_isWithinMaxClickMoveDiff(t,e){return Math.abs(t[0]-e[0])<=zm&&Math.abs(t[1]-e[1])<=zm}_isWithinMaxDoubleClickBreak(t,e){return Math.abs(t-e)<=Kx}_registerEventListeners(){this._pointerEventDispatcher.addPointerDownListener(this._onPointerDown,this._priority),this._pointerEventDispatcher.addPointerUpListener(this._onPointerUp,this._priority),this._pointerEventDispatcher.addPointerMoveListener(this._onPointerMove,this._priority)}_unregisterEventListeners(){this._pointerEventDispatcher.removePointerDownListener(this._onPointerDown),this._pointerEventDispatcher.removePointerUpListener(this._onPointerUp),this._pointerEventDispatcher.removePointerMoveListener(this._onPointerMove)}isEnabled(){return this._enabled}enable(){this._enabled||(this._registerEventListeners(),this._enabled=!0)}disable(){this._enabled&&(this._unregisterEventListeners(),this._enabled=!1)}}class $x{constructor(t,e,i,n,s,a,l,c){o(this,"_collider");o(this,"_requestFrame");o(this,"_clickListeners");o(this,"_doubleClickListeners");o(this,"_hoverListeners");o(this,"_gamepadManager");o(this,"_gazePointer");o(this,"_gazeTargetIntersection");o(this,"_hoveredMesh");o(this,"_enabled");o(this,"_lastClipX");o(this,"_lastClipY");o(this,"_helper");o(this,"_callbacks");o(this,"_clickIntersection");o(this,"onGamepadActionActivated",t=>{this._gazePointer&&this._gazePointer.reset(),t.action===Oe.TRIGGER&&this.handleClick(0,0,!1)});this._collider=e,this._requestFrame=i,this._clickListeners=n,this._doubleClickListeners=s,this._hoverListeners=a,this._gamepadManager=l,this._gazePointer=c,this._gazeTargetIntersection=new yr,this._hoveredMesh=void 0,this._enabled=!1,this._lastClipX=void 0,this._lastClipY=void 0,this._gazePointer&&this._gazePointer.setGazeHandlers(()=>this.handleGazeStart(),()=>this.handleGazeEnd()),this._helper=new sh(t,T.POINTER_PRIORITY.INTERACTION_DISPATCHER),this._callbacks=this._helper.callbacks,this._clickIntersection=new yr,this._callbacks.onPointerMove=(h,d)=>(console.assert(this._enabled),this._hoverListeners.empty()||(this._lastClipX=h,this._lastClipY=d,this._requestFrame()),!1),this._callbacks.onClick=(h,d)=>this.handleClick(h,d,!1),this._callbacks.onDoubleClick=(h,d)=>this.handleClick(h,d,!0),this._gamepadManager.addEventListener(Oo.actionActivated,this.onGamepadActionActivated),this.enable()}dispatchClick(t,e){if(!e.object)return!1;const i=t?this._doubleClickListeners:this._clickListeners;for(const n of i)if(n(e.object,e.point,e.distance))return!0;return!1}handleGazeStart(){return this._collider.findIntersectionAtPosition(0,0,!0,this._gazeTargetIntersection)}handleGazeEnd(){this.dispatchClick(!1,this._gazeTargetIntersection)}handleClick(t,e,i){return this._gazePointer&&this._gazePointer.reset(),this._collider.findIntersectionAtPosition(t,e,!0,this._clickIntersection)?this.dispatchClick(i,this._clickIntersection):!1}handleHover(){if(!this._enabled||this._hoverListeners.empty()||this._lastClipX===void 0||this._lastClipY===void 0)return;const t=this._collider.findObstacleMeshAtPosition(this._lastClipX,this._lastClipY,!0);if(t===null){this._hoveredMesh&&(this._hoverListeners.invoke(this._hoveredMesh,!1),this._hoveredMesh=void 0);return}t!==this._hoveredMesh&&(this._hoveredMesh&&this._hoverListeners.invoke(this._hoveredMesh,!1),this._hoverListeners.invoke(t,!0),this._hoveredMesh=t)}enable(){this._enabled=!0,this._helper.enable(),console.assert(this._hoveredMesh===void 0)}disable(){this._enabled=!1,this._hoveredMesh!==void 0&&(this._hoverListeners.invoke(this._hoveredMesh,!1),this._hoveredMesh=void 0),this._helper.disable()}dispose(){this.disable(),this._gamepadManager.removeEventListener(Oo.actionActivated,this.onGamepadActionActivated)}}function Zx(r){return r&1}function Jx(r){return r&2}function eE(r){return r&4}class tE{constructor(t,e){o(this,"_domElement");o(this,"_editMode");o(this,"_pointerDownListeners",new Array);o(this,"_pointerUpListeners",new Array);o(this,"_pointerMoveListeners",new Array);o(this,"_isPointerDown",!1);o(this,"_firstTouchIdentifier",-1);o(this,"_tmpClip",{clipX:0,clipY:0});o(this,"_enabled",!1);o(this,"_onPointerDown",t=>{this._extractButton(t)===0&&(this._isPointerDown||(this._isPointerDown=!0,hr(t)&&(console.assert(t.changedTouches.length>0),this._firstTouchIdentifier=t.changedTouches[0].identifier),this._dispatchEvent(this._pointerDownListeners,t)))});o(this,"_onPointerUp",t=>{if(this._extractButton(t)!==0)return;const i=hr(t);i&&this._findTouch(t,this._firstTouchIdentifier,!0)||this._isPointerDown&&(this._isPointerDown=!1,this._dispatchEvent(this._pointerUpListeners,t),i&&(this._firstTouchIdentifier=-1))});o(this,"_onPointerMove",t=>{hr(t)&&this._firstTouchIdentifier===-1||this._dispatchEvent(this._pointerMoveListeners,t)});this._domElement=t,this._editMode=e,this.enable()}_extractButton(t){if(hr(t)||t.button===void 0)return 0;switch(t.button){case 0:return 0;case 1:return 1;case 2:return 2}return-1}_isPointerLockActive(){const t=document;return!!(t.pointerLockElement||t.mozPointerLockElement||t.webkitPointerLockElement)}_findTouch(t,e,i=!1){if(!i)for(let n=0;n<t.changedTouches.length;n++){const s=t.changedTouches[n];if(s.identifier===e)return s}for(let n=0;n<t.touches.length;n++){const s=t.touches[n];if(s.identifier===e)return s}}_extractPosition(t){let e=0,i=0;const n=hr(t);if(!n&&this._isPointerLockActive())return this._tmpClip.clipX=0,this._tmpClip.clipY=0,this._tmpClip;if(n){const s=this._findTouch(t,this._firstTouchIdentifier);nt(s!==void 0),e=s.clientX,i=s.clientY}else e=t.clientX,i=t.clientY;return this._tmpClip.clipX=e/window.innerWidth*2-1,this._tmpClip.clipY=-(i/window.innerHeight)*2+1,this._tmpClip}_getEventKeyModifiers(t){let e=0;return(t.ctrlKey&&!$e.mac||t.metaKey&&$e.mac)&&(e|=2),t.altKey&&(e|=4),t.shiftKey&&(e|=1),e}_dispatchEvent(t,e){if(t.length===0)return;const i=this._extractPosition(e);for(const n of t)if(n.callback(i.clipX,i.clipY,this._getEventKeyModifiers(e)))return}_registerEventListeners(){this._domElement.addEventListener("mousedown",this._onPointerDown,!1),this._domElement.addEventListener("touchstart",this._onPointerDown,!1),this._domElement.addEventListener("mouseup",this._onPointerUp,!1),this._domElement.addEventListener("touchend",this._onPointerUp,!1),this._domElement.addEventListener("mousemove",this._onPointerMove,!1),this._domElement.addEventListener("touchmove",this._onPointerMove,!1),window.addEventListener("mouseup",this._onPointerUp,!1),this._editMode&&window.top.addEventListener("mouseup",this._onPointerUp,!1)}_unregisterEventListeners(){this._domElement.removeEventListener("mousedown",this._onPointerDown,!1),this._domElement.removeEventListener("touchstart",this._onPointerDown,!1),this._domElement.removeEventListener("mouseup",this._onPointerUp,!1),this._domElement.removeEventListener("touchend",this._onPointerUp,!1),this._domElement.removeEventListener("mousemove",this._onPointerMove,!1),this._domElement.removeEventListener("touchmove",this._onPointerMove,!1),window.removeEventListener("mouseup",this._onPointerUp,!1),this._editMode&&window.top.removeEventListener("mouseup",this._onPointerUp,!1)}_addListener(t,e,i){const n=t.filter(l=>l.callback===e);console.assert(n.length===0,"Do not add the same callback twice!");const s={callback:e,priority:i};let a=0;for(a=0;a<t.length;a+=1){const l=t[a];if(s.priority<=l.priority){if(s.priority===l.priority){console.error("Adding two listeners with the same priority is not allowed!");return}break}}t.splice(a,0,s)}addPointerDownListener(t,e){this._addListener(this._pointerDownListeners,t,e)}removePointerDownListener(t){this._pointerDownListeners=this._pointerDownListeners.filter(e=>e.callback!==t)}addPointerUpListener(t,e){this._addListener(this._pointerUpListeners,t,e)}removePointerUpListener(t){this._pointerUpListeners=this._pointerUpListeners.filter(e=>e.callback!==t)}addPointerMoveListener(t,e){this._addListener(this._pointerMoveListeners,t,e)}removePointerMoveListener(t){this._pointerMoveListeners=this._pointerMoveListeners.filter(e=>e.callback!==t)}isEnabled(){return this._enabled}enable(){this._enabled||(this._registerEventListeners(),this._enabled=!0)}disable(){this._enabled&&(this._unregisterEventListeners(),this._enabled=!1)}}const uu=.005,iE=.02,nE=[new ye(0,1),new ye(1,0),new ye(-1,0),new ye(0,-1)];class sE{constructor(t,e,i){o(this,"collider");o(this,"controls");o(this,"animationController");o(this,"enabled",!0);o(this,"toGround",1/0);o(this,"cameraPosition");o(this,"prevCameraPosition",new L);this.collider=t,this.controls=e,this.animationController=i,this.cameraPosition=this.controls.cameraWorldPosition(),this.enable()}_heightNeedsUpdate(){const t=this.controls.cameraHeight;return t===null?!1:this.toGround<t-uu||this.toGround>t+uu}_calculateGroundDistance(t,e,i){const a=new L,l=[t];return nE.forEach(c=>{a.copyFrom(e),a.x+=c.x*.1,a.y+=c.y*.1;const h=this.collider.distanceToGroundFrom(a,i*(1+.1));isFinite(h)&&l.push(h)}),l.reduce((c,h)=>Math.min(c,h),1/0)}updateCameraHeight(t){if(!this.enabled)return;const e=this.cameraPosition.z-this.prevCameraPosition.z;if(this.cameraPosition.x!==this.prevCameraPosition.x||this.cameraPosition.y!==this.prevCameraPosition.y?this.toGround=this.collider.distanceToGround(T.MAX_GROUND_SEARCH_DEPTH):this.toGround!==1/0&&(this.toGround+=e),this.toGround!==1/0&&(this.controls.cameraHeight!==null?(this.controls.cameraHeight+=e,this.controls.cameraHeight=Math.max(iE,this.controls.cameraHeight)):this.controls.cameraHeight=this.toGround,this._heightNeedsUpdate())){const n=Math.sqrt(Math.pow(this.cameraPosition.x-this.prevCameraPosition.x,2)+Math.pow(this.cameraPosition.y-this.prevCameraPosition.y,2))/t,s=Math.max(1.5*n,T.CAMERA_DEFAULT_MOVE_MAX_SPEED),a=this.controls.cameraHeight;this.toGround=this._calculateGroundDistance(this.toGround,this.cameraPosition,a);let l=Math.min(s*t,Math.abs(this.toGround-a));this.toGround>a&&(l=-l),(l<0||this.collider.distanceToCeiling(l+T.MIN_DISTANCE_TO_CEILING)===1/0&&Math.abs(l)>uu)&&(this.cameraPosition.z+=l,this.toGround+=l,this.animationController.requestFrame())}this.prevCameraPosition.copyFrom(this.cameraPosition)}enable(){this.enabled=!0,this.toGround=this.collider.distanceToGround(T.MAX_GROUND_SEARCH_DEPTH),this.toGround!==1/0?this.controls.cameraHeight=this.toGround:this.controls.cameraHeight=null,this.prevCameraPosition.copyFrom(this.cameraPosition)}disable(){this.enabled=!1}isEnabled(){return this.enabled}}/*!
 * Copyright (C) 2019-present Shapespark
 */class rE{constructor(t,e){o(this,"_controls");o(this,"_collider");o(this,"_enabled",!1);o(this,"_prevCameraPositionZ");o(this,"_cameraPosition");o(this,"_receivedHmdPosition",!1);this._controls=t,this._collider=e,this._cameraPosition=t.cameraWorldPosition()}onHmdPositionUpdate(t){this._enabled&&!this._receivedHmdPosition&&t.z>1&&(this._controls.cameraHeight=t.z,this._collider.adjustPointToMatchCameraHeight(this._cameraPosition),this._controls.cameraPositionUpdated(),this._prevCameraPositionZ=this._cameraPosition.z,this._receivedHmdPosition=!0)}onTeleportDone(){this._enabled&&(this._prevCameraPositionZ=this._cameraPosition.z)}updateCameraHeight(){this._enabled&&(this._controls.cameraHeight!==null&&(this._controls.cameraHeight+=this._cameraPosition.z-this._prevCameraPositionZ),this._prevCameraPositionZ=this._cameraPosition.z)}enable(){this._enabled=!0,this._controls.cameraHeight=this._collider.cameraHeightFromPoint(this._cameraPosition),this._controls.cameraHeight===null&&(this._controls.cameraHeight=T.FALLBACK_CAMERA_HEIGHT),this._prevCameraPositionZ=this._cameraPosition.z,this._receivedHmdPosition=!1}disable(){this._enabled=!1,this._controls.cameraHeight=null}}const oE=.025,Gm=1,Hm=.3,aE=1-Hm,lE=.4;class cE{constructor(t,e){o(this,"autoExposureEnabled",!1);o(this,"_camera");o(this,"_cameraExposureDelta",0);o(this,"_cameraExposureDeltaPerS",0);o(this,"_cameraExposureDeltaSign",0);o(this,"_currentTargetExposure",0);o(this,"_lastId",0);o(this,"_idToGammaAndExposure",{});o(this,"_idToPriority",{});o(this,"_idsInOrder");o(this,"_lumaMeter");this._camera=t,this._camera.addEventListener(At.eventType.UPDATED,()=>this._updateTargetExposureAndGamma()),this._lastId=0,this._idToGammaAndExposure={},this._idToPriority={},this._idsInOrder=[],this._lumaMeter=e}setPriority(t,e){this._idToPriority[t]=e}adaptExposure(t=!1,e=!1){if(!(!e&&!this.autoExposureAppliable()))if(T.DEV_NEW_RENDER_ARCHITECTURE&&!t)this._lumaMeter.onAsyncIncidentAndReflectedLuma((i,n)=>{this._onLumaMeasured(i,n,!1)});else{const i=this._lumaMeter.measureIncidentLuma(),n=this._lumaMeter.measureReflectedLuma();this._onLumaMeasured(i,n,t)}}_onLumaMeasured(t,e,i){const n=t*Hm+e*aE,s=Math.pow(n,lE),a=this._camera.autoExposureLumaTarget,l=Math.log2(a/s);this._setTargetExposure(l),this._cameraExposureDelta<oE&&(this._cameraExposureDelta=0),i&&this.updateWithoutDelay()}exposureNeedsUpdate(){return this._cameraExposureDelta>0}addManualExposure(t,e,i){return i==null&&(i=this._lastId++),this._idToGammaAndExposure[i]={gamma:e,exposure:t},this._idsInOrder.push(i),this._updateTargetExposureAndGamma(),i}updateManualExposure(t,e,i){this._idToGammaAndExposure[i]&&(this._idToGammaAndExposure[i]={gamma:e,exposure:t},this._updateTargetExposureAndGamma(),this.updateWithoutDelay())}removeManualExposure(t){this._idToGammaAndExposure[t]&&(delete this._idToGammaAndExposure[t],this._idsInOrder.splice(this._idsInOrder.findIndex(e=>e===t),1),this._updateTargetExposureAndGamma())}update(t){if(!this.exposureNeedsUpdate())return;const e=Math.min(this._cameraExposureDeltaPerS*t,this._cameraExposureDelta);this._cameraExposureDelta-=e,this._cameraExposureDelta<1e-5?(this._cameraExposureDelta=0,this._camera.exposure=this._currentTargetExposure):this._camera.exposure+=e*this._cameraExposureDeltaSign}updateWithoutDelay(){this.update(Gm)}autoExposureAppliable(){return this.autoExposureEnabled&&this._camera.autoExposure&&!this._manualExposureApplied()}enableAutoExposure(){this.autoExposureEnabled=!0}disableAutoExposure(){this.autoExposureEnabled=!1}_manualExposureApplied(){return this._idsInOrder.length>0}_setTargetExposure(t){this._currentTargetExposure=t,this._cameraExposureDelta=t-this._camera.exposure,this._cameraExposureDeltaSign=Math.sign(this._cameraExposureDelta),this._cameraExposureDelta=Math.abs(this._cameraExposureDelta),this._cameraExposureDeltaPerS=this._cameraExposureDelta/Gm}_setTargetExposureAndGamma(t,e){this._setTargetExposure(t),this._camera.gamma=e}_getActiveId(){this._idsInOrder.length>0;let t=1/0,e=this._idsInOrder.at(0);for(const i of this._idsInOrder){const n=this._idToPriority[i]!==void 0?this._idToPriority[i]:1/0;n<t&&(e=i,t=n)}return e}_updateTargetExposureAndGamma(){if(!this._manualExposureApplied()){if(this._camera.autoExposure){this._camera.gamma=this._camera.defaultGamma;return}this._setTargetExposureAndGamma(this._camera.defaultExposure,this._camera.defaultGamma);return}const t=this._idToGammaAndExposure[this._getActiveId()];this._setTargetExposureAndGamma(t.exposure,t.gamma)}}class rh{static updateProjectionFromCamera(t,e,i){t.viewportSize=i!=null?i:new ye(e.physicalWidth,e.physicalHeight),t.near=e.current.near,t.far=e.current.far,e.current instanceof Xs?(t.isPerspective=!0,t.fov=e.current.fov):(t.isPerspective=!1,t.left=e.current.left,t.right=e.current.right,t.top=e.current.top,t.bottom=e.current.bottom)}}const Ys=256,hE=16*16,dE=.3,uE=.04;class fE{constructor(t,e){o(this,"_rawRenderer");o(this,"_camera");o(this,"_scene");o(this,"_sceneRenderTarget");o(this,"_autoClearAlter");o(this,"_targetBuf",new Uint8Array(4*Ys*Ys));o(this,"_currentTargetSize",new ye(Ys,Ys));o(this,"_histogram",new Uint32Array(255*256));o(this,"_incidentLumaMaterial");o(this,"_reflectedLumaMaterial");o(this,"_asyncReadInProgress",!1);this._rawRenderer=t,this._camera=e.camera,this._scene=e,this._sceneRenderTarget=this._rawRenderer.createRenderTarget(Ys,Ys,{minFilter:H.NEAREST,magFilter:H.NEAREST,stencilBuffer:!1,generateMipmaps:!1}),this._autoClearAlter=new br(this._rawRenderer),this._incidentLumaMaterial=new Zd(!0,this._scene.sharedMaterialState),this._reflectedLumaMaterial=new Zd(!1,this._scene.sharedMaterialState)}isAsyncReadInProgress(){return this._asyncReadInProgress}measureLuma(t,e,i){var s;const n=t?this._incidentLumaMaterial:this._reflectedLumaMaterial;if(T.DEV_NEW_RENDER_ARCHITECTURE){!e||this._asyncReadInProgress,this._asyncReadInProgress=e!==void 0;const a=this._camera,l=Ys,c=Math.floor(Ys/a.aspectRatio);(this._currentTargetSize.x!==l||this._currentTargetSize.y!==c)&&(this._currentTargetSize.set(l,c),this._targetBuf=new Uint8Array(4*l*c));const h=new em;h.resultBuffer=this._targetBuf,h.renderIncidentLuma=t;const d=h.projectionComp;if(rh.updateProjectionFromCamera(d,a,new ye(l,c)),h.cameraPosition.copyFrom(a.getWorldPosition()),a.current.getWorldQuaternion(h.cameraRotation),h.debugSpectorCapture=(s=i==null?void 0:i.debugCapture)!=null?s:!1,e&&(h.asyncCallback=u=>{this._targetBuf,this._asyncReadInProgress=!1;const f=this._computeMeanLuma();i&&i.onLumaMeasured(f,this._currentTargetSize,this._targetBuf,t),e(f)}),pt.get().render(h),e)return-1;{const u=this._computeMeanLuma();return i&&i.onLumaMeasured(u,this._currentTargetSize,this._targetBuf,t),u}}else{this._autoClearAlter.set(!0,!0,!1);const a=this._scene.gpuMeshes.filter(l=>!l.material.transparent);return this._rawRenderer.renderMeshes(a,n,this._camera,this._sceneRenderTarget),this._rawRenderer.readPixels(Ys,Ys,this._targetBuf),this._rawRenderer.setRenderTarget(null),this._autoClearAlter.restore(),this._computeMeanLuma()}}_computeMeanLuma(){const t=this._targetBuf;let e=0,i=0;const n=this._currentTargetSize.x*this._currentTargetSize.y;for(let c=0;c<n;++c){const h=c*4,d=t[h]+t[h+1]*255;d!==0&&(i+=1,this._histogram[d]+=1,e=Math.max(e,d))}if(i<hE)return-1;let s=0,a=0;for(let c=1;c<=e;++c){const h=Math.floor(dE*i-s),d=Math.min(h,this._histogram[c]);if(this._histogram[c]-=d,s+=d,d===h)break}for(let c=e;c>=0;--c){const h=Math.floor(uE*i-a),d=Math.min(h,this._histogram[c]);if(this._histogram[c]-=d,a+=d,d===h)break}let l=0;for(let c=1;c<=e;++c){const d=c/8160;l+=this._histogram[c]*Math.log(d),this._histogram[c]=0}return Math.exp(l/(i-s-a))}}class pE{constructor(){o(this,"lastIncidentLuma",-1);o(this,"lastReflectedLuma",-1);o(this,"debugCapture",!1);o(this,"dumpResultName");o(this,"_dumpedSyncResultCounter",0)}onLumaMeasured(t,e,i,n){n?this.lastIncidentLuma=t:this.lastReflectedLuma=t,this.dumpResultName&&Lc(Wc(e.x,e.y,i),`${n?"incident":"reflected"}${this.dumpResultName}.tga`),++this._dumpedSyncResultCounter==2&&(this.dumpResultName=void 0,this._dumpedSyncResultCounter=0)}}class mE{constructor(t,e){o(this,"_rawRenderer");o(this,"_scene");o(this,"_debug");o(this,"_implementation");this._rawRenderer=t,this._scene=e,T.DEBUG&&T.DEV_NEW_RENDER_ARCHITECTURE&&(this._debug=new pE,ct.registerIfEnabled(this))}_getImplementation(){return this._implementation||(this._implementation=new fE(this._rawRenderer,this._scene)),this._implementation}onAsyncIncidentAndReflectedLuma(t){if(this._getImplementation().isAsyncReadInProgress())return;const e=i=>{this._getImplementation().measureLuma(!1,n=>{t(i,n)},this._debug)};this._getImplementation().measureLuma(!0,e,this._debug)}measureIncidentLuma(){return this._getImplementation().measureLuma(!0,void 0,this._debug)}measureReflectedLuma(){return this._getImplementation().measureLuma(!1,void 0,this._debug)}onDebugUi(){ct.beginWindow("Luma Meter",{x:0,y:0},{x:300,y:200}),ct.displayProperty(this._debug,"lastIncidentLuma","Incident Luma"),ct.displayProperty(this._debug,"lastReflectedLuma","Reflected Luma"),T.DEBUG_SPECTOR&&ImGui.Button("Capture")&&(this._debug.debugCapture=!0),ImGui.Button("Dump results to file")&&(this._debug.dumpResultName="LumaMeter"),ct.endWindow()}}const oh={};function fu(r,t,e){oh[r]={name:r,value:t,fontFamily:e}}function Ge(r,t){fu(r,t,"FontAwesomeSolid")}function Fo(r,t){fu(r,t,"FontAwesomeRegular")}function Ts(r,t){fu(r,t,"FontAwesomeBrands")}Ge("address-book",""),Ge("address-card",""),Ge("area-chart",""),Ge("arrows",""),Ge("arrow-up",""),Ge("arrow-down",""),Ge("assistive-listening-systems",""),Ge("asterisk",""),Ge("audio-description",""),Ge("at",""),Ge("bars",""),Ge("bell",""),Ge("book",""),Ge("bookmark",""),Ge("bullhorn",""),Ge("calculator",""),Ge("camera",""),Ge("chart-bar",""),Ge("chart-pie",""),Ge("chevron-up",""),Ge("chevron-down",""),Ge("cloud",""),Ge("cog",""),Ge("comment",""),Fo("compass",""),Fo("credit-card",""),Ge("crosshairs",""),Ge("desktop",""),Ge("download",""),Ge("envelope",""),Ge("expand",""),Ge("external-link",""),Fo("eye",""),Ge("eye-dropper",""),Ge("film",""),Ge("flag",""),Ge("folder",""),Ge("gift",""),Ge("headphones",""),Ge("highlighter",""),Ge("home",""),Fo("image",""),Ge("sign-in",""),Ge("info",""),Fo("lightbulb",""),Ge("magic",""),Ge("magnet",""),Ge("map-marker",""),Ge("map-pin",""),Ge("map-signs",""),Ge("paint-brush",""),Ge("pencil",""),Ge("pen",""),Ge("phone",""),Ge("question",""),Ge("search",""),Ge("share",""),Ge("share-alt",""),Ge("shopping-cart",""),Ge("sliders",""),Ge("star",""),Fo("sticky-note",""),Ge("sync",""),Fo("edit",""),Ge("tachometer",""),Ge("tag",""),Ge("video",""),Ge("wrench",""),Ge("palette",""),Ge("paint-roller",""),Ge("play",""),Ge("pause",""),Ge("plus",""),Ts("youtube",""),Ts("vimeo",""),Ts("facebook",""),Ts("twitter",""),Ts("instagram",""),Ts("linkedin",""),Ts("skype",""),Ts("whatsapp",""),Ts("facebook-messenger",""),Ts("telegram",""),Ts("slack","");const hl=512,_E=Math.PI*(70/180),gE=Math.floor(hl*(.5-.5*Math.sin(_E/2))),Wm=hl-2*gE,jm=2048;var Xm=(r=>(r.SPHERE="sphere",r.SPRITE="sprite",r))(Xm||{});class vE{constructor(t){o(this,"icon");o(this,"text");o(this,"imagePath");o(this,"font");o(this,"color");o(this,"opacity");o(this,"textColor");o(this,"type");o(this,"position");o(this,"radius");o(this,"height");o(this,"borderRadius");const e=new xn(t),i=e.parseString("icon"),n=i?oh[i]:void 0;this.text=n?n.value:e.parseString("text",""),this.imagePath=e.parseString("image"),this.font=n?n.fontFamily:"Open Sans",this.color=e.parseString("color","#4c9ed9"),this.opacity=e.parseNumber("opacity",1),this.textColor=e.parseString("textColor","#ffffff"),this.type=e.parseEnum("type",Xm,"sprite"),this.position=e.parseNumbers("position"),this.radius=e.parseNumber("radius",.1),this.height=e.parseNumber("height",.2),this.borderRadius=e.parseNumber("borderRadius",0)}colorWithOpacity(){return cr.combineColorWithOpacity(this.color,this.opacity)}hasAlpha(){return this.opacity<1}}class bE{constructor(t){o(this,"usedTimes",1);o(this,"texture");this.texture=t}}class pu{constructor(){o(this,"sphereGeometry");o(this,"planeGeometry");o(this,"planeColliderGeometry");o(this,"texturesCache",new Map);o(this,"_debugColliderMaterial");this.sphereGeometry=ft.createSphere(1,32,16),this.sphereGeometry.convertNormalsToSpherical(),this.planeGeometry=ft.createPlane(1,1),this.planeGeometry.convertNormalsToSpherical();const t=new Ue;t.makeRotationX(Math.PI/2),this.planeColliderGeometry=ft.createCylinder(.5,.5,1,16,1),this.planeColliderGeometry.applyMatrix(t),this.planeColliderGeometry.convertNormalsToSpherical()}debugColliderMaterial(){return this._debugColliderMaterial||(this._debugColliderMaterial=new Qt,this._debugColliderMaterial.opacity=.7,this._debugColliderMaterial.baseColor.setRGB(1,0,0),this._debugColliderMaterial.setUniforms()),this._debugColliderMaterial}static getInstance(t){let e=t.get("anchor_render_cache");return e||(e=new pu,t.set("anchor_render_cache",e)),e}}function yE(r,t,e,i,n,s){const a=s*.5*Math.min(i,n);r.beginPath(),r.moveTo(t+a,e),r.lineTo(t+i-a,e),r.quadraticCurveTo(t+i,e,t+i,e+a),r.lineTo(t+i,e+n-a),r.quadraticCurveTo(t+i,e+n,t+i-a,e+n),r.lineTo(t+a,e+n),r.quadraticCurveTo(t,e+n,t,e+n-a),r.lineTo(t,e+a),r.quadraticCurveTo(t,e,t+a,e),r.closePath(),r.fill()}function ah(r,t){return`400 ${r}px ${t}`}function xE(r,t,e){r.font=ah(128,e);const n=r.measureText(t).width;let s=Math.floor(128*(Wm/n));s=Math.min(s,Wm),r.font=ah(s,e)}function EE(r,t,e){r.width=hl,r.height=hl;const i=r.getContext("2d");return xE(i,t,e),i}function AE(r,t,e,i){const n=T.SPRITE_ANCHOR_FONT_SIZE;let s=r.getContext("2d");s.font=ah(n,e);let a=t,l=t.length-1,c,h;for(;c=s.measureText(a).width,h=c+2*i,!(h<=jm);)a=t.substring(0,l)+"...",--l;const d=1.5*n;return r.width=h,r.height=d,s=r.getContext("2d"),s.font=ah(n,e),[s,a]}function qm(r,t,e){const i=r.getContext("2d");i.fillStyle=t,e?yE(i,0,0,r.width,r.height,e):i.fillRect(0,0,r.width,r.height)}function TE(r,t,e,i,n){const s=document.createElement("canvas");return s.width=t,s.height=e,qm(s,i,n),s.getContext("2d").drawImage(r,0,0,t,e),s}function wE(r,t){const e=new st;e.hasAlpha=r.hasAlpha();const i=s=>{const a=r.type=="sphere"?hl:jm;let l=s.naturalWidth,c=s.naturalHeight;return l>=c&&l>a?(c=c/l*a,l=a):c>l&&c>a&&(l=l/c*a,c=a),[Math.round(l),Math.round(c)]},n=s=>{[e.width,e.height]=i(s),e.image=TE(s,e.width,e.height,r.colorWithOpacity(),r.borderRadius),e.needsUpdate=!0,e.notifyLoaded()};return Fp(T.LOAD_PRIORITY.CORE_RESOURCE,t,s=>n(s),()=>console.log(`Failed to load trigger image: ${t}`)),e}function SE(r,t){const e=document.createElement("canvas");let i,n=r.text;r.type=="sphere"?i=EE(e,n,r.font):[i,n]=AE(e,n,r.font,t),qm(e,r.colorWithOpacity(),r.borderRadius),i.fillStyle=r.textColor,i.textAlign="center",i.textBaseline="middle",i.shadowColor="black",i.shadowBlur=16,i.fillText(n,e.width/2,e.height/2);const s=new st(e);return s.width=e.width,s.height=e.height,s.anisotropy=st.NO_ANISOTROPY,s.hasAlpha=r.hasAlpha(),s.minFilter=H.LINEAR,s.loadingStatus=fr.COMPLETED,s.needsUpdate=!0,s}function ME(r,t){var a,l;const i=[(a=t.icon)!=null?a:"",t.text,(l=t.imagePath)!=null?l:"",t.font,t.colorWithOpacity(),t.textColor,t.type=="sphere",20,t.borderRadius,t.hasAlpha()].join("_"),n=r.get(i);if(n)return n.usedTimes++,[t.color,t.textColor,i,n.texture];let s;return t.imagePath?s=wE(t,Ja(t.imagePath)):s=SE(t,20),r.set(i,new bE(s)),[t.color,t.textColor,i,s]}class Yr extends je{constructor(e,i,n){const s=new vE(n),a=pu.getInstance(i),l=new L;l.fromArray(s.position);const[c,h,d,u]=ME(a.texturesCache,s),f=new _e;f.setStyle(c),f.convertGammaToLinear();const p=new _e;p.setStyle(h),p.convertGammaToLinear();let m,b,g,x,w;s.type==="sphere"?(m=a.sphereGeometry,x=new By,g=e.closestLightProbe(l),s.imagePath||(x.bumpTexture=u),x.disableLightProbe=g===null||!g.texturesReady(),x.headLight=!0):(s.type=="sprite",m=a.planeGeometry,x=new bm,g=null,x.headLight=!1,x.reflective=!1,w=new je(a.planeColliderGeometry,x)),x.baseColor=f,x.baseColorTexture=u,x.configureTransparency(),x.setUniforms();super(m,x);o(this,"color");o(this,"textColor");o(this,"colliderMesh");o(this,"_texturesCache");o(this,"_textureSignature");this._texturesCache=a.texturesCache,this._textureSignature=d,this.color=f,this.textColor=p,this.visible=!1,this.position.copyFrom(l),this.lightProbes=[g],w?(w.position.copyFrom(l),this.colliderMesh=w,this.colliderMesh.visible=!1):this.colliderMesh=this,this.colliderMesh.visibilityId=null,this.colliderMesh.anchor=this,u.addLoadedListener(()=>{if(s.type==="sphere"?b=[s.radius,s.radius,s.radius]:(x.baseColorTexture instanceof st,b=[x.baseColorTexture.width/x.baseColorTexture.height*s.height,s.height,1]),this.scale.fromArray(b),this.updateMatrixWorld(!0),w){const C=Math.max(b[0],b[1]),M=s.height;w.scale.fromArray([C,C,M]),w.updateMatrixWorld(!0),w.visible=!0}this.visible=!0,rn().requestFrame()})}dispose(){const e=this.material;e.dispose();const i=this._textureSignature,n=this._texturesCache.get(i),s=n.texture;e.baseColorTexture,setTimeout(()=>{n.usedTimes--,n.usedTimes===0&&(s.dispose(),this._texturesCache.delete(i))},5e3)}enableLightProbe(){if(this.lightProbes.length>0&&this.lightProbes[0]){nt(this.lightProbes[0].texturesReady());const e=this.material;e.disableLightProbe=!1,e.setUniforms()}}}var Fn=(r=>(r.TWO_STATE="twoState",r.MULTI_STATE="multiState",r.IMPULSE="impulse",r))(Fn||{});const PE={"":"address-book","":"address-card","":"area-chart","":"arrows","":"arrow-up","":"arrow-down","":"assistive-listening-systems","":"asterisk","":"audio-description","":"at","":"bars","":"bell","":"book","":"bookmark","":"bullhorn","":"calculator","":"camera","":"chart-bar","":"chart-pie","":"cloud","":"cog","":"comment","":"compass","":"credit-card","":"crosshairs","":"download","":"envelope","":"external-link","":"eye","":"eye-dropper","":"film","":"flag","":"folder","":"gift","":"headphones","":"home","":"image","":"sign-in","":"info","":"lightbulb","":"magic","":"magnet","":"map-marker","":"map-pin","":"map-signs","":"paint-brush","":"pencil","":"phone","":"question","":"share","":"share-alt","":"shopping-cart","":"sliders","":"star","":"tachometer","":"tag","":"video","":"wrench","":"play","":"youtube","":"vimeo","":"facebook","":"twitter","":"instagram"};class CE{constructor(){o(this,"_callbacks");this._callbacks=[]}size(){return this._callbacks.length}addCallback(t){this._callbacks.push(t)}removeCallback(t){this._callbacks=this._callbacks.filter(e=>e!==t)}onNodeTypeClicked(t,e,i){return this._callbacks.forEach(n=>{try{n(t,e,i)}catch(s){console.error(s)}}),!0}}class RE{constructor(){o(this,"_nodeTypeToListenerMulti");o(this,"_listeners");this._nodeTypeToListenerMulti=new Map,this._listeners=new Map}_getMultiListener(t){let e=this._nodeTypeToListenerMulti.get(t);return e===void 0&&(e=new CE,this._nodeTypeToListenerMulti.set(t,e),this._listeners.set(t,e.onNodeTypeClicked.bind(e))),e}onNodeTypeClicked(t,e){const i=this._getMultiListener(t);return i.addCallback(e),i.size()===1&&rn().onNodeTypeClicked(t,this._listeners.get(t)),e}removeOnNodeTypeClicked(t,e){const i=this._nodeTypeToListenerMulti.get(t);if(i===void 0){nt(i,`listenerMulti not registered for ${t}`);return}i.removeCallback(e),i.size()===0&&(rn().removeOnNodeTypeClicked(t,this._listeners.get(t)),this._nodeTypeToListenerMulti.delete(t))}}const Ym=new RE;class Qs{constructor(t){o(this,"_anchors",new Array);o(this,"_nodeListeners",new Array);o(this,"_enabled");o(this,"triggers",new Array);o(this,"definition");o(this,"viewerApi");o(this,"running",!1);o(this,"config");o(this,"triggersVisible",!0);var e;this.triggersVisible=!0,this.definition=this.constructor.definition,this.viewerApi=rn(),this.config=$a(this.migrateConfig(t)),this._enabled=(e=this.config.enabled)!=null?e:!0,this.viewerApi.onVrChange(this._vrChanged.bind(this))}_installTriggers(){this.config.trigger&&this.addTrigger(this.config.trigger,(t,e)=>this.trigger(e))}isTriggerable(){return!1}trigger(t){}doDispose(){}doInit(){this.viewerApi.onSceneReadyToDisplay(()=>this._installTriggers())}hasProperty(t){return this.definition.properties.some(e=>e.id===t)}migrateConfig(t){var e;if(t=as(t),t.anchor!==void 0&&t.trigger===void 0&&!this.hasProperty("anchor")&&this.hasProperty("trigger")){const i=t.anchor,n=i.icon;n&&n.font&&(i.icon=PE[n.value]),t.trigger=i,t.anchor=void 0}for(const i of this.definition.properties)t[i.id]===void 0&&i.defaultValue!==void 0&&(t[i.id]=i.defaultValue);return t.enabled=(e=t.enabled)!=null?e:!0,t}get enabled(){return this._enabled}get name(){return this.config.name}get type(){return this.config.type}get vrCompatible(){return this.definition.vrCompatible}cloneConfig(){return as(this.config)}updateConfig(t){this.dispose(),this.config=$a(t),this.init()}init(){!this.running&&this.enabled&&(this.doInit(),this.running=!0)}dispose(){if(this.running){this.doDispose();for(const t of this._anchors)this.viewerApi.removeAnchor(t);for(const t of this.triggers)t instanceof jn&&(this.viewerApi.removeOnCameraPositionUpdated(t.onCameraPositionUpdated),t.dispose(!0));for(const[t,e]of this._nodeListeners)Ym.removeOnNodeTypeClicked(t,e);this._nodeListeners.length=0,this.triggers.length=0,this._anchors.length=0,this.running=!1}}enable(){this._enabled=!0;const t=this.cloneConfig();t.enabled=!0,this.updateConfig(t),this.init()}disable(){this._enabled=!1;const t=this.cloneConfig();t.enabled=!1,this.updateConfig(t),this.dispose()}_vrChanged(t){t&&!this.vrCompatible?this.dispose():!t&&!this.vrCompatible&&this.init()}_addCameraVolumeTrigger(t,e,i,n){typeof t.triggerOnEnter=="boolean"&&(t.triggerOnExit,t.triggerOnEnter=t.triggerOnEnter?"fireExtension":"doNothing",t.triggerOnExit=t.triggerOnExit?"fireExtension":"doNothing");const s={fireExtension:[e],activateExtension:[i],deactivateExtension:[n],doNothing:[]},a=new jn(s[t.triggerOnEnter],s[t.triggerOnExit],{position:t.position,rotation:t.rotation,scale:t.scale,type:t.cameraVolumeType});this.triggers.push(a),rn().onCameraPositionUpdated(a.onCameraPositionUpdated)}addTrigger(t,e,i=zc,n=zc){if(t.type==="node"){const s=t.nodeType;this.triggers.push(...this.viewerApi.findNodesOfType(s)),this._nodeListeners.push([s,Ym.onNodeTypeClicked(s,e)])}else if(["sphere","sprite"].includes(t.type)){t=t;const s=this.viewerApi.addAnchor(t,e);this._anchors.push(s),this.triggers.push(s)}else t.type=="cameraVolumeTrigger"?this._addCameraVolumeTrigger(t,e,i,n):console.assert(!1,"Unknown trigger type.")}changeTriggersVisibility(t){this.triggersVisible!==t&&(this.triggersVisible=t,this.triggers.forEach(e=>{e instanceof Yr&&(e.visible=t)}))}}o(Qs,"definition");class ws extends Qs{trigger(t){this.activated()?this.deactivate():this.activate(t)}isTriggerable(){return!0}isTriggerExclusive(){return!!this.config.triggerExclusive}_installTriggers(){this.config.trigger&&this.addTrigger(this.config.trigger,(t,e)=>this.trigger(e),(t,e)=>this.activate(e),()=>this.deactivate())}}const hd=class hd extends ws{constructor(e){super(hd.migrateLegacyConfig(e));o(this,"_audioOnIcon");o(this,"_audioOffIcon");o(this,"_play");o(this,"_element");o(this,"_playButton");o(this,"_playButtonIcon");this._audioOnIcon=void 0,this._audioOffIcon=void 0,this._element=void 0,this._playButton=void 0,this._playButtonIcon=void 0,this._play=!1}static migrateLegacyConfig(e){return e.url&&!e.file&&(e.file={file:e.url.split("/").pop(),url:e.url},delete e.url),e.file.path&&e.file.url&&delete e.file.url,e}_onSceneReadyToDisplay(){const e=this.config;this._installTriggers(),e.menuButton&&(this._audioOffIcon,this._playButton=this.viewerApi.addMenuButton(this._audioOffIcon.src),this._playButton.addEventListener("click",()=>this.trigger()),this._playButtonIcon=this.viewerApi.getMenuButtonIcon(this._playButton)),e.autoplay&&this.viewerApi.onNextPageInteraction(()=>this.trigger())}activated(){return this._play}deactivate(){this._element,this._element.pause()}activate(){this._element,this.config.playRewinds&&(this._element.currentTime=0),this._element.play()}doInit(){Re.log("Audio start"),this.config.menuButton&&!this._audioOnIcon&&(this._audioOnIcon=Vc(yi("img/audio-on.svg")),this._audioOffIcon=Vc(yi("img/audio-off.svg"))),this._element=document.createElement("audio"),this.config.file&&(this.config.file.path?this._element.src=Ja(this.config.file.path):this.config.file.url&&(this._element.src=this.config.file.url)),this._element.src&&(this._element.loop=this.config.loop,this._element.addEventListener("play",()=>{this._play=!0,this._playButtonIcon&&(this._audioOnIcon,this._playButtonIcon.src=this._audioOnIcon.src)}),this._element.addEventListener("pause",()=>{this._play=!1,this._playButtonIcon&&(this._audioOffIcon,this._playButtonIcon.src=this._audioOffIcon.src)}),document.body.appendChild(this._element),this.viewerApi.onSceneReadyToDisplay(()=>this._onSceneReadyToDisplay()))}doDispose(){Re.log("Audio stop"),this._play=!1,this._playButton&&(this.viewerApi.removeMenuButton(this._playButton),this._playButton=void 0,this._playButtonIcon=void 0),this._element,this._element.pause(),this._element.remove(),this._element=void 0}};o(hd,"definition",{name:"Audio",type:Fn.TWO_STATE,properties:[{id:"file",type:"file",label:"File",fileType:"audio"},{id:"autoplay",type:"bool",label:"Autoplay",defaultValue:!1},{id:"triggerExclusive",type:"bool",label:"Exclusive",defaultValue:!1},{id:"playRewinds",type:"bool",label:"Play rewinds",defaultValue:!1},{id:"loop",type:"bool",label:"Loop",defaultValue:!0},{id:"menuButton",type:"bool",label:"Show menu button",defaultValue:!0},{id:"trigger",type:"trigger",label:"Trigger",optional:!0}],vrCompatible:!0});let mu=hd;class Qm extends Qs{constructor(e){super(e);o(this,"_nextView");this._nextView=0}isTriggerable(){return!0}trigger(){const e=this.config.views[this._nextView];this.viewerApi.switchToView(e,void 0,this.config.doNotMoveCamera),this._nextView=(this._nextView+1)%this.config.views.length}doInit(){super.doInit(),this._nextView=0}}o(Qm,"definition",{name:"Change view",type:Fn.MULTI_STATE,properties:[{id:"views",type:"list",elementType:"view",label:"Views to toggle"},{id:"doNotMoveCamera",type:"bool",label:"Do not move camera",defaultValue:!1},{id:"trigger",type:"trigger",label:"Trigger",optional:!0}],vrCompatible:!0});class Km extends Qs{constructor(e){super(e);o(this,"_visibleIcon");o(this,"_hiddenIcon");o(this,"_hideAnchorsButton");o(this,"_hideAnchorsButtonIcon");o(this,"_onAnchorsVisibilityChanged",()=>{this._hideAnchorsButtonIcon.src=this.viewerApi.anchorsVisible?this._visibleIcon.src:this._hiddenIcon.src});this._visibleIcon=Vc(yi("img/anchors-on.svg")),this._hiddenIcon=Vc(yi("img/anchors-off.svg"))}isTriggerable(){return!0}trigger(){this.viewerApi.anchorsVisible=!this.viewerApi.anchorsVisible}doInit(){const e=this.viewerApi;this._hideAnchorsButton=e.addMenuButton(this._visibleIcon.src),this._hideAnchorsButtonIcon=e.getMenuButtonIcon(this._hideAnchorsButton),e.onAnchorsVisibilityChanged(this._onAnchorsVisibilityChanged),this._hideAnchorsButton.addEventListener("click",()=>this.trigger()),e.onSceneReadyToDisplay(()=>e.anchorsVisible=this.config.visibleOnStart)}doDispose(){this.viewerApi.removeAnchorsVisibilityChangedListener(this._onAnchorsVisibilityChanged),this.viewerApi.removeMenuButton(this._hideAnchorsButton),this._hideAnchorsButton=void 0,this._hideAnchorsButtonIcon=void 0,this.viewerApi.anchorsVisible=!0}}o(Km,"definition",{name:"Hide triggers",type:Fn.TWO_STATE,properties:[{id:"visibleOnStart",type:"bool",label:"Visible on start",defaultValue:!0}],vrCompatible:!0});const es=class es extends ws{constructor(e){super(e);o(this,"_popup");this._popup=void 0}_sleepAnimatedMaterials(){es._animatedMaterialsAreSleeping||(this.viewerApi.sleepAnimatedMaterials(),es._animatedMaterialsAreSleeping=!0)}_wakeAnimatedMaterials(){es._animatedMaterialsAreSleeping&&(this.viewerApi.wakeAnimatedMaterials(),es._animatedMaterialsAreSleeping=!1)}_doesElementContainVideo(e){if(e instanceof HTMLVideoElement||e instanceof HTMLIFrameElement)return!0;for(const i of e.children)if(this._doesElementContainVideo(i))return!0;return!1}_onClosePopup(){this._popup=void 0,es._activeLabel===this&&(es._activeLabel=void 0,this._wakeAnimatedMaterials())}activated(){return es._activeLabel===this}deactivate(){this._popup!==void 0&&this.activated()&&this._popup.close()}activate(){if(!this.activated()){es._activeLabel=this,this._popup=this.viewerApi.openPopup(this.config.content,this.config,()=>this._onClosePopup());const e=document.createElement("div");e.innerHTML=this.config.content,this._doesElementContainVideo(e)?this._sleepAnimatedMaterials():this._wakeAnimatedMaterials()}}doDispose(){this._popup!==void 0&&this._popup.close()}};o(es,"definition",{name:"HTML label",type:Fn.TWO_STATE,properties:[{id:"trigger",type:"trigger",label:"Trigger",optional:!0},{id:"content",type:"textArea",label:"Content",optional:!0,defaultValue:"Content to display..."},{id:"centerHorizontally",type:"bool",label:"Center horizontally",defaultValue:!1},{id:"centerVertically",type:"bool",label:"Center vertically",defaultValue:!1},{id:"padding",type:"bool",label:"Padding",defaultValue:!0}],vrCompatible:!1}),o(es,"_activeLabel"),o(es,"_animatedMaterialsAreSleeping",!1);let _u=es;/*!
 * Copyright (C) 2022-present Shapespark
 */function Tt(r){return document.getElementById(r)}function Bo(){if(!$e.ios){const r=Tt("walk-canvas");r&&r.focus()}}function $m(r){return function(t){t.stopPropagation(),r(),Bo()}}function Ss(r,t){r.addEventListener("click",$m(t))}function Ki(r,t){const e=Tt(r);nt(e!=null,`${r} could not be found.`),e!==null&&Ss(e,t)}function lh(r){r.addEventListener("click",t=>{t.stopPropagation(),t.target instanceof HTMLInputElement||t.target instanceof HTMLSelectElement||t.target instanceof HTMLTextAreaElement||Bo()})}const Fr=class Fr{constructor(t,e,i){o(this,"_content");o(this,"_options");o(this,"_onClose");o(this,"_container");o(this,"_contentElement");o(this,"_isOpen");this._content=t,this._isOpen=!1,this._options=e,this._container=document.getElementById("ext-html-label"),this._contentElement=this._container.querySelector("#ext-html-label-content"),this._onClose=i}static set _setLastOpenPopup(t){Fr._lastOpenPopup=t}static get lastOpenPopup(){return Fr._lastOpenPopup}static openPopup(t,e,i){const n=new Fr(t,e,i);return Fr.lastOpenPopup!==void 0?Fr.lastOpenPopup.close(()=>n.open()):n.open(),Fr._setLastOpenPopup=n,n}close(t){if(!this._isOpen){t==null||t();return}const e=n=>{this._container.classList.remove("ext-html-label-topleft"),this._container.classList.remove("ext-html-label-horizontal-center"),this._container.classList.remove("ext-html-label-vertical-center"),this._container.classList.remove("ext-html-label-center"),this._container.classList.remove("ui-out"),this._contentElement.innerHTML="",this._container.style.display="none",this._onClose&&this._onClose(),n==null||n(),this._isOpen=!1};this._container.classList.add("ui-out");const i=400;Bo(),window.setTimeout(()=>e(t),i)}open(){if(this._isOpen)return;const t=()=>{this._options.centerVertically?this._options.centerHorizontally?this._container.classList.add("ext-html-label-center"):this._container.classList.add("ext-html-label-vertical-center"):this._options.centerHorizontally?this._container.classList.add("ext-html-label-horizontal-center"):this._container.classList.add("ext-html-label-topleft"),this._container.classList.add("ui-out"),this._container.classList.remove("ext-html-label-animated"),this._container.offsetHeight,this._container.classList.add("ext-html-label-animated"),this._container.classList.remove("ui-out")},e=()=>{this._options.padding||this._options.padding===void 0?this._contentElement.style.padding="":this._contentElement.style.padding="0"};if(this._content instanceof Node)this._contentElement.appendChild(this._content);else{const i=Ja("").slice(0,-1),n=this._content.replace(/\$EXTRA_ASSETS/g,i);this._contentElement.innerHTML=n}e(),this._container.style.display="",t(),this._container.querySelector("#ext-html-label-close").onclick=()=>{this.close()},this._isOpen=!0}};o(Fr,"_lastOpenPopup");let dl=Fr;const dd=class dd{constructor(t,e){o(this,"vrRadius");o(this,"vrPosition");o(this,"vrPositionOffset");o(this,"viewer");o(this,"trigger");this.viewer=t,this.trigger=e,this.vrPosition=new L,this.vrPositionOffset=new L,this.trigger&&["sprite","sphere"].includes(this.trigger.type)?(this.vrPosition.fromArray(this.trigger.position),this.vrRadius=this.trigger.radius):this.vrRadius=dd.VR_RADIUS}getPosition(t){if(t!=null)return(!this.trigger||this.trigger.type==="node")&&(this.vrPositionOffset.copyFrom(this.viewer.getCameraPosition()),this.vrPositionOffset.sub(t),this.vrPositionOffset.normalize().multiplyScalar(this.vrRadius),this.vrPosition.copyFrom(t).add(this.vrPositionOffset)),this.vrPosition}getRadius(){return this.vrRadius}};o(dd,"VR_RADIUS",.07);let ch=dd,IE=(Xa=class extends ws{constructor(e){super(Xa._migrateConfig(e));o(this,"_meshes");o(this,"_ownedMaterialPickerId");o(this,"_vrPlacer");o(this,"_apiUserStateKey");o(this,"_onStateChanged",(e,i)=>{console.assert(e===this._apiUserStateKey);const n=this.viewerApi.findMaterial(i);n&&this._setMaterial(n)});this._meshes=[],this._ownedMaterialPickerId=void 0,this._vrPlacer=new ch(this.viewerApi,this.config.trigger),this._apiUserStateKey="MaterialPicker:"+this.name,this.viewerApi.isSceneReadyToDisplay()||this._materialNames().forEach(i=>this.viewerApi.setMaterialEditable(i))}static _migrateConfig(e){if(!e.materials)return e;const i=as(e);return i.materials.length>0&&(i.toReplace=i.materials[0],i.toPick=i.materials.slice(1)),i.materials=void 0,$a(i)}_materialNames(){return(this.config.toReplace?[this.config.toReplace]:[]).concat(this.config.toPick||[])}_materials(){return this._materialNames().map(e=>this.viewerApi.findMaterial(e))}_setMaterial(e){this._meshes.forEach(i=>this.viewerApi.setMaterialForMesh(e,i))}_materialSelected(e){this.viewerApi.apiUserChangeState(this._apiUserStateKey,e.name)}activated(){return this._ownedMaterialPickerId===void 0?!1:this.viewerApi.getCurrentMaterialPickerId()===this._ownedMaterialPickerId}deactivate(){this.activated()&&(this._ownedMaterialPickerId=void 0,this.viewerApi.closeMaterialPicker())}activate(e){this.activated()||(this.viewerApi.closeMaterialPicker(),this._ownedMaterialPickerId=this.viewerApi.openMaterialPicker(this._materials(),i=>this._materialSelected(i),null,this._vrPlacer.getPosition(e),this._vrPlacer.getRadius()))}isTriggerable(){return!0}_sceneReadyToDisplay(){this._installTriggers(),this._meshes=this.viewerApi.findMeshesWithMaterial(this.config.toReplace||[])}doInit(){this.viewerApi.onSceneReadyToDisplay(()=>this._sceneReadyToDisplay()),this.viewerApi.onApiUserStateChanged(this._apiUserStateKey,this._onStateChanged)}doDispose(){const e=this.viewerApi.findMaterial(this.config.toReplace);e&&this._materialSelected(e),this.viewerApi.removeOnApiUserStateChanged(this._apiUserStateKey,this._onStateChanged)}},o(Xa,"definition",{name:"Material picker",type:Fn.TWO_STATE,properties:[{id:"toReplace",type:"material",label:"Material to replace"},{id:"toPick",type:"list",elementType:"material",label:"Materials to pick"},{id:"trigger",type:"trigger",label:"Trigger",optional:!0}],vrCompatible:!0}),Xa);const Ei=class Ei extends Qs{constructor(e){super(e);o(this,"_meshesForOptions",[]);o(this,"_defaultUvScale",[1,1]);o(this,"_originalUvOffsetScaleForMaterial",new Map);o(this,"_vrPlacer");o(this,"_apiUserStateKey");o(this,"_optionList");o(this,"_curOptionIdx",-1);o(this,"_materialSelected",(e,i)=>{this.viewerApi.apiUserChangeState(this._apiUserStateKey,i)});o(this,"_onStateChanged",(e,i)=>{if(console.assert(e===this._apiUserStateKey),this._revertChanges(),i!==0){this._curOptionIdx=i-1;for(let n=0;n<this._optionList[this._curOptionIdx].length;++n){const s=this._optionList[this._curOptionIdx][n],a=this.viewerApi.findMaterial(s.toUse),l=this._originalUvOffsetScaleForMaterial.get(a),c=s.uvScale?s.uvScale[0]:this._defaultUvScale[0],h=s.uvScale?s.uvScale[1]:this._defaultUvScale[1];a.setUvOffsetAndScale(l.x,l.y,l.z*c,l.w*h),a.setUniforms();for(const d of this._meshesForOptions[this._curOptionIdx][n])this.viewerApi.setMaterialForMesh(a,d)}}});o(this,"_sceneReadyToDisplay",()=>{for(const e of this.config.triggers)this.addTrigger(e,this.openFromTrigger.bind(this));for(let e=0;e<this._optionList.length;++e){this._meshesForOptions[e]=[];for(const{toReplace:i,toUse:n}of this._optionList[e]){this._meshesForOptions[e].push(this.viewerApi.findMeshesWithMaterial(i));const s=this.viewerApi.findMaterial(n);if(!this._originalUvOffsetScaleForMaterial.has(s)){const a=new We;this._originalUvOffsetScaleForMaterial.set(s,s.getUvOffsetAndScale(a))}}}});o(this,"togglePickersMenu",()=>{const e=Ei._startedPickers;if(console.assert(e.length>0),Ei._pickerOpened&&this.viewerApi.closeMaterialPicker(),Ei._menuPopup){this.closePickersMenu();return}const i=document.createElement("div");i.innerHTML=`
        <div class="ext-material-combo-picker-menu-title">
          <img src="${yi("img/sliders-horizontal.svg")}">
        </div>
        <ul class="ext-material-combo-picker-menu-list">
          <li class="ext-material-combo-picker-menu-item"></li>
        </ul>`;const n=i.getElementsByClassName("ext-material-combo-picker-menu-list")[0];let s=n.getElementsByClassName("ext-material-combo-picker-menu-item")[0];for(let a=0;a<e.length;++a){a>0&&(s=s.cloneNode(!0),n.appendChild(s));const l=e[a];ma(s,l.name),s.addEventListener("click",function(){l._openFromMenu()})}Ei._menuPopup=dl.openPopup(i,{centerHorizontally:!0,centerVertically:!0,padding:!1},()=>{Ei._menuPopup=void 0})});this._vrPlacer=new ch(this.viewerApi),this._apiUserStateKey="MaterialComboPicker:"+this.name,this._optionList=this.config.options,this.viewerApi.isSceneReadyToDisplay()||this._allMaterialNames().forEach(i=>this.viewerApi.setMaterialEditable(i))}_allMaterialNames(){const e=new Set;for(const i of this._optionList)for(const n of i)e.add(n.toReplace),e.add(n.toUse);return e}_revertChanges(){if(this._curOptionIdx!==-1)for(let e=0;e<this._optionList[this._curOptionIdx].length;++e){const i=this._optionList[this._curOptionIdx][e],n=this.viewerApi.findMaterial(i.toUse),s=this.viewerApi.findMaterial(i.toReplace);n.setUvOffsetAndScale(this._originalUvOffsetScaleForMaterial.get(n)),n.setUniforms();for(const a of this._meshesForOptions[this._curOptionIdx][e])this.viewerApi.setMaterialForMesh(s,a)}}isTriggerable(){return!1}openFromTrigger(e,i,n){Ei._menuPopup&&this.closePickersMenu();const s=this._toPickMaterials();this.viewerApi.openMaterialPicker(s,this._materialSelected,()=>this.pickerClosed(),this._vrPlacer.getPosition(i),this._vrPlacer.getRadius()),Ei._pickerOpened=!0}_toPickMaterialNames(){const e=[this._optionList[0][0].toReplace];for(const i of this._optionList)e.push(i[0].toUse);return e}_toPickMaterials(){return this._toPickMaterialNames().map(e=>this.viewerApi.findMaterial(e))}closePickersMenu(){Ei._menuPopup.close(),Ei._menuPopup=void 0}pickerClosed(){Ei._pickerOpened=!1}_openFromMenu(){const e=this._toPickMaterials();this.viewerApi.openMaterialPicker(e,this._materialSelected),Ei._pickerOpened=!0}doInit(){this.viewerApi.onSceneReadyToDisplay(this._sceneReadyToDisplay),this.viewerApi.onApiUserStateChanged(this._apiUserStateKey,this._onStateChanged);const e=Ei._startedPickers;if(e.push(this),e.length===1){const i=this.viewerApi.addMenuButton(yi("img/sliders-horizontal.svg"));i.addEventListener("click",this.togglePickersMenu),Ei._menuButton=i}}doDispose(){this._revertChanges(),this.viewerApi.removeOnApiUserStateChanged(this._apiUserStateKey,this._onStateChanged);const e=Ei._startedPickers;if(e.splice(e.indexOf(this),1),e.length===0){const i=Ei._menuButton;this.viewerApi.removeMenuButton(i),Ei._menuButton=void 0}}};o(Ei,"definition",{name:"Material combo picker",type:Fn.TWO_STATE,hideFromEditor:!0,properties:[{id:"triggers",type:"list",label:"Triggers",elementType:"trigger"},{id:"options",type:"list",label:"Options",elementType:{type:"list",label:"option",elementType:[{id:"toReplace",type:"material",label:"Material to replace"},{id:"toUse",type:"material",label:"Material to use"},{id:"uvScale",type:"list",label:"UV Scale",elementType:"float"}]}}],vrCompatible:!0}),o(Ei,"_startedPickers",[]),o(Ei,"_menuButton"),o(Ei,"_menuPopup"),o(Ei,"_pickerOpened",!1);let gu=Ei;const DE=["toggle","impulse","activate","deactivate"];function ul(r){const[t,e,i]=r.split(":");return[t,e,i]}function LE(r){return["VideoTextureControl","SwitchObjects"].includes(r.type)}class Zm extends Qs{constructor(e){super(e);o(this,"_nextTriggerActivate");this._nextTriggerActivate=!0}migrateConfig(e){e=super.migrateConfig(e);const i=new Array;let n=!1;for(const s of e.extensions){let[a,l,c]=ul(s);DE.includes(c)||(n=!0,c="toggle"),i.push(`${a}:${l}:${c}`)}return n&&(e.extensions=i),e}extensionsAndTriggerTypes(){return this.config.extensions.map(e=>{const[i,n,s]=ul(e);return[this.viewerApi.getExtension(i,n),s]})}get vrCompatible(){return this.extensionsAndTriggerTypes().every(([e])=>e.vrCompatible)}trigger(e){for(const[i,n]of this.extensionsAndTriggerTypes())try{switch(n){case"activate":Ce(i instanceof ws),i.activate(e);break;case"deactivate":Ce(i instanceof ws),i.deactivate();break;case"impulse":Ce(i instanceof ws),i.trigger(e);break;case"toggle":i instanceof ws?this._nextTriggerActivate?i.activate(e):i.deactivate():i.trigger(e);break}}catch(s){console.error("Failed to trigger an extension",s)}this._nextTriggerActivate=!this._nextTriggerActivate}isTriggerable(){return!1}doInit(){super.doInit(),this._nextTriggerActivate=!0}}o(Zm,"definition",{name:"Multi trigger",type:Fn.IMPULSE,getListElementsToAdd:function(e,i,n){nt(e==="extensions");const s=new Set(i.map(l=>ul(l)[0])),a=l=>l.isTriggerable()&&(LE(l)||!s.has(l.type));return n.filter(a).map(l=>`${l.type}:${l.name}:toggle`)},formatListElement:function(e){const[i,n,s]=ul(e),a=c_(i),l=s.replace(s[0],s[0].toUpperCase());return`${a.name}: ${n} - ${l}`},getTriggerTypeDefinition:function(e){const[i]=ul(e);return c_(i)},properties:[{id:"extensions",type:"list",elementType:"extension",label:"Extensions to trigger",elementLabel:"extension"},{id:"trigger",type:"trigger",label:"Trigger",optional:!0}],vrCompatible:!1});class Jm extends Qs{constructor(t){super(t)}isTriggerable(){return!0}trigger(){this.viewerApi.openUrl(this.config.url,this.config.newWindow)}}o(Jm,"definition",{name:"Open URL",type:Fn.IMPULSE,properties:[{id:"url",type:"text",label:"URL"},{id:"newWindow",type:"bool",label:"New window",defaultValue:!0},{id:"trigger",type:"trigger",label:"Trigger",optional:!0}],vrCompatible:!0});let e_=null,Er=!1,vu=!0;const t_=[{name:"mainMaterial",baseColor:[.5,.5,.5],roughness:.7,metallic:1},{name:"displayMaterial",baseColor:[0,0,0],roughness:.001,metallic:0}],Ks={sphere:null,cylinder:null,head:[],torso:[],displayPortrait:[],displayLandscape:[]},fl={};function OE(r){(!Ks.plane||e_!==r.id)&&(Ks.sphere=ft.createSphere(.08,32,16),Ks.sphere.convertNormalsToSpherical(),Ks.cylinder=ft.createCylinder(.005,.005,1,3),Ks.cylinder.convertNormalsToSpherical(),e_=r.id)}function FE(r,t,e){const i=new li;Ks.head.forEach(s=>{i.union(s.geometry.boundingBox)});const n=(i.max.z-i.min.z)/2;return new Yr(r,r.renderCaches,{type:"sprite",position:[0,0,.1+i.center().z+n],height:.1,text:t,textColor:e,opacity:0})}function BE(r){const t=new je(Ks.sphere,r);return t.scale.set(.4,.4,.4),t.visible=!1,t}function NE(r){const t=new Qt;t.lightmapSupported=!1,t.headLight=!1,t.baseColor.setStyle(r).convertGammaToLinear(),t.transparent=!0,t.opacity=.5,t.emissive=!0,t.disableLightProbe=!0,t.setUniforms();const e=new je(Ks.cylinder,t);return e.visible=!1,e}function UE(r,t){r.length!==t.size&&console.warn("Mismatch between avatar meshes count and geometries map size");for(const e of r){t.has(e.geometryName)||console.assert(!1,'Avatar "'+e.geometryName+'" mesh is missing');const i={materialName:e.materialName?e.materialName:"mainMaterial",geometry:t.get(e.geometryName)};Ks[e.group].push(i)}}function bu(r){const t=new Qt;return t.lightmapSupported=!1,t.baseColor.fromArray(r.baseColor),t.roughness=r.roughness||1,t.metallic=r.metallic||0,t.opacity=r.opacity||1,t.highlight=new _e(16777215),t.highlightMix=0,t.baseColorTexture=r.baseColorTexture,t.disableLightProbe=r.disableLightProbe||!1,t.headLight=r.headLight||!1,t.setUniforms(),t}function kE(r,t){r&&t_.push(...r),t_.forEach(e=>{if(e.baseColorTexture){const i=new Image;i.src=t+e.baseColorTexture.file,e.baseColorTexture=rn().createTextureFromHtmlImage(i)}fl[e.name]=bu(e)})}function VE(r,t,e){Er=t.displayLookAtCamera||!1,vu=t.rotateHeadInPortraitMode||!0,UE(t.meshes,e),kE(t.materials,r)}const yu="avatarDisposed",xu="avatarUpdated";class zE extends yt{constructor(t,e,i){super(),this.uuid=e,this.displayName=i.displayName,this._scene=t,this._lastLightProbeCheckPosition=new L(0,0,0),this.colliders=[],OE(t),this._haveLightProbe=this._scene.lightProbes.length>0;for(const a of Object.values(fl))a.disableLightProbe=!this._haveLightProbe,a.headLight=this._haveLightProbe,a.setUniforms();this.mainMaterial=bu(fl.mainMaterial),Er?(this.displayMaterial=new bm,this.displayMaterial.reflective=!1,this.displayMaterial.headLight=!1):this.displayMaterial=bu(fl.displayMaterial),this.mainMaterial.baseColor.setStyle(i.color).convertGammaToLinear(),this._body=new yt,this._head=new yt,this._head.rotation.order=ys.ZXY,this._torso=new yt,this._displayLandscape=new yt,this._displayPortrait=new yt;const n=a=>{switch(a){case"mainMaterial":return this.mainMaterial;case"displayMaterial":return this.displayMaterial;default:return fl[a]}},s=(a,l)=>{Ks[l].forEach(c=>{const h=n(c.materialName),d=new je(c.geometry,h);a.add(d),d.visibilityId=null,this.colliders.push(d)})};if(s(this._head,"head"),s(this._torso,"torso"),s(this._displayLandscape,"displayLandscape"),s(this._displayPortrait,"displayPortrait"),this._pointer=BE(this.mainMaterial),this._pointerLeaderStartOffset=new L(0,.3,-.35),this._pointerLeader=NE(i.color),this._displayNameAnchor=FE(t,i.displayName,i.color),this._body.add(this._torso),this._body.add(this._head),Er?(this.add(this._displayLandscape),this.add(this._displayPortrait)):(this._head.add(this._displayLandscape),this._head.add(this._displayPortrait)),this.add(this._body),this.add(this._displayNameAnchor),this.add(this._pointerLeader),this.add(this._pointer),i.position&&this.position.fromArray(i.position),this.updateMatrixWorld(!0),this._setClosestLightProbe(),Er){const a=new li;this._displayLandscape.children.forEach(l=>{a.union(l.geometry.boundingBox)}),this.displayMaterial.offset=a.center()}this._videoTexture0=null,this._videoTexture1=null,this._landscape=!0,this._displayLandscape.visible=!Er,this._displayPortrait.visible=!1,this._soundThreshold=140,this._maxHighlight=.5,this._highlightStepDown=.05}switchToPortrait(){this._landscape&&(this._landscape=!1,this._displayLandscape.visible=!1,this._displayPortrait.visible=!0,vu&&!Er&&(this._head.rotation.y=Math.PI/2,this._torso.position.z-=.05))}switchToLandscape(){this._landscape||(this._landscape=!0,this._displayLandscape.visible=!0,this._displayPortrait.visible=!1,vu&&!Er&&(this._head.rotation.y=0,this._torso.position.z+=.05))}hideBody(){this.traverse(t=>t.visible=!1),this.visible=!0,this._pointer.visible=!0,this._pointerLeader.visible=!0}_updated(){this.dispatchEvent({type:xu})}rotate(t,e){this._body.rotation.z=t,this._head.rotation.x=e}setOrientation(){this._videoTexture0.width<this._videoTexture0.height?this.switchToPortrait():this.switchToLandscape()}onVideoStreamStart(){Er&&(this._displayLandscape.visible=!0,this._displayPortrait.visible=!1)}onVideoStreamStop(){Er?(this._displayLandscape.visible=!1,this._displayPortrait.visible=!1):this.switchToLandscape()}setVideoTexture0(t){this._videoTexture0&&(this._videoTexture0.dispose(),this._videoTexture0=null),this._haveLightProbe&&(this.displayMaterial.disableLightProbe=!1),this.displayMaterial.baseColorTexture=void 0,this._updated(),t?(this.onVideoStreamStart(),t.addLoadedListener(()=>{this._videoTexture0=t,this.setOrientation(),this.displayMaterial.disableLightProbe=!0,this.displayMaterial.baseColorTexture=t,t.addResizedListener(()=>{this.setOrientation(),this._updated()}),this._updated()})):(this.onVideoStreamStop(),this._updated())}getVideoTexture0(){return this._videoTexture0}setVideoTexture1(t){this._videoTexture1&&(this._videoTexture1.dispose(),this._videoTexture1=null,this._updated()),t&&t.addLoadedListener(()=>{this._videoTexture1=t,this._updated()})}getVideoTexture1(){return this._videoTexture1}getMainMaterial(){return this.mainMaterial}_setClosestLightProbe(){const t=this._scene.closestLightProbe(this.position);if(this._head.children[0].lightProbes!==void 0){for(const e of this._head.children[0].lightProbes)if(e===t)return}for(const e of[this._head,this._torso,this._displayPortrait,this._displayLandscape])e.children.forEach(i=>{i.lightProbes=[t]});this._pointer.lightProbes=[t],this._pointerLeader.lightProbes=[t]}setPositionFromArray(t){this.position.fromArray(t),this._lastLightProbeCheckPosition.distanceTo(this.position)>.5&&(this._lastLightProbeCheckPosition.copyFrom(this.position),this._setClosestLightProbe(this.position))}placePointer(t,e,i){const n=new Ue,s=new L,a=new L,l=new L,c=new L,h=new Ue,d=new Ue;d.set(1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1);const u=new Ue;this._pointer.position.set(t-this.position.x,e-this.position.y,i-this.position.z),this._pointer.visible=!0,n.makeRotationZ(this._body.rotation.z),s.set(this._pointerLeaderStartOffset.x,this._pointerLeaderStartOffset.y,this._pointerLeaderStartOffset.z),n.affineTransformPoint3(s),a.set(this.position.x,this.position.y,this.position.z).add(s),l.set(t,e,i),c.set(t,e,i).sub(a),u.makeScale(1,c.length(),1),h.lookAt(a,l,yt.DEFAULT_UP),h.multiply(d),u.multiplyMatrices(h,u),c.divideScalar(2).add(s),u.setPosition(c),this._pointerLeader.matrix.identity(),this._pointerLeader.applyMatrix(u),this._pointerLeader.visible=!0}hidePointer(){this._pointerLeader.visible=!1,this._pointer.visible=!1}onSoundVolumeUpdated(t){if(t===null)return;const e=this._computeHighlighMix(t);this.getMainMaterial().highlightMix!==e&&(this.getMainMaterial().highlightMix=e,rn().requestFrame())}onSoundSwitchedOff(){this.getMainMaterial().highlightMix>0&&(this.getMainMaterial().highlightMix=0,rn().requestFrame())}_computeHighlighMix(t){const e=this.getMainMaterial().highlightMix;if(t<this._soundThreshold)return e>0?Math.max(0,e-this._highlightStepDown):0;{const i=(t-this._soundThreshold)/(255-this._soundThreshold)*this._maxHighlight;return i>e?i:Math.max(i,e-this._highlightStepDown)}}dispose(){this.mainMaterial.dispose(),this.displayMaterial.dispose(),this._videoTexture0&&this._videoTexture0.dispose(),this._videoTexture1&&this._videoTexture1.dispose(),this._displayNameAnchor.dispose(),this.dispatchEvent({type:yu})}}const i_=T.EDIT_MODE;class n_ extends Qs{constructor(e){super(e);o(this,"_apiUserStateKey");o(this,"_meetingController");o(this,"_material");o(this,"_origBaseColorTexture");o(this,"_presentingAvatar");o(this,"_editModePopup");o(this,"_attachScreenShareToTexture",()=>{const e=this._getScreenShareTexture();e?this._material.baseColorTexture=e:this._material.baseColorTexture=this._origBaseColorTexture});o(this,"_presentationStop",()=>{Re.log("Presentation stop"),this._presentingAvatar&&(this._presentingAvatar.uuid===this._meetingController.myUuid&&this._meetingController.stopShareScreen(),this._presentingAvatar.removeEventListener(yu,this._presentationStop),this._presentingAvatar.removeEventListener(xu,this._attachScreenShareToTexture)),this._presentingAvatar=void 0,this._material.baseColorTexture=this._origBaseColorTexture,this._removeTriggerHighlight()});o(this,"_fakeTogglePresentation",()=>{if(this._editModePopup){this._editModePopup.close();return}const e=`In a 3D meeting this trigger will start a screen sharing on the ${this.config.material} material. Outside of a 3D meeting the trigger will be hidden.`;this._editModePopup=dl.openPopup(e,{padding:!0,centerVertically:!0,centerHorizontally:!0},()=>{this._editModePopup=void 0})});o(this,"_togglePresentation",()=>{const e=this._meetingController.myUuid;!this._presentingAvatar||!this._getScreenShareTexture()?(Re.log("Requesting screen share "+e),this._meetingController.startShareScreen(()=>{this.viewerApi.apiUserChangeState(this._apiUserStateKey,e)},()=>{this.viewerApi.apiUserChangeState(this._apiUserStateKey,null)},()=>{})):this._presentingAvatar.uuid!==e||(Re.log("Requesting presentation stop"),this.viewerApi.apiUserChangeState(this._apiUserStateKey,null))});o(this,"onStateChanged",(e,i)=>{if(console.assert(e===this._apiUserStateKey),!i){this._presentationStop();return}if(this._presentingAvatar&&this._presentingAvatar.uuid!==i&&(Re.log("Changing presenting user"),this._presentationStop()),!this._presentingAvatar){if(Re.log("New presenting user "+i),this._presentingAvatar=this.viewerApi.findAvatar(i),!this._presentingAvatar){console.log("Cannot attach presentation stream of a user "+i+" The user was not found.");return}this._presentingAvatar.addEventListener(yu,this._presentationStop),this._presentingAvatar.addEventListener(xu,this._attachScreenShareToTexture),this._addTriggerHighlight(),this._attachScreenShareToTexture()}});o(this,"_onAvatarListChanged",()=>{this.onStateChanged(this._apiUserStateKey,this.viewerApi.getApiUserState(this._apiUserStateKey))});o(this,"_meetingJoined",e=>{const i=this.config;if(this._material=this.viewerApi.findMaterial(i.material),!this._material){console.error("Material for a projection screen is missing"),this._material=void 0;return}this._meetingController=e,this._origBaseColorTexture=this._material.baseColorTexture,this.config.trigger&&this.addTrigger(this.config.trigger,this._togglePresentation),this.viewerApi.onApiUserStateChanged(this._apiUserStateKey,this.onStateChanged),this.viewerApi._onAvatarListChanged(this._onAvatarListChanged)});this._apiUserStateKey="ProjectionScreen:"+this.name,this._meetingController=void 0,this._material=void 0,this._origBaseColorTexture=void 0,this._presentingAvatar=void 0,this._editModePopup=void 0,this.viewerApi.isSceneReadyToDisplay()||this.viewerApi.setMaterialEditable(this.config.material)}_hasHighlightableTrigger(){return this.triggers[0]instanceof Yr}_getTriggerMaterial(){return this.triggers[0]instanceof Yr,this.triggers[0].material}_addTriggerHighlight(){if(!this._hasHighlightableTrigger())return;const e=this._getTriggerMaterial();e.highlight=this._presentingAvatar.getMainMaterial().baseColor,e.setUniforms(),e.highlightMix=.7}_removeTriggerHighlight(){this._hasHighlightableTrigger()&&(this._getTriggerMaterial().highlightMix=0)}_getScreenShareTexture(){return this._presentingAvatar.getVideoTexture1()}isTriggerable(){return!1}doInit(){i_?this.config.trigger&&this.addTrigger(this.config.trigger,this._fakeTogglePresentation):this.viewerApi._onMeetingJoined(this._meetingJoined)}doDispose(){i_||(this.viewerApi._removeOnMeetingJoined(this._meetingJoined),this._meetingController&&(this.viewerApi.removeOnApiUserStateChanged(this._apiUserStateKey,this.onStateChanged),this.viewerApi._removeOnAvatarListChanged(this._onAvatarListChanged)),this._meetingController=void 0,this._material=void 0)}}o(n_,"definition",{name:"Meeting projection screen",type:Fn.TWO_STATE,properties:[{id:"material",type:"material",label:"Material to project on"},{id:"trigger",type:"trigger",label:"Trigger",optional:!0}],vrCompatible:!0});class s_ extends Qs{constructor(t){super(t)}isTriggerable(){return!0}trigger(){try{new Function('"use strict"; '+this.config.code)()}catch(t){console.error("Script extension error: "+t)}}doInit(){super.doInit(),this.config.trigger||this.trigger()}}o(s_,"definition",{name:"Script",type:Fn.IMPULSE,properties:[{id:"code",type:"textArea",label:"Code",defaultValue:"<!-- Put your JavaScript code here. If a trigger is set, the code is executed when the trigger is clicked. Otherwise the code is executed when a page is loaded -->"},{id:"trigger",type:"trigger",label:"Trigger",optional:!0}],vrCompatible:!0});class r_ extends Qs{constructor(e){super(e);o(this,"_apiUserStateKey");o(this,"_visibleNodeTypeIdx");o(this,"_visibleNodes");o(this,"_onStateChanged",(e,i)=>{console.assert(e===this._apiUserStateKey),this._visibleNodeTypeIdx=i,this._updateNodesVisibility()});if(this._apiUserStateKey="SwitchObjects:"+this.name,this._visibleNodeTypeIdx=void 0,this._visibleNodes=[],!this.viewerApi.isSceneReadyToDisplay())for(const i of this.config.nodeTypes)this.viewerApi.setNodeTypeEditable(i)}_affectedMeshes(){const e=new Array;return this.config.nodeTypes.forEach(i=>{this.viewerApi.findNodesOfType(i).forEach(s=>{s.visitSubtree(a=>{a.mesh&&e.push(a.mesh)})})}),e}_updateNodesVisibility(){if(this._visibleNodes.forEach(i=>i.hide()),this._visibleNodeTypeIdx===-1)this._visibleNodes=[];else{const i=this.config.nodeTypes[this._visibleNodeTypeIdx];this._visibleNodes=this.viewerApi.findNodesOfType(i),this._visibleNodes.forEach(n=>n.show())}const e=Gv();e&&e.updateMeshVisibility(this._affectedMeshes()),this.viewerApi.requestFrame()}trigger(){this.config.nodeTypes.length!==0&&(this._visibleNodeTypeIdx=this._visibleNodeTypeIdx+1,this._visibleNodeTypeIdx===this.config.nodeTypes.length&&(this._visibleNodeTypeIdx=this.config.hideAllAfterLast?-1:0),this.viewerApi.apiUserChangeState(this._apiUserStateKey,this._visibleNodeTypeIdx))}isTriggerable(){return!0}doInit(){this._visibleNodes=[],this.viewerApi.onSceneReadyToDisplay(()=>{for(let i=0;i<this.config.nodeTypes.length;++i)(i>0||this.config.hideAllOnStart)&&this.viewerApi.findNodesOfType(this.config.nodeTypes[i]).forEach(s=>s.hide());const e=this.config.nodeTypes.length==0||this.config.hideAllOnStart;this._visibleNodeTypeIdx=e?-1:0,this._updateNodesVisibility(),this._installTriggers()}),this.viewerApi.onApiUserStateChanged(this._apiUserStateKey,this._onStateChanged)}doDispose(){for(let i=0;i<this.config.nodeTypes.length;++i)i!==this._visibleNodeTypeIdx&&this.viewerApi.findNodesOfType(this.config.nodeTypes[i]).forEach(s=>s.show());const e=Gv();e&&e.updateMeshVisibility(this._affectedMeshes()),this.viewerApi.requestFrame()}}o(r_,"definition",{name:"Switch objects",type:Fn.MULTI_STATE,properties:[{id:"nodeTypes",type:"list",elementType:"nodeType",label:"Objects to switch"},{id:"trigger",type:"trigger",label:"Trigger",optional:!0},{id:"hideAllOnStart",type:"bool",label:"Hide all on start",defaultValue:!1},{id:"hideAllAfterLast",type:"bool",label:" Hide all after last",defaultValue:!1}],vrCompatible:!0});class o_ extends ws{constructor(e){super(e);o(this,"_material");o(this,"_initialized");o(this,"_initializationPending");o(this,"_origBaseColorTexture");this._origBaseColorTexture=void 0,this._material=void 0,this._initialized=!1,this._initializationPending=!1,this.viewerApi.isSceneReadyToDisplay()||this.viewerApi.setMaterialEditable(this.config.material)}_createVideoTexture(e){const i=document.createElement("video");if(i.classList.add("video-js"),i.autoplay=!0,i.muted=!0,i.type="application/x-mpegURL",Hls.isSupported()){const n=new Hls;n.loadSource(e),n.attachMedia(i)}else i.canPlayType("application/vnd.apple.mpegurl")?i.src=e:console.log("No Hls support");return this.viewerApi.createStreamTextureFromHtmlVideo(i)}_createStreamTexture(){const e=this._createVideoTexture(this.config.streamUrl);e.addLoadedListener(()=>{this._initializationPending=!1,this.running&&(this._origBaseColorTexture=this._material.baseColorTexture,this._material.baseColorTexture=e,this.viewerApi.onNextPageInteraction(()=>{e.muted=!1}),this._initialized=!0)}),this._initializationPending=!0,e.play()}_stateChanging(){return this._initializationPending?!0:!this._initialized&&!this._initializationPending?(this._createStreamTexture(),!0):!1}activated(){return this._material.isPlaying}activate(){this._stateChanging()||(this.config.playRewinds&&this._material.rewind(),this._material.play())}deactivate(){this._stateChanging()||this._material.pause()}trigger(){this._stateChanging()||super.trigger()}sceneLoadComplete(){const e=this.config;if(this._material=this.viewerApi.findMaterial(e.material),this._material){if(!this._material.baseColorTexture){console.error(`Material '${e.material}' for stream texture control '${e.name}' does not have a stream texture`),this._material=void 0;return}}else{console.error(`Material '${e.material}' for stream texture control '${e.name}' does not exist`);return}const i=()=>{this._installTriggers(),(this.config.autoplay||!this.config.trigger)&&this.trigger()};So(yi("lib/Hls.js"),i,()=>ii.error("Cannot load required library"))}doInit(){this.viewerApi.onSceneLoadComplete(()=>this.sceneLoadComplete())}doDispose(){if(this._material){if(this._initialized){this._initialized=!1;let e=this._material.baseColorTexture;this._material.baseColorTexture=this._origBaseColorTexture,e instanceof st&&e.dispose(),e=void 0,this._origBaseColorTexture=void 0}this._material=void 0}}}o(o_,"definition",{name:"Video Stream",type:Fn.TWO_STATE,properties:[{id:"material",type:"material",label:"Material with stream"},{id:"streamUrl",type:"text",label:"Stream URL"},{id:"trigger",type:"trigger",label:"Trigger",optional:!0},{id:"autoplay",type:"bool",label:"Autoplay",defaultValue:!0},{id:"triggerExclusive",type:"bool",label:"Exclusive",defaultValue:!1},{id:"playRewinds",type:"bool",label:"Play rewinds",defaultValue:!1}],vrCompatible:!0});class a_ extends ws{constructor(e){super(e);o(this,"_material");this._material=void 0,this.viewerApi.isSceneReadyToDisplay()||this.viewerApi.setMaterialEditable(this.config.material)}_videoTextureLoaded(){const e=this._material.baseColorTexture,i=this.config;e.loop=i.loop,i.autoplay?i.muted||this.viewerApi.onNextPageInteraction(()=>{e.muted=!1}):(this._material.pause(),e.muted=i.muted),this._installTriggers()}_sceneLoadComplete(){const e=this.config;if(this._material=this.viewerApi.findMaterial(e.material),this._material){if(!this._material.baseColorTexture||!(this._material.baseColorTexture instanceof jr)||this._material.baseColorTexture.video===void 0){console.error(`Material '${e.material}' for video texture control '${e.name}' does not have a video texture`),this._material=void 0;return}}else{console.error(`Material '${e.material}' for video texture control '${e.name}' does not exist`);return}this._material.baseColorTexture.addLoadedListener(()=>this._videoTextureLoaded())}activated(){var e;return!!((e=this._material)!=null&&e.isPlaying)}deactivate(){var e;(e=this._material)==null||e.pause()}activate(){this.config.playRewinds&&this._material.rewind(),this._material.play()}doInit(){this.viewerApi.onSceneLoadComplete(()=>this._sceneLoadComplete())}doDispose(){this._material&&(this._material.baseColorTexture.muted=!0,this._material.pause(),this._material=void 0)}}o(a_,"definition",{name:"Video texture control",type:Fn.TWO_STATE,properties:[{id:"material",type:"material",label:"Material with video"},{id:"trigger",type:"trigger",label:"Trigger",optional:!0},{id:"autoplay",type:"bool",label:"Autoplay",defaultValue:!0},{id:"triggerExclusive",type:"bool",label:"Exclusive",defaultValue:!1},{id:"playRewinds",type:"bool",label:"Play rewinds",defaultValue:!1},{id:"loop",type:"bool",label:"Loop",defaultValue:!0},{id:"muted",type:"bool",label:"Muted",defaultValue:!0}],vrCompatible:!0});const l_={HtmlLabel:_u,Audio:mu,MaterialPicker:IE,MaterialComboPicker:gu,VideoTextureControl:a_,OpenWebsite:Jm,ChangeView:Qm,HideAnchors:Km,Script:s_,ProjectionScreen:n_,SwitchObjects:r_,VideoStream:o_,MultiTrigger:Zm};function c_(r){return l_[r].definition}class GE{constructor(){o(this,"_extensions",new Array);o(this,"_extensionTypes",l_)}updateConfig(t){this._extensions=[];for(const e of t)this._extensions.push(this._createExtensionFromConfig(e))}_augmentTriggerExclusiveExtension(t){if(!(t instanceof ws&&t.isTriggerExclusive()))return;const e=t.activate;t.activate=i=>{this._extensions.forEach(n=>{if(n instanceof ws&&n!==t&&n.isTriggerExclusive()&&n.activated())try{n.deactivate()}catch(s){}}),e.call(t,i)}}_createExtensionFromConfig(t){function e(a,l){return a.some(c=>c.name===l&&c.config.type===t.type)}t.name=t.name.toString();const i=t.name;let n=2;for(;e(this._extensions,t.name);)t.name=i+n.toString(),n+=1;const s=new this._extensionTypes[t.type](t);return this._augmentTriggerExclusiveExtension(s),s}initExtensionsByType(t){this._loadFontAwesomeIfNeeded(()=>{this.getExtensionsByType(t).forEach(e=>e.init())})}initExtensions(){this._loadFontAwesomeIfNeeded(()=>{this._extensions.forEach(t=>t.init())})}_loadFontAwesomeIfNeeded(t){const e=this._extensions.map(i=>this._getFonts(i.config)).concat(T.FONT_FAMILIES_TO_LOAD).reduce((i,n)=>i.concat(n),[]).filter((i,n,s)=>n===s.indexOf(i));e.length>0&&!T.EDIT_MODE?Pp(e,t,t):t()}_getFonts(t){function e(a){return a.icon&&oh[a.icon].fontFamily}const i=[];function n(a){const l=e(a);l&&i.push(l)}const s=this._extensionTypes[t.type].definition;for(const a of s.properties)if(a.type==="trigger"&&t[a.id])n(t[a.id]);else if(a.type==="list"&&a.elementType==="trigger"&&t[a.id])for(const l of t[a.id])n(l);return i}disposeExtensions(){this._extensions.forEach(t=>t.dispose())}disposeExtensionsByType(t){this.getExtensionsByType(t).forEach(e=>e.dispose())}getEditableExtensionDefinitions(){const t=[];for(const[e,i]of Object.entries(this._extensionTypes||{}))i.definition.hideFromEditor||t.push({type:e,definition:i.definition});return t}getEditableExtensions(){return this._extensions.filter(t=>!t.definition.hideFromEditor)}getEditableTriggerImagePaths(){const t=i=>i.properties.filter(n=>n.type==="trigger").map(n=>n.id),e=new Set;for(const i of this.getEditableExtensions())t(i.definition).forEach(n=>{i.config[n]&&i.config[n].image&&e.add(i.config[n].image)});return Array.from(e)}addExtension(t){this._extensions.push(t),t.init()}createExtension(t){return this._createExtensionFromConfig(t)}removeExtension(t){t.dispose();const e=this._extensions.indexOf(t);e!==-1&&this._extensions.splice(e,1)}shiftExtension(t,e){kc(this._extensions,t,e)}getExtensionIndex(t){return this._extensions.findIndex(e=>e===t)}getConfigs(){return this._extensions.map(function(t){return t.config})}getExtensionsByType(t){return this._extensions.filter(e=>e.type===t)}getExtensionByTrigger(t){return this._extensions.find(e=>e.triggers.includes(t))}getExtension(t,e){const i=this._extensions.find(n=>n.type===t&&n.name===e);if(i)return i;console.error(`Unrecognized extension ${t} ${e}, supported types: ${Object.keys(this._extensionTypes)}`)}}const hh={cardboardConfig:{ADDITIONAL_VIEWERS:[],DEFAULT_VIEWER:"",MOBILE_WAKE_LOCK:!0,DEBUG:!1,DPDB_URL:null,CARDBOARD_UI_DISABLED:!1,K_FILTER:.98,ROTATE_INSTRUCTIONS_DISABLED:!1,PREDICTION_TIME_S:.04,YAW_ONLY:!1,BUFFER_SCALE:1,DIRTY_SUBMIT_FRAME_BINDINGS:!1}};class No{constructor(){this.clock=performance||Date,this.reset()}reset(){this.startMS=this.clock.now()}elapsedMSec(){return this.clock.now()-this.startMS}elapsedSec(){return this.elapsedMSec()*.001}}class Eu{constructor(t,e){this.nativeTimeoutId=null,this.durationMSec=t,this.callback=e}isRunning(){return this.nativeTimeoutId!==null}start(){function t(){this.nativeTimeoutId=null,this.callback&&this.callback()}this.nativeTimeoutId!==null&&clearTimeout(this.nativeTimeoutId),this.nativeTimeoutId=setTimeout(t,this.durationMSec)}}function HE(r,t){const e=new No,i=new Uint8Array(1*1*4),n=T.BENCHMARK_MEASUREMENTS?parseInt(T.BENCHMARK_MEASUREMENTS):60*16,s=3,a=.1;this.benchmarking=t;const l="EXT_disjoint_timer_query_webgl2",c=r,h=c.getSupportedExtensions().includes(l)?c.getExtension(l):null;h||alert(l+" support isn't enabled in this browser. Using gl.readPixels() as a means of synchronisation.");let d=null,u=!1,f=!1,p=[];this.lastMS=0,this.lastFPS=0,this.benchmarking&&document.addEventListener("keydown",m=>{m.code=="KeyB"&&(m.shiftKey?this.extensiveLogging():p=[])}),this.tearDownQuery=function(){u=!1,f=!1,d&&(c&&c.deleteQuery(d),d=null)},this.extensiveLogging=function(){const m=Array.from(p).sort((M,D)=>M-D);this.max=m.at(-1);const b=Math.floor(m.length*(1-a)),g=Math.floor(m.length/2),x=Math.floor(m.length*a),w=m.reduce((M,D)=>M+D,0)/m.length;let C;T.BENCHMARK_LIST_ALL?C=m.reduce((M,D)=>M+D.toFixed(s)+";",""):C=`high median average low 
`+m[b].toFixed(s)+" "+m[g].toFixed(s)+" "+w.toFixed(s)+" "+m[x].toFixed(s)+` 
`,T.BENCHMARK_OUTPUT==="console"?console.log(C):prompt(C+`
You can copy the result of the performance measurement by CTRL-C`,C),p=[]},this.addNewMeasurement=function(m){this.lastMS=m,this.lastFPS=1e3/this.lastMS,this.benchmarking&&(p.push(this.lastMS),p.length==n&&this.extensiveLogging())},this.glQueryEnd=function(){if(f||(c.endQuery(h.TIME_ELAPSED_EXT),f=!0),c.getParameter(h.GPU_DISJOINT_EXT)){this.tearDownQuery();return}if(!c.getQueryParameter(d,c.QUERY_RESULT_AVAILABLE))return;const g=c.getQueryParameter(d,c.QUERY_RESULT);this.addNewMeasurement(g/Math.pow(10,6)),this.tearDownQuery()},this.begin=function(){e.reset(),h&&!u&&(d=c.createQuery(),c.beginQuery(h.TIME_ELAPSED_EXT,d),u=!0)},this.end=function(){h?u&&this.glQueryEnd():(c.readPixels(0,0,1,1,c.RGBA,c.UNSIGNED_BYTE,i),this.addNewMeasurement(e.elapsedSec()*1e3))}}function h_(r,t){let e=null;function i(){e=null,r()}this.deferRun=function(){e!==null&&clearTimeout(e),e=setTimeout(i,t)}}function WE(r,t){let e=null;function i(){r()}this.deferRun=function(){e!==null&&clearInterval(e),e=setInterval(i,t)}}/*!
 * Copyright (C) 2018-present Shapespark
 */const jE=10,XE=200,d_=1.3,qE=1/5,u_=1,YE=1.9,QE=1.5,Uo=new L;function Au(r){if(r.empty())return 0;r.size(Uo);const t=Uo.x*Uo.y;return Uo.x<u_||Uo.y<u_||Uo.z<YE||t<QE?0:t*Uo.z}function KE(r,t,e=.1){return r.min.x-e<=t.min.x&&t.max.x<=r.max.x+e&&r.min.y-e<=t.min.y&&t.max.y<=r.max.y+e&&r.min.z-e<=t.min.z&&t.max.z<=r.max.z+e}function $E(r,t,e=.2){return!(r.max.x<t.min.x+e||r.min.x>t.max.x-e||r.max.y<t.min.y+e||r.min.y>t.max.y-e||r.max.z<t.min.z+e||r.min.z>t.max.z-e)}class f_{constructor(t){o(this,"_emptyBoxes",new Array);o(this,"_filledBoxes",new Array);o(this,"_tempBoxes",new Array);this._emptyBoxes.push(t);for(let e=0;e<6;e++)this._tempBoxes[e]=new li}addFilledBox(t){this._filledBoxes.push(t)}findBestFilledBoxes(){let t=new Array;this._filledBoxes.forEach(i=>t.push([i,i.volume()]));const e=new Array;for(;t.length>0&&e.length<jE;){const i=Id(t,s=>s[1]),n=t[i][0];e.push(n),t=t.filter(s=>!$E(s[0],n))}return e}isEnclosedInFilledBox(t){return this._filledBoxes.some(e=>KE(e,t))}findLargestEmptyBox(){const t=Id(this._emptyBoxes,e=>e.volume());return t!==void 0?this._emptyBoxes[t]:void 0}_visualizeBoxes(t,e,i,n=0){const s=new L,a=new Array,l=new li;for(const c of t){l.copyFrom(c),l.min.subScalar(n),l.max.addScalar(n);const h=new je(e,i);s.addVectors(l.min,l.max).multiplyScalar(.5),h.scale.subVectors(l.min,l.max),h.position.copyFrom(s),a.push(h)}return a}visualize(t){const e=ft.createBox(1,1,1),i=new Es(new _e(65280)),n=new Es(new _e(16711680)),s=.1,a=this._visualizeBoxes(this._emptyBoxes,e,i),l=this._visualizeBoxes(this._filledBoxes,e,n,s);for(const c of[...a,...l])t.add(c);t.updateMatrixWorld()}_doSplit(t,e,i){const n=this._tempBoxes;n[0].max.copyFrom(t.max),n[0].min.copyFrom(t.min),n[0].min.z=e.max.z,n[1].max.copyFrom(t.max),n[1].max.z=e.min.z,n[1].min.copyFrom(t.min),n[2].max.copyFrom(t.max),n[2].min.copyFrom(t.min),n[2].min.x=e.max.x,n[3].max.copyFrom(t.max),n[3].max.x=e.min.x,n[3].min.copyFrom(t.min),n[4].max.copyFrom(t.max),n[4].min.copyFrom(t.min),n[4].min.y=e.max.y,n[5].max.copyFrom(t.max),n[5].max.y=e.min.y,n[5].min.copyFrom(t.min);const s=Id(n,Au);Au(n[s])!==0&&(i.push(n[s].clone()),s===0?t.max.z=e.max.z:s===1?t.min.z=e.min.z:s===2?t.max.x=e.max.x:s===3?t.min.x=e.min.x:s===4?t.max.y=e.max.y:s===5&&(t.min.y=e.min.y),this._doSplit(t,e,i))}split(t){const e=new Array;for(let i=0;i<this._emptyBoxes.length;i+=1){const n=this._emptyBoxes[i];n.isIntersectionBox(t)?this._doSplit(n,t,e):e.push(n)}this._emptyBoxes=e}}o(f_,"DEBUG",!1);function p_(r,t){r.center(t.position),t.position.z=r.min.z+d_}function ZE(r,t,e){const i=new f_(r.boundingBox.clone()),n=new li,s=new li,a=new L,l=new No,c=new nn({id:0});for(let f=0;f<XE;f+=1){const p=i.findLargestEmptyBox();if(p===void 0)break;p_(p,c),c.enableBoundingBox(),s.makeEmpty();for(let m=0;m<5&&(t.findBounds(c),!!c.isBoundingBoxInitialized());m+=1){n.set(c.boxMin,c.boxMax);const b=Au(n);if(b===0||i.isEnclosedInFilledBox(n))break;n.center(a),a.z=n.min.z+d_;const g=c.position.distanceToSquared(a);if(s.volume()<b&&g<.25&&s.set(n.min,n.max),g<.04)break;c.position.copyFrom(a)}s.empty()?(p.center(n.min),p.center(n.max),i.split(n)):(i.addFilledBox(s.clone()),i.split(s))}Re.log("Light probes arrangement time "+l.elapsedSec());const h=i.findBestFilledBoxes(),d=h.reduce((f,p)=>f+p.volume(),0);function u(f){const p=new nn({id:r.lightProbes.length});p_(f,p),p.enableBoundingBox(),p.boxMin.copyFrom(f.min),p.boxMax.copyFrom(f.max),r.lightProbes.push(p)}(d>r.boundingBox.volume()*qE||e)&&h.forEach(u),r.lightProbes.length===0&&e&&u(r.boundingBox)}class pl extends yt{constructor(t=!1){super(),this.addToNewRenderer=t,this.overrideMaterial=null,this.autoUpdate=!0}shouldAddToNewRenderer(){return this.addToNewRenderer}clone(t){return t===void 0&&(t=new pl),yt.prototype.clone.call(this,t),this.overrideMaterial!==null&&(t.overrideMaterial=this.overrideMaterial.clone()),t.autoUpdate=this.autoUpdate,t.matrixAutoUpdate=this.matrixAutoUpdate,t}}class Tu{static merge(t){const e={};for(let i=0;i<t.length;i++){const n=Tu.clone(t[i]);for(const s in n)Object.prototype.hasOwnProperty.call(n,s)&&(e[s]=n[s])}return e}static clone(t){const e={};for(const i in t)if(Object.prototype.hasOwnProperty.call(t,i)){e[i]={};for(const n in t[i]){if(!Object.prototype.hasOwnProperty.call(t[i],n))continue;const s=t[i][n];s&&s.clone!==void 0?e[i][n]=s.clone():s instanceof Array?e[i][n]=s.slice():e[i][n]=s}}return e}}function ds(r,t,e){this.textureID=t!==void 0?t:"tDiffuse",this.depthID=e!==void 0?e:"tDepth",this.material=new bt({vsName:r.vertexShaderName,fsName:r.fragmentShaderName}),this.material.uniforms=Tu.clone(r.uniforms),this.uniforms=this.material.uniforms,this.renderToScreen=!1,this.enabled=!0,this.needsSwap=!0,this.clear=!1,this.camera=An.createNDC(),this.scene=new pl,this.quad=new je(ft.createPlane(2,2),this.material),this.scene.add(this.quad)}ds.prototype={render:function(r,t,e,i){const n=this.material.uniforms[this.textureID];n&&(n.value=e);const s=this.material.uniforms[this.depthID];s&&(s.value=e.depthTexture),this.renderToScreen?r.render(this.scene,this.camera):r.render(this.scene,this.camera,t,this.clear)},dispose:function(){this.material.dispose(),this.quad.geometry.dispose()}};/*!
 * Copyright (C) 2015-present Shapespark
 */function JE(r){return{uniforms:{roughness:{type:"f",value:.9},face:{type:"f",value:0},mipSize:{type:"f",value:128},envMap:{type:"t",value:null},envMapFiltered:{type:"t",value:null},integrationNumSamples:{type:"i",value:r}},vertexShaderName:"cubemap_filter_vertex.glsl",fragmentShaderName:"cubemap_filter_fragment.glsl"}}function eA(r,t){return Math.round(r[t]*256*256+r[t+1]*256+r[t+2])}function tA(r,t){const e=r.length;for(let i=0;i<e;i+=4){const n=eA(r,i);n!==16777215&&t.add(n)}}function iA(r,t,e){const i=new vm(!0),n=new Yd(T.CAMERA_WALK_NEAR,e),s=T.OBJECT_VISIBILITY_TARGET_SIZE;let a=r.createRenderTarget(s,s,{magFilter:H.NEAREST,minFilter:H.NEAREST,depthBuffer:!0,stencilBuffer:!1,generateMipmaps:!1}),l=new Uint8Array(4*s*s);const c=new br(r),h=new ih(r);this.getVisibilityMaterial=function(){return i},this.findVisibleObjects=function(d){const u=new Set,f=[];n.position.copyFrom(d),n.updateMatrixWorld();for(let m=0;m<t.length;m+=1){const b=t[m];console.assert(!b.visibilityId),b.visibilityId=m,f.push(b)}c.set(!0,!0,!1),h.set(_e.WHITE);for(let m=0;m<6;m+=1)r.renderMeshes(f,i,n.sideCameras[m],a),r.readPixels(s,s,l),tA(l,u);h.restore(),c.restore();const p=[];for(let m of u)p.push(t[m]);for(let m=0;m<t.length;m+=1)t[m].visibilityId=null;return p},this.dispose=function(){i.dispose(),a.dispose(),a=null,l=null}}var nA=Object.defineProperty,sA=Object.getOwnPropertyDescriptor,Bn=(r,t,e,i)=>{for(var n=i>1?void 0:i?sA(t,e):t,s=r.length-1,a;s>=0;s--)(a=r[s])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&nA(t,e,n),n};function rA(r,t){for(const e of r)if(e.material.envMapMirror&&e.lightProbes.includes(t))return!0;return!1}function oA(r,t){return Math.pow(2,Sd(t)-r)}let $s;function aA(r,t){let e=null,i=0;const n=t*t;console.assert(n<Math.pow(2,16)),$s||($s=new Uint16Array(256*256));for(let s=0;s<n*4;s+=4){const a=r[s],l=r[s+1];$s[a*256+l]+=1}$s[0]>.7*n&&(i=$s[0]),$s[0]=0;for(let s=1;s<$s.length;s+=1)$s[s]>i&&(i=$s[s],e=Math.floor(s/256)+s%256/255),$s[s]=0;return e}const wn=(ta=class{constructor(t,e,i,n,s){o(this,"_renderer");o(this,"_scene");o(this,"_aabbQueryMaterial",new Dy);o(this,"_filterPass");o(this,"_pixelBuf");o(this,"_targetCubeRaw");o(this,"_targetFiltered");o(this,"_autoClearAlter");o(this,"_timer",new No);o(this,"_cubeCamera");o(this,"_objectVisibilityQuery");o(this,"_mirrorCubeTexturesEnabled");o(this,"_alwaysCreateMirrorCubeTextures");o(this,"_orthoCubeCamera");o(this,"_numRenderedCubeMaps",0);const a={magFilter:H.LINEAR,minFilter:H.LINEAR,depthBuffer:!0,stencilBuffer:!1,generateMipmaps:!1};this._renderer=e,this._scene=t,this._filterPass=new ds(JE(s),"envMap");const l=T.LIGHT_PROBE_MAX_MIP_SIZE;this._pixelBuf=new Uint8Array(l*l*4),this._targetCubeRaw=e.createRenderTargetCube(l,l,a),a.depthBuffer=!1,this._targetFiltered=e.createRenderTarget(l,l,a),this._autoClearAlter=new br(e),this._cubeCamera=new Yd(ta.CUBE_CAMERA_NEAR,t.camera.far),this._mirrorCubeTexturesEnabled=i,this._alwaysCreateMirrorCubeTextures=n}_dumpCubeMapFace(t,e,i){const n=t.width,s=t.height,a=new Uint8Array(n*s*4);this._renderer.readPixels(n,s,a);const l=String(i).padStart(4,"0");Lc(Wc(n,s,a),`cubemap_${l}_${e}.tga`)}_lightProbeRenderingSettingsOn(t,e,i){this._scene.sharedMaterialState.hdrOutput=!0,this._scene.gpuMeshes.forEach(n=>{n.materialOverride&&!i.has(n)&&(i.set(n,n.materialOverride),n.materialOverride=null)}),this._scene.skyMeshes.forEach(n=>{i.set(n,n.visible),n.visible=!0}),this._scene.threeScene.traverse(function(n){if(!(n instanceof je)||!n.visible)return;const s=n.material;if(n.userData.hideFromLightProbes||s.hideFromLightProbes){t.add(n),n.visible=!1;return}!(s instanceof Qt)||e.has(s)||(e.set(s,{disableLightProbe:s.disableLightProbe,headLight:s.headLight}),s.transparent=!1,s.blending=Yt.DISABLED,s.depthWrite=!0,s.headLight!==void 0&&(s.headLight=!1),s.disableLightProbe=!0,s.setUniforms())})}_lightProbeRenderingSettingsOff(t,e,i){this._scene.sharedMaterialState.hdrOutput=!1,this._scene.gpuMeshes.forEach(n=>{i.has(n)&&(n.materialOverride=i.get(n),i.delete(n))}),this._scene.skyMeshes.forEach(n=>{i.has(n)&&(n.visible=i.get(n),i.delete(n))}),this._scene.threeScene.traverse(function(n){if(!(n instanceof je))return;const s=n.material;if(s instanceof Qt&&s.forceObjectUniformsRefresh(),!n.visible){t.has(n)&&(n.visible=!0);return}if(s instanceof Qt){const a=e.get(s);if(!a)return;e.delete(s),s.configureTransparency(),a.headLight!==void 0&&(s.headLight=a.headLight),s.disableLightProbe=a.disableLightProbe,s.setUniforms(),s.notifyUpdated()}})}_renderLightProbe(t,e){if(T.DEV_NEW_RENDER_ARCHITECTURE){const i=t.sideCameras[0],n=new $p;n.near=i.near,n.far=i.far,n.position=new L().copyFrom(t.position),n.renderTarget=e,pt.get().render(n)}else for(let i=0;i<6;i+=1){e.activeCubeFace=i;const n=t.sideCameras[i];this._renderer.render(this._scene.threeScene,n,e)}this._numRenderedCubeMaps++}_createMirrorCubeTexture(t){const e=T.LIGHT_PROBE_MIRROR_SIZE,i=this._renderer.createRenderTargetCube(e,e,{magFilter:H.LINEAR,minFilter:H.LINEAR,stencilBuffer:!1,generateMipmaps:!1});return this._renderLightProbe(t,i),this._renderer.deallocateRenderTargetRenderingBuffers(i),i}_findLightProbeBounds(t,e){const i=this._targetCubeRaw;this._pixelBuf,this._orthoCubeCamera||(this._orthoCubeCamera=new Ay(.01,255)),this._orthoCubeCamera.position.copyFrom(t.position),this._orthoCubeCamera.updateMatrixWorld();for(let n=0;n<6;n+=1){i.activeCubeFace=n,this._aabbQueryMaterial.axis=Math.floor(n/2),this._renderer.renderMeshes(this._scene.gpuMeshes,this._aabbQueryMaterial,this._orthoCubeCamera.sideCameras[n],i),this._renderer.readPixels(i.width,i.height,this._pixelBuf);const s=aA(this._pixelBuf,i.width);if(s===null){Re.log("Failed to find light probe bounds"),Re.log(`Light probe bounds: X[${e.boxMin.x.toFixed(2)}:${e.boxMax.x.toFixed(2)}] Y[${e.boxMin.y.toFixed(2)}:${e.boxMax.y.toFixed(2)}] Z[${e.boxMin.z.toFixed(2)}:${e.boxMax.z.toFixed(2)}]`),e.resetBoundingBox();return}const a=Math.floor(n/2),l=n&1?-1:1;(n&1?e.boxMin:e.boxMax).setComponent(a,t.position.getComponent(a)+s*l)}}_fillMipDebugBuffer(t,e,i){const n=255*t/T.LIGHT_PROBE_MIPS_COUNT;for(let s=0;s<4*e*e;s+=4)i[s]=n,i[s+1]=n,i[s+2]=n,i[s+3]=255/8}_readBuffer(t,e,i){let n=!0;for(;n;){t.readPixels(e,e,i);for(let s=0;s<e*e*4;s+=4)if(i[s]!==0||i[s+1]!==0||i[s+2]!==0){n=!1;break}if(n){console.warn("Cube face has all pixels black.");return}}}_generateFilteredTextureMip(t,e,i,n,s,a,l,c){T.DEBUG_LIGHT_PROBE_MIPS&&this._fillMipDebugBuffer(l,s,a);for(let h=0;h<6;h+=1)T.DEBUG_LIGHT_PROBE_MIPS||(e.uniforms.face.value=h,e.render(t,n,i),this._readBuffer(t,s,a)),t.copyFramebufferToCubeFaceMip(l,s,h,a,c)}createTextures(t,e,i,n){if(this._autoClearAlter.set(!0,!0,!1),i){const l=this._createMirrorCubeTexture(t);n.setMirrorTexture(l)}e&&this._findLightProbeBounds(t,n),this._renderLightProbe(t,this._targetCubeRaw),this._autoClearAlter.restore(),this._renderer.recreateWebGLState(),this._renderer.enableScissorTest(!0),this._autoClearAlter.set(!1,!1,!1);const s=this._targetFiltered.width;let a;T.DEV_NEW_RENDER_ARCHITECTURE?a=pt.get().createCubeTexture(s,!0):a=this._renderer.createCubeTexture(s,!0),n.setFilteredTexture(a),this._filterPass.uniforms.envMapFiltered.value=a;for(let l=0;l<T.LIGHT_PROBE_MIPS_COUNT;l+=1){const c=oA(l,s);this._renderer.setScissor(0,0,c,c);const h=l/(T.LIGHT_PROBE_MIPS_COUNT-1);this._filterPass.uniforms.mipSize.value=c,this._filterPass.uniforms.mipSize.value=c,this._filterPass.uniforms.roughness.value=h,this._pixelBuf,this._generateFilteredTextureMip(this._renderer,this._filterPass,this._targetCubeRaw,this._targetFiltered,c,this._pixelBuf,l,a)}this._renderer.enableScissorTest(!1),this._autoClearAlter.restore()}assignLightProbeIfClosest(t,e){const i=e.geometry.boundingSphere.center,n=T.ENABLE_REFLECTION_PROBES_BLENDING?T.MAX_BLENDED_REFLECTION_PROBES:1;if(e.lightProbes.length==0){e.lightProbes.push(t);return}const s=i.distanceTo(t.position);let a=e.lightProbes.findIndex(l=>s<=i.distanceTo(l.position));for(a===-1&&(a=e.lightProbes.length),e.lightProbes=[...e.lightProbes.slice(0,a),t,...e.lightProbes.slice(a,e.lightProbes.length)];e.lightProbes.length>n;)e.lightProbes.pop()}_assignFallbackLightProbesToObjects(t,e){Re.log("No visible light probe found for "+e.length+" objects. Assigning the closest ones.");for(let i=0;i<e.length;i+=1)for(let n=0;n<t.length;n+=1)this.assignLightProbeIfClosest(t[n],e[i])}assignLightProbesToObjects(){this._timer.reset(),this._objectVisibilityQuery||(this._objectVisibilityQuery=new iA(this._renderer,this._scene.gpuMeshes,this._scene.camera.far));for(const e of this._scene.gpuMeshes)e.lightProbes=[];for(const e of this._scene.lightProbes){mt.beginSection("Render probe visibility");let i;if(T.DEV_NEW_RENDER_ARCHITECTURE){const n=new Zp;n.position=new L().copyFrom(e.position),n.near=T.CAMERA_WALK_NEAR,n.far=this._scene.camera.far,n.visibilityMaterial=this._objectVisibilityQuery.getVisibilityMaterial(),pt.get().render(n),i=n.visibleObjects}else i=this._objectVisibilityQuery.findVisibleObjects(e.position);Re.log("Have visible objects "+i.length);for(const n of i)this.assignLightProbeIfClosest(e,n);mt.endSection("Render probe visibility")}Re.log("Light probe assigment time "+this._timer.elapsedSec());const t=e=>e.lightProbes.length===0;this._assignFallbackLightProbesToObjects(this._scene.lightProbes,this._scene.gpuMeshes.filter(t)),T.DEV_NEW_RENDER_ARCHITECTURE&&pt.get().refreshReflectionProbesAssignment()}_doCreateLightProbeTexture(t,e){this._cubeCamera.position.copyFrom(t.position),this._cubeCamera.updateMatrixWorld();const i=this._mirrorCubeTexturesEnabled&&(this._alwaysCreateMirrorCubeTextures||rA(this._scene.gpuMeshes,t));i&&Re.log("Mirror texture needed for the light probe."),this._timer.reset(),this.createTextures(this._cubeCamera,e,i,t),Re.log("Cube generation time "+this._timer.elapsedSec())}findBounds(t){this._cubeCamera.position.copyFrom(t.position),this._cubeCamera.updateMatrixWorld(),this._autoClearAlter.set(!0,!0,!1),this._findLightProbeBounds(this._cubeCamera,t),this._autoClearAlter.restore()}createLightProbeTexture(t,e){const i=new Set,n=new Map,s=new Map;this._lightProbeRenderingSettingsOn(i,n,s),this._doCreateLightProbeTexture(t,e),this._lightProbeRenderingSettingsOff(i,n,s)}createAllLightProbeTextures(){const t=new Set,e=new Map,i=new Map;this._lightProbeRenderingSettingsOn(t,e,i);for(const n of this._scene.lightProbes)this._doCreateLightProbeTexture(n,!1);this._lightProbeRenderingSettingsOff(t,e,i)}dispose(){this._targetCubeRaw.dispose(),this._targetFiltered.dispose(),this._aabbQueryMaterial.dispose(),this._filterPass.material.dispose(),this._pixelBuf=void 0,this._objectVisibilityQuery&&(this._objectVisibilityQuery.dispose(),this._objectVisibilityQuery=void 0)}},o(ta,"DUMP_CUBE_MAPS",!1),o(ta,"CUBE_CAMERA_NEAR",.15),ta);Bn([Vt()],wn.prototype,"_lightProbeRenderingSettingsOn",1),Bn([Vt()],wn.prototype,"_lightProbeRenderingSettingsOff",1),Bn([Vt()],wn.prototype,"_renderLightProbe",1),Bn([Vt()],wn.prototype,"_findLightProbeBounds",1),Bn([Vt()],wn.prototype,"_readBuffer",1),Bn([Vt()],wn.prototype,"_generateFilteredTextureMip",1),Bn([Vt()],wn.prototype,"createTextures",1),Bn([Vt()],wn.prototype,"assignLightProbeIfClosest",1),Bn([Vt()],wn.prototype,"_assignFallbackLightProbesToObjects",1),Bn([Vt()],wn.prototype,"assignLightProbesToObjects",1),Bn([Vt()],wn.prototype,"_doCreateLightProbeTexture",1),Bn([Vt()],wn.prototype,"findBounds",1),Bn([Vt()],wn.prototype,"createLightProbeTexture",1),Bn([Vt()],wn.prototype,"createAllLightProbeTextures",1);let lA=wn;var cA=Object.defineProperty,hA=Object.getOwnPropertyDescriptor,dA=(r,t,e,i)=>{for(var n=i>1?void 0:i?hA(t,e):t,s=r.length-1,a;s>=0;s--)(a=r[s])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&cA(t,e,n),n};class uA{}class m_ extends uA{constructor(e,i){super();o(this,"gpuDataConstructorType");o(this,"_doUpdateData");this._doUpdateData=i,this.gpuDataConstructorType=e}getDataConstructorType(){return this.gpuDataConstructorType}updateData(e,i){i.loadObject(this._doUpdateData(e))}}let Mt=class{constructor(r){o(this,"drawCall",new qr);o(this,"perObjectUpdaters",new Array);o(this,"material");o(this,"meshResourceDescriptor");o(this,"perObjectUniformBuffer");r!=null&&r.material&&(r==null||r.meshResourceDescriptor),this.material=r.material,this.meshResourceDescriptor=r.meshResourceDescriptor,r.drawCall&&(this.drawCall=r.drawCall),r.perObjectUpdaters&&(this.perObjectUpdaters=r.perObjectUpdaters)}};Mt=dA([tl.ImGuiCustomDisplay(r=>{const t=r;t.material.name&&ImGui.Text(t.material.name),ImGui.Text("VS: "+t.material.vertexShaderName+" FS: "+t.material.fragmentShaderName)})],Mt);class xi{constructor(){o(this,"materialOverride");o(this,"meshResourceDescriptorOverride");o(this,"drawCallComp");o(this,"perObjectShaderDefines",new Array);o(this,"perObjectUpdaters",new Array);o(this,"fsOutputs",new Array)}}class Qr{constructor(){o(this,"lineColor",new _e);o(this,"lineThickness",0);o(this,"backsideLineThickness",0)}}function ml(){const r={uniforms:{inputBuffer:{type:"t",value:null},weight:{type:"f",value:1}},vertexShaderName:"accumulate_vertex.glsl",fragmentShaderName:"accumulate_fragment.glsl"};ds.call(this,r,"inputBuffer"),this.material.depthTest=!1,this.material.depthWrite=!1,this.material.blending=Yt.CUSTOM,this.material.blendEquation=H.FUNC_ADD,this.material.blendDst=H.ONE_MINUS_SRC_ALPHA,this.material.blendSrc=H.SRC_ALPHA}ml.prototype=Object.create(ds.prototype),ml.prototype.constructor=ml;function fA(r,t,e,i,n){const s=r/t,a=Math.tan(Ai(n.fov)*.5),l=n.near*a/n.zoom,c=-l,h=c*s,d=l*s,u=(d-h)/r,f=(l-c)/t;n.projectionMatrix.makeFrustum(h-e*u,d-e*u,c-i*f,l-i*f,n.near,n.far)}function pA(r,t,e,i,n){const s=n.top,a=n.bottom,l=n.left,c=n.right,h=(c-l)/r,d=(a-s)/t;n.projectionMatrix.makeOrthographic(l-e*h,c-e*h,s-i*d,a-i*d,n.near,n.far)}function __(r){if(r instanceof Xs)return fA;if(r instanceof An)return pA;console.error("Unsupported camera type")}function mA(){const r={uniforms:{tDiffuse:{type:"t",value:null}},vertexShaderName:"copy_texture_vertex.glsl",fragmentShaderName:"copy_texture_fragment.glsl"},t=new ds(r);return t.renderToScreen=!0,t}function wu(r,t,e){e===void 0&&(t.camera.addEventListener(At.eventType.PROJECTION_TYPE_UPDATED,()=>this.updateProjectionType()),e=t.camera.current);let i,n,s=0;const a=[[.375,.4375],[.625,.0625],[.875,.1875],[.125,.0625],[.375,.6875],[.875,.4375],[.625,.5625],[.375,.9375],[.625,.3125],[.125,.5625],[.125,.8125],[.375,.1875],[.875,.9375],[.875,.6875],[.125,.3125],[.625,.8125]],l=new ml,c=mA(),h=new br(r);let d=__(e);this.updateProjectionType=()=>{e=t.camera.current,d=__(e)},this.reset=function(){s=0},this.renderSample=function(u,f){console.assert(s<a.length),h.set(!0,!0,!1),d(n.width,n.height,a[s][0]-.5,a[s][1]-.5,e),u?r.renderMeshes(u,f,e,i,!0):(console.assert(!(f!==void 0&&u===void 0),"Passing overrideMaterial without passing meshes is not implemented"),r.render(t.threeScene,e,i,!0)),h.restore(),h.set(!1,!1,!1),l.uniforms.weight.value=1/(s+1),l.render(r,n,i),h.restore(),e.updateProjectionMatrix(),s+=1},this.renderedSamplesCount=function(){return s},this.allSamplesRendered=function(){return s===a.length},this.renderAllSamples=function(u,f){for(;!this.allSamplesRendered();)this.renderSample(u,f)},this.renderAccumulatedSamplesToScreen=function(){h.set(!0,!0,!1),c.render(r,void 0,n),h.restore()},this.copyAccumulatedSamplesToBuffer=function(){const u=n.width,f=n.height,p=new Uint8Array(u*f*4);return r.readPixels(u,f,p),p},this.setTargets=function(u,f){console.assert(u.width===f.width&&u.height===f.height),i=u,n=f},this.dispose=function(){l.material.dispose()}}function _A(r){const t=new ex(new _e(0,0,0),1),e=new Qt;return e.sharedMaterialState=r.sharedMaterialState,e.reflective=!1,e.headLight=!1,e.setUniforms(),{outlineMaterial:t,planMaterial:e}}function gA(r,t,e,i){const n=Math.max(r,t),s=Math.max(e.size().x,e.size().y);return n/s*i}function g_(r,t,e){for(let i=0;i<e;++i)for(let n=0;n<t;++n){const s=4*(i*t+n);if(i<e/2){const a=4*((e-i-1)*t+n);for(let l=0;l<4;++l){const c=r[s+l];r[s+l]=r[a+l],r[a+l]=c}}}}function Su(r,t){return console.assert(t%4===0,"id passed does not point to alpha channel"),r[t+3]!==0}function v_(r,t){return console.assert(t%4===0,"id passed does not point to alpha channel"),r[t+3]<255}function vA(r,t,e){return r[e+3]<255&&r[e+3]>=r[t+3]}function bA(r,t){for(let e=0;e<r.length;e+=4)if(Su(t,e)){const i=t[e+3]/255;for(let n=0;n<3;++n)r[e+n]=r[e+n]*(1-i)+t[e+n]*i;r[e+3]=255}}function yA(r,t=void 0){const e=new Uint8Array(r.length);for(let i=0;i<r.length;i+=4)if(Su(r,i)&&(!t||v_(t,i)))for(let n=0;n<4;++n)e[i+n]=255;return e}function xA(r,t,e){return r[e]===0&&v_(t,e)}function EA(r,t,e,i){return r[i]===0&&vA(t,e,i)}function b_(r,t,e){t[r]=1,e.push(r)}function AA(r,t,e,i,n){for(let s=0;s<t.length;++s)EA(e,i,r,r+t[s])&&b_(r+t[s],e,n)}function TA(r,t,e,i){const n=[],s=[];for(b_(r,e,s);s.length;){const a=s.pop();n.push(a),AA(a,t,e,i,s)}return n}function wA(r,t,e){for(let i=0;i<r.length;++i)e[r[i]]=255*t.r,e[r[i]+1]=255*t.g,e[r[i]+2]=255*t.b,e[r[i]+3]=255}function SA(r,t,e,i=.02){const n=new Uint8Array(t.length),s=t.length/4*i,a=[-4,4,-r*4,r*4];for(let l=0;l<t.length;l+=4)if(xA(n,t,l)){const c=TA(l,a,n,t);c.length<s&&wA(c,e,t)}return t}function MA(r,t){for(let e=0;e<r.length;e+=4)if(Su(r,e)){const i=(r[e]+r[e+1]+r[e+2])/3;r[e]=t.r*255,r[e+1]=t.g*255,r[e+2]=t.b*255,r[e+3]=i}}function Mu(r,t,e){return r.createRenderTarget(t,e,{magFilter:H.NEAREST,minFilter:H.NEAREST,stencilBuffer:!1,generateMipmaps:!1})}function Pu(r,t,e){r.near=t,r.far=e,r.updateProjectionMatrix()}function PA(r,t){const e={uniforms:{tColor:{type:"t",value:null},tAlpha:{type:"t",value:null},colorFill:{type:"c",value:null}},vertexShaderName:"minimap_add_alpha_vertex.glsl",fragmentShaderName:"minimap_add_alpha_fragment.glsl"},i=new ds(e,"tColor");return i.uniforms.tAlpha.value=r,t&&(i.material.condDefine(!0,"USE_ALPHA_FROM_COLOR"),i.uniforms.colorFill.value=t),i}function CA(r,t){const i=new _e(1,1,1),n=_A(t);function s(c,h,d,u,f,p,m){if(T.DEV_NEW_RENDER_ARCHITECTURE){const C=z=>!(f&&!z.hasTag(Sm)||u&&z.hasComponent(Mt)&&z.get(Mt).material.transparent||z.hasComponent(Qr)),M=new Wd,D=M.projectionComp;D.viewportSize=new ye(h.width,h.height),D.isPerspective=!1,D.near=c.near,D.far=c.far,D.left=c.left,D.right=c.right,D.top=c.top,D.bottom=c.bottom,M.cameraPosition.copyFrom(c.position),c.rotation.toQuaternion(M.cameraRotation),M.overrideMaterial=d,M.entityFilter=C,M.postprocessComp.antialiasingType=xs.TAA,pt.get().render(M);const W=M.resultBuffer;return g_(W,h.width,h.height),m&&MA(W,m),W}const b=new Uint8Array(h.width*h.height*4),g=new br(r),x=new ih(r);g.set(!0,!0,!1),x.set(new _e(0),0);const w=[];if(t.gpuMeshes.forEach(C=>{(C.logicalMeshes||[C]).forEach(D=>{const W=f?!D.node.disableCollisions:!0;(u?!D.material.transparent:!0)&&W&&w.push(D)})}),p){const C=Mu(r,h.width,h.height),M=Mu(r,h.width,h.height),D=new wu(r,t,c);D.setTargets(C,M),D.renderAllSamples(w,d);const W=PA(C,m);g.restore(),g.set(!0,!0,!1),W.render(r,h,M),g.restore(),r.readPixels(h.width,h.height,b),C.dispose(),M.dispose(),D.dispose()}else r.renderMeshes(w,d,c,h),g.restore(),r.readPixels(h.width,h.height,b);return x.restore(),g_(b,h.width,h.height),b}function a(c,h,d,u,f){const p=gA(u,f,d,.1),m=c/p;n.outlineMaterial.setUniform("thickness","f",m),n.outlineMaterial.setUniform("color","c",h),T.DEV_NEW_RENDER_ARCHITECTURE&&n.outlineMaterial.notifyUpdated()}this.createMinimapImageDataComponents=function(c,h,d,u){a(c.outlineThickness,i,t.boundingBox,d,u);const f=h.cropRange.center(),p=Mu(r,d,u),m=new An(h.visibleRange.min.x-f.x,h.visibleRange.max.x-f.x,h.visibleRange.min.y-f.y,h.visibleRange.max.y-f.y,0,10);m.rotation.set(0,0,h.rotation*-1),m.position.set(f.x,f.y,h.slicePlaneHeight),m.updateMatrixWorld(!0),Pu(m,0,h.slicePlaneHeight-h.farPlaneHeight);const b=s(m,p,n.planMaterial,!0,!0,!0);let g;t.minimapConfig.outlineThickness>0&&(Pu(m,0,.1),g=s(m,p,n.outlineMaterial,!0,!0,!0,c.outlineColor),t.minimapConfig.fillEnabled&&SA(d,g,c.outlineColor),bA(b,g)),p.dispose();const x=yA(b,g),w=new Uint8ClampedArray(b.buffer),C=new ImageData(w,d,u),M=new Uint8ClampedArray(x.buffer),D=new ImageData(M,d,u);return{minimapImageData:C,walkableImageData:D}};function l(c,h,d){a(c.outlineThickness,c.outlineColor,t.collisionBoundingBox,h,d);const u=r.createRenderTarget(h,d,{magFilter:H.NEAREST,minFilter:H.NEAREST,stencilBuffer:!1,generateMipmaps:!1}),f=new An(t.collisionBoundingBox.min.x,t.collisionBoundingBox.max.x,t.collisionBoundingBox.max.y,t.collisionBoundingBox.min.y,0,10);f.position.set(0,0,c.slicePlaneHeight),f.updateMatrixWorld(!0),Pu(f,0,.1);const p=s(f,u,n.outlineMaterial,!1,!0);u.dispose();const m=new Uint8ClampedArray(p.buffer);return new ImageData(m,h,d)}this.getCollisionData=function(c,h,d){const u={x:{min:0,max:h},y:{min:0,max:d}},f={x:{min:t.collisionBoundingBox.min.x,max:t.collisionBoundingBox.max.x},y:{min:t.collisionBoundingBox.max.y,max:t.collisionBoundingBox.min.y}};return{collisionImageData:l(c,h,d),canvasRange:u,collisionRange:f}},this.calculateRenderSize=function(c,h){const d=h.empty()?1:h.size().y/h.size().x,u=d<1?c:Math.round(c*(1/d)),f=d<1?Math.round(c*d):c;return{width:u,height:f}}}function y_(r,t,e){this.scene=r,this.camera=t,this.overrideMaterial=e,this.enabled=!0,this.clear=!0,this.needsSwap=!0}y_.prototype={render:function(r,t,e,i){var n=this.scene.overrideMaterial;this.overrideMaterial&&(this.scene.overrideMaterial=this.overrideMaterial),r.render(this.scene,this.camera,t,this.clear),this.scene.overrideMaterial=n}};const RA={uniforms:{tDiffuse:{type:"t",value:null},texelSize:{type:"v2",value:new ye(1/1024,1/512)}},vertexShaderName:"fxaa_vertex.glsl",fragmentShaderName:"fxaa_fragment.glsl"};class IA{constructor(){this.shaderPass=new ds(RA),this.shaderPass.clear=!1,this.shaderPass.renderToScreen=!1,this.shaderPass.material.depthTest=!1,this.shaderPass.material.depthWrite=!1,this.shaderPass.uniforms.texelSize.value.set(1/window.innerWidth,1/window.innerHeight)}get renderToScreen(){return this.shaderPass.renderToScreen}set renderToScreen(t){this.shaderPass.renderToScreen=t}onResize(t,e){this.shaderPass.uniforms.texelSize.value.set(1/t,1/e)}update(){}}const DA={uniforms:{tDepth:{type:"t",value:null},tDiffuse:{type:"t",value:null},texelSize:{type:"v2",value:new ye(1/1024,1/512)},delta:{type:"f",value:1},velocityFactor:{type:"f",value:.5},invViewProjMatrix:{type:"m4",value:new Ue},prevViewProjMatrix:{type:"m4",value:new Ue}},vertexShaderName:"motion_blur_vertex.glsl",fragmentShaderName:"motion_blur_fragment.glsl"};class x_{constructor(t){this.camera=t,this.shaderPass=new ds(DA),this.shaderPass.clear=!1,this.shaderPass.renderToScreen=!1,this.shaderPass.material.depthTest=!0,this.shaderPass.material.depthWrite=!0,this.shaderPass.uniforms.texelSize.value.set(1/(window.innerWidth*window.devicePixelRatio),1/(window.innerHeight*window.devicePixelRatio)),this.shaderPass.uniforms.velocityFactor.value=t.motionBlurIntensity,this.previousMatrixWorldInverse=new Ue,this.previousProjectionMatrix=new Ue,this.previousCameraPosition=new L,this.cameraPosition=new L,this.inverseProjectionMatrix=new Ue}get renderToScreen(){return this.shaderPass.renderToScreen}set renderToScreen(t){this.shaderPass.renderToScreen=t}set intensity(t){this.shaderPass.uniforms.velocityFactor.value=t}onResize(t,e){this.shaderPass.uniforms.texelSize.value.set(1/t,1/e)}update(t){this.shaderPass.uniforms.delta.value=t,this.shaderPass.uniforms.invViewProjMatrix.value.getInverse(this.camera.matrixWorldInverse).multiply(this.inverseProjectionMatrix.getInverse(this.camera.projectionMatrix)),this.shaderPass.uniforms.prevViewProjMatrix.value.copyFrom(this.previousProjectionMatrix.multiply(this.previousMatrixWorldInverse)),this.camera.updateMatrixWorld(),this.camera.matrixWorld.getTranslation(this.cameraPosition),this.previousMatrixWorldInverse.copyFrom(this.camera.matrixWorldInverse),this.previousProjectionMatrix.copyFrom(this.camera.projectionMatrix),this.previousCameraPosition.copyFrom(this.cameraPosition)}}const E_={minFilter:H.LINEAR,magFilter:H.LINEAR,depthBuffer:!0,useDepthTexture:!0,stencilBuffer:!1,generateMipmaps:!1};class LA extends ci{constructor(t,e,i){super(),this.renderer=t,this.camera=i,this.scene=e,this.renderModel=new y_(e,i),this.renderTarget1=null,this.renderTarget2=null,this.passes=[],this.postProcessChain=[],i.addEventListener(At.eventType.MOTION_BLUR_UPDATED,()=>this.updateMotionBlur())}get isEnabled(){return this.postProcessChain.length>0}init(){this.configureTarget(1024,1024,E_),this.passes.push(this.renderModel)}onResize(t,e){this.renderer&&(this.configureTarget(t,e,E_),this.ssaa&&this.ssaa.setTargets(this.renderTarget1,this.renderTarget2)),this.postProcessChain.forEach(i=>{i.onResize(t,e)})}removePostProcess(t){this.passes=this.passes.filter(e=>e!==t.shaderPass),this.postProcessChain=this.postProcessChain.filter(e=>e!==t)}disposeTarget(){this.renderTarget1&&(this.renderTarget1.dispose(),this.renderTarget1=null),this.renderTarget2&&(this.renderTarget2.dispose(),this.renderTarget2=null)}configureTarget(t,e,i){this.disposeTarget(),this.renderTarget1=this.renderer.createRenderTarget(t,e,i),this.renderTarget2=this.renderer.createRenderTarget(t,e,i)}setup(){this.isEnabled&&(this.renderer.autoClear=!1,this.postProcessChain.forEach((t,e,i)=>{t.renderToScreen=e===i.length-1}))}render(t){let e=this.renderTarget1,i=this.renderTarget2;this.passes.filter(n=>n.enabled).forEach(n=>{n.render(this.renderer,e,i,t),n.needsSwap&&n!==this.passes.at(-1)&&([e,i]=[i,e])})}update(t){mt.beginSection("Postprocess.update"),this.postProcessChain.forEach(e=>{e.update(t)}),this.render(t),mt.endSection("Postprocess.update")}updateMotionBlur(){const t=this.postProcessChain.find(n=>n instanceof x_),e=t&&!this.camera.motionBlurEnabled,i=!t&&this.camera.motionBlurEnabled;e&&(this.removePostProcess(t),this.setup()),i&&(this.addMotionBlur(),this.setup()),t&&(t.intensity=this.camera.motionBlurIntensity)}addFXAA(){const t=new IA;this.passes.push(t.shaderPass),this.postProcessChain.push(t)}addMotionBlur(){const t=new x_(this.camera);this.passes.push(t.shaderPass),this.postProcessChain.push(t)}addSSAA(t){this.ssaa=new wu(this.renderer,t)}resetSSAA(){this.ssaa&&this.ssaa.reset()}updateSSAA(){return this.ssaa?(this.ssaa.renderSample(),this.ssaa.renderedSamplesCount()>=4&&this.ssaa.renderAccumulatedSamplesToScreen(),!this.ssaa.allSamplesRendered()):!1}}var A_=(r=>(r.DISPOSED="webGLRenderTargetDisposed",r))(A_||{});const ud=class ud extends ci{constructor(e,i,n){var s,a,l,c,h,d,u,f,p,m;super();o(this,"x",0);o(this,"y",0);o(this,"width");o(this,"height");o(this,"wrapS");o(this,"wrapT");o(this,"magFilter");o(this,"minFilter");o(this,"anisotropy");o(this,"offset",new ye(0,0));o(this,"repeat",new ye(1,1));o(this,"format");o(this,"depthBuffer");o(this,"stencilBuffer");o(this,"generateMipmaps");o(this,"shareDepthFrom");o(this,"isCube",!1);o(this,"loaded",!0);o(this,"useDepthTexture");o(this,"depthTexture",null);o(this,"webglFramebuffer",null);o(this,"webglRenderbuffer",null);o(this,"webglTexture",null);o(this,"webglSlot",null);this.width=e,this.height=i,n=n||{},this.wrapS=(s=n.wrapS)!=null?s:H.CLAMP_TO_EDGE,this.wrapT=(a=n.wrapT)!=null?a:H.CLAMP_TO_EDGE,this.magFilter=(l=n.magFilter)!=null?l:H.LINEAR,this.minFilter=(c=n.minFilter)!=null?c:H.LINEAR_MIPMAP_LINEAR,this.anisotropy=(h=n.anisotropy)!=null?h:1,this.format=(d=n.format)!=null?d:Ke.RGBA8,this.depthBuffer=(u=n.depthBuffer)!=null?u:!0,this.stencilBuffer=(f=n.stencilBuffer)!=null?f:!0,this.generateMipmaps=n.generateMipmaps||!1,this.shareDepthFrom=(p=n.shareDepthFrom)!=null?p:null,this.useDepthTexture=(m=n.useDepthTexture)!=null?m:!1}dispose(){this.dispatchEvent({type:ud.eventType.DISPOSED})}};o(ud,"eventType",A_);let ko=ud;var T_=(r=>(r.DISPOSED="webGLRenderTargetVRDisposed",r))(T_||{});const fd=class fd extends ci{constructor(e){super();o(this,"webglFramebuffer");o(this,"x",null);o(this,"y",null);o(this,"width",null);o(this,"height",null);o(this,"isCube",!1);this.webglFramebuffer=e}dispose(){this.webglFramebuffer=null,this.dispatchEvent({type:fd.eventType.DISPOSED})}};o(fd,"eventType",T_);let Cu=fd;class w_ extends ko{constructor(e,i,n){super(e,i,n);o(this,"activeCubeFace",0);this.isCube=!0,this.webglFramebuffer=[],this.webglRenderbuffer=[]}}function OA(r){return r.split(`
`).map((e,i)=>i+1+": "+e).join(`
`)}function S_(r,t,e,i){const n=r.createShader(t);r.shaderSource(n,e),r.compileShader(n);const s=r.getShaderParameter(n,r.COMPILE_STATUS)===!1;if(s&&console.error(`Shader '${i}' failed to compile.`),s||T.LOG_INFO){const a=r.getShaderInfoLog(n);a!==""&&console.warn(`Shader '${i}' info log: `,a,OA(e))}return n}const M_=["viewMatrix","modelViewMatrix","projectionMatrix","normalMatrix","modelMatrix","cameraPosition"];let FA=0;function BA(r,t){const e={};for(let i=0,n=M_.length;i<n;i++){const s=M_[i];e[s]=P_(r,t,s)}return e}function P_(r,t,e){const i=r.getUniformLocation(t,e);return i||r.getUniformLocation(t,`u${Rp(e)}`)}function NA(r,t,e){const i={i:[],f:[],v2:[],v3:[],c:[],v4:[],m4:[],t:[]};let n;for(let s in e)if(e.hasOwnProperty(s)){const a=P_(r,t,s);if(a){const c=e[s].type;console.assert(i.hasOwnProperty(c)),c==="i"||c==="f"||c==="t"?n=null:c==="v2"?n=[null,null]:c==="v3"||c==="c"?n=[null,null,null]:c==="v4"?n=[null,null,null,null]:c==="m4"?n=null:console.assert(!1),i[c].push({id:s,value:n,location:a})}}return i}function UA(r,t,e){const i={};for(let n=0,s=e.length;n<s;n++){const a=e[n];i[a]=r.getAttribLocation(t,a)}return i}function kA(){return this.recompileProgram=function(r,t){performance.now(),this.program&&r.deleteProgram(this.program);const e=t.index0AttributeName,i=r.createProgram(),n=S_(r,r.VERTEX_SHADER,t.generateVertexShader(),t.vertexShaderName),s=S_(r,r.FRAGMENT_SHADER,t.generateFragmentShader(),t.fragmentShaderName);r.attachShader(i,n),r.attachShader(i,s),e!==void 0&&r.bindAttribLocation(i,0,e),r.linkProgram(i);const a=r.getProgramInfoLog(i).trim();if(r.getProgramParameter(i,r.LINK_STATUS)===!1)console.error("Shader link error: "+r.getError(),"validate status: ",r.getProgramParameter(i,r.VALIDATE_STATUS),"material: ",t.name);else for(const l in Object.keys(Vi))if(Object.prototype.hasOwnProperty.call(Vi,l)){const c=Vi[l];r.getUniformBlockIndex(i,c)}a!==""&&a!=="\0"&&console.warn("program info log: "+a),r.deleteShader(n),r.deleteShader(s),this.transformUniformCache=BA(r,i),this.materialUniformCache=NA(r,i,t.uniforms),this.attributes=UA(r,i,t.attributes),this.attributesKeys=Object.keys(this.attributes),this.program=i},this.id=FA++,this.usedTimes=1,this}function VA(r){const t=new Map;this.recompileProgram=function(e){const i=e.generateProgramId();let n=t[i];n?n.recompileProgram(r,e):console.error("Couldn't find program to recompile!")},this.assignProgramToMaterial=function(e){console.assert(e instanceof bt);const i=e.generateProgramId();let n=t[i];n?n.usedTimes++:(n=new kA,n.recompileProgram(r,e),t[i]=n),e.program&&this.resetProgramAssignment(e),e.program=n},this.resetProgramAssignment=function(e){const i=e.program;if(e.program=null,i.usedTimes-=1,i.usedTimes===0){for(let n in t)if(t.hasOwnProperty(n)&&t[n]===i){delete t[n];break}r.deleteProgram(i.program)}}}function C_(r){const n=new Array(16).fill(0),s=new Array(16).fill(null),a=n.map(()=>0);let l=null,c=null,h=null,d=null,u=null,f=null,p=null,m=null,b=null,g=null,x=null,w=null;const C={x:null,y:null,width:null,height:null};this.resetAttributeStates=function(){for(let M=0,D=n.length;M<D;M++)n[M]=0},this.disableAttributeStates=function(){for(let M=0,D=n.length;M<D;M++)r.disableVertexAttribArray(M),n[M]=0},this.enableAttributeArray=function(M){n[M]!==2&&(r.enableVertexAttribArray(M),n[M]=2)},this.disableAttributeArray=function(M,D){n[M]!==1&&(r.disableVertexAttribArray(M),n[M]=1),s[M]!==D&&(D.length===2?r.vertexAttrib2fv(M,D):D.length===3?r.vertexAttrib3fv(M,D):D.length===4&&r.vertexAttrib4fv(M,D),s[M]=D)},this.resetAttributeDivisors=function(){for(let M=0,D=a.length;M<D;M++)a[M]&&(r.vertexAttribDivisor(M,0),a[M]=0)},this.setAttributeDivisor=function(M,D){r.vertexAttribDivisor(M,D),a[M]=D},this.setBlending=function(M){const D=M.blending;if(D!==l&&(D===Yt.DISABLED?r.disable(r.BLEND):D===Yt.ADDITIVE?(r.enable(r.BLEND),r.blendEquation(r.FUNC_ADD),r.blendFunc(r.SRC_ALPHA,r.ONE)):D===Yt.SUBTRACTIVE?(r.enable(r.BLEND),r.blendEquation(r.FUNC_ADD),r.blendFunc(r.ZERO,r.ONE_MINUS_SRC_COLOR)):D===Yt.MULTIPLY?(r.enable(r.BLEND),r.blendEquation(r.FUNC_ADD),r.blendFunc(r.ZERO,r.SRC_COLOR)):D===Yt.CUSTOM?r.enable(r.BLEND):(D==Yt.NORMAL,r.enable(r.BLEND),r.blendEquationSeparate(r.FUNC_ADD,r.FUNC_ADD),r.blendFuncSeparate(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA,r.ONE,r.ONE_MINUS_SRC_ALPHA)),l=D),D===Yt.CUSTOM){const W=M.blendEquation,z=M.blendEquationAlpha||W,$=M.blendSrc,Z=M.blendDst,ne=M.blendSrcAlpha||$,Me=M.blendDstAlpha||Z;(W!==c||z!==u)&&(r.blendEquationSeparate(W,z),c=W,u=z),($!==h||Z!==d||ne!==f||Me!==p)&&(r.blendFuncSeparate($,Z,ne,Me),h=$,d=Z,f=ne,p=Me)}else c=null,h=null,d=null,u=null,f=null,p=null},this.setDepthTest=function(M){m!==M&&(M?r.enable(r.DEPTH_TEST):r.disable(r.DEPTH_TEST),m=M)},this.setDepthWrite=function(M){b!==M&&(r.depthMask(M),b=M)},this.setColorWrite=function(M){g!==M&&(r.colorMask(M,M,M,M),g=M)},this.setDoubleSided=function(M){x!==M&&(M?r.disable(r.CULL_FACE):r.enable(r.CULL_FACE),x=M)},this.setFlipSided=function(M){w!==M&&(M?r.frontFace(r.CW):r.frontFace(r.CCW),w=M)},this.setViewport=function(M,D,W,z){const $=C;($.x!==M||$.y!==D||$.width!==W||$.height!==z)&&(r.viewport(M,D,W,z),$.x=M,$.y=D,$.width=W,$.height=z)}}function zA(){this.texture=null,this.locked=!1,this.usedCount=0}function GA(r){const t=[];for(let e=0;e<r;e+=1)t[e]=new zA;return t}function HA(r){const t=r.getParameter(r.MAX_TEXTURE_IMAGE_UNITS),e=GA(t);this.setSlot=function(i,n){let s=i.webglSlot,a;if(s!==null)return a=e[s],a.usedCount+=1,a.locked=a.locked||n,!1;let l=1/0;for(let c=0;c<t;c+=1)a=e[c],!a.locked&&a.usedCount<l&&(l=a.usedCount,s=c);return s===null&&(console.warn("Not enough texture units"),s=0),a=e[s],a.texture&&(a.texture.webglSlot=null),a.texture=i,a.usedCount=1,a.locked=n,i.webglSlot=s,!0},this.unlockAllSlots=function(){for(let i=0;i<t;i+=1)e[i].locked=!1},this.freeSlot=function(i){if(i.webglSlot!==null){const n=e[i.webglSlot];i.webglSlot=null,n.texture=null,n.locked=!1,n.usedCount=0}},this.freeAllSlots=function(){for(let i=0;i<t;i+=1){const n=e[i];n.texture&&(n.texture.webglSlot=null,n.texture=null,n.locked=!1,n.usedCount=0)}}}function WA(r){const t=r.getParameter(r.MAX_TEXTURE_IMAGE_UNITS);let e=0;this.setSlot=function(i,n){return e===t&&(console.warn("Not enough texture units"),e=0),i.webglSlot=e,n&&(e+=1),!0},this.unlockAllSlots=function(){e=0},this.freeSlot=function(i){i.webglSlot=null},this.freeAllSlots=function(){}}function dh(r,t,e,i,n){if(Gr(i)){r.compressedTexImage2D(t,e,i,n.width,n.height,0,n.data);return}const s=jd(i),a=Xd(i);n instanceof pr?r.texImage2D(t,e,i,n.width,n.height,0,s,a,n.data):r.texImage2D(t,e,i,s,a,n)}function _l(r,t,e,i,n,s,a){const l=jd(i),c=Xd(i);Gr(i),r.texImage2D(t,e,i,n,s,0,l,c,a)}function jA(r){const t={COMPRESSED_RGB_S3TC_DXT1_EXT:"WEBGL_compressed_texture_s3tc",COMPRESSED_RGBA_S3TC_DXT1_EXT:"WEBGL_compressed_texture_s3tc",COMPRESSED_RGBA_S3TC_DXT3_EXT:"WEBGL_compressed_texture_s3tc",COMPRESSED_RGBA_S3TC_DXT5_EXT:"WEBGL_compressed_texture_s3tc",COMPRESSED_RGB_PVRTC_4BPPV1_IMG:"WEBGL_compressed_texture_pvrtc",COMPRESSED_RGBA_PVRTC_4BPPV1_IMG:"WEBGL_compressed_texture_pvrtc",COMPRESSED_RGB_PVRTC_2BPPV1_IMG:"WEBGL_compressed_texture_pvrtc",COMPRESSED_RGBA_PVRTC_2BPPV1_IMG:"WEBGL_compressed_texture_pvrtc",COMPRESSED_RGB_ETC1_WEBGL:"WEBGL_compressed_texture_etc1",COMPRESSED_RGBA_ASTC_4x4_KHR:"WEBGL_compressed_texture_astc"};for(let[e,i]of Object.entries(H)){const n=t[e];if(n!==void 0){const s=$e.gl.extension(n);s&&console.assert(s[e]===i)}else console.assert(r[e]===i)}}function XA(r){return $e.gl.disableTextureSlotReuse?new WA(r):new HA(r)}function qA(r,t){let e=new _e(0),i=0;const n=[],s=[];this.domElement=r,this.renderContext=t,this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.sortObjects=!0;const a=this;let l,c,h,d,u,f,p;const m=new fa,b=new Ue,g=new L;this.recompileProgram=function(N){p.recompileProgram(N)},this.getProgramStore=function(){return p},this.getGl=function(){return t},this.getState=function(){return f};function x(N,U,k,X){t.clearColor(N,U,k,X)}this.recreateWebGLState=function(){f=new C_(t)};function w(){l=null,c=null,h=-1,d=null,u=null,f=new C_(t),p=new VA(t),t.clearColor(0,0,0,1),t.clearDepth(1),t.clearStencil(0),t.enable(t.DEPTH_TEST),t.depthFunc(t.LEQUAL),t.frontFace(t.CCW),t.cullFace(t.BACK),t.enable(t.CULL_FACE),t.enable(t.BLEND),t.blendEquation(t.FUNC_ADD),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),f.setViewport(0,0,r.width,r.height),x(e.r,e.g,e.b,i),$e.ie||t.pixelStorei(t.UNPACK_COLORSPACE_CONVERSION_WEBGL,t.NONE)}w(),jA(t),this.webGLContextRestored=function(){w()},this.context=t,this.state=f;const C=XA(t),M=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);this.setCanvasSize=function(N,U){r.width=N,r.height=U,c===null&&this.setViewport(0,0,N,U)},this.setViewport=function(N,U,k,X){f.setViewport(N,U,k,X)},this.setScissor=function(N,U,k,X){t.scissor(N,U,k,X)},this.enableScissorTest=function(N){N?t.enable(t.SCISSOR_TEST):t.disable(t.SCISSOR_TEST)},this.setClearColor=function(N,U){e.copyFrom(N),i=U!==void 0?U:1,x(e.r,e.g,e.b,i)},this.getClearColor=function(){return e},this.getClearAlpha=function(){return i},this.getTextureSlotter=function(){return C},this.clear=function(N,U,k){let X=0;N&&(X|=t.COLOR_BUFFER_BIT),U&&(X|=t.DEPTH_BUFFER_BIT),k&&(X|=t.STENCIL_BUFFER_BIT),t.clear(X)},this.clearColor=function(){t.clear(t.COLOR_BUFFER_BIT)},this.clearDepth=function(){t.clear(t.DEPTH_BUFFER_BIT)},this.clearStencil=function(){t.clear(t.STENCIL_BUFFER_BIT)};function D(N){const U=N.attributes;for(const k in N.attributesKeys)if(U.hasOwnProperty(k)){const X=U[k];X!==void 0&&X.buffer!==void 0&&(t.deleteBuffer(X.buffer),delete X.buffer)}f.disableAttributeStates(),d=null}function W(N){C.freeSlot(N),N.webglTexture&&(t.deleteTexture(N.webglTexture),N.webglTexture=null)}this.deallocateRenderTargetRenderingBuffers=function(N){if(N.isCube)for(let U=0;U<6;U++)t.deleteFramebuffer(N.webglFramebuffer[U]),t.deleteRenderbuffer(N.webglRenderbuffer[U]);else t.deleteFramebuffer(N.webglFramebuffer),t.deleteRenderbuffer(N.webglRenderbuffer);N.webglFramebuffer=null,N.webglRenderbuffer=null};function z(N){C.freeSlot(N),t.deleteTexture(N.webglTexture),N.webglTexture=null,N.webglFramebuffer&&a.deallocateRenderTargetRenderingBuffers(N)}function $(N){N.setOnDispose(void 0),D(N)}function Z(N){const U=N.target;U.removeEventListener(st.eventType.DISPOSED,Z),W(U)}function ne(N){const U=N.target;U.removeEventListener(ko.eventType.DISPOSED,ne),z(U)}function Me(N){const U=N.target;U.removeEventListener(bt.eventType.DISPOSED,Me),p.resetProgramAssignment(U)}this.getOnMaterialDispose=function(){return Me};function Xe(N,U,k){const X=k.attributes,ve=U.attributes,De=U.attributesKeys,qe=(k.instanceId||0)*4*4;for(let Ne=0,me=De.length;Ne<me;Ne++){const Ye=De[Ne],ue=ve[Ye];if(ue>=0){const Ee=X[Ye];if(Ee!==void 0){const Pe=Ee.itemSize,He=Ee.glType;Ee.buffer,t.bindBuffer(t.ARRAY_BUFFER,Ee.buffer),f.enableAttributeArray(ue);const lt=Ee.divisor||0;let Rt=qe*lt;k.vertexAttribOffset&&(Rt+=k.vertexAttribOffset*Ee.glTypeSize*Pe),t.vertexAttribPointer(ue,Pe,He,!1,0,Rt),f.setAttributeDivisor(ue,lt)}else{const Pe=(k.defaultAttributeValues?k.defaultAttributeValues[Ye]:void 0)||N.defaultAttributeValues[Ye];f.disableAttributeArray(ue,Pe)}}}}function xe(N,U){t.texParameteri(N,t.TEXTURE_WRAP_S,U.wrapS),t.texParameteri(N,t.TEXTURE_WRAP_T,U.wrapT),t.texParameteri(N,t.TEXTURE_MAG_FILTER,U.magFilter),t.texParameteri(N,t.TEXTURE_MIN_FILTER,U.minFilter);const k=$e.gl.extension("EXT_texture_filter_anisotropic");k&&U.anisotropy>1&&t.texParameterf(N,k.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(U.anisotropy,$e.gl.maxAnisotropy))}function Le(N,U){const k=N.material,X=U.material,ve=k.program,De=X.program;return ve&&De&&ve.id!==De.id?ve.id-De.id:k.renderResourceId-X.renderResourceId||N.id-U.id}function B(N,U){const k=N.material.transparentRenderOrder-U.material.transparentRenderOrder;return k||U.cameraDistance-N.cameraDistance||N.id-U.id}function Y(N,U){(U||N.material).transparent?(a.sortObjects===!0&&(N.cameraDistance=m.nearPlaneDistanceToCenter(N)),s.push(N)):n.push(N)}function re(N,U,k){if(!(!k&&N.visible===!1)){N instanceof je&&(N.frustumCulled===!1||m.intersectsObject(N)===!0)&&Y(N,U);for(let X=0,ve=N.children.length;X<ve;X++)re(N.children[X],U,k)}}this.setCubeTexture=function(N){if(N.needsUpdate&&N.webglTexture===null&&(N.webglTexture=t.createTexture(),C.setSlot(N,!1)),t.activeTexture(t.TEXTURE0+N.webglSlot),t.bindTexture(t.TEXTURE_CUBE_MAP,N.webglTexture),N.needsUpdate){t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,N.flipY);const U=Gr(N.format),k=N.image;xe(t.TEXTURE_CUBE_MAP,N);for(let X=0;X<6;X++)if(!U)dh(t,t.TEXTURE_CUBE_MAP_POSITIVE_X+X,0,N.format,k[X]),N.releaseOnLoadedToGpu&&(k[X]=null);else{const ve=k[X].mipmaps;for(let De=0,qe=ve.length;De<qe;De++){const Ne=ve[De];dh(t,t.TEXTURE_CUBE_MAP_POSITIVE_X+X,De,N.format,Ne),N.releaseOnLoadedToGpu&&(Ne.data=null)}}N.generateMipmaps&&t.generateMipmap(t.TEXTURE_CUBE_MAP),N.needsUpdate=!1}};const le=new Ue,ge=new Eo;function pe(N,U,k){let X;U.matrixWorld?(le.multiplyMatrices(N.matrixWorldInverse,U.matrixWorld),X=le):X=N.matrixWorldInverse,t.uniformMatrix4fv(k.modelViewMatrix,!1,X.elements),k.normalMatrix&&(ge.getNormalMatrix(X),t.uniformMatrix3fv(k.normalMatrix,!1,ge.elements)),k.modelMatrix!==null&&(U.matrixWorld?t.uniformMatrix4fv(k.modelMatrix,!1,U.matrixWorld.elements):t.uniformMatrix4fv(k.modelMatrix,!1,M))}this.setMaterialFaces=function(N){f.setDoubleSided(N.side===Ti.DOUBLE),f.setFlipSided(N.side===Ti.BACK)};function Ae(N,U=void 0){N.webglTexture||(N.addEventListener(st.eventType.DISPOSED,Z),N.webglTexture=t.createTexture()),t.activeTexture(t.TEXTURE0+(U!=null?U:N.webglSlot)),t.bindTexture(t.TEXTURE_2D,N.webglTexture),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,N.flipY),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,N.premultiplyAlpha),t.pixelStorei(t.UNPACK_ALIGNMENT,N.unpackAlignment),xe(t.TEXTURE_2D,N);const k=N.mipmaps;if(k.length>0){for(let X=0,ve=k.length;X<ve;X++)dh(t,t.TEXTURE_2D,X,N.format,k[X]);N.releaseOnLoadedToGpu&&(N.mipmaps=void 0),N.generateMipmaps=!1}else dh(t,t.TEXTURE_2D,0,N.format,N.image),N.releaseOnLoadedToGpu&&(N.image=void 0);N.generateMipmaps&&t.generateMipmap(t.TEXTURE_2D),N.needsUpdate=!1}this.setTexture=function(N,U=void 0){N.needsUpdate?Ae(N,U):(t.activeTexture(t.TEXTURE0+(U!=null?U:N.webglSlot)),t.bindTexture(t.TEXTURE_2D,N.webglTexture))},this.setRenderTarget=function(N){let U,k,X,ve,De;N?(N.isCube?U=N.webglFramebuffer[N.activeCubeFace]:U=N.webglFramebuffer,k=N.x,X=N.y,ve=N.width,De=N.height):(U=null,k=0,X=0,ve=r.width,De=r.height),U!==c&&(t.bindFramebuffer(t.FRAMEBUFFER,U),c=U),f.setViewport(k,X,ve,De)},this.loadMaterialUniforms=function(N,U){let k,X,ve,De,qe,Ne,me,Ye,ue,Ee,Pe,He,lt;for(k=N.materialUniformCache.i,Ee=0,Pe=k.length;Ee<Pe;Ee+=1)X=k[Ee],ve=X.id,De=U[ve].value,X.value!==De&&(t.uniform1i(X.location,De),X.value=De);for(k=N.materialUniformCache.f,Ee=0,Pe=k.length;Ee<Pe;Ee+=1)X=k[Ee],ve=X.id,De=U[ve].value,X.value!==De&&(t.uniform1f(X.location,De),X.value=De);for(k=N.materialUniformCache.v2,Ee=0,Pe=k.length;Ee<Pe;Ee+=1)X=k[Ee],ve=X.id,De=U[ve].value,qe=De.x,Ne=De.y,(X.value[0]!==qe||X.value[1]!==Ne)&&(t.uniform2f(X.location,qe,Ne),X.value[0]=qe,X.value[1]=Ne);for(k=N.materialUniformCache.v3,Ee=0,Pe=k.length;Ee<Pe;Ee+=1)X=k[Ee],ve=X.id,De=U[ve].value,qe=De.x,Ne=De.y,me=De.z,(X.value[0]!==qe||X.value[1]!==Ne||X.value[2]!==me)&&(t.uniform3f(X.location,qe,Ne,me),X.value[0]=qe,X.value[1]=Ne,X.value[2]=me);for(k=N.materialUniformCache.c,Ee=0,Pe=k.length;Ee<Pe;Ee+=1)X=k[Ee],ve=X.id,De=U[ve].value,qe=De.r,Ne=De.g,me=De.b,(X.value[0]!==qe||X.value[1]!==Ne||X.value[2]!==me)&&(t.uniform3f(X.location,qe,Ne,me),X.value[0]=qe,X.value[1]=Ne,X.value[2]=me);for(k=N.materialUniformCache.v4,Ee=0,Pe=k.length;Ee<Pe;Ee+=1)X=k[Ee],ve=X.id,De=U[ve].value,qe=De.x,Ne=De.y,me=De.z,Ye=De.w,(X.value[0]!==qe||X.value[1]!==Ne||X.value[2]!==me||X.value[3]!==Ye)&&(t.uniform4f(X.location,qe,Ne,me,Ye),X.value[0]=qe,X.value[1]=Ne,X.value[2]=me,X.value[3]=Ye);for(k=N.materialUniformCache.m4,Ee=0,Pe=k.length;Ee<Pe;Ee+=1)X=k[Ee],ve=X.id,t.uniformMatrix4fv(X.location,!1,U[ve].value.elements);for(k=N.materialUniformCache.t,Ee=0,Pe=k.length;Ee<Pe;Ee+=1)X=k[Ee],ve=X.id,ue=U[ve].value,ue&&(He=C.setSlot(ue,!0),lt=ue.webglSlot,X.value!==lt&&(t.uniform1i(X.location,lt),X.value=lt),(He||ue.needsUpdate)&&(ue.isCube?this.setCubeTexture(ue):this.setTexture(ue)));C.unlockAllSlots()},this.resetState=function(){C.unlockAllSlots(),w()},this.setMaterial=function(N){f.setBlending(N),f.setDepthTest(N.depthTest),f.setDepthWrite(N.depthWrite),f.setColorWrite(N.colorWrite)},this.setProgram=function(N,U,k){console.assert(U instanceof bt),U.programNeedsUpdate&&(p.assignProgramToMaterial(U),U.addEventListener(bt.eventType.DISPOSED,Me),U.programNeedsUpdate=!1),console.assert(!U.morphTargets);let X=!1,ve=!1;const De=U.program,qe=De.transformUniformCache;return De.id!==l&&(t.useProgram(De.program),l=De.id,X=!0,ve=!0),U.renderResourceId!==h&&(h=U.renderResourceId,ve=!0),X&&(t.uniformMatrix4fv(qe.projectionMatrix,!1,N.projectionMatrix.elements),qe.cameraPosition!==null&&(N.matrixWorld.getTranslation(g),t.uniform3f(qe.cameraPosition,g.x,g.y,g.z)),qe.viewMatrix!==null&&t.uniformMatrix4fv(qe.viewMatrix,!1,N.matrixWorldInverse.elements)),(X||k.matrixWorld!==u)&&(u=k.matrixWorld,pe(N,k,qe)),U.refreshPerObjectUniforms&&U.refreshPerObjectUniforms(k)&&(ve=!0),U.renderSteps>1&&(ve=!0),ve&&this.loadMaterialUniforms(De,U.uniforms),De},this.renderBufferDirect=function(N,U,k,X){if(U.visible===!1||k.vertexCnt===0)return;const ve=this.setProgram(N,U,X);let De=!1;(k.id!==d||ve.id!==l)&&(d=k.id,De=!0),console.assert(X instanceof je);const qe=t.TRIANGLES,Ne=k.attributes.index;if(Ne){const me=Ne.glType,Ye=k.indexUint?4:2;De&&(Xe(U,ve,k),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,Ne.buffer));let ue,Ee;k.indexOffset!==void 0?(ue=k.indexCnt,Ee=Ye*k.indexOffset):(ue=Ne.length,Ee=0),k.isInstanced?t.drawElementsInstanced(qe,ue,me,Ee,k.instanceCount):t.drawElements(qe,ue,me,Ee)}else{De&&Xe(U,ve,k);const me=k.attributes.position;let Ye,ue;k.vertexOffset!==void 0?(Ye=k.vertexCnt,ue=k.vertexOffset):(Ye=me.length/me.itemSize,ue=0),k.isInstanced?t.drawArraysInstanced(qe,ue,Ye,k.instanceCount):t.drawArrays(qe,ue,Ye)}f.resetAttributeDivisors()},this.renderObjects=function(N,U,k){mt.beginSection("WebGLRenderer.renderObjects");let X;k&&(X=k,this.setMaterial(X),this.setMaterialFaces(X));for(let ve=0,De=N.length;ve<De;ve+=1){const qe=N[ve],Ne=qe.geometry,me=qe.materialOverride?qe.materialOverride:qe.material;try{k?k.doNotOverrideSide&&me&&this.setMaterialFaces(me):(X=me,this.setMaterial(X),this.setMaterialFaces(X));for(let Ye=0;Ye<X.renderSteps;Ye++)X.updateRenderStep(Ye),this.renderBufferDirect(U,X,Ne,qe)}catch(Ye){const ue=X?X.name:"null";console.error(`Failed to render material ${ue}: ${Ye.stack}`)}}mt.endSection("WebGLRenderer.renderObjects")},this.updateRenderTargetMipmap=function(N){const U=C.setSlot(N,!1);t.activeTexture(t.TEXTURE0+N.webglSlot),N.isCube?(U&&t.bindTexture(t.TEXTURE_CUBE_MAP,N.webglTexture),t.generateMipmap(t.TEXTURE_CUBE_MAP)):(U&&t.bindTexture(t.TEXTURE_2D,N.webglTexture),t.generateMipmap(t.TEXTURE_2D))},this.resetCaching=function(){d=null,h=-1,l=null,u=null,f.resetAttributeStates()},this.render=function(N,U,k,X){this.renderMeshes(N.children,N.overrideMaterial,U,k,X)},this.renderMeshes=function(N,U,k,X,ve,De){mt.beginSection("WebGLRenderer.renderMeshes"),this.resetCaching(),k.matrixWorldInverse.getInverse(k.matrixWorld),b.multiplyMatrices(k.projectionMatrix,k.matrixWorldInverse),m.setFromMatrix(b),n.length=0,s.length=0;const qe=De===void 0?!1:De;for(let Ne=0;Ne<N.length;Ne+=1)re(N[Ne],U,qe);a.sortObjects===!0&&(n.sort(Le),s.sort(B)),this.setRenderTarget(X),(this.autoClear||ve)&&this.clear(this.autoClearColor,this.autoClearDepth,this.autoClearStencil),this.renderObjects(n,k,U),this.renderObjects(s,k,U),X&&X.generateMipmaps&&this.updateRenderTargetMipmap(X),f.setDepthTest(!0),f.setDepthWrite(!0),f.setColorWrite(!0),f.resetAttributeStates(),mt.endSection("WebGLRenderer.renderMeshes")};let Fe=null;this.setUploadBuffersFuncOverride=function(N){Fe=N},this.uploadNewBuffers=function(N){if(Fe){Fe(N);return}const U=N.geometry,k=U.attributes,X=U.attributesKeys;U.setOnDispose($),console.assert(U instanceof tn||U instanceof Ea);for(let ve=0,De=X.length;ve<De;ve+=1){const qe=X[ve],Ne=k[qe],me=qe==="index"?t.ELEMENT_ARRAY_BUFFER:t.ARRAY_BUFFER;if(Ne.buffer)Ne.needsUpdate===!0&&console.assert(!1);else{Ne.buffer=t.createBuffer(),t.bindBuffer(me,Ne.buffer);const Ye=Ne.array;if($e.ios&&me===t.ARRAY_BUFFER){const ue=Ne.itemSize*Ye.BYTES_PER_ELEMENT%4;console.assert(ue===0)}t.bufferData(me,Ye,t.STATIC_DRAW),Ye instanceof Float32Array?(Ne.glType=t.FLOAT,Ne.glTypeSize=4):Ye instanceof Int8Array?(Ne.glType=t.BYTE,Ne.glTypeSize=1):Ye instanceof Int16Array?(Ne.glType=t.SHORT,Ne.glTypeSize=2):Ye instanceof Uint16Array?(Ne.glType=t.UNSIGNED_SHORT,Ne.glTypeSize=2):Ye instanceof Uint32Array?(Ne.glType=t.UNSIGNED_INT,Ne.glTypeSize=4):console.assert(!1),Ne.releaseOnLoadedToGpu&&(Ne.array=null),Ne.needsUpdate=!1}}},this.uploadTexture=function(N,U=void 0){C.setSlot(N,!1),Ae(N,U)},this.copyFramebufferToCubeFaceMip=function(N,U,k,X,ve){C.setSlot(ve,!1),t.activeTexture(t.TEXTURE0+ve.webglSlot),t.bindTexture(t.TEXTURE_CUBE_MAP,ve.webglTexture),_l(t,t.TEXTURE_CUBE_MAP_POSITIVE_X+k,N,Ke.RGBA8,U,U,X)},this.createCubeTexture=function(N,U){const k=new st;k.isCube=!0,k.anisotropy=st.NO_ANISOTROPY,U?k.minFilter=H.LINEAR_MIPMAP_NEAREST:k.minFilter=H.LINEAR,k.generateMipmaps=!1,k.needsUpdate=!1,k.addEventListener(st.eventType.DISPOSED,Z),k.webglTexture=t.createTexture(),C.setSlot(k,!1),t.activeTexture(t.TEXTURE0+k.webglSlot),t.bindTexture(t.TEXTURE_CUBE_MAP,k.webglTexture),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MAG_FILTER,t.LINEAR),U?t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_NEAREST):t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MIN_FILTER,t.LINEAR);for(let X=0;X<6;X+=1)_l(t,t.TEXTURE_CUBE_MAP_POSITIVE_X+X,0,Ke.RGBA8,N,N,null);return U&&t.generateMipmap(t.TEXTURE_CUBE_MAP),k};function he(N,U){t.bindRenderbuffer(t.RENDERBUFFER,N),U.depthBuffer?(t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_STENCIL,U.width,U.height),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,t.RENDERBUFFER,N)):t.renderbufferStorage(t.RENDERBUFFER,t.RGBA4,U.width,U.height)}function tt(N,U,k){t.bindFramebuffer(t.FRAMEBUFFER,N),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,U,k,0)}function Ze(N,U){if(U.addEventListener(ko.eventType.DISPOSED,ne),U.webglTexture=t.createTexture(),C.setSlot(U,!1),t.activeTexture(t.TEXTURE0+U.webglSlot),N){t.bindTexture(t.TEXTURE_CUBE_MAP,U.webglTexture),xe(t.TEXTURE_CUBE_MAP,U);for(let k=0;k<6;k++)U.webglFramebuffer[k]=t.createFramebuffer(),U.webglRenderbuffer[k]=t.createRenderbuffer(),_l(t,t.TEXTURE_CUBE_MAP_POSITIVE_X+k,0,U.format,U.width,U.height,null),tt(U.webglFramebuffer[k],t.TEXTURE_CUBE_MAP_POSITIVE_X+k,U.webglTexture),he(U.webglRenderbuffer[k],U);U.generateMipmaps&&t.generateMipmap(t.TEXTURE_CUBE_MAP)}else{if(U.webglFramebuffer=t.createFramebuffer(),U.shareDepthFrom?U.webglRenderbuffer=U.shareDepthFrom.webglRenderbuffer:U.webglRenderbuffer=t.createRenderbuffer(),t.bindTexture(t.TEXTURE_2D,U.webglTexture),xe(t.TEXTURE_2D,U),_l(t,t.TEXTURE_2D,0,U.format,U.width,U.height,null),tt(U.webglFramebuffer,t.TEXTURE_2D,U.webglTexture),U.useDepthTexture)U.depthTexture=st.newDataTexture(null,U.width,U.height,Ke.DEPTH24),U.depthTexture.webglTexture=t.createTexture(),C.setSlot(U.depthTexture,!1),t.activeTexture(t.TEXTURE0+U.depthTexture.webglSlot),t.bindTexture(t.TEXTURE_2D,U.depthTexture.webglTexture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_COMPARE_MODE,t.NONE),_l(t,t.TEXTURE_2D,0,Ke.DEPTH24,U.width,U.height,null),t.framebufferTexture2D(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.TEXTURE_2D,U.depthTexture.webglTexture,0),t.bindTexture(t.TEXTURE_2D,null);else if(U.shareDepthFrom){if(U.depthBuffer){const k=t.DEPTH_STENCIL_ATTACHMENT;t.framebufferRenderbuffer(t.FRAMEBUFFER,k,t.RENDERBUFFER,U.webglRenderbuffer)}}else he(U.webglRenderbuffer,U);U.generateMipmaps&&t.generateMipmap(t.TEXTURE_2D)}t.bindRenderbuffer(t.RENDERBUFFER,null),t.bindFramebuffer(t.FRAMEBUFFER,null)}this.createFrameBufferRenderTarget=function(N){return new Cu(N)},this.createRenderTarget=function(N,U,k){const X=new ko(N,U,k);return Ze(!1,X),X},this.createRenderTargetCube=function(N,U,k){const X=new w_(N,U,k);return Ze(!0,X),X},this.readPixels=function(N,U,k){t.readPixels(0,0,N,U,t.RGBA,t.UNSIGNED_BYTE,k)},this.checkGlError=function(){const N=t.getError();N!==t.NO_ERROR&&console.log("gl error! "+N)}}const YA=10,QA=8;function KA(r){return T.DEBUG_WEBGL?In.wrapWebglDebug(r):r}function $A(r,t){t.alpha===void 0&&(t.alpha=!0),t.depth===void 0&&(t.depth=!0),t.stencil===void 0&&(t.stencil=!1),t.premultipliedAlpha===void 0&&(t.premultipliedAlpha=!0),t.antialias===void 0&&(t.antialias=!0),t.preserveDrawingBuffer===void 0&&(t.preserveDrawingBuffer=!1);try{return r.getContext("webgl2",t)}catch(e){return null}}function R_(r,t){const e=$A(r,t);return e?($e.resetGlDetector(e),$e.gl.reportToConsole(),new qA(r,KA(e))):null}function ZA(r){const t={antialias:!T.NO_BUILTIN_AA&&!T.FORCE_FXAA,powerPreference:T.HIGH_PERFORMANCE_POWER_PREFERENCE?"high-performance":"default"},e=R_(r,t);return e&&(e.autoClear=!0,e.autoClearColor=!1,e.autoClearDepth=!0,e.autoClearStencil=!1,e.sortObjects=!0),e}function JA(r,t,e,i){const n=e.camera,s=e.threeScene;let a=Date.now(),l=0;mt.setWebGLContext(r.renderContext),T.DEV_NEW_RENDER_ARCHITECTURE&&pt.get().init(e);const c=new LA(r,s,n);function h(){$e.gl.antialiasPostprocess&&(c.init(),$e.gl.antialiasNative||c.addFXAA(),n.motionBlurEnabled&&c.addMotionBlur(),c.setup(),c.addSSAA(e))}function d(){return window.devicePixelRatio}this.resize=function(u){let f,p,m,b;u||(f=window.innerWidth,p=window.innerHeight,m=f*d(),b=p*d(),n.physicalWidth=m,n.physicalHeight=b,n.updateProjectionMatrix(),r.setCanvasSize(m,b),r.domElement.style.width=f+"px",r.domElement.style.height=p+"px",c.onResize(m,b),T.DEV_NEW_RENDER_ARCHITECTURE&&pt.get().onViewportResize(m,b))},this.renderIdle=function(u,f){return!T.DEV_NEW_RENDER_ARCHITECTURE&&f===0&&c.resetSSAA(),i.exposureNeedsUpdate()?(this.renderToScreen(u,!1),!0):T.DEV_NEW_RENDER_ARCHITECTURE?pt.get().isSceneRenderingRequired():c.updateSSAA()},this.renderToScreen=function(u,f,p){if(mt.beginSection("Renderer.renderToScreen"),Date.now()-a>1e3/YA&&l>QA&&(i.adaptExposure(!1,T.FORCE_AUTO_EXPOSURE),a=Date.now(),l=0),l++,i.update(u),T.DEV_NEW_RENDER_ARCHITECTURE){const m=new zr;m.simStateAlpha=p,m.timeDelta=u,f&&(m.vrPose=t.getCurrentPose(),m.baseLayer=t.getBaseLayer(),m.vrPose&&m.baseLayer,void 0),pt.get().render(m)}else f?t.render(s,n.matrixWorld):c.isEnabled?c.update(u):r.render(s,n);mt.endSection("Renderer.renderToScreen")},this.enableAutoExposure=function(){i.enableAutoExposure()},this.disableAutoExposure=function(){i.disableAutoExposure()},this.reloadShaders=function(){T.DEV_NEW_RENDER_ARCHITECTURE&&pt.get().reloadShaders()},h()}var at=(r=>(r[r.SAMPLER_2D=H.SAMPLER_2D]="SAMPLER_2D",r[r.SAMPLER_CUBE=H.SAMPLER_CUBE]="SAMPLER_CUBE",r[r.SAMPLER_3D=H.SAMPLER_3D]="SAMPLER_3D",r[r.SAMPLER_2D_SHADOW=H.SAMPLER_2D_SHADOW]="SAMPLER_2D_SHADOW",r[r.SAMPLER_2D_ARRAY=H.SAMPLER_2D_ARRAY]="SAMPLER_2D_ARRAY",r[r.SAMPLER_2D_ARRAY_SHADOW=H.SAMPLER_2D_ARRAY_SHADOW]="SAMPLER_2D_ARRAY_SHADOW",r[r.SAMPLER_CUBE_SHADOW=H.SAMPLER_CUBE_SHADOW]="SAMPLER_CUBE_SHADOW",r[r.INT_SAMPLER_2D=H.INT_SAMPLER_2D]="INT_SAMPLER_2D",r[r.INT_SAMPLER_3D=H.INT_SAMPLER_3D]="INT_SAMPLER_3D",r[r.INT_SAMPLER_CUBE=H.INT_SAMPLER_CUBE]="INT_SAMPLER_CUBE",r[r.INT_SAMPLER_2D_ARRAY=H.INT_SAMPLER_2D_ARRAY]="INT_SAMPLER_2D_ARRAY",r[r.UNSIGNED_INT_SAMPLER_2D=H.UNSIGNED_INT_SAMPLER_2D]="UNSIGNED_INT_SAMPLER_2D",r[r.UNSIGNED_INT_SAMPLER_3D=H.UNSIGNED_INT_SAMPLER_3D]="UNSIGNED_INT_SAMPLER_3D",r[r.UNSIGNED_INT_SAMPLER_CUBE=H.UNSIGNED_INT_SAMPLER_CUBE]="UNSIGNED_INT_SAMPLER_CUBE",r[r.UNSIGNED_INT_SAMPLER_2D_ARRAY=H.UNSIGNED_INT_SAMPLER_2D_ARRAY]="UNSIGNED_INT_SAMPLER_2D_ARRAY",r[r.FLOAT=H.FLOAT]="FLOAT",r[r.FLOAT_VEC2=H.FLOAT_VEC2]="FLOAT_VEC2",r[r.FLOAT_VEC3=H.FLOAT_VEC3]="FLOAT_VEC3",r[r.FLOAT_VEC4=H.FLOAT_VEC4]="FLOAT_VEC4",r[r.INT=H.INT]="INT",r[r.INT_VEC2=H.INT_VEC2]="INT_VEC2",r[r.INT_VEC3=H.INT_VEC3]="INT_VEC3",r[r.INT_VEC4=H.INT_VEC4]="INT_VEC4",r[r.BOOL=H.BOOL]="BOOL",r[r.BOOL_VEC2=H.BOOL_VEC2]="BOOL_VEC2",r[r.BOOL_VEC3=H.BOOL_VEC3]="BOOL_VEC3",r[r.BOOL_VEC4=H.BOOL_VEC4]="BOOL_VEC4",r[r.FLOAT_MAT2=H.FLOAT_MAT2]="FLOAT_MAT2",r[r.FLOAT_MAT3=H.FLOAT_MAT3]="FLOAT_MAT3",r[r.FLOAT_MAT4=H.FLOAT_MAT4]="FLOAT_MAT4",r))(at||{});const I_=new Map([[at.FLOAT,4],[at.FLOAT_VEC2,8],[at.FLOAT_VEC3,12],[at.FLOAT_VEC4,16],[at.INT,4],[at.INT_VEC2,8],[at.INT_VEC3,12],[at.INT_VEC4,16],[at.BOOL,4],[at.BOOL_VEC2,8],[at.BOOL_VEC3,12],[at.BOOL_VEC4,16],[at.FLOAT_MAT2,16],[at.FLOAT_MAT3,36],[at.FLOAT_MAT4,64]]);function eT(r){switch(r){case at.SAMPLER_2D:case at.SAMPLER_CUBE:case at.SAMPLER_3D:case at.SAMPLER_2D_SHADOW:case at.SAMPLER_2D_ARRAY:case at.SAMPLER_2D_ARRAY_SHADOW:case at.SAMPLER_CUBE_SHADOW:case at.INT_SAMPLER_2D:case at.INT_SAMPLER_3D:case at.INT_SAMPLER_CUBE:case at.INT_SAMPLER_2D_ARRAY:case at.UNSIGNED_INT_SAMPLER_2D:case at.UNSIGNED_INT_SAMPLER_3D:case at.UNSIGNED_INT_SAMPLER_CUBE:case at.UNSIGNED_INT_SAMPLER_2D_ARRAY:return!0;default:return!1}}const Zs=4,Ru=16,tT=new Map([[at.SAMPLER_2D,H.TEXTURE_2D],[at.SAMPLER_CUBE,H.TEXTURE_CUBE_MAP]]);class D_ extends gr{constructor(e,i,n,s,a,l){super();o(this,"vsSource");o(this,"vsName");o(this,"fsSource");o(this,"fsName");o(this,"codeHash");o(this,"predefinedBindings");o(this,"attributeDescriptors");this.vsName=e,this.vsSource=i,this.fsName=n,this.fsSource=s,this.codeHash=Cp([this.vsSource,this.fsSource]),this.predefinedBindings=a,this.attributeDescriptors=l,Ce(n&&s||!n&&!s)}compare(e){return Gs(this.codeHash,e.codeHash)}}class iT{constructor(){o(this,"samplerUniforms",new Array)}setupSamplerUniforms(t,e){this.samplerUniforms=[];for(const s of e){const a=s[0],l=t.find(c=>c.name===a);if(l){const c=s[1],h=l.location,d=l.type;this.samplerUniforms.push({name:a,location:h,binding:c,type:d})}}const i=e.size,n=t.filter(s=>!e.has(s.name)).sort((s,a)=>s.name.localeCompare(a.name));for(let s=0;s<n.length;s++)n[s].binding=i+s,this.samplerUniforms.push(n[s])}}class L_ extends Io{constructor(){super(...arguments);o(this,"program");o(this,"uniformBlockDescriptors",new Map);o(this,"samplerUniformTable",new iT)}_compileProgram(e,i){const n=this.createWebGLShader(e,e.VERTEX_SHADER,i.vsSource,i.vsName);if(!n)return!1;const s=e.createProgram();if(s)e.attachShader(s,n);else return!1;let a=!0,l;if(i.fsSource!==""&&(l=this.createWebGLShader(e,e.FRAGMENT_SHADER,i.fsSource,i.fsName),l?e.attachShader(s,l):a=!1),a){this._setupAttributes(s,e,i.attributeDescriptors),e.linkProgram(s);const c=e.getProgramInfoLog(s),h=c?c.trim():"";e.getProgramParameter(s,e.LINK_STATUS)===!1&&(console.error("Shader link error: "+e.getError(),"validate status: ",e.getProgramParameter(s,e.VALIDATE_STATUS)),a=!1),h!==""&&h!=="\0"&&console.warn("program info log: "+h)}return a?this.program=s:e.deleteProgram(s),n&&e.deleteShader(n),l&&e.deleteShader(l),a}_setupAttributes(e,i,n){for(const s of n)i.bindAttribLocation(e,s.index,s.name)}getSamplerUniform(e){return this.samplerUniformTable.samplerUniforms.find(i=>i.name===e)}load(e){const i=e.webGLRenderer.getGl(),n=this._compileProgram(i,this.descriptor);if(n){const s=this.program;i.useProgram(s),this._setupUniformDescriptors(i,this.descriptor.predefinedBindings)}return n}unload(e){this.program&&e.webGLRenderer.getGl().deleteProgram(this.program),this.program=void 0}addLineNumbers(e){return e.split(`
`).map((n,s)=>s+1+": "+n).join(`
`)}createWebGLShader(e,i,n,s){let a=e.createShader(i);if(!a)return;e.shaderSource(a,n),e.compileShader(a);const l=e.getShaderParameter(a,e.COMPILE_STATUS)===!1;if(l&&console.error(`Shader '${s}' failed to compile.`),l||T.LOG_INFO){const c=e.getShaderInfoLog(a);c!==""&&console.warn(`Shader '${s}' info log: `,c,this.addLineNumbers(n)),l&&(e.deleteShader(a),a=null)}return a||void 0}_setupUniformDescriptors(e,i){const n=this.program,s=e.getProgramParameter(n,e.ACTIVE_UNIFORMS),a=[...Array(s).keys()],l=e.getActiveUniforms(n,a,e.UNIFORM_BLOCK_INDEX),c=e.getActiveUniforms(n,a,e.UNIFORM_OFFSET),h=this._setupUniformBlocks(e,l),d=new Array;for(let u=0;u<s;++u){const f=e.getActiveUniform(n,u),{name:p,type:m,size:b}=f;if(p.startsWith("gl_")||p.startsWith("webgl_"))continue;const g=h.get(l[u]),x=c[u],w=g.uniforms;let C=p;if(b>1){const D=p.indexOf("[");C=p.substring(0,D)}const M=-1;for(let D=0;D<b;D++){const W=b>1?`${C}[${D}]`:p;if(eT(m)){const z=e.getUniformLocation(n,W),$=tT.get(m);d.push({name:W,location:z,binding:M,type:$})}else{m!==at.FLOAT_VEC3&&at.FLOAT_MAT3;const z=b>1?x+I_.get(m)*D:x;w.set(W,new yy(m,z)),z+I_.get(m)<=g.size}}}this.samplerUniformTable.setupSamplerUniforms(d,i);for(const u of this.samplerUniformTable.samplerUniforms)e.uniform1i(u.location,u.binding)}_setupUniformBlocks(e,i){this.uniformBlockDescriptors.clear();const n=[...new Set(i)],s=new Map,a=this.program;for(const l of n.values())if(l!==-1){const c=e.getActiveUniformBlockName(a,l);if(!c){console.warn("Couldn't find uniform buffer block name!");continue}const h=xy[c];if(h!==void 0){const d=mr[h];e.uniformBlockBinding(a,l,d);const u=e.getActiveUniformBlockParameter(a,l,e.UNIFORM_BLOCK_DATA_SIZE),f=new sm(c,d,l);f.size=u,this.uniformBlockDescriptors.set(c,f),s.set(l,f)}else console.warn(`Unknown uniform buffer ${c}.`)}else{const c=new sm("",-1,-1);this.uniformBlockDescriptors.set("",c),s.set(-1,c)}return s}}const Iu=[{name:"position",type:H.FLOAT,itemCount:3,index:0},{name:"sphericalNormal",type:H.FLOAT,itemCount:2,index:1},{name:"uv0",type:H.FLOAT,itemCount:2,index:2},{name:"uv1",type:H.FLOAT,itemCount:2,index:3},{name:"uv1Mod",type:H.FLOAT,itemCount:4,index:4},{name:"t0",type:H.FLOAT,itemCount:4,index:5},{name:"t1",type:H.FLOAT,itemCount:4,index:6},{name:"t2",type:H.FLOAT,itemCount:4,index:7},{name:"normal",type:H.FLOAT,itemCount:3,index:8}],nT=Object.freeze((()=>{const r=new qd,t=new Float32Array([0,0]);return r.uv0=t,r.uv1=new Uint16Array([0,0]),r.uv1Mod=new Float32Array([0,0,1/65535,1/65535]),r.t0=new Float32Array([1,0,0,0]),r.t1=new Float32Array([0,1,0,0]),r.t2=new Float32Array([0,0,1,0]),r.sphericalNormal=t,r})());class sT{constructor(){o(this,"_code","");o(this,"_promotedVec3UniformDefines","")}generateUniformBuffersCode(t,e){if(this._code="",t&&!(t instanceof Py)&&(this._code+=`uniform ${Vi[oe.MATERIAL]} {
`,this._generateCodeForObject(t),this._code+=`};
`),e&&e.length>0){this._code+=`uniform ${Vi[oe.OBJECT]} {
`;for(const i of e){const n=new i;this._generateCodeForObject(n)}this._code+=`};
`}return this._code=this._code+this._promotedVec3UniformDefines,this._code}_addUniformLine(t,e,i){this._code+="	"+t+" "+(i!=null?i:"")+e+`;
`}_generateCodeForObject(t,e,i){if(t instanceof We)this._addUniformLine("vec4",e,i);else if(t instanceof L||t instanceof _e){const n=Rp(e),s=`${e}_pad`;this._addUniformLine("vec4",s,i),this._promotedVec3UniformDefines+=`#define u${n} ${s}.xyz
`}else if(t instanceof ye)this._addUniformLine("vec2",e,i);else if(t instanceof Ue)this._addUniformLine("mat4",e,i);else if(!(t instanceof Eo))if(t instanceof js)this._addUniformLine("int",e,i);else if(t instanceof rm)this._addUniformLine("uint",e,i);else for(const[n,s]of Object.entries(t))if(Array.isArray(s)){const a=s;for(let l=0;l<a.length;l++)a[l],this._generateCodeForObject(a[l],void 0,`${n}[${l}].`)}else typeof s=="object"?this._generateCodeForObject(s,n,i):typeof s=="number"&&this._addUniformLine("float",n,i)}}const pc=class pc{static _generateLineForVertexAttribute(t){let e="";return t.itemCount===1?t.type===H.FLOAT?e="float":t.type===H.INT?e="int":t.type===H.UNSIGNED_INT?e="uint":t.type===H.BYTE?e="int":t.type===H.UNSIGNED_BYTE?e="uint":t.type===H.SHORT?e="int":t.type===H.UNSIGNED_SHORT&&(e="uint"):t.type===H.FLOAT||t.normalized===!0?e="vec"+t.itemCount:t.type===H.INT?e="ivec"+t.itemCount:t.type===H.UNSIGNED_INT?e="uvec"+t.itemCount:t.type===H.BYTE?e="ivec"+t.itemCount:t.type===H.UNSIGNED_BYTE?e="uvec"+t.itemCount:t.type===H.SHORT?e="ivec"+t.itemCount:t.type===H.UNSIGNED_SHORT&&(e="uvec"+t.itemCount),`${t.type}`,`in ${e} ${t.name};
`}static generateShaderResourceDescriptor(t){var m,b,g;const e=new sT().generateUniformBuffersCode(t.uniformBufferData,t.perObjectUniformTypes),i=new Set;for(const x of t.materialDefines)i.add(x);for(const x of(m=t.perObjectDefines)!=null?m:[])i.add(x);const n=Array.from(i).sort(pc.compare);let s="";for(const x of n)s+=`#define ${x}
`;const a=t.shaderParams,l=(b=a.vertexAttributes)!=null?b:Iu,c="".concat(...l.map(x=>pc._generateLineForVertexAttribute(x))),h=`#version 300 es
    precision highp float;
    precision highp int;
    ${s}
    ${e}
    ${c}
    ${zi.get(a.vsName).code}
    ${a.vsHooks?zi.get(a.vsHooks).code:""}`,d="".concat(...t.fsTextureInputs.map(x=>`uniform ${x};
`)),u="".concat(...t.fsOutputs.map(x=>`out ${x};
`)),f=(g=a.fsHooksCode)!=null?g:a.fsHooks?zi.get(a.fsHooks).code:"",p=`#version 300 es
    precision ${$e.gl.fragmentPrecision} float;
    precision ${$e.gl.fragmentPrecision} int;
    ${s}
    ${d}
    ${e}
    ${u}
    ${zi.get(a.fsName).code}
    ${f}`;return new D_(a.vsName,h,a.fsName,p,t.predefinedBindings,t.attributeDescriptors)}};o(pc,"compare",(t,e)=>t.localeCompare(e));let Du=pc;class gl{constructor(t,e,i,n){o(this,"x");o(this,"y");o(this,"width");o(this,"height");this.x=t,this.y=e,this.width=i,this.height=n}equals(t){return this.x===t.x&&this.y===t.y&&this.width===t.width&&this.height===t.height}copyFrom(t){this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height}set(t,e,i,n){this.x=t,this.y=e,this.width=i,this.height=n}}var Kr=(r=>(r[r.R=1]="R",r[r.G=2]="G",r[r.B=4]="B",r[r.A=8]="A",r[r.RGB=7]="RGB",r[r.RGBA=15]="RGBA",r))(Kr||{}),Js=(r=>(r[r.COLOR=1]="COLOR",r[r.DEPTH=2]="DEPTH",r[r.STENCIL=4]="STENCIL",r[r.DEPTH_STENCIL=6]="DEPTH_STENCIL",r[r.ALL=7]="ALL",r))(Js||{});class O_{constructor(t){o(this,"mode",Yt.DISABLED);o(this,"src",H.SRC_ALPHA);o(this,"dst",H.ONE_MINUS_SRC_ALPHA);o(this,"equation",H.FUNC_ADD);o(this,"srcAlpha",0);o(this,"dstAlpha",0);o(this,"equationAlpha",0);t&&Object.assign(this,t)}compare(t){return this.mode!==t.mode?this.mode<t.mode?-1:1:this.src!==t.src?this.src<t.src?-1:1:this.dst!==t.dst?this.dst<t.dst?-1:1:this.equation!==t.equation?this.equation<t.equation?-1:1:this.srcAlpha!==t.srcAlpha?this.srcAlpha<t.srcAlpha?-1:1:this.dstAlpha!==t.dstAlpha?this.dstAlpha<t.dstAlpha?-1:1:this.equationAlpha!==t.equationAlpha?this.equationAlpha<t.equationAlpha?-1:1:0}resetCustomToZero(){this.equation=0,this.src=0,this.dst=0,this.equationAlpha=0,this.srcAlpha=0,this.dstAlpha=0}}class rT{constructor(){o(this,"enabled",!1);o(this,"writeMask",255);o(this,"compareFunc",H.ALWAYS);o(this,"compareMask",255);o(this,"reference",0);o(this,"failOp",H.KEEP);o(this,"zFailOp",H.KEEP);o(this,"passOp",H.KEEP)}compare(t){return this.enabled!==t.enabled?this.enabled?1:-1:this.writeMask!==t.writeMask?this.writeMask<t.writeMask?-1:1:this.compareFunc!==t.compareFunc?this.compareFunc<t.compareFunc?-1:1:this.compareMask!==t.compareMask?this.compareMask<t.compareMask?-1:1:this.failOp!==t.failOp?this.failOp<t.failOp?-1:1:this.zFailOp!==t.zFailOp?this.zFailOp<t.zFailOp?-1:1:this.passOp!==t.passOp?this.passOp<t.passOp?-1:1:this.reference!==t.reference?this.reference<t.reference?-1:1:0}}class Lu{constructor(){o(this,"depthRead",!0);o(this,"depthWrite",!0);o(this,"colorWriteMask",new ua(15));o(this,"blendState",new O_);o(this,"faceSide",Ti.FRONT);o(this,"stencilState",new rT)}compare(t){if(this.depthRead!==t.depthRead)return this.depthRead?1:-1;if(this.depthWrite!==t.depthWrite)return this.depthWrite?1:-1;const e=this.blendState.compare(t.blendState);if(e!==0)return e;const i=this.colorWriteMask.compare(t.colorWriteMask);if(i!==0)return i;if(this.faceSide!==t.faceSide)return this.faceSide<t.faceSide?-1:1;const n=this.stencilState.compare(t.stencilState);return n!==0?n:0}}class Ar{constructor(t=0,e=0,i=Ke.RGBA8){o(this,"type",H.TEXTURE_2D);o(this,"format",Ke.RGBA8);o(this,"generateMipmaps",!1);o(this,"width",0);o(this,"height",0);this.width=t,this.height=e,this.format=i}}class vl{constructor(t){o(this,"wrapS",H.CLAMP_TO_EDGE);o(this,"wrapR",H.CLAMP_TO_EDGE);o(this,"wrapT",H.CLAMP_TO_EDGE);o(this,"minFilter",H.LINEAR);o(this,"magFilter",H.LINEAR);o(this,"compareMode",H.NONE);o(this,"compareFunc",H.ALWAYS);o(this,"anisotropy",1);o(this,"minLod",0);o(this,"maxLod",16);t&&Object.assign(this,t),this.anisotropy=Math.min(this.anisotropy,$e.gl.maxAnisotropy)}static compare(t,e){return t.wrapS!==e.wrapS?t.wrapS<e.wrapS?-1:1:t.wrapR!==e.wrapR?t.wrapR<e.wrapR?-1:1:t.wrapT!==e.wrapT?t.wrapT<e.wrapT?-1:1:t.minFilter!==e.minFilter?t.minFilter<e.minFilter?-1:1:t.magFilter!==e.magFilter?t.magFilter<e.magFilter?-1:1:t.compareMode!==e.compareMode?t.compareMode<e.compareMode?-1:1:t.compareFunc!==e.compareFunc?t.compareFunc<e.compareFunc?-1:1:t.minLod!==e.minLod?t.minLod<e.minLod?-1:1:t.maxLod!==e.maxLod?t.maxLod<e.maxLod?-1:1:t.anisotropy!==e.anisotropy?t.anisotropy<e.anisotropy?-1:1:0}}class uh{constructor(t,e,i){o(this,"readArea",new gl(0,0,0,0));o(this,"pixelBuf");o(this,"asyncCallback");this.asyncCallback=e,this.readArea.copyFrom(t);const n=t.width*t.height*4;!i||i.length,this.pixelBuf=i!=null?i:new Uint8Array(n)}}class F_ extends gr{constructor(){super(...arguments);o(this,"pipelineState",new Lu)}compare(e){return this.pipelineState.compare(e.pipelineState)}}class B_ extends Io{}class fh{constructor(){o(this,"_textureBindings",new Map)}getBindings(){return this._textureBindings}getBinding(t){return this._textureBindings.has(t),this._textureBindings.get(t)}setBinding(t,e,i,n){const s={texture:i,binding:t,type:e,sampler:n};this._textureBindings.set(t,s)}clearTable(){this._textureBindings.clear()}}class ph{constructor(t){o(this,"dataBuffer");o(this,"dataView");o(this,"descriptor");this.descriptor=t,this.dataBuffer=new ArrayBuffer(t.size),this.dataView=new DataView(this.dataBuffer)}_getUniformOffset(t,e){let i=e!=null?e:"";return t&&(i+=`${e?".":""}${t}`),this.descriptor.getUniformOffsetInBytes(i)}_loadInt32(t,e){this.dataView.setInt32(t,e,!0)}_loadUint32(t,e){this.dataView.setUint32(t,e,!0)}_loadUint8(t,e){this.dataView.setUint8(t,e)}_loadFloat32(t,e){this.dataView.setFloat32(t,e,!0)}_loadFloat32Vector(t,e){this._loadFloat32(e,t.x),this._loadFloat32(e+1*Zs,t.y),t instanceof ye||this._loadFloat32(e+2*Zs,t.z),t instanceof We&&this._loadFloat32(e+3*Zs,t.w)}_loadFloat32Matrix(t,e){let i=0;for(const n of t.elements)this._loadFloat32(e+Zs*i++,n)}_loadColor(t,e){this._loadFloat32(e,t.r),this._loadFloat32(e+1*Zs,t.g),this._loadFloat32(e+2*Zs,t.b)}loadObject(t,e,i){if(t instanceof We)this._loadFloat32Vector(t,this._getUniformOffset(e,i));else if(t instanceof L){const n=`${e}_pad`;this._loadFloat32Vector(t,this._getUniformOffset(n,i))}else if(t instanceof ye)this._loadFloat32Vector(t,this._getUniformOffset(e,i));else if(t instanceof Ue)this._loadFloat32Matrix(t,this._getUniformOffset(e,i));else if(t instanceof Eo)this._loadFloat32Matrix(t,this._getUniformOffset(e,i));else if(t instanceof js)this._loadInt32(this._getUniformOffset(e,i),t.value);else if(t instanceof rm)this._loadUint32(this._getUniformOffset(e,i),t.value);else if(t instanceof _e){const n=`${e}_pad`;this._loadColor(t,this._getUniformOffset(n,i))}else{let n;for(n in t)if(Object.prototype.hasOwnProperty.call(t,n))if(Array.isArray(t[n])){const s=t[n];for(let a=0;a<s.length;a++)s[a],this.loadObject(s[a],void 0,`${n}[${a}]`)}else typeof t[n]=="object"?this.loadObject(t[n],n,i):typeof t[n]=="number"?this._loadFloat32(this._getUniformOffset(n,i),t[n]):typeof t[n]=="boolean"&&this._loadUint8(this._getUniformOffset(n,i),t[n]?1:0)}}}class Ou{constructor(t){o(this,"_dataBuffer");o(this,"_dataView");o(this,"descriptor");this.descriptor=t,this._dataBuffer=new ArrayBuffer(t.size),this._dataView=new DataView(this._dataBuffer)}readUniformBuffer(t,e,i){const n=t.gl;t.bindBuffer(n.UNIFORM_BUFFER,e.glBuffer),n.getBufferSubData(n.UNIFORM_BUFFER,0,this._dataView);for(const[s,a]of this.descriptor.uniforms){const l=a.blockOffset,c=[],{elementType:h,elementCount:d}=this._getElementTypeAndCount(a.type),u=this._getElementSize(h);for(let f=0;f<d;f++)h===0?c.push(this._dataView.getFloat32(l+f*u,!0)):h===1?c.push(this._dataView.getInt32(l+f*u,!0)):h===2&&c.push(this._dataView.getUint8(l+f*u));i(s,c)}}_getElementTypeAndCount(t){switch(t){case at.FLOAT:return{elementType:0,elementCount:1};case at.FLOAT_VEC2:return{elementType:0,elementCount:2};case at.FLOAT_VEC3:return{elementType:0,elementCount:3};case at.FLOAT_VEC4:return{elementType:0,elementCount:4};case at.FLOAT_MAT2:return{elementType:0,elementCount:4};case at.FLOAT_MAT3:return{elementType:0,elementCount:9};case at.FLOAT_MAT4:return{elementType:0,elementCount:16};case at.INT:return{elementType:1,elementCount:1};case at.INT_VEC2:return{elementType:1,elementCount:2};case at.INT_VEC3:return{elementType:1,elementCount:3};case at.INT_VEC4:return{elementType:1,elementCount:4};case at.BOOL:return{elementType:2,elementCount:1};case at.BOOL_VEC2:return{elementType:2,elementCount:2};case at.BOOL_VEC3:return{elementType:2,elementCount:3};case at.BOOL_VEC4:return{elementType:2,elementCount:4};default:throw new Error(`Unknown uniform data type: ${t}`)}}_getElementSize(t){switch(t){case 0:case 1:return Zs;case 2:return 1;default:throw new Error(`Unknown element type: ${t}`)}}}class Ta{constructor(t){o(this,"glBuffer");o(this,"_wholeBufferUploadedToGpu",!1);const e=t.createBuffer();this.glBuffer=e}update(t,e,i){const n=new ph(e);n.loadObject(t),this.uploadBufferToGpu(n.dataView,i)}uploadBufferToGpu(t,e){this.glBuffer,e.bindBuffer(e.UNIFORM_BUFFER,this.glBuffer),e.bufferData(e.UNIFORM_BUFFER,t,e.DYNAMIC_DRAW),e.bindBuffer(e.UNIFORM_BUFFER,null),this._wholeBufferUploadedToGpu=!0}uploadSubdataToGPU(t,e,i){this.glBuffer&&this._wholeBufferUploadedToGpu,i.bindBuffer(i.UNIFORM_BUFFER,this.glBuffer),i.bufferSubData(i.UNIFORM_BUFFER,e,t),i.bindBuffer(i.UNIFORM_BUFFER,null)}unload(t){this.glBuffer&&(t.deleteBuffer(this.glBuffer),this.glBuffer=void 0,this._wholeBufferUploadedToGpu=!1)}}class mh{constructor(t,e,i){o(this,"_uniformBuffer");o(this,"_transferBuffer");o(this,"data");this._uniformBuffer=new Ta(t.gl),this._transferBuffer=new ph(e),this.data=i}uploadData(t){this._transferBuffer.loadObject(this.data),this._uniformBuffer.uploadBufferToGpu(this._transferBuffer.dataView,t.gl)}bindUniformBufer(t,e){const i=this._uniformBuffer.glBuffer;e.bindUniformBuffer(t,i)}unload(t){this._uniformBuffer.unload(t.gl)}get uniformBuffer(){return this._uniformBuffer}}const $r=new Map([["lightmap",0],["brdfLUT",1],["envMap[0]",2],["envMap[1]",3],["envMap[2]",4],["colorMap",5],["liveLightmap",6]]);class Tr extends gr{constructor(e,i,n,s,a,l){super();o(this,"material");o(this,"fsOutputs");o(this,"fsTextureInputs");o(this,"perObjectUniformTypes");o(this,"perObjectShaderDefines");o(this,"perObjectShaderDefinesHash",0);o(this,"perObjectStencilState");this.material=e,this.fsOutputs=i,this.fsTextureInputs=n,this.perObjectUniformTypes=s,this.perObjectShaderDefines=a,this.perObjectStencilState=l,this.perObjectShaderDefines&&(this.perObjectShaderDefinesHash=Cp(this.perObjectShaderDefines))}compare(e){const i=Gs(this.material.renderResourceId,e.material.renderResourceId);if(i!==0)return i;const n=Gs(this.perObjectShaderDefinesHash,e.perObjectShaderDefinesHash);if(n!==0)return n;if(this.perObjectStencilState!==e.perObjectStencilState){if(!this.perObjectStencilState)return-1;if(!e.perObjectStencilState)return 1;const s=this.perObjectStencilState.compare(e.perObjectStencilState);if(s!==0)return s}return 0}}const qa=class qa extends Io{constructor(){super(...arguments);o(this,"shader",new Kt);o(this,"textures",new Array);o(this,"pipelineState",new Kt);o(this,"uniformBuffer");o(this,"textureTable",new fh)}load(e){return this._resetShader(e)?(this.resetPipelineState(e),this.resetTextureResources(e),!0):!1}_resetShader(e){var l,c,h;const i=this.descriptor,n=i.material,s={shaderParams:n.shaderParams,uniformBufferData:n.uniformBufferData,perObjectUniformTypes:(l=i.perObjectUniformTypes)!=null?l:[],materialDefines:n.getDefines(),perObjectDefines:(c=i.perObjectShaderDefines)!=null?c:[],predefinedBindings:$r,fsOutputs:i.fsOutputs,fsTextureInputs:(h=i.fsTextureInputs)!=null?h:[],attributeDescriptors:Iu},a=Du.generateShaderResourceDescriptor(s);if(this.shader=e.getResource(a),this.shader.get()){const d=this.shader.get().uniformBlockDescriptors.get(Vi[oe.MATERIAL]);if(d&&n.uniformBufferData){const u=e.webGLRenderer.getGl();this.uniformBuffer=new Ta(u),this.uniformBuffer.update(n.uniformBufferData,d,u)}return!0}return!1}resetPipelineState(e){var c,h,d;const i=this.descriptor,n=i.material,s=new F_,a=s.pipelineState;a.depthRead=n.depthTest,a.depthWrite=n.depthWrite,a.colorWriteMask=n.colorWrite?qa.colorWriteMask:qa.noColorWriteMask;const l=new O_({mode:n.blending,src:n.blendSrc,dst:n.blendDst,equation:n.blendEquation,srcAlpha:(c=n.blendSrcAlpha)!=null?c:0,dstAlpha:(h=n.blendDstAlpha)!=null?h:0,equationAlpha:(d=n.blendEquationAlpha)!=null?d:0});a.blendState=l,a.faceSide=n.side,i.perObjectStencilState&&Object.assign(a.stencilState,i.perObjectStencilState),this.pipelineState=e.getResource(s)}resetTextureResources(e){const i=this.shader.get().samplerUniformTable.samplerUniforms,n=this.descriptor.material.uniforms;this.textureTable.clearTable();for(const a of this.textures)a.set(void 0,e);this.textures.length=0;const s=e.textureManager;for(const a of i){const l=a.name;if(Object.prototype.hasOwnProperty.call(n,l)&&!$r.has(l)){const c=n[l].value,h=s.getDescriptorForTexture(c),d=e.getResource(h);this.textures.push(d);const u=d.get().descriptor.getTextureSamplerDescriptor(),f=e.renderContext.getTextureSampler(u),p=d.get().texture;this.textureTable.setBinding(a.binding,a.type,p,f)}}}unload(e){this.shader.set(void 0,e),this.pipelineState.set(void 0,e),this.uniformBuffer&&this.uniformBuffer.unload(e.webGLRenderer.getGl());for(const i of this.textures)i.set(void 0,e);this.textures.length=0,this.textureTable.clearTable()}};o(qa,"colorWriteMask",new ua(Kr.RGBA)),o(qa,"noColorWriteMask",new ua);let _h=qa;class oT{constructor(t){o(this,"gl");o(this,"boundTextures",new Array);o(this,"boundSamplers",new Array);o(this,"currentProgram");o(this,"currentVao");o(this,"currentFramebuffer");o(this,"currentViewport",new gl(0,0,0,0));o(this,"currentScissorArea");o(this,"anisotropyExtension");o(this,"_samplerDescriptorsToSamplers",new Yp(void 0,vl.compare));o(this,"_pipelineState",new Lu);o(this,"_clearColor",new We(0,0,0,1));this.gl=t,this.anisotropyExtension=$e.gl.extension("EXT_texture_filter_anisotropic")}bindTexture(t,e,i){const n=this.boundTextures;n[i]!==t&&(n[i]=t,this.gl.activeTexture(this.gl.TEXTURE0+i),this.gl.bindTexture(e,t))}bindSampler(t,e){const i=this.boundSamplers;i[e]!==t&&(i[e]=t,this.gl.bindSampler(e,t))}getTextureSampler(t){let e=this._samplerDescriptorsToSamplers.getElementByKey(t);if(!e){const i=this.gl;return e=i.createSampler(),i.samplerParameteri(e,i.TEXTURE_WRAP_S,t.wrapS),i.samplerParameteri(e,i.TEXTURE_WRAP_R,t.wrapR),i.samplerParameteri(e,i.TEXTURE_WRAP_T,t.wrapT),i.samplerParameteri(e,i.TEXTURE_MIN_FILTER,t.minFilter),i.samplerParameteri(e,i.TEXTURE_MAG_FILTER,t.magFilter),i.samplerParameteri(e,i.TEXTURE_COMPARE_MODE,t.compareMode),i.samplerParameteri(e,i.TEXTURE_COMPARE_FUNC,t.compareFunc),i.samplerParameterf(e,i.TEXTURE_MIN_LOD,t.minLod),i.samplerParameterf(e,i.TEXTURE_MAX_LOD,t.maxLod),this.anisotropyExtension&&i.samplerParameterf(e,this.anisotropyExtension.TEXTURE_MAX_ANISOTROPY_EXT,t.anisotropy),this._samplerDescriptorsToSamplers.setElement(t,e),e}return this._samplerDescriptorsToSamplers.getElementByKey(t)}createAndBindVao(){const t=this.gl.createVertexArray();return this.bindVao(t),t}bindVao(t){this.currentVao!==t&&(this.currentVao=t,this.gl.bindVertexArray(t!=null?t:null))}deleteVao(t){this.currentVao===t&&this.bindVao(void 0),this.gl.deleteVertexArray(t)}setupVertexAttribute(t,e,i,n,s=1,a=!1,l=0){const c=this.gl;c.enableVertexAttribArray(t),c.vertexAttribPointer(t,e,i,a,l,n),c.vertexAttribDivisor(t,s)}disableVertexAttribute(t,e){const i=this.gl;i.disableVertexAttribArray(t),e&&(e.length===1?i.vertexAttrib1fv(t,e):e.length===2?i.vertexAttrib2fv(t,e):e.length===3?i.vertexAttrib3fv(t,e):e.length===4&&i.vertexAttrib4fv(t,e))}createBuffer(){return this.gl.createBuffer()}deleteBuffer(t){this.gl.deleteBuffer(t!=null?t:null)}bindBuffer(t,e){this.gl.bindBuffer(t,e)}updateBuffer(t,e,i=!0){this.gl.bufferData(t,e,i?this.gl.STATIC_DRAW:this.gl.DYNAMIC_DRAW)}bindUniformBuffer(t,e){this.gl.bindBufferBase(this.gl.UNIFORM_BUFFER,t,e)}bindProgram(t){t!==this.currentProgram&&(this.currentProgram=t,this.gl.useProgram(t))}bindFramebuffer(t){this.currentFramebuffer!==t&&(this.currentFramebuffer=t,this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,t!=null?t:null))}bindPipelineState(t){T.DEV_NEW_PIPELINE_STATES;const e=this.gl,i=this._pipelineState;if(this.setBlending(t.blendState),i.depthRead!==t.depthRead&&(i.depthRead=t.depthRead,i.depthRead?e.enable(e.DEPTH_TEST):e.disable(e.DEPTH_TEST)),i.depthWrite!==t.depthWrite&&(i.depthWrite=t.depthWrite,e.depthMask(i.depthWrite)),i.colorWriteMask.compare(t.colorWriteMask)!==0){const n=t.colorWriteMask;i.colorWriteMask.copyFrom(n),this.gl.colorMask(n.get(Kr.R),n.get(Kr.G),n.get(Kr.B),n.get(Kr.A))}if(this.setCullFace(t.faceSide),i.stencilState.compare(t.stencilState)!==0){const n=Object.assign(i.stencilState,t.stencilState);n.enabled?(e.enable(e.STENCIL_TEST),e.stencilMask(n.writeMask),e.stencilFunc(n.compareFunc,n.reference,n.compareMask),e.stencilOp(n.failOp,n.zFailOp,n.passOp)):e.disable(e.STENCIL_TEST)}}setCullFace(t){const e=this.gl,i=this._pipelineState;i.faceSide!==t&&(i.faceSide=t,i.faceSide!==Ti.DOUBLE?e.enable(e.CULL_FACE):e.disable(e.CULL_FACE),e.frontFace(i.faceSide===Ti.BACK?e.CW:e.CCW))}setBlending(t){T.DEV_NEW_PIPELINE_STATES;const e=t.mode,i=this.gl;e!==this._pipelineState.blendState.mode&&(e===Yt.DISABLED?i.disable(i.BLEND):e===Yt.ADDITIVE?(i.enable(i.BLEND),i.blendEquation(i.FUNC_ADD),i.blendFunc(i.SRC_ALPHA,i.ONE)):e===Yt.SUBTRACTIVE?(i.enable(i.BLEND),i.blendEquation(i.FUNC_ADD),i.blendFunc(i.ZERO,i.ONE_MINUS_SRC_COLOR)):e===Yt.MULTIPLY?(i.enable(i.BLEND),i.blendEquation(i.FUNC_ADD),i.blendFunc(i.ZERO,i.SRC_COLOR)):e===Yt.CUSTOM?i.enable(i.BLEND):(e==Yt.NORMAL,i.enable(i.BLEND),i.blendEquationSeparate(i.FUNC_ADD,i.FUNC_ADD),i.blendFuncSeparate(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA,i.ONE,i.ONE_MINUS_SRC_ALPHA)),this._pipelineState.blendState.mode=e);const n=this._pipelineState.blendState;if(e===Yt.CUSTOM){const s=t.equationAlpha!==0?t.equationAlpha:t.equation,a=t.srcAlpha!==0?t.srcAlpha:t.src,l=t.dstAlpha!==0?t.dstAlpha:t.dst;(t.equation!==n.equation||s!==n.equationAlpha)&&(n.equation=t.equation,n.equationAlpha=s,i.blendEquationSeparate(t.equation,s)),(t.src!==n.src||t.dst!==n.dst||a!==n.srcAlpha||l!==n.dstAlpha)&&(i.blendFuncSeparate(t.src,t.dst,a,l),n.src=t.src,n.dst=t.dst,n.srcAlpha=a,n.dstAlpha=l)}else n.resetCustomToZero()}setScissorTest(t){t?(this.currentScissorArea||(this.currentScissorArea=new gl(0,0,0,0),this.gl.enable(this.gl.SCISSOR_TEST)),this.currentScissorArea.equals(t)||(this.gl.scissor(t.x,t.y,t.width,t.height),this.currentScissorArea.copyFrom(t))):this.currentScissorArea&&(this.gl.disable(this.gl.SCISSOR_TEST),this.currentScissorArea=void 0)}resetState(){const t=this.gl;if(this.currentProgram=void 0,t.useProgram(null),this.currentVao=void 0,t.bindVertexArray(null),this.boundTextures.length=0,this.boundSamplers.length=0,T.DEV_NEW_PIPELINE_STATES){const e=this._pipelineState;e.depthRead=!0,t.enable(t.DEPTH_TEST),e.depthWrite=!0,t.depthMask(!0),e.colorWriteMask.set(Kr.RGBA),t.colorMask(!0,!0,!0,!0),e.blendState.resetCustomToZero(),e.blendState.mode=Yt.DISABLED,t.disable(t.BLEND),e.faceSide=Ti.FRONT,t.enable(t.CULL_FACE),t.frontFace(t.CCW),e.stencilState.enabled=!1,t.disable(t.STENCIL_TEST),this._clearColor.set(0,0,0,0),this.gl.clearColor(0,0,0,0),this.gl.disable(this.gl.SCISSOR_TEST),this.currentScissorArea=void 0}}createTexture(t){const e=this.gl,i=e.createTexture();return this.bindTexture(i,H.TEXTURE_2D,0),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.texStorage2D(e.TEXTURE_2D,1,t.format,t.width,t.height),i}deleteTexture(t){this.gl.deleteTexture(t)}createFramebuffer(t,e,i){const n=this.gl,s=n.createFramebuffer();this.bindFramebuffer(s);const a=[];for(let c=0;c<t.length;c++){const h=n.COLOR_ATTACHMENT0+c;n.framebufferTexture2D(n.FRAMEBUFFER,h,n.TEXTURE_2D,t[c],0),t[c]&&a.push(h)}if(e){const c=i?n.DEPTH_STENCIL_ATTACHMENT:n.DEPTH_ATTACHMENT;n.framebufferTexture2D(n.FRAMEBUFFER,c,n.TEXTURE_2D,e,0)}n.drawBuffers(a);const l=n.checkFramebufferStatus(n.FRAMEBUFFER);return n.FRAMEBUFFER_COMPLETE,this.bindFramebuffer(void 0),s}deleteFramebuffer(t){this.gl.deleteFramebuffer(t)}drawGeometry(t,e,i=0,n,s){const a=this.gl;s=s!=null?s:a.TRIANGLES,e?n?a.drawElementsInstanced(s,t,e,i,n):a.drawElements(s,t,e,i):n?a.drawArraysInstanced(s,i,t,n):a.drawArrays(s,i,t)}setViewport(t){this.currentViewport.equals(t)||(this.currentViewport.copyFrom(t),this.gl.viewport(t.x,t.y,t.width,t.height))}checkGlError(){const t=this.gl.getError();t!==this.gl.NO_ERROR&&console.log("gl error! "+t)}clear(t,e=new ua(Js.ALL)){T.DEV_NEW_PIPELINE_STATES,t&&(this._clearColor.equals(t)||(this._clearColor.copyFrom(t),this.gl.clearColor(t.x,t.y,t.z,t.w)));let i=0;e.get(Js.COLOR)&&(i|=this.gl.COLOR_BUFFER_BIT),e.get(Js.DEPTH)&&(i|=this.gl.DEPTH_BUFFER_BIT),e.get(Js.STENCIL)&&(i|=this.gl.STENCIL_BUFFER_BIT),this.gl.clear(i)}clientWaitAsync(t,e,i){return new Promise((n,s)=>{function a(l){const c=l.clientWaitSync(t,e,0);if(c===l.WAIT_FAILED){s();return}if(c===l.TIMEOUT_EXPIRED){setTimeout(a.bind(null,l),i);return}n()}a(this.gl)})}getBufferSubDataAsync(t,e,i,n,s,a){return $t(this,null,function*(){const l=this.gl,c=l.fenceSync(l.SYNC_GPU_COMMANDS_COMPLETE,0);l.flush();const h=16;return yield this.clientWaitAsync(c,0,h),l.deleteSync(c),l.bindBuffer(t,e),l.getBufferSubData(t,i,n,s,a),l.bindBuffer(t,null),n})}readPixelsAsync(t){return $t(this,null,function*(){const e=this.gl,i=e.createBuffer();e.bindBuffer(e.PIXEL_PACK_BUFFER,i),e.bufferData(e.PIXEL_PACK_BUFFER,t.pixelBuf.byteLength,e.STREAM_READ);const n=t.readArea;return t.pixelBuf instanceof Uint8Array?e.readPixels(n.x,n.y,n.width,n.height,e.RGBA,e.UNSIGNED_BYTE,0):e.readPixels(n.x,n.y,n.width,n.height,e.RGBA,e.FLOAT,0),e.bindBuffer(e.PIXEL_PACK_BUFFER,null),yield this.getBufferSubDataAsync(e.PIXEL_PACK_BUFFER,i,0,t.pixelBuf),e.deleteBuffer(i),t})}readPixelsSync(t,e){const i=this.gl;e instanceof Uint8Array?i.readPixels(t.x,t.y,t.width,t.height,i.RGBA,i.UNSIGNED_BYTE,e):i.readPixels(t.x,t.y,t.width,t.height,i.RGBA,i.FLOAT,e)}readPixels(t){t.asyncCallback?this.readPixelsAsync(t).then(e=>{e.asyncCallback(e.pixelBuf)},()=>{console.warn("Read async failed!")}):this.readPixelsSync(t.readArea,t.pixelBuf)}}var Nn=(r=>(r[r.DEBUG_CAPTURE=0]="DEBUG_CAPTURE",r[r.CUSTOM_RENDER=1]="CUSTOM_RENDER",r[r.MANUAL_RENDER_STATE_RESET=2]="MANUAL_RENDER_STATE_RESET",r[r.DEBUG_POSTPROCESS=3]="DEBUG_POSTPROCESS",r))(Nn||{});class aT{constructor(){o(this,"simStateAlpha",0);o(this,"deltaTime",0);o(this,"renderedFramesCounter",0);o(this,"animatedMaterialVisible",!1)}}class Zr{constructor(t,e){o(this,"_renderWorld");o(this,"_resourcesEnv");o(this,"frameFlags");o(this,"sharedState");o(this,"webGLRenderer");o(this,"camera");o(this,"viewport",new gl(0,0,0,0));o(this,"frameMetrics",new aT);var i;this._renderWorld=e.renderWorld,this._resourcesEnv=e.resourcesEnv,this.camera=t,this.frameFlags=(i=e.frameFlags)!=null?i:new xo,this.sharedState=this.resourcesEnv.sharedState,this.webGLRenderer=this.resourcesEnv.webGLRenderer}get renderWorld(){return this._renderWorld}get resourcesEnv(){return this._resourcesEnv}get postprocessComp(){return this.camera.get(Dn)}}class Fu{constructor(){o(this,"_resource",new Kt)}assignResource(t,e){return this._resource.copyFrom(t,e),this}copyFrom(t,e){return this._resource.copyFrom(t._resource,e),this}getResourceAs(t){if(this._resource.get()&&this._resource.get()instanceof t)return this._resource.get()}unloadResource(t){this._resource.set(void 0,t)}}class mi extends Fu{}class Xn extends Fu{}class Jr extends Fu{}class N_{constructor(t,e,i){o(this,"parentNode");o(this,"connectedPorts",[]);o(this,"resultType");o(this,"shaderVariable");this.parentNode=t,this.resultType=e,this.shaderVariable=i}getShaderVariable(){return this.shaderVariable}getShaderVariableName(){var t;return(t=this.shaderVariable)==null?void 0:t.name}getConnectedPort(){return this.connectedPorts.length<=1,this.connectedPorts.length===0?void 0:this.connectedPorts[0]}connect(t){this.connectedPorts.includes(t)||this.connectedPorts.push(t),t.connectedPorts.includes(this)||t.connectedPorts.push(this)}disconnect(t){const e=this.connectedPorts.indexOf(t);e>-1&&this.connectedPorts.splice(e,1);const i=t.connectedPorts.indexOf(this);i>-1&&t.connectedPorts.splice(i,1)}}class Gi{constructor(t){o(this,"_inputs",new Array);o(this,"_outputs",new Array);o(this,"nodeName");o(this,"_nextFlowNode");o(this,"_prevFlowNode");this.nodeName=t,ct.registerIfEnabled(this)}get nextFlowNode(){return this._nextFlowNode}get prevFlowNode(){return this._prevFlowNode}getInputs(){return this._inputs}getOutputs(){return this._outputs}connectNextFlowNode(t){!this._nextFlowNode&&t._prevFlowNode,this._nextFlowNode=t,t._prevFlowNode=this}addInputPort(t,e){const i=new N_(this,t,e);return this._inputs.push(i),i}addOutputPort(t,e){const i=new N_(this,t,e);return this._outputs.push(i),i}connectOutput(t,e){const i=this.getInputs().find(s=>s.resultType===e),n=t.getOutputs().find(s=>s.resultType===e);i!==void 0&&n!==void 0?i.connect(n):console.error("Couldn't find valid ports for connecting by result of type "+e+".")}static connectOutputsToInputs(t,e){for(const i of e.getInputs()){const n=t.getOutputs().find(s=>s.resultType===i.resultType);n!==void 0&&i.connect(n)}}connectMatchingOutputs(t){for(const e of this.getInputs()){const i=t.getOutputs().find(n=>n.resultType===e.resultType);i!==void 0&&e.connect(i)}}build(t){}render(t){}acquireResources(t,e){}unloadResources(t){}isRenderCallRequired(){return!0}}class Bu extends gr{constructor(e,i,n,s){super();o(this,"textureSource");o(this,"textureId");o(this,"width",0);o(this,"height",0);this.textureSource=e,this.textureId=i,e instanceof Ar||e instanceof st?(this.width=e.width,this.height=e.height):(this.width=n,this.height=s)}compare(e){return Gs(this.textureId,e.textureId)}getCreatedTextureParams(){if(this.textureSource instanceof Ar)return this.textureSource}getTextureSamplerDescriptor(){this.textureSource instanceof st;const e=this.textureSource;return new vl({wrapS:e.wrapS,wrapT:e.wrapT,minFilter:e.minFilter,magFilter:e.magFilter,anisotropy:e.anisotropy})}}class bl extends Io{constructor(){super(...arguments);o(this,"texture")}load(e){return!1}unload(e){}}class wa extends Gi{constructor(){super(...arguments);o(this,"drawCall",new qr);o(this,"_textureTable",new fh);o(this,"_portsToTextureBindings",new Map);o(this,"_renderTarget",new Kt)}setupDrawCall(e,i,n,s){const a=n!=null?n:new Array;for(const p of this.getInputs()){const m=p.getShaderVariable();m&&a.push(`${m.type} ${m.name}`)}const l=new Array;for(const p of this.getOutputs()){const m=p.getShaderVariable();m&&l.push(`${m.type} ${m.name}`)}const c=new tu;c.meshDesc=e.fullscreenRenderHelper.meshResourceDescriptor,c.materialDesc=new Tr(i,l,a,void 0,void 0,s),this.drawCall.load(e,c);const h=e.textureManager,d=h.nullTextures.textureTypeToNullTextures,u=h.samplers.pointSampler;this._textureTable.clearTable(),this._portsToTextureBindings.clear();const f=this.drawCall.renderMaterial.get().shader.get().samplerUniformTable.samplerUniforms;for(const p of f){const m=p.name,b=this._inputs.findIndex(g=>g.getShaderVariableName()===m);if(b!==-1){const g=p.binding;this._textureTable.setBinding(g,p.type,d.get(p.type),u),this._portsToTextureBindings.set(this._inputs[b],this._textureTable.getBindings().get(g))}}this._portsToTextureBindings.size+(s?1:0),this._inputs.length}get textureTable(){return this._textureTable}setRenderTarget(e,i){this._renderTarget.set(e,i)}build(e){for(const i of this._inputs){if(i.connectedPorts.length===0)continue;const n=e.requestConnectedResultAs(i,i.resultType);if(n&&this._portsToTextureBindings.has(i)){const s=n.getResourceAs(bl);this._portsToTextureBindings.get(i).texture=s.texture}}this._renderTarget=e.requestRenderTarget(this)}unloadResources(e){this._renderTarget.set(void 0,e.resourcesEnv)}render(e){this._renderTarget.get();const i=e.webGLRenderer,n=e.resourcesEnv.renderContext;this._renderTarget.get().bind(n,i,e.viewport),e.sharedState.bindDrawCall(this.drawCall,i),e.sharedState.bindTextureTable(this._textureTable),this.drawCall.render(n)}unload(e){this.drawCall.unload(e)}}class lT extends wa{constructor(t){super("CameraReprojectedUv");const e=new bt({vsName:"postprocess_vertex.glsl",fsName:"reprojected_uv_fragment.glsl"});e.depthWrite=!1,e.depthTest=!1,e.addDefine("DEV_NEW_RENDER_ARCHITECTURE"),this.addInputPort(Xn,{type:"sampler2D",name:"tDepth"}),this.addOutputPort(Jr,{type:"vec4",name:"reprojectedUvResult"}),this.setupDrawCall(t,e)}}class cT extends wa{constructor(t){super("FXAA");const e=new bt({vsName:"fxaa_vertex.glsl",fsName:"fxaa_fragment.glsl"});e.depthWrite=!1,e.depthTest=!1,e.depthWrite=!1,e.addDefine("DEV_NEW_RENDER_ARCHITECTURE"),this.addInputPort(mi,{type:"sampler2D",name:"tDiffuse"}),this.addOutputPort(mi,{type:"vec4",name:"fragColor"}),this.setupDrawCall(t,e)}}class hT extends wa{constructor(t){super("MotionBlur");const e=new bt({vsName:"postprocess_vertex.glsl",fsName:"motion_blur_fragment.glsl"});e.depthWrite=!1,e.depthTest=!1,e.depthWrite=!1,e.addDefine("DEV_NEW_RENDER_ARCHITECTURE"),this.addInputPort(mi,{type:"sampler2D",name:"tDiffuse"}),this.addInputPort(Jr,{type:"sampler2D",name:"tReprojectedUv"}),this.addOutputPort(mi,{type:"vec4",name:"fragColor"}),this.setupDrawCall(t,e)}}function dT(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}function uT(r){if(r.__esModule)return r;var t=r.default;if(typeof t=="function"){var e=function i(){return this instanceof i?Reflect.construct(t,arguments,this.constructor):t.apply(this,arguments)};e.prototype=t.prototype}else e={};return Object.defineProperty(e,"__esModule",{value:!0}),Object.keys(r).forEach(function(i){var n=Object.getOwnPropertyDescriptor(r,i);Object.defineProperty(e,i,n.get?n:{enumerable:!0,get:function(){return r[i]}})}),e}var Ot={},Nu=function(r,t){return Nu=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,i){e.__proto__=i}||function(e,i){for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n])},Nu(r,t)};function U_(r,t){if(typeof t!="function"&&t!==null)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");Nu(r,t);function e(){this.constructor=r}r.prototype=t===null?Object.create(t):(e.prototype=t.prototype,new e)}var gh=function(){return gh=Object.assign||function(t){for(var e,i=1,n=arguments.length;i<n;i++){e=arguments[i];for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&(t[s]=e[s])}return t},gh.apply(this,arguments)};function k_(r,t){var e={};for(var i in r)Object.prototype.hasOwnProperty.call(r,i)&&t.indexOf(i)<0&&(e[i]=r[i]);if(r!=null&&typeof Object.getOwnPropertySymbols=="function")for(var n=0,i=Object.getOwnPropertySymbols(r);n<i.length;n++)t.indexOf(i[n])<0&&Object.prototype.propertyIsEnumerable.call(r,i[n])&&(e[i[n]]=r[i[n]]);return e}function V_(r,t,e,i){var n=arguments.length,s=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(r,t,e,i);else for(var l=r.length-1;l>=0;l--)(a=r[l])&&(s=(n<3?a(s):n>3?a(t,e,s):a(t,e))||s);return n>3&&s&&Object.defineProperty(t,e,s),s}function z_(r,t){return function(e,i){t(e,i,r)}}function fT(r,t,e,i,n,s){function a(x){if(x!==void 0&&typeof x!="function")throw new TypeError("Function expected");return x}for(var l=i.kind,c=l==="getter"?"get":l==="setter"?"set":"value",h=!t&&r?i.static?r:r.prototype:null,d=t||(h?Object.getOwnPropertyDescriptor(h,i.name):{}),u,f=!1,p=e.length-1;p>=0;p--){var m={};for(var b in i)m[b]=b==="access"?{}:i[b];for(var b in i.access)m.access[b]=i.access[b];m.addInitializer=function(x){if(f)throw new TypeError("Cannot add initializers after decoration has completed");s.push(a(x||null))};var g=(0,e[p])(l==="accessor"?{get:d.get,set:d.set}:d[c],m);if(l==="accessor"){if(g===void 0)continue;if(g===null||typeof g!="object")throw new TypeError("Object expected");(u=a(g.get))&&(d.get=u),(u=a(g.set))&&(d.set=u),(u=a(g.init))&&n.unshift(u)}else(u=a(g))&&(l==="field"?n.unshift(u):d[c]=u)}h&&Object.defineProperty(h,i.name,d),f=!0}function pT(r,t,e){for(var i=arguments.length>2,n=0;n<t.length;n++)e=i?t[n].call(r,e):t[n].call(r);return i?e:void 0}function mT(r){return typeof r=="symbol"?r:"".concat(r)}function _T(r,t,e){return typeof t=="symbol"&&(t=t.description?"[".concat(t.description,"]"):""),Object.defineProperty(r,"name",{configurable:!0,value:e?"".concat(e," ",t):t})}function G_(r,t){if(typeof Reflect=="object"&&typeof Reflect.metadata=="function")return Reflect.metadata(r,t)}function H_(r,t,e,i){function n(s){return s instanceof e?s:new e(function(a){a(s)})}return new(e||(e=Promise))(function(s,a){function l(d){try{h(i.next(d))}catch(u){a(u)}}function c(d){try{h(i.throw(d))}catch(u){a(u)}}function h(d){d.done?s(d.value):n(d.value).then(l,c)}h((i=i.apply(r,t||[])).next())})}function W_(r,t){var e={label:0,sent:function(){if(s[0]&1)throw s[1];return s[1]},trys:[],ops:[]},i,n,s,a;return a={next:l(0),throw:l(1),return:l(2)},typeof Symbol=="function"&&(a[Symbol.iterator]=function(){return this}),a;function l(h){return function(d){return c([h,d])}}function c(h){if(i)throw new TypeError("Generator is already executing.");for(;a&&(a=0,h[0]&&(e=0)),e;)try{if(i=1,n&&(s=h[0]&2?n.return:h[0]?n.throw||((s=n.return)&&s.call(n),0):n.next)&&!(s=s.call(n,h[1])).done)return s;switch(n=0,s&&(h=[h[0]&2,s.value]),h[0]){case 0:case 1:s=h;break;case 4:return e.label++,{value:h[1],done:!1};case 5:e.label++,n=h[1],h=[0];continue;case 7:h=e.ops.pop(),e.trys.pop();continue;default:if(s=e.trys,!(s=s.length>0&&s[s.length-1])&&(h[0]===6||h[0]===2)){e=0;continue}if(h[0]===3&&(!s||h[1]>s[0]&&h[1]<s[3])){e.label=h[1];break}if(h[0]===6&&e.label<s[1]){e.label=s[1],s=h;break}if(s&&e.label<s[2]){e.label=s[2],e.ops.push(h);break}s[2]&&e.ops.pop(),e.trys.pop();continue}h=t.call(r,e)}catch(d){h=[6,d],n=0}finally{i=s=0}if(h[0]&5)throw h[1];return{value:h[0]?h[1]:void 0,done:!0}}}var vh=Object.create?function(r,t,e,i){i===void 0&&(i=e);var n=Object.getOwnPropertyDescriptor(t,e);(!n||("get"in n?!t.__esModule:n.writable||n.configurable))&&(n={enumerable:!0,get:function(){return t[e]}}),Object.defineProperty(r,i,n)}:function(r,t,e,i){i===void 0&&(i=e),r[i]=t[e]};function j_(r,t){for(var e in r)e!=="default"&&!Object.prototype.hasOwnProperty.call(t,e)&&vh(t,r,e)}function bh(r){var t=typeof Symbol=="function"&&Symbol.iterator,e=t&&r[t],i=0;if(e)return e.call(r);if(r&&typeof r.length=="number")return{next:function(){return r&&i>=r.length&&(r=void 0),{value:r&&r[i++],done:!r}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function Uu(r,t){var e=typeof Symbol=="function"&&r[Symbol.iterator];if(!e)return r;var i=e.call(r),n,s=[],a;try{for(;(t===void 0||t-- >0)&&!(n=i.next()).done;)s.push(n.value)}catch(l){a={error:l}}finally{try{n&&!n.done&&(e=i.return)&&e.call(i)}finally{if(a)throw a.error}}return s}function X_(){for(var r=[],t=0;t<arguments.length;t++)r=r.concat(Uu(arguments[t]));return r}function q_(){for(var r=0,t=0,e=arguments.length;t<e;t++)r+=arguments[t].length;for(var i=Array(r),n=0,t=0;t<e;t++)for(var s=arguments[t],a=0,l=s.length;a<l;a++,n++)i[n]=s[a];return i}function Y_(r,t,e){if(e||arguments.length===2)for(var i=0,n=t.length,s;i<n;i++)(s||!(i in t))&&(s||(s=Array.prototype.slice.call(t,0,i)),s[i]=t[i]);return r.concat(s||Array.prototype.slice.call(t))}function Sa(r){return this instanceof Sa?(this.v=r,this):new Sa(r)}function Q_(r,t,e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var i=e.apply(r,t||[]),n,s=[];return n={},a("next"),a("throw"),a("return"),n[Symbol.asyncIterator]=function(){return this},n;function a(f){i[f]&&(n[f]=function(p){return new Promise(function(m,b){s.push([f,p,m,b])>1||l(f,p)})})}function l(f,p){try{c(i[f](p))}catch(m){u(s[0][3],m)}}function c(f){f.value instanceof Sa?Promise.resolve(f.value.v).then(h,d):u(s[0][2],f)}function h(f){l("next",f)}function d(f){l("throw",f)}function u(f,p){f(p),s.shift(),s.length&&l(s[0][0],s[0][1])}}function K_(r){var t,e;return t={},i("next"),i("throw",function(n){throw n}),i("return"),t[Symbol.iterator]=function(){return this},t;function i(n,s){t[n]=r[n]?function(a){return(e=!e)?{value:Sa(r[n](a)),done:!1}:s?s(a):a}:s}}function $_(r){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t=r[Symbol.asyncIterator],e;return t?t.call(r):(r=typeof bh=="function"?bh(r):r[Symbol.iterator](),e={},i("next"),i("throw"),i("return"),e[Symbol.asyncIterator]=function(){return this},e);function i(s){e[s]=r[s]&&function(a){return new Promise(function(l,c){a=r[s](a),n(l,c,a.done,a.value)})}}function n(s,a,l,c){Promise.resolve(c).then(function(h){s({value:h,done:l})},a)}}function Z_(r,t){return Object.defineProperty?Object.defineProperty(r,"raw",{value:t}):r.raw=t,r}var gT=Object.create?function(r,t){Object.defineProperty(r,"default",{enumerable:!0,value:t})}:function(r,t){r.default=t};function J_(r){if(r&&r.__esModule)return r;var t={};if(r!=null)for(var e in r)e!=="default"&&Object.prototype.hasOwnProperty.call(r,e)&&vh(t,r,e);return gT(t,r),t}function eg(r){return r&&r.__esModule?r:{default:r}}function tg(r,t,e,i){if(e==="a"&&!i)throw new TypeError("Private accessor was defined without a getter");if(typeof t=="function"?r!==t||!i:!t.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return e==="m"?i:e==="a"?i.call(r):i?i.value:t.get(r)}function ig(r,t,e,i,n){if(i==="m")throw new TypeError("Private method is not writable");if(i==="a"&&!n)throw new TypeError("Private accessor was defined without a setter");if(typeof t=="function"?r!==t||!n:!t.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return i==="a"?n.call(r,e):n?n.value=e:t.set(r,e),e}function ng(r,t){if(t===null||typeof t!="object"&&typeof t!="function")throw new TypeError("Cannot use 'in' operator on non-object");return typeof r=="function"?t===r:r.has(t)}function sg(r,t,e){if(t!=null){if(typeof t!="object"&&typeof t!="function")throw new TypeError("Object expected.");var i;if(e){if(!Symbol.asyncDispose)throw new TypeError("Symbol.asyncDispose is not defined.");i=t[Symbol.asyncDispose]}if(i===void 0){if(!Symbol.dispose)throw new TypeError("Symbol.dispose is not defined.");i=t[Symbol.dispose]}if(typeof i!="function")throw new TypeError("Object not disposable.");r.stack.push({value:t,dispose:i,async:e})}else e&&r.stack.push({async:!0});return t}var vT=typeof SuppressedError=="function"?SuppressedError:function(r,t,e){var i=new Error(e);return i.name="SuppressedError",i.error=r,i.suppressed=t,i};function rg(r){function t(i){r.error=r.hasError?new vT(i,r.error,"An error was suppressed during disposal."):i,r.hasError=!0}function e(){for(;r.stack.length;){var i=r.stack.pop();try{var n=i.dispose&&i.dispose.call(i.value);if(i.async)return Promise.resolve(n).then(e,function(s){return t(s),e()})}catch(s){t(s)}}if(r.hasError)throw r.error}return e()}const eo=uT(Object.freeze(Object.defineProperty({__proto__:null,__addDisposableResource:sg,get __assign(){return gh},__asyncDelegator:K_,__asyncGenerator:Q_,__asyncValues:$_,__await:Sa,__awaiter:H_,__classPrivateFieldGet:tg,__classPrivateFieldIn:ng,__classPrivateFieldSet:ig,__createBinding:vh,__decorate:V_,__disposeResources:rg,__esDecorate:fT,__exportStar:j_,__extends:U_,__generator:W_,__importDefault:eg,__importStar:J_,__makeTemplateObject:Z_,__metadata:G_,__param:z_,__propKey:mT,__read:Uu,__rest:k_,__runInitializers:pT,__setFunctionName:_T,__spread:X_,__spreadArray:Y_,__spreadArrays:q_,__values:bh,default:{__extends:U_,__assign:gh,__rest:k_,__decorate:V_,__param:z_,__metadata:G_,__awaiter:H_,__generator:W_,__createBinding:vh,__exportStar:j_,__values:bh,__read:Uu,__spread:X_,__spreadArrays:q_,__spreadArray:Y_,__await:Sa,__asyncGenerator:Q_,__asyncDelegator:K_,__asyncValues:$_,__makeTemplateObject:Z_,__importStar:J_,__importDefault:eg,__classPrivateFieldGet:tg,__classPrivateFieldSet:ig,__classPrivateFieldIn:ng,__addDisposableResource:sg,__disposeResources:rg}},Symbol.toStringTag,{value:"Module"})));var ku={},og;function bT(){return og||(og=1,Object.defineProperty(ku,"__esModule",{value:!0})),ku}var yl={},ag;function yh(){if(ag)return yl;ag=1,Object.defineProperty(yl,"__esModule",{value:!0}),yl.Signal=void 0;var r=eo,t=function(){function i(){this.handlers=[]}return Object.defineProperty(i.prototype,"hasHandlers",{get:function(){return this.handlers.length>0},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"handlersAmount",{get:function(){return this.handlers.length},enumerable:!1,configurable:!0}),i.prototype.connect=function(n,s){s===void 0&&(s=0);var a=this.handlers.find(function(h){return h.equals(n)}),l;if(a!==void 0)l=a.priority!==s,a.priority=s;else{var c=this.handlers[this.handlers.length-1];this.handlers.push(new e(n,s)),l=c!==void 0&&c.priority>s}l&&this.handlers.sort(function(h,d){return h.priority-d.priority})},i.prototype.disconnect=function(n){var s=this.handlers.findIndex(function(a){return a.equals(n)});s>=0&&this.handlers.splice(s,1)},i.prototype.disconnectAll=function(){this.handlers.length=0},i.prototype.emit=function(){for(var n,s,a=[],l=0;l<arguments.length;l++)a[l]=arguments[l];try{for(var c=r.__values(this.handlers),h=c.next();!h.done;h=c.next()){var d=h.value;d.handle.apply(d,r.__spreadArray([],r.__read(a),!1))}}catch(u){n={error:u}}finally{try{h&&!h.done&&(s=c.return)&&s.call(c)}finally{if(n)throw n.error}}},i}();yl.Signal=t;var e=function(){function i(n,s){this.handler=n,this.priority=s}return i.prototype.equals=function(n){return this.handler===n},i.prototype.handle=function(){for(var n=[],s=0;s<arguments.length;s++)n[s]=arguments[s];this.handler.apply(this,r.__spreadArray([],r.__read(n),!1))},i}();return yl}var Vo={},lg;function Vu(){if(lg)return Vo;lg=1,Object.defineProperty(Vo,"__esModule",{value:!0}),Vo.getComponentClass=Vo.getComponentId=void 0;function r(n,s){if(s===void 0&&(s=!1),n.hasOwnProperty(e))return n[e];if(s)return n[e]=i++}Vo.getComponentId=r;function t(n,s){var a=Object.getPrototypeOf(n).constructor;if(s){if(!(n instanceof s||a===s))throw new Error("Resolve class should be an ancestor of component class");a=s}return a}Vo.getComponentClass=t;var e="__componentClassId__",i=1;return Vo}var xl={},cg;function zu(){if(cg)return xl;cg=1,Object.defineProperty(xl,"__esModule",{value:!0}),xl.isTag=void 0;function r(t){var e=typeof t;return e==="string"||e==="number"}return xl.isTag=r,xl}var zo={},hg;function Gu(){if(hg)return zo;hg=1,Object.defineProperty(zo,"__esModule",{value:!0}),zo.isLinkedComponent=zo.LinkedComponent=void 0;var r=function(){function e(i){this.id=i,this.next=void 0}return e}();zo.LinkedComponent=r;function t(e){return e!==void 0&&e.hasOwnProperty("next")}return zo.isLinkedComponent=t,zo}var El={},Go={},Al={},dg;function yT(){if(dg)return Al;dg=1,Object.defineProperty(Al,"__esModule",{value:!0}),Al.LinkedComponentList=void 0;var r=eo,t=function(){function e(){}return Object.defineProperty(e.prototype,"head",{get:function(){return this._head},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isEmpty",{get:function(){return this._head===void 0},enumerable:!1,configurable:!0}),e.prototype.add=function(i){for(var n=void 0,s=this._head;s!==void 0;){if(s===i)throw new Error("Component is already appended, appending it once again will break linked items order");n=s,s=s.next}this._head===void 0?this._head=i:n.next=i},e.prototype.remove=function(i){var n=r.__read(this.find(i),2),s=n[0],a=n[1];return a===void 0?!1:(s===void 0?this._head=a.next:s.next=a.next,!0)},e.prototype.nodes=function(){var i;return r.__generator(this,function(n){switch(n.label){case 0:i=this.head,n.label=1;case 1:return i===void 0?[3,3]:[4,i];case 2:return n.sent(),i=i.next,[3,1];case 3:return[2]}})},e.prototype.iterate=function(i){var n,s;try{for(var a=r.__values(this.nodes()),l=a.next();!l.done;l=a.next()){var c=l.value;i(c)}}catch(h){n={error:h}}finally{try{l&&!l.done&&(s=a.return)&&s.call(a)}finally{if(n)throw n.error}}},e.prototype.clear=function(){this._head=void 0},e.prototype.find=function(i){for(var n,s=this._head;s!==void 0;){if(s===i)return[n,s];n=s,s=s.next}return[void 0,void 0]},e}();return Al.LinkedComponentList=t,Al}var ug;function Hu(){if(ug)return Go;ug=1,Object.defineProperty(Go,"__esModule",{value:!0}),Go.EntitySnapshot=Go.Entity=void 0;var r=eo,t=Vu(),e=yh(),i=zu(),n=Gu(),s=yT(),a=function(){function h(){this.onComponentAdded=new e.Signal,this.onComponentRemoved=new e.Signal,this.onInvalidationRequested=new e.Signal,this.id=c++,this._components={},this._linkedComponents={},this._tags=new Set}return Object.defineProperty(h.prototype,"components",{get:function(){return this._components},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"tags",{get:function(){return this._tags},enumerable:!1,configurable:!0}),h.prototype.add=function(d,u){return(0,i.isTag)(d)?this.addTag(d):this.addComponent(d,u),this},h.prototype.append=function(d,u){return this.appendComponent(d,u)},h.prototype.withdraw=function(d){var u=this.get(d);if(u!==void 0)return(0,n.isLinkedComponent)(u)?this.withdrawComponent(u,d):this.remove(d)},h.prototype.pick=function(d,u){if(typeof u=="string"){var f=this.find(d,function(p){return(0,n.isLinkedComponent)(p)&&p.id===u});return(0,n.isLinkedComponent)(f)?this.withdrawComponent(f,d):void 0}return(0,n.isLinkedComponent)(d)?this.withdrawComponent(d,u):this.remove(u!=null?u:(0,t.getComponentClass)(d))},h.prototype.addComponent=function(d,u){var f=(0,t.getComponentClass)(d,u),p=(0,t.getComponentId)(f,!0),m=(0,n.isLinkedComponent)(d);if(this._components[p]!==void 0){if(!m&&d===this._components[p])return;this.remove(f)}m?this.append(d,u):(this._components[p]=d,this.dispatchOnComponentAdded(d))},h.prototype.appendComponent=function(d,u){var f=(0,t.getComponentClass)(d,u),p=(0,t.getComponentId)(f,!0),m=this.getLinkedComponentList(p);return m.add(d),this._components[p]===void 0&&(this._components[p]=m.head),this.dispatchOnComponentAdded(d),this},h.prototype.addTag=function(d){this._tags.has(d)||(this._tags.add(d),this.dispatchOnComponentAdded(d))},h.prototype.has=function(d,u){return(0,i.isTag)(d)?this.hasTag(d):this.hasComponent(d,u)},h.prototype.contains=function(d,u){var f=(0,t.getComponentClass)(d,u);return(0,n.isLinkedComponent)(d)?this.find(f,function(p){return p===d})!==void 0:this.get(f)===d},h.prototype.hasComponent=function(d,u){return this.get(d,u)!==void 0},h.prototype.hasTag=function(d){return this._tags.has(d)},h.prototype.hasAny=function(){for(var d=this,u=[],f=0;f<arguments.length;f++)u[f]=arguments[f];return u.some(function(p){return d.has(p)})},h.prototype.hasAll=function(){for(var d=this,u=[],f=0;f<arguments.length;f++)u[f]=arguments[f];return u.every(function(p){return d.has(p)})},h.prototype.get=function(d,u){var f=(0,t.getComponentId)(d);if(f!==void 0){var p=this._components[f];if(u!==void 0){if((0,n.isLinkedComponent)(p))for(;p!==void 0;){if(p.id===u)return p;p=p.next}return}return this._components[f]}},h.prototype.getComponents=function(){return Array.from(Object.values(this._components))},h.prototype.getTags=function(){return Array.from(this._tags)},h.prototype.remove=function(d){if((0,i.isTag)(d)){this.removeTag(d);return}return this.removeComponent(d)},h.prototype.removeComponent=function(d){var u=(0,t.getComponentId)(d);if(!(u===void 0||this._components[u]===void 0)){var f=this._components[u];if((0,n.isLinkedComponent)(f))for(var p=this.getLinkedComponentList(d);!p.isEmpty;)this.withdraw(d);else delete this._components[u],this.dispatchOnComponentRemoved(f);return f}},h.prototype.removeTag=function(d){this._tags.has(d)&&(this._tags.delete(d),this.dispatchOnComponentRemoved(d))},h.prototype.clear=function(){this._components={},this._linkedComponents={},this._tags.clear()},h.prototype.copyFrom=function(d){return this._components=Object.assign({},d._components),this._linkedComponents=Object.assign({},d._linkedComponents),this._tags=new Set(d._tags),this},h.prototype.iterate=function(d,u){var f;this.hasComponent(d)&&((f=this.getLinkedComponentList(d))===null||f===void 0||f.iterate(u))},h.prototype.getAll=function(d){var u;return r.__generator(this,function(f){switch(f.label){case 0:return this.hasComponent(d)?(u=this.getLinkedComponentList(d,!1),u===void 0?[2,void 0]:[5,r.__values(u.nodes())]):[2];case 1:return f.sent(),[2]}})},h.prototype.find=function(d,u){var f=(0,t.getComponentId)(d,!1);if(f!==void 0){var p=this._components[f];if(p!==void 0)if((0,n.isLinkedComponent)(p))for(var m=p;m!==void 0;){if(u(m))return m;m=m.next}else return u(p)?p:void 0}},h.prototype.lengthOf=function(d){var u=0;return this.iterate(d,function(){u++}),u},h.prototype.invalidate=function(){this.onInvalidationRequested.emit(this)},h.prototype.takeSnapshot=function(d,u,f){var p=d.previous;if(d.current!==this&&(d.current=this,p.copyFrom(this)),u!==void 0)if((0,i.isTag)(u)){var m=p._tags;this.has(u)?m.delete(u):m.add(u)}else{var b=f!=null?f:Object.getPrototypeOf(u).constructor,g=(0,t.getComponentId)(b,!0),x=p._components;this.has(b)?delete x[g]:x[g]=u}},h.prototype.getLinkedComponentList=function(d,u){return u===void 0&&(u=!0),typeof d!="number"&&(d=(0,t.getComponentId)(d)),this._linkedComponents[d]!==void 0||!u?this._linkedComponents[d]:this._linkedComponents[d]=new s.LinkedComponentList},h.prototype.withdrawComponent=function(d,u){var f=(0,t.getComponentClass)(d,u),p=this.getLinkedComponentList(f,!1);if(!(!this.hasComponent(f)||p===void 0)){var m=p.remove(d)?d:void 0,b=(0,t.getComponentId)(f,!0);return p.isEmpty?(delete this._components[b],delete this._linkedComponents[b]):this._components[b]=p.head,m!==void 0&&this.dispatchOnComponentRemoved(m),m}},h.prototype.dispatchOnComponentAdded=function(d){this.onComponentAdded.hasHandlers&&this.onComponentAdded.emit(this,d)},h.prototype.dispatchOnComponentRemoved=function(d){this.onComponentRemoved.hasHandlers&&this.onComponentRemoved.emit(this,d)},h}();Go.Entity=a;var l=function(){function h(){this._previous=new a}return Object.defineProperty(h.prototype,"current",{get:function(){return this._current},set:function(d){this._current=d},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"previous",{get:function(){return this._previous},enumerable:!1,configurable:!0}),h}();Go.EntitySnapshot=l;var c=1;return Go}var Tl={},fg;function xT(){if(fg)return Tl;fg=1,Object.defineProperty(Tl,"__esModule",{value:!0}),Tl.Subscription=void 0;var r=function(){function t(e,i){this.messageType=e,this.handler=i}return t.prototype.equals=function(e,i){return this.messageType===e&&(i===void 0||this.handler===i)},t}();return Tl.Subscription=r,Tl}var pg;function ET(){if(pg)return El;pg=1,Object.defineProperty(El,"__esModule",{value:!0}),El.Engine=void 0;var r=eo,t=Hu(),e=xT(),i=yh(),n=function(){function s(){var a=this;this.onEntityAdded=new i.Signal,this.onEntityRemoved=new i.Signal,this._entityMap=new Map,this._entities=[],this._systems=[],this._queries=[],this._subscriptions=[],this._sharedConfig=new t.Entity,this.onComponentAdded=function(l,c,h){a._queries.forEach(function(d){return d.entityComponentAdded(l,c,h)})},this.onInvalidationRequested=function(l){a._queries.forEach(function(c){return c.validateEntity(l)})},this.onComponentRemoved=function(l,c,h){a._queries.forEach(function(d){return d.entityComponentRemoved(l,c,h)})},this.connectEntity(this._sharedConfig)}return Object.defineProperty(s.prototype,"entities",{get:function(){return Array.from(this._entities)},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"systems",{get:function(){return this._systems},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"queries",{get:function(){return this._queries},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"subscriptions",{get:function(){return this._subscriptions},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"sharedConfig",{get:function(){return this._sharedConfig},enumerable:!1,configurable:!0}),s.prototype.addEntity=function(a){return this._entityMap.has(a.id)?this:(this._entities.push(a),this._entityMap.set(a.id,a),this.onEntityAdded.emit(a),this.connectEntity(a),this)},s.prototype.removeEntity=function(a){if(!this._entityMap.has(a.id))return this;var l=this._entities.indexOf(a);return this._entities.splice(l,1),this._entityMap.delete(a.id),this.onEntityRemoved.emit(a),this.disconnectEntity(a),this},s.prototype.removeSystem=function(a){var l=this._systems.indexOf(a);return l===-1?this:(this._systems.splice(l,1),a.onRemovedFromEngine(),a.setEngine(void 0),this)},s.prototype.getEntityById=function(a){return this._entityMap.get(a)},s.prototype.getSystem=function(a){return this._systems.find(function(l){return l instanceof a})},s.prototype.removeAllSystems=function(){var a,l,c=this._systems;this._systems=[];try{for(var h=r.__values(c),d=h.next();!d.done;d=h.next()){var u=d.value;u.onRemovedFromEngine()}}catch(f){a={error:f}}finally{try{d&&!d.done&&(l=h.return)&&l.call(h)}finally{if(a)throw a.error}}},s.prototype.removeAllQueries=function(){var a,l,c=this._queries;this._queries=[];try{for(var h=r.__values(c),d=h.next();!d.done;d=h.next()){var u=d.value;this.disconnectQuery(u),u.clear()}}catch(f){a={error:f}}finally{try{d&&!d.done&&(l=h.return)&&l.call(h)}finally{if(a)throw a.error}}},s.prototype.removeAllEntities=function(){this.removeAllEntitiesInternal(!1)},s.prototype.clear=function(){this.removeAllEntitiesInternal(!0),this.removeAllSystems(),this.removeAllQueries()},s.prototype.update=function(a){var l,c;try{for(var h=r.__values(this._systems),d=h.next();!d.done;d=h.next()){var u=d.value;u.update(a),u.isRemovalRequested&&this.removeSystem(u)}}catch(f){l={error:f}}finally{try{d&&!d.done&&(c=h.return)&&c.call(h)}finally{if(l)throw l.error}}},s.prototype.addQuery=function(a){return this.connectQuery(a),a.matchEntities(this.entities),this._queries[this._queries.length]=a,this},s.prototype.addSystem=function(a,l){if(l===void 0&&(l=0),a.setPriority(l),this._systems.length===0)this._systems[0]=a;else{var c=this._systems.findIndex(function(h){return h.priority>l});c===-1?this._systems[this._systems.length]=a:this._systems.splice(c,0,a)}return a.setEngine(this),a.onAddedToEngine(),this},s.prototype.removeQuery=function(a){var l=this._queries.indexOf(a);if(l!=-1)return this._queries.splice(l,1),this.disconnectQuery(a),a.clear(),this},s.prototype.subscribe=function(a,l){this.addSubscription(a,l)},s.prototype.unsubscribe=function(a,l){this.removeSubscription(a,l)},s.prototype.unsubscribeAll=function(){this._subscriptions.length=0},s.prototype.addSubscription=function(a,l){var c,h;try{for(var d=r.__values(this._subscriptions),u=d.next();!u.done;u=d.next()){var f=u.value;if(f.equals(a,l))return f}}catch(m){c={error:m}}finally{try{u&&!u.done&&(h=d.return)&&h.call(d)}finally{if(c)throw c.error}}var p=new e.Subscription(a,l);return this._subscriptions.push(p),p},s.prototype.removeSubscription=function(a,l){for(var c=this._subscriptions.length;--c>=0;){var h=this._subscriptions[c];if(h.equals(a,l)&&(this._subscriptions.splice(c,1),l!==void 0))return}},s.prototype.dispatch=function(a){var l,c;try{for(var h=r.__values(this._subscriptions),d=h.next();!d.done;d=h.next()){var u=d.value;(typeof u.messageType=="function"&&a instanceof u.messageType||a===u.messageType)&&u.handler(a)}}catch(f){l={error:f}}finally{try{d&&!d.done&&(c=h.return)&&c.call(h)}finally{if(l)throw l.error}}},s.prototype.connectEntity=function(a){a.onComponentAdded.connect(this.onComponentAdded,Number.POSITIVE_INFINITY),a.onComponentRemoved.connect(this.onComponentRemoved,Number.POSITIVE_INFINITY),a.onInvalidationRequested.connect(this.onInvalidationRequested,Number.NEGATIVE_INFINITY)},s.prototype.disconnectEntity=function(a){a.onComponentAdded.disconnect(this.onComponentAdded),a.onComponentRemoved.disconnect(this.onComponentRemoved),a.onInvalidationRequested.disconnect(this.onInvalidationRequested)},s.prototype.connectQuery=function(a){this.onEntityAdded.connect(a.entityAdded),this.onEntityRemoved.connect(a.entityRemoved)},s.prototype.disconnectQuery=function(a){this.onEntityAdded.disconnect(a.entityAdded),this.onEntityRemoved.disconnect(a.entityRemoved)},s.prototype.removeAllEntitiesInternal=function(a){var l,c,h=this._entities;this._entities=[],this._entityMap.clear();try{for(var d=r.__values(h),u=d.next();!u.done;u=d.next()){var f=u.value;a||this.onEntityRemoved.emit(f),this.disconnectEntity(f)}}catch(p){l={error:p}}finally{try{u&&!u.done&&(c=d.return)&&c.call(d)}finally{if(l)throw l.error}}},s}();return El.Engine=n,El}var wl={},mg;function _g(){if(mg)return wl;mg=1,Object.defineProperty(wl,"__esModule",{value:!0}),wl.System=void 0;var r=function(){function t(){this._priority=0,this._isRemovalRequested=!1}return Object.defineProperty(t.prototype,"engine",{get:function(){if(this._engine===void 0)throw new Error(`Property "engine" can't be accessed when system is not added to the engine`);return this._engine},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isRemovalRequested",{get:function(){return this._isRemovalRequested},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"sharedConfig",{get:function(){if(this._engine===void 0)throw new Error(`Property "sharedConfig" can't be accessed when system is not added to the engine`);return this._engine.sharedConfig},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"priority",{get:function(){return this._priority},enumerable:!1,configurable:!0}),t.prototype.update=function(e){},t.prototype.onAddedToEngine=function(){},t.prototype.onRemovedFromEngine=function(){},t.prototype.dispatch=function(e){if(this._engine===void 0)throw new Error("Dispatching a message can't be done while system is not attached to the engine");this.engine.dispatch(e)},t.prototype.setEngine=function(e){this._engine=e},t.prototype.setPriority=function(e){this._priority=e},t.prototype.requestRemoval=function(){this._isRemovalRequested=!0},t}();return wl.System=r,wl}var Ms={},gg;function vg(){if(gg)return Ms;gg=1,Object.defineProperty(Ms,"__esModule",{value:!0}),Ms.isQueryBuilder=Ms.isQueryPredicate=Ms.QueryBuilder=Ms.Query=void 0;var r=eo,t=Vu(),e=Hu(),i=zu(),n=yh(),s=Gu(),a=function(){function u(f){var p=this;this.onEntityAdded=new n.Signal,this.onEntityRemoved=new n.Signal,this._helper=new e.Entity,this._snapshot=new e.EntitySnapshot,this._entities=[],this.entityAdded=function(m){var b=p._entities.indexOf(m);b===-1&&p._predicate(m)&&(p._entities.push(m),p.onEntityAdded.hasHandlers&&(m.takeSnapshot(p._snapshot),p.onEntityAdded.emit(p._snapshot)))},this.entityRemoved=function(m){var b=p._entities.indexOf(m);b!==-1&&(p._entities.splice(b,1),p.onEntityRemoved.hasHandlers&&(m.takeSnapshot(p._snapshot),p.onEntityRemoved.emit(p._snapshot)))},this.entityComponentAdded=function(m,b,g){var x=p.onEntityAdded.hasHandlers,w=p.onEntityRemoved.hasHandlers;p.updateHelper(m,b,g);var C=p._entities.indexOf(m),M=p._predicate(p._helper);C===-1&&M?(p._entities.push(m),x&&(m.takeSnapshot(p._snapshot,b,g),p.onEntityAdded.emit(p._snapshot))):C!==-1&&!M&&(p._entities.splice(C,1),w&&(m.takeSnapshot(p._snapshot,b,g),p.onEntityRemoved.emit(p._snapshot)))},this.entityComponentRemoved=function(m,b,g){var x=p.onEntityAdded.hasHandlers,w=p.onEntityRemoved.hasHandlers;p.updateHelper(m,b,g);var C=p._entities.indexOf(m);C!==-1&&p._predicate(p._helper)&&!p._predicate(m)?(p._entities.splice(C,1),w&&(m.takeSnapshot(p._snapshot,b,g),p.onEntityRemoved.emit(p._snapshot))):C===-1&&p._predicate(m)&&!p._predicate(p._helper)&&(p._entities.push(m),x&&(m.takeSnapshot(p._snapshot,b,g),p.onEntityAdded.emit(p._snapshot)))},this._predicate=f}return Object.defineProperty(u.prototype,"entities",{get:function(){return this._entities},enumerable:!1,configurable:!0}),Object.defineProperty(u.prototype,"first",{get:function(){if(this._entities.length!==0)return this._entities[0]},enumerable:!1,configurable:!0}),Object.defineProperty(u.prototype,"last",{get:function(){if(this._entities.length!==0)return this._entities[this._entities.length-1]},enumerable:!1,configurable:!0}),Object.defineProperty(u.prototype,"length",{get:function(){return this._entities.length},enumerable:!1,configurable:!0}),u.prototype.countBy=function(f){var p,m,b=0;try{for(var g=r.__values(this._entities),x=g.next();!x.done;x=g.next()){var w=x.value;f(w)&&b++}}catch(C){p={error:C}}finally{try{x&&!x.done&&(m=g.return)&&m.call(g)}finally{if(p)throw p.error}}return b},u.prototype.find=function(f){return this._entities.find(f)},u.prototype.filter=function(f){return this._entities.filter(f)},u.prototype.has=function(f){return this._entities.indexOf(f)!==-1},u.prototype.matchEntities=function(f){var p=this;f.forEach(function(m){return p.entityAdded(m)})},Object.defineProperty(u.prototype,"isEmpty",{get:function(){return this.entities.length==0},enumerable:!1,configurable:!0}),u.prototype.clear=function(){this._entities=[]},u.prototype.validateEntity=function(f){var p=this.entities.indexOf(f),m=this._predicate(f);p!==-1&&!m?this.entityRemoved(f):this.entityAdded(f)},u.prototype.updateHelper=function(f,p,m){this._helper.clear(),this._helper.copyFrom(f),(0,s.isLinkedComponent)(p)?this._helper.has((0,t.getComponentClass)(p,m))||this._helper.append(p):this._helper.add(p)},u}();Ms.Query=a;function l(u,f,p){var m,b,g,x;if(f.size>0)try{for(var w=r.__values(f),C=w.next();!C.done;C=w.next()){var M=C.value;if(u.components[M]===void 0)return!1}}catch($){m={error:$}}finally{try{C&&!C.done&&(b=w.return)&&b.call(w)}finally{if(m)throw m.error}}if(p.size>0)try{for(var D=r.__values(p),W=D.next();!W.done;W=D.next()){var z=W.value;if(!u.tags.has(z))return!1}}catch($){g={error:$}}finally{try{W&&!W.done&&(x=D.return)&&x.call(D)}finally{if(g)throw g.error}}return!0}var c=function(){function u(){this._components=new Set,this._tags=new Set}return u.prototype.contains=function(){for(var f,p,m=[],b=0;b<arguments.length;b++)m[b]=arguments[b];try{for(var g=r.__values(m),x=g.next();!x.done;x=g.next()){var w=x.value;if((0,i.isTag)(w))this._tags.has(w)||this._tags.add(w);else{var C=(0,t.getComponentId)(w,!0);this._components.has(C)||this._components.add(C)}}}catch(M){f={error:M}}finally{try{x&&!x.done&&(p=g.return)&&p.call(g)}finally{if(f)throw f.error}}return this},u.prototype.build=function(){var f=this;return new a(function(p){return l(p,f._components,f._tags)})},u.prototype.getComponents=function(){return this._components},u.prototype.getTags=function(){return this._tags},u}();Ms.QueryBuilder=c;function h(u){return typeof u=="function"}Ms.isQueryPredicate=h;function d(u){return u instanceof c}return Ms.isQueryBuilder=d,Ms}var Sl={},Ml={},bg;function yg(){if(bg)return Ml;bg=1,Object.defineProperty(Ml,"__esModule",{value:!0}),Ml.ReactionSystem=void 0;var r=eo,t=vg(),e=_g(),i=function(n){r.__extends(s,n);function s(a){var l=n.call(this)||this;return l.entityAdded=function(c){},l.entityRemoved=function(c){},(0,t.isQueryBuilder)(a)?l.query=a.build():(0,t.isQueryPredicate)(a)?l.query=new t.Query(a):l.query=a,l}return Object.defineProperty(s.prototype,"entities",{get:function(){return this.query.entities},enumerable:!1,configurable:!0}),s.prototype.onAddedToEngine=function(){this.engine.addQuery(this.query),this.prepare(),this.query.onEntityAdded.connect(this.entityAdded),this.query.onEntityRemoved.connect(this.entityRemoved)},s.prototype.onRemovedFromEngine=function(){this.engine.removeQuery(this.query),this.query.onEntityAdded.disconnect(this.entityAdded),this.query.onEntityRemoved.disconnect(this.entityRemoved),this.query.clear()},s.prototype.prepare=function(){},s}(e.System);return Ml.ReactionSystem=i,Ml}var xg;function AT(){if(xg)return Sl;xg=1,Object.defineProperty(Sl,"__esModule",{value:!0}),Sl.IterativeSystem=void 0;var r=eo,t=yg(),e=function(i){r.__extends(n,i);function n(s){var a=i.call(this,s)||this;return a._removed=!1,a}return n.prototype.update=function(s){this.updateEntities(s)},n.prototype.onAddedToEngine=function(){this._removed=!1,i.prototype.onAddedToEngine.call(this)},n.prototype.onRemovedFromEngine=function(){this._removed=!0,i.prototype.onRemovedFromEngine.call(this)},n.prototype.updateEntities=function(s){var a,l;try{for(var c=r.__values(this.query.entities),h=c.next();!h.done;h=c.next()){var d=h.value;if(this._removed)return;this.updateEntity(d,s)}}catch(u){a={error:u}}finally{try{h&&!h.done&&(l=c.return)&&l.call(c)}finally{if(a)throw a.error}}},n}(t.ReactionSystem);return Sl.IterativeSystem=e,Sl}(function(r){Object.defineProperty(r,"__esModule",{value:!0});var t=eo;t.__exportStar(bT(),r),t.__exportStar(yh(),r),t.__exportStar(Vu(),r),t.__exportStar(zu(),r),t.__exportStar(Gu(),r),t.__exportStar(ET(),r),t.__exportStar(Hu(),r),t.__exportStar(_g(),r),t.__exportStar(vg(),r),t.__exportStar(AT(),r),t.__exportStar(yg(),r)})(Ot);var TT=Object.defineProperty,wT=Object.getOwnPropertyDescriptor,ST=(r,t,e,i)=>{for(var n=i>1?void 0:i?wT(t,e):t,s=r.length-1,a;s>=0;s--)(a=r[s])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&TT(t,e,n),n};class MT{constructor(t){o(this,"_resourceConstructor");this._resourceConstructor=t}getResourceConstructor(){return this._resourceConstructor}}class to extends MT{constructor(e,i){super(e);o(this,"resourcesToDescriptors",new Map);o(this,"descriptorsToResources",new Yp(void 0,gr.compareInstances));o(this,"unusedResources",new Set);o(this,"resourcesEnv");this.resourcesEnv=i,ct.registerIfEnabled(this)}acquireResource(e){const i=this.descriptorsToResources.find(e);if(!i.equals(this.descriptorsToResources.end()))return i.pointer[1];mt.beginSection(this._resourceConstructor.name);const n=new this._resourceConstructor;if(this.resourcesToDescriptors.set(n,e),this.descriptorsToResources.setElement(e,n),n.descriptor=e,this._uploadResource(n))return this.onResourceLoaded(n),mt.endSection(this._resourceConstructor.name),n;mt.endSection(this._resourceConstructor.name)}_uploadResource(e){return e.load(this.resourcesEnv)}_unloadResource(e){e.unload(this.resourcesEnv)}onResourceLoaded(e){}unuseResource(e){e.refCounter,this.unusedResources.add(e)}removeResource(e){e.refCounter;const i=this.resourcesToDescriptors.get(e);this.resourcesToDescriptors.delete(e),this.descriptorsToResources.eraseElementByKey(i),this.unusedResources.delete(e),this._unloadResource(e)}removeAllResources(){for(const e of this.resourcesToDescriptors.keys())this._unloadResource(e),e.refCounter=0;this.resourcesToDescriptors.clear(),this.descriptorsToResources.clear(),this.unusedResources.clear()}updateManager(){this.garbageCollect()}garbageCollect(){this.unusedResources.forEach(e=>{e.refCounter===0&&this.removeResource(e)}),this.unusedResources.clear()}}ST([Vt({name:"Garbage collect"})],to.prototype,"garbageCollect",1);class Eg extends gr{constructor(e,i,n){super();o(this,"lightmap");o(this,"reflectionProbes");o(this,"envMapMirror");!e||e.id,this.lightmap=e,this.reflectionProbes=i?i.filter(s=>s):[],this.envMapMirror=n}compare(e){var a,l,c,h;if(this.lightmap!==e.lightmap){const d=(l=(a=this.lightmap)==null?void 0:a.id)!=null?l:"",u=(h=(c=e.lightmap)==null?void 0:c.id)!=null?h:"",f=d.localeCompare(u);if(f!==0)return f}const i=this.reflectionProbes,n=e.reflectionProbes,s=Gs(i.length,n.length);if(s!==0)return s;for(let d=0;d<i.length;d++)if(i[d].id!==n[d].id)return i[d].id<n[d].id?-1:1;return this.envMapMirror!==e.envMapMirror?this.envMapMirror?-1:1:0}}class PT{constructor(){o(this,"boxMin",new We);o(this,"boxMax",new We);o(this,"posW",new We)}set(t,e,i){this.boxMin.set(t.x,t.y,t.z,0),this.boxMax.set(e.x,e.y,e.z,0),this.posW.set(i.x,i.y,i.z,0)}setZeros(){this.boxMax.set(0,0,0,0),this.boxMin.set(0,0,0,0),this.posW.set(0,0,0,0)}}class CT{constructor(){o(this,"lightmapSize",new We);o(this,"lightmapThreshold",new We);o(this,"reflectionProbes",new Array(T.MAX_BLENDED_REFLECTION_PROBES));o(this,"reflectionProbesCount",new js(0))}}class Ag extends Io{constructor(){super(...arguments);o(this,"uniformBuffer");o(this,"lightmap",new Kt);o(this,"envMaps",new Array);o(this,"textureTable",new fh)}load(e){const i=e.textureManager;this.descriptor.lightmap&&(this.lightmap=e.getResource(i.getDescriptorForTexture(this.descriptor.lightmap)),this.lightmap.get(),void 0),this.uniformBuffer||(this.uniformBuffer=new Ta(e.webGLRenderer.getGl()));const n=e.shaderManager.getLightUniformBlockDescriptor();return this.updateUniformBuffer(e.webGLRenderer.getGl(),n),this.resetTextureResources(e),!0}resetTextureResources(e){this.envMaps=new Array;const i=e.textureManager;for(const u of this.descriptor.reflectionProbes)if(this.descriptor.envMapMirror){const f=u.getMirrorTexture();if(f)if(f instanceof st)this.envMaps.push(e.getResource(i.getDescriptorForTexture(f)));else{f instanceof w_&&f.webglTexture;const p=i.getDescriptorForTexture(f.webglTexture,f.width,f.height);this.envMaps.push(e.getResource(p))}}else{const f=u.getFilteredTexture();f&&this.envMaps.push(e.getResource(i.getDescriptorForTexture(f)))}this.textureTable.clearTable();let n;const s=i.nullTextures.textureTypeToNullTextures;let a=H.TEXTURE_2D,l,c;const h=e.textureManager.samplers.pointSampler,d=this.lightmap.get();d?(c=d.texture,l=e.renderContext.getTextureSampler(d.descriptor.getTextureSamplerDescriptor())):(c=s.get(a),l=h),this.textureTable.setBinding($r.get("lightmap"),a,c,l),a=H.TEXTURE_CUBE_MAP;for(let u=0;u<T.MAX_BLENDED_REFLECTION_PROBES;u++){if(u<this.envMaps.length){const f=this.envMaps[u].get();n=f.texture;const p=f.descriptor;p.textureSource instanceof st?l=e.renderContext.getTextureSampler(p.getTextureSamplerDescriptor()):l=e.textureManager.samplers.linearSampler}else n=s.get(a),l=h;this.textureTable.setBinding($r.get(`envMap[${u}]`),a,n,l)}}updateUniformBuffer(e,i){this.uniformBuffer;const n=new CT;if(this.lightmap.get()){const a=this.lightmap.get().descriptor.textureSource;n.lightmapSize.set(a.width,a.height,1/a.width,1/a.height),n.lightmapThreshold.set(a.ycocgmThreshold,(1-a.ycocgmThreshold)/(16-3),0,0)}else n.lightmapSize.set(0,0,0,0),n.lightmapThreshold.set(0,0,0,0);const s=this.descriptor.reflectionProbes;for(let a=0;a<T.MAX_BLENDED_REFLECTION_PROBES;a++)n.reflectionProbes[a]=new PT,a<s.length&&s[a].isBoundingBoxEnabled()?n.reflectionProbes[a].set(s[a].boxMin,s[a].boxMax,s[a].position):n.reflectionProbes[a].setZeros();n.reflectionProbesCount.value=s.length,this.uniformBuffer.update(n,i,e)}unload(e){this.uniformBuffer&&this.uniformBuffer.unload(e.webGLRenderer.getGl()),this.lightmap.set(void 0,e);for(const i of this.envMaps)i.set(void 0,e);this.textureTable.clearTable()}}class RT extends to{constructor(t){super(Ag,t)}refreshReflectionProbeTextures(){for(const t of this.resourcesToDescriptors.keys())t.resetTextureResources(this.resourcesEnv)}onTextureUploaded(t,e){for(const[i,n]of this.resourcesToDescriptors)n.lightmap===t&&i.updateUniformBuffer(e.webGLRenderer.getGl(),e.shaderManager.getLightUniformBlockDescriptor())}}var IT=Object.defineProperty,DT=Object.getOwnPropertyDescriptor,Tg=(r,t,e,i)=>{for(var n=i>1?void 0:i?DT(t,e):t,s=r.length-1,a;s>=0;s--)(a=r[s])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&IT(t,e,n),n};class Wu extends to{constructor(e){super(_h,e);o(this,"materialsToUpdate",new Set);o(this,"materialsToRecompile",new Set);o(this,"registeredBaseMaterials",new Set);o(this,"updateShaderForMaterial",e=>{this._addRenderMaterialsForBaseMaterial(e.target,this.materialsToRecompile)});o(this,"onMaterialDisposed",e=>{const i=e.target;this.registeredBaseMaterials.delete(i),i.removeEventListener(bt.eventType.DISPOSED,this.onMaterialDisposed),i.removeEventListener(bt.eventType.RECOMPILE_NEEDED,this.updateShaderForMaterial),i.removeEventListener(bt.eventType.MATERIAL_UPDATED,this.onMaterialUpdated)});o(this,"onMaterialUpdated",e=>{this._addRenderMaterialsForBaseMaterial(e.target,this.materialsToUpdate)})}_uploadResource(e){const i=e.descriptor;return this.registeredBaseMaterials.has(i.material)||(this.registeredBaseMaterials.add(i.material),i.material.addEventListener(bt.eventType.DISPOSED,this.onMaterialDisposed),i.material.addEventListener(bt.eventType.RECOMPILE_NEEDED,this.updateShaderForMaterial),i.material.addEventListener(bt.eventType.MATERIAL_UPDATED,this.onMaterialUpdated)),e.load(this.resourcesEnv)}_addRenderMaterialsForBaseMaterial(e,i){for(const[n,s]of this.descriptorsToResources)n.material===e&&i.add(s)}refreshAllMaterials(){for(const e of this.resourcesToDescriptors.keys())e.descriptor&&(e.unload(this.resourcesEnv),e.load(this.resourcesEnv))}updateManager(){super.updateManager(),this.compileUpdatedShaders(),this.updateMaterials()}compileUpdatedShaders(){for(const e of this.materialsToRecompile)e.unload(this.resourcesEnv),e.load(this.resourcesEnv);this.materialsToRecompile.clear()}updateMaterials(){if(this.materialsToUpdate.size===0)return;const e=Vi[oe.MATERIAL];for(const i of this.materialsToUpdate){const n=i.descriptor.material;if(i.uniformBuffer){const s=this.resourcesEnv.webGLRenderer.getGl(),a=i.shader.get().uniformBlockDescriptors.get(e);i.uniformBuffer.update(n.uniformBufferData,a,s)}i.resetTextureResources(this.resourcesEnv),i.resetPipelineState(this.resourcesEnv)}this.resourcesEnv.onMaterialsUpdated(this.materialsToUpdate),this.materialsToUpdate.clear()}}Tg([Vt()],Wu.prototype,"compileUpdatedShaders",1),Tg([Vt()],Wu.prototype,"updateMaterials",1);class LT extends to{constructor(t){super(B_,t)}_uploadResource(t){return!0}}class OT extends to{constructor(e){super(L_,e);o(this,"globalUniformDescriptor");o(this,"cameraUniformDescriptor");o(this,"lightUniformDescriptor");o(this,"_allUniformDescriptorsInitialized",!1)}getGlobalUniformBlockDescriptor(){return this.globalUniformDescriptor,this.globalUniformDescriptor}getCameraUniformBlockDescriptor(){return this.cameraUniformDescriptor,this.cameraUniformDescriptor}getLightUniformBlockDescriptor(){return this.lightUniformDescriptor,this.lightUniformDescriptor}onResourceLoaded(e){if(this._allUniformDescriptorsInitialized)return;const i=e.uniformBlockDescriptors;this.globalUniformDescriptor||(this.globalUniformDescriptor=i.get(Vi[oe.GLOBAL])),this.cameraUniformDescriptor||(this.cameraUniformDescriptor=i.get(Vi[oe.CAMERA])),this.lightUniformDescriptor||(this.lightUniformDescriptor=i.get(Vi[oe.LIGHT])),this._allUniformDescriptorsInitialized=this.globalUniformDescriptor!==void 0&&this.cameraUniformDescriptor!==void 0&&this.lightUniformDescriptor!==void 0,this._allUniformDescriptorsInitialized&&this.resourcesEnv.resourcesEvents.dispatchEvent({type:Ma.eventType.UNIFORM_DESCRIPTORS_INITIALIZED})}}class FT{constructor(t){o(this,"textureTypeToNullTextures",new Map);this.textureTypeToNullTextures.set(H.TEXTURE_2D,this._create2DTexture(t)),this.textureTypeToNullTextures.set(H.TEXTURE_CUBE_MAP,this._createCubeTexture(t))}_create2DTexture(t){const e=t.createTexture(),i=new Uint8Array(4*4);for(let n=0;n<i.length;n++)i[n]=1;return t.bindTexture(t.TEXTURE_2D,e),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,2,2,0,t.RGBA,t.UNSIGNED_BYTE,i),e}_createCubeTexture(t){const e=t.createTexture(),i=new Uint8Array(4*4);for(let n=0;n<i.length;n++)i[n]=1;t.bindTexture(t.TEXTURE_CUBE_MAP,e);for(let n=0;n<6;n++)t.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+n,0,t.RGBA,2,2,0,t.RGBA,t.UNSIGNED_BYTE,i);return e}}class BT{constructor(t){o(this,"_linearSampler");o(this,"_linearMipSampler");o(this,"_pointSampler");this._linearSampler=t.getTextureSampler(new vl({magFilter:H.LINEAR,minFilter:H.LINEAR})),this._linearMipSampler=t.getTextureSampler(new vl({magFilter:H.LINEAR,minFilter:H.LINEAR_MIPMAP_LINEAR})),this._pointSampler=t.getTextureSampler(new vl({magFilter:H.NEAREST,minFilter:H.NEAREST}))}get linearSampler(){return this._linearSampler}get linearMipSampler(){return this._linearMipSampler}get pointSampler(){return this._pointSampler}}class NT extends to{constructor(e){super(bl,e);o(this,"_textureSourceToResourceDescriptors",new Map);o(this,"_texturesToResources",new Map);o(this,"_videoTextures",new Array);o(this,"_textureIdCounter",1);o(this,"nullTextures");o(this,"samplers");o(this,"_onNeedsUpdate",e=>{const i=e.target;this._loadTextureFromSource(i)});o(this,"_onTextureDispose",e=>{const i=e.target;this._texturesToResources.get(i).set(void 0,this.resourcesEnv),i instanceof jr&&Qi(i,this._videoTextures),i.removeEventListener(st.eventType.DISPOSED,this._onTextureDispose),i.removeEventListener(st.eventType.NEEDS_UPDATE,this._onNeedsUpdate),i.webglTexture&&(this.resourcesEnv.renderContext.gl.deleteTexture(i.webglTexture),i.webglTexture=null)});this.nullTextures=new FT(this.resourcesEnv.renderContext.gl),this.samplers=new BT(e.renderContext)}getDescriptorForTexture(e,i,n){let s=this._textureSourceToResourceDescriptors.get(e);return s||(s=new Bu(e,this._textureIdCounter++,i,n),this._textureSourceToResourceDescriptors.set(e,s)),s}createTexture(e){e.width>0&&e.height>0;const i=new Bu(e,this._textureIdCounter++);return new Kt(this.acquireResource(i))}createCubeTexture(e,i){const n=new st;n.isCube=!0,n.anisotropy=st.NO_ANISOTROPY,n.minFilter=i?H.LINEAR_MIPMAP_NEAREST:H.LINEAR,n.magFilter=H.LINEAR,n.wrapS=H.CLAMP_TO_EDGE,n.wrapT=H.CLAMP_TO_EDGE,n.flipY=!1,n.format=Ke.RGBA8,n.generateMipmaps=i,n.needsUpdate=!1,n.width=e,n.height=e,n.needsUpdate=!0;const s=this.getDescriptorForTexture(n),a=this.acquireResource(s);return this._texturesToResources.get(n).get(),n}_uploadResource(e){const i=e.descriptor.textureSource;return i instanceof Ar?(i.type,H.TEXTURE_2D,e.texture=this.resourcesEnv.renderContext.createTexture(i)):i instanceof st?(e.texture=this._loadTextureFromSource(i),this._texturesToResources.set(i,new Kt(e)),i instanceof jr&&this._videoTextures.push(i)):e.texture=i,i instanceof Ar||this._textureSourceToResourceDescriptors.has(i),!0}_unloadResource(e){e.texture&&(this.resourcesEnv.renderContext.deleteTexture(e.texture),e.texture=void 0);const i=e.descriptor.textureSource;i instanceof Ar||this._textureSourceToResourceDescriptors.delete(i)}updateManager(){super.updateManager();for(const e of this._videoTextures)this._loadTextureFromSource(e)}isAnyVideoTexturePresent(){return this._videoTextures.length>0}_loadTextureFromSource(e){if(e.needsUpdate||!e.webglTexture){const i=this.resourcesEnv.renderContext.gl,n=e.isCube?i.TEXTURE_CUBE_MAP:i.TEXTURE_2D;e.webglTexture||(e.addEventListener(st.eventType.DISPOSED,this._onTextureDispose),e.addEventListener(st.eventType.NEEDS_UPDATE,this._onNeedsUpdate),e.webglTexture=i.createTexture(),e.webglTexture,void 0),this.resourcesEnv.renderContext.bindTexture(e.webglTexture,n,0),i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,e.flipY),i.pixelStorei(i.UNPACK_ALIGNMENT,e.unpackAlignment),i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,e.premultiplyAlpha),e.isCube?this._loadCubeTextureData(e):this._load2DTextureData(e),e.generateMipmaps&&i.generateMipmap(n),e.needsUpdate=!1}return e.webglTexture,e.webglTexture}_load2DTextureData(e){const i=this.resourcesEnv.renderContext.gl,n=e.mipmaps;if(n&&n.length>0){for(let s=0,a=n.length;s<a;s++)this._texImage2D(i.TEXTURE_2D,s,e.format,n[s]);e.releaseOnLoadedToGpu&&(e.mipmaps=void 0),e.generateMipmaps=!1}else e.image,this._texImage2D(i.TEXTURE_2D,0,e.format,e.image),e.releaseOnLoadedToGpu&&(e.image=void 0)}_loadCubeTextureData(e){const i=this.resourcesEnv.renderContext.gl;if(e.image){const n=Gr(e.format),s=e.image;for(let a=0;a<6;a++)n||(s[a],this._texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+a,0,e.format,s[a]),e.releaseOnLoadedToGpu&&(s[a].data=void 0))}else{e.width,e.height;const n=new ye(e.width,e.width);for(let s=0;s<6;s+=1)this._texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+s,0,e.format,n)}}_texImage2D(e,i,n,s){const a=this.resourcesEnv.renderContext.gl;if(Gr(n)){const d=s;d instanceof pr&&d.data,a.compressedTexImage2D(e,i,n,d.width,d.height,0,d.data);return}const l=jd(n),c=Xd(n);if(s instanceof ye){const d=s;Gr(n),a.texImage2D(e,i,n,d.x,d.y,0,l,c,null);return}const h=s;h instanceof pr?(h.data,a.texImage2D(e,i,n,h.width,h.height,0,l,c,h.data)):h instanceof Array||a.texImage2D(e,i,n,l,c,h)}}class wg extends gr{constructor(e,i){super();o(this,"geometry");o(this,"_geometryId");this.geometry=e,this._geometryId=i}compare(e){return Gs(this._geometryId,e._geometryId)}}class Sg extends Io{constructor(){super(...arguments);o(this,"refCounter",0);o(this,"vao");o(this,"buffers",[]);o(this,"indexBufferType");o(this,"itemsCount",0);o(this,"offset",0);o(this,"instanceCount",0);o(this,"instanced",!1)}load(e){return!0}unload(e){return!0}}var UT=Object.defineProperty,kT=Object.getOwnPropertyDescriptor,VT=(r,t,e,i)=>{for(var n=i>1?void 0:i?kT(t,e):t,s=r.length-1,a;s>=0;s--)(a=r[s])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&UT(t,e,n),n};class Mg extends to{constructor(e){super(Sg,e);o(this,"geometryIds",new Map);o(this,"currentId",0)}getMeshResourceDescriptor(e){return new wg(e,this.getGeometryId(e))}getGeometryId(e){const i=this.geometryIds.get(e);return i||(this.geometryIds.set(e,this.currentId),this.currentId++)}updateResource(e,i){const n=e.attributes,s=this.resourcesEnv,a=s.renderContext,l=n.index;i.vao?a.bindVao(i.vao):(e.setOnDispose(this._onGeometryDispose.bind(this)),i.vao=a.createAndBindVao()),l&&(l.needsUpdate||!l.buffer?this._updateBuffer(a,l,i,!0):a.bindBuffer(H.ELEMENT_ARRAY_BUFFER,l.buffer),[l.glType,l.glTypeSize]=this._getTypeAndSizeForArray(l.array));for(const c of Iu){const h=n[c.name];h?(h.needsUpdate||!h.buffer?this._updateBuffer(a,h,i,!1):a.bindBuffer(H.ARRAY_BUFFER,h.buffer),this._setupAttribute(a,h,c.index,e)):this._disableAttributeAndSetDefaultValue(e,c.name,a,c.index)}this._setupDrawCallParams(i,e,l),s.renderContext.bindVao(void 0)}_setupDrawCallParams(e,i,n){if(n){e.indexBufferType=n.glType;const s="indexUint"in i&&i.indexUint?4:2;"indexOffset"in i&&i.indexOffset!==void 0?(e.itemsCount=i.indexCnt,e.offset=s*i.indexOffset):(e.itemsCount=n.length,e.offset=0)}else{e.indexBufferType=void 0;const s=i.attributes.position;"vertexOffset"in i&&i.vertexOffset!==void 0?(e.itemsCount=i.vertexCnt,e.offset=i.vertexOffset):(e.itemsCount=s.length/s.itemSize,e.offset=0)}e.instanced="isInstanced"in i&&i.isInstanced,e.instanceCount="instanceCount"in i&&i.instanceCount?i.instanceCount:0}_uploadResource(e){return this.updateResource(e.descriptor.geometry,e),!0}_updateBuffer(e,i,n,s){i.buffer||(i.buffer=e.createBuffer(),n.buffers.push(i.buffer));const a=s?H.ELEMENT_ARRAY_BUFFER:H.ARRAY_BUFFER;e.bindBuffer(a,i.buffer),e.updateBuffer(a,i.array,!0),i.needsUpdate=!1}_setupAttribute(e,i,n,s){var u,f;const a=i.array;if($e.ios){const p=i.itemSize*a.BYTES_PER_ELEMENT%4;console.assert(p===0)}[i.glType,i.glTypeSize]=this._getTypeAndSizeForArray(a),i.needsUpdate=!1;const l=i.itemSize,c=(u=i.divisor)!=null?u:0;let d=(s instanceof Ea?((f=s.instanceId)!=null?f:0)*4*4:0)*c;s instanceof Ea&&s.vertexAttribOffset&&(d+=s.vertexAttribOffset*i.glTypeSize*l),e.setupVertexAttribute(n,i.itemSize,i.glType,d,c,!1,0)}_getTypeAndSizeForArray(e){return e instanceof Float32Array?[H.FLOAT,4]:e instanceof Int8Array?[H.BYTE,1]:e instanceof Int16Array?[H.SHORT,2]:e instanceof Uint16Array?[H.UNSIGNED_SHORT,2]:e instanceof Uint32Array?[H.UNSIGNED_INT,4]:[0,0]}_disableAttributeAndSetDefaultValue(e,i,n,s){let a;if("defaultAttributeValues"in e&&e.defaultAttributeValues){const l=i;a=e.defaultAttributeValues[l]}else a=nT[i];n.disableVertexAttribute(s,a)}_onGeometryDispose(e){e.setOnDispose(void 0);const i=this.resourcesEnv.renderContext.gl,n=e.attributes;for(const s in e.attributesKeys)if(Object.prototype.hasOwnProperty.call(n,s)){const a=n[s];a!==void 0&&a.buffer!==void 0&&(i.deleteBuffer(a.buffer),delete a.buffer)}}_unloadResource(e){this.resourcesEnv.webGLRenderer.getGl().deleteVertexArray(e.vao),e.buffers=[]}}VT([Vt()],Mg.prototype,"updateResource",1);class zT{constructor(t){o(this,"meshResourceDescriptor");const e=new tn,i=new Float32Array([-1,-1,-1,3,-1,-1,-1,3,-1]),n=new Float32Array([0,0,2,0,0,2]);e.addAttribute("position",new Dt(i,3)),e.addAttribute("uv0",new Dt(n,2)),this.meshResourceDescriptor=t.meshManager.getMeshResourceDescriptor(e)}}class ju extends gr{constructor(e,i){super();o(this,"_customId");o(this,"textureRefs");o(this,"webglRenderTarget");e instanceof ko?this.webglRenderTarget=e:this.textureRefs=e,this._customId=i}compare(e){return Gs(this._customId,e._customId)}}class xh extends Io{constructor(){super(...arguments);o(this,"textureRefs",new Array);o(this,"framebuffer");o(this,"webglRenderTarget")}bind(e,i,n){this.webglRenderTarget?(this.webglRenderTarget,i.setRenderTarget(this.webglRenderTarget)):e.bindFramebuffer(this.framebuffer),e.setViewport(n)}load(e){return!1}getSize(){this.textureRefs.length>0;const e=this.textureRefs[0].get();return[e.descriptor.width,e.descriptor.height]}unload(e){}}class GT extends to{constructor(e){super(xh,e);o(this,"webglRenderTargetsToResources",new Map);o(this,"renderTargetsIdCounter",0);o(this,"renderContext");this.renderContext=e.renderContext}getResourceForWebGlRenderTarget(e){let i=this.webglRenderTargetsToResources.get(e);return i||(i=new Kt(this.acquireResource(new ju(e,this.getUniqueRenderTargetId()))),this.webglRenderTargetsToResources.set(e,i)),i.clone()}getUniqueRenderTargetId(){return this.renderTargetsIdCounter++}_uploadResource(e){const i=e.descriptor;if(i.webglRenderTarget)return e.webglRenderTarget=i.webglRenderTarget,!0;i.textureRefs;const n=new Array;let s,a=!1;for(const c of i.textureRefs){const h=c.get();if(h){const d=h.descriptor.getCreatedTextureParams().format;tm(d)?(s=h.texture,a=by(d)):n.push(h.texture)}else n.push(null)}const l=n.length>0||s?this.renderContext.createFramebuffer(n,s,a):void 0;return e.framebuffer=l,e.textureRefs.length,e.textureRefs=i.textureRefs,i.textureRefs=void 0,!0}_unloadResource(e){if(!e.webglRenderTarget){for(const i of e.textureRefs)i.set(void 0,this.resourcesEnv);e.textureRefs.splice(0,e.textureRefs.length),e.framebuffer&&this.renderContext.deleteFramebuffer(e.framebuffer),e.framebuffer=void 0}}}const mc=class mc{constructor(){o(this,"_cubeRotations",new Array);const t=[{target:new L(1,0,0),up:new L(0,-1,0)},{target:new L(-1,0,0),up:new L(0,-1,0)},{target:new L(0,1,0),up:new L(0,0,1)},{target:new L(0,-1,0),up:new L(0,0,-1)},{target:new L(0,0,1),up:new L(0,-1,0)},{target:new L(0,0,-1),up:new L(0,-1,0)}],e=new L(0,0,0),i=new Ue().identity();for(const{target:n,up:s}of t)i.lookAt(e,n,s),this._cubeRotations.push(new bi().setFromRotationMatrix(i))}static getRotationForFace(t){return mc._instance._cubeRotations[t]}};o(mc,"_instance",new mc);let Eh=mc;class qn{constructor(){o(this,"viewMatrix",new Ue);o(this,"invViewMatrix",new Ue);o(this,"projectionMatrix",new pa);o(this,"unjitteredProjectionMatrix",new pa);o(this,"unjitteredInvProjectionMatrix",new pa);o(this,"unjitteredInvViewProjMatrix",new Ue);o(this,"viewProjMatrix",new Ue);o(this,"unjitteredViewProjMatrix",new Ue)}}class Un{constructor(){o(this,"unjitteredPrevViewProjMatrix",new Ue);o(this,"prevCameraPosition",new L(0,0,0));o(this,"jitterOffset",new ye(0,0));o(this,"staticWeightAccumulationFrameBalance",0);o(this,"currentTemporalHistoryWeight",0);o(this,"_taaAccumulationResetFlag",!0);o(this,"_taaAccumulated",!1);o(this,"_sampleIndex",0)}updateTemporalAaParams(t,e){if(this._taaAccumulationResetFlag){this._taaAccumulationResetFlag=!1,this._taaAccumulated=!1,this.currentTemporalHistoryWeight=0,this.staticWeightAccumulationFrameBalance=0,this._sampleIndex=0,this._updateJitterOffset(e);return}this._updateJitterOffset(e),this._taaAccumulated=this.staticWeightAccumulationFrameBalance>e.samplesCount,t&&this.staticWeightAccumulationFrameBalance++>=0?this.currentTemporalHistoryWeight=e.historyWeightOnStaticCamera:(this.currentTemporalHistoryWeight=e.historyWeightOnDynamicCamera,t||(this.staticWeightAccumulationFrameBalance=-e.dynamicWeightFramesCount))}isTaaAccumulated(){return this._taaAccumulated}getTaaHistoryWeight(){return this.currentTemporalHistoryWeight}requestTaaAccumulationReset(){this._taaAccumulationResetFlag=!0}resetFramesTillStaticTaaHistoryWeight(t){this.staticWeightAccumulationFrameBalance=-t,this._taaAccumulated=!1}_updateJitterOffset(t){this.jitterOffset.x=(this._getHaltonNumber(2,this._sampleIndex)-.5)*2*t.jitterSpread,this.jitterOffset.y=(this._getHaltonNumber(3,this._sampleIndex)-.5)*2*t.jitterSpread,++this._sampleIndex>=t.samplesCount&&(this._sampleIndex=0)}_getHaltonNumber(t,e){let i=0,n=1;for(;e>0;)n/=t,i+=n*(e%t),e=Math.floor(e/t);return i}}class wt{constructor(t){o(this,"position",new L(0,0,0));o(this,"rotation",new bi(1,0,0,1));o(this,"scale",new L(1,1,1));t!=null&&t.position&&this.position.copyFrom(t.position),t!=null&&t.rotation&&this.rotation.copyFrom(t.rotation),t!=null&&t.scale&&this.scale.copyFrom(t.scale)}}class Pg{constructor(){o(this,"projectionMatrix",new Ue);o(this,"viewMatrix",new Ue);o(this,"invViewMatrix",new Ue);o(this,"viewProjMatrix",new Ue);o(this,"cameraPosition",new L)}updateData(t,e){const i=t.camera,n=i.get(qn);this.projectionMatrix=e?n.projectionMatrix:n.unjitteredProjectionMatrix,this.viewMatrix=n.viewMatrix,this.invViewMatrix=n.invViewMatrix,this.viewProjMatrix=n.viewProjMatrix,this.cameraPosition=i.get(wt).position}}class HT{constructor(){o(this,"unjitteredInvProjMatrix",new Ue);o(this,"unjitteredPrevViewProjMatrix",new Ue);o(this,"zNear_zFar",new ye);o(this,"fogDistStart_DistDensity_HeightStart_HeightDensity",new We);o(this,"fogColor",new We);o(this,"camera_exposure_gamma",new We);o(this,"colorMapIntensity",0);o(this,"time",0);o(this,"texelSize",new ye);o(this,"renderTargetSize",new ye);o(this,"deltaTime",0);o(this,"velocityFactor",0);o(this,"jitterOffset",new ye);o(this,"temporalAaHistoryWeight",.95);o(this,"allTaaSamplesAccumulated",!1);o(this,"accumulatedStaticTaaSamples",0);o(this,"dynamicTaaHistoryMultiplier",.75);o(this,"neighbourhoodTexelOffsets",new Array(8));o(this,"screenResolution",new We);o(this,"lightmapMode",0)}updateData(t){const e=t.camera,i=e.get(qn);this.unjitteredInvProjMatrix=i.unjitteredInvProjectionMatrix;const n=e.get(Dn),s=t.renderWorld.scene.sharedMaterialState,a=s.fog;if(a!==void 0&&a.enabled()){const f=a.distanceEnabled?a.distanceDensity:0,p=a.heightEnabled?a.heightDensity:0;this.fogDistStart_DistDensity_HeightStart_HeightDensity.set(a.distanceStart,f,a.heightStart,p),this.fogColor.set(a.color.r,a.color.g,a.color.b,0)}else this.fogDistStart_DistDensity_HeightStart_HeightDensity.set(0,0,0,0),this.fogColor.set(0,0,0,0);const l=Math.pow(2,n.filmicConfig.exposure);if(this.camera_exposure_gamma.set(l,n.filmicConfig.gamma,0,0),this.colorMapIntensity=n.filmicConfig.colorMapIntensity,s.colorMap){const f=s.colorMap.webglTexture;t.resourcesEnv.globalTextureTable.setBinding($r.get("colorMap"),H.TEXTURE_2D,f,t.resourcesEnv.textureManager.samplers.linearSampler)}this.deltaTime=t.frameMetrics.deltaTime,this.time+=this.deltaTime;const c=e.get(en),h=c.viewportSize;this.texelSize.set(1/h.x,1/h.y),this.renderTargetSize.copyFrom(h),this.zNear_zFar.set(c.near,c.far),this.velocityFactor=n.motionBlurConfig.intensity,this.dynamicTaaHistoryMultiplier=n.temporalAaConfig.dynamicTaaHistoryMultiplier;const d=e.get(Un);d&&(this.unjitteredPrevViewProjMatrix=d.unjitteredPrevViewProjMatrix,this.jitterOffset.copyFrom(c.projectionJitterOffset),this.temporalAaHistoryWeight=d.getTaaHistoryWeight(),this.allTaaSamplesAccumulated=d.isTaaAccumulated(),this.accumulatedStaticTaaSamples=d.staticWeightAccumulationFrameBalance);let u=0;for(let f=-1;f<=1;f++)for(let p=-1;p<=1;p++)f===0&&p===0||(this.neighbourhoodTexelOffsets[u]=new ye(f,p),this.neighbourhoodTexelOffsets[u].multiply(this.texelSize),u++);s.liveLightmap.texture&&(this.screenResolution.set(s.physicalWidth,s.physicalHeight,0,0),this.lightmapMode=s.liveLightmap.mode,t.resourcesEnv.globalTextureTable.setBinding($r.get("liveLightmap"),H.TEXTURE_2D,s.liveLightmap.texture.webglTexture,t.resourcesEnv.textureManager.samplers.pointSampler))}}const WT="brdfLUT";class jT{constructor(t,e,i){o(this,"currentMaterial");o(this,"currentPipelineState");o(this,"_clearPipelineState",new Lu);o(this,"lightBinding");o(this,"_disableCameraJitter",!1);o(this,"globalUniformBufferUpdater");o(this,"defaultCameraUniformBufferUpdater");o(this,"unjitteredCameraUniformBufferUpdater");o(this,"nullTextures");o(this,"renderContext");this.renderContext=t,this.nullTextures=e;const n=()=>{const s=i.shaderManager.getGlobalUniformBlockDescriptor();this.globalUniformBufferUpdater=new mh(this.renderContext,s,new HT);const a=i.shaderManager.getCameraUniformBlockDescriptor();this.defaultCameraUniformBufferUpdater=new mh(this.renderContext,a,new Pg),this.unjitteredCameraUniformBufferUpdater=new mh(this.renderContext,a,new Pg)};i.resourcesEvents.addEventListener(Ma.eventType.UNIFORM_DESCRIPTORS_INITIALIZED,n)}bindTextureTable(t){for(const e of t.getBindings().values())this.renderContext.bindTexture(e.texture,e.type,e.binding),this.renderContext.bindSampler(e.sampler,e.binding)}bindDrawCall(t,e){var n,s;this.bindMaterial(t.activeMaterial,t.renderMaterial.get(),e),this.bindLightingData((s=(n=t.lightDataBinding)==null?void 0:n.get())!=null?s:void 0),this.bindCameraUniformData(!t.usesCameraJitter);const i=t.perObjectUniformBuffer;i&&this.renderContext.bindUniformBuffer(mr[oe.OBJECT],i.glBuffer),this.renderContext.bindVao(t.mesh.get().vao)}bindMaterial(t,e,i){if(e===this.currentMaterial)return;this.currentMaterial=e,T.DEV_NEW_PIPELINE_STATES?this.currentPipelineState!==e.pipelineState.get()&&(this.currentPipelineState=e.pipelineState.get(),this.renderContext.bindPipelineState(this.currentPipelineState.descriptor.pipelineState)):(i.setMaterial(t),i.setMaterialFaces(t));const n=e.uniformBuffer;n&&this.renderContext.bindUniformBuffer(mr[oe.MATERIAL],n.glBuffer),this.renderContext.bindProgram(e.shader.get().program),this.bindTextureTable(e.textureTable)}bindLightingData(t){if(t&&t!==this.lightBinding){this.lightBinding=t;const e=this.lightBinding.uniformBuffer;this.renderContext.bindUniformBuffer(mr[oe.LIGHT],e.glBuffer),this.bindTextureTable(t.textureTable)}}updateAndBindGlobalUniformData(t){const e=t.resourcesEnv;this.globalUniformBufferUpdater.data.updateData(t),this.globalUniformBufferUpdater.uploadData(this.renderContext),this.globalUniformBufferUpdater.bindUniformBufer(mr[oe.GLOBAL],this.renderContext),this.bindTextureTable(e.globalTextureTable)}updateCameraUniformData(t){const e=t.postprocessComp.isTaaEnabled();this.defaultCameraUniformBufferUpdater.data.updateData(t,e),this.defaultCameraUniformBufferUpdater.uploadData(this.renderContext),this.unjitteredCameraUniformBufferUpdater.data.updateData(t,!1),this.unjitteredCameraUniformBufferUpdater.uploadData(this.renderContext)}bindCameraUniformData(t){this._disableCameraJitter!==t&&(this._disableCameraJitter=t,this._disableCameraJitter?this.unjitteredCameraUniformBufferUpdater.bindUniformBufer(mr[oe.CAMERA],this.renderContext):this.defaultCameraUniformBufferUpdater.bindUniformBufer(mr[oe.CAMERA],this.renderContext))}bindForRenderTargetClear(t){this.currentPipelineState=void 0,this._clearPipelineState.depthRead=t.isAnyBitSet(Js.DEPTH_STENCIL),this._clearPipelineState.depthWrite=t.isAnyBitSet(Js.DEPTH_STENCIL),this._clearPipelineState.colorWriteMask=new ua(t.get(Js.COLOR)?Kr.RGBA:void 0),t.isAnyBitSet(Js.STENCIL)&&(this._clearPipelineState.stencilState.enabled=!0,this._clearPipelineState.stencilState.writeMask=255),this.renderContext.bindPipelineState(this._clearPipelineState)}resetState(){this.currentMaterial=void 0,this.lightBinding=void 0,this.renderContext.resetState(),this._disableCameraJitter=!1,this.defaultCameraUniformBufferUpdater.bindUniformBufer(mr[oe.CAMERA],this.renderContext)}unload(){var t,e,i;(t=this.globalUniformBufferUpdater)==null||t.unload(this.renderContext),(e=this.defaultCameraUniformBufferUpdater)==null||e.unload(this.renderContext),(i=this.unjitteredCameraUniformBufferUpdater)==null||i.unload(this.renderContext)}}var XT=Object.defineProperty,qT=Object.getOwnPropertyDescriptor,YT=(r,t,e,i)=>{for(var n=i>1?void 0:i?qT(t,e):t,s=r.length-1,a;s>=0;s--)(a=r[s])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&XT(t,e,n),n},Cg=(r=>(r.MATERIALS_UPDATED="materialsUpdated",r.UNIFORM_DESCRIPTORS_INITIALIZED="uniformDescriptorsInitialized",r))(Cg||{});class Ma extends ci{}o(Ma,"eventType",Cg);const Rg=class sb{constructor(t,e){o(this,"shaderManager");o(this,"materialManager");o(this,"meshManager");o(this,"lightBindingManager");o(this,"textureManager");o(this,"renderTargetManager");o(this,"pipelineStateManager");o(this,"resourceConstructorToResourceManagers",new Map);o(this,"webGLRenderer");o(this,"renderContext");o(this,"fullscreenRenderHelper");o(this,"resourcesEvents",new Ma);o(this,"sharedState");o(this,"globalTextureTable",new fh);this.webGLRenderer=t,this.renderContext=e,this.renderTargetManager=this._createResourceManager(GT),this.shaderManager=this._createResourceManager(OT),this.materialManager=this._createResourceManager(Wu),this.textureManager=this._createResourceManager(NT),this.pipelineStateManager=this._createResourceManager(LT),this.meshManager=this._createResourceManager(Mg),this.lightBindingManager=this._createResourceManager(RT),this.sharedState=new jT(e,this.textureManager.nullTextures,this),this.fullscreenRenderHelper=new zT(this)}_createResourceManager(t){const e=new t(this);return this.resourceConstructorToResourceManagers.set(e.getResourceConstructor(),e),e}getResource(t){const e=sb.getResourceConstructorForDescriptor(t),n=this.resourceConstructorToResourceManagers.get(e).acquireResource(t);return new Kt(n)}unuseResource(t){const e=this.getResourceConstructor(t);this.resourceConstructorToResourceManagers.get(e).unuseResource(t)}getResourceConstructor(t){for(const e of this.resourceConstructorToResourceManagers.keys())if(t instanceof e)return e}static getResourceConstructorForDescriptor(t){if(t instanceof D_)return L_;if(t instanceof Tr)return _h;if(t instanceof wg)return Sg;if(t instanceof Eg)return Ag;if(t instanceof ju)return xh;if(t instanceof F_)return B_;if(t instanceof Bu)return bl}removeAllResources(){const t=[this.materialManager,this.pipelineStateManager,this.shaderManager,this.meshManager,this.lightBindingManager,this.renderTargetManager,this.textureManager];for(const e of t)e.removeAllResources();this.sharedState.unload()}update(){for(const[t,e]of this.resourceConstructorToResourceManagers)mt.beginSection(`${t.name}`),e.updateManager(),mt.endSection(`${t.name}`)}onMaterialsUpdated(t){this.resourcesEvents.dispatchEvent({type:Ma.eventType.MATERIALS_UPDATED,materials:t})}};YT([Vt({name:"ResourcesEnv update"})],Rg.prototype,"update",1);let Sn=Rg;class Xu{}class qu{constructor(){o(this,"currentStep",0);o(this,"grassOffsetScaled",1)}}var io=(r=>(r.PROCEDURAL="procedural",r.EQUIRECT="equirect",r))(io||{}),Ig=(r=>(r.UPDATED="skyMeshUpdated",r))(Ig||{});const pd=class pd extends je{constructor(e,i,n,s){super(i,n);o(this,"autoPosition");o(this,"name");o(this,"fog");o(this,"_updatedEvent",{type:pd.eventType.UPDATED,target:this});s&&this.position.fromArray(s),this.autoPosition=!s,this.name=e}setTexture(e){Ce(this.type==="equirect"),this.material.map=e,this.yawRotationDeg=0,this._updated()}_updated(){this.dispatchEvent(this._updatedEvent)}get type(){return this.isEquirect?"equirect":"procedural"}get yawRotationDeg(){return Wn(this.rotation.y)}set yawRotationDeg(e){const i=Ai(e);this.rotation.y=i,this.updateMatrixWorld(),this._updated()}get isEquirect(){return this.material instanceof gm}get radius(){return this.scale.x}set radius(e){this.scale.set(e,e,e),this.updateMatrixWorld(!0),this._updated()}serialize(){var i;const e={name:this.name,type:this.type};return this.autoPosition||(e.center=this.position.toArray()),this.isEquirect&&(e.yawRotation=this.yawRotationDeg,e.texture=this.material.map?this.material.map.serialize():null),(i=this.fog)!=null&&i.enabled()&&(e.fog=this.fog.serialize()),e}clone(){throw Error("SkyMesh can't be cloned.")}};o(pd,"eventType",Ig);let Pl=pd;var Yu={exports:{}};/**
 * @license BitSet.js v5.1.1 2/1/2020
 * http://www.xarg.org/2014/03/javascript-bit-array/
 *
 * Copyright (c) 2020, Robert Eisele (robert@xarg.org)
 * Dual licensed under the MIT or GPL Version 2 licenses.
 **/(function(r,t){(function(e){var i=32,n=5;function s(u){return u-=u>>>1&1431655765,u=(u&858993459)+(u>>>2&858993459),(u+(u>>>4)&252645135)*16843009>>>24}function a(u,f){for(var p=0,m=0;m<u.length;m++){p*=2;var b=(u[m]+p)/f|0;p=(u[m]+p)%f,u[m]=b}return p}function l(u,f){if(f==null){u.data=[0,0,0,0,0,0,0,0,0,0],u._=0;return}if(f instanceof c){u.data=f.data,u._=f._;return}switch(typeof f){case"number":u.data=[f|0],u._=0;break;case"string":var p=2,m=i;f.indexOf("0b")===0?f=f.substr(2):f.indexOf("0x")===0&&(f=f.substr(2),p=16,m=8),u.data=[],u._=0;var b=f.length-m,g=f.length;do{var x=parseInt(f.slice(b>0?b:0,g),p);if(isNaN(x))throw SyntaxError("Invalid param");if(u.data.push(x|0),b<=0)break;b-=m,g-=m}while(1);break;default:u.data=[0];var w=u.data;if(f instanceof Array){for(var C=f.length-1;C>=0;C--){var M=f[C];M===1/0?u._=-1:(h(u,M),w[M>>>n]|=1<<M)}break}if(Uint8Array&&f instanceof Uint8Array){var D=8;h(u,f.length*D);for(var C=0;C<f.length;C++)for(var W=f[C],z=0;z<D;z++){var $=C*D+z;w[$>>>n]|=(W>>z&1)<<$}break}throw SyntaxError("Invalid param")}}function c(u){if(!(this instanceof c))return new c(u);l(this,u),this.data=this.data.slice()}function h(u,f){for(var p=f>>>n,m=u.data,b=u._,g=m.length;p>=g;p--)m.push(b)}var d={data:[],_:0};c.prototype={data:[],_:0,set:function(u,f){return u|=0,h(this,u),f===void 0||f?this.data[u>>>n]|=1<<u:this.data[u>>>n]&=~(1<<u),this},get:function(u){u|=0;var f=this.data,p=u>>>n;return p>=f.length?this._&1:f[p]>>>u&1},not:function(){for(var u=this.clone(),f=u.data,p=0;p<f.length;p++)f[p]=~f[p];return u._=~u._,u},and:function(u){l(d,u);var f=this.clone(),p=f.data,m=d.data,b=m.length,g=d._,x=f._;x!==0&&h(f,b*i-1);for(var w=p.length,C=Math.min(b,w),M=0;M<C;M++)p[M]&=m[M];for(;M<w;M++)p[M]&=g;return f._&=g,f},or:function(u){l(d,u);for(var f=this.clone(),p=f.data,m=d.data,b=m.length-1,g=p.length-1,x=Math.min(g,b),w=b;w>x;w--)p[w]=m[w];for(;w>=0;w--)p[w]|=m[w];return f._|=d._,f},xor:function(u){l(d,u);var f=this.clone(),p=f.data,m=d.data,b=f._,g=d._,x=0,w=p.length-1,C=m.length-1;for(x=w;x>C;x--)p[x]^=g;for(x=C;x>w;x--)p[x]=b^m[x];for(;x>=0;x--)p[x]^=m[x];return f._^=g,f},andNot:function(u){return this.and(new c(u).flip())},flip:function(u,f){if(u===void 0){for(var p=this.data,m=0;m<p.length;m++)p[m]=~p[m];this._=~this._}else if(f===void 0)h(this,u),this.data[u>>>n]^=1<<u;else if(0<=u&&u<=f){h(this,f);for(var m=u;m<=f;m++)this.data[m>>>n]^=1<<m}return this},clear:function(u,f){var p=this.data;if(u===void 0){for(var m=p.length-1;m>=0;m--)p[m]=0;this._=0}else if(f===void 0)u|=0,h(this,u),p[u>>>n]&=~(1<<u);else if(u<=f){h(this,f);for(var m=u;m<=f;m++)p[m>>>n]&=~(1<<m)}return this},slice:function(u,f){if(u===void 0)return this.clone();if(f===void 0){f=this.data.length*i;var p=Object.create(c.prototype);p._=this._,p.data=[0];for(var m=u;m<=f;m++)p.set(m-u,this.get(m));return p}else if(u<=f&&0<=u){var p=Object.create(c.prototype);p.data=[0];for(var m=u;m<=f;m++)p.set(m-u,this.get(m));return p}return null},setRange:function(u,f,p){for(var m=u;m<=f;m++)this.set(m,p);return this},clone:function(){var u=Object.create(c.prototype);return u.data=this.data.slice(),u._=this._,u},toArray:Math.clz32?function(){for(var u=[],f=this.data,p=f.length-1;p>=0;p--)for(var m=f[p];m!==0;){var b=31-Math.clz32(m);m^=1<<b,u.unshift(p*i+b)}return this._!==0&&u.push(1/0),u}:function(){for(var u=[],f=this.data,p=0;p<f.length;p++)for(var m=f[p];m!==0;){var b=m&-m;m^=b,u.push(p*i+s(b-1))}return this._!==0&&u.push(1/0),u},toString:function(u){var f=this.data;if(u||(u=2),!(u&u-1)&&u<36){for(var p="",m=2+Math.log(4294967295)/Math.log(u)|0,b=f.length-1;b>=0;b--){var g=f[b];g<0&&(g+=4294967296);var x=g.toString(u);p!==""&&(p+="0".repeat(m-x.length-1)),p+=x}return this._===0?(p=p.replace(/^0+/,""),p===""&&(p="0"),p):(p="1111"+p,p.replace(/^1+/,"...1111"))}else{if(2>u||u>36)throw SyntaxError("Invalid base");for(var p=[],w=[],b=f.length;b--;)for(var C=i;C--;)w.push(f[b]>>>C&1);do p.unshift(a(w,u).toString(u));while(!w.every(function(D){return D===0}));return p.join("")}},isEmpty:function(){if(this._!==0)return!1;for(var u=this.data,f=u.length-1;f>=0;f--)if(u[f]!==0)return!1;return!0},cardinality:function(){if(this._!==0)return 1/0;for(var u=0,f=this.data,p=0;p<f.length;p++){var m=f[p];m!==0&&(u+=s(m))}return u},msb:Math.clz32?function(){if(this._!==0)return 1/0;for(var u=this.data,f=u.length;f-- >0;){var p=Math.clz32(u[f]);if(p!==i)return f*i+i-1-p}return 1/0}:function(){if(this._!==0)return 1/0;for(var u=this.data,f=u.length;f-- >0;){var p=u[f],m=0;if(p){for(;(p>>>=1)>0;m++);return f*i+m}}return 1/0},ntz:function(){for(var u=this.data,f=0;f<u.length;f++){var p=u[f];if(p!==0)return p=(p^p-1)>>>1,f*i+s(p)}return 1/0},lsb:function(){for(var u=this.data,f=0;f<u.length;f++){var p=u[f],m=0;if(p){for(var b=p&-p;b>>>=1;m++);return i*f+m}}return this._&1},equals:function(u){l(d,u);var f=this.data,p=d.data,m=this._,b=d._,g=f.length-1,x=p.length-1;if(b!==m)return!1;for(var w=g<x?g:x,C=0;C<=w;C++)if(f[C]!==p[C])return!1;for(C=g;C>x;C--)if(f[C]!==b)return!1;for(C=x;C>g;C--)if(p[C]!==m)return!1;return!0},[Symbol.iterator]:function(){var u=this.data,f=0;if(this._===0){for(var p=0,m=u.length-1;m>=0;m--)if(u[m]!==0){p=m;break}return{next:function(){var b=f>>>n;return{done:b>p||b===p&&u[b]>>>f===0,value:b>p?0:u[b]>>>f++&1}}}}else return{next:function(){var b=f>>>n;return{done:!1,value:b<u.length?u[b]>>>f++&1:1}}}}},c.fromBinaryString=function(u){return new c("0b"+u)},c.fromHexString=function(u){return new c("0x"+u)},c.Random=function(u){(u===void 0||u<0)&&(u=i);for(var f=u%i,p=[],m=Math.ceil(u/i),b=Object.create(c.prototype),g=0;g<m;g++)p.push(Math.random()*4294967296|0);return f>0&&(p[m-1]&=(1<<f)-1),b.data=p,b._=0,b},Object.defineProperty(t,"__esModule",{value:!0}),c.default=c,c.BitSet=c,r.exports=c})()})(Yu,Yu.exports);var QT=Yu.exports;const Cl=dT(QT);class wr{constructor(){o(this,"frustum",new fa);o(this,"renderListsVisibility",{[xt.OPAQUE]:new Cl,[xt.GRASS]:new Cl,[xt.TRANSPARENT]:new Cl,[xt.SKY]:new Cl,[xt.MESH_ANIMATION]:new Cl})}}class no{constructor(){o(this,"children",new Array)}}class Qu{constructor(){o(this,"parentEntityId",-1)}}class Ah extends Ot.ReactionSystem{constructor(){super(e=>e.has(no));o(this,"entityRemoved",e=>{const i=e.previous.get(no).children;for(const n of i)this.engine.removeEntity(n)})}setParent(e,i){let n=e.get(Qu);n||(n=new Qu,e.addComponent(n));const s=i.get(no);if(n.parentEntityId!==-1){const l=this.engine.getEntityById(n.parentEntityId).get(no).children,c=l.indexOf(e);l.splice(c,1)}n.parentEntityId=i.id,s.children.push(e)}static executeOnHierachy(e,i){i(e);const n=e.get(no);if(n)for(const s of n.children)Ah.executeOnHierachy(s,i)}}class Yn{constructor(t){o(this,"_baseName");o(this,"name");o(this,"needsUpdate",!0);this._baseName=t,this.name=this._baseName}set baseName(t){this._baseName=t,this.needsUpdate=!0}get baseName(){return this._baseName}}class Dg{constructor(){o(this,"objectId",new js(0))}}class Ri{constructor(){o(this,"componentInterpolators",new Map)}}class kn{constructor(t){o(this,"object3D");o(this,"visible",!0);this.object3D=t}getObjectAs(t){return this.object3D instanceof t,this.object3D}}class KT{constructor(t){o(this,"_renderWorld");o(this,"_resourceEnv");o(this,"_objectsToBeRegistered",new Map);o(this,"threeMeshesToResources",new Map);o(this,"entitiesToUpdateTransform",new Set);this._renderWorld=t,this._resourceEnv=this._renderWorld.ecs.sharedConfig.get(Sn)}addEntity(t,e){const i=this._doAddEntity(t,e);this.updateEntityVisibility(i.id,t.visible)}getPreparedEntityForObject(t){t.entityId;let e=this._objectsToBeRegistered.get(t);return e||(e=new Ot.Entity,this._objectsToBeRegistered.set(t,e),e)}createCameraEntity(t,e){const i=new Ot.Entity;i.add(new en),i.add(e!=null?e:new Dn),i.add(new qn),i.add(new wr),i.add(new Yn("Camera")),this._renderWorld.ecs.addEntity(i);let n;return t?(t.entityId,t.entityId=i.id,i.add(new kn(t)),n=new wt({position:t.getWorldPosition(),rotation:t.getWorldQuaternion(),scale:t.getWorldScale()})):n=new wt,i.add(n),i}updateEntityVisibility(t,e){const i=this._renderWorld.ecs.getEntityById(t),n=i.get(kn).object3D;if(e){let l=n.parent;for(;l!==void 0;){if(!l.visible){e=!1;break}l=l.parent}}const s=i.get(Mt);s&&(s.drawCall.visible=e);const a=i.get(As);a&&(a.motionDrawCall.visible=e);for(const l of n.children)this.updateEntityVisibility(l.entityId,e&&l.visible)}_doAddEntity(t,e){let i=this._objectsToBeRegistered.get(t);i?this._objectsToBeRegistered.delete(t):i=new Ot.Entity;let n;e&&e.entityId!==-1&&(n=this._renderWorld.ecs.getEntityById(e.entityId)),n&&!n.has(no)&&n.add(new no),t instanceof je?this._configureMeshEntity(t,i):this._configureNonMeshEntity(t,i),i.addComponent(new kn(t)),i.addTag(this._getEntityTypeTagForObject3D(t)),t.children.length>0&&i.add(new no),this._renderWorld.ecs.addEntity(i),t.entityId=i.id,n&&this._renderWorld.hierarchySystem.setParent(i,n);for(const s of t.children)this._doAddEntity(s,t);return i}removeEntity(t){const e=this._renderWorld.ecs.getEntityById(t);Ah.executeOnHierachy(e,i=>{const n=i.get(kn).object3D;n.entityId=-1}),this._renderWorld.ecs.removeEntity(e)}_configureNonMeshEntity(t,e){e.add(new wt({position:t.getWorldPosition(),rotation:t.getWorldQuaternion(),scale:t.getWorldScale()})),e.add(new Yn(""))}_configureMeshEntity(t,e){var c,h;let i=this.threeMeshesToResources.get(t);if(i||(this.updateMeshResource(t),i=this.threeMeshesToResources.get(t)),t.matrixWorld){let d;if(t instanceof Tn&&((c=t.node)!=null&&c.animationMatrix)?d=t.node.animationMatrix:t instanceof Co&&t.editableRootNode&&(t.editableRootNode.mesh?d=t.editableRootNode.mesh.matrixWorld:d=t.editableRootNode.animationMatrix),d)e.add(new As({matrix:d}));else{const u=new wt({position:t.getWorldPosition(),rotation:t.getWorldQuaternion(),scale:t.getWorldScale()});e.add(u)}}const s=this._resourceEnv.meshManager.getMeshResourceDescriptor(t.geometry);e.add(new Mt({material:t.material,meshResourceDescriptor:s})),e.add(new xi);let a=t.geometry.boundingBox;if(!a){a=new li;const d=t.geometry;d instanceof tn?(Ce(d.attributes.position.array instanceof Float32Array),a.setFromArray(d.attributes.position.array)):(Ce(d.parent.attributes.position.array instanceof Float32Array),a.setFromArray(d.parent.attributes.position.array,d.vertexOffset?d.vertexOffset:0,d.vertexCnt)),t.geometry.boundingBox=a,t.geometry.boundingSphere=t.geometry.boundingBox.getBoundingSphere()}if(e.add(new Xr(a,t.frustumCulled)),e.add(new Yn("")),e.add(new Ri),t.material instanceof al)e.add(new Xu);else if(t.material instanceof Es){const d=new Qr,u=t.material,f=u.customizationFunc?u.customizationFunc(t):void 0;d.backsideLineThickness=(f==null?void 0:f.backsideLineThickness)||u.lineThickness,d.lineThickness=(f==null?void 0:f.lineThickness)||u.lineThickness,d.lineColor=(f==null?void 0:f.lineColor)||u.lineColor,e.add(d)}t instanceof Tn&&((h=t.node)==null?void 0:h.disableCollisions)||e.addTag(Sm)}_getEntityTypeTagForObject3D(t){let e=$T;return t instanceof Pl?e=Lg:t instanceof Co||t instanceof Tn?e=$u:t instanceof je&&(e=ZT),e}updateMeshResource(t){let e=this.threeMeshesToResources.get(t);if(e)this._resourceEnv.meshManager.updateResource(t.geometry,e.get());else{const i=this._resourceEnv.meshManager.getMeshResourceDescriptor(t.geometry);e=this._resourceEnv.getResource(i),this.threeMeshesToResources.set(t,e)}if(t instanceof Co)for(const i of t.logicalMeshes)this.updateMeshResource(i)}unuseMeshUsedByObject(t){t instanceof je&&(this.threeMeshesToResources.get(t).set(void 0,this._renderWorld.ecs.sharedConfig.get(Sn)),this.threeMeshesToResources.delete(t))}markTransformUpdated(t){const e=this._renderWorld.ecs.getEntityById(t);this.entitiesToUpdateTransform.add(e)}updateTransformFrom3DObjects(){for(const t of this.entitiesToUpdateTransform){const e=t.get(kn).object3D;if(e){let i;e.matrixWorld&&(i=new wt,e.getWorldPosition(i.position),e.getWorldQuaternion(i.rotation),e.getWorldScale(i.scale)),this._renderWorld.updateSystem.updateEntityState(t,wt,i)}}this.entitiesToUpdateTransform.clear()}}class Ku extends Ot.ReactionSystem{constructor(){super(t=>t.has(Mt)&&t.has(kn))}refreshLightDataBindings(t){for(const e of this.entities)e.has(xi)||this._refreshLightDataBindingForEntity(e,t)}_refreshLightDataBindingForEntity(t,e){const i=this.getLightDataBindingDescriptor(t);t.get(Mt).drawCall.setLightDataBinding(e,i)}getLightDataBindingDescriptor(t){const e=t.get(kn);if(e){const i=e.getObjectAs(je);if(i.lightmap||i.lightProbes.length>0){const n=i.material,s=n.envMapMirror;let a=[];return!n.disableLightProbe&&n.reflective&&(s?a=i.lightProbes.length>0?[i.lightProbes[0]]:[]:a=i.lightProbes),new Eg(i.lightmap,a,s)}}}}const so=[Xr,Mt],$T="NODE_TAG",$u="SCENE_MESH_TAG",Lg="SKY_MESH_TAG",ZT="HELPER_MESH_TAG",Zu="PER_OBJECT_DATA_TAG",Ju="DYNAMIC_TAA_MASK_TAG";class JT extends Ot.ReactionSystem{constructor(){super(e=>so.every(i=>e.has(i)));o(this,"entityRemoved",e=>{const i=this.sharedConfig.get(Sn),n=e.previous.get(Mt);if(n.drawCall.unload(i),n.perObjectUniformBuffer){const s=i.renderContext.gl;n.perObjectUniformBuffer.unload(s),n.perObjectUniformBuffer=void 0}})}onAddedToEngine(){super.onAddedToEngine(),this.sharedConfig.get(Sn).resourcesEvents.addEventListener(Ma.eventType.MATERIALS_UPDATED,this._onMaterialsUpdated.bind(this))}_onMaterialsUpdated(e){for(const i of this.entities){const a=i.get(Mt).drawCall.renderMaterial.get();a&&e.materials.has(a)&&(i.has(xi)||i.add(new xi))}}getEntities(){return this.entities}}class Rl extends Ot.ReactionSystem{constructor(e){super(i=>i.has(xt[e])?so.every(n=>i.has(n)):!1);o(this,"_renderList",new yx);o(this,"entityAdded",({current:e})=>{const i=e.get(Mt);this._renderList.add(i.drawCall)});o(this,"entityRemoved",e=>{const i=e.previous.get(Mt);this._renderList.remove(i.drawCall)})}update(e){this._renderList.reindexIfNeeded()}get renderList(){return this._renderList}getEntities(){return this.entities}}class ef extends Rl{constructor(){super(xt.OPAQUE)}}class tf extends Rl{constructor(){super(xt.GRASS)}}class nf extends Rl{constructor(){super(xt.TRANSPARENT)}}class sf extends Rl{constructor(){super(xt.SKY)}}class e1 extends Ot.ReactionSystem{constructor(){super(t=>t.has(xi)?so.every(e=>t.has(e)):!1)}update(){var n,s,a;const t=this.sharedConfig.get(Sn),e=t.renderContext.gl,i=this.entities;if(i.length>0){const l=new tu;for(let c=i.length-1;c>=0;c--){const h=i[c];for(let b=0;b<eu;b++)h.remove(xt[b]);const d=h.get(xi),u=(n=d.drawCallComp)!=null?n:h.get(Mt);u.perObjectUpdaters=d.perObjectUpdaters,u.perObjectUpdaters.length>0?h.addTag(Zu):h.removeTag(Zu);const f=(s=d.materialOverride)!=null?s:h.get(Mt).material;f.isPlaying?h.addTag(Ju):h.removeTag(Ju),l.materialDesc=new Tr(f,d.fsOutputs,void 0,u.perObjectUpdaters.map(b=>b.getDataConstructorType()),d.perObjectShaderDefines),l.meshDesc=(a=d.meshResourceDescriptorOverride)!=null?a:h.get(Mt).meshResourceDescriptor,l.lightBindingDesc=this.engine.getSystem(Ku).getLightDataBindingDescriptor(h),l.entity=h;const p=u.drawCall;p.load(t,l),p.usesCameraJitter=!0,u.perObjectUniformBuffer&&!p.usesPerObjectBuffer?(u.perObjectUniformBuffer.unload(e),u.perObjectUniformBuffer=void 0):!u.perObjectUniformBuffer&&p.usesPerObjectBuffer&&(u.perObjectUniformBuffer=new Ta(e)),p.perObjectUniformBuffer=u.perObjectUniformBuffer;let m=xt.OPAQUE;h.hasTag(Lg)?m=xt.SKY:f.transparent?m=xt.TRANSPARENT:h.has(Xu)&&(m=xt.GRASS),h.add(xt[m]),h.has(As)&&h.add(xt[xt.MESH_ANIMATION]),h.remove(xi)}}}}class er extends Ot.ReactionSystem{constructor(e,i){super(n=>!n.has(xi)||e&&!n.has(e)||i&&n.has(i)?!1:so.every(s=>n.has(s)));o(this,"_perObjectDataUpdater");o(this,"_perObjectDefines");o(this,"_materialOverride");o(this,"_fsOutputs")}getUpdater(){return this._perObjectDataUpdater}setUpdater(e,i){this._perObjectDataUpdater=new m_(e,i)}setDefines(e){this._perObjectDefines=e}setOverrideMaterial(e){this._materialOverride=e}setFsOutputs(e){this._fsOutputs=e}update(){for(const e of this.entities){const i=e.get(xi);if(this._perObjectDataUpdater&&(i.perObjectUpdaters.indexOf(this._perObjectDataUpdater,0),i.perObjectUpdaters.push(this._perObjectDataUpdater)),this._perObjectDefines)for(const n of this._perObjectDefines)i.perObjectShaderDefines.indexOf(n,0),i.perObjectShaderDefines.push(n);this._materialOverride&&(i.materialOverride,i.materialOverride=this._materialOverride),this._fsOutputs&&(i.fsOutputs=i.fsOutputs.concat(this._fsOutputs)),e.has(Ri)||e.addComponent(new Ri)}}}class Il{}const Pa="NonUniformScaleComponent";class t1 extends Ot.ReactionSystem{constructor(){super(t=>!t.has(Ri)||!t.has(wt)?!1:so.every(e=>t.has(e)))}update(t){for(const i of this.entities){const n=i.get(wt).scale;Oi(n.x,n.y,.001)&&Oi(n.x,n.z,.001)?i.remove(Pa):i.get(Mt).drawCall.usesNormalMatrix?i.add(Pa):i.remove(Pa)}}}class rf{constructor(){o(this,"normalMatrix",new Ue)}}class i1 extends er{constructor(){super(Pa);o(this,"_uploadDataHelper",new rf);this.setUpdater(rf,e=>this._uploadDataHelper),this.setDefines(["NON_UNIFORM_SCALE"])}}class n1 extends Ot.ReactionSystem{constructor(){super(e=>!e.has(Pa)||!e.has(wt)?!1:so.every(i=>e.has(i)));o(this,"_tempModelViewMat4",new Ue);o(this,"_tempModelMatrix",new Ue);o(this,"_uploadDataHelper",new rf);o(this,"entityRemoved",e=>{e.current.remove(Pa)})}update(e){const i=this.sharedConfig.get(Zr).camera.get(qn).viewMatrix,n=this.sharedConfig.get(Sn).webGLRenderer.getGl();for(const s of this.entities){const a=s.get(wt),c=s.get(Mt).drawCall;c.renderMaterial&&(this._tempModelMatrix.compose(a.position,a.rotation,a.scale),this._tempModelViewMat4.multiplyMatrices(i,this._tempModelMatrix),this._uploadDataHelper.normalMatrix=this._tempModelViewMat4,this._uploadDataHelper.normalMatrix.getInverse(this._tempModelViewMat4).transpose(),c.uploadPerObjectUniformSubData("normalMatrix",this._uploadDataHelper.normalMatrix.elements,n))}}}class Ca{constructor(){o(this,"modelMatrix",new Ue)}}class s1 extends er{constructor(){super(wt,Il);o(this,"_uploadHelper",new Ca);this.setDefines(["MODEL_MATRIX"]),this.setUpdater(Ca,e=>{const i=e.get(wt),n=i.scale;return this._uploadHelper.modelMatrix.compose(i.position,i.rotation,n),this._uploadHelper})}}class r1 extends er{constructor(){super(Il);o(this,"_uploadHelper",new Ca);this.setDefines(["MODEL_MATRIX"]),this.setUpdater(Ca,e=>{const i=this.engine.sharedConfig.get(Zr).camera;return this._uploadHelper.modelMatrix=i.get(qn).invViewMatrix,this._uploadHelper})}}class Th extends Ot.ReactionSystem{constructor(){super(t=>t.has(Il)&&t.has(Mt))}getEntities(){return this.entities}}class o1 extends Gi{constructor(e){super("ScreenSpaceEntitiesUv");o(this,"_drawCall",new qr);o(this,"_renderTarget",new Kt);const i=new bt({vsName:"screen_space_uv_vertex.glsl",fsName:"screen_space_uv_fragment.glsl"});i.depthWrite=!1,i.depthTest=!1,i.addDefine("DEV_NEW_RENDER_ARCHITECTURE");const n="reprojectedUvResult",s=new Tr(i,[`vec4 ${n}`]);this._drawCall.setMaterial(e,s),this.addOutputPort(Jr,{type:"vec4",name:n})}build(e){this._renderTarget=e.requestRenderTarget(this)}unloadResources(e){this._renderTarget.set(void 0,e.resourcesEnv)}render(e){const i=e.renderWorld.ecs.getSystem(Th).getEntities();if(i.length===0)return;const n=e.resourcesEnv.renderContext,s=e.webGLRenderer;this._renderTarget.get().bind(n,s,e.viewport);for(const a of i){const l=a.get(Mt);this._drawCall.mesh=l.drawCall.mesh,e.sharedState.bindDrawCall(this._drawCall,s),this._drawCall.render(n)}}}class a1 extends Gi{constructor(e){super("TaaDynamicMask");o(this,"_drawCall",new qr);o(this,"_renderTarget",new Kt);const i=new bt({vsName:"position_only_vertex.glsl",fsName:"taa_dynamic_mask_fragment.glsl"});i.depthWrite=!1,i.depthTest=!1,i.addDefine("DEV_NEW_RENDER_ARCHITECTURE");const n="reprojectedUvResult",s=new Tr(i,[`vec4 ${n}`]);this._drawCall.setMaterial(e,s),this.addOutputPort(Jr,{type:"vec4",name:n})}build(e){this._renderTarget=e.requestRenderTarget(this)}unloadResources(e){this._renderTarget.set(void 0,e.resourcesEnv)}render(e){const i=e.renderWorld.dynamicTaaMaskQuery.entities;if(i.length===0)return;const n=e.resourcesEnv.renderContext,s=e.webGLRenderer;this._renderTarget.get().bind(n,s,e.viewport);for(const a of i){const l=a.get(Mt).drawCall;this._drawCall.mesh=l.mesh,this._drawCall.perObjectUniformBuffer=l.perObjectUniformBuffer,this._drawCall.usesCameraJitter=l.usesCameraJitter,e.sharedState.bindDrawCall(this._drawCall,s),this._drawCall.render(n)}}}const md=class md extends wa{constructor(t,e){super("CopyTexture");const i=new bt({vsName:"postprocess_vertex.glsl",fsName:"copy_texture_fragment.glsl"});i.depthWrite=!1,i.depthTest=!1,i.depthWrite=!1,i.addDefine("DEV_NEW_RENDER_ARCHITECTURE"),i.addDefine("COPY_ALPHA"),this.addInputPort(mi,{type:"sampler2D",name:md.TEXTURE_UNIFORM_NAME}),e&&this.addInputPort(Xn),this.addOutputPort(mi,{type:"vec4",name:"fragColor"}),this.setupDrawCall(t,i,void 0,e)}};o(md,"TEXTURE_UNIFORM_NAME","tDiffuse");let Dl=md;class l1 extends Dl{capture(t,e,i){this._portsToTextureBindings.get(this._inputs[0]).texture=t;const n=i.sharedState,s=i.webGLRenderer;n.renderContext.bindFramebuffer(e),n.bindDrawCall(this.drawCall,s),n.bindTextureTable(this._textureTable);const a=s.getGl(),l=this.drawCall.mesh.get();a.drawArrays(a.TRIANGLES,l.offset,l.itemsCount)}}class Og{constructor(t,e){o(this,"renderTarget");o(this,"prevFrameTexture");this.prevFrameTexture=t,this.renderTarget=e}unuseResources(t){this.prevFrameTexture.set(void 0,t),this.renderTarget.set(void 0,t)}}class c1 extends wa{constructor(e){super("TemporalAA");o(this,"_sourceAndTarget");o(this,"_copyTextureRenderNode");o(this,"_currentFrameTextureBindIndex",-1);o(this,"_prevFrameTextureBindIndex",-1);o(this,"_copyTextureBindIndex",-1);o(this,"_oddFrameIndex",!1);const i=new bt({vsName:"postprocess_vertex.glsl",fsName:"temporal_aa_fragment.glsl"});i.depthWrite=!1,i.depthTest=!1,i.depthWrite=!1,i.addDefine("DEV_NEW_RENDER_ARCHITECTURE");const n="tColor";this.addInputPort(mi,{type:"sampler2D",name:n}),this.addInputPort(Jr,{type:"sampler2D",name:"tReprojectedUv"}),this.addOutputPort(mi,{type:"vec4",name:"fragColor"});const s="tColorPrev";this.setupDrawCall(e,i,[`sampler2D ${s}`]);const a=this.drawCall.getShader(),l=a.getSamplerUniform(n),c=e.textureManager.samplers.linearSampler;this.textureTable.getBinding(l.binding).sampler=c,this._currentFrameTextureBindIndex=l.binding;const h=a.getSamplerUniform(s);this._prevFrameTextureBindIndex=h.binding,this._copyTextureRenderNode=new Dl(e);const d=this._copyTextureRenderNode.drawCall.getShader().getSamplerUniform(Dl.TEXTURE_UNIFORM_NAME);this._copyTextureBindIndex=d.binding}build(e){super.build(e),this._renderTarget.get(),this._copyTextureRenderNode.setRenderTarget(this._renderTarget.get(),e.resourcesEnv),this._renderTarget.set(void 0,e.resourcesEnv);const i=e.getViewportSize(),n=new Ar;n.width=i.x,n.height=i.y;const s=e.getRenderTexture(n),a=e.getRenderTarget([s]),l=e.getRenderTexture(n),c=e.getRenderTarget([l]);this._sourceAndTarget=[new Og(s,c),new Og(l,a)]}unloadResources(e){this._sourceAndTarget&&(this._sourceAndTarget[0].unuseResources(e.resourcesEnv),this._sourceAndTarget[1].unuseResources(e.resourcesEnv)),this._sourceAndTarget=void 0,this._copyTextureRenderNode.unloadResources(e)}render(e){const i=this._sourceAndTarget[this._oddFrameIndex?0:1],n=i.renderTarget.get(),s=e.resourcesEnv.textureManager.samplers;this._renderTarget.set(n,e.resourcesEnv),this._textureTable.setBinding(this._prevFrameTextureBindIndex,H.TEXTURE_2D,i.prevFrameTexture.get().texture,s.linearSampler),super.render(e);const a=n.textureRefs[0].get().texture;this._copyTextureRenderNode.textureTable.setBinding(this._copyTextureBindIndex,H.TEXTURE_2D,a,s.pointSampler),this._copyTextureRenderNode.render(e),this._oddFrameIndex=!this._oddFrameIndex}}class Ll extends Gi{constructor(e,i,n=mi,s=!1){super(i);o(this,"renderPass");o(this,"renderTarget",new Kt);this.addOutputPort(n),s||this.addOutputPort(Xn),this.renderPass=e}build(e){this.renderTarget=e.requestRenderTarget(this)}unloadResources(e){this.renderTarget.set(void 0,e.resourcesEnv)}render(e){if(!this.renderTarget.get())return;const i=e.resourcesEnv.renderContext,n=e.webGLRenderer;this.renderTarget.get().bind(i,n,e.viewport),this.renderDrawCallList(e)}renderDrawCallList(e){const i=e.webGLRenderer,n=e.renderWorld.renderListsSystems[this.renderPass].renderList,a=e.camera.get(wr).renderListsVisibility[this.renderPass];if(a.msb()===1/0)return;const c=n.getSortedList();let h=-1;for(const d of c)h++,a.get(h)&&(e.sharedState.bindDrawCall(d,i),this.renderDrawCall(d,e.resourcesEnv.renderContext),d.activeMaterial.isAnimated&&(e.frameMetrics.animatedMaterialVisible=!0))}renderDrawCall(e,i){e.render(i)}}class h1{constructor(){o(this,"sortedList",[]);o(this,"_distancesSquared",new Map);o(this,"_compare");const t=(e,i)=>{const n=e.activeMaterial.transparentRenderOrder-i.activeMaterial.transparentRenderOrder;if(n!==0)return n;const s=this._distancesSquared.get(e),a=this._distancesSquared.get(i),l=Gs(a,s);return l!==0?l:e.index-i.index};this._compare=t.bind(this)}prepare(t,e){this._distancesSquared.clear(),this.sortedList.length=0;for(let i=0;i<e.length;i++){const n=e[i],s=n.boundsComp.wsSphere.center.distanceToSquared(t);this._distancesSquared.set(n,s)}e.sort(this._compare),this.sortedList=e}}class d1 extends Ll{constructor(){super(xt.TRANSPARENT,"Transparent pass");o(this,"_drawCallList",new h1)}renderDrawCallList(e){const i=e.webGLRenderer,n=e.camera.get(wr).renderListsVisibility[this.renderPass],s=e.renderWorld.renderListsSystems[this.renderPass].renderList.getSortedList();if(n.msb()===1/0)return;const l=new Array;let c=-1;for(const h of s)c++,n.get(c)&&l.push(h);this._drawCallList.prepare(e.camera.get(wt).position,l);for(const h of this._drawCallList.sortedList)e.sharedState.bindDrawCall(h,i),this.renderDrawCall(h,e.resourcesEnv.renderContext),h.activeMaterial.isAnimated&&(e.frameMetrics.animatedMaterialVisible=!0)}}class wh extends Gi{constructor(e,i=""){super(i);o(this,"inputsToOutputs",new Map);o(this,"outputsToInputs",new Map);o(this,"resultTypes",new Set);o(this,"proxiedNode");this.proxiedNode=e}addPortProxyIfNeeded(e){if(!this.resultTypes.has(e)){this.resultTypes.add(e);const i=this.addInputPort(e),n=this.addOutputPort(e);this.inputsToOutputs.set(i,n),this.outputsToInputs.set(n,i)}}acquireResources(e,i){this.proxiedNode.acquireResources(e,i);let n=this.inputsToOutputs.get(e);n||(n=this.outputsToInputs.get(e));const s=i.requestConnectedResult(n);s.getResourceAs(wm);const a=i.resourcesEnv;i.assignResultToPort(n,new n.resultType().copyFrom(s,a)),i.assignResultToPort(e,new e.resultType().copyFrom(s,a))}isRenderCallRequired(){return!1}}class Sh extends Gi{constructor(){super(...arguments);o(this,"inputProxyNode",new wh(this,"SequenceInProxyNode"));o(this,"outputProxyNode",new wh(this,"SequenceOutProxyNode"))}setNodesSequence(e){e.length>0;const i=new Set,n=new Set;for(const s of e){for(const a of s.getInputs())i.add(a.resultType);for(const a of s.getOutputs())n.add(a.resultType)}for(const s of i)this.inputProxyNode.addPortProxyIfNeeded(s);for(const s of n)this.outputProxyNode.addPortProxyIfNeeded(s);for(let s=0;s<e.length;s++){const a=e[s];Gi.connectOutputsToInputs(this.inputProxyNode,a),Gi.connectOutputsToInputs(a,this.outputProxyNode);const l=s+1<e.length?e[s+1]:this;a.connectNextFlowNode(l)}this.connectNextFlowNode(this.outputProxyNode),this.inputProxyNode.connectNextFlowNode(e[0])}getInputs(){return this.inputProxyNode.getInputs()}getOutputs(){return this.outputProxyNode.getOutputs()}}class u1 extends wa{constructor(t,e){super("CopyTexture");const i=new bt({vsName:"postprocess_vertex.glsl",fsName:"debug_fragment.glsl"});i.depthWrite=!1,i.depthTest=!1,i.depthWrite=!1,i.addDefine("DEV_NEW_RENDER_ARCHITECTURE"),i.addDefine("COPY_ALPHA"),this.addInputPort(mi,{type:"sampler2D",name:"tColorResult"}),this.addInputPort(Jr,{type:"sampler2D",name:"tReprojectedUvResult"}),e&&this.addInputPort(Xn),this.addOutputPort(mi,{type:"vec4",name:"fragColor"}),this.setupDrawCall(t,i,void 0,e)}}class f1 extends Gi{constructor(e,i){super(e.name+"RenderTexture");o(this,"textureParams");o(this,"renderTexture",new Kt);this.textureParams=i!=null?i:new Ar,this.addInputPort(e),this.addOutputPort(e)}acquireResources(e,i){if(e.parentNode,!this.renderTexture.get()){const n=i.getViewportSize();this.textureParams.width=n.x,this.textureParams.height=n.y,this.renderTexture=i.getRenderTexture(this.textureParams)}i.assignResultToPort(e,new e.resultType().assignResource(this.renderTexture,i.resourcesEnv))}unloadResources(e){this.renderTexture&&(e.unuseRenderTexture(this.renderTexture),this.renderTexture.set(void 0,e.resourcesEnv))}isRenderCallRequired(){return!1}}class p1 extends Gi{constructor(e){super(e.name+"RenderTargetTexture");o(this,"renderTargetOwner",new Kt);this.addInputPort(e),this.addOutputPort(e)}acquireResources(e,i){e.parentNode===this&&this.renderTargetOwner.get(),i.assignResultToPort(e,new e.resultType().assignResource(this.renderTargetOwner,i.resourcesEnv))}unloadResources(e){this.renderTargetOwner.set(void 0,e.resourcesEnv)}isRenderCallRequired(){return!1}}class Fg extends Gi{constructor(e){super(e!=null?e:"RenderTarget");o(this,"_inPortProxyNode");o(this,"_outPortProxyNode");this._inPortProxyNode=new wh(this,this.nodeName+"In"),this._outPortProxyNode=new wh(this,this.nodeName+"Out"),this._outPortProxyNode.connectNextFlowNode(this)}_addRenderTexture(e,i){return this._inPortProxyNode.resultTypes.has(e),this._inPortProxyNode.addPortProxyIfNeeded(e),this._outPortProxyNode.addPortProxyIfNeeded(e),Gi.connectOutputsToInputs(this._inPortProxyNode,i),Gi.connectOutputsToInputs(i,this._outPortProxyNode),this}getOutputs(){return this._outPortProxyNode.getOutputs()}getInputs(){return this._inPortProxyNode.getInputs()}}class Ra extends Fg{addRenderTexture(t,e){const i=new f1(t,new Ar(0,0,e));return this._addRenderTexture(t,i),this}}class Bg extends Fg{constructor(e,i){super(i!=null?i:"RenderTargetResourceNode");o(this,"_renderTargetResourceRef",new Kt);o(this,"_resultTypesToRenderNodes",new Map);for(const n of e){const s=new p1(n);this._resultTypesToRenderNodes.set(n,s),this._addRenderTexture(n,s)}}acquireResources(e,i){const n=i.resourcesEnv;if(!this._renderTargetResourceRef.get()){const s=this._acquireRenderTarget(i),a=s.get();this._renderTargetResourceRef.set(a,n);for(const l of this._resultTypesToRenderNodes.values())l.renderTargetOwner.set(a);s.set(void 0,n)}i.assignResultToPort(e,new e.resultType().assignResource(this._renderTargetResourceRef,n))}unloadResources(e){this._renderTargetResourceRef.set(void 0,e.resourcesEnv);for(const i of this._resultTypesToRenderNodes.values())i.unloadResources(e)}}class Ol{constructor(){o(this,"_currentResultTypesToOutputPorts",new Map);o(this,"_anyRenderResultPostprocessAdded",!1);o(this,"_lastAddedRenderNode")}build(t,e,i){this._addNode(e);const n=t.postprocessComp.antialiasingType,s=t.postprocessComp.motionBlurConfig.enabled;if(n===xs.NONE&&!s){for(const d of i)this._addNode(d);return this._lastAddedRenderNode}this._addNode(new Ra().addRenderTexture(mi,Ke.RGBA8).addRenderTexture(Xn,Ke.DEPTH24_STENCIL8));const a=t.resourcesEnv,l=n===xs.TAA||n===xs.TAA_AND_FXAA,c=n===xs.FXAA||n===xs.TAA_AND_FXAA;if(l||s){const d=new Sh("Reprojected UV sequence");d.setNodesSequence([new lT(a),new Ll(xt.MESH_ANIMATION,"Mesh animation",Jr,!0),new a1(a),new o1(a)]),this._addNode(d),this._addNode(new Ra().addRenderTexture(Jr,Ke.RGBA8))}c&&this._addRenderPostprocessPass(new cT(a)),l&&this._addRenderPostprocessPass(new c1(a)),s&&this._addRenderPostprocessPass(new hT(a)),t.frameFlags.isFlagEnabled(Nn.DEBUG_POSTPROCESS)&&this._addRenderPostprocessPass(new u1(a));for(const d of i)this._addNode(d);return this._lastAddedRenderNode}_addNode(t){for(const e of t.getInputs()){const i=this._currentResultTypesToOutputPorts.get(e.resultType);i&&i.connect(e)}for(const e of t.getOutputs())this._currentResultTypesToOutputPorts.set(e.resultType,e);this._lastAddedRenderNode=t}_addRenderPostprocessPass(t){this._anyRenderResultPostprocessAdded&&this._addNode(new Ra().addRenderTexture(mi,Ke.RGBA8)),this._anyRenderResultPostprocessAdded=!0,this._addNode(t)}}class Sr{constructor(t){o(this,"startProjectionMatrix");o(this,"endProjectionMatrix");o(this,"endOrtographic");o(this,"orthoFrustumSize");o(this,"alpha");o(this,"transitionFinished",!1);var e,i,n,s,a,l;this.endOrtographic=(e=t==null?void 0:t.endOrtographic)!=null?e:!1,this.orthoFrustumSize=(i=t==null?void 0:t.orthoFrustumSize)!=null?i:0,this.alpha=(n=t==null?void 0:t.alpha)!=null?n:0,this.startProjectionMatrix=(s=t==null?void 0:t.startProjectionMatrix)!=null?s:new pa,this.endProjectionMatrix=(a=t==null?void 0:t.endProjectionMatrix)!=null?a:new pa,this.transitionFinished=(l=t==null?void 0:t.transitionFinished)!=null?l:!1}}class ro extends Ot.ReactionSystem{constructor(){super(e=>e.hasAll(wt,en,Sr,qn));o(this,"entityAdded",({current:e})=>{const i=e.get(Sr),n=e.get(en);ro._computeProjectionMatrix(i.startProjectionMatrix,n,n.isPerspective),ro._computeProjectionMatrix(i.endProjectionMatrix,n,!i.endOrtographic,i.orthoFrustumSize),i.endOrtographic&&n.setOrthoFrustumSize(i.orthoFrustumSize)});o(this,"entityRemoved",({previous:e})=>{const i=e.get(Sr),n=e.get(en);n.isPerspective=!i.endOrtographic})}static updateProjectionMatricesForCamera(e,i=!1){const n=e.get(en),s=e.get(qn),a=e.get(Un);let l;const c=s.unjitteredProjectionMatrix;if(!i)if(l=e.get(Sr),l&&(l.alpha>=1||l.transitionFinished)&&(e.removeComponent(Sr),l=void 0),l)for(let d=0;d<16;d++)c.elements[d]=ki(l.alpha,0,1,l.startProjectionMatrix.elements[d],l.endProjectionMatrix.elements[d]);else ro._computeProjectionMatrix(c,n,n.isPerspective);s.unjitteredInvProjectionMatrix.copyFrom(c).invert();const h=s.projectionMatrix;if(a)if(!l)h.copyFrom(c),ro._applyJitter(n,n.isPerspective,h,a.jitterOffset);else{const d=new pa().copyFrom(l.startProjectionMatrix),u=l.endProjectionMatrix,f=a.jitterOffset;ro._applyJitter(n,n.isPerspective,d,f);for(let p=0;p<16;p++)h.elements[p]=ki(l.alpha,0,1,d.elements[p],u.elements[p])}else h.copyFrom(c)}static _computeProjectionMatrix(e,i,n,s){if(n)e.setPerspective(i.fov,i.aspect,i.near,i.far);else if(s){const a=i.aspect,l=s*a/-2,c=s*a/2,h=s/2,d=s/-2;e.setOrthographic(l,c,h,d,i.near,i.far)}else e.setOrthographic(i.left,i.right,i.top,i.bottom,i.near,i.far)}static _applyJitter(e,i,n,s){i?this._applyPerspectiveProjectionJitter(e,n,s):this._applyOrthographicProjectionJitter(e,n,s)}static _applyPerspectiveProjectionJitter(e,i,n){e.projectionJitterOffset.x=n.x/e.viewportSize.x,e.projectionJitterOffset.y=n.y/e.viewportSize.y,i.elements[8]+=e.projectionJitterOffset.x,i.elements[9]+=e.projectionJitterOffset.y}static _applyOrthographicProjectionJitter(e,i,n){const s=n.x/e.viewportSize.x,a=n.y/e.viewportSize.y;e.projectionJitterOffset.x=s*2,e.projectionJitterOffset.y=a*2;const l=e.right-e.left,c=e.top-e.bottom;i.makeOrthographic(e.left+s*l,e.right+s*l,e.top+a*c,e.bottom+a*c,e.near,e.far)}}const of=3;class m1{constructor(){o(this,"_values");o(this,"_endValueIndex",1);o(this,"_hasPendingValue",!0)}interpolate(t,e,i){const n=this._endValueIndex===0?of-1:this._endValueIndex-1;this._doInterpolate(t,this._values[n],this._values[this._endValueIndex],i,e)}}class af extends m1{constructor(t,e){super(),this._values=[this._cloneValue(t),this._cloneValue(e),this._cloneValue(e)]}setPendingValue(t){this._hasPendingValue=!0;const e=(this._endValueIndex+1)%of;this._values[e]=this._copyValue(this._values[e],t)}advance(){return this._hasPendingValue?(this._hasPendingValue=!1,this._endValueIndex=(this._endValueIndex+1)%of,!0):!1}apply(t,e){this._assign(t,this._values[this._endValueIndex],e)}_assign(t,e,i){t[i]=e}_cloneValue(t){return t}_copyValue(t,e){return e}}class _1 extends af{_doInterpolate(t,e,i,n,s){const a=n<.5?e:i;this._assign(t,a,s)}}class g1 extends af{_doInterpolate(t,e,i,n,s){const a=e+(i-e)*n;this._assign(t,a,s)}}class Fl extends af{_assign(t,e,i){t[i].copyFrom(e)}_cloneValue(t){return t.clone()}_copyValue(t,e){return t.copyFrom(e),t}}class v1 extends Fl{_doInterpolate(t,e,i,n,s){t[s].lerpVectors(e,i,n)}}class b1 extends Fl{_doInterpolate(t,e,i,n,s){t[s].lerpVectors(e,i,n)}}class y1 extends Fl{_doInterpolate(t,e,i,n,s){t[s].lerpVectors(e,i,n)}}class x1 extends Fl{_doInterpolate(t,e,i,n,s){const a=t[s];bi.slerp(e,i,a,n)}}class E1 extends Fl{_doInterpolate(t,e,i,n,s){t[s].lerpColors(e,i,n)}}const Qn=1e-5;class Ho{constructor(t){o(this,"_interpolatorConstructor");this._interpolatorConstructor=t}create(t,e){return new this._interpolatorConstructor(t,e)}}class A1 extends Ho{constructor(){super(_1)}approxEquals(t,e){return t===e}}class T1 extends Ho{constructor(){super(g1)}approxEquals(t,e){return Oi(t,e,Qn)}}class w1 extends Ho{constructor(){super(v1)}approxEquals(t,e){return Oi(t.x,e.x,Qn)&&Oi(t.y,e.y,Qn)}}class S1 extends Ho{constructor(){super(b1)}approxEquals(t,e){return Oi(t.x,e.x,Qn)&&Oi(t.y,e.y,Qn)&&Oi(t.z,e.z,Qn)}}class M1 extends Ho{constructor(){super(y1)}approxEquals(t,e){return Oi(t.x,e.x,Qn)&&Oi(t.y,e.y,Qn)&&Oi(t.z,e.z,Qn)&&Oi(t.w,e.w,Qn)}}const P1=1e-7;class C1 extends Ho{constructor(){super(x1)}approxEquals(t,e){const i=t.dot(e),n=1-i*i;return Oi(n,0,P1)}}class R1 extends Ho{constructor(){super(E1)}approxEquals(t,e){return Oi(t.r,e.r,Qn)&&Oi(t.g,e.g,Qn)&&Oi(t.b,e.b,Qn)}}const an=class an{static getPropertyFactory(t){if(typeof t=="object")return t instanceof ye?an._vector2Factory:t instanceof L?an._vector3Factory:t instanceof We?an._vector4Factory:t instanceof bi?an._quaternionFactory:t instanceof _e?an._colorFactory:an._nonLinearFactory;if(typeof t=="number")return an._numberFactory;if(typeof t=="boolean")return an._nonLinearFactory}};o(an,"_nonLinearFactory",new A1),o(an,"_numberFactory",new T1),o(an,"_vector2Factory",new w1),o(an,"_vector3Factory",new S1),o(an,"_vector4Factory",new M1),o(an,"_quaternionFactory",new C1),o(an,"_colorFactory",new R1);let lf=an;class I1{anyInterpolatorActive(){return!1}}class cf extends I1{constructor(e){super();o(this,"interpolatedObject");o(this,"interpolators",new Map);this.interpolatedObject=e}static createIfNeeded(e,i,n){let s=!1;for(const a in i)if(Object.prototype.hasOwnProperty.call(i,a)){const l=e[a],c=i[a],h=lf.getPropertyFactory(l);h.approxEquals(l,c)?n&&n.removeInterpolatorIfExists(a):(n||(n=new cf(e)),n.setPendingValueForProperty(l,c,a,h),s=!0)}return s?n:void 0}interpolate(e){for(const[i,n]of this.interpolators)n.interpolate(this.interpolatedObject,i,e)}anyInterpolatorActive(){return this.interpolators.size>0}applyPendingInterpolators(){for(const[e,i]of this.interpolators)i.advance()||(i.apply(this.interpolatedObject,e),this.interpolators.delete(e));return this.interpolators.size>0}setPendingValueForProperty(e,i,n,s){let a=this.interpolators.get(n);a?a.setPendingValue(i):(a=s.create(e,i),this.interpolators.set(n,a))}removeInterpolatorIfExists(e){this.interpolators.delete(e)}}class Ng extends Ot.ReactionSystem{constructor(){super(e=>e.hasAll(Ri));o(this,"doCleanup",!1)}update(){if(this.doCleanup){this.doCleanup=!1;for(let e=this.entities.length-1;e>=0;e--){const i=this.entities[e];i.get(Ri).componentInterpolators.size===0&&i.removeComponent(Ri)}}}}class Ia extends Ot.ReactionSystem{constructor(){super(e=>e.hasAll(Ri));o(this,"_anyEntityUpdated",!1);o(this,"_entityUpdateFlagSuppressed",!1);o(this,"entityAdded",()=>{this._entityUpdateFlagSuppressed||(this._anyEntityUpdated=!0)});ct.registerIfEnabled(this)}isAnyEntityUpdated(){return this._anyEntityUpdated}set suppressUpdateFlag(e){this._entityUpdateFlagSuppressed=e}applyPendingInterpolators(){for(const e of this.entities){const i=e.get(Ri);for(const[n,s]of i.componentInterpolators)s.applyPendingInterpolators()||i.componentInterpolators.delete(n)}this.engine.getSystem(Ng).doCleanup=!0}update(){const e=this.engine.sharedConfig.get(Zr).frameMetrics.simStateAlpha;this._anyEntityUpdated=this._anyEntityUpdated&&this.entities.length>0;for(const i of this.entities){const n=i.get(Ri);for(const s of n.componentInterpolators.values())s.interpolate(e)}}updateEntityState(e,i,n){let s=e.get(i);if(!n){s&&(e.removeComponent(i),e.has(Mt)&&!e.has(xi)&&e.addComponent(new xi));return}if(!s){s=new i(n),e.addComponent(s),e.has(Mt)&&!e.has(xi)&&e.addComponent(new xi),e.has(Ri)||e.add(new Ri);return}let a,l=e.get(Ri);l&&(a=l.componentInterpolators.get(s.constructor.name));const c=cf.createIfNeeded(s,n,a);c?(l||(l=new Ri,e.add(l)),l.componentInterpolators.set(s.constructor.name,c),i.name===Mt.name&&!e.has(xi)&&e.add(new xi)):a&&(a.anyInterpolatorActive()||l.componentInterpolators.delete(s.constructor.name))}onDebugUi(){ct.beginWindow("Updated entities",{x:1100,y:100},{x:400,y:800}),ImGui.Text("Count "+this.entities.length),ct.endWindow()}}class Kn extends Ot.ReactionSystem{constructor(){super(t=>t.hasAll(wt,en,qn,wr))}update(){const t=this.sharedConfig.get(Zr);t.frameFlags.isFlagEnabled(Nn.CUSTOM_RENDER)||Kn.updateCamera(t.camera,t.renderWorld.renderListsSystems)}getEntities(){return this.entities}static updateCamera(t,e){Kn.updateCameraMatrices(t),Kn.updateFrustumVisibility(t,e)}static updateFrustumVisibility(t,e){const i=t.get(wr),n=i.frustum;for(let s=0;s<eu;s++){const a=e[s].renderList,l=i.renderListsVisibility[s];l.clear();const c=a.getSortedList();let h=-1;for(const d of c){h++;const u=d.boundsComp;d.visible&&(!u||!u.frustumCulled||n.intersectsBox(u.wsBoundingBox))&&l.set(h,1)}}}static updateCameraMatrices(t,e=!1){ro.updateProjectionMatricesForCamera(t,e);const i=t.get(wt),n=t.get(qn),s=n.viewMatrix,a=n.invViewMatrix;a.compose(i.position,i.rotation,i.scale),s.copyFrom(a).invert();const l=n.unjitteredInvViewProjMatrix,c=n.unjitteredInvProjectionMatrix;l.copyFrom(a).multiply(c);const h=n.projectionMatrix;new Ue().copyFrom(h).invert(),n.viewProjMatrix.copyFrom(h).multiply(s);const u=n.unjitteredProjectionMatrix,f=n.unjitteredViewProjMatrix;f.copyFrom(u).multiply(n.viewMatrix),t.get(wr).frustum.setFromMatrix(f)}}class Vn extends Ot.ReactionSystem{constructor(){super(t=>t.hasAll(wt,en,Dn,qn,Un))}update(){const t=this.sharedConfig.get(Zr);t.camera&&t.camera.has(Un)&&Vn.updateTemporalMatricesAndParameters(t.renderWorld.isStaticTaaApplicable(t),t.camera)}static resetFramesTillStaticTaaHistoryWeight(t){const e=t.get(Un);if(!e)return;const i=t.get(Dn).temporalAaConfig;e.resetFramesTillStaticTaaHistoryWeight(i.dynamicWeightFramesCount)}static resetTaaAccumulation(t){const e=t.get(Un);e&&e.requestTaaAccumulationReset()}static isTaaAccumulatingSamples(t){const e=t.get(Un);return e?!e.isTaaAccumulated():!1}static updateTemporalMatricesAndParameters(t,e){const i=e.get(qn),n=e.get(Un),s=e.get(Dn).temporalAaConfig;n.prevCameraPosition.copyFrom(e.get(wt).position),n.unjitteredPrevViewProjMatrix.copyFrom(i.unjitteredProjectionMatrix),n.unjitteredPrevViewProjMatrix.multiply(i.viewMatrix),n.updateTemporalAaParams(t,s)}}var Ug=(r=>(r.REQUEST_PIPELINE_RELOAD="requestPipelineReload",r))(Ug||{});class Mh extends ci{}o(Mh,"eventType",Ug);class tr extends Ot.ReactionSystem{constructor(){super(e=>e.hasAll(wt,en,qn,Dn));o(this,"cameraPostprocessEvents",new Mh);o(this,"entityAdded",({current:e})=>{tr.configureCameraTemporalComponent(e)})}static configureCameraTemporalComponent(e){const i=e.get(Dn).isTaaEnabled();i&&!e.has(Un)?e.add(new Un):!i&&e.has(Un)&&e.removeComponent(Un)}handlePostprocessParamsChange(e,i,n=!1){const s=e.get(Dn),a=s.antialiasingType!==i.antialiasingType,l=s.motionBlurConfig.enabled!==i.motionBlurConfig.enabled||a;s.copyFrom(i),(a||n)&&(tr.configureCameraTemporalComponent(e),Vn.resetFramesTillStaticTaaHistoryWeight(e),Vn.resetTaaAccumulation(e)),l&&this.cameraPostprocessEvents.dispatchEvent({type:"requestPipelineReload",camera:e}),e.has(Ri)||e.add(new Ri)}}class D1 extends Ot.ReactionSystem{constructor(){super(e=>e.hasAll(wt,en,Dn,kn));o(this,"entityAdded",({current:e})=>{const i=e.get(kn).object3D;i.addEventListener(At.eventType.UPDATED,this._onCameraUpdated),i.addEventListener(At.eventType.EXPOSURE_UPDATED,this._onExposureUpdated),i.addEventListener(At.eventType.GAMMA_UPDATED,this._onPostprocessParamsUpdated),i.addEventListener(At.eventType.COLOR_MAP_UPDATED,this._onPostprocessParamsUpdated),i.addEventListener(At.eventType.TONE_MAPPING_UPDATED,this._onPostprocessParamsUpdated),i.addEventListener(At.eventType.MOTION_BLUR_UPDATED,this._onPostprocessParamsUpdated),i.addEventListener(At.eventType.POSITION_CHANGED,this._onCameraPositionChanged),i.addEventListener(At.eventType.ROTATION_CHANGED,this._onCameraRotationChanged)});o(this,"entityRemoved",({previous:e})=>{const i=e.get(kn).object3D;i.removeEventListener(At.eventType.UPDATED,this._onCameraUpdated),i.removeEventListener(At.eventType.EXPOSURE_UPDATED,this._onExposureUpdated),i.removeEventListener(At.eventType.GAMMA_UPDATED,this._onPostprocessParamsUpdated),i.removeEventListener(At.eventType.COLOR_MAP_UPDATED,this._onPostprocessParamsUpdated),i.removeEventListener(At.eventType.TONE_MAPPING_UPDATED,this._onPostprocessParamsUpdated),i.removeEventListener(At.eventType.MOTION_BLUR_UPDATED,this._onPostprocessParamsUpdated),i.removeEventListener(At.eventType.POSITION_CHANGED,this._onCameraPositionChanged),i.removeEventListener(At.eventType.ROTATION_CHANGED,this._onCameraRotationChanged),i.entityId=-1});o(this,"_onCameraUpdated",e=>{const i=e.target,n=this.engine.getEntityById(i.entityId),s={};rh.updateProjectionFromCamera(s,i),this.engine.getSystem(Ia).updateEntityState(n,en,s),this.engine.getSystem(tr).handlePostprocessParamsChange(n,i.postprocessComp)});o(this,"_onCameraPositionChanged",e=>{const i=e.target,n=this.engine.getEntityById(i.entityId),s=this.engine.getSystem(Ia),a=e.newPosition;s.updateEntityState(n,wt,{position:a});const l=this.engine.getSystem(Th).getEntities();for(const c of l)s.updateEntityState(c,wt,{position:a})});o(this,"_onCameraRotationChanged",e=>{const i=e.target,n=this.engine.getEntityById(i.entityId),s=this.engine.getSystem(Ia);s.updateEntityState(n,wt,{rotation:e.newRotation});const a=this.engine.getSystem(Th).getEntities();for(const l of a)s.updateEntityState(l,wt,{rotation:e.newRotation})});o(this,"_onPostprocessParamsUpdated",e=>{const i=e.target,n=this.engine.getEntityById(i.entityId);this.engine.getSystem(tr).handlePostprocessParamsChange(n,i.postprocessComp)});o(this,"_onExposureUpdated",e=>{const i=e.target,s=this.engine.getEntityById(i.entityId).get(Dn);s.filmicConfig.exposure=i.postprocessComp.filmicConfig.exposure})}}class L1{constructor(t){o(this,"nextTasks",new Set);o(this,"remainingDependentTasks",0);o(this,"renderNode");this.renderNode=t}}class O1{constructor(){o(this,"_renderNodesToTasks",new Map);o(this,"_tasks",new Array);o(this,"_renderNodesInOrder",new Array);o(this,"_portsToMaxResultsRequests",new Map)}getRenderNodes(){return this._renderNodesInOrder}getPortsToMaxResultsRequests(){return this._portsToMaxResultsRequests}rebuildDependencies(t){this._renderNodesInOrder=new Array,this._portsToMaxResultsRequests=new Map,this._renderNodesToTasks=new Map,this._tasks=new Array,t.nextFlowNode,this._buildOutput(t);const e=new Array;for(const i of this._tasks)i.remainingDependentTasks===0&&e.push(i);e.length>0;for(const i of e)this._addToOrder(i)}_getTask(t){return this._renderNodesToTasks.get(t)}_addDependency(t,e){const i=this._getTask(t),n=this._getTask(e);n.nextTasks.has(i),i.nextTasks.has(n)||(i.nextTasks.add(n),n.remainingDependentTasks++)}_tryToRegisterNode(t){if(!this._renderNodesToTasks.has(t)){const e=new L1(t);this._renderNodesToTasks.set(t,e),this._tasks.push(e);for(const i of t.getInputs())this._portsToMaxResultsRequests.set(i,0);for(const i of t.getOutputs())this._portsToMaxResultsRequests.set(i,0);return!0}return!1}_buildInput(t,e){console.assert(t.getInputs().includes(e),"Invalid port used!");for(const i of e.connectedPorts){const n=i.parentNode;this._buildOutput(n,i,t)}this._portsToMaxResultsRequests.set(e,e.connectedPorts.length)}_buildOutput(t,e,i){if(this._tryToRegisterNode(t)){i&&this._addDependency(t,i),t.prevFlowNode&&(this._buildOutput(t.prevFlowNode,void 0,void 0),this._addDependency(t.prevFlowNode,t));for(const n of t.getInputs())this._buildInput(t,n);t.nextFlowNode&&(this._buildOutput(t.nextFlowNode,void 0,void 0),this._addDependency(t,t.nextFlowNode))}if(e){const n=this._portsToMaxResultsRequests.get(e);this._portsToMaxResultsRequests.set(e,n+1)}}_addToOrder(t){this._renderNodesInOrder.includes(t.renderNode),this._renderNodesInOrder.push(t.renderNode);for(const e of t.nextTasks)--e.remainingDependentTasks===0&&this._addToOrder(e)}}class F1{constructor(t){o(this,"resourcesEnv");o(this,"unusedRenderTextures",new Map);o(this,"keysToRenderTargets",new Map);this.resourcesEnv=t}getRenderTarget(t){let e="",i=0;for(const s of t)e+=`${i++}:${s.get()?s.get().descriptor.textureId:0}:`;let n=this.keysToRenderTargets.get(e);if(!n){const s=this.resourcesEnv.renderTargetManager,a=new ju(t,s.getUniqueRenderTargetId());n=this.resourcesEnv.getResource(a),n.get(),this.keysToRenderTargets.set(e,n)}return n.clone()}getRenderTexture(t){const e=this._getParamsHash(t),i=this.unusedRenderTextures.get(e);return i&&i.length>0?i.pop():this.createRenderTexture(t,e)}unuseRenderTexture(t){if(!t.get())return;const e=this._getParamsHash(t.get().descriptor.getCreatedTextureParams()),i=this.unusedRenderTextures.get(e);i.includes(t),i.push(t.clone())}createRenderTexture(t,e){const i=this.resourcesEnv.textureManager.createTexture(t);return e=e!=null?e:this._getParamsHash(t),this.unusedRenderTextures.has(e)||this.unusedRenderTextures.set(e,[]),i}unloadAllRenderTargets(){for(const t of this.unusedRenderTextures.values())for(const e of t)e.set(void 0,this.resourcesEnv);this.unusedRenderTextures.clear();for(const t of this.keysToRenderTargets.values())t.set(void 0,this.resourcesEnv);this.keysToRenderTargets.clear()}_getParamsHash(t){const e=t;return""+e.format+e.generateMipmaps+e.width+e.height}}class B1{constructor(t){o(this,"_current",0);this.reset(t)}decrement(){return this._current>=0,this._current===0}reset(t){this._current=t}}class N1{constructor(t){o(this,"portsToRenderResults",new Map);o(this,"requestCounters");o(this,"resourcesEnv");this.resourcesEnv=t}resetRequestCounters(t){this.requestCounters=new Map;for(const[e,i]of t)this.requestCounters.set(e,new B1(i))}setResult(t,e){const i=this.portsToRenderResults.get(t);i&&i.unloadResource(this.resourcesEnv),this.portsToRenderResults.set(t,e)}acquirePortResult(t,e,i,n=!0){let s=this.portsToRenderResults.get(e);if(s&&s.constructor!==i){`${s.constructor}${i}`;return}if(s===void 0&&(e.parentNode.acquireResources(e,t),s=this.portsToRenderResults.get(e),s.constructor!==i)){`${s.constructor}${i}`;return}return this.requestCounters.has(e),this.requestCounters.get(e).decrement(),s}unloadAll(t){for(const e of this.portsToRenderResults.values())e.unloadResource(t);this.portsToRenderResults.clear()}}class U1{constructor(t,e){o(this,"resourcesEnv");o(this,"_rtResources");o(this,"_frameRenderResults");o(this,"_graphDependencyBuilder");o(this,"_currentSize",new ye(0,0));this.resourcesEnv=e,this._rtResources=new F1(e),this._frameRenderResults=new N1(e),this._graphDependencyBuilder=new O1,this._graphDependencyBuilder.rebuildDependencies(t)}onResize(t){if(this._currentSize.equals(t))return;this._currentSize.copyFrom(t),this.unloadRenderNodesResources();const e=this._graphDependencyBuilder.getRenderNodes();for(const i of e)i.build(this)}unloadRenderNodesResources(){const t=this._graphDependencyBuilder.getRenderNodes();for(const e of t)e.unloadResources(this);this._frameRenderResults.unloadAll(this.resourcesEnv),this._rtResources.unloadAllRenderTargets(),this.resourcesEnv.update(),this._frameRenderResults.resetRequestCounters(this._graphDependencyBuilder.getPortsToMaxResultsRequests())}getViewportSize(){return this._currentSize.x>0&&this._currentSize.y>0,this._currentSize}getOrderedNodesToRender(){return this._graphDependencyBuilder.getRenderNodes().filter(t=>t.isRenderCallRequired())}assignResultToPort(t,e){this._frameRenderResults.setResult(t,e)}getPortResult(t){return this._frameRenderResults.portsToRenderResults.get(t)}requestConnectedResultAs(t,e){return this._frameRenderResults.acquirePortResult(this,t.getConnectedPort(),e,!0)}requestConnectedResult(t){const e=t.getConnectedPort();return this._frameRenderResults.acquirePortResult(this,e,e.resultType,!1)}getRenderTexture(t){return this._rtResources.getRenderTexture(t)}getRenderTarget(t){return this._rtResources.getRenderTarget(t)}unuseRenderTexture(t){this._rtResources.unuseRenderTexture(t)}getScreenRenderTarget(){return this._rtResources.getRenderTarget([])}requestRenderTarget(t,e=!0){const i=e?t.getOutputs():t.getInputs(),n=new Array;for(const l of i){const c=this.requestConnectedResult(l);c&&n.push(c)}n.length>0;const s=n[0].getResourceAs(xh);if(s){for(const l of n)l.getResourceAs(xh);return new Kt(s)}const a=new Array;for(const l of n){const c=l.getResourceAs(bl);a.push(new Kt(c))}return this._rtResources.getRenderTarget(a)}}var k1=Object.defineProperty,V1=Object.getOwnPropertyDescriptor,z1=(r,t,e,i)=>{for(var n=i>1?void 0:i?V1(t,e):t,s=r.length-1,a;s>=0;s--)(a=r[s])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&k1(t,e,n),n};class kg{constructor(t,e){o(this,"_renderNodes");o(this,"_renderGraphDebugger");this._renderNodes=t,this._renderGraphDebugger=e}render(t){for(const e of this._renderNodes)In.setDebugMarker(e.nodeName),e.isRenderCallRequired()&&(mt.beginSection(e.nodeName),e.render(t),mt.endSection(e.nodeName),this._renderGraphDebugger&&this._renderGraphDebugger.captureRenderNodeResults(e)),In.clearDebugMarker()}}z1([Vt({name:"Render Command List"})],kg.prototype,"render",1);class G1{constructor(){o(this,"inputs",new Map);o(this,"outputs",new Map)}clear(t){for(const e of this.inputs.values())e.set(void 0,t);this.inputs.clear();for(const e of this.outputs.values())e.set(void 0,t);this.outputs.clear()}}class H1{constructor(t){o(this,"_renderNodesDebug",new Map);o(this,"_renderTargetDebugScale",.2);o(this,"_captureEnabled",!1);o(this,"_debugCaptureRenderNode");o(this,"_resourcesEnv");o(this,"_frameBuilder");this._frameBuilder=t,this._resourcesEnv=t.resourcesEnv,this._debugCaptureRenderNode=new l1(this._resourcesEnv),ct.registerIfEnabled(this)}startDebugCapture(){this._captureEnabled=!0}captureRenderNodeResults(t){let e=this._renderNodesDebug.get(t);e||(e=new G1,this._renderNodesDebug.set(t,e));for(const i of t.getInputs())this._capturePortResult(i,!0,e);for(const i of t.getOutputs())this._capturePortResult(i,!1,e)}_capturePortResult(t,e,i){var c;let n,s=[0,0];const a=t.getConnectedPort(),l=a?this._frameBuilder.getPortResult(a):void 0;if(l){const h=l.getResourceAs(bl);h&&(n=h.texture,s=[h.descriptor.width,h.descriptor.height])}if(n){s[0]*=this._renderTargetDebugScale,s[1]*=this._renderTargetDebugScale;const h=e?i.inputs:i.outputs;let d=(c=h.get(t))!=null?c:void 0;if(d){const u=d.get().getSize();(u[0]!==s[0]||u[1]!==s[1])&&d.set(void 0,this._resourcesEnv)}if(!d||!d.get()){const u=new Ar(s[0],s[1]),f=this._frameBuilder.getRenderTexture(u);d=this._frameBuilder.getRenderTarget([f]),h.set(t,d)}this._debugCaptureRenderNode.capture(n,d.get().framebuffer,this._resourcesEnv)}}endDebugCapture(){this._captureEnabled=!1}onDebugUi(){ct.beginWindow("Frame graph",{x:500,y:50},{x:450,y:600}),ImGui.Button(this._captureEnabled?"Stop capturing":"Start capturing")&&(this._captureEnabled=!this._captureEnabled);let t=0;for(const e of this._renderNodesDebug){ImGui.PushID(t++);const i=e[1];ImGui.CollapsingHeader(`${e[0].nodeName} ins: ${i.inputs.size} outs: ${i.outputs.size} `)&&(this._imguiTextureTable("Inputs",i.inputs),this._imguiTextureTable("Outputs",i.outputs)),ImGui.PopID()}ct.endWindow()}_imguiTextureTable(t,e){if(e.size!==0){ImGui.BeginTable(t,e.size,ImGui.TableFlags.Borders|ImGui.TableFlags.SizingFixedFit),ImGui.TableNextRow();for(const i of e){ImGui.TableNextColumn();const n=i[1].get();let s=i[0].resultType.name;i[0].shaderVariable&&(s+=` : ${i[0].shaderVariable.name}`),ImGui.Text(s);const a=n.getSize();ImGui.Image(n.textureRefs[0].get().texture,new ImGui.Vec2(a[0],a[1]),new ImGui.Vec2(0,1),new ImGui.Vec2(1,0))}ImGui.EndTable()}}}class Bl{constructor(t,e){o(this,"_renderWorld");o(this,"_renderCommandList");o(this,"_renderGraphRootNode");o(this,"_renderParamsName");o(this,"_frameConfigArgs");o(this,"_frameInfo");o(this,"_frameBuilder");this._renderWorld=t.renderWorld,this._frameConfigArgs=t,this._renderParamsName=e.name;const i=n=>{n.type===Mh.eventType.REQUEST_PIPELINE_RELOAD&&n.camera===this._frameInfo.camera&&this.reload()};this._renderWorld.ecs.getSystem(tr).cameraPostprocessEvents.addEventListener(Mh.eventType.REQUEST_PIPELINE_RELOAD,i)}onResize(t){if(!this._renderGraphRootNode)return;const e=this._frameInfo.camera.get(en);e.viewportSize=t,this._frameInfo.viewport.set(0,0,t.x,t.y),this._frameBuilder.onResize(t),Vn.resetTaaAccumulation(this._frameInfo.camera)}get frameInfo(){return this._frameInfo}get camera(){return this._frameInfo.camera}set camera(t){this._frameInfo=new Zr(t,this._frameConfigArgs)}get postprocessComp(){return this._frameConfigArgs.postprocessComp}load(){this._renderGraphRootNode=this._createRenderGraph(),this._frameBuilder=new U1(this._renderGraphRootNode,this._frameInfo.resourcesEnv);const e=this._frameInfo.frameFlags.isFlagEnabled(Nn.DEBUG_CAPTURE)?new H1(this._frameBuilder):void 0;this._renderCommandList=new kg(this._frameBuilder.getOrderedNodesToRender(),e)}unload(){this._renderGraphRootNode&&(this._renderGraphRootNode=void 0,this._frameBuilder.unloadRenderNodesResources(),this._frameBuilder=void 0,this._renderCommandList=void 0)}reload(){this.unload(),this.load(),this.onResize(this._frameInfo.camera.get(en).viewportSize)}get renderParamsName(){return this._renderParamsName}updateResources(){this._frameInfo.resourcesEnv.update()}_runRenderCommandList(){this._renderCommandList&&(this._renderCommandList.render(this._frameInfo),this._frameInfo.frameMetrics.renderedFramesCounter++)}}class hf extends Gi{constructor(e=_e.BLACK,i=new We(0,0,0,0)){super("PrepareRender");o(this,"renderTarget",new Kt);o(this,"_clearColor");o(this,"_clearMask",new ua(Js.ALL));o(this,"_oldClearColor");this._clearColor=i,this._oldClearColor=e,this.addOutputPort(mi),this.addOutputPort(Xn)}set clearColor(e){T.DEV_NEW_PIPELINE_STATES,this._clearColor=e}build(e){this.renderTarget=e.requestRenderTarget(this)}render(e){e.frameFlags.isFlagEnabled(Nn.MANUAL_RENDER_STATE_RESET)||e.sharedState.resetState(),e.sharedState.updateAndBindGlobalUniformData(e),e.sharedState.updateCameraUniformData(e),e.frameMetrics.animatedMaterialVisible=!1;const i=e.resourcesEnv.renderContext,n=e.webGLRenderer;this.renderTarget.get().bind(i,n,e.viewport),T.DEV_NEW_PIPELINE_STATES?(e.sharedState.bindForRenderTargetClear(this._clearMask),i.clear(this._clearColor,this._clearMask)):(n.state.setDepthTest(!0),n.state.setDepthWrite(!0),n.state.setColorWrite(!0),n.setClearColor(this._oldClearColor,0),n.clearDepth(),n.clearColor(),n.clearStencil(),n.resetCaching())}}class W1 extends Ll{constructor(){super(xt.GRASS,"Grass pass");o(this,"_dataUploadHelper",new qu);o(this,"_dataBuffer");o(this,"_dataView");this._dataBuffer=new ArrayBuffer(Zs),this._dataView=new DataView(this._dataBuffer)}renderDrawCall(e,i){e.activeMaterial instanceof al;const n=e.activeMaterial,s=Vi[oe.OBJECT],a=e.getShader().uniformBlockDescriptors.get(s),l=e.perObjectUniformBuffer;for(let c=0;c<n.renderSteps;c++){const h=n.grassHeight/n.renderSteps*c;this._dataUploadHelper.grassOffsetScaled=h*n.grassScale,this._dataUploadHelper.currentStep=c;for(const d in this._dataUploadHelper)if(Object.prototype.hasOwnProperty.call(this._dataUploadHelper,d)){const u=a.uniforms.get(d);this._dataView.setFloat32(0,Dc(this._dataUploadHelper,d),!0),l.uploadSubdataToGPU(this._dataView,u.blockOffset,i.gl)}super.renderDrawCall(e,i)}}}class df extends Sh{constructor(){super("SceneRender");o(this,"prepareRenderNode",new hf);this.setNodesSequence([this.prepareRenderNode,new Ll(xt.OPAQUE,"Opaque pass"),new Ll(xt.SKY,"Sky pass"),new W1,new d1])}render(e){e.webGLRenderer.getTextureSlotter().freeAllSlots(),e.sharedState.renderContext.bindVao(void 0)}}class j1 extends Bg{constructor(){super(...arguments);o(this,"_webglRenderTarget")}setWebGLRenderTarget(e){this._webglRenderTarget=e}_acquireRenderTarget(e){const i=e.resourcesEnv.renderTargetManager;return this._webglRenderTarget,i.getResourceForWebGlRenderTarget(this._webglRenderTarget)}}class X1 extends Bl{constructor(e){super(e,$p);o(this,"_renderTargetNode")}_createRenderGraph(){return this._renderTargetNode=new j1([mi,Xn]),new Ol().build(this._frameInfo,new df,[this._renderTargetNode])}render(e){const i=this._frameInfo.camera,n=i.get(wt);n.position.copyFrom(e.position);const s=i.get(en);s.near=e.near,s.far=e.far,s.fov=90;const a=e.renderTarget;this._renderTargetNode.setWebGLRenderTarget(a);const l=new ye(a.width,a.height);this.onResize(l),this._frameInfo.resourcesEnv.renderContext.setViewport(this._frameInfo.viewport),this._renderWorld.update(this._frameInfo);const c=e.dumpDebugName?new uh(this._frameInfo.viewport):void 0;for(let h=0;h<6;h++)n.rotation.copyFrom(Eh.getRotationForFace(h)),Kn.updateCamera(this._frameInfo.camera,this._renderWorld.renderListsSystems),a.activeCubeFace=h,this._runRenderCommandList(),c&&(this._frameInfo.resourcesEnv.renderContext.readPixels(c),Lc(Wc(l.x,l.y,c.pixelBuf),`${e.dumpDebugName}_${h}.tga`))}}class Nl{constructor(t=_e.WHITE){o(this,"color");this.color=t}}class q1 extends Gi{constructor(e){super("Luma pass");o(this,"_overridenDrawCall",new qr);o(this,"_colorBufferUpdater");o(this,"_renderTarget",new Kt);o(this,"renderIncidentLuma",!1);o(this,"renderListVisibility");const i=e.renderWorld.scene.sharedMaterialState,n=new Zd(!1,i),s=new Tr(n,["vec4 fragColor"],void 0,[Nl]);this._overridenDrawCall.setMaterial(e.resourcesEnv,s);const a=Vi[oe.OBJECT],l=this._overridenDrawCall.getShader().uniformBlockDescriptors.get(a);this._colorBufferUpdater=new mh(e.resourcesEnv.renderContext,l,new Nl),this._overridenDrawCall.perObjectUniformBuffer=this._colorBufferUpdater.uniformBuffer,this.addOutputPort(mi),this.addOutputPort(Xn)}build(e){this._renderTarget=e.requestRenderTarget(this)}unloadResources(e){this._renderTarget.set(void 0,e.resourcesEnv)}render(e){var d;if(!this._renderTarget.get())return;const i=e.resourcesEnv.renderContext,n=e.webGLRenderer;this._renderTarget.get().bind(i,n,e.viewport);const s=e.sharedState,a=this._overridenDrawCall;s.bindMaterial(a.activeMaterial,a.renderMaterial.get(),e.webGLRenderer),s.bindCameraUniformData(!1),e.resourcesEnv.renderContext.bindUniformBuffer(mr[oe.OBJECT],this._colorBufferUpdater.uniformBuffer.glBuffer),this.renderIncidentLuma&&(this._colorBufferUpdater.data.color=_e.WHITE,this._colorBufferUpdater.uploadData(e.resourcesEnv.renderContext));const l=(d=this.renderListVisibility)!=null?d:e.camera.get(wr).renderListsVisibility,h=e.renderWorld.renderListsSystems[xt.OPAQUE].renderList;this.renderDrawCallList(h,l[xt.OPAQUE],e)}renderDrawCallList(e,i,n){var h,d;if(i.msb()===1/0)return;const a=n.resourcesEnv.renderContext,l=e.getSortedList();let c=-1;for(const u of l)c++,i.get(c)&&(this.renderIncidentLuma||(this._colorBufferUpdater.data.color=u.activeMaterial.baseColor,this._colorBufferUpdater.uploadData(a)),n.sharedState.bindLightingData((d=(h=u.lightDataBinding)==null?void 0:h.get())!=null?d:void 0),a.bindVao(u.mesh.get().vao),u.render(a))}}class uf extends Gi{constructor(){super("RenderResultAcquireNode");o(this,"readResult");o(this,"_renderTarget",new Kt);this.addInputPort(mi)}build(e){this._renderTarget=e.requestRenderTarget(this,!1)}render(e){if(this.readResult){const i=e.resourcesEnv.renderContext,n=e.webGLRenderer;this._renderTarget.get().bind(i,n,e.viewport),i.readPixels(this.readResult)}}unloadResources(e){this._renderTarget.set(void 0,e.resourcesEnv)}}class Y1 extends Bl{constructor(e){super(e,em);o(this,"_lumaNode");o(this,"_renderResultNode")}_createRenderGraph(){const e=new hf;this._lumaNode=new q1(this._frameInfo);const i=new Sh("Entities render");return i.setNodesSequence([e,this._lumaNode]),this._renderResultNode=new uf,new Ol().build(this.frameInfo,i,[new Ra().addRenderTexture(mi,H.RGBA8).addRenderTexture(Xn,H.DEPTH_COMPONENT24),this._renderResultNode])}render(e){const i=this._frameInfo,n=i.camera,s=n.get(wt);s.position.copyFrom(e.cameraPosition),s.rotation.copyFrom(e.cameraRotation),n.addComponent(e.projectionComp),this.onResize(e.projectionComp.viewportSize);const a=this._frameInfo.resourcesEnv.renderContext.gl;e.debugSpectorCapture&&In.startCapture(a),this._lumaNode.renderIncidentLuma=e.renderIncidentLuma,this._renderWorld.update(i),Kn.updateCameraMatrices(n),Kn.updateFrustumVisibility(n,i.renderWorld.renderListsSystems);const l=new uh(i.viewport,e.asyncCallback,e.resultBuffer);this._renderResultNode.readResult=l,this._runRenderCommandList(),this._renderResultNode.readResult=void 0,e.resultBuffer=l.pixelBuf,e.debugSpectorCapture&&(e.debugSpectorCapture=!1,In.stopCapture())}}class Q1 extends Gi{constructor(){super("Entities render node");o(this,"_renderPasses");o(this,"_overridenDrawCall",new qr);o(this,"_overridenPerObjectUpdaters");o(this,"_renderTarget",new Kt);o(this,"_perObjectTransferBuffer");this.addOutputPort(mi),this.addOutputPort(Xn)}setOverrideMaterial(e,i,n){if(this._overridenDrawCall.setMaterial(e,i),this._overridenPerObjectUpdaters=n,this._overridenPerObjectUpdaters){this._overridenDrawCall.usesPerObjectBuffer;const s=Vi[oe.OBJECT],l=this._overridenDrawCall.getShader().uniformBlockDescriptors.get(s);this._perObjectTransferBuffer=new ph(l),this._overridenDrawCall.perObjectUniformBuffer=new Ta(e.renderContext.gl)}else this._overridenDrawCall.perObjectUniformBuffer&&(this._overridenDrawCall.perObjectUniformBuffer.unload(e.renderContext.gl),this._overridenDrawCall.perObjectUniformBuffer=void 0,this._perObjectTransferBuffer=void 0)}setRenderPassesToRender(e){this._renderPasses=e}build(e){this._renderTarget=e.requestRenderTarget(this)}unloadResources(e){this._renderTarget.set(void 0,e.resourcesEnv)}render(e){if(!this._renderPasses||!this._renderTarget.get())return;const i=e.resourcesEnv.renderContext,n=e.webGLRenderer;this._renderTarget.get().bind(i,n,e.viewport);const s=i.gl,a=this._overridenDrawCall,l=a.activeMaterial.doNotOverrideSide,c=e.camera.get(wr).renderListsVisibility;for(const h of this._renderPasses){const u=e.renderWorld.renderListsSystems[h].renderList.getSortedList(),f=c[h];if(f.msb()===1/0)continue;let m=-1;for(const b of u)if(m++,!!f.get(m)){if(a.mesh=b.mesh,a.lightDataBinding=b.lightDataBinding,this._overridenPerObjectUpdaters){for(const g of this._overridenPerObjectUpdaters)g.updateData(b.entity,this._perObjectTransferBuffer);a.perObjectUniformBuffer.uploadBufferToGpu(this._perObjectTransferBuffer.dataView,s)}e.sharedState.bindDrawCall(a,n),T.DEV_NEW_PIPELINE_STATES&&l&&i.setCullFace(b.activeMaterial.side),a.render(i)}}T.DEV_NEW_PIPELINE_STATES&&l&&i.setCullFace(a.activeMaterial.side)}}class Ph extends Bl{constructor(e){super(e,Zp);o(this,"_perObjectIdUpdater");o(this,"_dataTransferHelper",new Dg);o(this,"_materialOverrideNode");o(this,"_renderResultNode");this._perObjectIdUpdater=new m_(Dg,i=>(this._dataTransferHelper.objectId.value=i.id,this._dataTransferHelper))}load(){super.load();const e=T.OBJECT_VISIBILITY_TARGET_SIZE;this.onResize(new ye(e,e))}_createRenderGraph(){this._materialOverrideNode=new Q1,this._renderResultNode=new uf;const e=new hf;e.clearColor=new We(1,1,1,0);const i=new Sh("Object visibility render");return i.setNodesSequence([e,this._materialOverrideNode]),new Ol().build(this.frameInfo,i,[new Ra().addRenderTexture(mi,H.RGBA8).addRenderTexture(Xn,H.DEPTH_COMPONENT24),this._renderResultNode])}static _decodeInt(e,i){return Math.round(e[i]*256*256+e[i+1]*256+e[i+2])}static _getObjectsIdFromBuffer(e,i){const n=e.length;for(let s=0;s<n;s+=4){const a=Ph._decodeInt(e,s);a!==16777215&&i.add(a)}}render(e){const i=this._frameInfo,n=i.camera,s=n.get(wt);s.position.copyFrom(e.position);const a=n.get(en);a.near=e.near,a.far=e.far,a.fov=90;const l=new Array;l.push(this._perObjectIdUpdater),e.visibilityMaterial;const c=new Tr(e.visibilityMaterial,["vec4 fragColor"],void 0,l.map(u=>u.getDataConstructorType()));this._renderWorld.update(i);const h=new Set,d=new uh(i.viewport);this._materialOverrideNode.setOverrideMaterial(i.resourcesEnv,c,l);for(let u=0;u<6;u++)s.rotation.copyFrom(Eh.getRotationForFace(u)),Kn.updateCamera(i.camera,this._renderWorld.renderListsSystems),i.sharedState.resetState(),i.sharedState.updateAndBindGlobalUniformData(i),i.sharedState.updateCameraUniformData(i),i.sharedState.bindCameraUniformData(!0),this._renderResultNode.readResult=d,this._materialOverrideNode.setRenderPassesToRender([xt.OPAQUE,xt.TRANSPARENT]),this._runRenderCommandList(),this._renderResultNode.readResult=void 0,Ph._getObjectsIdFromBuffer(d.pixelBuf,h);e.visibleObjects=new Array;for(const u of h){const f=this._renderWorld.ecs.getEntityById(u);e.visibleObjects.push(f.get(kn).getObjectAs(je))}}}class K1{constructor(){o(this,"uImGuiProjMatrix",new Ue)}}const fo=class fo extends Gi{constructor(e){super("ImGui");o(this,"_vertexArrayObject");o(this,"_vertexBuffer");o(this,"_indexBuffer");o(this,"_colorBinding");o(this,"_renderTarget",new Kt);o(this,"_renderMaterial");const i=new bt({vsName:"imgui_vertex.glsl",fsName:"imgui_fragment.glsl",vertexAttributes:fo._getVertexAttributes(),uniformBufferData:new K1});i.depthWrite=!1,i.depthTest=!1,i.side=Ti.BACK,i.addDefine("DEV_NEW_RENDER_ARCHITECTURE"),i.blending=Yt.NORMAL;const n="tColor";this.addOutputPort(mi,{type:"vec4",name:"fragColor"});const s=new Tr(i,["vec4 fragColor"],[`sampler2D ${n}`]);this._renderMaterial=e.getResource(s);const l=this._renderMaterial.get().shader.get().getSamplerUniform(n);this._colorBinding=l.binding}static _getVertexAttributes(){return fo._vertexAttributes||(fo._vertexAttributes=[{name:"position",type:H.FLOAT,itemCount:2,index:0,vertexOffset:ImGui.DrawVertPosOffset,stride:ImGui.DrawVertSize},{name:"color",type:H.UNSIGNED_BYTE,itemCount:4,index:1,vertexOffset:ImGui.DrawVertColOffset,normalized:!0,stride:ImGui.DrawVertSize},{name:"uv0",type:H.FLOAT,itemCount:2,index:2,vertexOffset:ImGui.DrawVertUVOffset,stride:ImGui.DrawVertSize}]),fo._vertexAttributes}build(e){this._renderTarget=e.requestRenderTarget(this)}_createVao(e){var i;this._vertexArrayObject,this._vertexArrayObject=e.createAndBindVao(),this._vertexBuffer=e.createBuffer(),e.bindBuffer(e.gl.ARRAY_BUFFER,this._vertexBuffer);for(const n of fo._getVertexAttributes())e.setupVertexAttribute(n.index,n.itemCount,n.type,(i=n.vertexOffset)!=null?i:0,0,n.normalized,n.stride);this._indexBuffer=e.createBuffer(),e.bindBuffer(e.gl.ELEMENT_ARRAY_BUFFER,this._indexBuffer),e.bindVao(void 0)}unloadResources(e){const i=e.resourcesEnv.renderContext;this._renderTarget.set(void 0,e.resourcesEnv),i.deleteVao(this._vertexArrayObject),this._vertexArrayObject=void 0,i.deleteBuffer(this._vertexBuffer),this._vertexBuffer=void 0,i.deleteBuffer(this._indexBuffer),this._indexBuffer=void 0}render(e){var m;ImGui.Render();const i=e.resourcesEnv.renderContext,n=e.webGLRenderer,s=ImGui.GetDrawData(),a=s.DisplayPos.x,l=s.DisplayPos.x+s.DisplaySize.x,c=s.DisplayPos.y,h=s.DisplayPos.y+s.DisplaySize.y,d=new Float32Array([2/(l-a),0,0,0,0,2/(c-h),0,0,0,0,-1,0,(l+a)/(a-l),(c+h)/(h-c),0,1]);(m=this._renderMaterial.get().uniformBuffer)==null||m.uploadBufferToGpu(d,i.gl),this._renderTarget.get().bind(i,n,e.viewport);const u=e.sharedState,f=this._renderMaterial.get();u.bindMaterial(f.descriptor.material,f,n),this._vertexArrayObject||this._createVao(i),i.bindVao(this._vertexArrayObject);const p=e.resourcesEnv.textureManager.samplers.linearSampler;i.bindSampler(p,this._colorBinding),this.renderDrawData(s,i),i.bindVao(void 0)}renderDrawData(e,i){const n=ImGui.GetIO(),s=n.DisplaySize.x*n.DisplayFramebufferScale.x,a=n.DisplaySize.y*n.DisplayFramebufferScale.y;if(s===0||a===0)return;const l=i.gl;e.ScaleClipRects(n.DisplayFramebufferScale);const c=new We(0,0,0,0),h=new gl(0,0,0,0),d=e.DisplayPos,u=(ImGui.DrawIdxSize===4?l.UNSIGNED_INT:l.UNSIGNED_SHORT)||0;e.IterateDrawLists(f=>{l.bufferData(l.ARRAY_BUFFER,f.VtxBuffer,l.STREAM_DRAW),l.bufferData(l.ELEMENT_ARRAY_BUFFER,f.IdxBuffer,l.STREAM_DRAW),f.IterateDrawCmds(p=>{p.UserCallback!==null?p.UserCallback(f,p):(c.set(p.ClipRect.x-d.x,p.ClipRect.y-d.y,p.ClipRect.z-d.x,p.ClipRect.w-d.y),c.x<s&&c.y<a&&c.z>=0&&c.w>=0&&(h.set(c.x,a-c.w,c.z-c.x,c.w-c.y),i.setScissorTest(h),p.TextureId&&i.bindTexture(p.TextureId,l.TEXTURE_2D,this._colorBinding),l.drawElements(l.TRIANGLES,p.ElemCount,u,p.IdxOffset*ImGui.DrawIdxSize)))})}),i.setScissorTest(void 0)}};o(fo,"_vertexAttributes");let ff=fo;class $1 extends Bg{constructor(t){super(t?[mi,Xn]:[mi],"ScreenRenderTargetNode")}_acquireRenderTarget(t){return t.getScreenRenderTarget()}}var Z1=Object.defineProperty,J1=Object.getOwnPropertyDescriptor,ew=(r,t,e,i)=>{for(var n=i>1?void 0:i?J1(t,e):t,s=r.length-1,a;s>=0;s--)(a=r[s])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&Z1(t,e,n),n};class pf extends Bl{constructor(e){super(e,zr);o(this,"_isSceneRenderingRequired",!0);o(this,"_vrModeEnabled",!1);o(this,"_tempTransformMatrix",new Ue);o(this,"_tempViewMatrix",new Ue);ct.registerIfEnabled(this)}enableVrMode(e){this._frameBuilder.getScreenRenderTarget().get().framebuffer=e,this._vrModeEnabled=!0,this.frameInfo.frameFlags.enableFlag(Nn.CUSTOM_RENDER),this.frameInfo.frameFlags.enableFlag(Nn.MANUAL_RENDER_STATE_RESET)}disableVrMode(){this._frameBuilder.getScreenRenderTarget().get().framebuffer=void 0,this._vrModeEnabled=!1,this.frameInfo.frameFlags.disableFlag(Nn.CUSTOM_RENDER),this.frameInfo.frameFlags.disableFlag(Nn.MANUAL_RENDER_STATE_RESET)}_createRenderGraph(){const e=!this._frameInfo.postprocessComp.isPostprocessDoneInAdditionalStep(),i=new $1(e),n=new df;n.prepareRenderNode.clearColor=new We(1,1,1,1);const s=new Ol().build(this._frameInfo,n,[i]);return T.DEBUG_UI&&Gi.connectOutputsToInputs(new ff(this._frameInfo.resourcesEnv),i),s}isSceneRenderingRequired(){return this._isSceneRenderingRequired}render(e){const i=this._frameInfo.frameMetrics;if(i.simStateAlpha=e.simStateAlpha,i.deltaTime=e.timeDelta,this._renderWorld.update(this._frameInfo),T.DEBUG_UI&&(mt.beginSection("Debug UI"),va.instance().beginFrame(e.timeDelta),va.instance().endFrame(),mt.endSection("Debug UI")),e.vrPose){const n=e.vrPose.views,s=this._frameInfo.camera,a=s.get(qn),l=s.get(wt),c=new L().copyFrom(l.position),h=new bi().copyFrom(l.rotation);let d=!1;this._frameInfo.resourcesEnv.renderContext.resetState();for(const u of n){const f=e.baseLayer.getViewport(u);this._frameInfo.viewport.set(f.x,f.y,f.width,f.height),a.unjitteredProjectionMatrix.fromArray(u.projectionMatrix),this._tempViewMatrix.fromArray(u.transform.inverse.matrix),this._tempTransformMatrix.fromArray(e.vrPose.transform.matrix),this._tempViewMatrix.multiply(this._tempTransformMatrix),a.unjitteredProjectionMatrix.multiply(this._tempViewMatrix),Kn.updateCameraMatrices(s,!0),d||(d=!0,Kn.updateFrustumVisibility(s,this._frameInfo.renderWorld.renderListsSystems)),this._frameInfo.resourcesEnv.renderContext.setScissorTest(this._frameInfo.viewport),this._runRenderCommandList()}l.position.copyFrom(c),l.rotation.copyFrom(h),this._frameInfo.resourcesEnv.renderContext.setScissorTest(void 0)}else this._runRenderCommandList();this._isSceneRenderingRequired=this._vrModeEnabled||!this._frameInfo.renderWorld.isWorldStatic(this._frameInfo)||Vn.isTaaAccumulatingSamples(this._frameInfo.camera),T.DEBUG_UI&&(this._isSceneRenderingRequired=!0)}onDebugUi(){ct.beginWindow("Scene render",{x:50,y:50},{x:450,y:600});const e=this._frameInfo.camera,i=e.get(kn).getObjectAs(At),n=i.postprocessComp;let s=!1;if(s=ct.editProperty(n,"antialiasingType",{comboItems:["None","FXAA","FXAA + TAA","TAA"]}),ct.header("Camera")&&(ct.editProperty(i,"near",{min:.01,max:100,speed:.1}),ct.editProperty(i,"far",{min:10,max:2500,speed:.1}),ct.editProperty(i,"fov",{min:10,max:100,speed:.1})),ct.header("Temporal AA")){const a=n.temporalAaConfig;s=s||ct.editProperty(a,"historyWeightOnStaticCamera",{label:"Static weight",min:0,max:1}),s=s||ct.editProperty(a,"historyWeightOnDynamicCamera",{label:"Dynamic weight",min:0,max:1}),s=s||ct.editProperty(a,"dynamicTaaHistoryMultiplier",{label:"Dynamic multiplier",min:0,max:1}),s=s||ct.editProperty(a,"jitterSpread",{label:"Jitter spread",min:0,max:2}),s=s||ct.editProperty(a,"samplesCount",{label:"Samples count",min:1,max:16,asInteger:!0});const l=e.get(Un);l&&ct.displayProperty(l,"currentTemporalHistoryWeight","History weight")}if(ct.header("Motion blur")){const a=n.motionBlurConfig;s=s||ct.editProperty(a,"enabled"),s=s||ct.editProperty(a,"intensity",{label:"Intensity",min:0,max:1})}ct.endWindow(),s&&this._renderWorld.ecs.getSystem(tr).handlePostprocessParamsChange(e,n,!0)}}ew([Vt({name:"Scene render"})],pf.prototype,"render",1);const mf="MATERIAL_OVERRIDE_TAG";class _f extends er{constructor(){super(mf)}}class tw extends Bl{constructor(e){super(e,Wd);o(this,"_renderResultNode")}_createRenderGraph(){return this._renderResultNode=new uf,new Ol().build(this._frameInfo,new df,[new Ra().addRenderTexture(mi,H.RGBA8).addRenderTexture(Xn,H.DEPTH_COMPONENT24),this._renderResultNode])}_filterAndPrepareEntities(e,i,n){e.overrideMaterial&&this._renderWorld.ecs.getSystem(_f).setOverrideMaterial(e.overrideMaterial);const s=e.entityPrepare||e.overrideMaterial!==void 0;if(s||e.entityFilter){const a=l=>{if(!(!e.entityFilter||e.entityFilter(l))){if(e.entityFilter){const h=l.get(Mt).drawCall;h.visible&&(i.push(h),h.visible=!1)}return}e.entityPrepare&&e.entityPrepare(l),e.overrideMaterial&&l.addTag(mf),s&&(l.has(xi)||l.addComponent(new xi),n.push(l))};this._renderWorld.iterateSceneEntities(a)}}_restoreEntitiesState(e,i,n){e.overrideMaterial&&this._renderWorld.ecs.getSystem(_f).setOverrideMaterial(void 0);for(const s of i)s.visible=!0;for(const s of n)e.entityCleanup&&e.entityCleanup(s),e.overrideMaterial&&s.removeTag(mf),s.has(xi)||s.addComponent(new xi)}render(e){const i=this._frameInfo.camera,n=i.get(Dn);this._renderWorld.ecs.getSystem(Ia).suppressUpdateFlag=!0,this._renderWorld.ecs.getSystem(tr).handlePostprocessParamsChange(i,e.postprocessComp,!0),e.debugSpectorCapture&&In.startCapture(this._frameInfo.resourcesEnv.renderContext.gl);const s=i.get(wt);s.position.copyFrom(e.cameraPosition),s.rotation.copyFrom(e.cameraRotation),i.addComponent(e.projectionComp);const a=i.get(Un),l=a?n.temporalAaConfig.samplesCount:1;this.onResize(e.projectionComp.viewportSize);const c=new Array,h=new Array;this._filterAndPrepareEntities(e,c,h),this._renderWorld.update(this._frameInfo),a&&Vn.updateTemporalMatricesAndParameters(!0,this._frameInfo.camera),Kn.updateCamera(this._frameInfo.camera,this._renderWorld.renderListsSystems);const d=e.projectionComp.viewportSize,u=new uh(this.frameInfo.viewport,e.asyncCallback,e.resultBuffer);Vn.resetTaaAccumulation(this._frameInfo.camera);for(let f=0;f<l;f++)this._renderResultNode.readResult=f===l-1?u:void 0,this._runRenderCommandList(),a&&Vn.updateTemporalMatricesAndParameters(!0,this._frameInfo.camera),Kn.updateCameraMatrices(this._frameInfo.camera);this._restoreEntitiesState(e,c,h),this._renderWorld.ecs.getSystem(Ia).suppressUpdateFlag=!1,this._renderResultNode.readResult=void 0,e.resultBuffer=u.pixelBuf,e.debugSpectorCapture&&(e.debugSpectorCapture=!1,In.stopCapture()),e.dumpDebugName&&Lc(Wc(d.x,d.y,e.resultBuffer),`${e.dumpDebugName}.tga`)}}class iw extends Ot.ReactionSystem{constructor(){super(t=>t.has(Ri)?t.hasAll(wt,Xr):!1)}update(t){for(const e of this.entities){const i=e.get(wt),n=e.get(Xr),s=new Ue().compose(i.position,i.rotation,i.scale);n.wsBoundingBox.copyFrom(n.osBoundingBox).applyMatrix4(s),n.wsBoundingBox.getBoundingSphere(n.wsSphere)}}}class nw extends er{constructor(){super(Nl),this.setUpdater(Nl,t=>t.get(Nl))}}class sw extends Ot.ReactionSystem{constructor(){super(e=>e.hasAll(Yn));o(this,"entityFilter");o(this,"enableDebug",!1);o(this,"entityAdded",({current:e})=>{e.onComponentAdded.connect(this.onEntityComponentsChanged.bind(this)),e.onComponentRemoved.connect(this.onEntityComponentsChanged.bind(this)),this.onEntityComponentsChanged(e,e.get(Yn))});ct.registerIfEnabled(this)}onDebugUi(){if(this.enableDebug){this.entityFilter||(this.entityFilter=new ImGui.StringBuffer(128,"")),ct.beginWindow("Entities debug",{x:20,y:50},{x:600,y:1e3}),ImGui.InputText("Filter",this.entityFilter,ImGui.ARRAYSIZE(this.entityFilter));for(const e of this.entities){const i=e.get(Yn).name;if(!(this.entityFilter.buffer!==""&&i.indexOf(this.entityFilter.buffer)===-1)&&ImGui.TreeNode(e.id,i)){for(const n of e.getComponents()){if(n instanceof Yn||n instanceof Ri)continue;const s=n;ImGui.TreeNode(e.id+""+s.constructor.name,s.constructor.name)&&(ct.displayObject(s),ImGui.TreePop())}ImGui.TreePop()}}ct.endWindow()}}update(){for(const e of this.entities){const i=e.get(Yn);if(i.needsUpdate){i.needsUpdate=!1,i.name=i.baseName+e.id+" (";const n=e.getComponents().length;for(let s=0;s<n;s++){const a=e.getComponents()[s];if(a instanceof Yn||a instanceof Ri)continue;s!==0&&(i.name+=", ");const l=a.constructor.name,c=l.indexOf("Component");c!==-1?i.name+=l.substring(0,c):i.name+=l}i.name+=")"}}}onEntityComponentsChanged(e,i){i instanceof Ri||(e.get(Yn).needsUpdate=!0)}}class rw extends er{constructor(){super(void 0),this.setFsOutputs(["vec4 fragColor"])}}class ow extends er{constructor(){super(Xu);o(this,"_grassDataDummy",new qu);this.setUpdater(qu,()=>this._grassDataDummy)}}class aw extends er{constructor(){super(ol),this.setUpdater(ol,t=>t.get(ol)),this.setDefines(["OBJECT_HAS_HIGHLIGHT"])}}class lw extends er{constructor(){super(As,Il);o(this,"_uploadHelper",new Ca);this.setDefines(["MODEL_MATRIX"]),this.setUpdater(Ca,e=>{const i=e.get(As);return this._uploadHelper.modelMatrix.copyFrom(i.matrix),this._uploadHelper})}}class cw extends Ot.ReactionSystem{constructor(){super(t=>t.has(As)?so.every(e=>t.has(e)):!1)}update(t){const e=this.sharedConfig.get(Sn).renderContext.gl;for(const i of this.entities){const s=i.get(Mt).drawCall;if(!s.getShader())continue;const a=i.get(As);s.uploadPerObjectUniformSubData("modelMatrix",a.matrix.elements,e)}}}class hw{constructor(){o(this,"modelMatrix",new Ue);o(this,"prevModelMatrix",new Ue)}}class Ul extends Rl{constructor(){super(xt.MESH_ANIMATION);o(this,"_animationMatricesToUniformBuffers",new Map);o(this,"_motionDrawCallDescTemp");o(this,"_matrixUniformFloatOffset",-1);o(this,"_prevMatrixUniformFloatOffset",-1);o(this,"_transformData");o(this,"hasActiveAnimation",!1);o(this,"entityAdded",({current:e})=>{const i=this.engine.sharedConfig.get(Sn),n=e.get(Mt).drawCall,s=e.get(As),a=s.motionDrawCall;this._motionDrawCallDescTemp.meshDesc=n.mesh.get().descriptor,this._motionDrawCallDescTemp.entity=e,a.load(i,this._motionDrawCallDescTemp),a.usesCameraJitter=!0,a.visible=n.visible;const l=s.matrix;if(!this._animationMatricesToUniformBuffers.has(l)){const c=this.engine.sharedConfig.get(Sn).renderContext.gl,h=new Ta(c);this._transformData.set(l.elements,0),this._transformData.set(l.elements,Ru),h.uploadBufferToGpu(this._transformData,c),this._animationMatricesToUniformBuffers.set(l,h)}a.perObjectUniformBuffer=this._animationMatricesToUniformBuffers.get(l),this._matrixUniformFloatOffset===-1&&(this._matrixUniformFloatOffset=a.getPerObjectUniformOffset("modelMatrix")/Zs,this._prevMatrixUniformFloatOffset=a.getPerObjectUniformOffset("prevModelMatrix")/Zs),this._renderList.add(a)});o(this,"entityRemoved",e=>{const i=e.previous.get(As);i.motionDrawCall&&(this._renderList.remove(i.motionDrawCall),i.motionDrawCall.unload(this.engine.sharedConfig.get(Sn)))});const e=new bt({vsName:"reprojected_position_vertex.glsl",fsName:"reprojected_position_fragment.glsl"});e.depthWrite=!1,e.depthTest=!0,e.addDefine("DEV_NEW_RENDER_ARCHITECTURE"),e.addDefine("MODEL_MATRIX");const i="reprojectedUvResult",n=new Tr(e,[`vec4 ${i}`],void 0,[hw]);this._motionDrawCallDescTemp=new tu,this._motionDrawCallDescTemp.materialDesc=n,this._transformData=new Float32Array(Ru*2);const s=new Ue().identity();this._transformData.set(s.elements,0),this._transformData.set(s.elements,Ru)}update(e){const i=this.sharedConfig.get(Zr),n=i.camera.get(wt).position;this.hasActiveAnimation=!1;const s=i.renderWorld.scene;if(!s)return;const a=this.sharedConfig.get(Sn).renderContext.gl;for(const l of s.getAnimatedRootNodes()){const c=this._animationMatricesToUniformBuffers.get(l.animationMatrix);this._transformData.set(l.animationMatrix.elements,this._prevMatrixUniformFloatOffset),l.update(e,n)&&(this.hasActiveAnimation=!0),this._transformData.set(l.animationMatrix.elements,this._matrixUniformFloatOffset),c.uploadBufferToGpu(this._transformData,a)}}}class dw extends Ot.ReactionSystem{constructor(e){super(i=>i.hasAll(Mt,Xr));o(this,"renderDevice");this.renderDevice=e}getEntities(){return this.entities}onGeometryDispose(e){e.setOnDispose(void 0),this.deallocateGeometry(e)}deallocateGeometry(e){const i=e.attributes;for(const n in e.attributesKeys)if(Object.prototype.hasOwnProperty.call(i,n)){const s=i[n];s!==void 0&&s.buffer!==void 0&&(this.renderDevice.getGl().deleteBuffer(s.buffer),delete s.buffer)}}}class uw extends Ot.ReactionSystem{constructor(){super(t=>!t.has(Ri)||!t.has(Zu)?!1:so.every(e=>t.has(e)))}update(){const e=this.sharedConfig.get(Sn).webGLRenderer.getGl(),i=Vi[oe.OBJECT];for(const n of this.entities){const s=n.get(Mt),a=s.drawCall,l=a.getShader().uniformBlockDescriptors.get(i),c=new ph(l);for(const h of s.perObjectUpdaters)h.updateData(n,c);a.perObjectUniformBuffer.uploadBufferToGpu(c.dataView,e)}}}class fw extends Ot.ReactionSystem{constructor(){super(e=>!1);o(this,"_selectedId",-1);o(this,"inspectedDrawCall");o(this,"visibleInCameraFilter",!0);o(this,"_perObjectBufferReader");o(this,"_materialBufferReader");o(this,"_lightBufferReader");ct.registerIfEnabled(this)}onDebugUi(){var s,a,l,c,h,d,u;ct.beginWindow("DrawCall lists",{x:50,y:50},{x:450,y:600});const e=new ImGui.ImVec2;ImGui.GetWindowSize(e);const i=new ImGui.ImVec2;ImGui.GetWindowPos(i);const n=[this.engine.getSystem(ef).getEntities(),this.engine.getSystem(tf).getEntities(),this.engine.getSystem(nf).getEntities(),this.engine.getSystem(sf).getEntities(),this.engine.getSystem(Ul).getEntities()];ct.editProperty(this,"visibleInCameraFilter",{label:"Show only visible"});for(let f=0;f<eu;f++){const p=f,m=n[f];if(ImGui.CollapsingHeader(xt[p]+": "+m.length)){ImGui.BeginTable("Entity draw calls",8,ImGui.TableFlags.Borders|ImGui.TableFlags.SizingFixedFit);const b=this.engine.sharedConfig.get(Zr).camera.get(wr);ImGui.TableHeader("Entity draw calls"),ImGui.TableSetupColumn("Name"),ImGui.TableSetupColumn("DC index"),ImGui.TableSetupColumn("Ent id"),ImGui.TableSetupColumn("Parent id"),ImGui.TableSetupColumn("Light Id"),ImGui.TableSetupColumn("Object visible"),ImGui.TableSetupColumn("Visible"),ImGui.TableSetupColumn("Showed"),ImGui.TableHeadersRow();for(const g of m){const x=g.get(Mt),w=g.get(kn).object3D,C=x.drawCall.index,M=x.drawCall,D=b.renderListsVisibility[p].get(C);if(this.visibleInCameraFilter&&!D&&M.visible)continue;ImGui.TableNextRow(),ImGui.TableNextColumn();let W="??";w instanceof Tn&&w.node&&(W=(s=w.node.config.name)!=null?s:"??"),ImGui.PushID(g.id);const z=ImGui.SelectableFlags.SpanAllColumns|ImGui.SelectableFlags.AllowItemOverlap;if(ImGui.Selectable(W,g.id===this._selectedId,z)){this._selectedId=g.id,this.inspectedDrawCall=M;const Me=M.getShader();if(Me){const Xe=Me.uniformBlockDescriptors.get(Vi[oe.OBJECT]);((a=this._perObjectBufferReader)==null?void 0:a.descriptor)!==Xe&&(this._perObjectBufferReader=Xe?new Ou(Xe):void 0);const xe=Me.uniformBlockDescriptors.get(Vi[oe.MATERIAL]);((l=this._materialBufferReader)==null?void 0:l.descriptor)!==xe&&(this._materialBufferReader=new Ou(xe));const Le=Me.uniformBlockDescriptors.get(Vi[oe.LIGHT]);((c=this._lightBufferReader)==null?void 0:c.descriptor)!==Le&&(this._lightBufferReader=Le?new Ou(Le):void 0)}else this._perObjectBufferReader=void 0,this._materialBufferReader=void 0,this._lightBufferReader=void 0}if(M===this.inspectedDrawCall){if(ct.beginWindow("DrawCall",{x:e.x+i.x,y:i.y},{x:100,y:100},!0,!1)){const Me=this.sharedConfig.get(Sn).renderContext;this._inspectDrawCall(this.inspectedDrawCall,Me)}ct.endWindow()}ImGui.TableNextColumn(),ImGui.Text(""+C),ImGui.TableNextColumn(),ImGui.Text(""+g.id),ImGui.TableNextColumn();const $=g.get(Qu);ImGui.Text(""+($?$.parentEntityId:-1)),ImGui.TableNextColumn();let Z=-1;const ne=(d=(h=M.lightDataBinding)==null?void 0:h.get())!=null?d:void 0;ne&&ne.lightmap.get()&&(Z=(u=ne.lightmap.get().descriptor.textureId)!=null?u:""),ImGui.Text(Z.toString()),ImGui.TableNextColumn(),ImGui.Text(w.visible?"T":"F"),ImGui.TableNextColumn(),ImGui.Text(D?"T":"F"),ImGui.TableNextColumn(),ImGui.Checkbox("",(Me=M.visible)=>M.visible=Me),ImGui.PopID()}ImGui.EndTable()}}ct.endWindow()}_inspectDrawCall(e,i){var c,h,d;const n=ImGui.TableFlags.Borders|ImGui.TableFlags.SizingFixedFit,s=e.getShader();if(ImGui.CollapsingHeader("Material",ImGui.TreeNodeFlags.DefaultOpen)){ImGui.Text(s.descriptor.vsName),ImGui.Text(s.descriptor.fsName);const u=e.renderMaterial.get().descriptor.perObjectShaderDefines;if(u&&ImGui.Text(`Per object defines: ${u.join(", ")}`),this._materialBufferReader){const m=e.renderMaterial.get().uniformBuffer;this._displayUniforms("material",this._materialBufferReader,m,i)}const f=e.renderMaterial.get().textureTable.getBindings(),p=e.getShader().samplerUniformTable;if(f.size>0&&ImGui.BeginTable("Texture bindings",f.size,n)){ImGui.TableNextRow();for(const[m,b]of f){ImGui.TableNextColumn();const g=p.samplerUniforms.find(w=>w.binding===m),x=g?g.name:"??";ImGui.Text(`${x} ${m}`),ImGui.Image(b.texture,new ImGui.Vec2(100,100))}ImGui.EndTable()}ct.displayObject(e.renderMaterial.get().pipelineState.get().descriptor.pipelineState)}const a=(h=(c=e.lightDataBinding)==null?void 0:c.get())!=null?h:void 0;if(a&&ImGui.CollapsingHeader("Light binding",ImGui.TreeNodeFlags.DefaultOpen)){this._lightBufferReader&&this._displayUniforms("light",this._lightBufferReader,a.uniformBuffer,i);const u=a.lightmap?(d=a.lightmap.get())==null?void 0:d.descriptor.textureId:"??";ImGui.Text("Lightmap id: "+(u||"??")),a.lightmap.get()&&ImGui.Image(a.lightmap.get().texture,new ImGui.Vec2(100,100));for(const f of a.descriptor.reflectionProbes)ImGui.Text("Reflection probe id: "+f.id)}ImGui.CollapsingHeader("Per object data",ImGui.TreeNodeFlags.DefaultOpen)&&this._perObjectBufferReader&&this._displayUniforms("object",this._perObjectBufferReader,e.perObjectUniformBuffer,i);const l=e.entity;if(l&&l.has(wt)){const u=l.get(wt);ct.displayObject(u)}}_displayUniforms(e,i,n,s){const a=ImGui.TableFlags.Borders|ImGui.TableFlags.SizingFixedFit|ImGui.TableFlags.RowBg;ImGui.BeginTable(e,2,a)&&(i.readUniformBuffer(s,n,(l,c)=>{ImGui.TableNextRow(),ImGui.TableNextColumn(),ImGui.Text(l),ImGui.TableNextColumn();let h="";c.map((d,u)=>{h+=`${d.toFixed(2)}`,u<c.length-1&&(h+=", "),u%4===3&&(h+=`
`)}),ImGui.Text(h)}),ImGui.EndTable())}}class Vg{constructor(t){o(this,"mesh");this.mesh=t}}class pw extends Ot.ReactionSystem{constructor(){super(i=>i.hasAll(wt,Xr));o(this,"boxGeometry");o(this,"wireframeMaterials");o(this,"currentMaterialIndex",0);o(this,"entityAdded",({current:e})=>{this._entityAdded(e)});this.wireframeMaterials=[];const e=[new _e(5021401),new _e(7072564),new _e(3450091),new _e(9385195)];for(const i of e){const n=Qd(i);n.depthTest=!1,this.wireframeMaterials.push(n)}this.boxGeometry=ft.createBox(1,1,1)}_entityAdded(e){const i=new je(this.boxGeometry,this.wireframeMaterials[this.currentMaterialIndex++%this.wireframeMaterials.length]),s=this.engine.sharedConfig.get(Sn).meshManager.getMeshResourceDescriptor(i.geometry),a=e.get(Xr);i.position.addVectors(a.wsBoundingBox.min,a.wsBoundingBox.max).multiplyScalar(.5),i.scale.subVectors(a.wsBoundingBox.max,a.wsBoundingBox.min).multiplyScalar(1),i.updateMatrixWorld();const l=new Ot.Entity;l.add(new wt({position:i.position.clone(),rotation:i.rotation.toQuaternion(),scale:i.scale.clone()})),l.add(new Mt({material:i.material,meshResourceDescriptor:s})),l.add(new Vg(i)),l.add(new Yn("Debug")),this.engine.addEntity(l)}}class mw extends Ot.ReactionSystem{constructor(){super(t=>t.hasAll(wt,Mt,Vg))}getEntities(){return this.entities}}class zg extends er{constructor(){super(Qr),this.setUpdater(Qr,t=>t.get(Qr))}}var _w=Object.defineProperty,gw=Object.getOwnPropertyDescriptor,vw=(r,t,e,i)=>{for(var n=i>1?void 0:i?gw(t,e):t,s=r.length-1,a;s>=0;s--)(a=r[s])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&_w(t,e,n),n};class Gg{constructor(t,e){o(this,"ecs",new Ot.Engine);o(this,"updateSystem",new Ia);o(this,"hierarchySystem",new Ah);o(this,"renderListsSystems");o(this,"opaqueEntitiesQuery");o(this,"transparentEntitiesQuery");o(this,"dynamicTaaMaskQuery");o(this,"scene");o(this,"transformDebug",!1);o(this,"renderDevice");this.ecs.sharedConfig.add(e),this.ecs.addSystem(this.updateSystem,1),this.ecs.addSystem(this.hierarchySystem,0),this.ecs.addSystem(new dw(t),0),this.ecs.addSystem(new t1,2),this.ecs.addSystem(new iw,2),this.ecs.addSystem(new nw,3),this.ecs.addSystem(new s1,3),this.ecs.addSystem(new lw,3),this.ecs.addSystem(new _f,3),this.ecs.addSystem(new zg,3),this.ecs.addSystem(new ow,3),this.ecs.addSystem(new aw,3),this.ecs.addSystem(new i1,3),this.ecs.addSystem(new r1,3),this.ecs.addSystem(new Th,0),this.ecs.addSystem(new rw,3),this.ecs.addSystem(new e1,4),this.ecs.addSystem(new ef,5),this.ecs.addSystem(new tf,5),this.ecs.addSystem(new nf,5),this.ecs.addSystem(new sf,5),this.ecs.addSystem(new Ul,5),this.ecs.addSystem(new sw,2),this.ecs.addSystem(new JT,0),this.ecs.addSystem(new Ku,0),this.ecs.addSystem(new fw,0),this.ecs.addSystem(new Vn,6),this.ecs.addSystem(new tr,0),this.ecs.addSystem(new D1,0),this.ecs.addSystem(new ro,0),this.ecs.addSystem(new Kn,7),this.transformDebug&&(this.ecs.addSystem(new pw,2),this.ecs.addSystem(new mw,2)),this.ecs.addSystem(new uw,8),this.ecs.addSystem(new n1,9),this.ecs.addSystem(new cw,9),this.ecs.addSystem(new Ng,10),this.ecs.onEntityAdded.connect(i=>{!i.has(Mt)&&i.get(Yn).baseName===""&&(i.get(Yn).baseName="Helper")}),this.renderDevice=t,this.renderListsSystems={[xt.OPAQUE]:this.ecs.getSystem(ef),[xt.GRASS]:this.ecs.getSystem(tf),[xt.TRANSPARENT]:this.ecs.getSystem(nf),[xt.SKY]:this.ecs.getSystem(sf),[xt.MESH_ANIMATION]:this.ecs.getSystem(Ul)},this.opaqueEntitiesQuery=new Ot.QueryBuilder().contains(Mt,$u,xt[xt.OPAQUE]).build(),this.ecs.addQuery(this.opaqueEntitiesQuery),this.transparentEntitiesQuery=new Ot.QueryBuilder().contains(Mt,$u,xt[xt.TRANSPARENT]).build(),this.ecs.addQuery(this.transparentEntitiesQuery),this.dynamicTaaMaskQuery=new Ot.QueryBuilder().contains(Mt,Ju).build(),this.ecs.addQuery(this.dynamicTaaMaskQuery)}init(t){this.scene=t}close(){this.ecs.removeAllEntities(),this.ecs.clear()}checkIfObjectHasMainSceneParent(t){const e=this.scene.threeScene;let i=t.parent;for(;i;){if(i===e)return!0;i=i.parent}return!1}update(t){this.ecs.sharedConfig.add(t),this.ecs.update(t.frameMetrics.deltaTime)}refreshReflectionProbes(t){this.ecs.getSystem(Ku).refreshLightDataBindings(t)}onLogicUpdateBegin(){this.updateSystem.applyPendingInterpolators()}iterateSceneEntities(t){this.opaqueEntitiesQuery.entities.forEach(e=>{t(e)}),this.transparentEntitiesQuery.entities.forEach(e=>{t(e)})}isWorldStatic(t){const i=t.resourcesEnv.textureManager.isAnyVideoTexturePresent(),n=this.updateSystem.isAnyEntityUpdated(),s=this.ecs.getSystem(Ul).hasActiveAnimation,a=t.frameMetrics.animatedMaterialVisible;return!(n||i||s||a)}isStaticTaaApplicable(t){const e=this.updateSystem.isAnyEntityUpdated(),i=this.ecs.getSystem(Ul).hasActiveAnimation;return!(t.frameMetrics.animatedMaterialVisible||e||i)}}vw([Vt({name:"Render world update"})],Gg.prototype,"update",1);var bw=Object.defineProperty,yw=Object.getOwnPropertyDescriptor,Mr=(r,t,e,i)=>{for(var n=i>1?void 0:i?yw(t,e):t,s=r.length-1,a;s>=0;s--)(a=r[s])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&bw(t,e,n),n};class Ps extends pt{constructor(e){super();o(this,"webGLRenderer");o(this,"renderContext");o(this,"renderWorld");o(this,"resourcesEnv");o(this,"objectEntityMapper");o(this,"_duringShadersReload",!1);o(this,"_onSharedMaterialStateUpdated",()=>{Vn.resetFramesTillStaticTaaHistoryWeight(this.getActiveCamera())});this.webGLRenderer=e,this.webGLRenderer.setUploadBuffersFuncOverride(this.updateMeshBuffers.bind(this)),this.renderContext=new oT(this.webGLRenderer.getGl()),this.resourcesEnv=new Sn(this.webGLRenderer,this.renderContext),this.renderWorld=new Gg(e,this.resourcesEnv),this.objectEntityMapper=new KT(this.renderWorld),this._registerRenderPipeline(new pf({renderWorld:this.renderWorld,resourcesEnv:this.resourcesEnv,frameFlags:new xo(T.DEBUG?[Nn.DEBUG_POSTPROCESS]:[])})),this._registerRenderPipeline(new X1({renderWorld:this.renderWorld,resourcesEnv:this.resourcesEnv,frameFlags:new xo([Nn.CUSTOM_RENDER])})),this._registerRenderPipeline(new Ph({renderWorld:this.renderWorld,resourcesEnv:this.resourcesEnv,frameFlags:new xo([Nn.CUSTOM_RENDER])})),this._registerRenderPipeline(new tw({renderWorld:this.renderWorld,resourcesEnv:this.resourcesEnv,frameFlags:new xo([Nn.CUSTOM_RENDER])})),this._registerRenderPipeline(new Y1({renderWorld:this.renderWorld,resourcesEnv:this.resourcesEnv,frameFlags:new xo([Nn.CUSTOM_RENDER])}))}verifyProperFlagsUsage(){return T.DEV_NEW_RENDER_ARCHITECTURE&&!T.DEV_DISABLE_UNIFORM_BUFFERS}setMainScene(e){this.renderWorld.init(e)}enableVrMode(e){this._getRenderPipeline(zr).enableVrMode(e)}disableVrMode(){this._getRenderPipeline(zr).disableVrMode()}init(e){const i=e.sharedMaterialState,n=this.resourcesEnv.globalTextureTable,s=this.resourcesEnv.textureManager.samplers.linearSampler;if(e.sharedMaterialState.brdfLUT){const a=i.brdfLUT.webglTexture,l=$r.get(WT);n.setBinding(l,H.TEXTURE_2D,a,s)}if(i.colorMap){const a=i.colorMap.webglTexture,l=$r.get("colorMap");n.setBinding(l,H.TEXTURE_2D,a,s)}i.addEventListener(sl.eventType.UPDATED,this._onSharedMaterialStateUpdated),this.resourcesEnv.update();for(const a of this._renderParamsToPipelines.values())a.camera=this.objectEntityMapper.createCameraEntity(a instanceof pf?e.camera:void 0,a.postprocessComp),a.load()}onClose(){this.renderWorld.close(),this.resourcesEnv.removeAllResources()}setWireframeMode(e){const i=this.renderWorld.ecs;if(e){i.getSystem(zg).setOverrideMaterial(e);const n=s=>{s.addComponent(new Qr),s.has(xi)||s.addComponent(new xi)};this.renderWorld.iterateSceneEntities(n)}else{const n=s=>{s.removeComponent(Qr),s.has(xi)||s.addComponent(new xi)};this.renderWorld.iterateSceneEntities(n)}Vn.resetFramesTillStaticTaaHistoryWeight(this.getActiveCamera())}markTransformUpdated(e){this.objectEntityMapper.markTransformUpdated(e)}_getRenderPipeline(e){return this._renderParamsToPipelines.get(e.name)}getActiveCamera(){return this._getRenderPipeline(zr).frameInfo.camera}onLogicUpdateBegin(){this.renderWorld.onLogicUpdateBegin()}onLogicUpdateEnd(){this.objectEntityMapper.updateTransformFrom3DObjects()}isSceneRenderingRequired(){return T.ALWAYS_RENDER||this._getRenderPipeline(zr).isSceneRenderingRequired()}addEntity(e,i){this.objectEntityMapper.addEntity(e,i)}removeEntity(e){this.objectEntityMapper.removeEntity(e),Vn.resetFramesTillStaticTaaHistoryWeight(this.getActiveCamera())}unuseMeshUsedByObject(e){this.objectEntityMapper.unuseMeshUsedByObject(e)}updateMeshBuffers(e){this.objectEntityMapper.updateMeshResource(e)}updateEntityVisibility(e,i){this.objectEntityMapper.updateEntityVisibility(e,i),Vn.resetFramesTillStaticTaaHistoryWeight(this.getActiveCamera())}updateEntityState(e,i,n){this.renderWorld.updateSystem.updateEntityState(e,i,n)}updateEntityStateById(e,i,n){const s=this.renderWorld.ecs.getEntityById(e);this.updateEntityState(s,i,n)}updateMaterialForEntity(e,i){this.updateEntityStateById(e,Mt,{material:i})}hasComponent(e,i){return this.renderWorld.ecs.getEntityById(e).has(i)}registerComponentForObject(e,i){this.objectEntityMapper.getPreparedEntityForObject(e).add(i)}uploadTexture(e){const n=this.resourcesEnv.textureManager.getDescriptorForTexture(e);this.resourcesEnv.getResource(n).set(void 0,this.resourcesEnv),this.resourcesEnv.lightBindingManager.onTextureUploaded(e,this.resourcesEnv)}createCubeTexture(e,i){return this.resourcesEnv.textureManager.createCubeTexture(e,i)}onSceneLoaded(){this.resourcesEnv.lightBindingManager.refreshReflectionProbeTextures(),this.refreshReflectionProbesAssignment();const e=this.getActiveCamera();this.renderWorld.ecs.getSystem(tr).handlePostprocessParamsChange(e,e.get(kn).getObjectAs(At).postprocessComp)}refreshReflectionProbesAssignment(){this.renderWorld.refreshReflectionProbes(this.resourcesEnv)}checkGpuErrors(){this.resourcesEnv.renderContext.checkGlError()}reloadShaders(){this._duringShadersReload||(this._duringShadersReload=!0,console.log("Reloading shaders..."),zi.reloadShaders(()=>{this.resourcesEnv.materialManager.refreshAllMaterials(),this._duringShadersReload=!1}))}}Mr([Vt()],Ps.prototype,"onLogicUpdateBegin",1),Mr([Vt()],Ps.prototype,"onLogicUpdateEnd",1),Mr([Vt()],Ps.prototype,"addEntity",1),Mr([Vt()],Ps.prototype,"removeEntity",1),Mr([Vt()],Ps.prototype,"updateMeshBuffers",1),Mr([Vt()],Ps.prototype,"updateEntityState",1),Mr([Vt()],Ps.prototype,"uploadTexture",1),Mr([Vt()],Ps.prototype,"onSceneLoaded",1),Mr([Vt()],Ps.prototype,"refreshReflectionProbesAssignment",1);function xw(r,t,e){for(let i=0;i<e;++i)for(let n=0;n<t;++n){const s=4*(i*t+n);if(i<e/2){const l=4*((e-i-1)*t+n);for(let c=0;c<3;++c){const h=r[s+c];r[s+c]=r[l+c],r[l+c]=h}}const a=3;r[s+a]=255}}const kl=function(r,t,e,i,n){return r.createRenderTarget(t,e,{magFilter:i,minFilter:i,depthBuffer:n,stencilBuffer:!1,generateMipmaps:!1})};function Ew(r,t,e){const i=[],n=[],s=[{totalFovFraction:.25,count:2},{totalFovFraction:.25,count:16},{totalFovFraction:.375,count:48},{totalFovFraction:.125,count:8}],a=4;(function(){const c={fovSum:0,heightSum:0,totalFovFraction:0};for(let h=0;h<s.length;h++){const d=s[h],u=d.totalFovFraction*r/d.count;console.assert(u===Math.floor(u),`Height (${u})must be an integer`);const f=d.totalFovFraction*Math.PI/2/d.count,p=kl(e,t*a,u*a,H.LINEAR,!0);n.push(p);for(let m=0;m<d.count;m++)i.push({fov:f,fovOffset:c.fovSum+(m+.5)*f,height:u,yOffset:c.heightSum+m*u,renderTarget:p});c.fovSum+=d.count*f,c.heightSum+=d.count*u,c.totalFovFraction+=d.totalFovFraction}console.assert(c.totalFovFraction===1,"Invalid fractions sum"),console.assert(c.fovSum===Math.PI/2,"Invalid fov definition for rectangles"),console.assert(c.heightSum===r,"Invalid rectangles height")})(),this.getRectangleHeight=function(c){return i[c].height},this.getRectangleOffset=function(c){return i[c].yOffset},this.getRectangleFov=function(c){return i[c].fov},this.getRectangleFovOffset=function(c){return i[c].fovOffset},this.getRectangleRenderTarget=function(c){return i[c].renderTarget},this.dispose=function(){n.forEach(function(c){c.dispose()}),i.length=0,n.length=0},this.getRectangleCount=function(){return i.length}}function Aw(r,t,e){let i=null,n=null,s=null,a=null;const l=new L;function c(){const p=document.body.offsetHeight*i,m=(document.body.offsetWidth-p)/2,b=Math.max(m,0),g=`${m}px`,x=`${b}px`;n.style.width=x,s.style.width=x,a.style.left=g,a.style.right=g}this.markArea=function(p){function m(g,x){g.style.zIndex=1,g.style.pointerEvents="none",g.style.position="absolute",g.style.top=0,g.style.bottom=0,g.style[x]=0,g.style.backgroundColor="rgba(0, 0, 0, 0.5)"}function b(g){g.style.zIndex=1,g.style.pointerEvents="none",g.style.position="absolute",g.style.boxSizing="border-box",g.style.top=0,g.style.bottom=0,g.style.border="4px solid rgba(35, 181, 233, 0.5)"}a||(n=document.createElement("div"),m(n,"left"),s=document.createElement("div"),m(s,"right"),a=document.createElement("div"),b(a),document.body.appendChild(n),document.body.appendChild(s),document.body.appendChild(a),window.addEventListener("resize",c)),i=p,c()},this.unmarkArea=function(){a&&(n.remove(),s.remove(),a.remove(),window.removeEventListener("resize",c),i=null,n=null,s=null,a=null)};function h(p,m,b,g,x,w){const C=t.camera.near,M=t.camera.far,D=512,W=.03;console.assert(b%D===0,"Invalid width for stereo panorama");const z=b/2,$=new L(0,-1,0),Z=z/2,ne=2*Math.PI/D,Me=b/D,Xe=-Me,xe=Me,Le={BOTTOM:Symbol("Bottom"),TOP:Symbol("Top")},B=Math.floor(m/ne)*ne,Y=C*Math.tan(ne/2),re=new Xs;re.up.set(0,0,1);const le=new Ew(Z,Me,r),ge=le.getRectangleCount(),pe=new L,Ae=new L,Fe=new L,he=new Ue,tt=function(me,Ye,ue,Ee){const Pe=function(F){return Y*Math.cos(F)},He=-(Ye*ne-B),lt=me===Le.TOP?-le.getRectangleFovOffset(ue):le.getRectangleFovOffset(ue);he.makeRotationZ(He),pe.set(Ee,0,0),he.affineTransformPoint3(pe),re.position.copyFrom(p).add(pe),Ae.copyFrom($),he.makeRotationX(lt).transformVector3(Ae),he.makeRotationZ(He).transformVector3(Ae),Fe.copyFrom(re.position).add(Ae),re.lookAt(Fe);const Rt=C*Math.tan(le.getRectangleFov(ue)/2),Et=Pe(lt);re.projectionMatrix.makeFrustum(-Et,Et,-Rt,Rt,C,M),re.updateMatrix(),re.updateMatrixWorld()},Ze=kl(r,b,2*z,H.NEAREST,!1);Ze.width=Me;const N=new ml,U=function(me){Ze.dispose(),le.dispose(),N.dispose(),x(me)},k=[{hemisphere:Le.TOP,eyeOffset:W,parallaxOffset:Xe,targetYOffset:z},{hemisphere:Le.BOTTOM,eyeOffset:W,parallaxOffset:Xe,targetYOffset:z},{hemisphere:Le.TOP,eyeOffset:-W,parallaxOffset:xe,targetYOffset:0},{hemisphere:Le.BOTTOM,eyeOffset:-W,parallaxOffset:xe,targetYOffset:0}],X=function(me,Ye){if(Ye++,Ye===D){if(me++,me===k.length)return[-1,-1];Ye=0}return[me,Ye]},ve=k.length*D,De=Math.ceil(ve/100),qe=function(me){g({done:me,total:ve})},Ne=function(me,Ye){const ue=k[me].hemisphere,Ee=k[me].eyeOffset,Pe=k[me].parallaxOffset,He=k[me].targetYOffset;for(let lt=0;lt<ge;lt++){tt(ue,Ye,lt,Ee);const Rt=le.getRectangleRenderTarget(lt);r.render(t.threeScene,re,Rt);const Et=le.getRectangleHeight(lt),F=le.getRectangleOffset(lt);ue===Le.TOP?Ze.y=He+Z+F:Ze.y=He+Z-F-Et,Ze.x=(Ye*Me+Pe+b)%b,Ze.height=Et,N.render(r,Ze,Rt)}if(w()){U(null);return}if([me,Ye]=X(me,Ye),me===-1){const lt=new Uint8Array(b*2*z*4);r.readPixels(b,2*z,lt),U(lt);return}Ye%De===0&&qe(me*D+Ye),setTimeout(()=>Ne(me,Ye),0)};Ne(0,0)}function d(p,m,b,g){const x=new Yd(t.camera.near,t.camera.far);x.rotateZ(m),x.position.copyFrom(p),x.updateMatrixWorld();const w=4096,C=r.createRenderTargetCube(w,w,{magFilter:H.LINEAR,minFilter:H.LINEAR,stencilBuffer:!1,generateMipmaps:!1});for(let $=0;$<6;$+=1)C.activeCubeFace=$,r.render(t.threeScene,x.sideCameras[$],C);const M=kl(r,b,g,H.NEAREST,!0),D={uniforms:{panoramaCube:{type:"t",value:null}},vertexShaderName:"cube_to_equirect_vertex.glsl",fragmentShaderName:"cube_to_equirect_fragment.glsl"},W=new ds(D,"panoramaCube");W.render(r,M,C),W.dispose(),C.dispose();const z=new Uint8Array(b*g*4);return r.readPixels(b,g,z),M.dispose(),z}function u(p,m){if(T.DEV_NEW_RENDER_ARCHITECTURE){const b=t.camera,g=new Wd,x=g.projectionComp;return rh.updateProjectionFromCamera(x,b,new ye(p,m)),g.cameraPosition.copyFrom(e.cameraWorldPosition()),b.current.getWorldQuaternion(g.cameraRotation),g.postprocessComp.copyFrom(b.postprocessComp),g.postprocessComp.antialiasingType=xs.TAA,pt.get().render(g),g.resultBuffer}else{const b=kl(r,p,m,H.NEAREST,!0),g=kl(r,p,m,H.NEAREST,!1),x=new wu(r,t);x.setTargets(b,g),x.renderAllSamples();const w=x.copyAccumulatedSamplesToBuffer();return b.dispose(),g.dispose(),x.dispose(),w}}this.monoScreenToBuffer=function(p,m,b){return p?d(e.cameraWorldPosition(),e.getYawAngle(),m,b):u(m,b)},this.stereoPanoramaToBuffer=function(p,m,b,g){h(e.cameraWorldPosition(),e.getYawAngle(),p,m,b,g)},this.monoScreenToDataUrl=function(p,m,b){const g=this.monoScreenToBuffer(p,m,b);xw(g,m,b);const x=new Uint8ClampedArray(g),w=new ImageData(x,m,b),C=document.createElement("canvas");C.width=m,C.height=b,C.getContext("2d").putImageData(w,0,0);const D="image/jpeg";return C.toDataURL(D)},this.monoScreenToLocalImage=function(p,m,b){const g=this.monoScreenToDataUrl(p,m,b);da(g,"screenshot")},this.coverToServer=function(p,m){const b=u(p,m),g=`screenshot?width=${p}&height=${m}`;Vr(g,"application/binary",b)};function f(p,m){const b=Math.min(T.MAX_PANORAMA_SIZE,$e.gl.maxRenderBufferSize);if(p<=b&&m<=b)return[p,m];const g=p/m;return p>m?[b,Math.floor(b/g)]:[Math.floor(b*g),b]}this.monoPanoramaToServer=function(p,m){p.position?l.fromArray(p.position):l.copyFrom(e.cameraWorldPosition());let b=p.width!==void 0?p.width:8e3,g=p.height!==void 0?p.height:4e3;[b,g]=f(b,g);const x=p.rotation!==void 0?Ai(p.rotation):0,w=d(l,x,b,g),C=p.name,M=`panorama?width=${b}&height=${g}&name=${C}`;Vr(M,"application/binary",w,m,m)}}class Hg{constructor(){o(this,"_strings",new Set);o(this,"_regExps",new Array)}add(t){t instanceof RegExp?this._regExps.push(t):this._strings.add(t)}matchesAny(t){return this._strings.has(t)?!0:this._regExps.some(e=>e.test(t))}}class Tw{constructor(){o(this,"_editableNodeTypes",new Hg);o(this,"_editableMaterialNames",new Hg);o(this,"_allMaterialsEditable",!1)}setAllMaterialsEditable(){this._allMaterialsEditable=!0}setNodeTypeEditable(t){this._editableNodeTypes.add(t)}setMaterialEditable(t){this._editableMaterialNames.add(t)}isMaterialEditable(t){return this._allMaterialsEditable||this._editableMaterialNames.matchesAny(t)}isNodeTypeEditable(t){return this._editableNodeTypes.matchesAny(t)}}function ww(){return{enabled:!1,outlineColor:[0,0,0],outlineThickness:1,fillEnabled:!0,levels:[]}}function Sw(r){return r!==void 0?r:ww()}function Mw(r){return r&&r.trim()||"level"}class gf{constructor(t,e,i){o(this,"_boundingBox");o(this,"_updatedCallback");o(this,"_name");o(this,"_slicePlaneHeight");o(this,"_farPlaneHeight");o(this,"_rotation");o(this,"_crop");o(this,"_cropRange");o(this,"_ratio");o(this,"_visibleRange");this._boundingBox=e,this._updatedCallback=i,this._name=t.name||"level",this._slicePlaneHeight=t.slicePlaneHeight,this._farPlaneHeight=t.farPlaneHeight,this._rotation=t.rotation||0,this._crop=!!t.cropRange,this._cropRange=t.cropRange?new Qa(new ye().fromArray(t.cropRange.min),new ye().fromArray(t.cropRange.max)):new Qa,this._ratio=new ye(1,1),this._visibleRange=new Qa,this._crop&&this._updateRatio()}_setDefaultRange(){this._cropRange.set(new ye(this._boundingBox.min.x,this._boundingBox.min.y),new ye(this._boundingBox.max.x,this._boundingBox.max.y))}_updateVisibleRange(){const t=this._cropRange.center(),e=Math.abs(Math.sin(this._rotation)),i=Math.abs(Math.cos(this._rotation)),n=Math.abs(this._cropRange.max.x-this._cropRange.min.x),s=Math.abs(this._cropRange.max.y-this._cropRange.min.y),a=n*i+s*e,l=n*e+s*i;this._visibleRange.set(new ye(t.x-a/2,t.y+l/2),new ye(t.x+a/2,t.y-l/2))}_updateRatio(){const t=Math.abs(this._boundingBox.min.x-this._boundingBox.max.x),e=Math.abs(this._boundingBox.min.y-this._boundingBox.max.y),i=this._cropRange.size().x/t,n=this._cropRange.size().y/e;i>n?this._ratio.set(1,n/i):this._ratio.set(i/n,1)}setRange(t,e,i){t>this._cropRange.max[i]&&(t=this._cropRange.max[i]),e<this._cropRange.min[i]&&(e=this._cropRange.min[i]),this._cropRange.min[i]=t,this._cropRange.max[i]=e,this._updateVisibleRange(),this._updateRatio(),this._updatedCallback()}serialize(){const t=this._crop?{min:this._cropRange.min.toArray(),max:this._cropRange.max.toArray()}:null;return{name:this.name,slicePlaneHeight:this.slicePlaneHeight,farPlaneHeight:this.farPlaneHeight,cropRange:t,rotation:this.rotation}}get name(){return this._name}set name(t){this._name=Mw(t),this._updatedCallback()}get slicePlaneHeight(){return this._slicePlaneHeight}set slicePlaneHeight(t){t>=this._farPlaneHeight&&(this._slicePlaneHeight=t,this._updatedCallback())}get farPlaneHeight(){return this._farPlaneHeight}set farPlaneHeight(t){t<=this._slicePlaneHeight&&(this._farPlaneHeight=t,this._updatedCallback())}get crop(){return this._crop}set crop(t){this._crop=t,t||this._setDefaultRange(),this._updateVisibleRange(),this._updateRatio(),this._updatedCallback()}get cropRange(){return this._cropRange.empty()&&this._setDefaultRange(),this._cropRange}get visibleRange(){return this._visibleRange.empty()&&this._updateVisibleRange(),this._visibleRange}get ratio(){const t=this._ratio;return(t.x===0||t.y===0||!isNaN(t.x)||!isNaN(t.y))&&this._updateRatio(),t}get rotation(){return this._rotation}set rotation(t){this._rotation=t,this._crop||this._setDefaultRange(),this._updateVisibleRange(),this._updateRatio(),this._updatedCallback()}get rotationDeg(){return Wn(this.rotation)}set rotationDeg(t){this.rotation=Ai(t)}}var Wg=(r=>(r.UPDATED="minimapConfigUpdated",r))(Wg||{});const _d=class _d extends ci{constructor(e,i){var l,c;super();o(this,"_boundingBox");o(this,"_defaultViewHeight");o(this,"_updated");o(this,"_enabled");o(this,"_outlineColor");o(this,"_outlineThickness");o(this,"_fillEnabled");o(this,"_levels");const n=e.minimap,s=e.views||[];this._boundingBox=i,this._defaultViewHeight=(c=(l=s.at(0))==null?void 0:l.position)==null?void 0:c.at(2);const a=Sw(n);this._updated=()=>this.dispatchEvent({type:_d.eventType.UPDATED}),this._enabled=a.enabled,this._outlineColor=new _e().fromArray(a.outlineColor),this._outlineThickness=a.outlineThickness,this._fillEnabled=a.fillEnabled,this._levels=a.levels.map(h=>new gf(h,i,this._updated))}_firstLevel(){var s;const e="level0",i=(s=this._defaultViewHeight)!=null?s:this._boundingBox.min.z+T.FALLBACK_CAMERA_HEIGHT,n=this._boundingBox.min.z;return new gf({name:e,slicePlaneHeight:i,farPlaneHeight:n},this._boundingBox,this._updated)}_nextLevel(e,i){const n="level"+e,s=this._levels[e-1],a=this._boundingBox.max.z-s.slicePlaneHeight,l=s.slicePlaneHeight+a/2,c=s.farPlaneHeight,h=s.rotation,d=i.crop?{min:i.cropRange.min.toArray(),max:i.cropRange.max.toArray()}:void 0;return new gf({name:n,slicePlaneHeight:l,farPlaneHeight:c,cropRange:d,rotation:h},this._boundingBox,this._updated)}_serializeLevels(){return this._levels.map(e=>e.serialize())}createLevel(e){const i=this._levels.length;return i===0?this._firstLevel():(nt(e),this._nextLevel(i,e))}addLevel(e){this._levels.push(e),this._updated()}removeLevel(e){Qi(e,this._levels),this._levels.length===0&&this._levels.push(this._firstLevel()),this._updated()}shiftLevel(e,i){kc(this._levels,e,i),this._updated()}getLevelsIndex(e){return this._levels.findIndex(i=>i===e)}serialize(){return{enabled:this.enabled,outlineColor:this.outlineColor.toArray(),outlineThickness:this.outlineThickness,fillEnabled:this.fillEnabled,levels:this._serializeLevels()}}get enabled(){return this._enabled}set enabled(e){e&&this._levels.length===0&&this.addLevel(this.createLevel()),this._enabled=e,this._updated()}get outlineColor(){return this._outlineColor}get outlineColorRGB(){return this._outlineColor.toArray()}set outlineColorRGB(e){this._outlineColor.setRGB(...e),this._updated()}get outlineThickness(){return this._outlineThickness}set outlineThickness(e){this._outlineThickness=e,this._updated()}get fillEnabled(){return this._fillEnabled}set fillEnabled(e){this._fillEnabled=e,this._updated()}get levels(){return this._levels}};o(_d,"eventType",Wg);let Vl=_d;function jg(r){return Zt(Ai(r))}var Cs=(r=>(r.ORBIT="orbit",r.FPS="fps",r))(Cs||{});const Pw={internal:!1,position:[0,0,0],rotation:[0,0],hideFromMenu:!0,sky:T.EDITOR_CONTROLLED_SKY_NAME};var Xg=(r=>(r.UPDATED="viewUpdated",r))(Xg||{});const Ya=class Ya extends ci{constructor(e=Pw,i){var n,s,a,l,c,h,d,u,f,p,m,b,g;super();o(this,"id");o(this,"name");o(this,"internal");o(this,"position");o(this,"rotation");o(this,"hideFromMenu");o(this,"sky");o(this,"mode");o(this,"orthographic");o(this,"orthoFrustumSize");o(this,"distance");o(this,"panPrimary");o(this,"noRotate");o(this,"noPitchRotate");o(this,"noPan");o(this,"minDistance");o(this,"maxDistance");o(this,"minUpAngle");o(this,"maxUpAngle");o(this,"minSideAngle");o(this,"maxSideAngle");o(this,"target");o(this,"fov");o(this,"_updated");this.id=e.id!==void 0?e.id:Ya._nextViewAutoId++,this.name=e.name||"view"+this.id,this.internal=(n=e.internal)!=null?n:!1,this.mode=(s=e.mode)!=null?s:"fps",e.position?this.position=new L(e.position[0],e.position[1],e.position[2]):this.mode==="fps"&&(this.position=i),e.rotation&&(this.rotation=new Fi(jg(e.rotation[0]),jg(e.rotation[1]),0)),this.hideFromMenu=(a=e.hideFromMenu)!=null?a:!1,this.sky=(l=e.sky)!=null?l:T.EDITOR_CONTROLLED_SKY_NAME,this.orthographic=(c=e.orthographic)!=null?c:!1,this.orthoFrustumSize=(h=e.orthoFrustumSize)!=null?h:T.CAMERA_ORTHO_FRUSTUM_SIZE,this.distance=e.distance,this.panPrimary=e.panPrimary,this.noRotate=e.noRotate,this.noPitchRotate=e.noPitchRotate,this.noPan=(d=e.noPan)!=null?d:!1,this.minDistance=(u=e.minDistance)!=null?u:1,this.maxDistance=(f=e.maxDistance)!=null?f:100,this.minUpAngle=(p=e.minUpAngle)!=null?p:-Math.PI/2,this.maxUpAngle=(m=e.maxUpAngle)!=null?m:Math.PI/2,this.minSideAngle=(b=e.minSideAngle)!=null?b:-Math.PI,this.maxSideAngle=(g=e.maxSideAngle)!=null?g:Math.PI,e.target&&(this.target=new L(e.target[0],e.target[1],e.target[2])),this.fov=e.fov,this._updated=()=>this.dispatchEvent({type:Ya.eventType.UPDATED})}isTop(){return!!(this.mode==="orbit"&&this.panPrimary&&this.noPitchRotate)}isOrbit(){return this.mode==="orbit"&&!this.isTop()}usesDefaultSky(){return this.sky===T.DEFAULT_SKY_NAME}switchSky(){this.usesDefaultSky()?this.sky=T.EDITOR_CONTROLLED_SKY_NAME:this.sky=T.DEFAULT_SKY_NAME,this._updated()}setName(e){this.name=e,this._updated()}getCameraParameters(){var e,i,n;return{position:(e=this.position)==null?void 0:e.toArray(),rotation:(i=this.rotation)==null?void 0:i.toDegTriple(),target:(n=this.target)==null?void 0:n.toArray(),distance:this.distance}}setCameraParameters(e){e.position?(this.position||(this.position=new L),this.position.fromArray(e.position)):this.position=void 0,e.rotation?(this.rotation||(this.rotation=new Fi),this.rotation.setFromDegTriple(e.rotation)):this.rotation=void 0,this.distance=e.distance,e.target?(this.target||(this.target=new L),this.target.fromArray(e.target)):this.target=void 0}setPosition(e,i,n){Ce(this.position),this.position.set(e,i,n),this._updated()}setYaw(e){Ce(this.rotation),this.rotation.yaw=e,this._updated()}setMinUpAngle(e){e!==this.minUpAngle&&(this.minUpAngle=e,this._updated())}setMaxUpAngle(e){e!==this.maxUpAngle&&(this.maxUpAngle=e,this._updated())}setMinSideAngle(e){e!==this.minSideAngle&&(this.minSideAngle=e,this._updated())}setMaxSideAngle(e){e!==this.maxSideAngle&&(this.maxSideAngle=e,this._updated())}setHideFromMenu(e){e!==this.hideFromMenu&&(this.hideFromMenu=e,this._updated())}setMinDistance(e){e!==this.minDistance&&(this.minDistance=e,this._updated())}setMaxDistance(e){e!==this.maxDistance&&(this.maxDistance=e,this._updated())}setNoPan(e){e!==this.noPan&&(this.noPan=e,this._updated())}toCamera(){const e=new At;return this.orthographic?Ce(!1,"TODO(kj): writeme"):(Ce(this.position),Ce(this.rotation),e.position.copyFrom(this.position),e.rotation.copyFrom(this.rotation)),e.updateMatrixWorld(!0),e.matrixWorldInverse.getInverse(e.matrixWorld),e}serialize(){var i;const e={id:this.id,name:this.name,mode:this.mode,rotation:(i=this.rotation)==null?void 0:i.toDegTriple().slice(0,2),hideFromMenu:this.hideFromMenu,sky:this.sky};return this.position&&(e.position=this.position.toArray()),this.target&&(e.target=this.target.toArray()),this.minSideAngle!==-1/0&&(e.minSideAngle=this.minSideAngle),this.maxSideAngle!==1/0&&(e.maxSideAngle=this.maxSideAngle),this.orthographic&&(e.orthographic=this.orthographic,e.orthoFrustumSize=this.orthoFrustumSize),this.distance!==void 0&&(e.distance=this.distance),this.minDistance!==void 0&&(e.minDistance=this.minDistance),this.maxDistance!==void 0&&(e.maxDistance=this.maxDistance),this.panPrimary!==void 0&&(e.panPrimary=this.panPrimary),this.noPan!==void 0&&(e.noPan=this.noPan),this.noRotate!==void 0&&(e.noRotate=this.noRotate),this.noPitchRotate!==void 0&&(e.noPitchRotate=this.noPitchRotate),this.minUpAngle!==void 0&&(e.minUpAngle=this.minUpAngle),this.maxUpAngle!==void 0&&(e.maxUpAngle=this.maxUpAngle),this.fov!==void 0&&(e.fov=this.fov),e}};o(Ya,"eventType",Xg),o(Ya,"_nextViewAutoId",1e3);let hn=Ya;const qg=(r,t)=>{const e=r.createRenderTarget(512,512,{format:Ke.RGBA8,magFilter:H.LINEAR,minFilter:H.LINEAR,stencilBuffer:!1,generateMipmaps:!1}),i={vertexShaderName:"brdf_vertex.glsl",fragmentShaderName:"brdf_fragment.glsl",uniforms:{integrateBrdfNumSamples:{type:"f",value:t}}},n=new ds(i),s=new br(r);return s.set(!0,!1,!1),n.render(r,e),s.restore(),n.dispose(),e},vf=["faces16","faces","vertices","normals","transforms"],bf=[...vf,"meshes","bounds","uvs0","uvs1"];class Cw{constructor(t,e){o(this,"onProgress");o(this,"onFailure");o(this,"onHaveBuffer");o(this,"highPriorityUvs",!1);o(this,"assetsUrl");o(this,"buffers",{});o(this,"_buffersDone",{});this.assetsUrl=t,this.highPriorityUvs=e!=null?e:this.highPriorityUvs}haveAllBuffers(){return bf.every(t=>this.buffers[t]!==void 0)}haveCoreBuffers(){return vf.every(t=>this.buffers[t]!==void 0)}releaseCoreBuffersExceptTransform(){vf.filter(e=>e!=="transforms").forEach(e=>this.buffers[e]=void 0)}_queueAjaxGetBuffer(t,e){const i=s=>{var a;this.buffers[e]=s,(a=this.onHaveBuffer)==null||a.call(this)},n=s=>{var a;this._buffersDone[e]=s.loaded,(a=this.onProgress)==null||a.call(this)};Mo(t,`${this.assetsUrl}${e}.buf`,!0,i,this.onFailure,n,!0)}load(){var i;const t=T.LOAD_PRIORITY.CORE_RESOURCE,e={uvs0:this.highPriorityUvs?t:T.LOAD_PRIORITY.UV0,uvs1:this.highPriorityUvs?t:T.LOAD_PRIORITY.LIGHTMAP};for(const n of bf)this._queueAjaxGetBuffer((i=e[n])!=null?i:t,n)}totalDone(){let t=0;return bf.forEach(e=>{var i;return t+=(i=this._buffersDone[e])!=null?i:0}),t}}const Rw=10,Yg=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0]),Qg=function(r){this.minVerticesUntilTimeCall=r,this.verticesCount=0,this.timer=new No};Qg.prototype.shouldInterrupt=function(r){return this.verticesCount+=r,this.verticesCount>this.minVerticesUntilTimeCall&&this.timer.elapsedMSec()>Rw?(this.verticesCount=0,this.timer.reset(),!0):!1};function Kg(r,t,e,i,n,s,a){for(let l=0,c=3*e;l<c;l+=3){const h=r[l+t]*n,d=r[l+t+1]*n,u=r[l+t+2]*n;s[a+l]=i[0]*h+i[1]*d+i[2]*u+i[3],s[a+l+1]=i[4]*h+i[5]*d+i[6]*u+i[7],s[a+l+2]=i[8]*h+i[9]*d+i[10]*u+i[11]}}function $g(r,t,e,i,n,s){for(let a=0,l=2*e;a<l;a+=2){let c=(r[a+t]/254+.5)*Math.PI,h=r[a+t+1]*(Math.PI/127);const d=Math.sin(c),u=d*Math.cos(h),f=d*Math.sin(h),p=Math.cos(c),m=i[0]*u+i[1]*f+i[2]*p,b=i[4]*u+i[5]*f+i[6]*p,g=i[8]*u+i[9]*f+i[10]*p;c=(Math.acos(g)/Math.PI-.5)*2,h=Math.atan2(b,m)/Math.PI,n[s+a]=Oc(c),n[s+a+1]=Oc(h)}}function Ch(r){return r.instanceId!==0||r.parent.ownsGpuBuffers===!1}function Zg(r,t,e,i,n,s){let a=!1;for(let l=0,c=2*e;l<c;l+=1){const h=r[l+t]*i;n[s+l]=h,(h<0||h>1)&&(a=!0)}return a}function Jg(r,t,e,i,n){let s=!1;for(let a=0,l=2*e;a<l;a+=1){const c=r[a+t];i[n+a]=c,(c<0||c>1)&&(s=!0)}return s}function ev(r,t,e,i,n,s,a,l,c){for(let h=0,d=2*e;h<d;h+=2){const u=r[h+t],f=r[h+t+1];u!==0||f!==0?(l[c+h]=Math.round(u*i)+s,l[c+h+1]=Math.round(f*n)+a):(l[c+h]=0,l[c+h+1]=0)}}function tv(r){return r.uv0ByteOffset!==-1}function iv(r){return r.uv1ByteOffset!==-1}function nv(r){return r.quantVertexRange/r.quantVertexMax}function yf(r){return r.quantUv0Max===0}function sv(r){return r.quantUv0Range/r.quantUv0Max}function Rh(r,t,e,i,n,s){const a=new Qg(5e4);let l=0,c=0;function h(){for(;l<r.length;){const d=r[l];if(c===0&&!e(d)){l+=1;continue}for(;c<d.logicalMeshes.length;){const u=d.logicalMeshes[c],f=t.get(u);if(i(u,f),c+=1,a.shouldInterrupt(f.vertexCnt)){setTimeout(h,0);return}}n(d),l+=1,c=0}s()}h()}function rv(r,t){return t.geometry.allocateCoreBuffers(r),!0}function ov(r){return r.anyLogicalMeshHasUvs?(r.geometry.allocateUv0(),!0):!1}function av(r){return r.lightmap?(r.geometry.allocateUv1(),!0):!1}function Iw(r,t,e,i,n){const s=new Uint16Array(r),a=new Float32Array(r);function l(c,h){if(!tv(h))return;const d=c.geometry;if(Ch(d))return;const u=d.vertexOffset,f=d.parent;let p=!1;yf(h)?p=Jg(a,h.uv0ByteOffset/4,h.vertexCnt,f.uvs0,u*2):p=Zg(s,h.uv0ByteOffset/2,h.vertexCnt,sv(h),f.uvs0,u*2),p&&(f.isUvs0Repeating=!0)}Rh(t,e,ov,l,i,n)}function lv(r,t,e,i,n){const s=n.instanceId*4,a=n.parent.uvs1Mod;a[s]=e/65535,a[s+1]=i/65535,a[s+2]=r/65535,a[s+3]=t/65535}function Dw(r,t,e,i,n,s,a){const l=i?dv(n,r):new Uint16Array(r);function c(h,d){if(!iv(d))return;let u=d.uv1CoordUScale,f=d.uv1CoordVScale,p=d.uv1CoordUOffset,m=d.uv1CoordVOffset;const b=h.geometry;if(b.isInstanced){if(lv(u,f,p,m,b),Ch(b))return;u=f=1,p=m=0}const g=b.vertexOffset;ev(l,d.uv1ByteOffset/2,d.vertexCnt,u,f,p,m,b.parent.uvs1,g*2)}Rh(t,e,av,c,s,a)}function cv(r,t){const e=t.parent,i=t.instanceId*4,n=e.transforms0;n[i]=r[0],n[i+1]=r[1],n[i+2]=r[2],n[i+3]=r[3];const s=e.transforms1;s[i]=r[4],s[i+1]=r[5],s[i+2]=r[6],s[i+3]=r[7];const a=e.transforms2;a[i]=r[8],a[i+1]=r[9],a[i+2]=r[10],a[i+3]=r[11]}function Lw(r,t,e,i,n,s,a){const l=i?hv(n,t,e,r.faces):[new Uint16Array(r.faces16),new Uint32Array(r.faces)],c=l[0],h=l[1],d=new Int8Array(r.vertices),u=new Int16Array(r.vertices),f=new Int32Array(r.vertices),p=new Int8Array(r.normals);function m(b,g){const x=b.geometry,w=x.parent;let C=new Float32Array(r.transforms,g.transformByteOffset,16);if(x.isInstanced){if(cv(C,x),Ch(x))return;C=Yg}let M,D;switch(Fc(g.quantVertexMax)){case 1:M=d,D=g.vertexByteOffset;break;case 2:M=u,D=g.vertexByteOffset/2;break;case 4:M=f,D=g.vertexByteOffset/4;break}const W=x.vertexOffset;Kg(M,D,g.vertexCnt,C,nv(g),w.vertices,W*3),$g(p,g.normalByteOffset,g.vertexCnt,C,w.normals,W*2);const z=w.index;let $=x.indexOffset,Z,ne;g.useFaces16?(Z=g.faceByteOffset/2,ne=c):(Z=g.faceByteOffset/4,ne=h);for(let Me=Z,Xe=Z+g.faceCnt*3;Me<Xe;Me+=1,$+=1)z[$]=ne[Me]+W}Rh(t,e,rv.bind(null,!0),m,s,a)}function Ow(r){return new Uint8Array(r.buffer,r.byteOffset,r.byteLength)}function hv(r,t,e,i){let n=[],s=[],a=0,l=0;for(const p of t)for(const m of p.logicalMeshes){const b=e.get(m);if(b.useFaces16){let g=b.faceByteOffset/2;n.push([g,b.faceCnt,b.useFaces16]),a+=b.faceCnt}else{let g=b.faceByteOffset/4;s.push([g,b.faceCnt,b.useFaces16]),l+=b.faceCnt}}const c=(p,m)=>p[0]-m[0];n.sort(c),s.sort(c);let h=a>0?new Uint32Array(a*3):null,d=l>0?new Uint32Array(l*3):null,u=0,f=-1;for(const p of[...n,...s]){const m=p[0],b=p[1],g=p[2];if(f==m||b==0)continue;f=m;const x=new Uint32Array(i.slice(u,u+=4)).at(0),C=Ow((g?h:d).subarray(m)),M=new Uint8Array(i).subarray(u,u+=x);r.decodeIndexBuffer(C,b*3,4,M)}return[new Uint16Array(h),d]}function dv(r,t){if(!t)return null;const e=new Uint8Array(t.slice(4)),i=new Uint32Array(t.slice(0,4)).at(0),n=new Uint8Array(i*4);return r.decodeVertexBuffer(n,i,4,e),new Uint16Array(n.buffer)}function Fw(r,t,e,i,n,s,a){const l=i?hv(n,t,e,r.faces):[new Uint16Array(r.faces16),new Uint32Array(r.faces)],c=l[0],h=l[1],d=new Int8Array(r.vertices),u=new Int16Array(r.vertices),f=new Int32Array(r.vertices),p=new Int8Array(r.normals),m=new Uint16Array(r.uvs0),b=new Float32Array(r.uvs0),g=i?dv(n,r.uvs1):new Uint16Array(r.uvs1);function x(C){return rv(!1,C),ov(C),av(C),!0}function w(C,M){const D=C.geometry,W=C.geometry.parent;let z=new Float32Array(r.transforms,M.transformByteOffset,16),$;tv(M)&&W.uvs0&&($=W.uvs0);let Z,ne,Me,Xe,xe;if(iv(M)&&W.uvs1&&(Z=W.uvs1,ne=M.uv1CoordUScale,Me=M.uv1CoordVScale,Xe=M.uv1CoordUOffset,xe=M.uv1CoordVOffset),D.isInstanced){if(cv(z,D),Z&&lv(ne,Me,Xe,xe,D),Ch(D))return;z=Yg,ne=Me=1,Xe=xe=0}let Le,B;M.useFaces16?(Le=c,B=M.faceByteOffset/2):(Le=h,B=M.faceByteOffset/4);let Y,re;switch(Fc(M.quantVertexMax)){case 1:Y=d,re=M.vertexByteOffset;break;case 2:Y=u,re=M.vertexByteOffset/2;break;case 4:Y=f,re=M.vertexByteOffset/4;break}let le;yf(M)?le=M.uv0ByteOffset/4:le=M.uv0ByteOffset/2;let ge=C.geometry.vertexOffset*3,pe=C.geometry.vertexOffset*2;const Ae=W.vertices,Fe=W.normals,he=M.normalByteOffset,tt=M.uv1ByteOffset/2;for(let Ze=B,N=B+M.faceCnt*3;Ze<N;Ze+=1,ge+=3,pe+=2){const U=Le[Ze],k=re+U*3;Kg(Y,k,1,z,nv(M),Ae,ge);const X=he+U*2;if($g(p,X,1,z,Fe,pe),$){const ve=le+U*2;let De=!1;yf(M)?De=Jg(b,ve,1,$,pe):De=Zg(m,ve,1,sv(M),$,pe),De&&(W.isUvs0Repeating=!0)}if(Z){const ve=tt+U*2;ev(g,ve,1,ne,Me,Xe,xe,Z,pe)}}}Rh(t,e,x,w,s,a)}class Bw{constructor(t,e){o(this,"lightmapCount");o(this,"encoding");o(this,"format");o(this,"thresholds");this.lightmapCount=t;const i=new xn(e);this.encoding=i.parseEnum("encoding",Hr,Hr.RGBM),this.thresholds=i.parseNumbers("thresholds");const s=i.parseStrings("formats").indexOf("webp")>=0;this.format=s?"webp":"png"}load(t){const e=H.NEAREST,i=[];for(let n=0;n<this.lightmapCount;n+=1){const s=new Wr;s.id=s.name="lightmap-"+this.encoding+n,s.stdExt=this.format,s.encoding=this.encoding,s.alpha=!0,s.webFormats=["large/std"];const a=t.load(s,En.NONE,T.LOAD_PRIORITY.LIGHTMAP);a.anisotropy=st.NO_ANISOTROPY,a.magFilter=e,a.minFilter=e,a.ycocgmThreshold=this.thresholds.at(n)||0,a.encoding=this.encoding,i.push(a)}return[this.encoding,i]}}const Nw=["cutoutMaskThreshold","doubleSided","name","opacity","materialLibraryHash"],Uw=["bumpScale","normalScale","cutoutMode","emissive","emissionStrength","envMapProject","metallic","roughness","alphaInLowerHalf","chromaKeyEnabled"],kw=["baseColor","bumpScale","normalScale",cn.BUMP,cn.NORMAL,"doubleSided","emissive","metallic","opacity","roughness"];function uv(r,t,e){for(let i=0;i<t.length;i+=1){const n=t[i],s=r[n];s!==void 0&&(e["_"+n]=s)}}const fv=T.LOAD_PRIORITY.DIFFUSE,Ih=T.LOAD_PRIORITY.SPECULARITY,Dh=En.REPEAT_WRAPPING|En.GENERATE_MIPS|(T.PUPPETEER_TEST?En.PAUSE_LOADED_VIDEO:0);class xf{constructor(t,e,i=!1){o(this,"_textureManager");o(this,"_mergeConfig");o(this,"_textureAtlases");o(this,"_postponeTexLoad");o(this,"_shaders",new Array);o(this,"_shadersVersion",0);this._textureManager=t,this._mergeConfig=e,this._textureAtlases=t.atlases(),this._postponeTexLoad=i}_loadTexture(t,e,i){return this._textureManager.load(t,e,i,!1,this._postponeTexLoad)}getAtlasEntry(t){t instanceof jc||(t=jc.parse(t));const i=this._textureAtlases.get(t.atlasId).getAtlasEntry(t.id,t.name,t.atlasOffset[0],t.atlasOffset[1],t.atlasScale[0],t.atlasScale[1]);return i.rawExt!==void 0&&i.rawExt!==t.rawExt&&console.warn("Atlas entries with not matching rawExt "+t.name),i.rawExt=t.rawExt,i.stdExt!==void 0&&i.stdExt!==t.stdExt&&console.warn("Atlas entries with not matching stdExt "+t.name),i.stdExt=t.stdExt,i.importGpuCompress=t.importGpuCompress!==!1,i.importAutoScale=t.importAutoScale!==!1,i}applyBaseColorTexture(t,e){const i=e.baseColorTexture;if(i){let n;i.atlasId?n=this.getAtlasEntry(i):n=this._loadTexture(i,Dh,fv),n.isCutout=void 0,t.baseColorTexture=n}}parseTexture(t,e,i,n=Dh,s=fv){const l=new xn(e).parseObject(i);l&&(t[i]=this._loadTexture(l,n,s))}applyBaseColor(t,e){e.baseColor&&(t.baseColor.fromArray(e.baseColor),t.baseColor.roundChannels())}applyTextureCorrection(t,e,i){const n=i[e+"Correction"];t.loadCorrection(e,n)}applyUvOffsetScale(t,e){if(e.uvOffsetScale){const i=e.uvOffsetScale;t.setUvOffsetAndScale(i[0],i[1],i[2],i[3])}}applyAntiTiling(t,e){const i=e.antiTiling;if(i!==void 0&&(t.antiTilingType=i.antiTilingType,t.antiTilingType==="Regular")){const n=i.antiTilingRegularParameters;for(const s of Object.keys(mm))t.setAntiTilingRegularParameters(s,n[s])}}applyAttribute(t,e,i){i[t]&&(e[t]=i[t])}applyDoNotImport(t,e){e.doNotImport&&Dd(e.doNotImport,kw,t.doNotImport)}applyChromaKey(t,e){const i=e.chromaKeyColor;i&&(t.chromaKeyColor.fromArray(i),t.chromaKeyColor.roundChannels());const n=e.chromaKeyDelta;n&&t.chromaKeyDelta.fromArray(n)}setGrassMaterialProperties(t,e){return t.name=e.name,this.applyBaseColorTexture(t,e),this.parseTexture(t,e,cn.HEIGHT),this.applyBaseColor(t,e),this.applyTextureCorrection(t,cn.BASE_COLOR,e),this.applyAttribute("grassHeight",t,e),this.applyAttribute("grassLayers",t,e),this.applyAttribute("grassDirection",t,e),this.applyUvOffsetScale(t,e),this.applyAntiTiling(t,e),t}setWaterMaterialProperties(t,e){return t.name=e.name,this.parseTexture(t,e,cn.NORMAL,En.REPEAT_WRAPPING,Ih),this.applyBaseColor(t,e),this.applyAttribute("opacity",t,e),uv(e,["wavesSpeed","wavesScale","refractionFactor"],t),t.setUniforms(),t}hasResidueAfterWaterMaterial(t){return t.wavesSpeed!==void 0&&t.wavesSpeed!==null||t.wavesScale!==void 0&&t.wavesScale!==null}setStandardMaterialProperties(t,e){Dd(e,Nw,t),e.reflective!==void 0?t._reflective=e.reflective:t._reflective=!!(e.roughnessTexture||e.roughness!==1),uv(e,Uw,t),this.applyBaseColor(t,e),this.applyTextureCorrection(t,cn.BASE_COLOR,e),this.applyBaseColorTexture(t,e);for(const i of[cn.ROUGHNESS,cn.METALLIC,cn.BUMP])this.parseTexture(t,e,i,Dh,Ih),this.applyTextureCorrection(t,i,e);return this.hasResidueAfterWaterMaterial(e)||(this.parseTexture(t,e,cn.NORMAL,Dh,Ih),this.applyTextureCorrection(t,cn.NORMAL,e)),this.applyDoNotImport(t,e),this.applyChromaKey(t,e),this.applyUvOffsetScale(t,e),this.applyAntiTiling(t,e),t}setUniversalMaterialProperties(t,e){this.setStandardMaterialProperties(t,e);const i=new xn(e);for(let s=0;s<8;s++){const a=i.parseObject(`texture${s}`);a&&(t.textures[s]=this._loadTexture(a,En.REPEAT_WRAPPING|En.GENERATE_MIPS,Ih))}const n=i.parseNumber("shaderId",-1);if(n>=0&&n<this._shaders.length&&(t.customShader=this._shaders[n]),t.customShaderVersion=this._shadersVersion,e.uniforms){const s=e.uniforms;for(const a of s)t.uniformVectors.push(new We(a[0],a[1],a[2],a[3]))}if(t.alphaMode=i.parseNumber("alphaMode",0),t.usesTexCoords=i.parseBoolean("usesTexCoords",!1),t.clearcoatUnused=i.parseBoolean("clearcoatUnused",!1),t.sheenUnused=i.parseBoolean("sheenUnused",!1),t.customShaderVersion==0&&(t.usesTexCoords=t.textures.length>0),!t.customShader){t.clearcoat=i.parseNumber("clearcoat",0),t.clearcoatRoughness=i.parseNumber("clearcoatRoughness",0);const s=i.parseNumbers("sheenColor");s.length==3&&(t.sheenColor=s),t.sheenRoughness=i.parseNumber("sheenRoughness",0);const a=i.parseNumbers("specularColor");a.length==3&&(t.specularColor=a),t.specular=i.parseNumber("specular",1)}return t.configureTransparency(),t.setUniforms(),t}setMaterialFromJson(t,e){switch(t.type){case hs.UNIVERSAL:return this.setUniversalMaterialProperties(t,e);case hs.GRASS:return this.setGrassMaterialProperties(t,e);case hs.WATER:return this.setWaterMaterialProperties(t,e);default:return this.setStandardMaterialProperties(t,e)}}_createMaterial(t,e){_r.WEBWALK;const i=nu(t.type,e);return this.setMaterialFromJson(i,t)}getMaterial(t,e){return t===void 0?nu(hs.STANDARD,e):this._createMaterial(t,e)}load(t,e){var d,u,f;const i=(d=t.materials)!=null?d:[];this._shaders=((u=t.shaders)!=null?u:[]).map(p=>zi.makeInline(p)),this._shadersVersion=(f=t.shadersVersion)!=null?f:0;const n=t.formatVersion,s=new Map;let a=0;const l=p=>{if(this._mergeConfig.isMaterialEditable(p.name))return p;const m=p.hash(),b=s.get(m)||[];for(const g of b)if(g.canMerge(p)){a+=1,g.merged=!0,p=g;break}return p.merged||(b.push(p),s.set(m,b)),p},h=i.some(p=>p.id===void 0)||n==="1.5.0";i.forEach((p,m)=>{var M;const b=(M=p.source)!=null?M:_r.SCENE,g=this._createMaterial(p,b);let x=p.id;h&&(x=m);const w=g,C=l(g);w===C?(C.merged,e.addMaterial(C,x),g.setUniforms()):(C.merged,e.addMergedMaterial(w,x,C))}),a>0&&Re.log(`Merged ${i.length} materials down to ${i.length-a}.`)}}const Vw=500;class zw{constructor(t,e,i,n,s){o(this,"nodeId");o(this,"materialId");o(this,"useFaces16");o(this,"faceByteOffset");o(this,"faceCnt");o(this,"vertexByteOffset");o(this,"vertexCnt");o(this,"normalByteOffset");o(this,"uv0ByteOffset");o(this,"uv1ByteOffset");o(this,"lightmapIdx");o(this,"uv1CoordUScale");o(this,"uv1CoordVScale");o(this,"uv1CoordUOffset");o(this,"uv1CoordVOffset");o(this,"transformByteOffset");o(this,"boundsByteOffset");o(this,"quantVertexRange");o(this,"quantVertexMax");o(this,"quantUv0Range");o(this,"quantUv0Max");o(this,"autoLightmapResolution");o(this,"useInstances",!1);o(this,"hasCopies",!1);o(this,"isMasterCopy",!1);o(this,"boundingBox",new li);o(this,"boundingSphere",new os);this.nodeId=t[n],this.materialId=t[n+1],this.useFaces16=t[n+2]===1,this.faceByteOffset=t[n+3],this.faceCnt=t[n+4],this.vertexByteOffset=t[n+5],this.vertexCnt=t[n+6],this.normalByteOffset=t[n+7],this.uv0ByteOffset=t[n+8],this.uv1ByteOffset=t[n+9],this.lightmapIdx=t[n+10],this.uv1CoordUScale=e[n+11],this.uv1CoordVScale=e[n+12],this.uv1CoordUOffset=t[n+13],this.uv1CoordVOffset=t[n+14],this.transformByteOffset=t[n+15],this.boundsByteOffset=t[n+16],this.quantVertexRange=e[n+17],this.quantVertexMax=t[n+18],this.quantUv0Range=e[n+19],this.quantUv0Max=t[n+20],this.autoLightmapResolution=s>=2?t[n+21]:-1,this.useInstances=!1,this.hasCopies=!1,this.isMasterCopy=!1,this._parseBounds(i)}_parseBounds(t){const e=this.boundsByteOffset/4;t.subarray(e,e+6).some(i=>!isFinite(i))||(this.boundingBox.max.x=t[e],this.boundingBox.max.y=t[e+1],this.boundingBox.max.z=t[e+2],this.boundingBox.min.x=t[e+3],this.boundingBox.min.y=t[e+4],this.boundingBox.min.z=t[e+5],this.boundingBox.center(this.boundingSphere.center),this.boundingSphere.radius=t[e+6])}uv0Needed(){return this.uv0ByteOffset!==-1}getSharedGeometryId(){return this.useInstances?this.vertexByteOffset:void 0}}class pv{constructor(t,e,i,n,s,a){o(this,"meshPropsSet",new Set);o(this,"material");o(this,"lightmap");o(this,"lightProbes");o(this,"anyLogicalMeshHasUvs");o(this,"sharedGeometryId");o(this,"hideInViews");o(this,"editableRootNode");this.meshPropsSet.add(t),this.material=e,this.lightmap=i,this.lightProbes=n,this.hideInViews=s,this.editableRootNode=a,this.anyLogicalMeshHasUvs=t.uv0Needed(),this.sharedGeometryId=t.getSharedGeometryId()}canUseLightmap(t){return this.lightmap===null||t===null||this.lightmap===t}}function Gw(r,t,e){let i,n,s,a;e?(i=r.faceCnt*3,n=r.vertexCnt):(i=0,n=r.faceCnt*3),t.isInstanced?(s=0,a=0):(s=t.indexCnt,a=t.vertexCnt);const l=new Ea(i,n,t,s,a,r.boundingBox,r.boundingSphere);return t.boundingBox.union(r.boundingBox),os.union(r.boundingSphere,t.boundingSphere),t.isInstanced?(l.instanceId=t.instanceCount,t.instanceCount+=1,t.indexCnt=i,t.vertexCnt=n):(t.indexCnt+=i,t.vertexCnt+=n),l}class Hw{constructor(t,e,i,n){o(this,"_scene");o(this,"_useIndexedGeometry");o(this,"_logicalMeshesCount",0);o(this,"_totalVertexCount",0);o(this,"_totalFaceCount",0);o(this,"_meshesBufferLength");o(this,"_allMeshProps",new Array);o(this,"mergedMeshes",new Array);o(this,"meshToProps",new Map);o(this,"coreGeometryDownloadSize",0);o(this,"geometryDownloadSize",0);o(this,"lightmapCount",0);o(this,"encodedUsingMeshOpt",!1);this._scene=t,this._useIndexedGeometry=n,this._meshesBufferLength=e.byteLength,this._parseMeshesBuffer(e,i),this._computeGeometrySizeInfo(),Re.log(`Have  ${this._totalVertexCount} vertices, ${this._totalFaceCount} faces and ${this.lightmapCount} lightmaps.`)}_parseMeshesBuffer(t,e){const i=new Int32Array(t),n=new Float32Array(t),s=new Float32Array(e),a={},l=i[0];this.encodedUsingMeshOpt=l>=3;const c=i[1];for(let h=2;h<i.length;h+=c){const d=new zw(i,n,s,h,l);this.lightmapCount=Math.max(this.lightmapCount,d.lightmapIdx+1);const u=d.vertexByteOffset;if(!Object.hasOwn(a,u))a[u]=[d];else{const f=a[u],p=f[0];p.isMasterCopy=!0,p.hasCopies=!0,d.hasCopies=!0,f.push(d)}this._allMeshProps.push(d)}for(const h of Object.values(a))(h.length-1)*h[0].faceCnt>Vw&&h.forEach(f=>f.useInstances=!0)}_computeGeometrySizeInfo(){const t=h=>h+3&-4;let e=0,i=0,n=0,s=0,a=0,l=0,c=0;for(const h of this._allMeshProps){const d=h.vertexCnt;this._totalVertexCount+=d,this._totalFaceCount+=h.faceCnt,e=Math.max(e,h.faceByteOffset+h.faceCnt*3*(h.useFaces16?2:4)),i=Math.max(i,t(h.vertexByteOffset+d*3*Fc(h.quantVertexMax))),n=Math.max(n,h.normalByteOffset+d*2),s=Math.max(s,h.transformByteOffset+16*4),a=Math.max(a,h.boundsByteOffset+7*4),h.uv0ByteOffset!==-1&&(l=Math.max(l,t(h.uv0ByteOffset+d*2*Fc(h.quantVertexMax)))),h.uv1ByteOffset!==-1&&(c=Math.max(c,h.uv1ByteOffset+d*2*2))}this.coreGeometryDownloadSize=this._meshesBufferLength+e+i+n+s+a,this.geometryDownloadSize+=this.coreGeometryDownloadSize+l+c}_createLogicalMesh(t,e,i,n){const s=new Tn(t,e,i.material);return s.lightmap=i.lightmap,s.lightProbes=i.lightProbes,s.autoLightmapResolution=n.autoLightmapResolution,this.meshToProps.set(s,n),s.lightmapIdx=n.lightmapIdx,n.hasCopies&&(n.isMasterCopy?s.sharedBuffersDebug=1:s.sharedBuffersDebug=2),this._logicalMeshesCount+=1,i.addLogicalMesh(s),s}_assignMeshesToGroups(t){const e=new Array,i=new Map,n=s=>{var x;const a=this._scene.findNode(s.nodeId),l=(x=T.EDIT_MODE?void 0:a.config.overriddenMaterialId)!=null?x:s.materialId,c=this._scene.materialManager.getMaterial(l);let h=new Array;a.initialLightProbeIds!==null&&(h=this._scene.findLightProbes(a.initialLightProbeIds));let d=null;s.lightmapIdx!==-1&&(d=t[s.lightmapIdx]);const u=a.hideInViews||[],f=a.editableRoot;let p=a.editable||c.transparent;if(c.reflective&&c.roughness<.2&&(p=!0),p){e.push(new pv(s,c,d,h,u,f));return}const m=s.getSharedGeometryId(),b=i.get(c)||[];for(const w of b)if(Nc(w.lightProbes,h)&&w.editableRootNode===f&&w.canUseLightmap(d)&&w.sharedGeometryId===m&&Nc(w.hideInViews,u)){d!==null&&(w.lightmap=d),w.anyLogicalMeshHasUvs=w.anyLogicalMeshHasUvs||s.uv0Needed(),w.meshPropsSet.add(s);return}const g=new pv(s,c,d,h,u,f);b.push(g),i.set(c,b),e.push(g)};return this._allMeshProps.forEach(n),e}createMeshes(t){const e=t?t[0]:null,i=this._assignMeshesToGroups(t),n={};for(const s of i){let a;const l=s.sharedGeometryId;if(l!==void 0){let h=n[l],d=!1;h||(h=new xa,d=!0,n[l]=h),a=new eh(h,d)}else a=new xa;const c=new Co(a,s.material);c.lightProbes=s.lightProbes,c.lightmap=s.lightmap||e,c.hideInViews=s.hideInViews,c.anyLogicalMeshHasUvs=s.anyLogicalMeshHasUvs,c.editableRootNode=s.editableRootNode,this.mergedMeshes.push(c);for(const h of s.meshPropsSet){const d=Gw(h,a,this._useIndexedGeometry),u=this._scene.findNode(h.nodeId);u.mesh=this._createLogicalMesh(u,d,c,h),u.mesh.originalMaterialId=h.materialId}}Re.log(`Have ${this._logicalMeshesCount} meshes and ${this.mergedMeshes.length} merged meshes.`)}}const mv=512*1024,_v=12*1024*1024;function Ww(r,t,e,i,n,s){const a=!e,l=!e&&!T.DEBUG_SHARED_BUFFERS,c=new No;this.onProgress=null,this.onMeshBuffersLoaded=null,this.onReadyToDisplay=null,this.onComplete=null,this.panoramas=[],this.load=function(){mt.createNewProfileFrame({name:"Webwalk init",log:!0}),mt.beginSection("SceneLoader.load");const h=this;let d=null,u=null,f=!1,p=!1,m=!1,b,g=null,x=!1,w=!1,C=T.CPU_COLLIDER&&!T.NO_COLLISIONS,M={total:void 0,texturesDone:0,totalDone:function(){return this.texturesDone+d.totalDone()}};function D(){M.total&&h.onProgress(M.totalDone()/M.total)}function W(){p||(p=!0,h.onReadyToDisplay(r))}function z(){!m||!f||C&&!w||n.loadingProgress().isFinished()&&(n.freeLoadingBuffers(),n.onTextureLoaded=void 0,d=u=null,r.sharedMaterialState.clearDefaultLightmaps(),Uc(()=>{W(),h.onComplete(r)}))}function $(he){he.geometry.addUv1Attribute(),h.onMeshBuffersLoaded(he)}function Z(){d.buffers.uvs1&&(b=z,Dw(d.buffers.uvs1,u.mergedMeshes,u.meshToProps,u.encodedUsingMeshOpt,qs,$,function(){d.buffers.uvs1=null,m=!0,b()}))}function ne(he){he.geometry.isUvs0Repeating&&he.material.ensureTexturesRepeatable(),he.geometry.addUv0Attribute(),h.onMeshBuffersLoaded(he)}function Me(){d.buffers.uvs0&&(b=Z,Iw(d.buffers.uvs0,u.mergedMeshes,u.meshToProps,ne,function(){d.buffers.uvs0=null,b()}))}function Xe(){var he;(he=g.views)==null||he.forEach(tt=>r.addView(new hn(tt,r.center))),r.createDefaultViews()}function xe(){if(f=!0,Xe(),!e&&!r.disableProgressiveLoader&&!T.PUPPETEER_TEST){const tt=1e3*T.PROGRESSIVE_LOADER_AFTER_SEC-c.elapsedMSec();tt<=0?W():setTimeout(W,tt)}b()}function Le(he){T.DEV_NEW_SCENE||r.addGpuMesh(he)}function B(he){he.geometry.addCoreAttributes();const tt=he.logicalMeshes;console.assert(!tt[0].node.editable||tt.length===1),tt[0].node.editable||!l?tt.forEach(Le):Le(he),h.onMeshBuffersLoaded(he)}function Y(he){he.geometry.isUvs0Repeating&&he.material.ensureTexturesRepeatable(),he.geometry.uvs0&&he.geometry.addUv0Attribute(),he.geometry.uvs1&&he.geometry.addUv1Attribute(),B(he)}function re(){if(a){if(!d.haveCoreBuffers())return;Re.log("Using indexed geometry"),b=Me,Lw(d.buffers,u.mergedMeshes,u.meshToProps,u.encodedUsingMeshOpt,qs,B,xe)}else{if(!d.haveAllBuffers())return;b=z,Fw(d.buffers,u.mergedMeshes,u.meshToProps,u.encodedUsingMeshOpt,qs,Y,()=>{m=!0,xe()})}d==null||d.releaseCoreBuffersExceptTransform()}function le(){qs.ready.then(()=>{x=!0,b()})}function ge(){var he,tt;g&&(b=pe,g.autoAddLightProbes!==void 0&&(r.autoAddLightProbes=g.autoAddLightProbes),r.disableProgressiveLoader=g.disableProgressiveLoader||!1,g.interactionPrompt&&(r.interactionPrompt=g.interactionPrompt),g.autoTour!==void 0&&(r.autoTour.disabled=g.autoTour.disabled||!1,r.autoTour.startOnLoad=g.autoTour.startOnLoad||!1),g.emissiveMaterialsLightEnabled!==void 0&&(r.emissiveMaterialsLightEnabled=g.emissiveMaterialsLightEnabled),r.addLights(On.loadLights(g.lights)),T.NO_REFLECTION_PROBES||(he=g.lightProbes)==null||he.forEach(Ze=>r.addLightProbe(new nn(Ze,T.NO_REFLECTION_PROBE_BOXES))),r.camera.setFromJson(g.camera),(tt=g.cameraVolumes)==null||tt.forEach(Ze=>r.addCameraAdjustmentVolume(new kf(Ze,r.camera,r.exposureController))),r.addNodeConfigsFromJson(g,i),r.addNodesFromJson(g),b())}function pe(){var N;if(!g||!d.buffers.meshes||!d.buffers.bounds||!x)return;b=re,T.DEV_NEW_RENDER_ARCHITECTURE&&pt.get().setMainScene(r),(N=g.camera)!=null&&N.lutTexture&&(r.camera.colorMap=n.loadColorMap(g.camera.lutTexture)),n.loadAtlases(g.atlases||[]),new xf(n,i).load(g,r.materialManager),r.lightmapLayoutVersion=g.lightmap?g.lightmap.lightmapLayoutVersion:0,r.lightmapLayoutVersion=r.lightmapLayoutVersion||0,new zf(n).load(g.skies||[],r),r.findSkyMesh(T.EDITOR_CONTROLLED_SKY_NAME)===null&&console.error("A sky with name "+T.EDITOR_CONTROLLED_SKY_NAME+" is missing."),u=new Hw(r,d.buffers.meshes,d.buffers.bounds,a);let Ze=null;if(u.lightmapCount!==0){let U=new Bw(u.lightmapCount,g.lightmap),k;[k,Ze]=U.load(n),r.setLightmapEncoding(k),U=null}if(u.createMeshes(Ze),T.EDIT_MODE&&r.materialManager.initializeMaterialOverrides(r.nodeConfigs),M.total=u.geometryDownloadSize+(n.loadingProgress().totalResources-u.lightmapCount)*mv+u.lightmapCount*_v,g.panoramas&&(h.panoramas=g.panoramas),r.minimapConfig=new Vl(g,r.boundingBox),!T.NO_BRDFLUT&&!$e.isLongShaderExecutionProblematicDevice()){const U=$e.ios?512:2048,k=qg(s,U);r.addBrdfLUT(k)}n.onTextureLoaded=U=>{M.texturesDone+=U.name.indexOf("lightmap-")===0?_v:mv,D(),b()},b()}function Ae(he){g=he,b()}c.reset(),C&&wx().then(()=>{w=!0,b()}),b=ge;const Fe=()=>ii.sceneLoadError();Mo(T.LOAD_PRIORITY.CORE_RESOURCE,t+"scene.json",!1,Ae,Fe),d=new Cw(t,!a),d.onProgress=D,d.onFailure=Fe,d.onHaveBuffer=function(){b()},d.load(),le()},this.elapsedLoadTimeSec=function(){return c.elapsedSec()}}const gv=T.DEBUG;class Lh{constructor(t){o(this,"_renderer");o(this,"_renderTargets");o(this,"_mapUvStep",new ye);o(this,"_mapUvOffsetScale",new We);o(this,"_mapUvScale",new ye);o(this,"_alphaStatsPass",Lh._constructAlphaPass(this._mapUvStep,this._mapUvOffsetScale));o(this,"_alphaStatsCombinePass",Lh._constructCombinePass(this._mapUvScale,this._mapUvStep));o(this,"_resultBuf",new Uint8Array(4*1024));o(this,"_debugTimer",gv?new No:void 0);this._renderer=t;const e={magFilter:H.NEAREST,minFilter:H.NEAREST,stencilBuffer:!1,depthBuffer:!1,generateMipmaps:!1};this._renderTargets=[this._renderer.createRenderTarget(1024,1024,e),this._renderer.createRenderTarget(512,512,e)]}static _constructCombinePass(t,e){const i={uniforms:{map:{type:"t",value:null},mapUvStep:{type:"v2",value:null},mapUvScale:{type:"v2",value:null}},vertexShaderName:"alpha_stats_vertex.glsl",fragmentShaderName:"alpha_stats_combine_fragment.glsl"},n=new ds(i,"map");return n.material.depthTest=!1,n.material.depthWrite=!1,n.uniforms.mapUvScale.value=t,n.uniforms.mapUvStep.value=e,n}static _constructAlphaPass(t,e){const i={uniforms:{map:{type:"t",value:null},mapUvStep:{type:"v2",value:null},mapUvOffsetScale:{type:"v4",value:null}},vertexShaderName:"alpha_stats_vertex.glsl",fragmentShaderName:"alpha_stats_fragment.glsl"},n=new ds(i,"map");return n.material.depthTest=!1,n.material.depthWrite=!1,n.uniforms.mapUvStep.value=t,n.uniforms.mapUvOffsetScale.value=e,n}detect(t){var x;const e=t instanceof Xc;let i,n,s,a,l;if(e?(i=t.parentTexture,n=t.uvOffsetScale.x,s=t.uvOffsetScale.y,a=t.uvOffsetScale.z,l=t.uvOffsetScale.w):(i=t,n=s=0,a=l=1),!i.hasAlpha||i instanceof jr){t.isCutout=!1;return}(x=this._debugTimer)==null||x.reset(),this._renderer.enableScissorTest(!0);const c=i.width*a,h=i.height*l;this._mapUvStep.set(1/c,1/h),this._mapUvOffsetScale.set(n,s,a,l);let d=Math.max(Math.floor(c/2),1),u=Math.max(Math.floor(h/2),1);this._renderer.setRenderTarget(this._renderTargets[0]),this._renderer.setViewport(0,0,d,u),this._renderer.setScissor(0,0,d,u),this._alphaStatsPass.render(this._renderer,this._renderTargets[0],i);let f=1,p=this._renderTargets[0];for(;d!==1&&u!==1;){this._mapUvStep.set(1/p.width,1/p.height),this._mapUvScale.set(d/p.width,u/p.height),d=Math.floor(d/2),u=Math.floor(u/2);const w=this._renderTargets[f];this._renderer.setRenderTarget(w),this._renderer.setViewport(0,0,d,u),this._renderer.setScissor(0,0,d,u),this._alphaStatsCombinePass.render(this._renderer,w,p),p=w,f=(f+1)%2}this._renderer.readPixels(d,u,this._resultBuf);let m=0,b=0;const g=Math.max(d,u);for(let w=0;w<g;++w)m+=this._resultBuf[4*w],b+=this._resultBuf[4*w+1];if(m=100*m/(255*g),b=100*b/(255*g),t.isCutout=m<20||b>50,gv){this._debugTimer;let w="";e&&(w+=`From atlas: ${i.name} [${n}, ${s}, ${a}, ${l}]
`),console.log(`${t.name} ${i.width}x${i.height}
${w}Is cutout: ${t.isCutout}
Partialy transparent regions: ${m}%
Fully transparent pixels: ${b}%
Time: ${this._debugTimer.elapsedSec()}
`)}this._renderer.enableScissorTest(!1)}dispose(){this._renderTargets[0].dispose(),this._renderTargets[1].dispose(),this._alphaStatsPass.dispose(),this._alphaStatsCombinePass.dispose()}}const Ef=512*1024;class jw{constructor(t,e){o(this,"onTextureLoaded");o(this,"_renderer");o(this,"_textureLoader");o(this,"_cutoutDetector");o(this,"_loadingProgress",new Vf);o(this,"_textures",new Array);o(this,"_idToTexture",new Map);o(this,"_atlases",new Map);o(this,"_onLoadSuccess",t=>{this._addToProgress(t),T.DEV_NEW_RENDER_ARCHITECTURE?pt.get().uploadTexture(t):this._renderer.uploadTexture(t),t.isAtlas()?t.forEachAtlasEntry(e=>{console.assert(e.isCutout===void 0),this._detectCutout(e)}):t.isCutout===void 0&&this._detectCutout(t)});o(this,"_onLoadFailed",t=>{this._addToProgress(t);const e=`Failed to load texture <i>${this._textureLoader.getTexturePath(t)}</i><br><hr><ul><li>The server may be misconfigured for this type of file.</li><li>The ad blocker in your browser may be incorrectly classifying the texture as an ad banner.</li></ul>`;ii.sceneLoadError(e)});o(this,"_onLoadFailedSoft",t=>{this._addToProgress(t),ii.info("Failed to load texture")});o(this,"_onVideoLoadFailed",t=>{this._addToProgress(t),console.warn("Failed to load video texture")});this._renderer=e,this._textureLoader=new rM(t,$e,this._onLoadSuccess,this._onLoadFailed,this._onLoadFailedSoft,this._onVideoLoadFailed)}_addToProgress(t){var e;this._loadingProgress.loadedBytes+=Ef,this._loadingProgress.loadedResources++,(e=this.onTextureLoaded)==null||e.call(this,t)}_detectCutout(t){this._cutoutDetector||(this._cutoutDetector=new Lh(this._renderer)),t.isCutout===void 0&&this._cutoutDetector.detect(t)}remove(t){const e=this._idToTexture.get(t);if(e===void 0)return!1;delete this._textures[e],this._idToTexture.delete(t)}findTexture(t){const e=this._idToTexture.get(t);if(e===void 0)return;const i=this._textures[e],n=i==null?void 0:i.deref();if(!(n!=null&&n.isDisposed()))return n;delete this._textures[e],this._idToTexture.delete(t)}load(t,e=En.DEFAULT,i=0,n=!1,s=!1){t instanceof Wr||(t=Wr.parse(t)),Ce(t.id);let a=this.findTexture(t.id);if(a===void 0){a=t.video?new jr:new st,a.initFromJson(t,e);const l=this._textures.length;this._textures.push(new WeakRef(a)),this._idToTexture.set(t.id,l),s?a.loadingStatus=fr.POSTPONED:(this._textureLoader.load(a,i,n),this._loadingProgress.totalBytes+=Ef,this._loadingProgress.totalResources++)}else!s&&a.loadingStatus===fr.POSTPONED&&(this._textureLoader.load(a,i,n),this._loadingProgress.totalBytes+=Ef,this._loadingProgress.totalResources++);return a}loadPostponed(t,e=0,i=!1){for(const n of t){const s=this.findTexture(n);s!==void 0&&s.loadingStatus===fr.POSTPONED&&this._textureLoader.load(s,e,i)}}loadColorMap(t){const e=this.load(t,En.NONE,T.LOAD_PRIORITY.COLORMAP);return e.anisotropy=st.NO_ANISOTROPY,e.flipY=!1,e}atlases(){return this._atlases}loadAtlases(t){if(t.length!==0)for(const e of t){const i=Wr.parse(e),n=this.load(i,En.DEFAULT,T.LOAD_PRIORITY.DIFFUSE);n.flipY=!1,n.enableAtlas(),Ce(typeof i.id=="string"),this._atlases.set(i.id,n)}}loadingProgress(){return this._loadingProgress}freeLoadingBuffers(){this._cutoutDetector=void 0}}const vv=1024*1024,zl=Math.round,dn=zl(window.devicePixelRatio||1),Af=100*dn,bv=48*dn,yv=3*dn,xv=2*dn,Da=3*dn,Wo=15*dn,La=94*dn,Oa=30*dn;let Ev=0,Tf=0;function Xw(r){if(T.LOG_FPS){const t=T.LOG_FPS_SKIP_INITIAL_SEC?parseInt(T.LOG_FPS_SKIP_INITIAL_SEC):0;if(Tf++,Tf>t){Ev+=r;const e=Ev/(Tf-t);Re.log(`Fps:${r} Average Fps:${e}`)}}}class Gl{constructor(t,e,i){o(this,"name");o(this,"min",1/0);o(this,"fg");o(this,"bg");o(this,"max",0);o(this,"canvas");o(this,"context");o(this,"dom");this.name=t,this.min=1/0,this.fg=e,this.bg=i,this.canvas=document.createElement("canvas"),this.canvas.width=Af,this.canvas.height=bv,this.canvas.style.cssText="width:100px;height:48px",this.context=this.canvas.getContext("2d"),this.context.font="bold "+9*dn+"px Helvetica,Arial,sans-serif",this.context.textBaseline="top",this.context.fillStyle=this.bg,this.context.fillRect(0,0,Af,bv),this.context.fillStyle=this.fg,this.context.fillText(this.name,yv,xv),this.context.fillRect(Da,Wo,La,Oa),this.context.fillStyle=this.bg,this.context.globalAlpha=.9,this.context.fillRect(Da,Wo,La,Oa),this.dom=this.canvas}update(t,e){this.min=Math.min(this.min,t),this.max=Math.max(this.max,t),this.context.fillStyle=this.bg,this.context.globalAlpha=1,this.context.fillRect(0,0,Af,Wo),this.context.fillStyle=this.fg,this.context.fillText(zl(t)+" "+this.name+" ("+zl(this.min)+"-"+zl(this.max)+")",yv,xv),this.context.drawImage(this.canvas,Da+dn,Wo,La-dn,Oa,Da,Wo,La-dn,Oa),this.context.fillRect(Da+La-dn,Wo,dn,Oa),this.context.fillStyle=this.bg,this.context.globalAlpha=.9,this.context.fillRect(Da+La-dn,Wo,dn,zl((1-t/e)*Oa))}}class qw{constructor(){o(this,"frames");o(this,"mode");o(this,"memPanel");o(this,"beginTime");o(this,"prevTime");o(this,"fpsPanel");o(this,"msPanel");o(this,"performance");o(this,"container",document.createElement("div"));o(this,"dom");this.mode=0,this.performance=performance,this.container.style.cssText="position:fixed;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000",this.container.addEventListener("click",t=>{t.preventDefault(),this.showPanel(++this.mode%this.container.children.length)},!1),this.beginTime=(performance||Date).now(),this.prevTime=this.beginTime,this.frames=0,this.fpsPanel=this.addPanel(new Gl("FPS","#0ff","#002")),this.msPanel=this.addPanel(new Gl("MS","#0f0","#020")),this.performance&&this.performance.memory&&(this.memPanel=this.addPanel(new Gl("MB","#f08","#201"))),this.showPanel(0),this.dom=this.container}update(){this.beginTime=this.end()}begin(){this.beginTime=(performance||Date).now()}end(){this.frames++;const t=(performance||Date).now();if(this.msPanel.update(t-this.beginTime,200),t>=this.prevTime+1e3){const e=this.frames*1e3/(t-this.prevTime);if(this.fpsPanel.update(e,100),Xw(e),this.prevTime=t,this.frames=0,this.memPanel){const i=this.performance.memory;this.memPanel.update(i.usedJSHeapSize/vv,i.jsHeapSizeLimit/vv)}}return t}addPanel(t){return this.container.appendChild(t.dom),t}showPanel(t){for(let e=0;e<this.container.children.length;e++)this.container.children[e].style.display=e===t?"block":"none";this.mode=t}}class Yw{constructor(t){o(this,"stats",new qw);o(this,"perf");o(this,"ms");o(this,"fps");this.stats.showPanel(0),T.BENCHMARK&&(this.perf=new HE(t,T.BENCHMARK),this.ms=this.stats.addPanel(new Gl("RenderMS","#ff8","#221")),this.fps=this.stats.addPanel(new Gl("ApproxFPS","#ff8","#221"))),document.body.appendChild(this.stats.dom)}begin(){T.BENCHMARK&&(this.perf,this.perf.begin()),this.stats.begin()}end(){T.BENCHMARK&&(this.perf&&this.ms&&this.fps,this.perf.end(),this.ms.update(this.perf.lastMS,100),this.fps.update(this.perf.lastFPS,100)),this.stats.end()}}/*!
 * Copyright (C) 2015-present Shapespark
 */function wf(r,t){Array.from(document.getElementsByClassName(r)).forEach(t)}function Qw(r){const t=new Array;wf(r,function(e){t.push(e)});for(const e of t)e.classList.remove(r)}function zn(r,t){r.style.display=t?"":"none"}function ir(r,t){zn(Tt(r),t)}function Oh(r,t){wf(r,e=>{zn(e,t)})}function Av(r){zn(r,!0),r.style.opacity="0",Uc(function(){r.style.opacity="1"})}function Kw(){let r=document.getElementById("qr-code-canvas");if(r){r.remove();return}r=document.createElement("canvas"),r.setAttribute("id","qr-code-canvas"),document.body.appendChild(r),QRCode.toCanvas(r,window.location.toString())}function Sf(r){r.style.opacity="0";const t=window.getComputedStyle(r).transitionDuration;if(t){let e=parseFloat(t);t.indexOf("ms")===-1&&(e*=1e3),setTimeout(function(){zn(r,!1),r.style.opacity="1.0"},e)}else zn(r,!1),r.style.opacity="1.0"}var Tv=(r=>(r.VISIBILITY_CHANGED="menuVisibilityChanged",r))(Tv||{});const _c=class _c extends ci{constructor(e,i,n,s,a,l=!0){super();o(this,"cover");o(this,"_editMode");o(this,"_gamepadManager");o(this,"_toggleVr");o(this,"_toggleFullScreen");o(this,"_togglePointerLock");o(this,"_scene");o(this,"_teleport");o(this,"_autoTour");o(this,"_screenshotTaker");o(this,"_vrSupported",!1);o(this,"_fullScreenSupported",!1);o(this,"_pointerLockSupported",!1);o(this,"_pointerLockEnabled",!1);o(this,"_vrEnabled",!1);o(this,"_showMenuSetting");o(this,"_showHelpSetting",!1);o(this,"_advancedDesktopHelp",!1);o(this,"_forceInfoTextTimer");o(this,"_interactionPrompt",!1);this._editMode=e,this._gamepadManager=i,this._toggleVr=n,this._toggleFullScreen=s,this._togglePointerLock=a,this._showMenuSetting=l}_visibleViews(){return this._scene?this._scene.visibleViews():[]}_findViewByIdx(e){const i=this._visibleViews();if(i.length>e)return i[e]}_findUiView(e){if(!e)return;const n=this._visibleViews().findIndex(a=>a===e);return n===-1?void 0:Tt("view-list-items").children[n]}_removeUiViewHighlight(e){return()=>{e.classList.remove("active-view"),e.classList.remove("next-active-view")}}_removeAllUiViewsHighlight(){const e=Array.from(Tt("view-list-items").children);for(const i of e)i.classList.remove("active-view"),i.classList.remove("next-active-view")}_onTourStarted(){Tt("tour-button").classList.add("tour-on")}_onTourStopped(){Tt("tour-button").classList.remove("tour-on"),this._removeAllUiViewsHighlight()}_toggleAutoTour(){this._autoTour.isRunning()?this._autoTour.stop():this._autoTour.start()}_stopAutoTour(){return this._autoTour.isRunning()?(this._autoTour.stop(),!0):!1}_onTeleportStarted(e){this._removeAllUiViewsHighlight();const i=this._findUiView(e.view);i&&i.classList.add("next-active-view")}_onTeleportDone(e){const i=this._findUiView(e.view);i&&(i.classList.remove("next-active-view"),i.classList.add("active-view"),setTimeout(this._removeUiViewHighlight(i),T.AUTO_TOUR_IN_VIEW_STILL_TIME_MS))}_viewClicked(e){return $m(()=>{const i=this._stopAutoTour();this._teleport.switchToView(e,i?0:void 0)})}_fillCover(){Ce(this.cover);const e=this.cover.title,i=this.cover.author,n=this.cover.authorHref,s=this.cover.engineLogoOn,a=this.cover.engineLogoText,l=this.cover.engineLogoUrl;let c=this.cover.authorLogoUrl;this.cover.authorLogo&&(c=Ja(this.cover.authorLogo.path));const h=Tt("author-logo"),d=h.firstElementChild;c?(n&&(h.href=n),d.src=c):(zn(h,!1),d.removeAttribute("src"));const u=!this._scene||!!this._forceInfoTextTimer;ir("info-text",u&&(!!e||!!i)),u&&(ma(Tt("info-title"),e),ma(Tt("info-author"),i),n&&(Tt("info-author").href=n));let f="";e?f=e:f="3D scene",i&&(f+=" by "+i),document.title=f;const p=Tt("engine-logo");if(zn(p,s),s){if(a){const m=Tt("engine-logo-text");zn(m,!0),ma(m,a)}l&&(p.href=l)}}_fillUiViews(e,i){let n=i.children[0];for(this._removeUiViewHighlight(n)();i.children.length>1;)i.removeChild(i.children[i.children.length-1]);for(const s of e)s.hideFromMenu||(ma(n,s.name),n.onclick=this._viewClicked(s),i.appendChild(n),n=n.cloneNode(!0))}_refreshMenu(){const e=Tt("info-bar"),i=Tt("info-bar-slide"),n=Tt("view-list"),s=Tt("view-list-slide"),a=Tt("menu-bar"),l=Tt("menu-bar-slide"),c=Tt("menu-bar-folder"),h=Tt("view-mode-slide");if(zn(c,!!this._scene&&!this._pointerLockEnabled),this.visible)e.style.pointerEvents="auto",i.style.left="0",n.style.pointerEvents="auto",s.style.top="0",a.style.pointerEvents="auto",l.style.right="0",c.style.pointerEvents="auto",c.children[0].style.transform="",h&&(h.style.left="0");else{const f=Tt("menu-bar-content");e.style.pointerEvents="none",i.style.left=-i.offsetWidth+"px",n.style.pointerEvents="none",s.style.top=-s.offsetHeight+"px",a.style.pointerEvents="none",c.style.pointerEvents="auto",l.style.right=-f.offsetWidth+"px",c.children[0].style.transform="rotate(180deg)",h&&(h.style.left=-h.offsetWidth+"px");return}this.cover&&this._fillCover();const d=this._visibleViews(),u=Tt("view-list-items");ir("view-list",d.length>0&&!this._pointerLockEnabled),d.length>0&&this._fillUiViews(d,u),ir("menu-buttons",!!this._scene&&!this._pointerLockEnabled),this._scene&&this._scene.canStartAutoTour()&&!this._vrEnabled?ir("tour-button",!0):(this._autoTour&&this._autoTour.isRunning()&&this._autoTour.stop(),ir("tour-button",!1))}_refreshHelp(){const e=this.helpVisible;if($e.mobile)ir("mobile-help",e);else if(ir("desktop-help",e),e){const i=Tt("desktop-help-switch"),n=Tt("desktop-help-content"),s=this._advancedDesktopHelp?1:0;i.children[s].classList.add("selected"),zn(n.children[s],!0),i.children[1-s].classList.remove("selected"),zn(n.children[1-s],!1)}}_toggleMenu(){this.visible=!this._showMenuSetting}_toggleHelp(){this.helpVisible=!this._showHelpSetting}_switchToBasicDesktopHelp(){this._advancedDesktopHelp=!1,this.refresh()}_switchToAdvancedDesktopHelp(){this._advancedDesktopHelp=!0,this.refresh()}_switchToPreviousView(){const e=this._stopAutoTour();this._teleport.switchToPreviousVisibleView(e?0:void 0)}_switchToNextView(){const e=this._stopAutoTour();this._teleport.switchToNextVisibleView(e?0:void 0)}_showInteractionPrompt(){const e=Tt("interaction-prompt");e&&(this._interactionPrompt=!0,Av(e))}_hideInteractionPrompt(){this._interactionPrompt&&(this._interactionPrompt=!1,Sf(Tt("interaction-prompt")))}_onKeyDown(e){if(this._hideInteractionPrompt(),e.ctrlKey||e.altKey||e.metaKey)return;const i=e.target||e.srcElement,n=i.nodeType===Node.ELEMENT_NODE?i.nodeName.toUpperCase():"";if(/INPUT|SELECT|TEXTAREA/.test(n))return;if(T.DEBUG){if(e.key.toLowerCase()==="c"){const a=$e.gl.extension("WEBGL_lose_context");nt(a),e.shiftKey?a.restoreContext():a.loseContext()}e.key==="r"&&kS()}if(!this._scene)return;switch(e.key.toLowerCase()){case"escape":this._stopAutoTour();break;case"f":this._fullScreenSupported&&this._toggleFullScreen();break;case"l":this._pointerLockSupported&&this._togglePointerLock();break;case"h":this._toggleHelp();break;case"m":this._toggleMenu();break;case"v":this._vrSupported&&this._toggleVr();break;case"p":T.NO_SCREENSHOTS||(e.shiftKey?this._screenshotTaker.monoScreenToLocalImage(!0,4e3,2e3):this._screenshotTaker.monoScreenToLocalImage(!1,window.innerWidth,window.innerHeight));break;case"u":So(yi("lib/qrcode.js"),Kw,()=>ii.error("Cannot load required library"));break;case"[":this._switchToPreviousView();break;case"]":this._switchToNextView();break}const s=parseInt(e.key);if(!isNaN(s)){const a=this._findViewByIdx(s-1);a&&this._viewClicked(a)(e)}}_onMousePressed(){this._hideInteractionPrompt()}_onWheelScroll(){this._hideInteractionPrompt()}_onTouchStart(){this._hideInteractionPrompt()}_onGamepadActionActivated(e){switch(this._hideInteractionPrompt(),e.action){case Oe.PREVIOUS:this._switchToPreviousView();break;case Oe.NEXT:this._switchToNextView();break}}refresh(){this._refreshMenu(),this._refreshHelp()}get visible(){const e=this._vrEnabled&&$e.mobile;return this._showMenuSetting&&!e}set visible(e){const i=this.visible;this._showMenuSetting=e,i!==this.visible&&this.dispatchEvent({type:_c.eventType.VISIBILITY_CHANGED}),this.refresh()}get helpVisible(){const e=this._vrEnabled&&$e.mobile;return this._showHelpSetting&&!e&&!this._pointerLockEnabled}set helpVisible(e){this._showHelpSetting=e,this.refresh()}updateCover(e){this.cover=e,this._forceInfoTextTimer!==void 0&&clearTimeout(this._forceInfoTextTimer),this._forceInfoTextTimer=setTimeout(()=>{this._forceInfoTextTimer=void 0,this.refresh()},5e3),this.refresh()}onFullScreenChange(e){}onPointerLockChange(e){this._pointerLockEnabled=e,this.refresh()}onVrChange(e){const i=this.visible;this._vrEnabled=e,i!==this.visible&&this.dispatchEvent({type:_c.eventType.VISIBILITY_CHANGED}),this.refresh()}onResize(){if(!this.visible){const e=[Tt("info-bar-slide"),Tt("menu-bar-slide"),Tt("view-list-slide")];e.forEach(i=>i.style.transition="none"),this.refresh(),e.forEach(i=>i.style.transition="")}}enablePlayButton(e){const i=Tt("play-button");i.addEventListener("click",e),zn(i,!0)}setVrSupported(e){this._vrSupported=e,Oh("vr-specific",e)}setFullScreenSupported(){this._fullScreenSupported=!this._editMode,this._fullScreenSupported&&Oh("fullscreen-specific",!0)}setPointerLockSupported(){this._pointerLockSupported=!this._editMode}addExtraButton(e){const i=Tt("tour-button"),n=document.createElement("img");n.src=e;const s=document.createElement("div");return s.className="menu-button menu-item ui-hoverable ui-panel",s.appendChild(n),i.parentNode.insertBefore(s,i),s}removeExtraButton(e){e.remove()}getExtraButonIcon(e){return e.firstElementChild}sceneLoadStarted(){ir("play-button",!1),ir("primary-progress",!0)}loadProgress(e){if(!this._scene){const s=Math.max(314.159*(1-e),0);Tt("primary-progress-done").style.strokeDashoffset=s.toString()}const n=Math.floor(e*100);Tt("secondary-progress-done").style.width=n+"%"}sceneReadyToDisplay(e,i,n,s){this._scene=e,this._teleport=i,this._teleport.addEventListener(ps.eventType.TELEPORT_STARTED,this._onTeleportStarted.bind(this)),this._teleport.addEventListener(ps.eventType.TELEPORT_DONE,this._onTeleportDone.bind(this)),this._autoTour=n,this._autoTour.addEventListener(cl.eventType.TOUR_STARTED,this._onTourStarted.bind(this)),this._autoTour.addEventListener(cl.eventType.TOUR_STOPPED,this._onTourStopped.bind(this)),this._screenshotTaker=s,Sf(Tt("cover-image")),Sf(Tt("primary-progress")),Av(Tt("secondary-progress"));const a=rn();this._scene.interactionPrompt&&!this._showHelpSetting&&!T.EDIT_MODE&&(a._isMeeting()?a._onMeetingJoined(()=>this._showInteractionPrompt()):this._showInteractionPrompt()),this._scene.addEventListener(Hi.eventType.VIEW_ADDED,()=>this.refresh()),this._scene.addEventListener(Hi.eventType.VIEW_REMOVED,()=>this.refresh()),this._scene.addEventListener(Hi.eventType.VIEW_SHIFTED,()=>this.refresh()),document.body.style.backgroundImage="none",document.body.style.backgroundColor="#000",this.refresh()}sceneLoadComplete(){ir("secondary-progress",!1)}init(){this._editMode&&(Oh("viewer-specific",!1),Oh("editor-specific",!0)),wf("ui-panel",n=>lh(n)),$e.mobile&&Qw("ui-hoverable");const e=Tt("author-logo"),i=e.firstElementChild;i.onload=()=>zn(e,!0),i.onerror=()=>zn(e,!1),document.addEventListener("keydown",this._onKeyDown.bind(this),!1),document.addEventListener("mousedown",this._onMousePressed.bind(this),!1),document.addEventListener("wheel",this._onWheelScroll.bind(this),!1),document.addEventListener("touchstart",this._onTouchStart.bind(this),!1),Ki("help-button",this._toggleHelp.bind(this)),Ki("fullscreen-button",this._toggleFullScreen),Ki("vr-button",this._toggleVr),Ki("tour-button",this._toggleAutoTour.bind(this)),Ki("menu-bar-folder",this._toggleMenu.bind(this)),Ki("view-list-folder",this._toggleMenu.bind(this)),Ki("basic-desktop-help-option",this._switchToBasicDesktopHelp.bind(this)),Ki("advanced-desktop-help-option",this._switchToAdvancedDesktopHelp.bind(this)),Ki("close-desktop-help-button",this._toggleHelp.bind(this)),Ki("close-mobile-help-button",this._toggleHelp.bind(this)),this._gamepadManager.addEventListener(Oo.actionActivated,this._onGamepadActionActivated.bind(this)),this.refresh()}contextLost(){this._scene=this._teleport=this._autoTour=this._screenshotTaker=void 0,this.refresh()}};o(_c,"eventType",Tv);let Fh=_c;function wv(r,t){return Math.abs(r.x-t.x)<Number.EPSILON&&Math.abs(r.y-t.y)<Number.EPSILON&&Math.abs(r.z-t.z)<Number.EPSILON}function Mf(){return window.innerWidth<640||window.innerHeight<640}function Sv(r,t,e){const i=Math.sin(t),n=Math.cos(t),s=(r.x-e.x)*n-(r.y-e.y)*i+e.x,a=(r.x-e.x)*i+(r.y-e.y)*n+e.y;r instanceof L?r.set(s,a,r.z):r.set(s,a)}function $w(r){const t=document.createElement("canvas");t.width=r,t.height=r;const i=60*Math.PI/180,n=-i/2-Math.PI/2,s=i/2-Math.PI/2,a=t.getContext("2d");return a.beginPath(),a.arc(r/2,r/2,4,0,Math.PI*2),a.fillStyle="rgb(0, 220, 255)",a.fill(),a.moveTo(r/2,r/2),a.arc(r/2,r/2,12,n,s,!0),a.lineTo(r/2,r/2),a.arc(r/2,r/2,90,n,s),a.lineTo(r/2,r/2),a.fillStyle="rgba(0, 220, 255, 0.5)",a.fill(),t}class Zw{constructor(t,e){o(this,"width");o(this,"height");o(this,"container");o(this,"_translate");this.width=t,this.height=e;const i=200;this._translate="translate(-"+i/2+"px, -"+i/2+"px)",this.container=this._createContainer(i)}_createContainer(t){const e=document.createElement("div"),i=$w(t);return e.style.width=t+"px",e.style.height=t+"px",e.style.position="absolute",e.style.pointerEvents="none",e.style.zIndex="2",e.style.opacity="1",e.style.transition="opacity 0.5s",e.id="minimap-camera",e.appendChild(i),e}update(t,e){this.container.style.left=t.x/this.width*100+"%",this.container.style.top=t.y/this.height*100+"%",this.container.style.transform=this._translate+" rotate("+e+"rad)"}show(){this.container.style.opacity="1"}hide(){this.container.style.opacity="0"}getContainer(){return this.container}}function Jw(r,t){if("ResizeObserver"in window){new ResizeObserver(t).observe(r);return}const e=window.getComputedStyle(r),i=60;let n,s,a,l;function c(){s=i,n||h()}function h(){n=!0;const u=e.width,f=e.height;a!==u||l!==f?(a=u,l=f,t(),window.requestAnimationFrame(h)):s!==void 0&&s>0?(s-=1,window.requestAnimationFrame(h)):n=!1}new MutationObserver(()=>c()).observe(r,{attributes:!0}),window.addEventListener("resize",()=>c())}class eS{constructor(t,e,i,n){o(this,"_offset",{x:"0",y:"0"});o(this,"_width");o(this,"_height");o(this,"_driver");o(this,"_controllerElement");o(this,"_driverComputedStyle");this._width=t,this._height=e,this._driver=document.createElement("canvas"),this._driver.width=t*3,this._driver.height=e*3,this._driver.style.position="absolute",this._driver.style.maxWidth="100%",this._driver.style.maxHeight="100%",this._controllerElement=document.createElement("div"),this._controllerElement.classList.add("minimap-content-controller"),this._driverComputedStyle=window.getComputedStyle(this._driver),n.appendChild(this._driver),n.appendChild(this._controllerElement),Jw(i,()=>this._onResize())}_setOffset(){this._controllerElement.style.transform="translate("+this._offset.x+","+this._offset.y+")"}_onResize(){this._controllerElement.style.width=this._driverComputedStyle.width,this._controllerElement.style.height=this._driverComputedStyle.height}add(t){this._controllerElement.appendChild(t)}clear(){this._controllerElement.innerHTML=""}updateOffset(t){this._offset.x=50-t.x/this._width*100+"%",this._offset.y=50-t.y/this._height*100+"%",this._setOffset()}addOffset(){this._setOffset()}removeOffset(){this._controllerElement.style.transform=""}updateRatio(t){const e=()=>{const i=Math.abs(Math.sin(t.rotation)),n=Math.abs(Math.cos(t.rotation));this._driver.width=3*(this._width*t.ratio.x*n+this._height*t.ratio.y*i),this._driver.height=3*(this._width*t.ratio.x*i+this._height*t.ratio.y*n),this._onResize()};window.requestAnimationFrame(e)}}var Mv=(r=>(r.LEVEL_SELECTED="minimapLevelSelected",r))(Mv||{});const gd=class gd extends ci{constructor(e,i,n,s){super();o(this,"_minimapRenderer");o(this,"_scene");o(this,"_teleport");o(this,"_viewerApi");o(this,"_closed",!1);o(this,"_initialized",!1);o(this,"_minimized",!1);o(this,"_cameraMarker");o(this,"_contentController");o(this,"_currentLevel");o(this,"_levelsWrapper",new Array);o(this,"_levelSwitchLock",!1);o(this,"_cameraLimitMin",-1/0);o(this,"_cameraLimitMax",1/0);o(this,"_width");o(this,"_height");o(this,"_buttonMinimize",document.getElementById("minimap-button-minimize"));o(this,"_buttonMaximize",document.getElementById("minimap-button-maximize"));o(this,"_buttonClose",document.getElementById("minimap-button-close"));o(this,"_buttonToggle",document.getElementById("minimap-button-toggle"));o(this,"_container",document.getElementById("minimap-container"));o(this,"_wrapper",document.getElementById("minimap-wrapper"));o(this,"_content",document.getElementById("minimap-content"));o(this,"_tabs",document.getElementById("minimap-tabs"));o(this,"_lastCameraPosition",new L(0,0,0));o(this,"_lastCameraRotation",new L(0,0,0));o(this,"_pointPosition",new ye);o(this,"_pixelPosition",new ye);o(this,"_canvasRangeX");o(this,"_canvasRangeY");this._minimapRenderer=e,this._scene=i,this._teleport=n,this._viewerApi=s,this._viewerApi.onViewSwitchStarted(()=>this._levelSwitchLock=!0),this._viewerApi.onViewSwitchDone(()=>this._levelSwitchLock=!1);const a=700,{width:l,height:c}=this._minimapRenderer.calculateRenderSize(a,this._scene.boundingBox);this._width=l,this._height=c,this._canvasRangeX={min:0,max:this._width},this._canvasRangeY={min:0,max:this._height},this._scene.minimapConfig,this._scene.minimapConfig.enabled&&this._init(),this._scene.minimapConfig.addEventListener(Vl.eventType.UPDATED,()=>this._onConfigUpdate()),this._viewerApi._onMeetingJoined(()=>this._close())}_initLevels(){this._scene.minimapConfig,this._levelsWrapper=this._scene.minimapConfig.levels.map(e=>({level:e,canvas:void 0,tab:void 0}))}_createLevelTabs(){this._levelsWrapper.forEach(e=>{e.tab=document.createElement("div"),e.tab.classList.add("minimap-tab"),e.tab.innerText=e.level.name,e.tab.addEventListener("click",()=>{this.selectLevel(e.level),Bo()}),this._tabs.appendChild(e.tab)})}_isLevelCurrent(e){return e===this._currentLevel}_setLevelCurrent(e){this._currentLevel=e,this._cameraMarker.show(),this._levelsWrapper.forEach(i=>{i.level===e?i.tab.classList.add("minimap-tab-current"):i.tab.classList.remove("minimap-tab-current")})}_setLevelSelected(e){this._levelsWrapper.forEach(i=>{i.canvas&&(i.canvas.style.opacity=i.level===e?"1":"0",i.canvas.style.zIndex=i.level===e?"1":"0"),i.level===e?i.tab.classList.add("minimap-tab-active"):i.tab.classList.remove("minimap-tab-active")})}_createInitLevel(){const i=this._levelsWrapper.find(n=>n.level===this._currentLevel)?this._currentLevel:this._levelsWrapper.at(-1).level;this.selectLevel(i,!0)}_calculateCameraLimit(e,i){const n=e.slicePlaneHeight-i.slicePlaneHeight;return e.slicePlaneHeight-n/2}_setCameraLimits(e){const i=this._levelsWrapper.filter(s=>s.level.slicePlaneHeight<e.slicePlaneHeight).sort((s,a)=>a.level.slicePlaneHeight-s.level.slicePlaneHeight)[0],n=this._levelsWrapper.filter(s=>s.level.slicePlaneHeight>e.slicePlaneHeight).sort((s,a)=>s.level.slicePlaneHeight-a.level.slicePlaneHeight)[0];this._cameraLimitMin=i?this._calculateCameraLimit(e,i.level):-1/0,this._cameraLimitMax=n?this._calculateCameraLimit(e,n.level):1/0}_levelForCameraPosition(e){return this._levelsWrapper.reduce((n,s)=>Math.abs(s.level.slicePlaneHeight-e.z)<Math.abs(n.level.slicePlaneHeight-e.z)?s:n).level}_selectLevelForCameraPosition(e){if(e.z>this._cameraLimitMax||e.z<this._cameraLimitMin){const i=this._levelForCameraPosition(e);this._setCameraLimits(i),this.selectLevel(i,!0)}}_updateElementsTransforms(e,i){if(!this._currentLevel)return;!e&&!i&&(e=this._viewerApi.getCameraPosition(),i=this._viewerApi.getCameraRotation()),this._pointPosition.set(e.x,e.y),Sv(this._pointPosition,this._currentLevel.rotation,this._currentLevel.cropRange.center()),this._pixelPosition.set(ki(this._pointPosition.x,this._currentLevel.visibleRange.max.x,this._currentLevel.visibleRange.min.x,this._canvasRangeX.max,this._canvasRangeX.min),ki(this._pointPosition.y,this._currentLevel.visibleRange.max.y,this._currentLevel.visibleRange.min.y,this._canvasRangeY.max,this._canvasRangeY.min));const n=i.z*-1+this._currentLevel.rotation*-1;this._cameraMarker.update(this._pixelPosition,n),this._minimized&&this._contentController.updateOffset(this._pixelPosition)}_minimize(){this._minimized=!0,this._container.classList.add("minimap-container-minimized"),this._wrapper.classList.add("minimap-wrapper-minimized"),this._contentController.addOffset(),this._updateElementsTransforms()}_maximize(){this._minimized=!1,this._container.classList.remove("minimap-container-minimized"),this._wrapper.classList.remove("minimap-wrapper-minimized"),this._contentController.removeOffset()}_close(){this._closed=!0,this._wrapper.style.transform="translate(-101%, 0)"}_open(){this._closed=!1,this._wrapper.style.transform=""}_toggle(){if(!this._viewerApi.menuVisible){this._close();return}if(this._minimized&&Mf()){this._maximize(),this._open();return}this._closed?this._open():this._close()}_onMenuVisibilityChanged(){this._closed&&this._viewerApi&&Mf()||this._toggle()}_setupInteractions(){Ss(this._buttonMinimize,()=>this._minimize()),Ss(this._buttonMaximize,()=>this._maximize()),Ss(this._buttonClose,()=>this._close()),Ss(this._buttonToggle,()=>this._toggle()),this._viewerApi.onMenuVisibilityChanged(()=>this._onMenuVisibilityChanged)}_addMinimapToCanvas(e,i){i.getContext("2d").putImageData(e,0,0)}_isWalkable(e,i,n){const s=(i+n*this._width)*4+3;return e.data[s]!==0}_createDestinationView(e){const i={position:[e.x,e.y,e.z]};return new hn(i)}_addCanvasInteractionsHandler(e,i,n){const s=new L,a={min:0,max:1};i.addEventListener("click",l=>{const c=i.getBoundingClientRect(),h=(l.clientX-c.left)/c.width,d=(l.clientY-c.top)/c.height,u=Math.round(h*this._width),f=Math.round(d*this._height);if(this._isWalkable(e,u,f)){s.set(ki(h,a.min,a.max,n.visibleRange.min.x,n.visibleRange.max.x),ki(d,a.min,a.max,n.visibleRange.min.y,n.visibleRange.max.y),n.slicePlaneHeight),Sv(s,n.rotation*-1,n.cropRange.center());const p=this._createDestinationView(s);this._teleport.switchToView(p),this._isLevelCurrent(n)||this._setLevelCurrent(n)}Bo()})}_show(){this._contentController.add(this._cameraMarker.getContainer()),this._buttonToggle.style.display="",this._container.style.display="",this._levelsWrapper.length>1&&(this._tabs.style.display="",this._wrapper.classList.add("minimap-wrapper-tabs"))}_dispose(){this._contentController.clear(),this._tabs.innerHTML="",this._tabs.style.display="none",this._container.style.display="none",this._buttonToggle.style.display="none",this._wrapper.classList.remove("minimap-wrapper-tabs")}_createLevelCanvas(e){const i=document.createElement("canvas");i.width=this._width,i.height=this._height,i.style.transition="opacity 0.5s";const{minimapImageData:n,walkableImageData:s}=this._minimapRenderer.createMinimapImageDataComponents(this._scene.minimapConfig,e,this._width,this._height);return this._addMinimapToCanvas(n,i),this._addCanvasInteractionsHandler(s,i,e),this._contentController.add(i),i}_enable(){this._initLevels(),this._createLevelTabs(),this._createInitLevel(),this._show()}_hasMissingElements(){return!(this._buttonMinimize&&this._buttonMaximize&&this._buttonClose&&this._buttonToggle&&this._container&&this._wrapper&&this._content)}_init(){this._hasMissingElements()||(this._contentController=new eS(this._width,this._height,this._wrapper,this._content),this._cameraMarker=new Zw(this._width,this._height),Mf()?this._close():this._minimize(),this._setupInteractions(),this._initialized=!0,this._enable())}_onConfigUpdate(){var e;if(!this._initialized){this._init();return}(e=this._scene.minimapConfig)!=null&&e.enabled?(this._dispose(),this._enable()):this._dispose()}selectLevel(e,i=!1){const n=this._levelsWrapper.filter(s=>s.level===e)[0];i&&this._setLevelCurrent(e),n.canvas||(n.canvas=this._createLevelCanvas(e)),this._isLevelCurrent(e)?this._cameraMarker.show():this._cameraMarker.hide(),this._setLevelSelected(e),this._setCameraLimits(e),this._updateElementsTransforms(),this._contentController.updateRatio(e),this.dispatchEvent({type:gd.eventType.LEVEL_SELECTED,level:e})}update(){if(this._hasMissingElements())return;const e=this._viewerApi.getCameraPosition(),i=this._viewerApi.getCameraRotation();(wv(this._lastCameraPosition,e)===!1||wv(this._lastCameraRotation,i)===!1)&&(this._updateElementsTransforms(e,i),this._levelSwitchLock||this._selectLevelForCameraPosition(e),this._lastCameraPosition.set(e.x,e.y,e.z),this._lastCameraRotation.set(i.x,i.y,i.z))}};o(gd,"eventType",Mv);let Bh=gd;class tS{constructor(){o(this,"_nodeTypeHoverListeners",new Map);o(this,"_materialHoverListeners",new Map)}_callListener(t,e,i){try{return t(e,i)}catch(n){console.error(n)}return!1}registerMaterialHoverListener(t,e){const i=this._materialHoverListeners.get(t);if(i){i.push(e);return}this._materialHoverListeners.set(t,[e])}registerNodeTypeHoverListener(t,e){const i=this._nodeTypeHoverListeners.get(t);if(i){i.push(e);return}this._nodeTypeHoverListeners.set(t,[e])}empty(){return this._nodeTypeHoverListeners.size==0&&this._materialHoverListeners.size==0}invoke(t,e){var i,n,s;if(t instanceof Yr)return((i=this._nodeTypeHoverListeners.get(t))!=null?i:[]).some(l=>this._callListener(l,t,e));if(t instanceof Tn){for(let a=t.node;a!==null;a=a.parent)if(((n=this._nodeTypeHoverListeners.get(a.type))!=null?n:[]).some(c=>this._callListener(c,a,e)))return!0}return t.material?((s=this._materialHoverListeners.get(t.material.name))!=null?s:[]).some(l=>this._callListener(l,t.material,e)):!1}}const iS=.1,Us=class Us{constructor(t,e,i,n,s,a,l){o(this,"lightmap",null);o(this,"meshes",new Array);o(this,"_gazeModeObserver");o(this,"_gazeListeners",new Array);o(this,"_onGazeModeEnabled",()=>this._setGaze(!0));o(this,"_onGazeModeDisabled",()=>this._setGaze(!1));this._gazeModeObserver=l;const c=Math.max(n.camera.near*2,iS);this._gazeModeObserver.addEventListener(xr.eventType.MODE_ENABLED,this._onGazeModeEnabled),this._gazeModeObserver.addEventListener(xr.eventType.MODE_DISABLED,this._onGazeModeDisabled);let[h,d,u,f]=this._computeSphereParameters(t,n,c);if(t.some(m=>m.lightmapEnabled)){let m=a.measureIncidentLuma();m<0&&(m=1);const b=n.sharedMaterialState.lightmapEncoding;this.lightmap=il.createSingleColorLightmap(new _e(m,m,m),b),this.lightmap.id=`[MaterialPickerLightmap ${m}]`}const p=new L;t.forEach((m,b)=>{if(!m)return;p.set(h,d,-c);const g=this._createSphereMesh(n,m,u,p,this.lightmap);h+=2*u+f;const x=this._computeWorldStaticMatrix(s.cameraWorldPosition(),i,e,u,p,b);this.meshes.push(g),this._gazeListeners.push(w=>{w&&x?(g.matrix=x,g.matrixWorld=x):(T.DEV_NEW_RENDER_ARCHITECTURE&&pt.get().registerComponentForObject(g,new Il),g.matrix=n.camera.matrix,g.matrixWorld=n.camera.matrixWorld)})}),this._setGaze(l.modeIsEnabled())}_rotationAngle(t){return Math.abs(t.y)>Math.abs(t.x)?t.x>0?0:-Math.PI:t.y>0?Math.PI/2:-Math.PI/2}_createSphereMesh(t,e,i,n,s){e instanceof al&&(i-=Math.min(1,e.grassHeight)*i*.5);const a=ft.createSphere(i,32,16);a.changePosition(n),a.computeBoundingSphere(),a.convertNormalsToSpherical();const l=new Tn(null,a,e);return e.lightmapEnabled&&(l.lightmap=s),e instanceof al&&(l.grassScaleOverride=i),t.camera.getWorldPosition(Us._cameraPositionTemp),l.lightProbes=[t.closestLightProbe(Us._cameraPositionTemp)],l.frustumCulled=!1,l.userData.hideFromLightProbes=!0,l}_computeSphereParameters(t,e,i){const n=e.camera.fov,s=e.camera.aspectRatio,a=Math.tan(Ai(n/2))*i,l=-a,c=s*l,h=s*a,d=Math.abs(h-c),u=Math.abs(a-l),f=.01*d;let p=(d-t.length*f-f)/(2*t.length);p=Math.min(p,T.MATERIAL_PICKER_BALL_MAX_SIZE/2*d);const m=-(2*p+f)*(t.length/2)+p+f,b=document.getElementById("menu-bar").getBoundingClientRect().top,x=(window.innerHeight-b)/window.innerHeight,w=-u/2+u*x+p+f;return[m,w,p,f]}_computeWorldStaticMatrix(t,e,i,n,s,a){if(!i)return;const l=new Ue,c=Us._mat4Temp;return l.multiply(c.makeTranslation(i.x,i.y,i.z)),Us._vec2Temp.x=t.x-i.x,Us._vec2Temp.y=t.y-i.y,l.multiply(c.makeRotationZ(this._rotationAngle(Us._vec2Temp))),l.multiply(c.makeRotationX(-Math.PI/2)),l.multiply(c.makeScale(e,e,e)),l.multiply(c.makeTranslation((a+1)*2.1,0,0)),l.multiply(c.makeScale(1/n,1/n,1/n)),l.multiply(c.makeTranslation(-s.x,-s.y,-s.z)),l}_setGaze(t){this._gazeListeners.forEach(e=>e(t))}dispose(){this._gazeListeners.length=0,this._gazeModeObserver.removeEventListener(xr.eventType.MODE_ENABLED,this._onGazeModeEnabled),this._gazeModeObserver.removeEventListener(xr.eventType.MODE_DISABLED,this._onGazeModeDisabled),this.meshes.forEach(t=>t.geometry.dispose()),this.meshes=[],this.lightmap&&(this.lightmap.dispose(),this.lightmap=null)}};o(Us,"_cameraPositionTemp",new L),o(Us,"_mat4Temp",new Ue),o(Us,"_vec2Temp",new ye);let Pf=Us;function Pv(r,t,e){let i,n=null,s,a,l,c,h,d,u,f,p,m,b,g,x=!1,w=!1,C=null,M=null;const D={nextPageInteraction:[],viewerConfigLoaded:[],sceneReadyToDisplay:[],sceneLoadComplete:[],anchorClicked:{},materialPickerClicked:{},materialPickerClosed:null,nodeTypeClicked:{},anyNodeTypeClicked:[],materialClicked:{},hoverListeners:new tS,viewSwitchStarted:[],viewSwitchDone:[],vrChange:[],beforeRender:[],anchorsVisibilityChanged:[],apiUserStateChanged:{},anyApiUserStateChanged:[],meetingJoined:[],avatarListChanged:[]},W=[],z=[];let $=0;function Z(...F){return null}function ne(F){e.isMaterialEditable(F)||console.assert(!1,"Can't access material, call ViewerApi.setMaterialEditable('"+F+"') before the scene is loaded.")}function Me(){const F=[];for(const ee of n.materials)e.isMaterialEditable(ee.name)&&F.push(ee);return F}function Xe(){const F=[];for(const ee of n.nodeConfigs)e.isNodeTypeEditable(ee.name)&&F.push(ee.name);return F}function xe(F){ne(F);for(const ee of n.materials)if(ee.name===F)return ee;return null}const Le=new L;function B(){return Le.copyFrom(s.cameraWorldPosition()),Le}const Y=new Fi;function re(){return Y.yaw=s.getYawAngle(),Y.pitch=s.getPitchAngle(),Y.roll=0,Y}function le(){return n.boundingBox}function ge(F){const ee=[];ne(F);for(let ze of n.gpuMeshes)ze.material.name===F&&ee.push(ze);return ee}function pe(F){const ee=n.findNodeConfig(F);return ee?ee.nodes.slice(0):[]}function Ae(F,ee){ee.geometry.isUvs0Repeating&&F.ensureTexturesRepeatable&&F.ensureTexturesRepeatable(),ee.material=F,u.requestFrame()}function Fe(F,ee){console.warn("setMaterialForNode() is deprecated, use setMaterialForMesh() instead"),Ae(F,ee)}this._allViews=function(){return n.allViews()},this.visibleViews=function(){return n.visibleViews()};function he(F,ee,ze){let Lt;if(typeof F=="string"){let Ht=F;Lt=n.findViewByName(Ht)}else Lt=F;Lt?(ee===!0?ee=0:ee===!1&&(ee=void 0),l.isRunning()&&(ee=0,l.stop()),ze?(a.activateSky(Lt),a.updateHiddenMeshes(Lt)):a.switchToView(Lt,ee)):console.error("Unknown view: "+F)}function tt(F={}){const ee=F.isPanorama||!1;function ze(){return ee?4e3:window.innerWidth}function Lt(){return ee?2e3:window.innerHeight}const Ht=F.width||ze(),gt=F.height||Lt();if(F.toDataUrl||!1)return h.monoScreenToDataUrl(ee,Ht,gt);h.monoScreenToLocalImage(ee,Ht,gt)}function Ze(F){n.addAuxiliaryObject(F),F!==F.colliderMesh&&i.uploadNewBuffers(F.colliderMesh),c==null||c.addDynamicObstacles([F.colliderMesh])}function N(F){n.removeAuxiliaryObject(F),c==null||c.removeDynamicObstacles([F.colliderMesh])}function U(F,...ee){try{return F(...ee)}catch(ze){console.error(ze)}return!1}function k(F,...ee){if(F)for(let ze of F)U(ze,...ee)}function X(){k(D.nextPageInteraction),D.nextPageInteraction.length=0}document.addEventListener("keydown",X),document.addEventListener("mousedown",X),document.addEventListener($e.ios?"touchstart":"touchend",X);let ve=!0;Object.defineProperty(this,"anchorsVisible",{get(){return ve},set(F){F!==ve&&(ve=F,ve?W.forEach(ee=>Ze(ee)):W.forEach(ee=>N(ee)),this.requestFrame(),k(D.anchorsVisibilityChanged,ve))}});function De(F,ee){const ze=new Yr(n,n.renderCaches,F);return W.push(ze),ve&&Ze(ze),D.anchorClicked[ze.colliderMesh.id]=ee,x=!0,u.requestFrame(),ze}function qe(F){delete D.anchorClicked[F.colliderMesh.id],ve&&N(F),Qi(F,W),F.dispose(),u.requestFrame()}function Ne(F,ee){const ze=new zE(n,F,ee);return z.push(ze),n.addAuxiliaryObject(ze,!0),c==null||c.addDynamicObstacles(ze.colliders),k(D.avatarListChanged),ze}function me(F){c==null||c.removeDynamicObstacles(F.colliders),n.removeAuxiliaryObject(F),Qi(F,z),F.dispose(),k(D.avatarListChanged)}function Ye(F){return z.find(ee=>ee.uuid===F)}function ue(){for(const F of n.materialManager.getAnimatedMaterials())F.sleepAnimation()}function Ee(){for(const F of n.materialManager.getAnimatedMaterials())F.wakeAnimation();u.requestFrame()}function Pe(F,ee){return f.getExtension(F,ee)}function He(F,ee){let ze=F[ee];return ze||(ze=[],F[ee]=ze,ze)}const lt=function(){const ee=new L,ze=new L,Lt=new L,Ht=new os,gt=new L,Wi=new Fi;let Bi;function Ii(Be,I,V){ze.set(Be.x,Be.y,Bi.z).sub(Bi);const te=ze.length();te>I&&(ze.normalize().multiplyScalar(te-I),V.add(ze))}return function(Be){Bi=s.cameraWorldPosition(),gt.copyFrom(Bi);let I;Be instanceof Jc&&Be.light.type===Ln.SUN?(h0(n,Be.rotation,ee),I=ee):Be instanceof Pm?(VM(Be,Ht),I=Ht.center,Ii(I,1+Ht.radius,gt)):(I=Be.position,Ii(I,1,gt)),Lt.copyFrom(I).sub(gt).normalize(),Wi.setFromDirection(Lt);const V=new hn({position:gt.toArray(),rotation:[Wi.yawDeg,Wi.pitchDeg],mode:a.lastDestinationView.mode,orthographic:a.lastDestinationView.orthographic,orthoFrustumSize:a.lastDestinationView.orthoFrustumSize,distance:a.lastDestinationView.orthographic?a.lastDestinationView.distance:1,target:I.toArray()});a.switchToView(V)}}();this.getCurrentMaterialPickerId=function(){return C?$:null},this.openMaterialPicker=function(F,ee,ze,Lt,Ht){return console.assert(!C,"Only one material picker can be opened"),C=new Pf(F,Lt,Ht,n,s,d,b),c.addDynamicObstacles(C.meshes),C.meshes.forEach(function(gt){n.addAuxiliaryObject(gt),D.materialPickerClicked[gt.id]=ee}),D.materialPickerClosed=ze,this._setMeetingCameraPreviewVisibility(!1),++$},this.closeMaterialPicker=function(){C&&(c.removeDynamicObstacles(C.meshes),C.meshes.forEach(function(F){n.removeAuxiliaryObject(F),delete D.materialPickerClicked[F.id]}),C.dispose(),C=null,D.materialPickerClosed&&(D.materialPickerClosed(),D.materialPickerClosed=null),this._setMeetingCameraPreviewVisibility(!0))},window.addEventListener("resize",this.closeMaterialPicker.bind(this)),this._vrChange=function(F){k(D.vrChange,F)},this._update=function(F){k(D.beforeRender,F)},this._clickListener=function(F,ee,ze){if(!x)return!1;if(C){const gt=D.materialPickerClicked[F.id];return gt?(U(gt,F.material,C.meshes.indexOf(F)),!0):(this.closeMaterialPicker(),!0)}const Lt=D.anchorClicked[F.id];if(Lt)return U(Lt,F.anchor,ee,ze),!0;const Ht=(gt,Wi)=>{if(gt){for(let Bi of gt)if(U(Bi,Wi,ee,ze))return!0}return!1};for(let gt=F.node;gt;gt=gt.parent)if(Ht(D.nodeTypeClicked[gt.type],F.node))return!0;return F.node&&Ht(D.anyNodeTypeClicked,F.node)?!0:F.material?Ht(D.materialClicked[F.material.name],F.material):!1},this.getHoverListeners=()=>D.hoverListeners,this._teleportStarted=function(F){const ee=F.view;ee&&k(D.viewSwitchStarted,ee.name,ee)},this._teleportDone=function(F){const ee=F.view;ee&&k(D.viewSwitchDone,ee.name,ee)},this._viewerConfigLoaded=function(F){p=F,k(D.viewerConfigLoaded,p),D.viewerConfigLoaded=[]},this._sceneReadyToDisplay=function(F,ee,ze,Lt,Ht,gt,Wi,Bi,Ii,Be,I,V,te){i=F,n=ee,s=ze,a=Lt,l=Ht,c=gt,h=Wi,d=Bi,m=Ii,b=Be,g=I,u=V,f=te,this.getEditableMaterials=Me,this.getEditableNodeTypes=Xe,this.findMaterial=xe,this.findMeshesWithMaterial=ge,this.findNodesOfType=pe,this.getCameraPosition=B,this.getCameraRotation=re,this.getSceneBoundingBox=le,this.setMaterialForNode=Fe,this.setMaterialForMesh=Ae,this.switchToView=he,this.captureImage=tt,this.addAnchor=De,this.removeAnchor=qe,this.addAvatar=Ne,this.removeAvatar=me,this.findAvatar=Ye,this.seeItem=lt,this.sleepAnimatedMaterials=ue,this.wakeAnimatedMaterials=Ee,this.getExtension=Pe,k(D.sceneReadyToDisplay,n),D.sceneReadyToDisplay=[],a.addEventListener(ps.eventType.TELEPORT_STARTED,this._teleportStarted.bind(this)),a.addEventListener(ps.eventType.TELEPORT_DONE,this._teleportDone.bind(this))},this._contextLost=function(){w=!1,p=n=a=l=c=h=g=u=null,this.getEditableMaterials=Z,this.getEditableNodeTypes=Z,this.findMaterial=Z,this.findMeshesWithMaterial=Z,this.findNodesOfType=Z,this.setMaterialForNode=Z,this.setMaterialForMesh=Z,this.switchToView=Z,this.captureImage=Z,this.addAnchor=Z,this.addAvatar=Z,this.removeAnchor=Z,this.findAvatar=Z,this.sleepAnimatedMaterials=Z,this.wakeAnimatedMaterials=Z,this.getExtension=Z},this._sceneLoadComplete=function(){k(D.sceneLoadComplete),D.sceneLoadComplete=[],w=!0;for(const F of W)F.enableLightProbe()},this.openUrl=function(F,ee){if(ee||r)return window.open(F);window.location.href=F},this.onNextPageInteraction=function(F){D.nextPageInteraction.push(F)},this.onViewerConfigLoaded=function(F){if(p){F(p);return}D.viewerConfigLoaded.push(F)},this.isSceneReadyToDisplay=function(){return n!==null},this.onSceneReadyToDisplay=function(F){if(n){F(n);return}D.sceneReadyToDisplay.push(F)},this.onSceneLoadComplete=function(F){if(w){F(n);return}D.sceneLoadComplete.push(F)},this.requestFrame=function(){u&&u.requestFrame()},this.setNodeTypeEditable=function(F){console.assert(n===null,"setNodeTypeEditable must be called before the scene is loaded"),e.setNodeTypeEditable(F)},this.setMaterialEditable=function(F){console.assert(n===null,"setMaterialEditable must be called before the scene is loaded"),e.setMaterialEditable(F)},this.setAllMaterialsEditable=function(){console.assert(n===null,"setAllMaterialsEditable must be called before the scene is loaded"),e.setAllMaterialsEditable()},this.onCameraPositionUpdated=function(F){n.camera.addEventListener(At.eventType.POSITION_CHANGED,F)},this.removeOnCameraPositionUpdated=function(F){n.camera.removeEventListener(At.eventType.POSITION_CHANGED,F)},this.onNodeTypeClicked=function(F,ee){typeof F=="function"?(ee=F,D.anyNodeTypeClicked.push(ee)):He(D.nodeTypeClicked,F).push(ee),x=!0},this.removeOnNodeTypeClicked=function(F,ee){typeof F=="function"?(ee=F,Qi(ee,D.anyNodeTypeClicked)):Qi(ee,D.nodeTypeClicked[F])},this.onMaterialClicked=function(F,ee){this.setMaterialEditable(F),He(D.materialClicked,F).push(ee),x=!0},this.onNodeTypeHoverChanged=function(F,ee){F instanceof Yr||this.setNodeTypeEditable(F),D.hoverListeners.registerNodeTypeHoverListener(F,ee)},this.onMaterialHoverChanged=function(F,ee){this.setMaterialEditable(F),D.hoverListeners.registerMaterialHoverListener(F,ee)},this.onViewSwitchStarted=function(F){D.viewSwitchStarted.push(F)},this.onViewSwitchDone=function(F){D.viewSwitchDone.push(F)},this.onVrChange=function(F){D.vrChange.push(F)},this.onBeforeRender=function(F){D.beforeRender.push(F)},this.createTextureFromHtmlImage=function(F,ee=!1){const ze=new st;ze.image=F,ze.wrapS=ze.wrapT=H.REPEAT,ze.minFilter=H.LINEAR_MIPMAP_LINEAR,ze.format=ee?Ke.RGBA8:Ke.RGB8,ze.hasAlpha=ee;let Lt=null;function Ht(){ze.needsUpdate=!0,ze.width=F.naturalWidth,ze.height=F.naturalHeight,ze.notifyLoaded()}function gt(){Ht(),Lt&&Lt(),F.onload=Lt}return F.complete&&F.naturalHeight!==0?Ht():(Lt=F.onload,F.onload=gt),ze},this.createTextureFromHtmlVideo=function(F){const ee=new jr;ee.video=F,ee.minFilter=H.LINEAR,ee.format=Ke.RGB8,ee.generateMipmaps=!1;function ze(Lt){ee.width=Lt.videoWidth,ee.height=Lt.videoHeight,ee.wrapS=H.REPEAT,ee.wrapT=H.REPEAT,ee.notifyLoaded(),ee.needsUpdate=!0}return F.setAttribute("playsinline",""),F.setAttribute("webkit-playsinline",""),F.crossOrigin="anonymous",Mp(F,ze),ee},this.createStreamTextureFromHtmlVideo=function(F){const ee=this.createTextureFromHtmlVideo(F);return ee._interruptible=!1,ee},this.addAnchor=function(F,ee){},this.removeAnchor=function(F){},this.addAvatar=function(){},this.removeAvatar=function(){},this.findAvatar=function(F){},this.sleepAnimatedMaterials=function(){},this.wakeAnimatedMaterials=function(){},this.getExtension=function(F,ee){},this.onAnchorsVisibilityChanged=function(F){D.anchorsVisibilityChanged.push(F)},this.removeAnchorsVisibilityChangedListener=function(F){D.anchorsVisibilityChanged=D.anchorsVisibilityChanged.filter(ee=>ee!==F)},this.getEditableMaterials=Z,this.getEditableNodeTypes=Z,this.findMaterial=Z,this.findMeshesWithMaterial=Z,this.findNodesOfType=Z,this.getCameraPosition=Z,this.getCameraRotation=Z,this.getSceneBoundingBox=Z,this.setMaterialForNode=Z,this.setMaterialForMesh=Z,this.switchToView=Z,this.captureImage=Z,this.seeItem=Z,this.getViewerAssetUrl=F=>yi(F),this.addMenuButton=function(F){return t.addExtraButton(F)},this.removeMenuButton=function(F){t.removeExtraButton(F)},this.getMenuButtonIcon=function(F){return t.getExtraButonIcon(F)},Object.defineProperty(this,"menuVisible",{get(){return t.visible},set(F){t.visible=F}}),this.onMenuVisibilityChanged=function(F){t.addEventListener(Fh.eventType.VISIBILITY_CHANGED,()=>F())},Object.defineProperty(this,"helpVisible",{get(){return t.helpVisible},set(F){t.helpVisible=F}}),this.play=function(){zv()};const Rt={};this.apiUserChangeState=function(F,ee){if(Za(Rt[F],ee))return;Rt[F]=$a(ee);const ze=as(ee);k(D.apiUserStateChanged[F],F,ze),k(D.anyApiUserStateChanged,F,ze)},this.onApiUserStateChanged=function(F,ee){typeof F=="function"?(ee=F,D.anyApiUserStateChanged.push(ee)):He(D.apiUserStateChanged,F).push(ee)},this.removeOnApiUserStateChanged=function(F,ee){typeof F=="function"?(ee=F,Qi(ee,D.anyApiUserStateChanged)):Qi(ee,D.apiUserStateChanged[F])},this.getApiUserState=function(F){if(F===void 0)return as(Rt);const ee=Rt[F];return ee===void 0?void 0:as(ee)},this._meetingJoined=function(F){console.assert(M===null),M=F,k(D.meetingJoined,M)},this._isMeeting=function(){return T.urlHashContains("meeting-key")||T.urlHashContains("meeting")},this._onMeetingJoined=function(F){D.meetingJoined.push(F),M!==null&&F(M)},this._removeOnMeetingJoined=function(F){Qi(F,D.meetingJoined)},this._setMeetingCameraPreviewVisibility=function(F){M!==null&&M.setCameraPreviewVisibility(F)},this._onAvatarListChanged=function(F){D.avatarListChanged.push(F)},this._removeOnAvatarListChanged=function(F){Qi(F,D.avatarListChanged)},this._createPointerEventHelper=function(F){return new sh(g,F)},this._disableControls=function(){s.disable()},this._enableControls=function(){s.enable()};const Et=new yr;this._findIntersectionAtPosition=function(F,ee){return c==null||c.findIntersectionAtPosition(F,ee,!0,Et),Et},this.getWalkMaxSpeed=function(){return console.assert(n,"getWalkMaxSpeed must be called after the scene is loaded"),n.camera.moveMaxSpeed},this.setWalkMaxSpeed=function(F){console.assert(n,"setWalkMaxSpeed must be called after the scene is loaded"),n.camera.moveMaxSpeed=F},this.openPopup=function(F,ee={},ze=void 0){return dl.openPopup(F,ee,ze)},this.enableMinimap=function(){console.assert(n,"enableMinimap must be called after the scene is loaded"),n.minimapConfig.enabled=!0},this.disableMinimap=function(){console.assert(n,"disableMinimap must be called after the scene is loaded"),n.minimapConfig.enabled=!1},this.isMinimapEnabled=function(){return console.assert(n,"isMinimapEnabled must be called after the scene is loaded"),n.minimapConfig.enabled},this.vrEnabled=function(){return console.assert(n,"vrEnabled must be called after the scene is loaded"),m.vrEnabled()},this.enableVr=function(){console.assert(n,"enableVr must be called after the scene is loaded"),m.vrEnabled()||m.enableVr(i.context,n.camera)},this.disableVr=function(){console.assert(n,"disableVr must be called after the scene is loaded"),m.vrEnabled()&&m.disableVr(n.camera)}}function nS(r,t,e,i,n,s,a){const l=navigator.xr,c=e?!e.nativeWebXR:!1,h="immersive-vr";let d,u,f,p=!1,m,b,g,x=null,w;const C=new Ue;let M=T.CAMERA_MIN_FAR,D=!1,W=xs.NONE;const z=!1,$=xs.NONE;function Z(){m.depthFar=M,d.updateRenderState(m)}this.setCameraFar=function(xe){M=xe,d&&Z()},this.getCurrentPose=function(){return f},this.getBaseLayer=function(){return m.baseLayer},this.render=function(xe,Le){T.DEV_NEW_RENDER_ARCHITECTURE,g.set(!1,!0,!1),b.matrixWorld=Le;const B=b.projectionMatrix,Y=f.views;for(let re=0;re<Y.length;++re){const le=Y[re];C.fromArray(le.transform.inverse.matrix),B.fromArray(f.transform.matrix),C.multiply(B),B.fromArray(le.projectionMatrix),B.multiply(C),r.enableScissorTest(!0);const ge=m.baseLayer.getViewport(le);r.setScissor(ge.x,ge.y,ge.width,ge.height),w.x=ge.x,w.y=ge.y,w.width=ge.width,w.height=ge.height,r.render(xe,b,w),r.enableScissorTest(!1)}g.restore()};function ne(){return $e.ios&&DeviceMotionEvent!==void 0&&typeof DeviceMotionEvent.requestPermission=="function"&&DeviceOrientationEvent!==void 0&&typeof DeviceOrientationEvent.requestPermission=="function"?new Promise(function(xe,Le){Promise.all([DeviceMotionEvent.requestPermission(),DeviceOrientationEvent.requestPermission()]).then(function(B){B[0]==="granted"&&B[1]==="granted"?xe():Le()},function(){Le()})}):Promise.resolve()}function Me(){if(d=null,w.dispose(),w=null,m=null,u=null,f=null,t.removeAllXrGamepads(),a(!1),x){const xe=x;x=null,xe()}}function Xe(xe){for(const Le of xe.removed)Le.gamepad&&t.removeXrGamepad(Le.gamepad);for(const Le of xe.added)Le.gamepad&&t.addXrGamepad(Le.gamepad,Le.handedness)}if(this.enableVr=function(xe,Le){l?p?(s(!0),ne().then(function(){const B="local-floor";return xe.makeXRCompatible().then(function(){return navigator.xr.requestSession(h,{requiredFeatures:[B]})}).then(function(Y){return d=Y,d.requestReferenceSpace(B)}).then(function(Y){u=Y;const re=new XRWebGLLayer(d,xe);w=r.createFrameBufferRenderTarget(re.framebuffer),T.DEV_NEW_RENDER_ARCHITECTURE&&(W=Le.antialiasingType,D=Le.motionBlurEnabled,Le.antialiasingType=$,Le.motionBlurEnabled=z,pt.get().enableVrMode(re.framebuffer)),m={baseLayer:re},b||(b=new Xs,g=new br(r)),m.depthNear=T.CAMERA_WALK_NEAR,Z(),d.addEventListener("end",Me),c||d.addEventListener("inputsourceschange",Xe),s(!1),a(!0)}).catch(function(){s(!1),ii.info("Failed to enable VR mode")})}).catch(function(){s(!1),ii.info("Permissions necessary for VR mode not granted")})):ii.info("VR device not connected"):ii.info('You need a <a href="https://mozvr.com/#start" target="_blank">VR ready browser</a>.')},this.disableVr=function(xe){d.end().then(function(){ii.hideInfo(),T.DEV_NEW_RENDER_ARCHITECTURE&&(xe.antialiasingType=W,xe.motionBlurEnabled=D,pt.get().disableVrMode())},function(){ii.info("Failed to exit VR mode")})},this.vrEnabled=()=>!!u,this.requestAnimationFrame=function(){function xe(Le,B){if(f=B.getViewerPose(u),x){const Y=x;x=null,Y(Le)}}return function(Le){x=Le,d.requestAnimationFrame(xe)}}(),this.update=function(){const xe=new Fi,Le=new L;return function(){if(!f)return;const B=f.transform;if(B.orientation===null)return;{xe.setFromQuaternion(B.orientation,ys.YXZ);const re=xe.y;xe.y=-xe.z,xe.z=re}const Y=B.position;n(xe,Y&&Le.set(Y.x,-Y.z,Y.y,Y.w))}}(),($e.https||$e.localhost)&&l){const xe=function(){navigator.xr.isSessionSupported(h).then(function(Le){p=Le,i(Le)})};xe(),navigator.xr.addEventListener("devicechange",xe,!1)}else i(!1)}const us=document.getElementById("walk-canvas"),$i=T.EDIT_MODE,sS=1/15,Hl=1/30;let Wl=0,_i,Mn,oi,Fa,Pn,nr,Nt,jo,ni,sr,Nh,Cf,Cv,Pt,Xo,$n,un,Gn,Rs,Pr,sn,jl,Rf,qo,Xl,fn=null,Yo=null,Ba,Uh,If,kh=0,Vh=!1,Rv=!1,Df,Na=!0,Iv=!1;const Qo=new xr;function rS(r,t){return Xo.renderIdle(r,t)}function Lf(r,t){mt.beginSection("Integrate simulation"),t&&jo.update(),T.DEV_NEW_SCENE&&Pt.updateSegments(),sn.update(r),Uh&&Pt.minimapConfig.enabled&&Uh.update(),Na&&!t&&$n.handleCollisions(r),Rs==null||Rs.handleHover(),Pr.update(r),Nt.update(r),un==null||un.updateCameraHeight(r),Gn==null||Gn.updateCameraHeight(),t&&!sn.teleportingToPoint&&(Mn.update(),ni.requestFrame()),jl&&(t&&!jo.hasGamepads()?jl.update(r):jl.reset());let e=T.BENCHMARK;if(!T.DEV_NEW_RENDER_ARCHITECTURE)for(const i of Pt.getAnimatedRootNodes())i.update(r,Nt.cameraWorldPosition())&&(e=!0);for(const i of Pt.materialManager.getAnimatedMaterials())i.isPlaying&&(i.update(r),e=!0);e&&!T.PUPPETEER_TEST&&ni.requestFrame(),Xl==null||Xl.update(r),Pn._update(r),mt.endSection("Integrate simulation")}function oS(r,t){if(mt.createNewProfileFrame(),mt.beginSection("Tick"),Yo==null||Yo.begin(),T.PUPPETEER_TEST&&(r=1/30),r=Math.min(r,sS),T.DEV_NEW_RENDER_ARCHITECTURE){const e=pt.get();if(mt.beginSection("Logic update"),t||T.DEV_DISABLE_INTERPOLATION)Wl=Hl,e.onLogicUpdateBegin(),Lf(r,t),e.onLogicUpdateEnd();else for(Wl+=r;Wl>=Hl;)Wl-=Hl,e.onLogicUpdateBegin(),Lf(Hl,t),e.onLogicUpdateEnd();mt.endSection("Logic update"),mt.beginSection("Render to screen");const i=Wl/Hl;Xo.renderToScreen(r,t,i),e.isSceneRenderingRequired()&&ni.requestFrame(),mt.endSection("Render to screen")}else Lf(r,t),Xo.renderToScreen(r,t);Yo==null||Yo.end(),mt.endSection("Tick")}function aS(r){r.view&&(un==null||un.disable(),Rs==null||Rs.disable())}function lS(r){un&&!un.isEnabled()&&!Mn.vrEnabled()&&un.enable(),Gn&&Mn.vrEnabled()&&Gn.onTeleportDone(),r.view&&Rs&&Rs.enable(),Mn.vrEnabled()&&Nt.hmdReset()}function cS(){if(Pt){if(document.visibilityState==="hidden")for(const r of Pt.materialManager.getAnimatedMaterials())r.sleepAnimation();else if(document.visibilityState==="visible"){for(const r of Pt.materialManager.getAnimatedMaterials())r.wakeAnimation();ni.requestFrame()}}}function Ua(){$e.ios&&(document.documentElement.style.height=window.innerHeight+"px",document.body.scrollTop!==0&&window.scrollTo(0,0)),Xo.resize(Mn.vrEnabled()),ni.requestFrame(),oi.onResize()}function Of(){return document.pointerLockElement===us||document.mozPointerLockElement===us||document.webkitPointerLockElement===us}function Ff(){return document.fullscreenElement||document.mozFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement||document.webkitFullscreenElement}function hS(){Of()&&(document.exitPointerLock=document.exitPointerLock||document.mozExitPointerLock||document.webkitExitPointerLock,document.exitPointerLock&&document.exitPointerLock())}function dS(){Ff()&&(document.exitFullScreen=document.exitFullscreen||document.mozCancelFullScreen||document.msExitFullscreen||document.webkitExitFullscreen,document.exitFullScreen&&document.exitFullScreen())}function Bf(){if(Of()){Nt.mousePressLook=!1,oi.onPointerLockChange(!0);const r=T.GAZE_IN_POINTER_LOCK;r?Qo.enableMode():Qo.disableMode(),Pn.anchorsVisible=r}else Nt.mousePressLook=!0,oi.onPointerLockChange(!1),Qo.disableMode(),Pn.anchorsVisible=!0}function uS(){us.requestPointerLock=us.requestPointerLock||us.mozRequestPointerLock||us.webkitRequestPointerLock,us.requestPointerLock(),document.addEventListener("pointerlockchange",Bf,!1),document.addEventListener("mozpointerlockchange",Bf,!1),document.addEventListener("webkitpointerlockchange",Bf,!1)}function zh(){Ff()?(oi.onFullScreenChange(!0),screen.orientation&&screen.orientation.lock&&screen.orientation.lock("landscape-primary")):oi.onFullScreenChange(!1)}function fS(){const r=document.body;(r.mozRequestFullScreen||r.webkitRequestFullscreen||r.msRequestFullscreen||r.requestFullscreen).call(r),document.addEventListener("fullscreenchange",zh,!1),document.addEventListener("mozfullscreenchange",zh,!1),document.addEventListener("webkitfullscreenchange",zh,!1),document.addEventListener("MSFullscreenChange",zh,!1)}function Dv(r){_i.uploadNewBuffers(r),ni==null||ni.requestFrame()}function pS(r){Nt=new Xx(r,us,jo,ni),Nt.mousePressLook=!0,T.FLIP_MOUSE&&(Nt.flipMouseLook=!0)}function mS(){Pr=new Fx(Pt,$n,Nt,sn);const r=[Pn._clickListener.bind(Pn)],t=[Pr.onMeshClicked.bind(Pr)];$i||r.push(Pr.onMeshClicked.bind(Pr)),Rs=new $x(Nh,$n,()=>ni.requestFrame(),r,t,Pn.getHoverListeners(),jo,jl)}function _S(){Ff()?dS():fS()}function gS(){Of()?hS():uS()}function Lv(){un==null||un.disable(),Gn==null||Gn.enable(),Nt.mouseControlsPitch=!1,Nt.hmdReset(),sn.onVrChange(!0),Qo.enableMode(),oi.onVrChange(!0),Pn._vrChange(!0),Ua()}function vS(){Nt.resetRollAngle(),Nt.resetPitchAngle(),Nt.mouseControlsPitch=!0,console.assert(!Mn.vrEnabled()),Gn==null||Gn.disable(),un==null||un.enable(),sn.onVrChange(!1),Qo.disableMode(),oi.onVrChange(!1),Pn._vrChange(!1),Ua(),setTimeout(Ua,1e3)}function bS(r){ni.isEnabled()&&(r?Lv():vS())}function yS(r){$i||$e.mobile&&!T.ALLOW_MOBILE_VR||($e.ios||$e.mobile&&$e.firefox)&&$e.inCrossOriginIframe||oi.setVrSupported(r)}function xS(){Mn.vrEnabled()?Mn.disableVr(Pt.camera):(qo.isRunning()&&qo.stop(),Mn.enableVr(_i.context,Pt.camera))}function ES(r,t){Gn&&t!==null&&Gn.onHmdPositionUpdate(t),Nt.onHmdUpdate(r,t)}function AS(r,t){if(r&&Nt.cameraWorldPosition().set(r[0],r[1],r[2]),t){const e=new Fi;e.setFromDegTriple(t),Nt.setYawAngle(e.yaw),Nt.setPitchAngle(e.pitch)}}function TS(r){return r.every(t=>t.lightProbes.length!==0)}function wS(r,t,e){const i=performance.now();$n=new ou(r,t,e);const n=[];if(t.visitAllNodes(s=>{s.mesh&&n.push(s.mesh)}),$n.addStaticObstacles(n),T.DEBUG){const s=performance.now()-i;console.log(`Collider construction time: ${s}`)}}function SS(r){const t=T.urlHashGetArgument("view");let e=null;return t&&(e=r.findViewByName(t)),e||r.allViews()[0]}function Ov(r){if(mt.endSection("SceneLoader.load"),mt.beginSection("Scene ready to display"),Pt=r,Pt.adjustSkiesAndCameraFarToSpanWholeScene(),Pt.addEventListener(Hi.eventType.UPDATED,()=>ni.requestFrame()),Pt.addEventListener(Hi.eventType.ANY_VIEW_UPDATED,()=>oi.refresh()),Pt.disableLightProbesForMaterials(),Nt.enable(),Pt.threeScene.updateMatrixWorld(!0),Mn.setCameraFar(Pt.camera.far),Pt.camera.current instanceof Xs&&(Pt.camera.current.aspectRatio=window.innerWidth/window.innerHeight),Xo=new JA(_i,Mn,Pt,Pt.exposureController),T.DEV_NEW_RENDER_ARCHITECTURE){const e=pt.get();e.onLogicUpdateBegin();const i=Pt.camera,n=e.getActiveCamera().get(en);rh.updateProjectionFromCamera(n,i),e.onLogicUpdateEnd()}If=new CA(_i,Pt),Nh=new tE(_i.domElement,$i),(Na||$i)&&(wS(_i,Pt,Nt),Nt.orbit.collider=$n),sn=new ps(Pt,Nt,ni,If,$n),sn.addEventListener(ps.eventType.TELEPORT_STARTED,aS),sn.addEventListener(ps.eventType.TELEPORT_DONE,lS),qo=new cl(sn),Na&&Pt.camera.autoClimb&&(un=new sE($n,Nt,ni)),Na&&(Gn=new rE(Nt,$n)),sn.switchToView(SS(Pt),0),Rf=new Qx(Pt,sn),Ba=new Aw(_i,Pt,Nt);function t(){ni.requestFrame()}if(Na&&T.NO_GAZE_TELEPORT!==!0&&(jl=new Yx(Pt,Nt,t,Qo)),Pn._sceneReadyToDisplay(_i,Pt,Nt,sn,qo,$n,Ba,Cf,Mn,Qo,Nh,ni,nr),mS(),document.addEventListener("visibilitychange",cS),window.addEventListener("resize",function(){$e.ios?setTimeout(Ua,1e3):Ua()},!1),$e.fullScreenSupported()&&oi.setFullScreenSupported(),$e.pointerLockSupported()&&oi.setPointerLockSupported(),oi.sceneReadyToDisplay(Pt,sn,qo,Ba),Ua(),T.DEBUG&&(Yo=new Yw(_i.context)),Bo(),T.DEBUG_SHARED_BUFFERS&&(Pt.threeScene.overrideMaterial=new Vy),T.DEBUG_GEOMETRY_MERGING&&fM(Pt,!1),Pt.startAutoTourOnLoad()&&qo.start(),ni.enable(),Mn.vrEnabled()&&Lv(),T.PUPPETEER_TEST){const e="display:none;";document.getElementById("cover-image").style.cssText=e,document.getElementById("info-bar").style.cssText=e,document.getElementById("menu-bar").style.cssText=e,document.getElementById("view-list").style.cssText=e,document.getElementById("minimap-wrapper").style.cssText=e,document.getElementById("primary-progress").style.cssText=e,MS()}Df=fn.elapsedLoadTimeSec(),T.DEBUG&&console.log("readyToDisplayTime:",Df),mt.endSection("Scene ready to display")}function MS(){const r=document.createElement("div");r.style.cssText="display:none;",r.id="loading-finished-marker",document.body.appendChild(r)}function Fv(r){!$i&&!T.urlHashContains("nostats")&&kh===0&&oi.cover.sendStats&&Vr("./stats/"+r,null,null)}function PS(r){let t="";for(const[e,i]of Object.entries(r))if(i!=""){const n=t.length==0?"?":"&";t+=`${n}${e}=${i}`}Fv("play"+t)}function CS(r,t){Fv("loaded?readyToDisplayTime="+r.toFixed(1)+"&loadTime="+t.toFixed(1))}function RS(r,t){const e=new Map;function i(){t.assignLightProbesToObjects()}function n(c){const h=c.target;function d(){e.delete(h),r.findLightProbe(h.id)!==null&&(t.assignLightProbesToObjects(),t.createLightProbeTexture(h,!1),ni.requestFrame())}let u=e.get(h);u===void 0&&(u=new h_(d,1e3),e.set(h,u)),u.deferRun()}function s(c){const h=c.target;if(t.createLightProbeTexture(h,!0),!h.isBoundingBoxInitialized()){const d=h.boxMin,u=h.boxMax;d.copyFrom(h.position).addScalar(-1),u.copyFrom(h.position).addScalar(1),h.enableBoundingBox()}}function a(c){for(const h of r.materials)h.forceObjectUniformsRefresh()}function l(c){const h=c.lightProbe;t.assignLightProbesToObjects(),t.createLightProbeTexture(h,!0),h.isBoundingBoxInitialized()||h.disableBoundingBox(),h.addEventListener(nn.eventType.BOUNDS_INIT,s),h.addEventListener(nn.eventType.POSITION_UPDATED,n),h.addEventListener(nn.eventType.BOUNDS_UPDATED,a)}r.addEventListener(Hi.eventType.LIGHT_PROBE_ADDED,l),r.addEventListener(Hi.eventType.LIGHT_PROBE_REMOVED,i);for(const c of r.lightProbes)c.addEventListener(nn.eventType.POSITION_UPDATED,n),c.addEventListener(nn.eventType.BOUNDS_INIT,s),c.addEventListener(nn.eventType.BOUNDS_UPDATED,a)}function IS(r,t,e){const i=new Set;function n(s){if(s===r.length){e();return}const a=r[s],l=a.name;i.has(l)?n(s+1):(i.add(l),t.monoPanoramaToServer(a,()=>n(s+1)))}n(0)}function Bv(r){mt.beginSection("sceneLoadComplete");let t;const e=T.urlHashContains("headless");if(r.lightProbes.length>0||$i){let s=T.CUBEMAP_FILTER_SHADER_SAMPLES_COUNT;$e.isLongShaderExecutionProblematicDevice()&&(s=Math.min(s,128));const a=(!$e.mobile||T.MOBILE_HI||r.lightProbes.length<=4)&&!T.CUSTOM_LIGHT_PROBE_MAX_MIP_SIZE;if(t=new lA(r,_i,a,$i,s),r.lightProbes.length===0&&$i&&r.autoAddLightProbes&&ZE(r,t,e),r.lightProbes.length>0){TS(r.gpuMeshes)||(console.warn("Some objects do not have light probes assigned, this is not optimal."),t.assignLightProbesToObjects());let l=r.allViews().findIndex(c=>c.mode!=="orbit");l===-1&&(l=0),sn.executeWithViewVisibilitySettings(r.allViews()[l],function(){t.createAllLightProbeTextures()}),r.enableLightProbesForMaterials()}}if(r.hasLightmap()&&Xo.enableAutoExposure(),r.exposureController.updateWithoutDelay(),r.exposureController.adaptExposure(!0),$i){if(t?RS(r,t):console.warn("Cube maps support is required in the edit mode"),Cv=new td({scene:r,controls:Nt,rawRenderer:_i,teleport:sn,animationController:ni}),Xl=new Ut(Nh,r,$n,ni,Nt,nr),sr.sendCoverToServer){const s="SwitchObjects";nr.initExtensionsByType(s);const a=nr.getExtensionsByType(s);a.forEach(l=>l.changeTriggersVisibility(!1)),Ba.coverToServer(T.EDITOR_COVER_WIDTH,T.EDITOR_COVER_HEIGHT),a.forEach(l=>l.changeTriggersVisibility(!0)),nr.disposeExtensionsByType(s)}AS(sr.forcedInitialCameraPosition,sr.forcedInitialCameraRotation)}else t&&(t.dispose(),t=null);Uh=new Bh(If,r,sn,Pn);const i=new xf(r.textureManager,Fa);function n(){if(sr.onSceneLoaded&&sr.onSceneLoaded(new fP(r,oi,Nt,$n,sn,Xl,nr,Ba,ni,Uh,qo,Cv,i)),oi.sceneLoadComplete(),!T.PUPPETEER_TEST)for(const s of r.materialManager.getAnimatedMaterials())s.play();Pn._sceneLoadComplete(),ni.requestFrame(),CS(Df,fn.elapsedLoadTimeSec()),fn=null}$i&&e?IS(fn.panoramas,Ba,n):n(),T.DEV_NEW_RENDER_ARCHITECTURE&&pt.get().onSceneLoaded(),mt.endSection("sceneLoadComplete")}function DS(){return T.VR_LO?hh.cardboardConfig.BUFFER_SCALE*=.5:T.VR_HI&&(hh.cardboardConfig.BUFFER_SCALE*=1.5),new WebXRPolyfill(hh)}function Nf(){Vh&&(Vh=!1,fn.load(),oi.sceneLoadStarted(),T.SHOW_HELP_ON_LOAD&&(oi.helpVisible=!0),PS($e.getPlatformInfo()))}function LS(){const r="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation";return window.WebGLRenderingContext?'Your graphics card does not seem to support <a href="'+r+'" target="_blank">WebGL</a> or your browser has WebGL disabled.<br/><a href="http://get.webgl.org/" target="_blank">Find out how to get it.</a>':'Your browser does not seem to support <a href="'+r+'" target="_blank">WebGL</a>.<br/><a href="http://get.webgl.org/" target="_blank">Find out how to get it.</a>'}function Nv(r){if(oi.updateCover(r),nr.updateConfig(r.extensions||[]),r.canForceBrotliBuffers===!0&&Db(),r.webwalkLogMode===1?(Re.logInfoMessages(),Re.initLoggingToServer(!0)):r.webwalkLogMode===2&&Re.initLoggingToServer(!1),$i||nr.initExtensions(),Pn._viewerConfigLoaded(r),r.language){const i=Bd[r.language];i?Ip(i):console.log(`Unknown language: ${r.language}`)}Vh=!0;const t=new Hi(Nt.camera()),e=new jw(T.ASSETS_URL,_i);t.textureManager=e,Cf=new mE(_i,t),t.exposureController=new cE(t.camera,Cf),sr.assetsUrl!==void 0&&sr.assetsUrl!==null&&(T.ASSETS_URL=sr.assetsUrl),T.DEV_NEW_SCENE?(fn=new YS(t,T.ASSETS_URL,$i,Fa,e,_i),fn.onProgress=oi.loadProgress,fn.onMeshBuffersLoaded=Dv,fn.onReadyToDisplay=Ov,fn.onComplete=Bv):(fn=new Ww(t,T.ASSETS_URL,$i,Fa,e,_i),fn.onProgress=oi.loadProgress,fn.onMeshBuffersLoaded=Dv,fn.onReadyToDisplay=Ov,fn.onComplete=Bv),T.AUTO_PLAY||Rv||kh>0?Nf():T.HIDE_PLAY||oi.enablePlayButton(Nf)}function Uv(){return!$i&&fn===null&&kh<=T.CONTEXT_LOST_RESTORE_LIMIT}function OS(r){if(r.preventDefault(),kh+=1,ni.disable(),!Uv()){ii.error("Graphics context lost, reload to retry.");return}nr.disposeExtensions(),Pn._contextLost(),Rf.dispose(),Rf=null,Rs.dispose(),Rs=null,Pr&&(Pr.dispose(),Pr=null),oi.contextLost(),T.DEV_NEW_RENDER_ARCHITECTURE&&pt.get().close()}function FS(r){r.preventDefault(),Uv()&&(ii.info("Graphics context restored, reloading the scene to use the new context.",5e3),$e.resetGlDetector(_i.context),$e.gl.reportToConsole(),_i.webGLContextRestored(),T.DEV_NEW_RENDER_ARCHITECTURE&&new Ps(_i),Nv(oi.cover))}function BS(){function r(t,e){let i="Failed to initialize the scene.";t==401&&e!==void 0&&(i=e),ii.error(i)}Hc(T.COVER_JSON_URL,!1,Nv,r)}function kv(r){if(Iv=!0,yt.onAdd=s=>{s instanceof je&&_i.uploadNewBuffers(s)},sr=r,Na=sr.enableCollisions&&!T.NO_COLLISIONS,_i=ZA(us),!_i){ii.error(LS());return}T.DEV_NEW_RENDER_ARCHITECTURE&&new Ps(_i);const t=$e.missingCapabilities();if(t){ii.errorWithQr(t);return}us.addEventListener("webglcontextlost",OS,!1),us.addEventListener("webglcontextrestored",FS,!1),oi.init(),nr=new GE;let e=null;try{e=DS()}catch(s){Re.log("Failed to initialize WebXR polyfill")}function i(s){s?ni.disable():ni.enable()}Mn=new nS(_i,jo,e,yS,ES,i,bS),ni=new Rx(Mn,oS,rS),ni.disable();const n=new At;pS(n),Nt.disable(),BS()}jo=new Gx,oi=new Fh($i,jo,xS,_S,gS,!T.PUPPETEER_TEST),Fa=new Tw,$i&&Fa.setAllMaterialsEditable(),Pn=new Pv($i,oi,Fa);function NS(r){const t=document.createElement("base");t.target="_blank",document.head.appendChild(t),Pp(Object.keys(Od),function(){kv(r)})}function US(){return Iv}function Vv(r){$i||kv(r)}function zv(){Vh?Nf():Rv=!0}function rn(){return Pn}function Gv(){return $n}let Uf=!1;function kS(){T.DEV_NEW_RENDER_ARCHITECTURE?Xo.reloadShaders():Uf||(Uf=!0,console.log("Reloading shaders..."),zi.reloadShaders(()=>{const r=new Map;let t=0;Pt.threeScene.traverse(function(e){const i=e.material;i&&i.generateProgramId!==void 0&&r.set(i.generateProgramId(),i)});for(const e of r.values())e.tryToRefreshShaderCode()&&(_i.recompileProgram(e),t++);Uf=!1,console.log("Updated "+t+" shaders.")}))}class kf{constructor(t,e,i){o(this,"_config");o(this,"_volumeTrigger");o(this,"_camera");o(this,"_exposureController");this._config=t,this._volumeTrigger=this._constructVolumeTrigger(t),this._camera=e,this._camera.addEventListener(At.eventType.POSITION_CHANGED,this._volumeTrigger.onCameraPositionUpdated),this._exposureController=i}_constructVolumeTrigger(t){const e=()=>{rn().onSceneReadyToDisplay(()=>{this._exposureController.addManualExposure(this._config.exposure,this._config.gamma,this._config.id)})},i=()=>{this._exposureController.removeManualExposure(this._config.id)};return new jn([e],[i],t)}setPriority(t){this._exposureController.setPriority(this._config.id,t)}onUpdated(){this._exposureController.updateManualExposure(this._config.exposure,this._config.gamma,this._config.id)}getCameraVolumeTrigger(){return this._volumeTrigger}get id(){return this._config.id}get name(){return this._config.name}set name(t){this._config.name=t}get exposure(){return this._config.exposure}set exposure(t){this._config.exposure=t,this.onUpdated()}get gamma(){return this._config.gamma}set gamma(t){this._config.gamma=t,this.onUpdated()}dispose(){this._camera.removeEventListener(At.eventType.POSITION_CHANGED,this._volumeTrigger.onCameraPositionUpdated),this._volumeTrigger.dispose()}reinstate(){this._camera.addEventListener(At.eventType.POSITION_CHANGED,this._volumeTrigger.onCameraPositionUpdated),this._volumeTrigger.reinstate()}serialize(){return si(si({},this._config),this._volumeTrigger.serialize())}}class Vf{constructor(){o(this,"totalResources",0);o(this,"loadedResources",0);o(this,"totalBytes",0);o(this,"loadedBytes",0)}reset(){this.totalResources=this.loadedResources=0,this.totalBytes=this.loadedBytes=0}isFinished(){return this.totalResources==this.loadedResources}progress(){return this.totalBytes==0?0:this.loadedBytes/this.totalBytes}add(t){this.totalResources+=t.totalResources,this.loadedResources+=t.loadedResources,this.totalBytes+=t.totalBytes,this.loadedBytes+=t.loadedBytes}}const Hv=(r,t)=>{const e=r%t;return r+(e==0?0:t-e)};class VS{constructor(t,e){o(this,"data");o(this,"byteOffset");this.data=t,this.byteOffset=e}readBlock(t,e){const i=new t(this.data,this.byteOffset,e);return this.byteOffset+=e*t.BYTES_PER_ELEMENT,i}alignOffset(t=4){this.byteOffset=Hv(this.byteOffset,t)}}class zS{constructor(t,e,i,n,s){o(this,"faces");o(this,"vertices");o(this,"normals");o(this,"uvs0");o(this,"uvs1");this.faces=t,this.vertices=e,this.normals=i,this.uvs0=n,this.uvs1=s}numVertices(){return this.vertices.length/3}numFaces(){return this.faces.length}}class Gh{constructor(t,e,i){o(this,"scaleFactor");o(this,"bytesPerEntry");o(this,"isInteger");this.scaleFactor=t,this.bytesPerEntry=e,this.isInteger=i}static parse(t){const e=new Float32Array(t.buffer,t.byteOffset,t.length),i=t.length/2,n=[];for(let s=0;s<i;s++){const a=e[s*2+0],l=t[s*2+1],c=l>0;n.push(new Gh(a,Math.abs(l),c))}return n}}class GS{constructor(t){o(this,"meshFlags");o(this,"meshIndices");o(this,"meshNumFaces");o(this,"meshNumVertices");o(this,"uvs0QuantInfo");o(this,"vertsQuantInfo");o(this,"quantizedVertices");o(this,"quantizedUvs0");o(this,"normals");o(this,"encodedFaces");o(this,"encodedUvs1");const e=t.readBlock(Uint32Array,7),i=e[0],n=e[1],s=e[2],a=e[3],l=e[4],c=e[5];this.meshFlags=e[6],this.meshIndices=t.readBlock(Uint32Array,i),this.meshNumFaces=t.readBlock(Uint32Array,i),this.meshNumVertices=t.readBlock(Uint32Array,i);const h=bo(this.meshFlags,2);this.uvs0QuantInfo=Gh.parse(t.readBlock(Int32Array,h?i*2:0)),this.vertsQuantInfo=Gh.parse(t.readBlock(Int32Array,i*2)),this.quantizedVertices=t.readBlock(Uint8Array,s),this.quantizedUvs0=t.readBlock(Uint8Array,l),this.normals=t.readBlock(Int8Array,a),this.encodedFaces=t.readBlock(Uint8Array,n),this.encodedUvs1=t.readBlock(Uint8Array,c),t.alignOffset()}numMeshes(){return this.meshIndices.length}numVertices(){return this.meshNumVertices.reduce((t,e)=>t+e,0)}numFaces(){return this.meshNumFaces.reduce((t,e)=>t+e,0)}dequantizeUvs0(t){const e=this.numMeshes(),i=new Float32Array(t*2),n=new Array(e);if(n.fill(!1,0,e),t==0)return[null,n];const s=this.quantizedUvs0,a=new Uint32Array(s.buffer,s.byteOffset,s.byteLength/4),l=new Float32Array(s.buffer,s.byteOffset,s.byteLength/4);let c=0,h=0;for(let d=0;d<e;d++){const u=this.uvs0QuantInfo[d],f=this.meshNumVertices[d];if(u.isInteger){for(let p=0;p<f;p++){const m=a[c+p];i[h+p*2+0]=(m&65535)*u.scaleFactor,i[h+p*2+1]=(m>>16)*u.scaleFactor}c+=f}else{for(let p=0;p<f*2;p++){const m=l[c+p];i[h+p]=m,n[d]=m<0||m>1}c+=f*2}h+=f*2}return[i,n]}dequantizeVertices(t){const e=this.numMeshes(),i=new Float32Array(t*3),n=this.quantizedVertices;let s=0,a=0;for(let l=0;l<e;l++){const c=this.vertsQuantInfo[l],d=this.meshNumVertices[l]*3;if(Ce(c.isInteger),c.bytesPerEntry==1){const u=new Int8Array(n.buffer,n.byteOffset+s,d);for(let f=0;f<d;f++)i[a+f]=u[f]*c.scaleFactor}else if(c.bytesPerEntry==2){const u=new Int16Array(n.buffer,n.byteOffset+s,d);for(let f=0;f<d;f++)i[a+f]=u[f]*c.scaleFactor}else{Ce(c.bytesPerEntry==4);const u=new Int32Array(n.buffer,n.byteOffset+s,d);for(let f=0;f<d;f++)i[a+f]=u[f]*c.scaleFactor}s=Hv(s+d*c.bytesPerEntry,4),a+=d}return i}parse(t){const e=this.numVertices(),i=this.numFaces(),n=this.quantizedUvs0.byteLength>0,s=this.encodedUvs1.byteLength>0,a=i*3,l=this.dequantizeVertices(e),c=this.normals,[h]=this.dequantizeUvs0(n?e:0),d=new Uint8Array(s?e*4:0);e>0&&s&&t.decodeVertexBuffer(d,e,4,this.encodedUvs1);const u=d.byteLength/2,f=u==0?null:new Uint16Array(d.buffer,d.byteOffset,u),p=new Uint32Array(a);if(a>0){const m=new Uint8Array(p.buffer,p.byteOffset,p.byteLength);t.decodeIndexBuffer(m,a,4,this.encodedFaces)}return new zS(p,l,c,h,f)}}class HS{constructor(t){o(this,"meshInstanceIndices");o(this,"meshIndices");o(this,"nodeIndices");o(this,"materialIndices");o(this,"lightmapIndices");o(this,"uv1Transforms");o(this,"transforms");const i=t.readBlock(Uint32Array,1)[0];this.meshInstanceIndices=t.readBlock(Uint32Array,i),this.meshIndices=t.readBlock(Uint32Array,i),this.nodeIndices=t.readBlock(Uint32Array,i),this.materialIndices=t.readBlock(Uint16Array,i),this.lightmapIndices=t.readBlock(Uint8Array,i),t.alignOffset(),this.uv1Transforms=t.readBlock(Float32Array,i*4),this.transforms=t.readBlock(Float32Array,i*12)}numMeshInstances(){return this.meshInstanceIndices.length}}class WS{constructor(t){o(this,"numSegments");o(this,"boundingBoxes");o(this,"segmentNumTextureSegments");o(this,"textureIndices");o(this,"initialSegments");const e=t.readBlock(Uint32Array,3);this.numSegments=e[0];const i=e[1],n=e[2];this.boundingBoxes=t.readBlock(Float32Array,this.numSegments*6),this.segmentNumTextureSegments=t.readBlock(Uint16Array,this.numSegments),this.textureIndices=t.readBlock(Uint16Array,n),this.initialSegments=t.readBlock(Uint16Array,i)}parseTexturesMap(){const t=new Array(this.numSegments);let e=0;for(let i=0;i<this.numSegments;i++){const n=this.segmentNumTextureSegments[i],s=new Array(n);for(let a=0;a<n;a++)s[a]=this.textureIndices[e+a];t[i]=s,e+=n}return t}}class jS{constructor(t){o(this,"numTextures");o(this,"numLightmaps");o(this,"textureNameLengths");o(this,"textureNames");const e=t.readBlock(Uint32Array,3);this.numTextures=e[0],this.numLightmaps=e[1];const i=e[2];this.textureNameLengths=t.readBlock(Uint8Array,this.numTextures),this.textureNames=t.readBlock(Uint8Array,i)}parse(){const t=new Array(this.numTextures),e=new TextDecoder;let i=0;for(let n=0;n<this.numTextures;n++){const s=this.textureNameLengths[n],a=this.textureNames.subarray(i,i+s);t[n]=e.decode(a),i+=s}return t}}class XS{constructor(t){o(this,"data");o(this,"segmentIdx");o(this,"meshesChunks");o(this,"meshInstancesChunks");o(this,"segmentsChunk");o(this,"texturesChunk");const i=new DataView(t,0,16),n=i.getUint32(0,!0),s=i.getUint16(4,!0),a=i.getUint16(6,!0),l=i.getUint32(8,!0);this.segmentIdx=i.getInt32(12,!0),Ce(n==1802528883),Ce(s==1&&a==0),this.data=t,this.meshesChunks=[],this.meshInstancesChunks=[];let c,h;const d={0:x=>this.meshesChunks.push(new GS(x)),1:x=>this.meshInstancesChunks.push(new HS(x)),2:x=>{Ce(!c,"Only single SegmentsChunk is allowed in Package"),c=new WS(x)},3:x=>{Ce(!h,"Only single TexturesChunk is allowed in Package"),h=new jS(x)}},u=new VS(t,16),f=u.readBlock(Uint8Array,l);u.alignOffset();const p=u.readBlock(Uint32Array,l);for(let x=0;x<l;x++){const w=f[x],C=u.byteOffset+p[x];d[w](u),u.byteOffset=C}this.segmentsChunk=c,this.texturesChunk=h;const m=this.meshesChunks.reduce((x,w)=>x+w.meshIndices.length,0),b=this.meshInstancesChunks.reduce((x,w)=>x+w.meshInstanceIndices.length,0),g=this.segmentsChunk?this.segmentsChunk.numSegments:0;console.log(`ScenePackage ${this.segmentIdx}: meshes:${m} instances:${b} segments:${g}`)}}class qS{constructor(t,e){o(this,"_assetsUrl");this._assetsUrl=t,this.load(-1,e)}load(t,e){console.assert(t>=-1);const i=Date.now(),n=c=>{const h=new XS(c),d=Date.now()-i;console.log(`Loaded segment ${t}: size:${c.byteLength} in: ${d} ms`),e(t,h)},s=()=>{console.log("Failed to load segment: "+t)},a=c=>{},l=this._assetsUrl+(t==-1?"shared.buf":"segment"+t+".buf");Mo(T.LOAD_PRIORITY.CORE_RESOURCE,l,!0,n,s,a,!0)}}class YS{constructor(t,e,i,n,s,a){o(this,"onProgress");o(this,"onMeshBuffersLoaded",null);o(this,"onReadyToDisplay");o(this,"onComplete");o(this,"panoramas");o(this,"_scene");o(this,"_assetsUrl");o(this,"_editMode");o(this,"_mergeConfig");o(this,"_textureManager");o(this,"_segmentManager");o(this,"_rawRenderer");o(this,"_timer",new No);o(this,"_segmentLoader");o(this,"_initialSegment");o(this,"_readyToDisplayCalled",!1);o(this,"_sceneJson");o(this,"_meshOptCompiled",!1);o(this,"_nextInitStep");o(this,"_timeout");o(this,"updateProgress",()=>{var i,n;this._timeout!==void 0&&clearTimeout(this._timeout);const t=new Vf;t.add(this._textureManager.loadingProgress());const e=(i=this._segmentManager)==null?void 0:i.loadingProgress();e&&t.add(e),(n=this.onProgress)==null||n.call(this,t.progress()),this._timeout=setTimeout(this.updateProgress,50)});Ce(T.DEV_NEW_SCENE),this._scene=t,this._assetsUrl=e,this._editMode=i,this._mergeConfig=n,this._textureManager=s,this._rawRenderer=a,this.panoramas=[]}readyToDisplay(){var t;this._readyToDisplayCalled||(this._readyToDisplayCalled=!0,(t=this.onReadyToDisplay)==null||t.call(this,this._scene))}load(){const t=()=>{this._textureManager.loadingProgress().isFinished()&&Uc(()=>{var l;this._textureManager.freeLoadingBuffers(),this._textureManager.onTextureLoaded=void 0,this.readyToDisplay(),(l=this.onComplete)==null||l.call(this,this._scene)})},e=()=>{var d;if(!this._sceneJson)return;this._nextInitStep=i;const l=this._scene,c=new xn(this._sceneJson);l.autoAddLightProbes=c.parseBoolean("autoAddLightProbes",l.autoAddLightProbes),l.interactionPrompt=c.parseBoolean("interactionPrompt",l.interactionPrompt);const h=c.child("autoTour");l.autoTour.disabled=h.parseBoolean("disabled",!1),l.autoTour.startOnLoad=h.parseBoolean("startOnLoad",!1),l.emissiveMaterialsLightEnabled=c.parseBoolean("emissiveMaterialsLightEnabled",!0),l.addLights(On.loadLights(c.parseObjects("lights"))),l.camera.setFromJson(c.parseObject("camera")),c.parseObjects("cameraVolumes").forEach(u=>l.addCameraAdjustmentVolume(new kf(u,l.camera,l.exposureController))),c.parseObjects("views").forEach(u=>l.addView(new hn(u,this._scene.center))),this._scene.createDefaultViews(),l.addNodeConfigsFromJson(this._sceneJson,this._mergeConfig),l.addNodesFromJson(this._sceneJson),(d=this._nextInitStep)==null||d.call(this)},i=()=>{var m;const l=this._sceneJson,c=this._scene;if(!l||!this._meshOptCompiled||!this._segmentLoader||!this._initialSegment)return;const h=new xn(l),d=h.parseObjects("atlases");Ce(d==null||d.length==0),this._textureManager.onTextureLoaded=b=>{var g;return(g=this._nextInitStep)==null?void 0:g.call(this)},new xf(this._textureManager,this._mergeConfig,!0).load(l,this._scene.materialManager),c.disableLightProbesForMaterials(),c.initSegmentManager(this._segmentLoader,qs,this._initialSegment),this._nextInitStep=t;const f=h.child("camera").parseObject("lutTexture");f&&(c.camera.colorMap=this._textureManager.loadColorMap(f)),c.lightmapLayoutVersion=h.child("lightmap").parseNumber("lightmapLayoutVersion",0),new zf(this._textureManager).load(l.skies||[],c),c.findSkyMesh(T.EDITOR_CONTROLLED_SKY_NAME)===null&&console.error("A sky with name "+T.EDITOR_CONTROLLED_SKY_NAME+" is missing."),this.panoramas=h.parseObjects("panoramas"),c.minimapConfig=new Vl(l,c.boundingBox),this._sceneJson=void 0,(m=this._nextInitStep)==null||m.call(this)};this._timer.reset(),this._nextInitStep=e;const n=l=>{var c;this._sceneJson=l,(c=this._nextInitStep)==null||c.call(this)},s=()=>ii.sceneLoadError();Mo(T.LOAD_PRIORITY.CORE_RESOURCE,this._assetsUrl+"scene.json",!1,n,s);const a=(l,c)=>{var h;this._initialSegment=c,(h=this._nextInitStep)==null||h.call(this)};if(this._segmentLoader=new qS(this._assetsUrl,a),!T.NO_BRDFLUT&&!$e.isLongShaderExecutionProblematicDevice()){const l=$e.ios?512:2048,c=qg(this._rawRenderer,l);this._scene.addBrdfLUT(c)}qs.ready.then(()=>{var l;this._meshOptCompiled=!0,(l=this._nextInitStep)==null||l.call(this)}),this.updateProgress()}elapsedLoadTimeSec(){return this._timer.elapsedSec()}}class zf{constructor(t){o(this,"_textureManager");this._textureManager=t}loadSkyTexture(t){t.id,this._textureManager.remove(t.id);const e=this._textureManager.load(t,En.NONE,T.LOAD_PRIORITY.SKY);return e.anisotropy=st.NO_ANISOTROPY,e}loadSingleSky(t,e,i){let n;t.type===io.PROCEDURAL||t.type===void 0?n=this._createProceduralSkyMesh(t):t.type===io.EQUIRECT?n=this._createEquirectSkyMesh(t):(console.warn("Unknown sky type: ",t.type),n=this._createProceduralSkyMesh(t)),n.fog=i,e.addSkyMesh(n)}load(t,e){const i=new Qc(t[0].fog);e.addFog(i),this.loadSingleSky({name:T.DEFAULT_SKY_NAME,type:io.PROCEDURAL},e,i),t.forEach(n=>this.loadSingleSky(n,e,i))}_createSphereSkyMesh(t,e,i){const n=ft.createSphere(1,64,64);return new Pl(t,n,e,i)}_createProceduralSkyMesh(t){const e=new ix;return this._createSphereSkyMesh(t.name,e,t.center)}_createEquirectSkyMesh(t){const e=new gm;e.map=t.texture instanceof st?t.texture:this.loadSkyTexture(t.texture);const i=this._createSphereSkyMesh(t.name,e,t.center);return i.geometry.applyMatrix(new Ue().makeScale(1,1,-1)),i.rotation.x=Math.PI/2,i.yawRotationDeg=t.yawRotation||0,i}}const Wv=function(){function r(t,e){return{formatIdx:t,gpuFormat:e}}return{ETC1:r(0,Ke.RGB_ETC1),BC1:r(2,Ke.RGB_DXT1),BC3:r(3,Ke.RGBA_DXT5),PVRTC1_4_RGB:r(8,Ke.RGB_PVRTC_4BPPV1),PVRTC1_4_RGBA:r(9,Ke.RGBA_PVRTC_4BPPV1),ASTC_4x4:r(10,Ke.RGBA_ASTC_4x4_KHR),RGBA8:r(13,Ke.RGBA8)}}();function jv(r,t,e,i,n){r({wasmBinary:t}).then(s=>{s.initializeBasis();function a(c,h,d){const u=h===d,f=Math.log2(h)%1===0&&Math.log2(d)%1===0;return i.dxtTextures?c?e.BC3:e.BC1:i.pvrtcTextures&&u&&f?c?e.PVRTC1_4_RGBA:e.PVRTC1_4_RGB:i.etc1Textures&&!c?e.ETC1:i.astcTextures?e.ASTC_4x4:e.RGBA8}function l(c){const h=new s.BasisFile(new self.Uint8Array(c));function d(){h.close(),h.delete()}const u=(W,z)=>{if(!W)throw d(),"Error in .basis file: "+z},f=h.getHasAlpha(),p=h.getNumImages(),m=h.getNumLevels(0),b=h.getImageWidth(0,0),g=h.getImageHeight(0,0);u(b!==0&&g!==0&&m!==0,"invalid dimensions"),u(p===1,"invalid number of images");const x=0,w=a(f,b,g),C=w.formatIdx;let M=h.startTranscoding();u(M,"startTranscoding failed");const D=[];for(let W=0;W<m;++W){const z=h.getImageWidth(x,W),$=h.getImageHeight(x,W),Z=h.getImageTranscodedSizeInBytes(x,W,C),ne=new self.Uint8Array(new self.ArrayBuffer(Z));M=h.transcodeImage(ne,x,W,C,0,f),u(M,"transcodeImage failed"),D.push({data:ne,width:z,height:$})}return d(),{gpuFormat:w.gpuFormat,mipmaps:D}}n(l)})}function QS(r,t,e,i){const n=new window.Worker(r);let s=null;const a={processItem:function(h){console.assert(!s),s=h,n.postMessage(h.texBuffer,[h.texBuffer])},terminate:function(){console.assert(!s),n.terminate()}},l=function(h){throw"Worker error @L"+h.lineno+": "+h.message};n.addEventListener("error",l);const c=function(){n.removeEventListener("error",l),n.removeEventListener("message",c),n.addEventListener("error",function(h){const d="Worker error @L"+h.lineno+": "+h.message;s&&(s.onError(d),s=null)}),n.addEventListener("message",function(h){console.assert(s),s.onSuccess(h.data),s=null,i(a)}),e(),i(a)};n.addEventListener("message",c),n.postMessage(t)}function KS(r,t,e,i){const n=`
self.importScripts(`+JSON.stringify(r)+`);
const initBasis = `+jv.toString()+`;
const basisFormats = `+JSON.stringify(Wv)+`;
const glDetector = `+JSON.stringify({astcTextures:t.gl.astcTextures,dxtTextures:t.gl.dxtTextures,etc1Textures:t.gl.etc1Textures,pvrtcTextures:t.gl.pvrtcTextures})+`;

function initHandler(evt) {
  self.removeEventListener('message', initHandler);

  const wasmBinary = evt.data;
  initBasis(BASIS, wasmBinary, basisFormats, glDetector,
            decodeTexBuffer => {
    self.addEventListener('message', function(evt) {
        const texBuffer = evt.data;
        const texDatas = decodeTexBuffer(texBuffer);
        // second argument to transfer ownership to the main thread
        self.postMessage(texDatas, texDatas.mipmaps.map(t => t.data.buffer));
    });
    self.postMessage({}); // communicate end of init
  });
}

self.addEventListener('message', initHandler);
`,s=window.URL.createObjectURL(new window.Blob([n]));let a=!1,l=0;const c=[],h=[],d=new h_(()=>{for(const f of c)f.terminate();l-=c.length,c.length=0},5e3);function u(){d.deferRun(),h.length!==0&&(c.length>0?(c.pop().processItem(h.pop()),u()):l<i&&!a&&(l++,a=!0,QS(s,e,()=>{a=!1},m=>{c.push(m),u()})))}return function(p,m,b){h.push({texBuffer:p,onSuccess:m,onError:b}),u()}}function $S(r,t){Hc(yi("lib/basis/basis_transcoder.wasm"),!0,function(e){const i=yi("lib/basis/basis_transcoder.js"),n=r.basisDecodeWorkers;if(n<=0){const s=window.document.createElement("script");s.addEventListener("load",function a(){s.removeEventListener("load",a),jv(window.BASIS,e,Wv,r.gl,l=>{t(function(c,h,d){try{h(l(c))}catch(u){d(u)}})})}),s.src=i,window.document.head.appendChild(s)}else t(KS(i,r,e,n))},e=>{throw e})}function ZS(r){if(!(window.WebAssembly&&(r.gl.pvrtcTextures||r.gl.etc1Textures||r.gl.dxtTextures||r.gl.astcTextures)))return;const t=[];let e=(...s)=>{t.push(s)};function i(s){e=s,t.forEach(a=>e(...a)),t.length=0}let n=!1;return{load:function(s,a,l,c){const h=()=>c(s);n||(n=!0,$S(r,i)),a(function(d){e(d,function(u){const f=u.mipmaps;s.format=u.gpuFormat,s.mipmaps=f.map(p=>new pr(p.data,p.width,p.height)),s.width=f[0].width,s.height=f[0].height,s.minFilter=f.length===1?H.LINEAR:H.LINEAR_MIPMAP_LINEAR,s.flipY=!1,s.generateMipmaps=!1,s.needsUpdate=!0,l(s)},h)},h)}}}let Xv=!1;function JS(r,t,e,i){function n(a){const l=a.sigBytes,c=a.words,h=new Uint8Array(l);let d=0,u=0;for(;d!==l;){let f=c[u++];if(h[d++]=(f&4278190080)>>>24,d===l||(h[d++]=(f&16711680)>>>16,d===l)||(h[d++]=(f&65280)>>>8,d===l))break;h[d++]=f&255}return h}function s(){Xv=!0;const a=CryptoJS.lib.WordArray.create(r),l=a.clone();l.sigBytes=16,l.clamp(),a.words.splice(0,4),a.sigBytes-=16;const c=CryptoJS.enc.Base64.parse(t),h=CryptoJS.AES.decrypt({ciphertext:a},c,{iv:l,mode:CryptoJS.mode.CFB}),d=n(h);e(d.buffer)}Xv?s():So(yi("lib/crypto-js.min.js"),s,()=>ii.error("Cannot load required library"))}function eM(r){const i=[],n=(g,x)=>{if(!g)throw"Error in .ktx file: "+x},s=new Int32Array(r,0,16);n(s[3]===67305985,"endianness mismatch"),n(s[4]===0&&s[5]===1&&s[6]===0,"invalid header");let a,l;s[7]===35842?(l=6408,a=Ke.RGBA_PVRTC_4BPPV1):s[7]===36196?(l=6407,a=Ke.RGB_ETC1):s[7]===33776?(l=6407,a=Ke.RGB_DXT1):s[7]===33779?(l=6408,a=Ke.RGBA_DXT5):n(!1,"unknown internal format: "+s[7]),n(s[8]===l,"invalid base internal format: ",s[8]);const c=s[9],h=s[10];n((c&c-1)===0&&(h&h-1)===0,"non power-of-two size: "+c+" "+h),n(s[11]===0&&s[12]===0&&s[13]===1,"invalid header");const d=s[14],u=s[15];n(u%4===0,"invalid header");let f=4*16+u;const p=new DataView(r,0);let m=c,b=h;for(let g=0;g<d;++g){const x=p.getUint32(f,!0);f+=4;const w=new Uint8Array(r,f,x);i.push({data:w,width:m,height:b});const C=3-(x+3)%4;f+=x+C,m=Math.max(m/2,1),b=Math.max(b/2,1)}return n(f===r.byteLength,"invalid data size"),{format:a,width:c,height:h,mipmapCount:d,mipmaps:i}}function tM(){this.load=function(r,t,e,i,n){const s=[];r.flipY=!1,r.generateMipmaps=!1,r.image=s;function a(l){let c;try{c=eM(l)}catch(h){console.error(h),n(r);return}if(c.isCubemap){const h=c.mipmaps.length/c.mipmapCount;for(let d=0;d<h;d+=1){s[d]={mipmaps:[]};for(let u=0;u<c.mipmapCount;u+=1)s[d].mipmaps.push(c.mipmaps[d*c.mipmapCount+u]),s[d].format=c.format,s[d].width=c.width,s[d].height=c.height}}else r.image.width=c.width,r.image.height=c.height,r.mipmaps=c.mipmaps.map(h=>new pr(h.data,h.width,h.height));c.mipmapCount===1&&(r.minFilter=H.LINEAR),r.format=c.format,r.width=c.width,r.height=c.height,i&&i(r)}Mo(t,e,!0,a,n)}}function Ko(r,t){return r.indexOf(t)>-1}function qv(r,t){return function(e,i){Mo(r,t,!0,e,i)}}function Yv(r,t,e){return function(i,n){qv(r,t)(function(a){JS(a,e,i)},n)}}function iM(r,t,e,i,n,s,a){const l=()=>s(r);r.format=i;function c(h){r.image=h,r.width=h.width,r.height=h.height,n(r)}return a!==void 0?Yv(t,e,a)(function(d){const u=new Uint8Array(d),f=e.endsWith("png")?"image/png":e.endsWith("webp")?"image/webp":"image/jpeg",p=new Blob([u],{type:f}),b=(window.URL||window.webkitURL).createObjectURL(p),g=new Image;g.onload=function(){c(g)},g.src=b},l):Fp(t,e,c,l),r}function nM(r,t,e,i,n,s){r.format=i;function a(l){r.video=l,r.width=l.videoWidth,r.height=l.videoHeight,n(r),r.pauseWhenLoaded&&(r.pause(),r.rewind())}kb(t,e,a,()=>s(r))}class sM{constructor(t){o(this,"ios");o(this,"mobile");o(this,"pvrtc");o(this,"etc1");o(this,"dxt");this.ios=t.ios,this.mobile=t.mobile,this.pvrtc=t.gl.pvrtcTextures,this.etc1=t.gl.etc1Textures,this.dxt=t.gl.dxtTextures}}class rM{constructor(t,e,i,n,s,a){o(this,"_assetsUrl");o(this,"_onTextureLoaded");o(this,"_onTextureLoadFailed");o(this,"_onTextureLoadFailedSoft");o(this,"_onVideoTextureLoadFailed");o(this,"_basisLoader");o(this,"_ktxLoader");o(this,"_platformInfo");this._ktxLoader=new tM,T.NO_BASIS||(this._basisLoader=ZS(e)),this._onTextureLoaded=i,this._onTextureLoadFailed=n,this._onTextureLoadFailedSoft=s,this._onVideoTextureLoadFailed=a,this._platformInfo=new sM(e),this._assetsUrl=t}getTexturePath(t){const e=t.id,i=t.webFormats;if(Ce(i.length>0,"No web format for texture: "+t.id+"."+t.rawExt),t.url)return t.url;if(t instanceof jr)return this._assetsUrl+"video/"+i[0]+"/"+e+"."+t.stdExt;const n=this._assetsUrl+"img/",s=this._platformInfo.ios&&t.encoding;if(this._basisLoader&&!s){if(!this._platformInfo.mobile&&Ko(i,"large/basis"))return n+"large/basis/"+e+".basis";if(Ko(i,"small/basis"))return n+"small/basis/"+e+".basis"}if(this._platformInfo.pvrtc&&!s&&Ko(i,"small/pvr"))return n+"small/pvr/"+e+".ktx";if(this._platformInfo.etc1&&Ko(i,"small/etc1"))return n+"small/etc1/"+e+".ktx";if(this._platformInfo.dxt&&Ko(i,"large/dxt"))return n+"large/dxt/"+e+".ktx";const a=Ko(i,"small/std");return Ko(i,"large/std")&&(!this._platformInfo.mobile||!a)?n+"large/std/"+e+"."+t.stdExt:n+"small/std/"+e+"."+t.stdExt}loadIntDataTexture(t,e,i,n,s,a){t.anisotropy=st.NO_ANISOTROPY;const l=()=>a(t);function c(h){const d=new Uint8Array(h,0,h.byteLength),u=d[0],f=d[1];Ce(t.image instanceof pr),t.image.width=Math.pow(2,u),t.image.height=Math.pow(2,f),t.format=n,t.image.data=d.subarray(2),s&&s(t)}Mo(e,i,!0,c,l)}load(t,e,i=!1){nt(t.loadingStatus==fr.NOT_LOADED||t.loadingStatus==fr.POSTPONED),t.loadingStatus=fr.IN_PROGRESS;const n=t.hasAlpha?Ke.RGBA8:Ke.RGB8,s=this.getTexturePath(t),a=/\.basis$/.test(s),l=/\.ktx$/.test(s),c=/\.buf$/.test(s),h=t instanceof jr,d=!(l||c||h),u=m=>{console.error("Error while loading texture: ",s),(i?this._onTextureLoadFailedSoft:this._onTextureLoadFailed)(m)},f=m=>{console.error("Error while loading video texture: ",s),this._onVideoTextureLoadFailed(m)},p=m=>{m.needsUpdate=!0,this._onTextureLoaded(m),m.notifyLoaded()};if(c)this.loadIntDataTexture(t,e,s,n,p,u);else if(a&&this._basisLoader){let m;t.passphrase===void 0?m=qv(e,s):m=Yv(e,s,t.passphrase),this._basisLoader.load(t,m,p,u)}else l?this._ktxLoader.load(t,e,s,p,u):d?iM(t,e,s,n,p,u,t.passphrase):(Ce(h),nM(t,T.LOAD_PRIORITY.VIDEO,s,n,p,f))}}class oM{constructor(t,e,i,n){o(this,"numVertices");o(this,"numIndices");o(this,"vertexOffset");o(this,"indexOffset");this.numVertices=t,this.numIndices=e,this.vertexOffset=i,this.indexOffset=n}}class aM{constructor(t,e,i,n){o(this,"boundingBox");o(this,"geometryRange");o(this,"segmentIdx");o(this,"geometryIdx");this.boundingBox=t,this.geometryRange=e,this.segmentIdx=i,this.geometryIdx=n}}class Gf{constructor(t,e,i,n,s,a,l){o(this,"meshIdx");o(this,"nodeIdx");o(this,"materialId");o(this,"lightmapIdx");o(this,"transform");o(this,"uv1Transform");o(this,"boundingBox");this.meshIdx=t,this.nodeIdx=e,this.materialId=i,this.transform=s,this.uv1Transform=a,this.boundingBox=l,this.lightmapIdx=n}}o(Gf,"invalidLightmapIdx",255);class Hh{constructor(t,e,i){o(this,"geometries");o(this,"meshes");o(this,"meshInstances");this.geometries=t,this.meshes=e,this.meshInstances=i}static parse(t,e){const i=Date.now(),n=new Array,s=new Map,a=new Map;for(const c of t.meshesChunks){const h=c.parse(e),d=new xa;d.vertexCnt=c.numVertices(),d.indexCnt=c.numFaces()*3,d.vertices=h.vertices,d.normals=h.normals,d.index=h.faces,d.indexUint=!0,d.uvs0=h.uvs0,d.uvs1=h.uvs1,d.addCoreAttributes(),d.uvs0!==null&&d.addUv0Attribute(),d.uvs1!==null&&d.addUv1Attribute();const u=n.length;n.push(d);let f=0,p=0;for(let m=0;m<c.numMeshes();m++){const b=new li,g=c.meshNumVertices[m],x=c.meshNumFaces[m]*3,w=new oM(g,x,f,p);f+=g,p+=x,s.set(c.meshIndices[m],new aM(b,w,t.segmentIdx,u))}}for(const c of t.meshInstancesChunks)for(let h=0;h<c.numMeshInstances();h++)a.set(h,Hh._parseInstance(c,h));const l=Date.now()-i;return console.log(`Parsing SegmentChunk(${t.segmentIdx}): time: ${l} ms`),new Hh(n,s,a)}static _parseInstance(t,e){const i=new li,n=new Float32Array(16);for(let a=0;a<12;a++)n[a]=t.transforms[e*12+a];n[12]=n[13]=n[14]=0,n[15]=1;const s=new Float32Array(4);for(let a=0;a<4;a++)s[a]=t.uv1Transforms[e*4+(a+2)%4];return new Gf(t.meshIndices[e],t.nodeIndices[e],t.materialIndices[e],t.lightmapIndices[e],n,s,i)}}function lM(r,t,e){const i=[65433,2293759,13395711,16737945,16763904,13395609,13421568],n=Kd();n.baseColor=new _e(i[e%i.length]).convertGammaToLinear(),n.setUniforms();const s=new je(ft.createBox(1,1,1),n);return s.position.addVectors(t.min,t.max).multiplyScalar(.5),s.scale.subVectors(t.max,t.min).multiplyScalar(1),s.updateMatrixWorld(),r.addAuxiliaryObject(s),s}class cM{constructor(t,e,i){o(this,"meshes",[]);o(this,"bboxMesh");for(const n of t.meshInstances.values()){const s=t.meshes.get(n.meshIdx),a=s.geometryRange,l=t.geometries[s.geometryIdx],c=new Ea(a.numIndices,a.numVertices,l),h=n.uv1Transform.slice(),d=65535;h[2]*=1/d,h[3]*=1/d,c.defaultAttributeValues=new qd,c.defaultAttributeValues.uv1Mod=h,c.boundingBox=n.boundingBox,c.boundingSphere=c.boundingBox.getBoundingSphere(),c.vertexAttribOffset=a.vertexOffset,c.indexOffset=a.indexOffset;const u=e.materialManager.getMaterial(n.materialId),f=new Tn(e.findNode(n.nodeIdx),c,u);if(f.matrixWorld=new Ue,f.matrixWorld.elements=n.transform,f.matrixWorld=f.matrixWorld.transpose(),i.length>0){const p=n.lightmapIdx==Gf.invalidLightmapIdx?0:n.lightmapIdx;Ce(p>=0&&p<i.length),f.lightmap=i[p]}this.meshes.push(f),e.addGpuMesh(f)}}}const Qv=2*1024*1024;class hM{constructor(t,e,i,n){o(this,"numSegments");o(this,"_segmentBoundingBoxes",[]);o(this,"_segmentPackages",[]);o(this,"_loadingSegments",[]);o(this,"_segments",[]);o(this,"_segmentRenderables",[]);o(this,"_meshoptDecoder");o(this,"_loader");o(this,"_loadingProgress",new Vf);o(this,"_textureManager");o(this,"_textureNames");o(this,"_texturesMap");o(this,"_segmentVisBoxes",new Array);o(this,"_onSegmentLoaded",(t,e)=>{const i=this._loadingSegments.indexOf(t);Ce(i!=-1),this._loadingSegments.splice(i,1),this._segmentPackages[t]=e;const n=Hh.parse(e,this._meshoptDecoder);this._segments[t]=n,this._loadingProgress.loadedBytes+=Qv,this._loadingProgress.loadedResources++});var a,l;this._loader=e,this._meshoptDecoder=i,this._textureManager=t,Ce(n.segmentsChunk);const s=n.segmentsChunk;this.numSegments=s.numSegments;for(let c=0;c<this.numSegments;c++){const h=new L(s.boundingBoxes[c*6+0],s.boundingBoxes[c*6+1],s.boundingBoxes[c*6+2]),d=new L(s.boundingBoxes[c*6+3],s.boundingBoxes[c*6+4],s.boundingBoxes[c*6+5]);this._segmentBoundingBoxes.push(new li(h,d)),this._segmentPackages.push(void 0),this._segments.push(void 0)}this._textureNames=(a=n.texturesChunk)==null?void 0:a.parse(),this._texturesMap=(l=n.segmentsChunk)==null?void 0:l.parseTexturesMap()}visibleSegments(t){const e=[];for(let i=0;i<this.numSegments;i++)t.intersectsBox(this._segmentBoundingBoxes[i])&&e.push(i);return e}isLoaded(t){return console.assert(t>=0&&t<this.numSegments),this._segmentPackages[t]!==void 0}areTexturesLoaded(t){if(!this._texturesMap||!this._textureNames)return!1;const e=i=>{const n=this._textureManager.findTexture(this._textureNames[i]);return n&&n.loaded};return this._texturesMap[t].every(e)}loadSegment(t){if(!(this.isLoaded(t)||this._loadingSegments.includes(t))&&(this._loadingSegments.push(t),this._loader.load(t,this._onSegmentLoaded),this._loadingProgress.totalBytes+=Qv,this._loadingProgress.totalResources++,this._texturesMap&&this._textureNames)){const e=this._texturesMap[t].map(i=>this._textureNames[i]);this._textureManager.loadPostponed(e)}}loadVisibleSegments(t){for(const e of this.visibleSegments(t))this.loadSegment(e)}loadAllSegments(){for(let t=0;t<this.numSegments;t++)this.loadSegment(t)}updateRenderables(t,e){for(let i=0;i<this.numSegments;i++){if(this._segments[i]!==void 0&&this._segmentRenderables[i]===void 0){if(!this.areTexturesLoaded(i))continue;const a=new cM(this._segments[i],t,e);this._segmentRenderables[i]=a}const n=!this.isLoaded(i),s=this._segmentVisBoxes[i]!==void 0;n&&!s&&(this._segmentVisBoxes[i]=lM(t,this._segmentBoundingBoxes[i],i)),!n&&s&&(t.removeAuxiliaryObject(this._segmentVisBoxes[i]),this._segmentVisBoxes[i]=void 0)}}updateHelpers(){}loadingProgress(){return this._loadingProgress}}let dM=0;function Wh(r,t,e){return!r.some(i=>Object.prototype.hasOwnProperty.call(i,e)&&i[e]===t)}function ka(r,t,e){return r.find(i=>i[e]===t)}var Kv=(r=>(r.UPDATED="sceneUpdated",r.ANY_VIEW_UPDATED="anyViewUpdated",r.VIEW_ADDED="viewAdded",r.VIEW_REMOVED="viewRemoved",r.VIEW_SHIFTED="viewShifted",r.SKY_MESH_ADDED="skyMeshAdded",r.SKY_MESH_REMOVED="skyMeshRemoved",r.LIGHT_ADDED="lightAdded",r.LIGHT_REMOVED="lightRemoved",r.LIGHT_PROBE_ADDED="lightProbeAdded",r.LIGHT_PROBE_REMOVED="lightProbeRemoved",r.LIVE_LIGHTMAP_NEEDS_UPDATE="liveLightmapNeedsUpdate",r))(Kv||{});const vn=class vn extends ci{constructor(e){super();o(this,"id");o(this,"camera");o(this,"threeScene",new pl(!0));o(this,"autoAddLightProbes",!0);o(this,"autoTour",{disabled:!1,startOnLoad:!1});o(this,"disableProgressiveLoader",!1);o(this,"interactionPrompt",!1);o(this,"materialManager");o(this,"nodeConfigs",new Array);o(this,"_nodeConfigsLookup",{});o(this,"nodes",new Array);o(this,"_animatedRootNodes",new Array);o(this,"_nodeLookup",{});o(this,"gpuMeshes",new Array);o(this,"segmentManager");o(this,"segmentLightmaps",new Array);o(this,"textureManager");o(this,"exposureController");o(this,"renderCaches",new Map);o(this,"_animatableAuxiliaryObjects",new Set);o(this,"boundingBox",new li);o(this,"collisionBoundingBox",new li);o(this,"_sumLogicalMeshCenter",new L);o(this,"_logicalNonemptyMeshCount",0);o(this,"_center",new L);o(this,"skyMeshes",new Array);o(this,"views",new Array);o(this,"internalViews",new Array);o(this,"lights",new Array);o(this,"lightProbes",new Array);o(this,"cameraVolumes",new Array);o(this,"lightmapLayoutVersion",0);o(this,"liveLightmap");o(this,"minimapConfig",null);o(this,"sharedMaterialState");o(this,"_updated",()=>{this.dispatchEvent({type:vn.eventType.UPDATED})});o(this,"_anyViewUpdated",()=>{this.dispatchEvent({type:vn.eventType.ANY_VIEW_UPDATED}),this._updated()});o(this,"_liveLightmapUpdateNeeded",()=>{this.dispatchEvent({type:vn.eventType.LIVE_LIGHTMAP_NEEDS_UPDATE})});o(this,"_logicalMeshCenter",new L);o(this,"_nodeConfigUpdated",()=>{this._animatedRootNodes.length=0,this.visitAllNodes(e=>{e.isAnimatedRoot&&this._animatedRootNodes.push(e)}),this._updated()});this.id=dM++,this.camera=e,this.liveLightmap=new Yc,this.sharedMaterialState=new sl(this.camera,this.liveLightmap),this.materialManager=new Ax(this.gpuMeshes,this.sharedMaterialState,()=>this.lightProbes.length===0,this._animatableAuxiliaryObjects,this._updated,this._liveLightmapUpdateNeeded),this.camera.addEventListener(At.eventType.UPDATED,this._updated)}canStartAutoTour(){return!this.autoTour.disabled&&this.visibleViews().length>1}startAutoTourOnLoad(){return this.canStartAutoTour()&&this.autoTour.startOnLoad&&!T.EDIT_MODE}initSegmentManager(e,i,n){Ce(this.textureManager),this.segmentManager=new hM(this.textureManager,e,i,n);const s=this.views[0].toCamera(),a=new Ue;a.multiplyMatrices(s.projectionMatrix,s.matrixWorldInverse);const l=new fa;l.setFromMatrix(a),this.segmentManager.loadVisibleSegments(l)}updateSegments(){const e=this.camera;e.updateMatrixWorld(!0),e.matrixWorldInverse.getInverse(e.matrixWorld);const i=new Ue;i.multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse);const n=new fa;n.setFromMatrix(i),this.segmentManager.loadVisibleSegments(n),this.segmentManager.updateRenderables(this,this.segmentLightmaps)}serialize(){const e=i=>i.name!==T.DEFAULT_SKY_NAME;return{emissiveMaterialsLightEnabled:this.emissiveMaterialsLightEnabled,disableProgressiveLoader:this.disableProgressiveLoader,interactionPrompt:this.interactionPrompt,autoTour:this.autoTour,camera:this.camera.serialize(),materials:this.materialManager.serialize(),nodeConfigs:this.nodeConfigs.map(i=>i.serialize()),nodes:this.nodes.map(i=>i.serialize()),lights:this.lights.map(i=>i.serialize()),lightProbes:this.lightProbes.map(i=>i.serialize()),cameraVolumes:this.cameraVolumes.map(i=>i.serialize()),autoAddLightProbes:!1,views:this.views.map(i=>i.serialize()),skies:this.skyMeshes.filter(e).map(i=>i.serialize()),minimap:this.minimapConfig.serialize()}}get emissiveMaterialsLightEnabled(){return this.sharedMaterialState.emissiveMaterialsLightEnabled}set emissiveMaterialsLightEnabled(e){this.sharedMaterialState.emissiveMaterialsLightEnabled=e,this.dispatchEvent({type:vn.eventType.LIVE_LIGHTMAP_NEEDS_UPDATE})}get materials(){return this.materialManager.materials}getMaterials(){return this.materials}addNodeConfigsFromJson(e,i){e.nodeConfigs.forEach(n=>{n.editable=i.isNodeTypeEditable(n.name),this.addNodeConfig(new xx(n))})}addNodesFromJson(e){const i=(n,s)=>{s.config;const a=this.findNodeConfig(s.config),l=new Pm(n,a,s);return s.children&&(l.children=s.children.map(c=>i(l,c))),l};e.nodes.forEach(n=>this.addNode(i(null,n)))}addNodeConfig(e){this.nodeConfigs.push(e),this._nodeConfigsLookup[e.name]=e,e.addEventListener(Mm.UPDATED,this._nodeConfigUpdated)}findNodeConfig(e){return Object.prototype.hasOwnProperty.call(this._nodeConfigsLookup,e)?this._nodeConfigsLookup[e]:null}addNode(e){this.nodes.push(e),e.visitSubtree(i=>{this._nodeLookup[i.id]=i,i.isAnimatedRoot&&this._animatedRootNodes.push(i)})}findNode(e){return this._nodeLookup[e]}visitAllNodes(e){for(const i of this.nodes)i.visitSubtree(e)}visitMeshesWithMaterial(e,i){this.visitAllNodes(n=>{const s=n.mesh;s&&s.material===e&&i(s)})}_updateSceneCenterWithGpuMesh(e){if(e instanceof Co)for(let i=0;i<e.logicalMeshes.length;i+=1){const n=e.logicalMeshes[i].geometry.boundingBox;n.empty()||(n.center(this._logicalMeshCenter),this._sumLogicalMeshCenter.add(this._logicalMeshCenter),++this._logicalNonemptyMeshCount)}else{const i=e.geometry.boundingBox;i.empty()||(i.center(this._logicalMeshCenter),this._sumLogicalMeshCenter.add(this._logicalMeshCenter),++this._logicalNonemptyMeshCount)}this._logicalNonemptyMeshCount&&this._center.copyFrom(this._sumLogicalMeshCenter).divideScalar(this._logicalNonemptyMeshCount)}addGpuMesh(e){this.addAuxiliaryObject(e,!1),this.gpuMeshes.push(e),this.boundingBox.union(e.geometry.boundingBox),(e instanceof Co?e.logicalMeshes:[e]).forEach(n=>{n.node.disableCollisions||this.collisionBoundingBox.union(n.geometry.boundingBox)}),this._updateSceneCenterWithGpuMesh(e)}addAuxiliaryObject(e,i=!1){this.threeScene.add(e),e.traverse(n=>{if(!(n instanceof je))return;const s=n.material;s&&s.sharedMaterialState===null&&(s.sharedMaterialState=this.sharedMaterialState)}),i&&this._animatableAuxiliaryObjects.add(e),this._updated()}removeAuxiliaryObject(e){this.threeScene.remove(e),this._animatableAuxiliaryObjects.delete(e),this._updated()}addFog(e){nt(this.sharedMaterialState.fog===void 0),this.sharedMaterialState.fog=e}addBrdfLUT(e){this.sharedMaterialState.brdfLUT=e}setLightmapEncoding(e){this.sharedMaterialState.lightmapEncoding=e}getLightmapEncoding(){return this.sharedMaterialState.lightmapEncoding}hasLightmap(){return this.sharedMaterialState.lightmapEnabled}addSkyMesh(e){this.skyMeshes.push(e),e.addEventListener(Pl.eventType.UPDATED,this._updated),this.dispatchEvent({type:vn.eventType.SKY_MESH_ADDED,skyMesh:e})}removeSkyMesh(e){Qi(e,this.skyMeshes),this.dispatchEvent({type:vn.eventType.SKY_MESH_REMOVED,skyMesh:e}),e.geometry.dispose(),e.material.dispose()}findSkyMesh(e){return ka(this.skyMeshes,e,"name")}addLight(e){nt(Wh(this.lights,e.name,"name")),this.lights.push(e),e.addEventListener(On.eventType.UPDATED,this._updated),e.addEventListener(On.eventType.INSTANCE_ADDED,this._updated),e.addEventListener(On.eventType.INSTANCE_REMOVED,this._updated),e.addEventListener(On.eventType.UPDATED,this._liveLightmapUpdateNeeded),e.addEventListener(On.eventType.INSTANCE_ADDED,this._liveLightmapUpdateNeeded),e.addEventListener(On.eventType.INSTANCE_REMOVED,this._liveLightmapUpdateNeeded),this._updated(),this.dispatchEvent({type:vn.eventType.LIGHT_ADDED,light:e})}addLights(e){for(const i of e)this.addLight(i)}removeLight(e){Qi(e,this.lights),this._updated(),this.dispatchEvent({type:vn.eventType.LIGHT_REMOVED,light:e}),this._liveLightmapUpdateNeeded()}addLightProbe(e){nt(Wh(this.lightProbes,e.id,"id")),this.lightProbes.push(e),e.addEventListener(nn.eventType.POSITION_UPDATED,this._updated),e.addEventListener(nn.eventType.BOUNDS_UPDATED,this._updated),this._updated(),this.dispatchEvent({type:vn.eventType.LIGHT_PROBE_ADDED,lightProbe:e})}removeLightProbe(e){Qi(e,this.lightProbes);for(const i of this.gpuMeshes)_b(e,i.lightProbes);this._updated(),this.dispatchEvent({type:vn.eventType.LIGHT_PROBE_REMOVED,lightProbe:e}),e.dispose()}findLightProbe(e){return ka(this.lightProbes,e,"id")}findLightProbes(e){const i=new Array;let n;for(const s of e)n=ka(this.lightProbes,s,"id"),n&&i.push(n);return i}closestLightProbe(e){let i=null,n=1/0;for(const s of this.lightProbes){const a=e.distanceTo(s.position);a<n&&(n=a,i=s)}return i}addCameraAdjustmentVolume(e){nt(Wh(this.cameraVolumes,e.id,"id")),this.cameraVolumes.push(e),e.getCameraVolumeTrigger().addEventListener(jn.eventType.UPDATED,this._updated),this._updated()}removeCameraVolume(e){Qi(e,this.cameraVolumes),e.dispose(),this._updated()}findCameraVolume(e){return ka(this.cameraVolumes,e,"id")}shiftCameraVolume(e,i){nt(this.cameraVolumes.length>0),kc(this.cameraVolumes,e,i);for(let n=0;n<this.cameraVolumes.length;n+=1)this.cameraVolumes[n].setPriority(n);this.cameraVolumes.at(-1).onUpdated()}allViews(){return this.views.concat(this.internalViews)}findView(e){return ka(this.allViews(),e,"id")}findViewByName(e){return ka(this.allViews(),e,"name")}visibleViews(){return this.allViews().filter(e=>!e.hideFromMenu)}addView(e){nt(Wh(this.allViews(),e.id,"id")),e.internal?this.internalViews.push(e):this.views.push(e),e.addEventListener(hn.eventType.UPDATED,this._anyViewUpdated),this._updated(),this.dispatchEvent({type:vn.eventType.VIEW_ADDED,view:e})}removeView(e){Qi(e,e.internal?this.internalViews:this.views),this.nodeConfigs.forEach(i=>i.removeFromHideInViews(e.id)),this._updated(),this.dispatchEvent({type:vn.eventType.VIEW_REMOVED,view:e})}shiftView(e,i){nt(e.internal===!1),kc(this.views,e,i),this.dispatchEvent({type:vn.eventType.VIEW_SHIFTED,view:e})}createDefaultViews(){if(this.views.length===0){const e=new hn({id:0,name:"Start place",hideFromMenu:!T.SHOW_INTERNAL_VIEWS,position:this.center.toArray(),rotation:[0,0],internal:!0,sky:T.EDITOR_CONTROLLED_SKY_NAME});this.addView(e)}if(T.SHOW_INTERNAL_VIEWS||T.EDIT_MODE){const e=Math.max(...this.allViews().map(d=>d.id)),i=this.boundingBox.getBoundingSphere().radius,n=this.boundingBox.size(),s=this.boundingBox.center().toArray(),a={hideFromMenu:!T.SHOW_INTERNAL_VIEWS,internal:!0,mode:Cs.ORBIT,orthographic:!0,target:s,distance:i,maxDistance:i*2},l=new hn(Rn(si({},a),{id:e+1,name:Jh.TOP,orthoFrustumSize:Math.max(n.x,n.y),rotation:[0,-90]})),c=new hn(Rn(si({},a),{id:e+2,name:Jh.FRONT,orthoFrustumSize:Math.max(n.x,n.z),rotation:[0,0]})),h=new hn(Rn(si({},a),{id:e+3,name:Jh.LEFT,orthoFrustumSize:Math.max(n.y,n.z),rotation:[-90,0]}));this.addView(l),this.addView(c),this.addView(h)}}adjustSkiesAndCameraFarToSpanWholeScene(){const e=(l,c)=>{const h=Math.max(Math.abs(l.min.x-c.x),Math.abs(l.max.x-c.x)),d=Math.max(Math.abs(l.min.y-c.y),Math.abs(l.max.y-c.y)),u=Math.max(Math.abs(l.min.z-c.z),Math.abs(l.max.z-c.z));return Math.sqrt(h*h+d*d+u*u)},i=(l,c)=>{const h=l.maxDistance===void 0?l.distance:l.maxDistance;if(l.target&&h)return l.target.distanceTo(c)+h},n=(l,c)=>{if(l.position)return l.position.distanceTo(c)},s=(l,c)=>{let h=0;return l.forEach(d=>{let u;d.mode===Cs.ORBIT?u=i(d,c):d.mode===Cs.FPS&&(u=n(d,c)),u&&u>h&&(h=u)}),h};let a=0;for(const l of this.skyMeshes){l.autoPosition&&l.position.copyFrom(this.center);let c;if(this.boundingBox.empty())c=0;else{const h=e(this.boundingBox,l.position),d=s(this.allViews(),l.position);c=Math.max(h,d)}c+=T.SKY_DISTANCE_TO_SCENE,l.radius=c,a=Math.max(a,c)}this.camera.far=Math.max(this.camera.far,2*a),Re.log("Camera far set to "+this.camera.far)}disableLightProbesForMaterials(){for(const e of this.materials)e.disableLightProbe=!0,e.setUniforms()}enableLightProbesForMaterials(){for(const e of this.materials)e.disableLightProbe=!1,e.setUniforms()}getAnimatedRootNodes(){return this._animatedRootNodes}get center(){return this._center}};o(vn,"eventType",Kv);let Hi=vn;function uM(r){const t=new Es(new _e(16777215*Math.random())),e=ft.createBox(r.max.x-r.min.x,r.max.y-r.min.y,r.max.z-r.min.z),i=new je(e,t);return r.center(i.position),i.updateMatrixWorld(),i}function fM(r,t=!1){for(const e of r.gpuMeshes){if(!(e instanceof je)||t&&!e.material.transparent)continue;const i=e.geometry;i.boundingBox||i.computeBoundingBox();const n=uM(i.boundingBox);r.addAuxiliaryObject(n)}}const pM=function(r,t){console.warn("Camera path debug mode");const e=2,i=document.createElement("canvas"),n=i.getContext("2d");i.width=r*e,i.height=t*e,i.style.position="absolute",i.style.left="0",i.style.top="0",i.style.maxWidth="100%",document.body.appendChild(i);const s={};function a(b){return parseFloat(b.toFixed(4))}function l(b,g){return b.reduce((x,w)=>x+w[g],0)}function c(b,g="black",x=1,w=1){const C=b.x*e,M=b.y*e,D=w*e;n.lineWidth=x*e,n.strokeStyle=g,n.beginPath(),n.arc(C,M,D,0,Math.PI*2),n.stroke()}function h(b,g="black",x=1,w=!1){const C=b.x*e-.5*e,M=b.y*e-.5*e,D=e,W=e;n.lineWidth=x*e,n.strokeStyle=g,n.fillStyle=g,n.beginPath(),n.rect(C,M,D,W),n.stroke(),w&&n.fill()}function d(b,g,x="black",w=1){n.lineWidth=w*e,n.strokeStyle=x,n.beginPath(),n.moveTo(b.x*e,b.y*e),n.lineTo(g.x*e,g.y*e),n.stroke()}function u(b){b.forEach(g=>{const x=g.distanceToObstacle*255,w=g.distanceToObstacle===0?"black":"rgb(255,"+x+","+x+")";h(g,w,0,!0)})}function f(b){b.forEach(g=>{const x=new ye(g.x,g.y);c(x,"green",.5,.5)})}function p(b){b.forEach((g,x)=>{const w=new ye(g.x,g.y);if(x>0){const C=new ye(b[x-1].x,b[x-1].y);d(C,w,"blue",1)}c(w,"blue",1,1)})}this.render=function(b,g,x){n.clearRect(0,0,r*e,t*e),u(b),f(g),p(x)};const m=function(b){const g=[];function x(){return g.at(-1)}function w(){return g.at(-1).end-g.at(-1).start}this.start=function(){const C=performance.now(),M={start:C,end:C,delta:0};g.push(M)},this.end=function(){const C=performance.now();x()!==void 0&&(x().end=C,x().delta=w())},this.stats=function(){const C=x().delta,M=g.reduce(($,Z)=>$.delta<Z.delta?$:Z).delta,D=g.reduce(($,Z)=>$.delta>Z.delta?$:Z).delta,z=l(g,"delta")/g.length;return{name:b,last:a(C),best:a(M),worst:a(D),average:a(z)}}};this.timeStart=function(b){s[b]===void 0&&(s[b]=new m(b)),s[b].start()},this.timeEnd=function(b){s[b]!==void 0&&s[b].end()},this.logTime=function(){const b=[];Object.values(s).forEach(x=>{b.push(x.stats())});const g={name:"TOTAL",last:a(l(b,"last")),best:a(l(b,"best")),worst:a(l(b,"worst")),average:a(l(b,"average"))};b.push(g),console.table(b)}};function jh(r,t){r&&r.timeStart(t)}function Xh(r,t){r&&r.timeEnd(t)}const $v=function(r="score"){const t=[];function e(n){const s=t[n];for(;n>0;){const a=Math.floor((n-1)/2),l=t[a];if(s[r]<=l[r])t[a]=s,t[n]=l,n=a;else break}}function i(n){const s=t[n];for(;;){const a=2*n+1,l=2*n+2;let c,h,d=null;if(a<t.length&&(c=t[a],s[r]>c[r]&&(d=a)),l<t.length&&(h=t[l],(d===null&&s[r]>h[r]||d!==null&&c[r]>h[r])&&(d=l)),d!==null)t[n]=t[d],t[d]=s,n=d;else break}}this.extract=function(){const n=t[0],s=t.pop();return t.length>0&&(t[0]=s,i(0)),n},this.insert=function(n){t.push(n),e(t.length-1)},this.update=function(n){const s=t.indexOf(n);if(s===0)return;const a=Math.floor((s-1)/2);n[r]<t[a]?e(s):i(s)},this.size=function(){return t.length}},Zv=function(r,t,e,i){this.id=r,this.x=t,this.y=e,this.distanceToObstacle=i,this.parent=null,this.score=0};Zv.prototype={distanceTo:function(r){return Math.sqrt(Math.pow(this.x-r.x,2)+Math.pow(this.y-r.y,2))},distanceMeasured:function(){return this.distanceToObstacle!==void 0},isObstacle:function(){return this.distanceToObstacle===0},visited:function(){return this.parent!==null},visit:function(r,t){this.parent=r,this.score=t}};const mM=function(r,t,e,i){const n=[-1,1,-t,t],s=r.canvasRange,a=r.collisionRange,l=[];function c(d){const u=new $v("distanceToObstacle");for(let f=0;f<=d.data.length;f+=4){const p=d.data[f-1]===255,m=Math.floor(f/(t*4)),b=f/4-m*t,g=p?0:void 0,x=new Zv(f/4,b,m,g);l.push(x),p&&u.insert(x)}for(;u.size()>0;){const f=u.extract();n.forEach(p=>{const m=f.id+p;f.distanceToObstacle<1&&l[m]!==void 0&&l[m].distanceMeasured()===!1&&(l[m].distanceToObstacle=Math.min(1,f.distanceToObstacle+1/i),u.insert(l[m]))})}}c(r.collisionImageData);function h(d,u){if(d.x!==0&&d.x!==t-1)return!0;const f=d.x+u.x!==1,p=d.x+u.x!==t-2;return!f&&!p}this.forEachNeighbour=function(d,u){const f=d.x+d.y*t;n.forEach(p=>{l[f+p]!==void 0&&h(d,l[f+p])&&u(l[f+p])})},this.hasObstacleAt=function(d,u){const f=Math.round(d)+Math.round(u)*t;return l[f].isObstacle()},this.getNodeAtScenePosition=function(d){const u=Math.round(ki(d.position.x,a.x.min,a.x.max,s.x.min,s.x.max)),f=Math.round(ki(d.position.y,a.y.min,a.y.max,s.y.min,s.y.max)),p=u+f*t;return l[p]},this.getScenePointFromNode=function(d){const u=ki(d.x,s.x.min,s.x.max,a.x.min,a.x.max),f=ki(d.y,s.y.min,s.y.max,a.y.min,a.y.max);return new ye(u,f)},this.resetNodeMap=function(){l.forEach(d=>{d.parent=null,d.score=0})},this.getNodeMap=function(){return l}};function _M(r,t){let e=null,i=null;const n=200,s=7,{width:a,height:l}=t.calculateRenderSize(n,r.collisionBoundingBox),c=T.DEBUG_CAMERA_PATH?new pM(a,l):null;function h(g){const x=g.position.z.toFixed(4);if(x!==e){const w={outlineThickness:2,outlineColor:new _e(0,0,0),slicePlaneHeight:g.position.z},C=t.getCollisionData(w,a,l);i=new mM(C,a,l,s),e=x}else i.resetNodeMap()}function d(g,x){const w=i.getNodeAtScenePosition(g),C=i.getNodeAtScenePosition(x);if(!w||!C)return[];const M=new $v;M.insert(w);const D=[];for(;M.size()>0;){const W=M.extract();if(W===C){for(let z=W;z;z=z.parent)z&&D.push(z);D.reverse();break}i.forEachNeighbour(W,z=>{if(z.isObstacle())return;const $=z.distanceToObstacle?z.distanceToObstacle:1,Z=W.score+1/$,ne=z.visited()||z===w;(!ne||Z<z.score)&&(z.visit(W,Z),ne?M.update(z):M.insert(z))})}return D}function u(g,x){const w=Math.abs(g.y-x.y)>Math.abs(g.x-x.x),C=g.x<x.x?g:x,M=g.x<x.x?x:g,D=g.y<x.y?g:x,W=g.y<x.y?x:g,z=C.x===M.x?null:(M.y-C.y)/(M.x-C.x),$=z===null?C.x:C.y-z*C.x;if(w)for(let Z=D.y;Z<=W.y;Z+=.2){const ne=z===null?D.x:(Z-$)/z;if(i.hasObstacleAt(ne,Z))return!0}else for(let Z=C.x;Z<=M.x;Z+=.2){const ne=z===null?C.y:z*Z+$;if(i.hasObstacleAt(Z,ne))return!0}return!1}function f(g,x){for(let w=g+1;w<x.length;w++)if(u(x[g],x[w]))return w;return-1}function p(g,x,w,C){const M=f(g,x);if(M===-1)w.push(x.at(-1));else{const D=M-g,W=D>C?M-C:M-Math.floor(D/2);w.push(x[W]),p(W,x,w,C)}}function m(g){const x=[g[0]];return p(0,g,x,5),x}function b(g,x,w){const C=[];C.push(new ye(x.position.x,x.position.y));for(let M=1;M<g.length-1;M++)C.push(i.getScenePointFromNode(g[M]));return C.push(new ye(w.position.x,w.position.y)),C}this.findPath=function(g,x){jh(c,"Graph"),h(x),Xh(c,"Graph"),jh(c,"Raw path");const w=d(g,x);Xh(c,"Raw path");const C=[],M=[];return w.length>=2&&(jh(c,"Refine path"),C.push(...m(w)),Xh(c,"Refine path"),jh(c,"Calculate points"),M.push(...b(C,g,x)),Xh(c,"Calculate points")),c&&(c.render(i.getNodeMap(),w,C),c.logTime()),M}}const{abs:ql,cos:Cr,sin:Va,acos:gM,atan2:Yl,sqrt:oo,pow:fs}=Math;function Ql(r){return r<0?-fs(-r,1/3):fs(r,1/3)}const Jv=Math.PI,qh=2*Jv,ao=Jv/2,vM=1e-6,Hf=Number.MAX_SAFE_INTEGER||9007199254740991,Wf=Number.MIN_SAFE_INTEGER||-9007199254740991,bM={x:0,y:0,z:0},we={Tvalues:[-.06405689286260563,.06405689286260563,-.1911188674736163,.1911188674736163,-.3150426796961634,.3150426796961634,-.4337935076260451,.4337935076260451,-.5454214713888396,.5454214713888396,-.6480936519369755,.6480936519369755,-.7401241915785544,.7401241915785544,-.820001985973903,.820001985973903,-.8864155270044011,.8864155270044011,-.9382745520027328,.9382745520027328,-.9747285559713095,.9747285559713095,-.9951872199970213,.9951872199970213],Cvalues:[.12793819534675216,.12793819534675216,.1258374563468283,.1258374563468283,.12167047292780339,.12167047292780339,.1155056680537256,.1155056680537256,.10744427011596563,.10744427011596563,.09761865210411388,.09761865210411388,.08619016153195327,.08619016153195327,.0733464814110803,.0733464814110803,.05929858491543678,.05929858491543678,.04427743881741981,.04427743881741981,.028531388628933663,.028531388628933663,.0123412297999872,.0123412297999872],arcfn:function(r,t){const e=t(r);let i=e.x*e.x+e.y*e.y;return typeof e.z!="undefined"&&(i+=e.z*e.z),oo(i)},compute:function(r,t,e){if(r===0)return t[0].t=0,t[0];const i=t.length-1;if(r===1)return t[i].t=1,t[i];const n=1-r;let s=t;if(i===0)return t[0].t=r,t[0];if(i===1){const l={x:n*s[0].x+r*s[1].x,y:n*s[0].y+r*s[1].y,t:r};return e&&(l.z=n*s[0].z+r*s[1].z),l}if(i<4){let l=n*n,c=r*r,h,d,u,f=0;i===2?(s=[s[0],s[1],s[2],bM],h=l,d=n*r*2,u=c):i===3&&(h=l*n,d=l*r*3,u=n*c*3,f=r*c);const p={x:h*s[0].x+d*s[1].x+u*s[2].x+f*s[3].x,y:h*s[0].y+d*s[1].y+u*s[2].y+f*s[3].y,t:r};return e&&(p.z=h*s[0].z+d*s[1].z+u*s[2].z+f*s[3].z),p}const a=JSON.parse(JSON.stringify(t));for(;a.length>1;){for(let l=0;l<a.length-1;l++)a[l]={x:a[l].x+(a[l+1].x-a[l].x)*r,y:a[l].y+(a[l+1].y-a[l].y)*r},typeof a[l].z!="undefined"&&(a[l]=a[l].z+(a[l+1].z-a[l].z)*r);a.splice(a.length-1,1)}return a[0].t=r,a[0]},computeWithRatios:function(r,t,e,i){const n=1-r,s=e,a=t;let l=s[0],c=s[1],h=s[2],d=s[3],u;if(l*=n,c*=r,a.length===2)return u=l+c,{x:(l*a[0].x+c*a[1].x)/u,y:(l*a[0].y+c*a[1].y)/u,z:i?(l*a[0].z+c*a[1].z)/u:!1,t:r};if(l*=n,c*=2*n,h*=r*r,a.length===3)return u=l+c+h,{x:(l*a[0].x+c*a[1].x+h*a[2].x)/u,y:(l*a[0].y+c*a[1].y+h*a[2].y)/u,z:i?(l*a[0].z+c*a[1].z+h*a[2].z)/u:!1,t:r};if(l*=n,c*=1.5*n,h*=3*n,d*=r*r*r,a.length===4)return u=l+c+h+d,{x:(l*a[0].x+c*a[1].x+h*a[2].x+d*a[3].x)/u,y:(l*a[0].y+c*a[1].y+h*a[2].y+d*a[3].y)/u,z:i?(l*a[0].z+c*a[1].z+h*a[2].z+d*a[3].z)/u:!1,t:r}},derive:function(r,t){const e=[];for(let i=r,n=i.length,s=n-1;n>1;n--,s--){const a=[];for(let l=0,c;l<s;l++)c={x:s*(i[l+1].x-i[l].x),y:s*(i[l+1].y-i[l].y)},t&&(c.z=s*(i[l+1].z-i[l].z)),a.push(c);e.push(a),i=a}return e},between:function(r,t,e){return t<=r&&r<=e||we.approximately(r,t)||we.approximately(r,e)},approximately:function(r,t,e){return ql(r-t)<=(e||vM)},length:function(r){const e=we.Tvalues.length;let i=0;for(let n=0,s;n<e;n++)s=.5*we.Tvalues[n]+.5,i+=we.Cvalues[n]*we.arcfn(s,r);return .5*i},map:function(r,t,e,i,n){const s=e-t,a=n-i,l=r-t,c=l/s;return i+a*c},lerp:function(r,t,e){const i={x:t.x+r*(e.x-t.x),y:t.y+r*(e.y-t.y)};return t.z!==void 0&&e.z!==void 0&&(i.z=t.z+r*(e.z-t.z)),i},pointToString:function(r){let t=r.x+"/"+r.y;return typeof r.z!="undefined"&&(t+="/"+r.z),t},pointsToString:function(r){return"["+r.map(we.pointToString).join(", ")+"]"},copy:function(r){return JSON.parse(JSON.stringify(r))},angle:function(r,t,e){const i=t.x-r.x,n=t.y-r.y,s=e.x-r.x,a=e.y-r.y,l=i*a-n*s,c=i*s+n*a;return Yl(l,c)},round:function(r,t){const e=""+r,i=e.indexOf(".");return parseFloat(e.substring(0,i+1+t))},dist:function(r,t){const e=r.x-t.x,i=r.y-t.y;return oo(e*e+i*i)},closest:function(r,t){let e=fs(2,63),i,n;return r.forEach(function(s,a){n=we.dist(t,s),n<e&&(e=n,i=a)}),{mdist:e,mpos:i}},abcratio:function(r,t){if(t!==2&&t!==3)return!1;if(typeof r=="undefined")r=.5;else if(r===0||r===1)return r;const e=fs(r,t)+fs(1-r,t),i=e-1;return ql(i/e)},projectionratio:function(r,t){if(t!==2&&t!==3)return!1;if(typeof r=="undefined")r=.5;else if(r===0||r===1)return r;const e=fs(1-r,t),i=fs(r,t)+e;return e/i},lli8:function(r,t,e,i,n,s,a,l){const c=(r*i-t*e)*(n-a)-(r-e)*(n*l-s*a),h=(r*i-t*e)*(s-l)-(t-i)*(n*l-s*a),d=(r-e)*(s-l)-(t-i)*(n-a);return d==0?!1:{x:c/d,y:h/d}},lli4:function(r,t,e,i){const n=r.x,s=r.y,a=t.x,l=t.y,c=e.x,h=e.y,d=i.x,u=i.y;return we.lli8(n,s,a,l,c,h,d,u)},lli:function(r,t){return we.lli4(r,r.c,t,t.c)},makeline:function(r,t){return new hi(r.x,r.y,(r.x+t.x)/2,(r.y+t.y)/2,t.x,t.y)},findbbox:function(r){let t=Hf,e=Hf,i=Wf,n=Wf;return r.forEach(function(s){const a=s.bbox();t>a.x.min&&(t=a.x.min),e>a.y.min&&(e=a.y.min),i<a.x.max&&(i=a.x.max),n<a.y.max&&(n=a.y.max)}),{x:{min:t,mid:(t+i)/2,max:i,size:i-t},y:{min:e,mid:(e+n)/2,max:n,size:n-e}}},shapeintersections:function(r,t,e,i,n){if(!we.bboxoverlap(t,i))return[];const s=[],a=[r.startcap,r.forward,r.back,r.endcap],l=[e.startcap,e.forward,e.back,e.endcap];return a.forEach(function(c){c.virtual||l.forEach(function(h){if(h.virtual)return;const d=c.intersects(h,n);d.length>0&&(d.c1=c,d.c2=h,d.s1=r,d.s2=e,s.push(d))})}),s},makeshape:function(r,t,e){const i=t.points.length,n=r.points.length,s=we.makeline(t.points[i-1],r.points[0]),a=we.makeline(r.points[n-1],t.points[0]),l={startcap:s,forward:r,back:t,endcap:a,bbox:we.findbbox([s,r,t,a])};return l.intersections=function(c){return we.shapeintersections(l,l.bbox,c,c.bbox,e)},l},getminmax:function(r,t,e){if(!e)return{min:0,max:0};let i=Hf,n=Wf,s,a;e.indexOf(0)===-1&&(e=[0].concat(e)),e.indexOf(1)===-1&&e.push(1);for(let l=0,c=e.length;l<c;l++)s=e[l],a=r.get(s),a[t]<i&&(i=a[t]),a[t]>n&&(n=a[t]);return{min:i,mid:(i+n)/2,max:n,size:n-i}},align:function(r,t){const e=t.p1.x,i=t.p1.y,n=-Yl(t.p2.y-i,t.p2.x-e),s=function(a){return{x:(a.x-e)*Cr(n)-(a.y-i)*Va(n),y:(a.x-e)*Va(n)+(a.y-i)*Cr(n)}};return r.map(s)},roots:function(r,t){t=t||{p1:{x:0,y:0},p2:{x:1,y:0}};const e=r.length-1,i=we.align(r,t),n=function(z){return 0<=z&&z<=1};if(e===2){const z=i[0].y,$=i[1].y,Z=i[2].y,ne=z-2*$+Z;if(ne!==0){const Me=-oo($*$-z*Z),Xe=-z+$,xe=-(Me+Xe)/ne,Le=-(-Me+Xe)/ne;return[xe,Le].filter(n)}else if($!==Z&&ne===0)return[(2*$-Z)/(2*$-2*Z)].filter(n);return[]}const s=i[0].y,a=i[1].y,l=i[2].y,c=i[3].y;let h=-s+3*a-3*l+c,d=3*s-6*a+3*l,u=-3*s+3*a,f=s;if(we.approximately(h,0)){if(we.approximately(d,0))return we.approximately(u,0)?[]:[-f/u].filter(n);const z=oo(u*u-4*d*f),$=2*d;return[(z-u)/$,(-u-z)/$].filter(n)}d/=h,u/=h,f/=h;const p=(3*u-d*d)/3,m=p/3,b=(2*d*d*d-9*d*u+27*f)/27,g=b/2,x=g*g+m*m*m;let w,C,M,D,W;if(x<0){const z=-p/3,$=z*z*z,Z=oo($),ne=-b/(2*Z),Me=ne<-1?-1:ne>1?1:ne,Xe=gM(Me),xe=Ql(Z),Le=2*xe;return M=Le*Cr(Xe/3)-d/3,D=Le*Cr((Xe+qh)/3)-d/3,W=Le*Cr((Xe+2*qh)/3)-d/3,[M,D,W].filter(n)}else{if(x===0)return w=g<0?Ql(-g):-Ql(g),M=2*w-d/3,D=-w-d/3,[M,D].filter(n);{const z=oo(x);return w=Ql(-g+z),C=Ql(g+z),[w-C-d/3].filter(n)}}},droots:function(r){if(r.length===3){const t=r[0],e=r[1],i=r[2],n=t-2*e+i;if(n!==0){const s=-oo(e*e-t*i),a=-t+e,l=-(s+a)/n,c=-(-s+a)/n;return[l,c]}else if(e!==i&&n===0)return[(2*e-i)/(2*(e-i))];return[]}if(r.length===2){const t=r[0],e=r[1];return t!==e?[t/(t-e)]:[]}return[]},curvature:function(r,t,e,i,n){let s,a,l,c,h=0,d=0;const u=we.compute(r,t),f=we.compute(r,e),p=u.x*u.x+u.y*u.y;if(i?(s=oo(fs(u.y*f.z-f.y*u.z,2)+fs(u.z*f.x-f.z*u.x,2)+fs(u.x*f.y-f.x*u.y,2)),a=fs(p+u.z*u.z,3/2)):(s=u.x*f.y-u.y*f.x,a=fs(p,3/2)),s===0||a===0)return{k:0,r:0};if(h=s/a,d=a/s,!n){const m=we.curvature(r-.001,t,e,i,!0).k,b=we.curvature(r+.001,t,e,i,!0).k;c=(b-h+(h-m))/2,l=(ql(b-h)+ql(h-m))/2}return{k:h,r:d,dk:c,adk:l}},inflections:function(r){if(r.length<4)return[];const t=we.align(r,{p1:r[0],p2:r.slice(-1)[0]}),e=t[2].x*t[1].y,i=t[3].x*t[1].y,n=t[1].x*t[2].y,s=t[3].x*t[2].y,a=18*(-3*e+2*i+3*n-s),l=18*(3*e-i-3*n),c=18*(n-e);if(we.approximately(a,0)){if(!we.approximately(l,0)){let f=-c/l;if(0<=f&&f<=1)return[f]}return[]}const h=l*l-4*a*c,d=Math.sqrt(h),u=2*a;return we.approximately(u,0)?[]:[(d-l)/u,-(l+d)/u].filter(function(f){return 0<=f&&f<=1})},bboxoverlap:function(r,t){const e=["x","y"],i=e.length;for(let n=0,s,a,l,c;n<i;n++)if(s=e[n],a=r[s].mid,l=t[s].mid,c=(r[s].size+t[s].size)/2,ql(a-l)>=c)return!1;return!0},expandbox:function(r,t){t.x.min<r.x.min&&(r.x.min=t.x.min),t.y.min<r.y.min&&(r.y.min=t.y.min),t.z&&t.z.min<r.z.min&&(r.z.min=t.z.min),t.x.max>r.x.max&&(r.x.max=t.x.max),t.y.max>r.y.max&&(r.y.max=t.y.max),t.z&&t.z.max>r.z.max&&(r.z.max=t.z.max),r.x.mid=(r.x.min+r.x.max)/2,r.y.mid=(r.y.min+r.y.max)/2,r.z&&(r.z.mid=(r.z.min+r.z.max)/2),r.x.size=r.x.max-r.x.min,r.y.size=r.y.max-r.y.min,r.z&&(r.z.size=r.z.max-r.z.min)},pairiteration:function(r,t,e){const i=r.bbox(),n=t.bbox(),s=1e5,a=e||.5;if(i.x.size+i.y.size<a&&n.x.size+n.y.size<a)return[(s*(r._t1+r._t2)/2|0)/s+"/"+(s*(t._t1+t._t2)/2|0)/s];let l=r.split(.5),c=t.split(.5),h=[{left:l.left,right:c.left},{left:l.left,right:c.right},{left:l.right,right:c.right},{left:l.right,right:c.left}];h=h.filter(function(u){return we.bboxoverlap(u.left.bbox(),u.right.bbox())});let d=[];return h.length===0||(h.forEach(function(u){d=d.concat(we.pairiteration(u.left,u.right,a))}),d=d.filter(function(u,f){return d.indexOf(u)===f})),d},getccenter:function(r,t,e){const i=t.x-r.x,n=t.y-r.y,s=e.x-t.x,a=e.y-t.y,l=i*Cr(ao)-n*Va(ao),c=i*Va(ao)+n*Cr(ao),h=s*Cr(ao)-a*Va(ao),d=s*Va(ao)+a*Cr(ao),u=(r.x+t.x)/2,f=(r.y+t.y)/2,p=(t.x+e.x)/2,m=(t.y+e.y)/2,b=u+l,g=f+c,x=p+h,w=m+d,C=we.lli8(u,f,b,g,p,m,x,w),M=we.dist(C,r);let D=Yl(r.y-C.y,r.x-C.x),W=Yl(t.y-C.y,t.x-C.x),z=Yl(e.y-C.y,e.x-C.x),$;return D<z?((D>W||W>z)&&(D+=qh),D>z&&($=z,z=D,D=$)):z<W&&W<D?($=z,z=D,D=$):z+=qh,C.s=D,C.e=z,C.r=M,C},numberSort:function(r,t){return r-t}};class Kl{constructor(t){this.curves=[],this._3d=!1,t&&(this.curves=t,this._3d=this.curves[0]._3d)}valueOf(){return this.toString()}toString(){return"["+this.curves.map(function(t){return we.pointsToString(t.points)}).join(", ")+"]"}addCurve(t){this.curves.push(t),this._3d=this._3d||t._3d}length(){return this.curves.map(function(t){return t.length()}).reduce(function(t,e){return t+e})}curve(t){return this.curves[t]}bbox(){const t=this.curves;for(var e=t[0].bbox(),i=1;i<t.length;i++)we.expandbox(e,t[i].bbox());return e}offset(t){const e=[];return this.curves.forEach(function(i){e.push(...i.offset(t))}),new Kl(e)}}const{abs:$l,min:e0,max:t0,cos:yM,sin:xM,acos:EM,sqrt:Zl}=Math,AM=Math.PI;class hi{constructor(t){let e=t&&t.forEach?t:Array.from(arguments).slice(),i=!1;if(typeof e[0]=="object"){i=e.length;const p=[];e.forEach(function(m){["x","y","z"].forEach(function(b){typeof m[b]!="undefined"&&p.push(m[b])})}),e=p}let n=!1;const s=e.length;if(i){if(i>4){if(arguments.length!==1)throw new Error("Only new Bezier(point[]) is accepted for 4th and higher order curves");n=!0}}else if(s!==6&&s!==8&&s!==9&&s!==12&&arguments.length!==1)throw new Error("Only new Bezier(point[]) is accepted for 4th and higher order curves");const a=this._3d=!n&&(s===9||s===12)||t&&t[0]&&typeof t[0].z!="undefined",l=this.points=[];for(let p=0,m=a?3:2;p<s;p+=m){var c={x:e[p],y:e[p+1]};a&&(c.z=e[p+2]),l.push(c)}const h=this.order=l.length-1,d=this.dims=["x","y"];a&&d.push("z"),this.dimlen=d.length;const u=we.align(l,{p1:l[0],p2:l[h]}),f=we.dist(l[0],l[h]);this._linear=u.reduce((p,m)=>p+$l(m.y),0)<f/50,this._lut=[],this._t1=0,this._t2=1,this.update()}static quadraticFromPoints(t,e,i,n){if(typeof n=="undefined"&&(n=.5),n===0)return new hi(e,e,i);if(n===1)return new hi(t,e,e);const s=hi.getABC(2,t,e,i,n);return new hi(t,s.A,i)}static cubicFromPoints(t,e,i,n,s){typeof n=="undefined"&&(n=.5);const a=hi.getABC(3,t,e,i,n);typeof s=="undefined"&&(s=we.dist(e,a.C));const l=s*(1-n)/n,c=we.dist(t,i),h=(i.x-t.x)/c,d=(i.y-t.y)/c,u=s*h,f=s*d,p=l*h,m=l*d,b={x:e.x-u,y:e.y-f},g={x:e.x+p,y:e.y+m},x=a.A,w={x:x.x+(b.x-x.x)/(1-n),y:x.y+(b.y-x.y)/(1-n)},C={x:x.x+(g.x-x.x)/n,y:x.y+(g.y-x.y)/n},M={x:t.x+(w.x-t.x)/n,y:t.y+(w.y-t.y)/n},D={x:i.x+(C.x-i.x)/(1-n),y:i.y+(C.y-i.y)/(1-n)};return new hi(t,M,D,i)}static getUtils(){return we}getUtils(){return hi.getUtils()}static get PolyBezier(){return Kl}valueOf(){return this.toString()}toString(){return we.pointsToString(this.points)}toSVG(){if(this._3d)return!1;const t=this.points,e=t[0].x,i=t[0].y,n=["M",e,i,this.order===2?"Q":"C"];for(let s=1,a=t.length;s<a;s++)n.push(t[s].x),n.push(t[s].y);return n.join(" ")}setRatios(t){if(t.length!==this.points.length)throw new Error("incorrect number of ratio values");this.ratios=t,this._lut=[]}verify(){const t=this.coordDigest();t!==this._print&&(this._print=t,this.update())}coordDigest(){return this.points.map(function(t,e){return""+e+t.x+t.y+(t.z?t.z:0)}).join("")}update(){this._lut=[],this.dpoints=we.derive(this.points,this._3d),this.computedirection()}computedirection(){const t=this.points,e=we.angle(t[0],t[this.order],t[1]);this.clockwise=e>0}length(){return we.length(this.derivative.bind(this))}static getABC(t=2,e,i,n,s=.5){const a=we.projectionratio(s,t),l=1-a,c={x:a*e.x+l*n.x,y:a*e.y+l*n.y},h=we.abcratio(s,t);return{A:{x:i.x+(i.x-c.x)/h,y:i.y+(i.y-c.y)/h},B:i,C:c,S:e,E:n}}getABC(t,e){e=e||this.get(t);let i=this.points[0],n=this.points[this.order];return hi.getABC(this.order,i,e,n,t)}getLUT(t){if(this.verify(),t=t||100,this._lut.length===t)return this._lut;this._lut=[],t++,this._lut=[];for(let e=0,i,n;e<t;e++)n=e/(t-1),i=this.compute(n),i.t=n,this._lut.push(i);return this._lut}on(t,e){e=e||5;let i;const n=this.getLUT(),s=[];for(let a=0,l,c=0;a<n.length;a++)l=n[a],we.dist(l,t)<e&&(s.push(l),c+=a/n.length);return s.length?i/=s.length:!1}project(t){const e=this.getLUT(),i=e.length-1,n=we.closest(e,t),s=n.mpos,a=(s-1)/i,l=(s+1)/i,c=.1/i;let h=n.mdist,d=a,u=d,f;h+=1;for(let p;d<l+c;d+=c)f=this.compute(d),p=we.dist(t,f),p<h&&(h=p,u=d);return u=u<0?0:u>1?1:u,f=this.compute(u),f.t=u,f.d=h,f}get(t){return this.compute(t)}point(t){return this.points[t]}compute(t){return this.ratios?we.computeWithRatios(t,this.points,this.ratios,this._3d):we.compute(t,this.points,this._3d,this.ratios)}raise(){const t=this.points,e=[t[0]],i=t.length;for(let n=1,s,a;n<i;n++)s=t[n],a=t[n-1],e[n]={x:(i-n)/i*s.x+n/i*a.x,y:(i-n)/i*s.y+n/i*a.y};return e[i]=t[i-1],new hi(e)}derivative(t){return we.compute(t,this.dpoints[0],this._3d)}dderivative(t){return we.compute(t,this.dpoints[1],this._3d)}align(){let t=this.points;return new hi(we.align(t,{p1:t[0],p2:t[t.length-1]}))}curvature(t){return we.curvature(t,this.dpoints[0],this.dpoints[1],this._3d)}inflections(){return we.inflections(this.points)}normal(t){return this._3d?this.__normal3(t):this.__normal2(t)}__normal2(t){const e=this.derivative(t),i=Zl(e.x*e.x+e.y*e.y);return{x:-e.y/i,y:e.x/i}}__normal3(t){const e=this.derivative(t),i=this.derivative(t+.01),n=Zl(e.x*e.x+e.y*e.y+e.z*e.z),s=Zl(i.x*i.x+i.y*i.y+i.z*i.z);e.x/=n,e.y/=n,e.z/=n,i.x/=s,i.y/=s,i.z/=s;const a={x:i.y*e.z-i.z*e.y,y:i.z*e.x-i.x*e.z,z:i.x*e.y-i.y*e.x},l=Zl(a.x*a.x+a.y*a.y+a.z*a.z);a.x/=l,a.y/=l,a.z/=l;const c=[a.x*a.x,a.x*a.y-a.z,a.x*a.z+a.y,a.x*a.y+a.z,a.y*a.y,a.y*a.z-a.x,a.x*a.z-a.y,a.y*a.z+a.x,a.z*a.z];return{x:c[0]*e.x+c[1]*e.y+c[2]*e.z,y:c[3]*e.x+c[4]*e.y+c[5]*e.z,z:c[6]*e.x+c[7]*e.y+c[8]*e.z}}hull(t){let e=this.points,i=[],n=[],s=0;for(n[s++]=e[0],n[s++]=e[1],n[s++]=e[2],this.order===3&&(n[s++]=e[3]);e.length>1;){i=[];for(let a=0,l,c=e.length-1;a<c;a++)l=we.lerp(t,e[a],e[a+1]),n[s++]=l,i.push(l);e=i}return n}split(t,e){if(t===0&&e)return this.split(e).left;if(e===1)return this.split(t).right;const i=this.hull(t),n={left:this.order===2?new hi([i[0],i[3],i[5]]):new hi([i[0],i[4],i[7],i[9]]),right:this.order===2?new hi([i[5],i[4],i[2]]):new hi([i[9],i[8],i[6],i[3]]),span:i};return n.left._t1=we.map(0,0,1,this._t1,this._t2),n.left._t2=we.map(t,0,1,this._t1,this._t2),n.right._t1=we.map(t,0,1,this._t1,this._t2),n.right._t2=we.map(1,0,1,this._t1,this._t2),e?(e=we.map(e,t,1,0,1),n.right.split(e).left):n}extrema(){const t={};let e=[];return this.dims.forEach(function(i){let n=function(a){return a[i]},s=this.dpoints[0].map(n);t[i]=we.droots(s),this.order===3&&(s=this.dpoints[1].map(n),t[i]=t[i].concat(we.droots(s))),t[i]=t[i].filter(function(a){return a>=0&&a<=1}),e=e.concat(t[i].sort(we.numberSort))}.bind(this)),t.values=e.sort(we.numberSort).filter(function(i,n){return e.indexOf(i)===n}),t}bbox(){const t=this.extrema(),e={};return this.dims.forEach(function(i){e[i]=we.getminmax(this,i,t[i])}.bind(this)),e}overlaps(t){const e=this.bbox(),i=t.bbox();return we.bboxoverlap(e,i)}offset(t,e){if(typeof e!="undefined"){const i=this.get(t),n=this.normal(t),s={c:i,n,x:i.x+n.x*e,y:i.y+n.y*e};return this._3d&&(s.z=i.z+n.z*e),s}if(this._linear){const i=this.normal(0),n=this.points.map(function(s){const a={x:s.x+t*i.x,y:s.y+t*i.y};return s.z&&i.z&&(a.z=s.z+t*i.z),a});return[new hi(n)]}return this.reduce().map(function(i){return i._linear?i.offset(t)[0]:i.scale(t)})}simple(){if(this.order===3){const n=we.angle(this.points[0],this.points[3],this.points[1]),s=we.angle(this.points[0],this.points[3],this.points[2]);if(n>0&&s<0||n<0&&s>0)return!1}const t=this.normal(0),e=this.normal(1);let i=t.x*e.x+t.y*e.y;return this._3d&&(i+=t.z*e.z),$l(EM(i))<AM/3}reduce(){let t,e=0,i=0,n=.01,s,a=[],l=[],c=this.extrema().values;for(c.indexOf(0)===-1&&(c=[0].concat(c)),c.indexOf(1)===-1&&c.push(1),e=c[0],t=1;t<c.length;t++)i=c[t],s=this.split(e,i),s._t1=e,s._t2=i,a.push(s),e=i;return a.forEach(function(h){for(e=0,i=0;i<=1;)for(i=e+n;i<=1+n;i+=n)if(s=h.split(e,i),!s.simple()){if(i-=n,$l(e-i)<n)return[];s=h.split(e,i),s._t1=we.map(e,0,1,h._t1,h._t2),s._t2=we.map(i,0,1,h._t1,h._t2),l.push(s),e=i;break}e<1&&(s=h.split(e,1),s._t1=we.map(e,0,1,h._t1,h._t2),s._t2=h._t2,l.push(s))}),l}translate(t,e,i){i=typeof i=="number"?i:e;const n=this.order;let s=this.points.map((a,l)=>(1-l/n)*e+l/n*i);return new hi(this.points.map((a,l)=>({x:a.x+t.x*s[l],y:a.y+t.y*s[l]})))}scale(t){const e=this.order;let i=!1;if(typeof t=="function"&&(i=t),i&&e===2)return this.raise().scale(i);const n=this.clockwise,s=this.points;if(this._linear)return this.translate(this.normal(0),i?i(0):t,i?i(1):t);const a=i?i(0):t,l=i?i(1):t,c=[this.offset(0,10),this.offset(1,10)],h=[],d=we.lli4(c[0],c[0].c,c[1],c[1].c);if(!d)throw new Error("cannot scale this curve. Try reducing it first.");return[0,1].forEach(function(u){const f=h[u*e]=we.copy(s[u*e]);f.x+=(u?l:a)*c[u].n.x,f.y+=(u?l:a)*c[u].n.y}),i?([0,1].forEach(function(u){if(!(e===2&&u)){var f=s[u+1],p={x:f.x-d.x,y:f.y-d.y},m=i?i((u+1)/e):t;i&&!n&&(m=-m);var b=Zl(p.x*p.x+p.y*p.y);p.x/=b,p.y/=b,h[u+1]={x:f.x+m*p.x,y:f.y+m*p.y}}}),new hi(h)):([0,1].forEach(u=>{if(e===2&&u)return;const f=h[u*e],p=this.derivative(u),m={x:f.x+p.x,y:f.y+p.y};h[u+1]=we.lli4(f,m,d,s[u+1])}),new hi(h))}outline(t,e,i,n){if(e=e===void 0?t:e,this._linear){const D=this.normal(0),W=this.points[0],z=this.points[this.points.length-1];let $,Z,ne;i===void 0&&(i=t,n=e),$={x:W.x+D.x*t,y:W.y+D.y*t},ne={x:z.x+D.x*i,y:z.y+D.y*i},Z={x:($.x+ne.x)/2,y:($.y+ne.y)/2};const Me=[$,Z,ne];$={x:W.x-D.x*e,y:W.y-D.y*e},ne={x:z.x-D.x*n,y:z.y-D.y*n},Z={x:($.x+ne.x)/2,y:($.y+ne.y)/2};const Xe=[ne,Z,$],xe=we.makeline(Xe[2],Me[0]),Le=we.makeline(Me[2],Xe[0]),B=[xe,new hi(Me),Le,new hi(Xe)];return new Kl(B)}const s=this.reduce(),a=s.length,l=[];let c=[],h,d=0,u=this.length();const f=typeof i!="undefined"&&typeof n!="undefined";function p(D,W,z,$,Z){return function(ne){const Me=$/z,Xe=($+Z)/z,xe=W-D;return we.map(ne,0,1,D+Me*xe,D+Xe*xe)}}s.forEach(function(D){const W=D.length();f?(l.push(D.scale(p(t,i,u,d,W))),c.push(D.scale(p(-e,-n,u,d,W)))):(l.push(D.scale(t)),c.push(D.scale(-e))),d+=W}),c=c.map(function(D){return h=D.points,h[3]?D.points=[h[3],h[2],h[1],h[0]]:D.points=[h[2],h[1],h[0]],D}).reverse();const m=l[0].points[0],b=l[a-1].points[l[a-1].points.length-1],g=c[a-1].points[c[a-1].points.length-1],x=c[0].points[0],w=we.makeline(g,m),C=we.makeline(b,x),M=[w].concat(l).concat([C]).concat(c);return new Kl(M)}outlineshapes(t,e,i){e=e||t;const n=this.outline(t,e).curves,s=[];for(let a=1,l=n.length;a<l/2;a++){const c=we.makeshape(n[a],n[l-a],i);c.startcap.virtual=a>1,c.endcap.virtual=a<l/2-1,s.push(c)}return s}intersects(t,e){return t?t.p1&&t.p2?this.lineIntersects(t):(t instanceof hi&&(t=t.reduce()),this.curveintersects(this.reduce(),t,e)):this.selfintersects(e)}lineIntersects(t){const e=e0(t.p1.x,t.p2.x),i=e0(t.p1.y,t.p2.y),n=t0(t.p1.x,t.p2.x),s=t0(t.p1.y,t.p2.y);return we.roots(this.points,t).filter(a=>{var l=this.get(a);return we.between(l.x,e,n)&&we.between(l.y,i,s)})}selfintersects(t){const e=this.reduce(),i=e.length-2,n=[];for(let s=0,a,l,c;s<i;s++)l=e.slice(s,s+1),c=e.slice(s+2),a=this.curveintersects(l,c,t),n.push(...a);return n}curveintersects(t,e,i){const n=[];t.forEach(function(a){e.forEach(function(l){a.overlaps(l)&&n.push({left:a,right:l})})});let s=[];return n.forEach(function(a){const l=we.pairiteration(a.left,a.right,i);l.length>0&&(s=s.concat(l))}),s}arcs(t){return t=t||.5,this._iterate(t,[])}_error(t,e,i,n){const s=(n-i)/4,a=this.get(i+s),l=this.get(n-s),c=we.dist(t,e),h=we.dist(t,a),d=we.dist(t,l);return $l(h-c)+$l(d-c)}_iterate(t,e){let i=0,n=1,s;do{s=0,n=1;let a=this.get(i),l,c,h,d,u=!1,f=!1,p,m=n,b=1;do if(f=u,d=h,m=(i+n)/2,l=this.get(m),c=this.get(n),h=we.getccenter(a,l,c),h.interval={start:i,end:n},u=this._error(h,a,i,n)<=t,p=f&&!u,p||(b=n),u){if(n>=1){if(h.interval.end=b=1,d=h,n>1){let x={x:h.x+h.r*yM(h.e),y:h.y+h.r*xM(h.e)};h.e+=we.angle({x:h.x,y:h.y},x,this.get(1))}break}n=n+(n-i)/2}else n=m;while(!p&&s++<100);if(s>=100)break;d=d||h,e.push(d),i=b}while(n<1);return e}}const TM=2,wM=6,Jl=Math.PI/3,SM=1,MM=2*T.CAMERA_DEFAULT_MOVE_MAX_SPEED,Yh=2,i0=3,jf=5,Xf=5,n0=.25,s0=.35,Is=r=>-(Math.cos(Math.PI*r)-1)/2,PM=r=>Math.sqrt(1-Math.pow(r-1,2)),CM=r=>Math.pow(r,5),RM=r=>1-Math.pow(1-r,5);class qf{constructor(t){o(this,"distance");o(this,"velocity");o(this,"time");this.distance=t,this.velocity=0,this.time=0}setVelocityFromCornerAngle(t){this.velocity=ki(Math.max(Jl,t),Jl,Math.PI,SM,MM)}}class r0{constructor(t,e,i){o(this,"_startKnot");o(this,"_endKnot");o(this,"_acceleration");this._startKnot=t,this._endKnot=e,this._acceleration=i}endTime(){return this._endKnot.time}getDistance(t){const e=t-this._startKnot.time,i=this._startKnot.velocity*e,n=.5*this._acceleration*Math.pow(e,2),s=i+n;return this._startKnot.distance+s}isTimeWithinEquation(t){return t>=this._startKnot.time&&t<=this._endKnot.time}}class IM{constructor(t,e,i,n,s,a){o(this,"_startKnot");o(this,"_endKnot");o(this,"_maxVelocity");o(this,"_accelerationTime");o(this,"_accelerationDistance");o(this,"_acceleration");this._startKnot=t,this._endKnot=e,this._maxVelocity=i,this._accelerationTime=n,this._accelerationDistance=s,this._acceleration=a}endTime(){return this._endKnot.time}getDistance(t){const e=t-this._startKnot.time;if(e<this._accelerationTime){const i=this._startKnot.velocity*e,n=.5*this._acceleration*Math.pow(e,2),s=i+n;return this._startKnot.distance+s}else{const i=this._maxVelocity*(e-this._accelerationTime),n=.5*this._acceleration*Math.pow(e-this._accelerationTime,2),s=i-n;return this._startKnot.distance+this._accelerationDistance+s}}isTimeWithinEquation(t){return t>=this._startKnot.time&&t<=this._endKnot.time}}class Yf{constructor(t,e,i){o(this,"_endDistance");o(this,"_startDistance");o(this,"_bezier");this._startDistance=t,this._endDistance=e,this._bezier=i}getEndDistance(){return this._endDistance}getPoint(t){const e=ki(t,this._startDistance,this._endDistance,0,1);return this._bezier.get(e)}getRotation(t){const e=ki(t,this._startDistance,this._endDistance,0,1),i=this._bezier.normal(e);return Math.atan2(i.y,i.x)-Math.PI}isDistanceWithinCurve(t){return t>=this._startDistance&&t<=this._endDistance}}const DM=(r,t,e)=>{const i=r.velocity,n=t.velocity,s=t.distance-r.distance,a=Math.sqrt(.5*Math.pow(i,2)+.5*Math.pow(n,2)+s*e);if(a>i&&a>n){const l=.5*(Math.pow(a,2)-Math.pow(i,2))/e,c=.5*(Math.pow(a,2)-Math.pow(n,2))/e;console.assert(Math.abs(s-l-c)<.001);const h=(a-i)/e,d=(a-n)/e;return t.time=r.time+h+d,new IM(r,t,a,h,l,e)}else if(a<=n){const l=Math.sqrt(Math.pow(i,2)+2*s*e),c=.5*(Math.pow(l,2)-Math.pow(i,2))/e;return console.assert(Math.abs(s-c)<.001),t.time=r.time+(l-i)/e,t.velocity=l,new r0(r,t,e)}else{const l=2*s/(i+n),c=i*l+.5*(n-i)*l;console.assert(Math.abs(s-c)<.001);const h=(n-i)/l;return t.time=r.time+l,new r0(r,t,h)}},LM=function(){const r=new ye,t=new ye;return function(e,i,n){return r.subVectors(i,e),t.subVectors(n,i),Math.asin(ye.crossVectors(r,t)/(r.length()*t.length()))}}();function OM(r){return ki(Math.max(Jl,r),Jl,Math.PI,TM,wM)}const Qf=r=>new ye(r.x,r.y),o0=(r,t)=>new hi([r,r.clone().lerp(t,1/3),r.clone().lerp(t,2/3),t]),FM=(r,t,e,i)=>{const n=t.distanceTo(r),s=t.distanceTo(e),a=Math.min(s,n),l=a/n,c=a/s,h=i/a<.5?i/a:.5,d=t.clone().lerp(r,h*l),u=t.clone().lerp(r,h/3*l),f=t.clone().lerp(e,h/3*c),p=t.clone().lerp(e,h*c);return new hi([d,u,f,p])},BM=(r,t)=>{const e=Zt(t.x-r.x),i=Zt(t.y-r.y),n=Math.max(Math.abs(e),Math.abs(i)),s=PM(n/Math.PI);return ki(s,0,1,0,Yh)};class a0{constructor(t,e,i,n,s){o(this,"_camera");o(this,"_controls");o(this,"_start");o(this,"_destination");o(this,"_transition");o(this,"_time");o(this,"_totalTime");o(this,"_totalDistance");o(this,"_timeMultiplier");o(this,"_currentPlanarCurve");o(this,"_currentPlanarDistanceEquation");o(this,"_getPlanarPosition");o(this,"_getHeight");o(this,"_getYaw");o(this,"_getPitch");o(this,"_getFov");o(this,"_modifyProjectionMatrix");o(this,"_planarCurves");o(this,"_planarDistanceEquations");o(this,"_isPositivePlanarDistance");if(this._camera=t,this._controls=e,this._start=i,this._destination=n,this._transition=s,this._time=0,this._totalTime=BM(this._start.rotation,this._destination.rotation),this._totalDistance=0,this._timeMultiplier=1,this._currentPlanarCurve=void 0,this._currentPlanarDistanceEquation=void 0,this._getPlanarPosition=void 0,this._getHeight=void 0,this._getYaw=void 0,this._getPitch=void 0,this._getFov=void 0,this._modifyProjectionMatrix=void 0,this._planarCurves=[],this._planarDistanceEquations=[],this._isPositivePlanarDistance=this._nonZeroPlanarDistanceToDestination(),this._isPositivePlanarDistance&&this._initPlanarMovement(),this._transition.usePath&&this._isPositivePlanarDistance?(this._initPathRotation(),this._initPathHeight()):(this._initLinearRotation(),this._destination.height!==void 0&&(!this._isPositivePlanarDistance&&this._nonZeroHeightDistanceToDestination()&&this._adjustTimeForHeightOnlyMovement(),this._initLinearHeight())),this._destination.fov!==void 0&&(this._getFov=function(l){const c=Is(l/this._totalTime);return ki(c,0,1,this._start.fov,this._destination.fov)}),this._start.projectionMatrix!==void 0&&this._destination.projectionMatrix!==void 0&&this._doMatricesDiffer(this._start.projectionMatrix,this._destination.projectionMatrix)){const c=(()=>this._camera.isOrthographic()&&!this._destination.orthographic?CM:!this._camera.isOrthographic()&&this._destination.orthographic?RM:h=>h)();T.DEV_NEW_RENDER_ARCHITECTURE&&pt.get().updateEntityStateById(this._camera.entityId,Sr,{endOrtographic:this._destination.orthographic,orthoFrustumSize:this._destination.orthoFrustumSize}),this._modifyProjectionMatrix=function(h){const d=c(h/this._totalTime);for(let u=0;u<16;u++)this._camera.current.projectionMatrix.elements[u]=ki(d,0,1,this._start.projectionMatrix.elements[u],this._destination.projectionMatrix.elements[u]);T.DEV_NEW_RENDER_ARCHITECTURE&&pt.get().updateEntityStateById(this._camera.entityId,Sr,{alpha:d})},this._totalTime<Yh&&this._adjustTimeForProjectionChange()}}get _startHeight(){return this._start.height||this._controls.cameraWorldPosition().z}get _destinationHeight(){return this._destination.height||this._controls.cameraWorldPosition().z}_clampTotalTime(t){return Math.max(Yh,Math.min(t,this._transition.maxTime))}_calculateTimeMultiplier(){const t=this._planarDistanceEquations.at(-1);return t!==void 0?t.endTime()/this._totalTime:1}_calculateTimeForHeightOnlyDistance(t){const e=Math.sqrt(t/this._transition.acceleration);return this._clampTotalTime(e)}_adjustTimeForHeightOnlyMovement(){this._totalDistance=Math.abs(this._destinationHeight-this._startHeight),this._totalTime=this._calculateTimeForHeightOnlyDistance(this._totalDistance)}_getPlanarCurveByDistance(t){return this._planarCurves.find(i=>i.isDistanceWithinCurve(t))}_initPlanarMovement(){const t=[];for(let u=1;u<this._transition.points.length-1;u++){const f=this._transition.points[u-1],p=this._transition.points[u],m=this._transition.points[u+1],b=LM(f,p,m),g=OM(b),x=FM(f,p,m,g);t.push({bezier:x,angle:b})}const e=[];e.push(new qf(0));let i=this._transition.points[0],n=0;for(let u=0;u<t.length;u++){const f=t[u-1],p=t[u],m=t[u+1];f!==void 0&&(i=Qf(f.bezier.points[3]));const b=Qf(p.bezier.points[0]),g=o0(i,b);if(g.length()>0){const W=n,z=n+g.length(),$=new Yf(W,z,g);this._planarCurves.push($),n+=g.length()}const x=p.bezier.length()/2,w=n,C=n+x*2,M=new Yf(w,C,p.bezier);this._planarCurves.push(M),n+=x;const D=Math.abs(p.angle);if(D>Jl){const W=new qf(n);W.setVelocityFromCornerAngle(D),e.push(W)}n+=x,m===void 0&&(i=Qf(p.bezier.points[3]))}const s=this._transition.points.at(-1),a=o0(i,s),l=n+a.length(),c=new Yf(n,l,a);this._planarCurves.push(c),n+=a.length(),e.push(new qf(n));for(let u=1;u<e.length;u++){const f=e[u-1],p=e[u],m=DM(f,p,this._transition.acceleration);this._planarDistanceEquations.push(m)}this._getPlanarPosition=function(u){var f;return(f=this._currentPlanarCurve)==null?void 0:f.getPoint(u)},this._currentPlanarCurve=this._planarCurves[0],this._currentPlanarDistanceEquation=this._planarDistanceEquations[0],this._totalDistance=n;const h=this._planarDistanceEquations.at(-1),d=h!==void 0?h.endTime():0;this._totalTime=this._clampTotalTime(d),this._timeMultiplier=this._calculateTimeMultiplier()}_initPathRotation(){if(this._totalDistance>jf){const t=jf*n0,e=this._getPlanarCurveByDistance(t),i=Zt(e.getRotation(t)-this._start.rotation.x),n=this._totalDistance-jf*(1-n0),s=this._getPlanarCurveByDistance(n),a=Zt(this._destination.rotation.x-s.getRotation(n));this._getYaw=function(l){if(l<t){const c=Is(l/t);return this._start.rotation.x+c*i}else if(l>n){const c=l-n,h=this._totalDistance-n,d=1-Is(c/h);return this._destination.rotation.x-d*a}else return this._currentPlanarCurve?this._currentPlanarCurve.getRotation(l):0}}else{const t=Zt(this._destination.rotation.x-this._start.rotation.x);this._getYaw=function(e){const i=Is(e/this._totalDistance);return this._start.rotation.x+i*t}}if(this._totalDistance>Xf){const t=Xf*s0,e=Zt(0-this._start.rotation.y),i=this._totalDistance-Xf*(1-s0),n=Zt(this._destination.rotation.y);this._getPitch=function(s){if(s<t){const a=Is(s/t);return this._start.rotation.y+a*e}else if(s>i){const a=s-i,l=this._totalDistance-i;return Is(a/l)*n}else return 0}}else{const t=Zt(this._destination.rotation.y-this._start.rotation.y);this._getPitch=function(e){const i=Is(e/this._totalDistance);return this._start.rotation.y+i*t}}}_initLinearRotation(){const t=Zt(this._destination.rotation.x-this._start.rotation.x);this._getYaw=function(i){return this._start.rotation.x+Is(i/this._totalTime)*t};const e=Zt(this._destination.rotation.y-this._start.rotation.y);this._getPitch=function(i){return this._start.rotation.y+Is(i/this._totalTime)*e}}_initPathHeight(){const t=this._totalDistance>i0?i0:this._totalDistance;this._getHeight=function(e){if(e<t){const i=Is(e/t);return ki(i,0,1,this._startHeight,this._destinationHeight)}else return this._destinationHeight}}_initLinearHeight(){this._getHeight=function(t){const e=Is(t/this._totalTime);return ki(e,0,1,this._startHeight,this._destinationHeight)}}_nonZeroPlanarDistanceToDestination(){const t=this._transition.points[0],e=this._transition.points.at(-1)||t;return t.distanceTo(e)>.001}_nonZeroHeightDistanceToDestination(){return Math.abs(this._destinationHeight-this._startHeight)>.001}_doMatricesDiffer(t,e){return t.elements.some((i,n)=>i!==e.elements[n])}_adjustTimeForProjectionChange(){this._totalTime=Yh}_getDistance(){const t=this._time*this._timeMultiplier,e=this._currentPlanarDistanceEquation;if(e===void 0)throw new Error("currentEquation is null");return t>e.endTime()&&(this._currentPlanarDistanceEquation=this._planarDistanceEquations.find(i=>i.isTimeWithinEquation(t))),e.getDistance(t)}_updateCurrentPlanarCurve(t){const e=this._currentPlanarCurve;if(e===void 0)throw new Error("currentPlanarCurve is undefined");t>e.getEndDistance()&&(this._currentPlanarCurve=this._getPlanarCurveByDistance(t))}update(t,e){if(this._time+=t,this._time>=this._totalTime)return T.DEV_NEW_RENDER_ARCHITECTURE&&pt.get().hasComponent(this._camera.entityId,Sr)&&pt.get().updateEntityStateById(this._camera.entityId,Sr,{alpha:1,transitionFinished:!0}),!1;let i;if(this._transition.usePath&&this._isPositivePlanarDistance?(i=this._getDistance(),this._updateCurrentPlanarCurve(i)):i=this._time,this._getPlanarPosition){const n=this._getPlanarPosition(this._getDistance());if(n===void 0)throw new Error("planar is undefined");e.setX(n.x),e.setY(n.y)}if(this._getHeight){const n=this._getHeight(i);e.setZ(n)}return this._getFov&&(this._camera.fov=this._getFov(this._time),this._camera.updateProjectionMatrix()),this._modifyProjectionMatrix&&this._modifyProjectionMatrix(this._time),this._getYaw&&this._controls.setYawAngle(this._getYaw(i)),this._getPitch&&this._controls.setPitchAngle(this._getPitch(i)),this._controls.cameraPositionUpdated(),!0}}/*!
 * Copyright (C) 2014-present Shapespark
 */const Kf=1/180;class NM{constructor(t){o(this,"_scene");o(this,"_activeSkyMesh");this._scene=t,this._activeSkyMesh=void 0}activateSky(t){if(this._activeSkyMesh){if(this._activeSkyMesh.name===t)return;this._scene.removeAuxiliaryObject(this._activeSkyMesh)}const e=this._scene.findSkyMesh(t),i=e.material.map;i&&!i.loaded?(this.activateSky(T.DEFAULT_SKY_NAME),this._activeSkyMesh=e,i.addLoadedListener(()=>{this._activeSkyMesh===e&&(this._scene.addAuxiliaryObject(e),e.updateMatrixWorld(!0))})):(this._scene.addAuxiliaryObject(e),e.updateMatrixWorld(!0),this._activeSkyMesh=e)}activeSkyName(){return this._activeSkyMesh.name}}class l0{constructor(t,e,i){o(this,"position");o(this,"rotation");o(this,"fov");this.position=t||new L,this.rotation=e||new ye,this.fov=i||0}}var c0=(r=>(r.TELEPORT_STARTED="teleportStarted",r.TELEPORT_DONE="teleportDone",r))(c0||{});const ia=class ia extends ci{constructor(e,i,n,s,a){super();o(this,"_scene");o(this,"_controls");o(this,"_animationController");o(this,"_skyControls");o(this,"_cameraPosition");o(this,"_camera");o(this,"_meshesToHide",{});o(this,"_meshesHiddenByTeleport",new Array);o(this,"_cameraPath");o(this,"_teleportMovement");o(this,"_destination",new l0);o(this,"_destinationTarget",new L);o(this,"_destinationMinDistance");o(this,"_destinationMaxDistance");o(this,"_viewToEnable");o(this,"_vrEnabled",!1);o(this,"teleportingToView",!1);o(this,"teleportingToPoint",!1);o(this,"_instant",!1);o(this,"_useCameraHeightInViews",!1);o(this,"_lastVisibleDestinationView");o(this,"lastDestinationView");o(this,"collider");o(this,"_initMeshesToHide",()=>{this._meshesToHide=[];for(const e of this._scene.views)this._meshesToHide[e.id]=[];for(const e of this._scene.gpuMeshes){const i=e.hideInViews;if(i)for(const n of i)this._meshesToHide[n]?this._meshesToHide[n].push(e):console.warn("Invalid view id in hideInViews list: '"+n+"'")}});o(this,"_skyMeshAdded",e=>{this._skyControls.activateSky(e.skyMesh.name),this._animationController.requestFrame()});o(this,"_skyMeshRemoved",e=>{this._skyControls.activeSkyName()===e.skyMesh.name&&(this._skyControls.activateSky(T.DEFAULT_SKY_NAME),this._animationController.requestFrame())});this._scene=e,this._controls=i,this.collider=a,this._animationController=n,this._skyControls=new NM(e),this._cameraPosition=i.cameraWorldPosition(),this._camera=e.camera,this._cameraPath=new _M(e,s),this._initMeshesToHide(),this._scene.addEventListener(Hi.eventType.VIEW_ADDED,this._initMeshesToHide),this._scene.addEventListener(Hi.eventType.VIEW_REMOVED,this._initMeshesToHide),this._scene.addEventListener(Hi.eventType.SKY_MESH_ADDED,this._skyMeshAdded),this._scene.addEventListener(Hi.eventType.SKY_MESH_REMOVED,this._skyMeshRemoved)}_cameraVector(){const e=new l0(this._controls.cameraWorldPosition());return e.rotation.set(Zt(this._controls.getYawAngle()),Zt(this._controls.getPitchAngle())),e.fov=this._camera.fov,e}teleporting(){return this.teleportingToView||this.teleportingToPoint}_getMeshesToHide(e){return this._meshesToHide[e]||[]}_hideMeshes(e){for(const i of e)i.visible=!1,this._meshesHiddenByTeleport.push(i);this.collider&&this.collider.updateMeshVisibility(e)}_showMeshesHiddenByTeleport(){this._meshesHiddenByTeleport.forEach(e=>e.visible=!0),this.collider&&this.collider.updateMeshVisibility(this._meshesHiddenByTeleport),this._meshesHiddenByTeleport.length=0}_hideOnlyMeshes(e){this._showMeshesHiddenByTeleport(),this._hideMeshes(e)}_placeCameraAtDestination(){this._camera.fov=this._destination.fov,this._cameraPosition.copyFrom(this._destination.position),this._controls.setYawAngle(this._destination.rotation.x),this._controls.setPitchAngle(this._destination.rotation.y),this._controls.cameraPositionUpdated(),this._teleportMovement=void 0}_adjustHeightIfNeeded(e){if((this._useCameraHeightInViews||T.CAMERA_FIXED_HEIGHT!==null||this._camera.autoClimb&&this._camera.fixedHeight!==null)&&this.collider!==void 0){this._viewToEnable;const i=this._meshesHiddenByTeleport.slice();this._hideOnlyMeshes(this._getMeshesToHide(this._viewToEnable.id)),this.collider.adjustPointToMatchCameraHeight(e),this._hideOnlyMeshes(i)}}_planarPointsLinear(){return[new ye(this._cameraVector().position.x,this._cameraVector().position.y),new ye(this._destination.position.x,this._destination.position.y)]}_shouldUsePathTransition(e){const i=e.mode!=="orbit",n=this.lastDestinationView?this.lastDestinationView.mode!=="orbit":!0;return this._camera.autoPath&&i&&n}_onReachedToView(){if(this._viewToEnable.mode==="orbit"&&!this._vrEnabled)this._controls.orbit.setPanPrimary(this._viewToEnable.panPrimary||!1),this._controls.orbit.noRotate=this._viewToEnable.noRotate||!1,this._controls.orbit.noPitchRotate=this._viewToEnable.noPitchRotate||!1,this._controls.orbit.getNoPan=()=>this._viewToEnable.noPan,this._controls.orbit.getMinPitchAngle=()=>-this._viewToEnable.maxUpAngle,this._controls.orbit.getMaxPitchAngle=()=>-this._viewToEnable.minUpAngle,this._controls.orbit.getMinYawAngle=()=>this._viewToEnable.minSideAngle,this._controls.orbit.getMaxYawAngle=()=>this._viewToEnable.maxSideAngle,this._controls.orbit.getMinDistance=()=>this._viewToEnable.minDistance,this._controls.orbit.getMaxDistance=()=>this._viewToEnable.maxDistance,this._controls.orbit.target.copyFrom(this._destinationTarget),this._controls.setControlMode(du.ORBIT);else{const e=this._controls.camera();e.near=T.CAMERA_WALK_NEAR,this._controls.setControlMode(du.WALK)}this._viewToEnable.orthographic?(this._camera.orthoFrustumSize=this._viewToEnable.orthoFrustumSize,this._camera.setOrthographic()):this._camera.setPerspective(),this._skyControls.activateSky(this._viewToEnable.sky),this._hideOnlyMeshes(this._getMeshesToHide(this._viewToEnable.id))}update(e){if(!this.teleporting())return;e=Math.min(e,.067),e=Math.max(e,Kf);let i=!0;this._teleportMovement!==void 0&&(this.teleportingToPoint&&(this._destination.position.z=this._cameraPosition.z),this._teleportMovement.update(e,this._cameraPosition)?i=!1:this._placeCameraAtDestination()),i&&(this.teleportingToView&&this._onReachedToView(),this.teleportingToView=this.teleportingToPoint=!1,this.dispatchEvent({view:this._viewToEnable,type:ia.eventType.TELEPORT_DONE})),this._animationController.requestFrame()}cancelSwitchToPoint(){this.teleportingToPoint,this.teleportingToPoint=!1,this.dispatchEvent({view:void 0,type:ia.eventType.TELEPORT_DONE})}_pointEqualsCameraPositionXY(e){return e.x===this._cameraPosition.x&&e.y===this._cameraPosition.y}_rotationEqualsCameraRotation(e){return Zt(e.yaw)===this._cameraVector().rotation.x&&Zt(e.pitch)===this._cameraVector().rotation.y}switchToPoint(e,i){if(!(this._pointEqualsCameraPositionXY(e)&&(i===void 0||this._rotationEqualsCameraRotation(i)))){if(this._viewToEnable=void 0,this.teleportingToPoint=!0,this.teleportingToView=!1,this.dispatchEvent({view:void 0,type:ia.eventType.TELEPORT_STARTED}),this._instant?this._destination.position.set(e.x,e.y,e.z):this._destination.position.set(e.x,e.y,this._cameraPosition.z),i)this._destination.rotation.set(Zt(i.yaw),Zt(i.pitch));else{const n=wp(this._cameraPosition,e),s=Zt(n);this._destination.rotation.set(s,0)}if(this._destination.fov=this._camera.defaultFov,this._instant)this._placeCameraAtDestination(),this.update(Kf);else{const n={fov:this._camera.fov,height:this._cameraVector().position.z,rotation:this._cameraVector().rotation},s={fov:this._destination.fov,rotation:this._destination.rotation},a={acceleration:T.TELEPORT_TO_POINT_ACCELERATION,maxTime:T.TELEPORT_TO_POINT_MAX_TIME,points:this._planarPointsLinear(),usePath:!1};this._teleportMovement=new a0(this._camera,this._controls,n,s,a),this._animationController.requestFrame()}}}switchToView(e,i){const n=this._shouldUsePathTransition(e);e.hideFromMenu||(this._lastVisibleDestinationView=e),this.lastDestinationView=this._viewToEnable=e,this.teleportingToView=!0,this.teleportingToPoint=!1,this.dispatchEvent({view:this._viewToEnable,type:ia.eventType.TELEPORT_STARTED}),this._controls.disable(),this._controls.resetRollAngle(),this._hideMeshes(this._getMeshesToHide(this._viewToEnable.id));const s=this._camera.current.projectionMatrix.clone(),a=this._camera.createProjectionMatrix(this._viewToEnable.orthographic,this._viewToEnable.orthoFrustumSize);if(this._viewToEnable.rotation!==void 0?this._destination.rotation.set(this._viewToEnable.rotation.yaw,this._viewToEnable.rotation.pitch):this._destination.rotation.set(0,0),this._destination.fov=this._viewToEnable.fov||this._camera.defaultFov,this._viewToEnable.mode==="orbit"){this._viewToEnable.target!==void 0?this._destinationTarget.set(this._viewToEnable.target.x,this._viewToEnable.target.y,this._viewToEnable.target.z):this._destinationTarget.set(0,0,0),this._destinationMinDistance=this._viewToEnable.minDistance,this._destinationMaxDistance=this._viewToEnable.maxDistance;const l=Yi(this._viewToEnable.distance||10,this._destinationMinDistance,this._destinationMaxDistance);Aa.computeCameraPosition(this._destination.position,this._destinationTarget,this._destination.rotation.x,this._destination.rotation.y,l),this._camera.near=Aa.computeCameraNear(l),this._camera.updateProjectionMatrix()}else this._viewToEnable.position!==void 0?(this._destination.position.set(this._viewToEnable.position.x,this._viewToEnable.position.y,this._viewToEnable.position.z),this._adjustHeightIfNeeded(this._destination.position)):this._destination.position.set(0,0,0);if(i===void 0&&T.TELEPORT_TO_VIEW_MAX_TIME===0||i===0||this._instant)this._placeCameraAtDestination(),this.update(Kf);else{this._viewToEnable.sky!==this._skyControls.activeSkyName()&&this._skyControls.activateSky(T.DEFAULT_SKY_NAME);const l=n?this._cameraPath.findPath(this._cameraVector(),this._destination):[],c=l.length>0,h=n&&c,d=h?l:this._planarPointsLinear(),u=h?T.TELEPORT_PATH_ACCELERATION:T.TELEPORT_TO_VIEW_ACCELERATION;if(i===void 0&&(i=h?T.TELEPORT_PATH_MAX_TIME:T.TELEPORT_TO_VIEW_MAX_TIME),this._viewToEnable.rotation===void 0){const b=d.at(-1),g=d.at(-2),x=wp(g,b),w=Zt(x);this._destination.rotation.set(w,0)}const f={fov:this._camera.fov,height:this._cameraVector().position.z,rotation:this._cameraVector().rotation,projectionMatrix:s},p={fov:this._destination.fov,height:this._destination.position.z,rotation:this._destination.rotation,projectionMatrix:a,orthographic:this._viewToEnable.orthographic,orthoFrustumSize:this._viewToEnable.orthoFrustumSize},m={acceleration:u,maxTime:i,points:d,usePath:h};this._teleportMovement=new a0(this._camera,this._controls,f,p,m),this._animationController.requestFrame()}}_switchToAdjacentVisibleView(e,i){const n=this._scene.visibleViews();if(n.length===0)return;if(this._lastVisibleDestinationView===void 0){this.switchToView(n[0],i);return}const s=n.indexOf(this._lastVisibleDestinationView);s===-1&&this.switchToView(n[0],i);const a=(s+n.length+e)%n.length;this.switchToView(n[a],i)}switchToPreviousVisibleView(e){this._switchToAdjacentVisibleView(-1,e)}switchToNextVisibleView(e){this._switchToAdjacentVisibleView(1,e)}updateHiddenMeshes(e){this._initMeshesToHide(),e?this._hideOnlyMeshes(this._getMeshesToHide(e.id)):this._showMeshesHiddenByTeleport(),this._animationController.requestFrame()}activateSky(e){this._skyControls.activateSky(e.sky),this._animationController.requestFrame()}executeWithViewVisibilitySettings(e,i){const n=this._meshesHiddenByTeleport.slice();this._hideOnlyMeshes(this._getMeshesToHide(e.id)),this._skyControls.activateSky(e.sky),i(),this._skyControls.activateSky(this.lastDestinationView.sky),this._hideOnlyMeshes(n)}onVrChange(e){this._vrEnabled=e,this._instant=this._vrEnabled,this._useCameraHeightInViews=this._vrEnabled,this.lastDestinationView&&this.lastDestinationView.mode==="orbit"&&this.switchToView(this.lastDestinationView,0)}};o(ia,"eventType",c0);let ps=ia;class ec{constructor(t,e,i,n,s,a){o(this,"editor");o(this,"controller");o(this,"property");o(this,"elements");o(this,"values");o(this,"unmergable");this.editor=t,this.controller=e,this.property=i,this.elements=n,this.values=s,this.unmergable=a}isMergable(t){return this.unmergable||!(t instanceof ec)?!1:(console.assert(t instanceof ec),t.property===this.property&&Nc(t.elements,this.elements))}apply(){const t=[];for(let i=0;i<this.elements.length;i++){const n=this.elements[i];t.push(this.editor.getElementValue(this.property,n))}const e=[];for(let i=0;i<this.elements.length;i++){const n=this.elements[i],s=this.values[i],a=this.controller.createItemUpdater(n),l=this.editor.setElementValue(n,a,this.property,s);e.push(l)}return new ec(this.editor,this.controller,this.property,e,t,this.unmergable)}}class UM{constructor(){o(this,"_pastEntries",new Array);o(this,"_futureEntries",new Array)}editorHistoryEntry(t,e,i,n,s,a){return new ec(t,e,i,n,s,a)}addItem(t){this._futureEntries=[],!(this._pastEntries.length>0&&this._pastEntries.at(-1).isMergable(t))&&this._pastEntries.push(t)}isUndoable(){return this._pastEntries.length>0}undo(){console.assert(this.isUndoable());const t=this._pastEntries.pop();this._futureEntries.push(t.apply())}isRedoable(){return this._futureEntries.length>0}redo(){console.assert(this.isRedoable());const t=this._futureEntries.pop();this._pastEntries.push(t.apply())}}class kM{constructor(t,e){o(this,"_scene");o(this,"_animationController");o(this,"_selectedMesh");o(this,"_selectedMeshDispose");o(this,"_volumeGroup",new yt);o(this,"_material",Qd());o(this,"_hollowMaterial",Kd());this._scene=t,this._animationController=e,this._scene.addAuxiliaryObject(this._volumeGroup),this._volumeGroup.visible=!1}setHighlightedCameraVolumeTrigger(t){var a;(a=this._selectedMeshDispose)==null||a.call(this);const e=new je(t.getVolumeGeometry(),this._material),i=new je(t.getVolumeGeometry(),this._hollowMaterial);e.add(i),this._volumeGroup.add(e);const n=()=>{e.position.copyFrom(t.position),e.rotation.copyFrom(t.rotation),e.scale.copyFrom(t.scale),e.updateMatrixWorld(),this._animationController.requestFrame()},s=()=>{this.setControlsVisible(!1)};return n(),t.addEventListener(jn.eventType.UPDATED,n),t.addEventListener(jn.eventType.DISPOSED,s),this._selectedMeshDispose=()=>{this._selectedMesh&&this._volumeGroup.remove(this._selectedMesh),t.removeEventListener(jn.eventType.UPDATED,n),t.removeEventListener(jn.eventType.DISPOSED,s)},this._selectedMesh=e,e.material}setControlsVisible(t){this._volumeGroup.visible=t,this._animationController.requestFrame()}}/*!
 * Copyright (C) 2019-present Shapespark
 */function h0(r,t,e){const i=r.findSkyMesh(T.EDITOR_CONTROLLED_SKY_NAME);e.set(0,-i.radius,0),t.applyToVector3(e),e.add(i.position)}function VM(r,t){t.radius=0,r.visitSubtree(function(e){e.mesh&&os.union(e.mesh.geometry.boundingSphere,t)})}const d0=.4,zM=1.5;function GM(){const r=new tn,t=new Float32Array(8*4*3*3);r.addAttribute("position",new Dt(t,3));const e=d0,i=[[[-1,-1,-1],[-1,-1+e,-1],[-1+e,-1,-1]],[[-1,-1,-1],[-1,-1,-1+e],[-1,-1+e,-1]],[[-1,-1,-1],[-1+e,-1,-1],[-1,-1,-1+e]],[[-1+e,-1,-1],[-1,-1+e,-1],[-1,-1,-1+e]],[[-1,-1,1],[-1+e,-1,1],[-1,-1+e,1]],[[-1,-1,1],[-1,-1+e,1],[-1,-1,1-e]],[[-1,-1,1],[-1,-1,1-e],[-1+e,-1,1]],[[-1+e,-1,1],[-1,-1,1-e],[-1,-1+e,1]],[[1,-1,-1],[1-e,-1,-1],[1,-1+e,-1]],[[1,-1,-1],[1,-1+e,-1],[1,-1,-1+e]],[[1,-1,-1],[1,-1,-1+e],[1-e,-1,-1]],[[1-e,-1,-1],[1,-1,-1+e],[1,-1+e,-1]],[[-1,1,-1],[-1+e,1,-1],[-1,1-e,-1]],[[-1,1,-1],[-1,1-e,-1],[-1,1,-1+e]],[[-1,1,-1],[-1,1,-1+e],[-1+e,1,-1]],[[-1+e,1,-1],[-1,1,-1+e],[-1,1-e,-1]],[[1,1,1],[1-e,1,1],[1,1-e,1]],[[1,1,1],[1,1-e,1],[1,1,1-e]],[[1,1,1],[1,1,1-e],[1-e,1,1]],[[1-e,1,1],[1,1,1-e],[1,1-e,1]],[[1,-1,1],[1,-1+e,1],[1-e,-1,1]],[[1,-1,1],[1,-1,1-e],[1,-1+e,1]],[[1,-1,1],[1-e,-1,1],[1,-1,1-e]],[[1-e,-1,1],[1,-1+e,1],[1,-1,1-e]],[[1,1,-1],[1,1-e,-1],[1-e,1,-1]],[[1,1,-1],[1,1,-1+e],[1,1-e,-1]],[[1,1,-1],[1-e,1,-1],[1,1,-1+e]],[[1-e,1,-1],[1,1-e,-1],[1,1,-1+e]],[[-1,1,1],[-1,1-e,1],[-1+e,1,1]],[[-1,1,1],[-1,1,1-e],[-1,1-e,1]],[[-1,1,1],[-1+e,1,1],[-1,1,1-e]],[[-1+e,1,1],[-1,1-e,1],[-1,1,1-e]]];let n=0;return i.forEach(function(s){for(let a=0;a<3;a+=1)for(let l=0;l<3;l+=1)t[n]=s[a][l],n+=1}),r.computeVertexNormals(),r.convertNormalsToSpherical(),r}function HM(){const r=new Qt;return r.lightmapSupported=!1,r.reflective=!1,r.headLight=!0,r.baseColor=T.EDITOR_SELECTION_COLOR,r.setUniforms(),r}const gi=.01,ke=1-1.24*(d0/4);function WM(){const r=new tn,t=new Float32Array(12*8*3*3);r.addAttribute("position",new Dt(t,3));const e=new Array;function i(c,h){e.push([[c.x,c.y,c.z],[h.x,c.y,c.z],[c.x,h.y,c.z]]),e.push([[c.x,h.y,c.z],[h.x,c.y,c.z],[h.x,h.y,c.z]])}function n(c,h){e.push([[c.x,c.y,c.z],[c.x,h.y,c.z],[c.x,c.y,h.z]]),e.push([[c.x,c.y,h.z],[c.x,h.y,c.z],[c.x,h.y,h.z]])}function s(c,h){e.push([[c.x,c.y,c.z],[h.x,c.y,c.z],[c.x,c.y,h.z]]),e.push([[c.x,c.y,h.z],[h.x,c.y,c.z],[h.x,c.y,h.z]])}function a(c,h,d){const u={x:Math.min(c.x,h.x),y:Math.min(c.y,h.y),z:Math.min(c.z,h.z)},f={x:Math.max(c.x,h.x),y:Math.max(c.y,h.y),z:Math.max(c.z,h.z)};d!=="XY"&&(i(new L(f.x,u.y,u.z),new L(u.x,f.y,u.z)),i(new L(u.x,u.y,f.z),new L(f.x,f.y,f.z))),d!=="YZ"&&(n(new L(u.x,f.y,u.z),new L(u.x,u.y,f.z)),n(new L(f.x,u.y,u.z),new L(f.x,f.y,f.z))),d!=="XZ"&&(s(new L(f.x,f.y,u.z),new L(u.x,f.y,f.z)),s(new L(u.x,u.y,u.z),new L(f.x,u.y,f.z)))}a(new L(-ke,ke,ke),new L(ke,ke-gi,ke-gi),"YZ"),a(new L(-ke,ke,-ke+gi),new L(ke,ke-gi,-ke),"YZ"),a(new L(-ke,-ke,-ke),new L(ke,-ke+gi,-ke+gi),"YZ"),a(new L(-ke,-ke,ke),new L(ke,-ke+gi,ke-gi),"YZ"),a(new L(ke,ke,ke),new L(ke-gi,-ke,ke-gi),"XZ"),a(new L(ke,ke,-ke),new L(ke-gi,-ke,-ke+gi),"XZ"),a(new L(-ke,ke,-ke),new L(-ke+gi,-ke,-ke+gi),"XZ"),a(new L(-ke,ke,ke),new L(-ke+gi,-ke,ke-gi),"XZ"),a(new L(ke,ke,ke),new L(ke-gi,ke-gi,-ke),"XY"),a(new L(ke,-ke,ke),new L(ke-gi,-ke+gi,-ke),"XY"),a(new L(-ke,ke,ke),new L(-ke+gi,ke-gi,-ke),"XY"),a(new L(-ke,-ke,ke),new L(-ke+gi,-ke+gi,-ke),"XY");let l=0;return e.forEach(function(c){for(let h=0;h<3;h+=1)for(let d=0;d<3;d+=1)t[l]=c[h][d],l+=1}),r.computeVertexNormals(),r.convertNormalsToSpherical(),r}class jM{constructor(t,e){o(this,"_scene");o(this,"_animationController");o(this,"_lightsVisible",!1);o(this,"_geometryRotation",new Ue);o(this,"_geometryTranslation",new Ue);o(this,"_geometryTransform",new Ue);o(this,"_pointLightGeometry");o(this,"_areaLightGeometry");o(this,"_lightSelectionGeometry");o(this,"_lightSubSelectionGeometry");o(this,"_lightSelectionMaterial");o(this,"_lightUpdated");o(this,"_lightInstanceAdded");o(this,"_lightInstanceRemoved");o(this,"_lightAdded");o(this,"_lightRemoved");o(this,"selectedLightInstance");o(this,"subSelectedLightInstances",new Array);o(this,"lightInstanceMeshes",new Array);this._scene=t,this._animationController=e,this._pointLightGeometry=ft.createSphere(1,32,16),this._pointLightGeometry.convertNormalsToSpherical(),this._areaLightGeometry=ft.createPlane(1,1),this._geometryRotation.makeRotationX(-Math.PI/2),this._areaLightGeometry.applyMatrix(this._geometryRotation),this._areaLightGeometry.convertNormalsToSpherical(),this._lightSelectionGeometry=GM(),this._lightSubSelectionGeometry=WM(),this._lightSelectionMaterial=HM(),this._lightUpdated=i=>{this._updateLightInstanceMeshes(i.target)},this._lightInstanceAdded=i=>{const n=i.instance,s=n.light;let a;s.instances[0]!==n?a=this._getLightInstanceMesh(s.instances[0]).geometry:a=this._createLightGeometry(s),this._createLightInstanceMesh(s,n,a),this._animationController.requestFrame()},this._lightInstanceRemoved=i=>{this._updateLightInstanceMeshes(i.instance.light),this._animationController.requestFrame()},this._lightAdded=i=>{this._addLight(i.light),this._animationController.requestFrame()},this._lightRemoved=i=>{this._removeLightInstanceMeshes(i.light),this._animationController.requestFrame()},this._scene.lights.forEach(i=>this._addLight(i)),this._scene.addEventListener(Hi.eventType.LIGHT_ADDED,this._lightAdded),this._scene.addEventListener(Hi.eventType.LIGHT_REMOVED,this._lightRemoved)}_createLightGeometry(t){let e;if(t.type===Ln.SPOT){const i=Ai(t.angle),n=1,s=Math.cos(i/2)*n,a=Math.sin(i/2)*n;e=ft.createCylinder(0,a,s,32,1),this._geometryTranslation.makeTranslation(0,-s/2,0),this._geometryRotation.makeRotationZ(Math.PI),this._geometryTransform.multiplyMatrices(this._geometryRotation,this._geometryTranslation),e.applyMatrix(this._geometryTransform),e.convertNormalsToSpherical()}else t.type===Ln.AREA?e=this._areaLightGeometry:([Ln.POINT,Ln.SUN].includes(t.type),`${t.type}`,e=this._pointLightGeometry);return e}_createLightInstanceMesh(t,e,i){const n=new $d(t),s=new je(i,n);s.visibilityId=null;const a=new je(this._lightSelectionGeometry,this._lightSelectionMaterial);s.add(a);const l=new je(this._lightSubSelectionGeometry,this._lightSelectionMaterial);if(e!==this.selectedLightInstance&&!this.subSelectedLightInstances.includes(e)&&(l.visible=!1),s.add(l),t.type!==Ln.SUN){const c=e.rotation.toQuaternion().multiply(s.rotation.toQuaternion());if(s.setRotationFromQuaternion(c),s.position.copyFrom(e.position),t.type===Ln.AREA){n.side=Ti.DOUBLE,s.scale.set(t.width,1,t.height);const h=Math.max(t.width,t.height)/2;a.scale.set(h/t.width,h,h/t.height),l.scale.set(h/t.width,h,h/t.height)}else s.scale.set(t.size,t.size,t.size)}else{const c=this._scene.findSkyMesh(T.EDITOR_CONTROLLED_SKY_NAME).radius,h=.5*2*Math.PI*c*zM/360;h0(this._scene,e.rotation,s.position),s.scale.set(h,h,h)}s.userData.lightInstance=e,s.updateMatrixWorld(),this.lightInstanceMeshes.push(s),this._lightsVisible&&this._scene.addAuxiliaryObject(s)}_createLightInstanceMeshes(t){const e=this._createLightGeometry(t);t.forEachLightInstance(i=>this._createLightInstanceMesh(t,i,e))}_getLightInstanceMesh(t){return this.lightInstanceMeshes.find(e=>e.userData.lightInstance===t)}_removeLightInstanceMeshes(t){const e=i=>i.userData.lightInstance.light!==t;for(const i of this.lightInstanceMeshes)e(i)||(this._lightsVisible&&this._scene.removeAuxiliaryObject(i),i.geometry!==this._pointLightGeometry&&i.geometry!==this._areaLightGeometry&&i.geometry.dispose(),i.material.dispose());this.lightInstanceMeshes=this.lightInstanceMeshes.filter(e)}_updateLightInstanceMeshes(t){this._removeLightInstanceMeshes(t),this._createLightInstanceMeshes(t)}_addLight(t){this._createLightInstanceMeshes(t),t.addEventListener(On.eventType.UPDATED,this._lightUpdated),t.addEventListener(On.eventType.INSTANCE_ADDED,this._lightInstanceAdded),t.addEventListener(On.eventType.INSTANCE_REMOVED,this._lightInstanceRemoved)}getLightInstanceMaterial(t){var e;return(e=this._getLightInstanceMesh(t))==null?void 0:e.material}showLights(){this._lightsVisible||(this._lightsVisible=!0,this.lightInstanceMeshes.forEach(t=>this._scene.addAuxiliaryObject(t)))}showSelectionMesh(t,e){this.lightInstanceMeshes.forEach(function(i){i.children[0].visible=i.userData.lightInstance.light===t||e.includes(i.userData.lightInstance.light)})}showInstancesSelectionMesh(t,e){this.selectedLightInstance=t,this.subSelectedLightInstances=e,this.lightInstanceMeshes.forEach(function(i){i.children[1].visible=i.userData.lightInstance===t||e.includes(i.userData.lightInstance)})}hideLights(){this._lightsVisible&&(this._lightsVisible=!1,this.lightInstanceMeshes.forEach(t=>this._scene.removeAuxiliaryObject(t)))}}class XM{constructor(t,e){o(this,"_scene");o(this,"_animationController");o(this,"_lightProbesVisible",!1);o(this,"_visibleBoxMesh");o(this,"lightProbeMeshes",new Array);o(this,"_lightProbeGeometry",ft.createSphere(.2,32,16));o(this,"_boxMaterial",Qd());o(this,"_boxGeometry",ft.createBox(1,1,1));o(this,"_hollowBoxMaterial",Kd());o(this,"_lightProbeUpdated",t=>{const e=t.target,i=this._findLightProbeMeshIdx(e);if(i===-1)return;const n=this.lightProbeMeshes[i];n.position.copyFrom(e.position);const s=n.children[0];e.isBoundingBoxEnabled()?(this._setLightProbeBoxPosition(e,s),s.visible=!0):s.visible=!1,n.updateMatrixWorld()});o(this,"_lightProbeAdded",t=>{this._createLightProbeMesh(t.lightProbe)});o(this,"_lightProbeRemoved",t=>{this._removeLightProbeMesh(t.lightProbe)});this._scene=t,this._animationController=e,this._lightProbesVisible=!1,this._lightProbeGeometry.convertNormalsToSpherical(),this._boxGeometry.convertNormalsToSpherical(),this._init()}_setLightProbeBoxPosition(t,e){e.position.addVectors(t.boxMin,t.boxMax).multiplyScalar(.5).sub(t.position),e.scale.subVectors(t.boxMax,t.boxMin),e.scale.subScalar(.005)}_constructLightProbeMesh(){const t=new Qt;t.lightmapSupported=!1,t.hideFromLightProbes=!0,t.disableLightProbe=!1,t.highlight=T.EDITOR_SELECTION_COLOR,t.metallic=1,t.roughness=0,t.setUniforms();const e=new je(this._lightProbeGeometry,t);return e.lightProbes=[],e}_createLightProbeMesh(t){const e=this._constructLightProbeMesh();e.lightProbes.push(t),e.position.copyFrom(t.position);const i=new je(this._boxGeometry,this._boxMaterial),n=new je(this._boxGeometry,this._hollowBoxMaterial);i.visible=!1,i.add(n),e.add(i),t.isBoundingBoxEnabled()&&this._setLightProbeBoxPosition(t,i),e.updateMatrixWorld(!0),e.visible=this._lightProbesVisible,this.lightProbeMeshes.push(e),this._scene.addAuxiliaryObject(e),t.addEventListener(nn.eventType.POSITION_UPDATED,this._lightProbeUpdated),t.addEventListener(nn.eventType.BOUNDS_UPDATED,this._lightProbeUpdated)}_hideVisibleBoxMesh(){this._visibleBoxMesh&&(this._visibleBoxMesh.visible=!1,this._visibleBoxMesh=void 0)}_findLightProbeMeshIdx(t){return this.lightProbeMeshes.findIndex(e=>{for(let i=0;i<T.MAX_BLENDED_REFLECTION_PROBES;i++)if(e.lightProbes[i]===t)return!0;return!1})}_findLightProbeMesh(t){return this.lightProbeMeshes[this._findLightProbeMeshIdx(t)]}_removeLightProbeMesh(t){const e=this._findLightProbeMeshIdx(t),i=this.lightProbeMeshes[e];this._scene.removeAuxiliaryObject(i),i.material.dispose(),this.lightProbeMeshes.splice(e,1)}_init(){this._scene.lightProbes.forEach(t=>this._createLightProbeMesh(t)),this._scene.addEventListener(Hi.eventType.LIGHT_PROBE_ADDED,this._lightProbeAdded),this._scene.addEventListener(Hi.eventType.LIGHT_PROBE_REMOVED,this._lightProbeRemoved)}_changeLightProbesVisibility(t){this._lightProbesVisible!==t&&(this._lightProbesVisible=t,this.lightProbeMeshes.forEach(e=>e.visible=t)),this._animationController.requestFrame()}getLightProbeMaterial(t){const e=this._findLightProbeMesh(t);return e?e.material:void 0}showLightProbeBoundingBox(t){if(this._hideVisibleBoxMesh(),t.isBoundingBoxEnabled()){const e=this._findLightProbeMesh(t).children[0];this._visibleBoxMesh=e,this._visibleBoxMesh.visible=!0}}showLightProbes(){this._changeLightProbesVisibility(!0)}hideLightProbes(){this._changeLightProbesVisibility(!1)}}function Qh(r){return r instanceof jn}function tc(r){return r instanceof jn?!0:r instanceof nn?!1:[Ln.SUN,Ln.SPOT,Ln.AREA].includes(r.light.type)}class qM{constructor(t,e){o(this,"_target");o(this,"_supportedModes");this._target=t,this._supportedModes=e}offsetPosition(t){const e=this._target.position.clone().add(t);this._target.setPosition(e.x,e.y,e.z)}offsetRotation(t){tc(this._target);const e={x:this._target.rotation.x+t.x,y:this._target.rotation.y+t.y,z:this._target.rotation.z+t.z};this._target.setRotation(e.z,e.x,e.y)}offsetScale(t){Qh(this._target);const e=this._target.scale.clone().add(t);this._target.setScale(e.x,e.y,e.z)}isSupported(t){return this._supportedModes[t]}get target(){return this._target}}var di=(r=>(r[r.NONE=0]="NONE",r[r.X=1]="X",r[r.Y=2]="Y",r[r.XY=3]="XY",r[r.Z=4]="Z",r[r.XZ=5]="XZ",r[r.YZ=6]="YZ",r[r.ALL=7]="ALL",r))(di||{});const u0=new L(0,0,1),Kh=new L(1,0,0),$h=new L(0,1,0);function YM(r){switch(r){case 1:return Kh;case 2:return $h;case 4:return u0}zs()}function QM(r){return[1,2,4].includes(r)}function KM(r){const t=new li;return r instanceof yt&&r.traverse(e=>{e instanceof je&&(e.geometry.boundingBox||e.geometry.computeBoundingBox(),t.union(e.geometry.boundingBox))}),t}function $M(r,t){const e=KM(r),i=e.size(),n=ft.createBox(i.x,i.y,i.z),s=e.center(),a=new Ue;a.makeTranslation(s.x,s.y,s.z),n.applyMatrix(a),n.computeBoundingBox();const l=new je(n,t);return l.visible=!1,l.visibilityId=null,l}const Ds=.6;function Ls(r,t){const e=new Qt;return e.lightmapSupported=!1,e.hideFromLightProbes=!0,e.baseColor.copyFrom(r),e.reflective=!1,e.headLight=!1,e.depthTest=!1,e.depthWrite=!1,e.opacity=t,e}class $f extends yt{constructor(e,i,n){super();o(this,"material");o(this,"collider");o(this,"defaultOpacity");o(this,"hoveredOpacity",.99);o(this,"notUsedOpacity",.3);o(this,"usedAxes",0);this.add(e).add(i),this.material=n,this.collider=i,this.defaultOpacity=n.opacity}}function $o(...r){console.assert(r.length>0,"Part must have at least one element!");const t=new yt;r.forEach(n=>t.add(n));const e=$M(t,Ls(_e.WHITE,Ds)),i=t.children[0].material;return new $f(t,e,i)}class ZM extends yt{constructor(){super();o(this,"axisX");o(this,"axisY");o(this,"axisZ");o(this,"axes");o(this,"_visibility",[!1,!1,!1]);const e=.0075,i=ft.createCylinder(e,e,1e3,4,1,!1);function n(s){const a=Ls(s,Ds);return a.depthTest=!0,new je(i,a)}this.axisX=n(_e.RED),this.axisX.rotation.set(0,0,Math.PI/2),this.axisY=n(_e.GREEN),this.axisZ=n(_e.BLUE),this.axisZ.rotation.set(Math.PI/2,0,0),this.axes=[this.axisX,this.axisY,this.axisZ];for(const s of this.axes)this.add(s)}show(e){this._visibility[0]=(1&e)===1,this._visibility[1]=(2&e)===2,this._visibility[2]=(4&e)===4;for(let i=0;i<3;i++)this.axes[i].visible=this._visibility[i]}update(e){const n=new L;n.copyFrom(e),n.sub(this.position),n.normalize(),this.axisX.visible=this._visibility[0]&&Math.abs(Kh.dot(n))<.998,this.axisY.visible=this._visibility[1]&&Math.abs($h.dot(n))<.998,this.axisZ.visible=this._visibility[2]&&Math.abs(u0.dot(n))<.998}}class JM extends yt{constructor(){super();o(this,"markerX");o(this,"markerY");o(this,"markerZ");o(this,"markers");o(this,"_markerGeometry",ft.createSphere(.012,10,10));const e=()=>new je(this._markerGeometry,Ls(_e.WHITE,.99));this.markerX=e(),this.markerY=e(),this.markerZ=e(),this.markers=[this.markerX,this.markerY,this.markerZ];for(const i of this.markers)this.add(i)}show(e){this.markerX.visible=(1&e)===1,this.markerY.visible=(2&e)===2,this.markerZ.visible=(4&e)===4}update(e){for(const i of[0,1,2]){const n=i;this.markers[i].position.setComponent(n,e.getComponent(n)),this.markers[i].updateMatrixWorld()}}}class eP extends yt{constructor(){super();o(this,"planeXY");o(this,"planeXZ");o(this,"planeYZ");o(this,"localPlanes");o(this,"cameraPlane");const e=ft.createPlane(1e3,1e3,1,1);function i(a,l=0,c=0,h=0){const d=Ls(a,.2);d.depthTest=!0,d.side=Ti.DOUBLE;const u=$o(new je(e,d));return u.rotation.set(l,c,h),u}const n=i(_e.WHITE),s=new yt;this.add(n).add(s),this.planeXY=i(_e.BLUE),this.planeXZ=i(_e.GREEN,Math.PI/2,0,0),this.planeYZ=i(_e.RED,0,Math.PI/2,0),s.add(this.planeXY).add(this.planeXZ).add(this.planeYZ),this.localPlanes=s,this.cameraPlane=n}setLocalRotation(e){e?this.localPlanes.rotation.copyFrom(e):this.localPlanes.rotation.set(0,0,0)}update(e){this.cameraPlane.rotation.setFromRotationMatrix(e.matrixWorld),this.cameraPlane.updateMatrixWorld()}findPlaneIntersectionPoint(e,i,n,s){const a=new L,l=new L,c=f=>{switch(f){case 1:return this.planeYZ;case 2:return this.planeXZ;case 4:return this.planeXY;case 3:return this.planeXY;case 5:return this.planeXZ;case 6:return this.planeYZ;case 7:return this.cameraPlane}zs()};function h(f,p){if(QM(f)){const m=l.dot(l),b=l.dot(p),g=p.dot(p),x=l.dot(a),w=p.dot(a),C=m*g-b*b;return Math.abs(C)<1e-5?1/0:(m*w-b*x)/C}else{const m=l.dot(p);return Math.abs(m)<1e-5?1/0:l.dot(a)/m}}const d=c(e);d.getWorldPosition(a).sub(i),d.getWorldDirection(l);const u=h(e,n);return u===1/0?!1:(s.copyFrom(n).multiplyScalar(u).add(i),!0)}show(e){this.cameraPlane.visible=e===7,this.planeXY.visible=e===3,this.planeXZ.visible=e===5,this.planeYZ.visible=e===6}}function Zf(r,t,e){const i=r.collider,n=r.material;t===i?(n.opacity=r.hoveredOpacity,n.setUniforms()):(e&&t!==null?n.opacity=r.notUsedOpacity:n.opacity=r.defaultOpacity,n.setUniforms())}const Zh=.015;class tP extends yt{constructor(){super();o(this,"parts");o(this,"collidersMap");o(this,"colliders");function e(){const g=new Ue,x=ft.createSphere(.1,16,16),w=ft.createPlane(.23,.23,1,1);g.makeTranslation(.45,.45,0),w.applyMatrix(g);const C=ft.createCylinder(Zh,Zh,1,4,1,!1);g.makeTranslation(0,.65,0),C.applyMatrix(g);const M=ft.createCylinder(0,.05,.2,10,1,!1);return g.makeTranslation(0,1.25,0),M.applyMatrix(g),{pickerGeometry:x,squareGeometry:w,lineGeometry:C,arrowHeadGeometry:M}}function i(g,x){const w=g*g,C=new Uint8Array(4*w),M=Math.floor(x.r*255),D=Math.floor(x.g*255),W=Math.floor(x.b*255);let z=0;for(let Z=0;Z<g;Z++)for(let ne=0;ne<g;ne++){C[z]=M,C[z+1]=D,C[z+2]=W;const Me=Z===0||ne===0||Z===g-1||ne===g-1;C[z+3]=Me?220:150,z+=4}const $=st.newDataTexture(C,g,g,Ke.RGBA8);return $.hasAlpha=!0,$.needsUpdate=!0,$}function n(g){const x=i(32,g),w=new Qt;return w.lightmapSupported=!1,w.hideFromLightProbes=!0,w.reflective=!1,w.headLight=!1,w.depthTest=!1,w.depthWrite=!1,w.transparent=!0,w.baseColor=g,w.side=Ti.DOUBLE,w.baseColorTexture=x,w.opacity=Ds,w.configureTransparency(),w.setUniforms(),w}const s=e();function a(){const g=Ls(_e.WHITE,Ds);return $o(new je(s.pickerGeometry,g))}function l(g){const x=n(g);return $o(new je(s.squareGeometry,x))}function c(g){const x=Ls(g,Ds);return $o(new je(s.lineGeometry,x),new je(s.arrowHeadGeometry,x))}const h=a(),d=c(_e.RED);d.rotation.set(0,0,-Math.PI/2);const u=c(_e.GREEN),f=c(_e.BLUE);f.rotation.set(Math.PI/2,0,0);const p=l(_e.BLUE),m=l(_e.GREEN);m.rotation.set(Math.PI/2,0,0);const b=l(_e.RED);b.rotation.set(0,-Math.PI/2,0),h.usedAxes=7,d.usedAxes=1,u.usedAxes=2,f.usedAxes=4,p.usedAxes=3,m.usedAxes=5,b.usedAxes=6,this.parts=[h,d,u,f,p,m,b],this.parts.forEach(g=>this.add(g)),this.collidersMap=new Map(this.parts.map(g=>[g.collider,g])),this.colliders=[...this.collidersMap.keys()]}highlight(e,i){this.parts.forEach(n=>Zf(n,e,i))}usedAxes(e){return this.collidersMap.get(e).usedAxes}}class iP extends yt{constructor(){super();o(this,"parts");o(this,"collidersMap");o(this,"colliders");o(this,"circleXYZ");o(this,"sphere");function e(f){const p=ft.createTorus(f,.012,6,64),m=ft.createTorus(f,.038,6,64);return{torusGeometry:p,colliderGeometry:m}}function i(f,p){const m=new ox(f,Ds),b=new yt().add(new je(p.torusGeometry,m)),g=new je(p.colliderGeometry,m);return g.visible=!1,g.visibilityId=null,new $f(b,g,m)}function n(f,p){const m=Ls(f,0),b=ft.createSphere(p,32,32),g=new yt().add(new je(b,m)),x=new je(b,m);x.visible=!1,x.visibilityId=null;const w=new $f(g,x,m);return w.defaultOpacity=0,w.hoveredOpacity=.2,w.notUsedOpacity=0,w}const s=e(.9),a=i(_e.RED,s);a.rotation.set(0,Math.PI/2,0);const l=i(_e.GREEN,s);l.rotation.set(Math.PI/2,0,0);const c=i(_e.BLUE,s),h=e(1.12),d=i(_e.WHITE,h),u=n(_e.WHITE,.848);this.parts=[a,l,c,d,u],this.parts.forEach(f=>this.add(f)),this.collidersMap=new Map(this.parts.map(f=>[f.collider,f])),this.colliders=[...this.collidersMap.keys()],a.usedAxes=1,l.usedAxes=2,c.usedAxes=4,d.usedAxes=7,this.circleXYZ=d,u.usedAxes=0,this.sphere=u}update(e){this.parts.filter(i=>i!==this.sphere).forEach(i=>{const n=i.material;n.gizmoPosition.copyFrom(this.position),n.sphereRadius=this.scale.x*.86}),this.circleXYZ.rotation.setFromRotationMatrix(e.matrixWorld),this.circleXYZ.updateMatrixWorld()}highlight(e,i){this.parts.forEach(n=>Zf(n,e,i))}usedAxes(e){return this.collidersMap.get(e).usedAxes}}class nP extends yt{constructor(){super();o(this,"parts");o(this,"collidersMap");o(this,"colliders");function e(){const g=new Ue,x=ft.createBox(.3,.3,.3),w=ft.createPlane(.23,.23,1,1);g.makeTranslation(.45,.45,0),w.applyMatrix(g);const C=ft.createCylinder(Zh,Zh,1,4,1,!1);g.makeTranslation(0,.65,0),C.applyMatrix(g);const M=ft.createBox(.1,.1,.1);return g.makeTranslation(0,1.1,0),M.applyMatrix(g),{pickerGeometry:x,squareGeometry:w,lineGeometry:C,cubeGeometry:M}}function i(g,x){const w=g*g,C=new Uint8Array(4*w),M=Math.floor(x.r*255),D=Math.floor(x.g*255),W=Math.floor(x.b*255);let z=0;for(let Z=0;Z<g;Z++)for(let ne=0;ne<g;ne++){C[z]=M,C[z+1]=D,C[z+2]=W;const Me=Z===0||ne===0||Z===g-1||ne===g-1;C[z+3]=Me?220:150,z+=4}const $=st.newDataTexture(C,g,g,Ke.RGBA8);return $.hasAlpha=!0,$.needsUpdate=!0,$}function n(g){const x=i(32,g),w=new Qt;return w.lightmapSupported=!1,w.hideFromLightProbes=!0,w.reflective=!1,w.headLight=!1,w.depthTest=!1,w.depthWrite=!1,w.transparent=!0,w.baseColor=g,w.side=Ti.DOUBLE,w.baseColorTexture=x,w.opacity=Ds,w.configureTransparency(),w.setUniforms(),w}const s=e();function a(){const g=Ls(_e.WHITE,Ds);return $o(new je(s.pickerGeometry,g))}function l(g){const x=n(g);return $o(new je(s.squareGeometry,x))}function c(g){const x=Ls(g,Ds);return $o(new je(s.lineGeometry,x),new je(s.cubeGeometry,x))}const h=a(),d=c(_e.RED);d.rotation.set(0,0,-Math.PI/2);const u=c(_e.GREEN),f=c(_e.BLUE);f.rotation.set(Math.PI/2,0,0);const p=l(_e.BLUE),m=l(_e.GREEN);m.rotation.set(Math.PI/2,0,0);const b=l(_e.RED);b.rotation.set(0,-Math.PI/2,0),h.usedAxes=7,d.usedAxes=1,u.usedAxes=2,f.usedAxes=4,p.usedAxes=3,m.usedAxes=5,b.usedAxes=6,this.parts=[h,d,u,f,p,m,b],this.parts.forEach(g=>this.add(g)),this.collidersMap=new Map(this.parts.map(g=>[g.collider,g])),this.colliders=[...this.collidersMap.keys()]}highlight(e,i){this.parts.forEach(n=>Zf(n,e,i))}usedAxes(e){return this.collidersMap.get(e).usedAxes}}const sP=.01,rP=2;class oP extends yt{constructor(){super();o(this,"currentRotationX",0);o(this,"lineMaterial",Ls(_e.WHITE,Ds));o(this,"arrow");o(this,"line");o(this,"arc");o(this,"_arrowMaterial",Ls(_e.ORANGE,Ds));o(this,"_radius",sP);o(this,"_size",rP);this.arrow=this._createArrow(),this.line=this._createLine(),this.arc=this._createArc(),this.add(this.arrow).add(this.line).add(this.arc)}_createArrow(){const e=this._radius,i=this._size,n=ft.createCylinder(0,e*6,i*.25,32,1,!1),s=ft.createCylinder(e,e,i*.75,32,1,!1),a=new je(n,this._arrowMaterial),l=new je(s,this._arrowMaterial);return a.position.y=i*.125*-1,l.position.y=i*.625*-1,new yt().add(a).add(l)}_createLine(){const e=this._radius,i=this._size,n=ft.createCylinder(e,e,i,32,1,!1),s=new je(n,this.lineMaterial);return s.position.y=i*.5*-1,new yt().add(s)}_createArcMesh(e){const i=ft.createTorus(this._size*.9,this._radius,6,32,e),n=new je(i,this.lineMaterial);return n.rotation.set(0,-Math.PI/2,-Math.PI/2),n}_createArc(){return new yt().add(this._createArcMesh(Math.PI/2))}_updateArcIfNeeded(e){if(e===this.currentRotationX)return;const i=e*-1,n=this.arc.children.pop(),s=this._createArcMesh(i);this.arc.remove(n),this.arc.add(s),n.geometry.dispose(),this.currentRotationX=e}update(e){this.arrow.rotation.copyFrom(e),this.line.rotation.set(0,0,e.z),this.arc.rotation.set(0,0,e.z),this._updateArcIfNeeded(e.x)}}var ui=(r=>(r[r.TRANSLATE=0]="TRANSLATE",r[r.ROTATE=1]="ROTATE",r[r.SCALE=2]="SCALE",r))(ui||{});const f0={ORTHOGRAPHIC:.1,PERSPECTIVE:.002};class aP{constructor(t,e,i,n){o(this,"_scene");o(this,"_collider");o(this,"_cameraWorldPosition");o(this,"_animationController");o(this,"target");o(this,"subTargetsInfo",null);o(this,"subTargetsData",new Array);o(this,"_axes",new ZM);o(this,"_planes",new eP);o(this,"_markers",new JM);o(this,"_translateGizmo",new tP);o(this,"_rotateGizmo",new iP);o(this,"_scaleGizmo",new nP);o(this,"_sunHelper",new oP);o(this,"_objects3d",[this._axes,this._planes,this._markers,this._translateGizmo,this._rotateGizmo,this._scaleGizmo,this._sunHelper]);o(this,"_transforming",!1);o(this,"_initialPositionOffset",new L(0,0,0));o(this,"_initialRotationOffset",0);o(this,"_initialScaleOffset",new L);o(this,"oldPosition",new L(0,0,0));o(this,"newPosition",new L(0,0,0));o(this,"oldRotation",new Fi(0,0,0,ys.XYZ));o(this,"newRotation",new Fi(0,0,0,ys.XYZ));o(this,"oldScale",new L(1,1,1));o(this,"newScale",new L(1,1,1));o(this,"_mode",ui.TRANSLATE);o(this,"_visible",!1);o(this,"_startClip",{x:1/0,y:1/0});o(this,"_markersPosition",new L(0,0,0));o(this,"_currentlyHovered",null);o(this,"_pointerDown",!1);o(this,"_usedAxes",di.ALL);o(this,"_toEye",new L);o(this,"rotationSpeed",5);this._scene=t,this._collider=e,this._cameraWorldPosition=i,this._animationController=n,this._axes.show(di.ALL),this._planes.show(di.NONE),this._markers.show(di.NONE),this.mode=ui.TRANSLATE}get transforming(){return this._transforming}get position(){return this._axes.position}get rotation(){return this.oldRotation}get scale(){return this.oldScale}get currentGizmo(){switch(this._mode){case ui.TRANSLATE:return this._translateGizmo;case ui.ROTATE:return this._rotateGizmo;case ui.SCALE:return this._scaleGizmo}}get mode(){return this._mode}set mode(t){this._mode!==t&&(this._mode=t,this._updateControlsVisibility(),this._animationController.requestFrame())}get visible(){return this._visible}set visible(t){this._visible!==t&&(this._visible=t,this._updateControlsVisibility())}_setScale(t){for(const e of this._objects3d)e.scale.set(t,t,t)}_copyPositionFrom(t){this.oldPosition.copyFrom(t),this.newPosition.copyFrom(t);for(const e of this._objects3d)e.position.copyFrom(t)}_copyRotationFrom(t){this.oldRotation.copyFrom(t),this.newRotation.copyFrom(t),this._mode===ui.SCALE?(this._axes.rotation.copyFrom(t),this._planes.setLocalRotation(t),this._scaleGizmo.rotation.copyFrom(this.oldRotation)):(this._axes.rotation.set(0,0,0),this._planes.setLocalRotation(void 0),this._sunHelper.update(t))}_copyScaleFrom(t){this.oldScale.copyFrom(t),this.newScale.copyFrom(t)}_updateControlsVisibility(){if(!this._visible){for(const t of this._objects3d)this._scene.removeAuxiliaryObject(t);return}this._mode===ui.TRANSLATE?(this._scene.addAuxiliaryObject(this._axes),this._scene.addAuxiliaryObject(this._planes),this._scene.addAuxiliaryObject(this._markers),this._scene.addAuxiliaryObject(this._translateGizmo),this._scene.removeAuxiliaryObject(this._rotateGizmo),this._scene.removeAuxiliaryObject(this._scaleGizmo),this._scene.removeAuxiliaryObject(this._sunHelper)):this._mode===ui.ROTATE?(this._scene.addAuxiliaryObject(this._axes),this._scene.removeAuxiliaryObject(this._translateGizmo),this._scene.addAuxiliaryObject(this._rotateGizmo),this._scene.removeAuxiliaryObject(this._scaleGizmo)):(this._scene.addAuxiliaryObject(this._axes),this._scene.addAuxiliaryObject(this._planes),this._scene.removeAuxiliaryObject(this._translateGizmo),this._scene.removeAuxiliaryObject(this._rotateGizmo),this._scene.addAuxiliaryObject(this._scaleGizmo),this._scene.removeAuxiliaryObject(this._sunHelper))}_targetIsSunInstance(){var t,e;return this.target instanceof Jc&&((t=this.target)==null?void 0:t.light)!==void 0&&((e=this.target)==null?void 0:e.light.type)===Ln.SUN}_setupCameraWorldDirection(t,e,i){const n=this._scene.camera.getCurrent();this._scene.camera.isOrthographic()?t.copyFrom(n.getWorldDirection()):(n.unprojectVector(t.set(e,i,1)),t.sub(this._cameraWorldPosition).normalize())}_getCameraRayOrigin(t,e){if(this._scene.camera.isPerspective())return this._cameraWorldPosition.clone();const i=this._scene.camera.getCurrent();nt(i instanceof An);const n=this._scene.camera.getWorldQuaternion(new bi),s=t*(i.right-i.left)/2,a=e*(i.top-i.bottom)/2,l=new L(s,a,0);return n.applyToVector3(l),this._cameraWorldPosition.clone().add(l)}_getAxesIntersectionPosition(t,e,i){const n=new L,s=new L,a=new bi;this._setupCameraWorldDirection(n,e,i);const l=this._getCameraRayOrigin(e,i);return this._planes.findPlaneIntersectionPoint(t,l,n,s)?(s.sub(this._axes.position),this._axes.rotation.toQuaternion(a),a.inverse().applyToVector3(s),t&di.X||(s.x=0),t&di.Y||(s.y=0),t&di.Z||(s.z=0),s):null}_getCameraPlaneIntersectionAngle(t,e){var h;const i=new L,n=new L,s=new L,a=this._planes.cameraPlane;i.set(0,0,-1),a.matrixWorld.transformVector3(i),n.set(-1,0,0),a.matrixWorld.transformVector3(n);const l=(h=this._getAxesIntersectionPosition(di.ALL,t,e))==null?void 0:h.normalize();return s.copyFrom(n).cross(l),Math.sign(i.dot(s))*Math.acos(n.dot(l))}_getInitialRotationOffset(t,e){return this._getCameraPlaneIntersectionAngle(t,e)}_getNewRotation(t,e){const i=new Fi(0,0,0,ys.XYZ),n=new bi,s=new bi,a=new ye(0,0),l=new bi,c=new L,h=new L,d=new L;if(this.oldRotation.toQuaternion(l),l.normalize(),a.set(this._startClip.x-t,this._startClip.y-e),a.multiplyScalar(this.rotationSpeed),this._usedAxes===di.NONE){const p=this._planes.cameraPlane;return c.copyFrom(Kh),p.matrixWorld.transformVector3(c),h.set(0,1,0),p.matrixWorld.transformVector3(h),s.setFromAxisAngle(c,a.y),n.setFromAxisAngle(h,-a.x),n.multiply(s),n.multiply(l),n.normalize(),i.setFromQuaternion(n,ys.ZXY),i}let u=$h,f=0;if(this._usedAxes===di.ALL){const p=this._planes.cameraPlane;d.set(0,0,-1),p.matrixWorld.transformVector3(d),u=d,f=this._getCameraPlaneIntersectionAngle(t,e),f=f-this._initialRotationOffset}else{if(this._usedAxes!==di.Z){const p=this._usedAxes===di.X?$h:Kh,m=this._usedAxes===di.X?-1:1;a.multiplyScalar(m*Math.sign(p.dot(this._toEye)))}this._usedAxes===di.X||this._usedAxes===di.Y||(this._usedAxes,di.Z),u=YM(this._usedAxes),f=this._usedAxes===di.Z?-a.x:a.y}return n.setFromAxisAngle(u,f),n.multiply(l),n.normalize(),i.setFromQuaternion(n,ys.ZXY),i}_getUsedAxes(t){return this.currentGizmo.usedAxes(t)}_handleHover(t,e,i){const n={hoveredCollider:null,hasAnythingChanged:!1},s=this.currentGizmo,a=this._collider.findMeshFromListAtPosition(s.colliders,t,e,!0);let l=!1;return(a!==this._currentlyHovered||this._pointerDown!==i)&&(this._currentlyHovered=a,s.highlight(a,i),l=!0),n.hoveredCollider=a,n.hasAnythingChanged=l,n}onCanvasPointerMove(t,e){if(!this.transforming)return this._handleHover(t,e,this._pointerDown).hasAnythingChanged&&this._animationController.requestFrame(),!1;if(this._axes.show(this._usedAxes),this.mode===ui.TRANSLATE){const i=this._getAxesIntersectionPosition(this._usedAxes,t,e);i&&this.newPosition.copyFrom(i.sub(this._initialPositionOffset).add(this._axes.position)),this._translateGizmo.position.copyFrom(this.newPosition),this.adjustScaleToGizmoPosition(),this._markersPosition.copyFrom(this.newPosition),this._markersPosition.sub(this._axes.position),this._markersPosition.divide(this._axes.scale),this._markers.update(this._markersPosition),(t!==this._startClip.x||e!==this._startClip.y)&&this._markers.show(this._usedAxes)}else if(this.mode===ui.ROTATE)this.newRotation.copyFrom(this._getNewRotation(t,e)),this._targetIsSunInstance()&&(this.target&&tc(this.target),this._sunHelper.update(this.target.rotation));else{const i=this._getAxesIntersectionPosition(this._usedAxes,t,e);i&&(i.addScalar(1).divide(this._initialScaleOffset),this.newScale.copyFrom(i))}return this._animationController.requestFrame(),!0}onCanvasPointerDown(t,e){const i=this._handleHover(t,e,!0);if(this._pointerDown=!0,i.hoveredCollider!==null){if(this._transforming=!0,this._usedAxes=this._getUsedAxes(i.hoveredCollider),this._startClip.x=t,this._startClip.y=e,this.mode===ui.TRANSLATE){this._planes.show(this._usedAxes),this.newPosition.copyFrom(this.oldPosition);const n=this._getAxesIntersectionPosition(this._usedAxes,t,e);this._initialPositionOffset.copyFrom(n)}else if(this.mode===ui.ROTATE)this._usedAxes===di.ALL&&(this.newRotation.copyFrom(this.oldRotation),this._initialRotationOffset=this._getInitialRotationOffset(t,e));else{this._planes.show(this._usedAxes===di.ALL?di.NONE:this._usedAxes),this.newScale.copyFrom(this.oldScale);const n=this._getAxesIntersectionPosition(this._usedAxes,t,e);this._initialScaleOffset.copyFrom(n).addScalar(1).divide(this.oldScale)}return!0}return this._usedAxes=di.ALL,this._transforming=!1,i.hasAnythingChanged&&this._animationController.requestFrame(),!1}onCanvasPointerUp(t,e){this.transforming&&(this._copyPositionFrom(this.newPosition),this._copyRotationFrom(this.newRotation),this._copyScaleFrom(this.newScale),this._planes.show(di.NONE),this._markers.show(di.NONE),this._usedAxes=di.ALL,this._axes.show(this._usedAxes),this.currentGizmo.visible=!0);const i=this.transforming;return this._transforming=!1,this.update(),this._handleHover(t,e,!1).hasAnythingChanged&&this._animationController.requestFrame(),this._pointerDown=!1,i}updateHelpers(){this._targetIsSunInstance()?this._scene.addAuxiliaryObject(this._sunHelper):this._scene.removeAuxiliaryObject(this._sunHelper)}adjustScaleToGizmoPosition(){if(this._scene.camera.isOrthographic())this._setScale(this._scene.camera.orthoFrustumSize*f0.ORTHOGRAPHIC);else{const t=this.currentGizmo.position.distanceTo(this._cameraWorldPosition);this._setScale(t*this._scene.camera.fov*f0.PERSPECTIVE)}}update(){var t;this.transforming||(((t=this.target)==null?void 0:t.position)!==void 0&&this._copyPositionFrom(this.target.position),this.target&&tc(this.target)&&this._copyRotationFrom(this.target.rotation),this.target&&Qh(this.target)&&this._copyScaleFrom(this.target.scale)),this._toEye.copyFrom(this._cameraWorldPosition),this._toEye.sub(this._axes.position),this._toEye.normalize(),this.adjustScaleToGizmoPosition(),this._rotateGizmo.update(this._scene.camera),this._planes.update(this._scene.camera),this._axes.update(this._cameraWorldPosition);for(const e of this._objects3d)e.updateMatrixWorld()}}class Jf{constructor(t,e,i,n,s){o(this,"target");o(this,"_update");o(this,"_position",new L);o(this,"_rotation",new Fi);o(this,"_scale",new L);o(this,"_oldPosition");o(this,"_oldRotation");o(this,"_oldScale");this._update=t,this.target=e,i&&this._position.copyFrom(i),n&&this._rotation.copyFrom(n),s&&this._scale.copyFrom(s),this._oldPosition=i,this._oldRotation=n,this._oldScale=s}apply(){var e,i,n;const t=new Jf(this._update,this.target,this._oldPosition,this._oldRotation,this._oldScale);return(e=this._oldPosition)==null||e.copyFrom(this._position),(i=this._oldRotation)==null||i.copyFrom(this._rotation),(n=this._oldScale)==null||n.copyFrom(this._scale),this._update(),t}}class ic{constructor(t){o(this,"transforms");this.transforms=t}static fromTargets(t,e){const i=new Array;for(const n of t)i.push(new Jf(e,n,n.position,tc(n)?n.rotation:void 0,Qh(n)?n.scale:void 0));return new ic(i)}apply(){const t=new Array;for(const e of this.transforms)t.push(e.apply());return new ic(t)}isMergable(t){return!(t instanceof ic)||t.transforms.length!==this.transforms.length?!1:t.transforms.every((e,i)=>e.target===this.transforms[i].target)}}class lP{constructor(t,e,i,n,s,a){o(this,"history");o(this,"_controls");o(this,"_enabled",!1);o(this,"_transformGizmo");o(this,"_callbacks",{itemModified:zc});o(this,"_supportedModes",new Array);o(this,"_helper");this._controls=s,this._enabled=!1,this._transformGizmo=new aP(i,n,s.cameraWorldPosition(),e),this._transformGizmo.mode=ui.TRANSLATE,this.history=a,this._helper=new sh(t,T.POINTER_PRIORITY.TRANSFORM_CONTROLS),this._helper.callbacks.onPointerDown=(l,c)=>{const h=this._transformGizmo.onCanvasPointerDown(l,c);return this._setControlsEnabledState(!this._transformGizmo.transforming),h},this._helper.callbacks.onPointerUp=(l,c)=>{const h=this._transformGizmo.onCanvasPointerUp(l,c);return this._setControlsEnabledState(!this._transformGizmo.transforming),h},this._helper.callbacks.onPointerMove=(l,c)=>{const h=this._transformGizmo.onCanvasPointerMove(l,c);if(!this._transformGizmo.transforming)return h;this.target;const d=ic.fromTargets([this.target].concat(this.subTargetsData.map(u=>u.target)),()=>{this.target&&this.target.position,this._callbacks.itemModified(this.target),this.target.setPosition(...this.target.position.toArray())});return this.history.addItem(d),this._transformGizmo.mode===ui.TRANSLATE?this._updateTargetsAfterTranslation():this._transformGizmo.mode===ui.ROTATE?this._updateTargetsAfterRotation():this._updateTargetsAfterScaling(),h},this._helper.disable()}get supportedModes(){return this._supportedModes}get mode(){return this._transformGizmo.mode}get target(){return this._transformGizmo.target}get subTargetsData(){return this._transformGizmo.subTargetsData}setTransformMode(t){this._transformGizmo.mode=t}setItemModifiedCallback(t){console.assert(this._callbacks.itemModified===zc),this._callbacks.itemModified=t}update(){this._enabled&&this._transformGizmo.update()}enable(t,e,i=[]){this._enabled=!0,this._setTarget(t,i),this._supportedModes=e,this._supportedModes.indexOf(this._transformGizmo.mode)===-1&&(this._transformGizmo.mode=e[0]),this._helper.enable()}disable(){this._enabled=!1,this._supportedModes=[],this._transformGizmo.visible=!1,this._helper.disable()}_updateTargetsAfterTranslation(){this.target&&this.target.position&&this.target.setPosition;const t=this._transformGizmo.newPosition,e=t.clone().sub(this.target.position);this.target.setPosition(t.x,t.y,t.z),this._callbacks.itemModified(this.target),this.subTargetsData&&this.subTargetsData.forEach(i=>{i.isSupported(this._transformGizmo.mode)&&(i.offsetPosition(e),this._callbacks.itemModified(i.target))})}_updateTargetsAfterRotation(){this.target&&tc(this.target);const t=this._transformGizmo.newRotation,e=new L(t.x-this.target.rotation.x,t.y-this.target.rotation.y,t.z-this.target.rotation.z),i={x:this.target.rotation.x+e.x,y:this.target.rotation.y+e.y,z:this.target.rotation.z+e.z};this.target.setRotation(i.z,i.x,i.y),this._callbacks.itemModified(this.target),this.subTargetsData&&this.subTargetsData.forEach(n=>{n.isSupported(this._transformGizmo.mode)&&(n.offsetRotation(e),this._callbacks.itemModified(n.target))})}_updateTargetsAfterScaling(){this.target&&Qh(this.target);const t=this._transformGizmo.newScale,e=t.clone().sub(this.target.scale);this.target.setScale(t.x,t.y,t.z),this._callbacks.itemModified(this.target),this.subTargetsData&&this.subTargetsData.forEach(i=>{i.isSupported(this._transformGizmo.mode)&&(i.offsetScale(e),this._callbacks.itemModified(i.target))})}_setControlsEnabledState(t){this._controls.isEnabled()!==t&&(t?this._controls.enable():this._controls.disable())}_setTarget(t,e){this._transformGizmo.target=t,this._transformGizmo.subTargetsData=e,t!==null&&(this._transformGizmo.update(),this._transformGizmo.visible=!0,this._transformGizmo.updateHelpers())}}class cP{constructor(t,e){o(this,"_nodesPrimary");o(this,"_nodesSecondary");this._nodesPrimary=t,this._nodesSecondary=e}set highlightMix(t){this._nodesPrimary.forEach(e=>e.highlightMix=t),this._nodesSecondary.forEach(e=>e.highlightMix=t)}set selected(t){this._nodesPrimary.forEach(e=>e.selected=t),this._nodesSecondary.forEach(e=>e.selectedSecondary=t)}}class Ut{constructor(t,e,i,n,s,a){o(this,"_scene");o(this,"_collider");o(this,"_animationController");o(this,"_lightControls");o(this,"_lightProbeControls");o(this,"transformControls");o(this,"_cameraVolumeTriggerControls");o(this,"_updateSelectionHighlight",!1);o(this,"_selectedItems",[]);o(this,"_selectionTimeLeft",0);o(this,"_selectedNodeGroup");o(this,"_distanceToObject",0);o(this,"_clickIntersection",new yr);o(this,"_selectionTimeSec",1);o(this,"_mode",Ut.SelectionMode.OFF);o(this,"_callbacks",{materialClicked:void 0,lightInstanceClicked:void 0,lightProbeClicked:void 0,nodeClicked:void 0,extensionClicked:void 0,positionClicked:void 0});o(this,"_extensionManager");o(this,"history",new UM);this._scene=e,this._collider=i,this._animationController=n,this._extensionManager=a,this._lightControls=new jM(e,n),this._lightProbeControls=new XM(e,n),this._selectionTimeLeft=0,this._distanceToObject=0,this._clickIntersection=new yr,this.transformControls=new lP(t,n,e,i,s,this.history),this._cameraVolumeTriggerControls=new kM(e,n),this._registerPointerEventHandlers(t),this.setSelectionMode(Ut.SelectionMode.OFF,!0)}_removeCurrentSelection(){this._selectedItems.forEach(t=>{t instanceof $d||(t.selected=!1),t.highlightMix=0}),this._selectedItems.length=0}_updateSelectionIntensity(){this._selectedItems.forEach(t=>{t.highlightMix=.8*Math.pow(this._selectionTimeLeft/this._selectionTimeSec,2)})}_selectItemByMaterial(t){this._removeCurrentSelection(),t instanceof $d?this._selectedItems.push(t):t instanceof bt&&this._scene.threeScene.traverse(e=>{e instanceof Tn&&e.material===t&&(e.selected=!0,this._selectedItems.push(e))}),this._updateSelectionHighlight=!0,this._selectionTimeLeft=this._selectionTimeSec,this._updateSelectionIntensity(),this._animationController.requestFrame()}_getSupportedModeForLightInstance(t){return t.light.type==Ln.POINT&&!t.light.photometricProfile?[ui.TRANSLATE]:t.light.type==Ln.SUN?[ui.ROTATE]:[ui.TRANSLATE,ui.ROTATE]}get selectionMode(){return this._mode}selectMaterial(t){this._selectItemByMaterial(t)}selectLights(t,e){this._lightControls.showSelectionMesh(t,e),this._animationController.requestFrame()}selectLightInstances(t,e,i){this._mode,Ut.SelectionMode.LIGHT;const n=s=>{const a=new Array;for(const l of this._getSupportedModeForLightInstance(t))a[l]=!0;return s.map(l=>new qM(l,a))};if(this._lightControls.showInstancesSelectionMesh(t,e),t){const s=this._getSupportedModeForLightInstance(t);this.transformControls.enable(t,s,n(e))}else this.transformControls.disable();if(i){const s=this._lightControls.getLightInstanceMaterial(i);this._selectItemByMaterial(s)}else this._animationController.requestFrame()}selectLightProbe(t){this._mode,Ut.SelectionMode.LIGHT_PROBE;let e;t?(this._lightProbeControls.showLightProbeBoundingBox(t),e=this._lightProbeControls.getLightProbeMaterial(t),this.transformControls.enable(t,[ui.TRANSLATE])):this.transformControls.disable(),this._selectItemByMaterial(e)}selectCameraVolumeTrigger(t){this._mode,Ut.SelectionMode.CAMERA_VOLUME,t?(this._cameraVolumeTriggerControls.setControlsVisible(!0),this._selectItemByMaterial(this._cameraVolumeTriggerControls.setHighlightedCameraVolumeTrigger(t)),this.transformControls.enable(t,[ui.TRANSLATE,ui.ROTATE,ui.SCALE]),t.addEventListener(jn.eventType.DISPOSED,()=>this.transformControls.disable())):(this._selectItemByMaterial(void 0),this.transformControls.disable())}selectExtension(t){if(this._mode,Ut.SelectionMode.EXTENSION,!t||t.triggers.length===0)return;const e=t.triggers[0];e instanceof Yr&&this._selectItemByMaterial(e.material)}selectNodes(t,e,i,n){if(this._mode,Ut.SelectionMode.NODE,this._selectedNodeGroup&&(this._selectedNodeGroup.selected=!1,this._removeCurrentSelection()),t||e.length){const s=[t].concat(i),a=e.concat(n);this._selectedNodeGroup=new cP(s,a),this._selectedNodeGroup.selected=!0,this._selectedItems.push(this._selectedNodeGroup),this._updateSelectionHighlight=!0,this._selectionTimeLeft=this._selectionTimeSec,this._updateSelectionIntensity()}else this._selectedNodeGroup=void 0;this._animationController.requestFrame()}update(t){this.transformControls.update(),this._updateSelectionHighlight&&(this._selectionTimeLeft>0?(this._selectionTimeLeft-=t,this._updateSelectionIntensity()):(this._selectedItems.forEach(e=>{e.highlightMix=0}),this._updateSelectionHighlight=!1),this._animationController.requestFrame())}_playAnimatedMaterials(){for(const t of this._scene.materialManager.getAnimatedMaterials())t.play()}_pauseAnimatedMaterials(){for(const t of this._scene.materialManager.getAnimatedMaterials())t.pause()}setDistanceToObject(t){this._distanceToObject=t}setSelectionMode(t,e=!1){!e&&t===this._mode||(this._mode===Ut.SelectionMode.CAMERA_VOLUME&&this._cameraVolumeTriggerControls.setControlsVisible(!1),this._removeCurrentSelection(),t==Ut.SelectionMode.LIGHT?this._lightControls.showLights():this._lightControls.hideLights(),t==Ut.SelectionMode.LIGHT_PROBE?this._lightProbeControls.showLightProbes():this._lightProbeControls.hideLightProbes(),this.transformControls.disable(),t===Ut.SelectionMode.MATERIAL||t===Ut.SelectionMode.EXTENSION?this._playAnimatedMaterials():this._pauseAnimatedMaterials(),this._mode=t)}setMaterialClickedCallback(t){this._callbacks.materialClicked,this._callbacks.materialClicked=t}setLightInstanceClickedCallback(t){this._callbacks.lightInstanceClicked,this._callbacks.lightInstanceClicked=t}setLightProbeClickedCallback(t){this._callbacks.lightProbeClicked,this._callbacks.lightProbeClicked=t}setNodeClickedCallback(t){this._callbacks.nodeClicked,this._callbacks.nodeClicked=t}setExtensionClickedCallback(t){this._callbacks.extensionClicked,this._callbacks.extensionClicked=t}setPositionClickedCallback(t){this._callbacks.positionClicked,this._callbacks.positionClicked=t}getMeshAtPosition(t,e){return this._collider.findObstacleMeshAtPosition(t,e,!1)}_findClickedMaterial(t,e){const i=this._collider.findObstacleMeshAtPosition(t,e,!1);return i!==null?i.material:null}_findClickedLightInstance(t,e){const i=this._collider.findMeshFromListAtPosition(this._lightControls.lightInstanceMeshes,t,e);return i!==null?i.userData.lightInstance:null}_findClickedLightProbe(t,e){const i=this._collider.findMeshFromListAtPosition(this._lightProbeControls.lightProbeMeshes,t,e);return i!==null?i.lightProbes[0]:null}_findClickedNode(t,e){const i=this._collider.findObstacleMeshAtPosition(t,e,!1);return i instanceof Tn?i.node:null}_findClickedAnchor(t,e){if(!this._collider.findIntersectionAtPosition(t,e,!1,this._clickIntersection))return;const i=this._clickIntersection.object.anchor;return i!=null?i:void 0}_findClickedPosition(t,e){return!this._collider.findIntersectionAtPosition(t,e,!1,this._clickIntersection)||this._clickIntersection.object.anchor?null:this._collider.movePointTowardsTheCamera(this._clickIntersection.point,this._distanceToObject)}_registerPointerEventHandlers(t){const e=new sh(t,T.POINTER_PRIORITY.EDITOR_SELECTOR);e.callbacks.onClick=(i,n,s)=>{if([Ut.SelectionMode.OFF,Ut.SelectionMode.CAMERA_VOLUME].includes(this._mode))return!1;let a=null,l=!1;switch(this._mode){case Ut.SelectionMode.MATERIAL:a=this._findClickedMaterial(i,n),a!==null&&this._callbacks.materialClicked&&(l=this._callbacks.materialClicked(a,s));break;case Ut.SelectionMode.LIGHT:a=this._findClickedLightInstance(i,n),a!==null&&this._callbacks.lightInstanceClicked&&(l=this._callbacks.lightInstanceClicked(a,s));break;case Ut.SelectionMode.LIGHT_PROBE:a=this._findClickedLightProbe(i,n),a!==null&&this._callbacks.lightProbeClicked&&(l=this._callbacks.lightProbeClicked(a,s));break;case Ut.SelectionMode.NODE:a=this._findClickedNode(i,n),a&&this._callbacks.nodeClicked&&(l=this._callbacks.nodeClicked(a,s));break;case Ut.SelectionMode.EXTENSION:{if(!this._callbacks.extensionClicked)break;if(a=this._findClickedAnchor(i,n),a){const c=this._extensionManager.getExtensionByTrigger(a);l=this._callbacks.extensionClicked(c,a,s)}break}case Ut.SelectionMode.POSITION:a=this._findClickedPosition(i,n),a&&this._callbacks.positionClicked&&(l=this._callbacks.positionClicked(a,s));break}return l},e.callbacks.onDoubleClick=(i,n)=>!1}}(r=>{(t=>{t[t.OFF=0]="OFF",t[t.MATERIAL=1]="MATERIAL",t[t.LIGHT=2]="LIGHT",t[t.LIGHT_PROBE=3]="LIGHT_PROBE",t[t.NODE=4]="NODE",t[t.EXTENSION=6]="EXTENSION",t[t.POSITION=7]="POSITION",t[t.CAMERA_VOLUME=8]="CAMERA_VOLUME"})(r.SelectionMode||(r.SelectionMode={}))})(Ut||(Ut={}));var Jh=(r=>(r.TOP="top",r.LEFT="left",r.FRONT="front",r))(Jh||{}),p0=(r=>(r[r.PERSPECTIVE=0]="PERSPECTIVE",r[r.ORTHOGRAPHIC=1]="ORTHOGRAPHIC",r))(p0||{}),m0=(r=>(r[r.NONE=0]="NONE",r[r.WIREFRAME_TRANSPARENT=1]="WIREFRAME_TRANSPARENT",r[r.WIREFRAME_OPAQUE=2]="WIREFRAME_OPAQUE",r))(m0||{});function ed(r){let t,e;if(r instanceof Tn){const s=Fd();r.selected===!0?(e=1.5,t=s.meshSelectedLineColor):r.selectedSecondary===!0&&(e=1.25,t=s.meshSelectedSecondaryLineColor)}return{lineColor:t,lineThickness:e}}var _0=(r=>(r.VIEW_MODE_CHANGED="viewModeChanged",r))(_0||{});const vd=class vd extends ci{constructor(e){super();o(this,"_scene");o(this,"_controls");o(this,"_rawRenderer");o(this,"_teleport");o(this,"_animationController");o(this,"_internalViews");o(this,"_wireframeMaterial");o(this,"_autoClearAlter");o(this,"_clearColorAlter");o(this,"_currentMaterialOverride");o(this,"_transparentWireframeMaterial");o(this,"_opaqueWireframeMaterial");o(this,"_onViewModeChanged",e=>{this.dispatchEvent({type:vd.eventType.VIEW_MODE_CHANGED,viewMode:e})});this._scene=e.scene,this._controls=e.controls,this._rawRenderer=e.rawRenderer,this._teleport=e.teleport,this._animationController=e.animationController,this._internalViews=this._scene.internalViews;const i=this._scene.boundingBox.getBoundingSphere().radius*2;this._wireframeMaterial=new Es(void 0,i,ed),this._transparentWireframeMaterial=new Es(void 0,i,ed,!0),this._opaqueWireframeMaterial=new Es(void 0,i,ed,!1),this._autoClearAlter=new br(this._rawRenderer),this._clearColorAlter=new ih(this._rawRenderer),this._currentMaterialOverride=0,this._bindUi()}_bindUi(){const e=document.getElementById("view-mode");if(!e)return;e.style.display="block";const i=(n,s)=>{var a;(a=document.getElementById(n))==null||a.addEventListener("click",s)};i("view-mode-top",()=>this._setViewModeType("top")),i("view-mode-front",()=>this._setViewModeType("front")),i("view-mode-left",()=>this._setViewModeType("left")),i("view-mode-fps",()=>this._switchToFpsView()),i("view-mode-persp",()=>this._setProjectionType(0)),i("view-mode-ortho",()=>this._setProjectionType(1)),i("view-mode-color",()=>this._setMaterialOverride(0)),i("view-mode-wireframe-opaque",()=>this._setMaterialOverride(2)),i("view-mode-wireframe-transparent",()=>this._setMaterialOverride(1))}_switchToFpsView(){const e=this._controls.getYawAngle()/Math.PI*180,i=this._controls.getPitchAngle()/Math.PI*180,n=new hn({mode:Cs.FPS,position:this._controls.cameraWorldPosition().toArray(),rotation:[e,i],fov:this._teleport.lastDestinationView.fov,internal:!0});this._teleport.switchToView(n),this._onViewModeChanged("ViewModeType.FPS")}_setViewModeType(e){const i=this._internalViews.find(n=>n.name===e);i&&(i.orthographic=this._teleport.lastDestinationView.orthographic,this._teleport.switchToView(i),this._onViewModeChanged("ViewModeType."+e.toUpperCase()))}_setProjectionType(e){var l;const i=()=>{const c=this._controls.getYawAngle()/Math.PI*180,h=this._controls.getPitchAngle()/Math.PI*180;return[c,h]},n=e===1?this._scene.boundingBox.getBoundingSphere().radius:this._teleport.lastDestinationView.distance,s=e===1?Cs.ORBIT:this._teleport.lastDestinationView.mode,a=this._teleport.teleportingToView?this._teleport.lastDestinationView:new hn({position:this._controls.cameraWorldPosition().toArray(),rotation:i(),orthoFrustumSize:this._teleport.lastDestinationView.orthoFrustumSize,target:(l=this._teleport.lastDestinationView.target)==null?void 0:l.toArray(),mode:s,distance:n,internal:!0});a.orthographic=e===1,this._teleport.switchToView(a),this._onViewModeChanged("ProjectionType."+p0[e])}_setMaterialOverride(e){switch(e){case 0:this._removeMaterialOverride(),this._currentMaterialOverride=0;break;case 2:this._setWireframeMaterial(this._opaqueWireframeMaterial),this._currentMaterialOverride=2;break;case 1:this._setWireframeMaterial(this._transparentWireframeMaterial),this._currentMaterialOverride=1;break}this._onViewModeChanged("MaterialOverride."+m0[e])}_removeMaterialOverride(){this._currentMaterialOverride!==0&&(this._autoClearAlter.restore(),this._clearColorAlter.restore()),T.DEV_NEW_RENDER_ARCHITECTURE?pt.get().setWireframeMode(void 0):this._scene.gpuMeshes.forEach(e=>{e.materialOverride=null}),this._scene.skyMeshes.forEach(e=>{e.visible=!0}),this._animationController.requestFrame()}_setWireframeMaterial(e){if(this._currentMaterialOverride===0&&(this._autoClearAlter.set(!0,!1,!1),this._clearColorAlter.set(Fd().wireframeModeClearColor)),T.DEV_NEW_RENDER_ARCHITECTURE){const i=pt.get();i.setWireframeMode(e),this._scene.gpuMeshes.forEach(n=>{const s=ed(n);s.lineColor&&i.updateEntityStateById(n.entityId,Qr,{lineColor:s.lineColor,lineThickness:s.lineThickness,backsideLineThickness:s.backsideLineThickness})})}else this._scene.gpuMeshes.forEach(i=>{i.materialOverride=e,this._rawRenderer.uploadNewBuffers(i)});this._scene.skyMeshes.forEach(i=>{i.visible=!1}),this._animationController.requestFrame()}};o(vd,"eventType",_0);let td=vd;function nc(r){return r.reduce((t,e)=>Math.max(t,e.id),0)+1}function hP(r,t){return r.every(e=>e.name!==t)}function za(r,t){let e=r;for(let i=2;!hP(t,e);i+=1)e=r+i.toString();return e}function ep(r,t,e){t.name="",t.name=za(r,e)}function dP(r){return r.trim()||"light"}function g0(r){return r.trim()||"view"}function uP(r){return[Wn(Math.atan2(-r.x,r.y)),Wn(Math.asin(r.z))]}class fP{constructor(t,e,i,n,s,a,l,c,h,d,u,f,p){o(this,"scene");o(this,"menu");o(this,"controls");o(this,"collider");o(this,"teleport");o(this,"editorSelector");o(this,"extensionManager");o(this,"screenshotTaker");o(this,"animationController");o(this,"minimap");o(this,"autoTour");o(this,"sceneStats");o(this,"disableCache");o(this,"pauseLoadedVideoTextures");o(this,"textureManager");o(this,"skyLoader");o(this,"transformControls");o(this,"viewModeControls");o(this,"history");o(this,"materialLoader");o(this,"removedViewsToHiddenNodes",new Map);o(this,"_requestLiveLightmapUpdate",()=>{});this.scene=t,this.menu=e,this.controls=i,this.collider=n,this.teleport=s,this.editorSelector=a,this.extensionManager=l,this.screenshotTaker=c,this.animationController=h,this.minimap=d,this.autoTour=u,this.viewModeControls=f,this.materialLoader=p,this.sceneStats={geometryFacesCnt:this.scene.nodes.reduce((b,g)=>b+g.facesInSubtree(),0),objectsCnt:this._getObjectsCnt(),lightmapsCnt:this._getLightmapsCnt()},this.disableCache=!0,this.pauseLoadedVideoTextures=!1,this.textureManager=t.textureManager,this.skyLoader=new zf(this.textureManager),this.transformControls=this.editorSelector.transformControls,this.history=this.editorSelector.history;const m=()=>{this._requestLiveLightmapUpdate(),this.scene.liveLightmap.mode===qc.LIVE&&(this.scene.liveLightmap.mode=qc.BASIC)};this.scene.camera.addEventListener(At.eventType.POSITION_CHANGED,m),this.scene.camera.addEventListener(At.eventType.ROTATION_CHANGED,m),this.scene.camera.addEventListener(At.eventType.PHYSICAL_DIMENSIONS_CHANGED,m),this.scene.addEventListener(Hi.eventType.LIVE_LIGHTMAP_NEEDS_UPDATE,()=>this._requestLiveLightmapUpdate())}setLiveLightmapCallback(t){this._requestLiveLightmapUpdate=t}_getObjectsCnt(){let t=0;return this.scene.visitAllNodes(function(e){e.mesh&&t++}),t}_getLightmapsCnt(){let t=-1;return this.scene.visitAllNodes(function(e){e.mesh&&e.mesh.lightmapIdx>t&&(t=e.mesh.lightmapIdx)}),t+1}get screenAspectRatio(){return this.scene.camera.aspectRatio}get emissiveMaterialsLightEnabled(){return this.scene.emissiveMaterialsLightEnabled}set emissiveMaterialsLightEnabled(t){this.scene.emissiveMaterialsLightEnabled=t}setLiveLightmap(t){this.scene.liveLightmap.mode=qc.LIVE,this.scene.liveLightmap.set(t)}getLightmapLayoutVersion(){return this.scene.lightmapLayoutVersion}getExtensionManager(){return this.extensionManager}getCameraPosition(){const t=this.controls.cameraWorldPosition();return[t.x,t.y,t.z]}getCameraRotation(){return[Wn(this.controls.getYawAngle()),Wn(this.controls.getPitchAngle())]}getPointInFrontOfTheCamera(t=1){const e=this.collider.distanceToObstacle(t);e<t&&(t=e);const i=this.controls.cameraWorldPosition(),n=this.controls.getYawAngle(),s=this.controls.getPitchAngle(),a=t*Math.cos(s)*Math.sin(n),l=t*Math.cos(s)*Math.cos(n),c=t*Math.sin(s),h=i.x-a,d=i.y+l,u=i.z+c;return[h,d,u]}getCamera(){return this.scene.camera}getSceneStats(){return this.sceneStats}getMaterials(){return this.scene.materialManager.materials.slice(0)}getLights(){return this.scene.lights}getLightProbes(){return this.scene.lightProbes}getCameraVolumes(){return this.scene.cameraVolumes}getNodes(){return this.scene.nodes}getNodesForMaterial(t){const e=new Array;return this.scene.visitAllNodes(i=>{var n;((n=i.mesh)==null?void 0:n.material)===t&&e.push(i)}),e}getMinimap(){return this.minimap}getMinimapConfig(){return this.scene.minimapConfig}setLevelSelectedCallback(t){this.minimap.addEventListener(Bh.eventType.LEVEL_SELECTED,e=>{e.level!==null&&t(e.level)})}getBoundingBox(){return this.scene.boundingBox}addLight(t){this.scene.addLight(t)}createLight(t,e,i){const n=new On({name:za(t,this.scene.lights),type:e,doNotImport:!0});return n.addInstance(i),n}removeLight(t){this.scene.removeLight(t)}renameLight(t,e){ep(dP(e),t,this.scene.lights)}createLightInstance(t,e,i=[0,-90,0]){const n=new L().fromArray(e),s=new Fi().setFromDegTriple(i);return new Jc(t,n,s)}addLightInstance(t){console.assert(this.scene.lights.some(e=>e===t.light)),t.light.addCreatedInstance(t)}cloneLightInstance(t){const e=this.createLightInstance(t.light,[0,0,0]);return this.cloneIntoLightInstance(e,t),e}cloneIntoLightInstance(t,e){t.position.copyFrom(e.position),t.rotation.copyFrom(e.rotation)}removeLightInstance(t,e){t.removeInstance(e)}addLightProbe(t){console.assert(this.scene.lightProbes.every(e=>e.id!==t.id)),this.scene.addLightProbe(t),this.scene.lightProbes.length===1&&this.scene.enableLightProbesForMaterials()}createLightProbe(t){const e=new nn({id:nc(this.scene.lightProbes),position:t});return e.enableBoundingBox(),e}cloneLightProbe(t){const e=this.createLightProbe([0,0,0]);return this.cloneIntoLightProbe(e,t),e}cloneIntoLightProbe(t,e){const i=e.position.toArray();t.setPosition(...i),t.setBoxMin(...e.boxMin.toArray()),t.setBoxMax(...e.boxMax.toArray()),e.isBoundingBoxEnabled()||t.disableBoundingBox(),t.id=nc(this.scene.lightProbes)}removeLightProbe(t){this.scene.removeLightProbe(t),this.scene.lightProbes.length===0&&this.scene.disableLightProbesForMaterials()}getCameraVolumeTypes(){return Object.values(Zc)}createCameraVolume(t,e){const i=new L().fromArray(this.getCameraPosition()),n=this.getCameraRotation(),s=new L(0,3,0);new Fi(n[0]/180*Math.PI,n[1]/180*Math.PI,0).applyToVector3(s);const l=nc(this.scene.cameraVolumes);return Ce(t===Zc.CUBE||t===Zc.SPHERE),new kf({id:l,name:e||t+l,type:t,position:i.add(s).toArray(),rotation:[0,0,0],scale:[1,1,1],exposure:this.scene.camera.defaultExposure,gamma:this.scene.camera.defaultGamma},this.scene.camera,this.scene.exposureController)}addCameraVolume(t){console.assert(this.scene.cameraVolumes.every(e=>e.id!==t.id)),t.name=za(t.name,this.scene.cameraVolumes),t.reinstate(),this.scene.addCameraAdjustmentVolume(t)}cloneCameraVolume(t){const e=this.createCameraVolume(t.getCameraVolumeTrigger().volumeType);return this.cloneIntoCameraVolume(e,t),e}cloneIntoCameraVolume(t,e){const i=e.getCameraVolumeTrigger(),n=t.getCameraVolumeTrigger();n.position.copyFrom(i.position),n.rotation.copyFrom(i.rotation),n.scale.copyFrom(i.scale),t.exposure=e.exposure,t.gamma=e.gamma}removeCameraVolume(t){this.scene.removeCameraVolume(t)}shiftCameraVolume(t,e){this.scene.shiftCameraVolume(t,e)}getCameraVolumesIndex(t){return this.scene.cameraVolumes.findIndex(e=>e===t)}getViews(){return this.scene.views}markScreenshotArea(t){this.screenshotTaker.markArea(t)}unmarkScreenshotArea(){this.screenshotTaker.unmarkArea()}monoScreenToBuffer(t,e,i){return this.screenshotTaker.monoScreenToBuffer(t,e,i)}stereoPanoramaToBuffer(t,e,i,n){this.screenshotTaker.stereoPanoramaToBuffer(t,e,i,n)}_fillParamsForTopViewType(t){const e=this.controls.orbit,i=this.controls.cameraWorldPosition();t.mode=Cs.ORBIT,t.sky=T.DEFAULT_SKY_NAME,t.panPrimary=!0,t.noPitchRotate=!0,Ce(t.rotation),t.rotation[1]=-90,t.minUpAngle=0,t.maxUpAngle=Math.PI/2,e.isEnabled()?(t.target=[e.target.x,e.target.y,this.scene.boundingBox.min.z],t.distance=e.getCameraDistance(),t.minDistance=e.getMinDistance(),t.maxDistance=e.getMaxDistance()):(t.target=[i.x,i.y,this.scene.boundingBox.min.z],t.distance=Math.max(i.z-this.scene.boundingBox.min.z,1))}_fillParamsForOrbitViewType(t){const e=this.controls.orbit,i=this.controls.cameraWorldPosition();if(t.mode=Cs.ORBIT,t.sky=T.DEFAULT_SKY_NAME,t.panPrimary=!1,t.noPitchRotate=!1,e.isEnabled())t.target=e.target.toArray(),t.distance=e.getCameraDistance(),t.minDistance=e.getMinDistance(),t.maxDistance=e.getMaxDistance(),t.minUpAngle=-e.getMaxPitchAngle(),t.maxUpAngle=-e.getMinPitchAngle(),t.noPan=e.getNoPan();else{t.minUpAngle=0,t.maxUpAngle=Math.PI/2;const n=this.scene.boundingBox.center();t.target=n.toArray();const s=n;s.sub(i),t.distance=s.length(),s.normalize(),t.rotation=uP(s),t.rotation[1]=Yi(t.rotation[1],-t.maxUpAngle,t.minUpAngle)}}createViewFromCamera(t,e){const i=[0,0];i[0]=Wn(this.controls.getYawAngle()),i[1]=Wn(this.controls.getPitchAngle());const n={id:nc(this.scene.allViews()),name:za(g0(t),this.scene.allViews()),rotation:i};if(e==="fps"){const s=this.controls.cameraWorldPosition();n.mode=Cs.FPS,n.sky=T.EDITOR_CONTROLLED_SKY_NAME,n.position=s.toArray()}else e==="top"?this._fillParamsForTopViewType(n):this._fillParamsForOrbitViewType(n);return new hn(n)}addView(t){console.assert(this.scene.allViews().every(i=>i.id!==t.id)),t.name=za(t.name,this.scene.allViews());const e=this.removedViewsToHiddenNodes.get(t);if(e){for(const i of e)i.isOnHideInViews(t.id)||i.addToHideInViews(t.id);this.removedViewsToHiddenNodes.delete(t)}this.scene.addView(t)}cloneView(t){const e=this.createViewFromCamera("","fps");return this.cloneIntoView(e,t),e}cloneIntoView(t,e){Object.assign(t,new hn(e.serialize())),t.id=nc(this.scene.allViews()),this.scene.nodeConfigs.forEach(function(i){i.hideInViews&&i.isOnHideInViews(e.id)&&i.addToHideInViews(t.id)})}resetViewFromCamera(t){const e=this.controls.cameraWorldPosition();t.mode===Cs.FPS?t.position.copyFrom(e):(t.target.copyFrom(this.controls.orbit.target),t.distance=e.distanceTo(t.target)),(t.mode===Cs.FPS||!t.isTop())&&(t.rotation.pitch=this.controls.getPitchAngle()),t.setYaw(this.controls.getYawAngle())}removeView(t){const i=this.scene.nodeConfigs.filter(n=>n.hideInViews&&n.isOnHideInViews(t.id));this.removedViewsToHiddenNodes.set(t,i),this.scene.removeView(t)}shiftView(t,e){this.scene.shiftView(t,e)}getViewsIndex(t){return this.scene.views.findIndex(e=>e===t)}activateSkyForView(t){this.teleport.activateSky(t)}setCameraPosition(t,e,i){this.controls.cameraWorldPosition().set(t,e,i),this.controls.cameraPositionUpdated()}isTeleporting(){return this.teleport.teleportingToView||this.teleport.teleportingToPoint}switchToView(t,e){this.autoTour.isRunning()&&this.autoTour.stop(),this.teleport.switchToView(t,e),Bo()}renameView(t,e){ep(g0(e),t,this.scene.allViews())}updateHiddenMeshes(t){this.teleport.updateHiddenMeshes(t)}getSky(){return this.scene.findSkyMesh(T.EDITOR_CONTROLLED_SKY_NAME)}loadSkyTexture(t){return this.skyLoader.loadSkyTexture(t)}loadTexture(t,e){Ce(typeof t.id=="string"),this.textureManager.remove(t.id);const i=this.textureManager.load(t,En.REPEAT_WRAPPING|En.GENERATE_MIPS,T.LOAD_PRIORITY.CORE_RESOURCE,!0);return e===cn.BASE_COLOR&&(i.isCutout=void 0),i}materialTextureUpdated(t,e){const n=new Set;let s="";const a=function(l){const c=l.geometry;if(!(c.vertexCnt===0||c.hasAttribute("uv0"))&&!n.has(l.node.type)){if(n.add(l.node.type),n.size>5)return;s+=s.length>0?", ":"",s+=`'${l.node.type}'`}};return t.textureNeedsUv0(e)&&this.scene.visitMeshesWithMaterial(t,a),n.size===0?!1:`Texture ${e} won't be correctly mapped. The following objects lack base color UV mapping coming from the 3D modeling tool: ${s} `+(n.size>5?` (plus ${n.size-5} more).`:".")}changeSkyTexture(t){const e=this.scene.findSkyMesh(T.EDITOR_CONTROLLED_SKY_NAME),i=this.scene.sharedMaterialState.fog;if(!t&&e.type===io.EQUIRECT){this.scene.removeSkyMesh(e);const n={name:T.EDITOR_CONTROLLED_SKY_NAME,type:io.PROCEDURAL};this.skyLoader.loadSingleSky(n,this.scene,i)}else if(Ce(t),e.type===io.PROCEDURAL){this.scene.removeSkyMesh(e);const n={name:T.EDITOR_CONTROLLED_SKY_NAME,type:io.EQUIRECT,texture:t};this.skyLoader.loadSingleSky(n,this.scene,i)}else e.setTexture(t);this.scene.adjustSkiesAndCameraFarToSpanWholeScene()}getColorMapName(){return this.scene.camera.colorMap?this.scene.camera.colorMap.name:void 0}loadColorMap(t){return this.textureManager.loadColorMap(t)}getSceneJson(){return this.scene.serialize()}getCoverJson(){const t=this.menu.cover;return t.extensions=this.extensionManager.getConfigs(),t}getSelectionMode(){return this.editorSelector.selectionMode}disableSelection(){this.editorSelector.setSelectionMode(Ut.SelectionMode.OFF)}enableMaterialSelection(){this.editorSelector.setSelectionMode(Ut.SelectionMode.MATERIAL)}enableLightSelection(){this.editorSelector.setSelectionMode(Ut.SelectionMode.LIGHT)}enableLightProbeSelection(){this.editorSelector.setSelectionMode(Ut.SelectionMode.LIGHT_PROBE)}enableExtensionSelection(){this.editorSelector.setSelectionMode(Ut.SelectionMode.EXTENSION)}enablePositionSelection(t){this.editorSelector.setDistanceToObject(t),this.editorSelector.setSelectionMode(Ut.SelectionMode.POSITION)}enableNodeSelection(){this.editorSelector.setSelectionMode(Ut.SelectionMode.NODE)}enableCameraVolumeSelection(){this.editorSelector.setSelectionMode(Ut.SelectionMode.CAMERA_VOLUME)}selectMaterial(t){this.editorSelector.selectMaterial(t)}changeMaterialType(t,e){const i=this.scene.materialManager.changeMaterialType(t,e);return i.isAnimated&&i.play(),i}selectLights(t,e){this.editorSelector.selectLights(t,e)}selectLightInstances(t,e,i){this.editorSelector.selectLightInstances(t,e,i)}selectLightProbe(t){this.editorSelector.selectLightProbe(t)}selectCameraVolumeTrigger(t){this.editorSelector.selectCameraVolumeTrigger(t)}selectExtension(t){this.editorSelector.selectExtension(t)}selectNodes(t,e,i,n){this.editorSelector.selectNodes(t,e,i,n)}setMaterialClickedCallback(t){this.editorSelector.setMaterialClickedCallback(t)}setLightInstanceClickedCallback(t){this.editorSelector.setLightInstanceClickedCallback(t)}setLightProbeClickedCallback(t){this.editorSelector.setLightProbeClickedCallback(t)}setNodeClickedCallback(t){this.editorSelector.setNodeClickedCallback(t)}setExtensionClickedCallback(t){this.editorSelector.setExtensionClickedCallback(t)}setPositionClickedCallback(t){this.editorSelector.setPositionClickedCallback(t)}setItemModifiedCallback(t){this.transformControls.setItemModifiedCallback(t)}setViewSelectedCallback(t){this.teleport.addEventListener(ps.eventType.TELEPORT_STARTED,e=>{e.view&&t(e.view)})}coverModified(t){this.menu.updateCover(t)}autoTourModified(){this.menu.refresh()}hasLightmap(){return this.scene.hasLightmap()}getAutoTour(){return this.scene.autoTour}getDisableProgressiveLoader(){return this.scene.disableProgressiveLoader}setDisableProgressiveLoader(t){this.scene.disableProgressiveLoader=t}getInteractionPrompt(){return this.scene.interactionPrompt}setInteractionPrompt(t){this.scene.interactionPrompt=t}getTransformMode(){return this.transformControls.mode}setTransformMode(t){this.transformControls.setTransformMode(t)}getSupportedTransformModes(){return this.transformControls.supportedModes}seeItem(t){rn().seeItem(t)}onViewModeChanged(t){this.viewModeControls.addEventListener(td.eventType.VIEW_MODE_CHANGED,e=>t(e.viewMode))}getMeshAtPosition(t,e){const i=t/window.innerWidth*2-1,n=-(e/window.innerHeight)*2+1;return this.editorSelector.getMeshAtPosition(i,n)}getMaterialOverriddenNodeConfigs(t){return this.scene.materialManager.getOverriddenConfigs(t)}removeMaterialOverrideForNodeType(t){this.scene.materialManager.removeMaterialOverrideForNodeType(t)}overrideMaterialForNodeType(t,e){this.scene.materialManager.overrideMaterialForNodeType(t,e),this.animationController.requestFrame()}cloneMaterial(t){const e=t.serialize();return e.id=void 0,e.materialLibraryHash=void 0,this.createNewMaterial(e,_r.EDITOR)}replaceMaterialForMaterial(t,e){const i=t.name,n=t.getTextures();for(const s of n.keys())t.setTexture(s,void 0);e.id=void 0,this.materialLoader.setMaterialFromJson(t,e),t.name=i,this.animationController.requestFrame()}addMaterial(t,e){this.scene.materialManager.addMaterial(t,e)}renameMaterial(t,e){t.source,_r.EDITOR,ep(e,t,this.scene.materials)}removeMaterial(t){this.scene.materialManager.removeMaterial(t)}createNewMaterial(t,e){[_r.EDITOR,_r.MATERIAL_LIBRARY].includes(e);const i=this.materialLoader.getMaterial(t,e);return t===void 0&&(i.name="Editor Material"),i.name=za(i.name,this.scene.materials),i}}class v0{constructor(){o(this,"onSceneLoaded");o(this,"enableCollisions");o(this,"forcedInitialCameraPosition");o(this,"forcedInitialCameraRotation");o(this,"sendCoverToServer");this.onSceneLoaded=void 0,this.enableCollisions=!0,this.forcedInitialCameraPosition=void 0,this.forcedInitialCameraRotation=void 0,this.sendCoverToServer=!1}}class pP extends bt{constructor(){super({vsName:"static_render_vertex.glsl",fsName:"static_render_fragment.glsl"}),this.uniforms={staticRender:{type:"t",value:null,uniformSourceType:oe.MATERIAL},sizeInv:{type:"v2",value:new ye,uniformSourceType:oe.GLOBAL}}}}function mP(r){const t=R_(r,{antialias:!1});return t.autoClear=!1,t.sortObjects=!1,t}class _P{constructor(t){o(this,"_material",new pP);o(this,"_camera",An.createNDC());o(this,"_scene",new pl);o(this,"_renderer");this._renderer=mP(t);const e=new je(ft.createPlane(2,2),this._material);this._renderer.uploadNewBuffers(e),this._scene.add(e)}update(t){const e=new Float32Array(t,0,t.byteLength/4),i=e[1],n=e[2],s=e.subarray(3);i*n,s.length/3;const a=st.newDataTexture(s,i,n,Ke.RGB32F);a.minFilter=H.NEAREST,a.magFilter=H.NEAREST,a.generateMipmaps=!1,a.flipY=!1,a.needsUpdate=!0,this._material.uniforms.staticRender.value=a,this._material.uniforms.sizeInv.value.set(1/i,1/n),this._renderer.setCanvasSize(i,n),this._renderer.render(this._scene,this._camera),a.dispose()}}function gP(){T.Viewer=Pv,T.View=hn,T.getViewer=rn,T.getExtraAssetUrl=Ja,T.initEditMode=NS,T.ColorUtils=cr,T.TRANSFORM_MODE=ui,T.STRINGS=Bd,T.ICONS=oh,T.StaticRenderViewer=_P,T.SceneLoadConfig=v0,T.init=Vv,T.updateViewerStrings=Ip,T.getViewerStrings=Cb,T.hasShiftKeyModifier=Zx,T.hasCtrlEquivalentKeyModifier=Jx,T.hasAltEquivalentModifier=eE,T.StandardMaterial=Qt,window.WALK=T,window.WebXRConfig=hh}function vP(){const r=this,t=new L,e=new L,i=new L,n=new L,s=new L;this.objects=[];let a=null;this.vertices=[],this.normals=[],this.uvs=[],this.startObject=function(p){a={name:p||"",vertices:[],normals:[],uvs:[],hasUvs:!1},this.objects.push(a)};function l(p,m,b){return(p>=0?p-1:p+m/b)*b}function c(p,m,b){const g=r.vertices,x=a.vertices;x.push(g[p+0],g[p+1],g[p+2]),x.push(g[m+0],g[m+1],g[m+2]),x.push(g[b+0],g[b+1],g[b+2])}function h(p,m,b){const g=r.normals,x=a.normals;x.push(g[p+0],g[p+1],g[p+2]),x.push(g[m+0],g[m+1],g[m+2]),x.push(g[b+0],g[b+1],g[b+2])}function d(p,m,b){const g=r.vertices,x=a.normals;t.fromArray(g,p),e.fromArray(g,m),i.fromArray(g,b),s.subVectors(i,e),n.subVectors(t,e),s.cross(n),s.normalize(),x.push(s.x,s.y,s.z),x.push(s.x,s.y,s.z),x.push(s.x,s.y,s.z)}function u(p,m,b){const g=r.uvs,x=a.uvs;x.push(g[p+0],g[p+1]),x.push(g[m+0],g[m+1]),x.push(g[b+0],g[b+1])}function f(){const p=a.uvs;p.push(0,0),p.push(0,0),p.push(0,0)}this.addFace=function(p,m,b,g,x,w,C,M,D){const W=this.vertices.length,z=l(p,W,3),$=l(m,W,3),Z=l(b,W,3);if(c(z,$,Z),C!==void 0){const ne=this.normals.length;h(l(C,ne,3),l(M,ne,3),l(D,ne,3))}else d(z,$,Z);if(g!==void 0){const ne=this.uvs.length;u(l(g,ne,2),l(x,ne,2),l(w,ne,2)),a.hasUvs=!0}else f()}}function bP(r){return r.indexOf(`\r
`)!==-1&&(r=r.replace(/\r\n/g,`
`)),r.indexOf(`\\
`)!==-1&&(r=r.replace(/\\\n/g,"")),r}function Rr(r){if(!(r===void 0||r===""))return parseInt(r,10)}function yP(r){const t=/^[og]\s*(.+)?/,e=/^mtllib /,i=/^usemtl /,n=/^usemap /,s=new vP;r=bP(r);const a=r.split(`
`);let l=[];for(const h of a){if(h.length===0||h==="\0")continue;const d=h.charAt(0);if(d!=="#")if(d==="v"){const u=h.split(/\s+/);switch(u[0]){case"v":s.vertices.push(parseFloat(u[1]),parseFloat(u[2]),parseFloat(u[3])),u.length>=7&&console.assert(!1,"obj with vertex colors is not supported");break;case"vn":s.normals.push(parseFloat(u[1]),parseFloat(u[2]),parseFloat(u[3]));break;case"vt":s.uvs.push(parseFloat(u[1]),parseFloat(u[2]));break}}else if(d==="f"){const f=h.substr(1).trim().split(/\s+/),p=[];for(const b of f)if(b.length>0){const g=b.split("/");p.push(g)}const m=p[0];for(let b=1,g=p.length-1;b<g;b++){const x=p[b],w=p[b+1];s.addFace(Rr(m[0]),Rr(x[0]),Rr(w[0]),Rr(m[1]),Rr(x[1]),Rr(w[1]),Rr(m[2]),Rr(x[2]),Rr(w[2]))}}else if(d==="l")console.assert(!1,"line geometry is not supported");else if(d==="p")console.assert(!1,"obj point geometry not supported");else if((l=t.exec(h))!==null){const u=(" "+l[0].substr(1).trim()).substr(1);s.startObject(u)}else i.test(h)||e.test(h)||n.test(h)||d==="s"||console.warn('OBJLoader: Unexpected line: "'+h+'"')}const c=new Map;for(const h of s.objects){if(h.vertices.length===0)continue;const d=new tn;d.addAttribute("position",new Dt(new Float32Array(h.vertices),3)),h.normals.length>0&&d.addAttribute("normal",new Dt(new Float32Array(h.normals),3)),h.hasUvs===!0&&d.addAttribute("uv0",new Dt(new Float32Array(h.uvs),2)),d.convertNormalsToSpherical(),d.computeBoundingBox(),d.computeBoundingSphere(),c.set(h.name,d)}return c}let rt={};function xP(r){for(;r.firstChild;)r.removeChild(r.firstChild)}function EP(r,t){const e=document.getElementById(r);e.onchange=t}function id(r){r.style.display=""}function nd(r){r.style.display="none"}function AP(r,t){t?id(r):nd(r)}function TP(r,t){t?r.classList.add("ext-meeting-button-highlight"):r.classList.remove("ext-meeting-button-highlight")}function wP(r){r.classList.add("ext-meeting-input-missing"),window.setTimeout(()=>{r.classList.remove("ext-meeting-input-missing")},200)}function SP(r){r.classList.add("ext-meeting-text-highlighted"),window.setTimeout(()=>{r.classList.remove("ext-meeting-text-highlighted")},200)}function Os(r){let t=null,e=null;this.showDismiss=!0,this.onClose=null,this.onDismiss=null,this.position=Os.DEFAULT,this.foremost=!1,this.modal=!1,this.open=function(){e===null&&(this.modal?(t=document.createElement("div"),t.className="modal-backdrop",document.body.appendChild(t),e=document.createElement("div"),t.appendChild(e)):(e=document.createElement("div"),document.body.appendChild(e)),this.update(r))},this.hide=function(){nd(t||e)},this.unhide=function(){id(t||e)},this.update=function(i){const n=this.showDismiss?`<div class="ext-popup-close-button-panel ui-close-hoverable">
           <div class="ext-popup-close-button"></div>
         </div>`:"",a=(()=>{switch(this.position){case Os.TOP:return"ui-top ui-center";case Os.DEFAULT:return"ui-upper-half-center";case Os.CENTER:return"ui-all-center";default:return console.log(`Invalid popup position: ${this.position}`),"ui-all-center"}})(),l=this.foremost?"ui-foremost":"";if(To(e,`
       <div class="ext-popup ${a} ${l}">
         <div class="ext-popup-content">
           ${i}
         </div>${n}
       </div>`),lh(e),this.showDismiss){const c=e.getElementsByClassName("ext-popup-close-button-panel")[0];Ss(c,()=>this.dismiss())}},this.getElementsByClassName=function(i){return e.getElementsByClassName(i)},this.dismiss=function(){e!==null&&(this.close(),this.onDismiss&&this.onDismiss())},this.close=function(){e!==null&&(this.modal?(document.body.removeChild(t),t=null):document.body.removeChild(e),e=null,this.onClose&&this.onClose())}}Os.CENTER="center",Os.DEFAULT="default",Os.TOP="top";function MP(r,t){let e="";t&&(e=`<h3 class="ext-meeting-dialog-title">${t}</h3>`),e+=`
      <div class="ext-meeting-dialog-message">
        ${r}
      </div>
      <div class="ext-meeting-dialog-buttons">
        <button class="ext-meeting-button" data-strings="meetings.close">
        </button>
      </div>
    `;const i=new Os(e);i.showDismiss=!1,i.foremost=!0,i.modal=!0,i.open();const n=i.getElementsByClassName("ext-meeting-button")[0];n.onclick=()=>{i.close()}}function PP(r,t,e){const i=`
      <div class="ext-meeting-dialog-iframe-container">
        <h3 class="ext-meeting-dialog-title">${r}</h3>
        <iframe src="${t}" class="ext-meeting-dialog-iframe">
        </iframe>
        <div>
          <div class="ext-meeting-dialog-buttons">
            <button class="ext-meeting-button" data-strings="meetings.close">
            </button>
          </div>
        </div>
      <div>
    `,n=new Os(i);n.showDismiss=!1,n.position=Os.CENTER,n.onClose=e,n.open();const s=n.getElementsByClassName("ext-meeting-dialog-iframe")[0];s.style.visibility="hidden",s.onload=()=>{s.style.visibility="visible"};const a=n.getElementsByClassName("ext-meeting-button")[0];a.onclick=()=>n.close()}rt={removeChildren:xP,addChangeHandler:EP,show:id,hide:nd,setVisibility:AP,setButtonHighlight:TP,highlightInput:wP,highlightText:SP,UiPopup:Os,showMessage:MP,showIframePopup:PP};let sc={},tp=null;function ip(){if(tp===null){const r=window.AudioContext||window.webkitAudioContext;tp=new r}return tp}class lo{constructor(t,e,i){this._frequencyDiv=e,this._noSoundThreshold=i,this._minFrequencyIndex=-1,this._maxFrequencyIndex=-1,this._noSoundCalls=0,this._source=null,this._analyser=ip().createAnalyser(),this._analyser.fftSize=this._frequencyDiv*2,this._analyser.smoothingTimeConstant=.5;const n=new MediaStream([t.mediaStreamTrack]);this._source=ip().createMediaStreamSource(n),this._source.connect(this._analyser);const s=ip().sampleRate/this._frequencyDiv;this._minFrequencyIndex=Math.floor(lo._minVoiceFrequency/s),this._maxFrequencyIndex=Math.floor(lo._maxVoiceFrequency/s),this._dataArray=new Uint8Array(this._maxFrequencyIndex+1)}measureSoundVolume(){const t=this._getOverallSoundVolume();return this._shouldSkipNoSoundNotification(t)?null:t}dispose(){this._source!==null&&(this._source.disconnect(),this._source=null)}_getOverallSoundVolume(){this._analyser.getByteFrequencyData(this._dataArray);let t=0;for(let e=this._minFrequencyIndex;e<=this._maxFrequencyIndex;e++)this._dataArray[e]>t&&(t=this._dataArray[e]);return t}_shouldSkipNoSoundNotification(t){return t<this._noSoundThreshold?(this._noSoundCalls++,this._noSoundCalls<lo._skippedNoSoundCalls):(this._noSoundCalls=0,!1)}}lo._minVoiceFrequency=85,lo._maxVoiceFrequency=350,lo._skippedNoSoundCalls=3;class Fs{constructor(t,e,i,n){this._width=t,this._height=e,this._bottomMargin=n!==void 0?n:0,this._volumeRect=null,this._rectId=Fs._baseRectId+Fs._counter,Fs._counter++,this._noSoundThreshold=i,this._lengthCoef=t/(255-this._noSoundThreshold)}getHTML(){return this._volumeRect=null,`
        <svg style="filter: drop-shadow(0px 0px 1px black);
                    margin-bottom: ${this._bottomMargin.toString()}px;"
             width="${this._width.toString()}px"
             height="${this._height.toString()}px">
          <rect id="${this._rectId}"
                x = "${(this._width/2-1).toString()}" y = "0"
                width="${1 .toString()}"
                height="${this._height.toString()}"
                fill="red"/>
        </svg>
      `}getEmptyHTML(){return`
        <svg width="${this._width.toString()}px"
             height="${this._height.toString()}px">
        </svg>
      `}update(t){if(this._volumeRect===null&&(this._volumeRect=document.getElementById(this._rectId)),console.assert(this._volumeRect!==null,"Volume visualizer HTML not attached to any element"),t===null)return;const e=this._getColor(t),i=Math.max(t,this._noSoundThreshold),n=Math.max(Fs._minimalDisplayedValue,i-this._noSoundThreshold),s=this._width/2-n*this._lengthCoef/2,a=n*this._lengthCoef;this._volumeRect.setAttribute("fill",e),this._volumeRect.setAttribute("x",s.toString()),this._volumeRect.setAttribute("width",a.toString())}_getColor(t){return t<this._noSoundThreshold?"red":t<Fs._lowSoundThreshold?"orange":"green"}}Fs._counter=0,Fs._baseRectId="ext-meeting-mic-bar-",Fs._lowSoundThreshold=180,Fs._minimalDisplayedValue=20,sc={VolumeMeter:lo,VolumeVisualizer:Fs};let b0;const CP=2e3,y0={MICROPHONE:"microphone",CAMERA:"camera"},rc={name:"mic"},oc={name:"camera",facingMode:"user",width:480,height:360,frameRate:24};function x0(r,t){return t===void 0?r.type:(r.type,t.type,"microphoneAndCamera")}function E0(r,t){const e=x0(r,t),i=r.error.name;return console.assert(t===void 0||t.error.name===i),Bt(i==="NotFoundError"?`meetings.devicesNotFound.${e}`:i==="NotAllowedError"?`meetings.devicesBlocked.${e}`:i==="Error"?"meetings.error":`meetings.devicesNotAvailable.${e}`)}function A0(r,t){const e=t!==void 0,i=e?"twoDevices":"oneDevice",n=r.error.name;if(n==="NotFoundError"){const s=x0(r,t);return Bt(`meetings.checkIfDevicesConnected.${s}`)}else if(n==="NotAllowedError")if($e.mobile)if($e.ios){const s=e?`${r.unblockIcon} ${Bt("meetings.and")} ${t.unblockIcon}`:r.unblockIcon;return`<span>
          ${Bt(`meetings.unblockDevices.byButtons.${i}.beforeIcons`)}
          ${s}
          ${Bt(`meetings.unblockDevices.byButtons.${i}.afterIcons`)}
        </span>`}else return Bt(`meetings.unblockDevices.inBrowserSettings.${i}`);else{const s=e?t.unblockIcon:r.unblockIcon;return`<span>
        ${Bt(`meetings.unblockDevices.byButtonInAddressBar.${i}.beforeIcon`)}
        ${s}
        ${Bt(`meetings.unblockDevices.byButtonInAddressBar.${i}.afterIcon`)}
      </span>`}else return Bt(n==="Error"?"meetings.browserDoesNotSupportMeetings":`meetings.ifConnectedCloseAppsAndRefresh.${i}`)}class RP{constructor(t,e,i,n){this._firstErrorDiv=document.getElementById(t),this._secondErrorDiv=document.getElementById(e),this._devicePreview1=i,this._devicePreview2=n}_reset(){this._devicePreview1.setErrorDiv(null),this._devicePreview2.setErrorDiv(null),rt.removeChildren(this._firstErrorDiv),rt.removeChildren(this._secondErrorDiv)}_displayAndLogErrorMessage(t,e,i){function n(c){if(c!==void 0)return c.device}const s=E0(e.device,n(i)),a=A0(e.device,n(i)),l=`
        <div class="ext-meeting-join-error-title">${s}</div>
        <div class="ext-meeting-join-error-description">${a}</div>
      `;To(t,l),e.setErrorDiv(t),e.device.logError(),i!==void 0&&(i.setErrorDiv(t),i.device.logError())}update(){this._reset();const t=this._devicePreview1.device.error,e=this._devicePreview2.device.error;t===null&&e===null||(t!==null&&e!==null?t.name===e.name?this._displayAndLogErrorMessage(this._firstErrorDiv,this._devicePreview1,this._devicePreview2):(this._displayAndLogErrorMessage(this._firstErrorDiv,this._devicePreview1),this._displayAndLogErrorMessage(this._secondErrorDiv,this._devicePreview2)):t!==null?this._displayAndLogErrorMessage(this._firstErrorDiv,this._devicePreview1):this._displayAndLogErrorMessage(this._firstErrorDiv,this._devicePreview2))}}class IP{constructor(t,e){this._type=t,this._active=!1,this._unblockIcon=e,this._trackOptions=null,this._track=null,this._error=null}get type(){return this._type}get track(){return this._track}set track(t){this._track=t}get active(){return this._active}set active(t){this._active=t}get unblockIcon(){return this._unblockIcon}logError(){this._error!==null&&Re.log(`Can't create local ${this.type} track : ${this._error.name}, ${this._error.message}`)}get error(){return this._error}set error(t){this._error=t}get trackOptions(){return this._trackOptions}set trackOptions(t){this._trackOptions=t}_getLabel(){return this._track?this._track.mediaStreamTrack.label:null}getId(){return this._trackOptions&&this._trackOptions.deviceId?this._trackOptions.deviceId.exact:null}getErrorMessageInfo(){if(this._error===null)return null;const t=E0(this),e=A0(this);return{title:t,description:e}}}class T0{constructor(t,e,i,n,s,a,l){this._device=new IP(t,l),this._width=i,this._height=n,this._toggleButton=document.getElementById(s),this._previewContainer=document.getElementById(a),this._errorDiv=null,this._meetingStarter=e,Ki(this._toggleButton.id,this._onToggleButtonClicked.bind(this)),this._onStoppedBound=this._onStopped.bind(this),this._twilioCreateTrackFunction=null}get device(){return this._device}isAvailable(){return this._device.track!==null}dispose(){this._device.track!==null&&this._device.track.removeListener("stopped",this._onStoppedBound),this._close()}_pauseMonitoringTrackBeforeReset(){this._device.track.removeListener("stopped",this._onStoppedBound)}_resumeMonitoringTrackAfterReset(){this._device.track.addListener("stopped",this._onStoppedBound)}setErrorDiv(t){this._errorDiv=t}showInTestNeededMode(){this.setError({name:"Test needed"})}showInPreviewMode(){this.setError({name:"Initializing"}),this.setToggleButtonVisibility(!0)}createTrack(t){return new Promise((e,i)=>{const n=t||this._device.trackOptions;this._twilioCreateTrackFunction(as(n)).then(s=>{this.setTrack(s,n)}).catch(s=>{this.setTrack(null,n,s)}).finally(()=>{this._toggleButton.disabled=!1,e()})})}updateTrackDeviceId(t){const e=(i,n)=>{const s=i.find(a=>a.label===n);return s?s.deviceId:null};if(this._device.track&&!this._device.trackOptions.deviceId){const i=this._device._getLabel(),n=e(t,i);console.assert(n!==null,"deviceId not found"),this._device.trackOptions={name:this._device.trackOptions.name,deviceId:{exact:n}}}}setTrack(t,e,i){e&&(this._device.trackOptions=e),t!==null&&i!==void 0?console.assert("Invalid setTrack parameters : track and error set"):t===null&&i===void 0&&console.assert("Invalid setTrack parameters : track and error not set"),this._disposeTrack(),this._device.track=t,this._device.track!==null?(this._device.track.on("stopped",this._onStoppedBound),this._device.active=!0,this._showTrack(),this.setError(null)):(this._device.active=!1,this._hideTrack(),this.setError(i)),this._meetingStarter.updateErrorMessage(),this._updateToggleButtonState()}setError(t){this._device.error=t}restartTrack(t){this._toggleButton.disabled=!0,this.isAvailable()?(this._pauseMonitoringTrackBeforeReset(),this._device.trackOptions=t,this._device.track.restart(as(t)).then(()=>{this._resumeMonitoringTrackAfterReset(),this._meetingStarter.updateErrorMessage(),this._toggleButton.disabled=!1}).catch(e=>{Re.log(`Second attempt to create track,device: ${this._device.type}`),window.setTimeout(()=>this.createTrack(t),1e3)})):this.createTrack(t)}setToggleButtonVisibility(t){rt.setVisibility(this._toggleButton,t)}_updateToggleButtonState(){this._device.active?(rt.setButtonHighlight(this._toggleButton,!1),rt.setVisibility(this._toggleButton.children[0],!0),rt.setVisibility(this._toggleButton.children[1],!1)):(rt.setButtonHighlight(this._toggleButton,!0),rt.setVisibility(this._toggleButton.children[0],!1),rt.setVisibility(this._toggleButton.children[1],!0))}_disposeTrack(){if(this._device.track!==null){const t=this._device.track;t.removeListener("stopped",this._onStoppedBound),t.detach(),t.stop()}this._device.track=null}_onStopped(){this._device.track!==null&&this.setTrack(null,null,{name:"NotReadableError",message:"Stopped"})}_close(){rt.removeChildren(this._previewContainer)}_setPreviewInnerHTML(t){this._close(),this._previewContainer.innerHTML=t,rt.show(this._previewContainer)}_setPreviewElement(t){this._close(),t!==null&&(t.style.width=this._width.toString()+"px",t.style.height=this._height.toString()+"px",this._previewContainer.appendChild(t),rt.show(this._previewContainer))}_showTrack(){this._device.active=!0,this._device.track.enable()}_hideTrack(){this._device.active=!1}_onToggleButtonClicked(){if(!this.isAvailable()){this.createTrack().then(()=>{this._device.error&&rt.highlightText(this._errorDiv)});return}this._device.active?this._onSwitchOff():this._onSwitchOn(),this._updateToggleButtonState()}_onSwitchOff(){this._hideTrack(),this._device.track.disable()}_onSwitchOn(){this._showTrack(),this._device.track.enable()}}class DP extends T0{constructor(t,e,i,n,s){super(y0.CAMERA,t,e,i,n,s,'<span class="fa-video-slash"></span>'),this._twilioCreateTrackFunction=Twilio.Video.createLocalVideoTrack,this._device.trackOptions=oc}showInTestNeededMode(){super.showInTestNeededMode(),this._showPlaceholder()}showInPreviewMode(){super.showInPreviewMode(),this._showPlaceholder()}_showPlaceholder(){const t=`
        <div class="ext-meeting-join-camera-preview-placeholder">
          <span class="fa-video absolute-center"></span>
        </div>
      `;this._setPreviewInnerHTML(t)}_hideTrack(){super._hideTrack(),this._showPlaceholder()}_showTrack(){super._showTrack(),this._setPreviewElement(this._device.track.attach())}_onSwitchOff(){super._onSwitchOff(),this.setTrack(null,null,null)}}class LP extends T0{constructor(t,e,i,n,s){super(y0.MICROPHONE,t,e,i,n,s,'<span class="fa-microphone-slash"></span>'),this._noSoundThreshold=80,this._volumeVisualizer=new sc.VolumeVisualizer(e,i,this._noSoundThreshold),this._volumeMeter=null,this._measurementIntervalId=null,this._twilioCreateTrackFunction=Twilio.Video.createLocalAudioTrack,this._device.trackOptions=rc}showInTestNeededMode(){super.showInTestNeededMode(),this._setPreviewElement(null)}showInPreviewMode(){super.showInPreviewMode(),this._setPreviewElement(null)}dispose(){this._isMeasurementActive()&&this._stopMeasurement(),super.dispose()}_measure(){this._volumeVisualizer.update(this._volumeMeter.measureSoundVolume())}_hideTrack(){super._hideTrack(),this._isMeasurementActive()&&this._stopMeasurement(),this._setPreviewElement(null)}_showTrack(){super._showTrack(),this._setPreviewInnerHTML(this._volumeVisualizer.getHTML()),this._startMeasurement()}_startMeasurement(){this._volumeMeter=new sc.VolumeMeter(this._device.track,512,this._noSoundThreshold),this._measurementIntervalId=setInterval(()=>this._measure())}_stopMeasurement(){clearInterval(this._measurementIntervalId),this._measurementIntervalId=null,this._volumeMeter.dispose(),this._volumeMeter=null}_isMeasurementActive(){return this._measurementIntervalId!==null}_pauseMonitoringTrackBeforeReset(){super._pauseMonitoringTrackBeforeReset(),this._isMeasurementActive()&&this._stopMeasurement()}_resumeMonitoringTrackAfterReset(){super._resumeMonitoringTrackAfterReset(),this._startMeasurement()}_disposeTrack(){this._isMeasurementActive()&&this._stopMeasurement(),super._disposeTrack()}}b0=class{constructor(r,t){this._onJoinCallback=r,this._joinMode=!1,this._dialog=null,this._preflightTestDone=!1,this._mediaInitialized=!1,this._cameraPreview=null,this._micVolumePreview=null,this._cameraPreviewHeight=198,this._cameraPreviewWidth=264,this._micVolumePreviewHeight=4,this._micVolumePreviewWidth=40,this._onDevicesChangedBound=this._onDevicesChanged.bind(this),this._errorMessageActive=!0,this._runPrefilghtTest(t)}show(){this._blurHelp(),this._createDialog(),this._cameraPreview=new DP(this,this._cameraPreviewWidth,this._cameraPreviewHeight,"ext-meeting-join-camera-toggle","ext-meeting-join-camera-preview-container"),this._micVolumePreview=new LP(this,this._micVolumePreviewWidth,this._micVolumePreviewHeight,"ext-meeting-join-mic-toggle","ext-meeting-join-mic-volume-container"),this._errorMessageGenerator=new RP("ext-meeting-join-first-error","ext-meeting-join-second-error",this._micVolumePreview,this._cameraPreview),this._setupDevicesSelection(),this._checkPermissions().then(()=>{this._runPreviewMode(!1),this._createMediaTracksSeparately(oc,rc,()=>this._onMediaInitialized())}).catch(r=>{r!==void 0&&Re.log("Error checking audio/video devices permissions: "+r.name+": "+r.message),this._runTestNeededMode()})}_checkPermissions(){return new Promise((r,t)=>navigator.mediaDevices.enumerateDevices().then(function(e){const i=e.filter(function(s){return s.kind==="audioinput"&&s.deviceId!==""&&s.label!==""}),n=e.filter(function(s){return s.kind==="videoinput"&&s.deviceId!==""&&s.label!==""});i.length>0||n.length>0?r():t()}).catch(function(e){t(e)}))}_setupDevicesSelection(){const r=e=>{this._cameraPreview.restartTrack({name:"camera",deviceId:{exact:e.currentTarget.value}})};rt.addChangeHandler("ext-meeting-join-select-camera",r);const t=e=>{this._micVolumePreview.restartTrack({name:"mic",deviceId:{exact:e.currentTarget.value}})};rt.addChangeHandler("ext-meeting-join-select-microphone",t),navigator.mediaDevices.addEventListener("devicechange",this._onDevicesChangedBound)}_onDevicesChanged(){if(!this._joinMode)return;const r=this._cameraPreview.device.error,t=this._micVolumePreview.device.error;r||t?this._createMediaTracksSeparately(r?oc:null,t?rc:null):this._fillDevicesSelectControls()}_fillDevicesSelectControls(){navigator.mediaDevices.enumerateDevices().then(r=>{this._cameraPreview.updateTrackDeviceId(r),this._micVolumePreview.updateTrackDeviceId(r);const t=r.filter(function(i){return i.kind==="audioinput"});this._fillDevicesSelectControl(t,"ext-meeting-join-select-microphone-container","ext-meeting-join-select-microphone",this._micVolumePreview.device.getId());const e=r.filter(function(i){return i.kind==="videoinput"});this._fillDevicesSelectControl(e,"ext-meeting-join-select-camera-container","ext-meeting-join-select-camera",this._cameraPreview.device.getId())})}_fillDevicesSelectControl(r,t,e,i){const n=document.getElementById(t),s=document.getElementById(e);rt.setVisibility(n,r.length>1),rt.removeChildren(s),r.length>1&&(r.forEach(a=>{const l=document.createElement("option");l.value=`${a.deviceId}`,ma(l,`${a.label}`),s.appendChild(l)}),s.value=i)}_createDialog(){this._dialog=new rt.UiPopup(`
        <h3 class="ext-meeting-dialog-title" data-strings="meetings.join3dMeeting"></h3>
        <div class="ext-meeting-join-row">
          <div id="ext-meeting-join-name-label">
            ${Bt("meetings.name")}:
          </div>
          <input type="text" id="ext-meeting-join-name"
                 class="ext-meeting-join-input"
                 autocomplete="off">
          </input>
        </div>
        <div class="ext-meeting-join-row">
          <div class="ext-meeting-join-main-container">
            <div id="ext-meeting-join-error-container"
                 class="absolute-vertical-center">
              <div id="ext-meeting-join-first-error"></div>
              <div id="ext-meeting-join-second-error"></div>
            </div>
            <div id="ext-meeting-join-camera-preview-container"></div>
            <div id="ext-meeting-join-mic-volume-container"></div>
            <div id="ext-meeting-join-preview-toggle-container"
                 class="absolute-horizontal-center">
              <button id="ext-meeting-join-mic-toggle" style="display: none"
                      class="ext-meeting-button ext-meeting-button-highlight
                            ext-meeting-join-device-button">
                <span class="fa-microphone" style="display: none"></span>
                <span class="fa-microphone-slash"></span>
              </button>
              <button id="ext-meeting-join-camera-toggle" style="display: none"
                      class="ext-meeting-button ext-meeting-button-highlight
                            ext-meeting-join-device-button">
                <span class="fa-video" style="display: none"></span>
                <span class="fa-video-slash"></span>
              </button>
            </div>
          </div>
        </div>
        <div class="ext-meeting-join-row">
          <div id="ext-meeting-join-select-camera-container"
               style="display: none">
            ${Bt("meetings.camera")}:
            <select id="ext-meeting-join-select-camera"
                    class="ext-meeting-join-input">
            </select>
          </div>
          <div id="ext-meeting-join-select-microphone-container"
               style="display: none">
            ${Bt("meetings.microphone")}:
            <select id="ext-meeting-join-select-microphone"
                    class="ext-meeting-join-input">
            </select>
          </div>
        </div>
        <div id="ext-meeting-join-network-error-container" style="display: none">
          <div data-strings="meetings.networkIssuesDetected"></div>
          <div>
            <a href="https://networktest.twilio.com/" style="color: white" target="_blank"
               data-strings="meetings.diagnoseConnection">
            </a>
          </div>
        </div>
        <div id="ext-meeting-join-button-container"
             class="ext-meeting-join-row">
          <button id="ext-meeting-join-button"
                  class="ext-meeting-button ext-meeting-dialog-buttons"
                  data-strings="meetings.join">
          </button>
        </div>
        <div class="ext-meeting-join-footer">
          <span data-strings="meetings.byJoiningYouAgreeTo"></span>
          <span id="terms-of-service-link" class="ext-meeting-terms-link">
            <u data-strings="meetings.termsOfService"></u>
          </span>
          ${Bt("meetings.and")}
          <span id="privacy-policy-link" class="ext-meeting-terms-link">
            <u data-strings="meetings.privacyPolicy"></u><!-- no whitespace before dot --></span>.
        </div>
      `),this._dialog.showDismiss=!1,this._dialog.foremost=!0,this._dialog.open();const r=document.getElementById("terms-of-service-link");r.onclick=()=>{const e="https://www.shapespark.com/terms#in-viewer";this._dialog.hide(),rt.showIframePopup(Bt("meetings.infrastructureProvidedUnderTos"),e,()=>this._dialog.unhide())};const t=document.getElementById("privacy-policy-link");t.onclick=()=>{const e="https://www.shapespark.com/privacy#in-viewer";this._dialog.hide(),rt.showIframePopup(Bt("meetings.infrastructureProvidedUnderPp"),e,()=>this._dialog.unhide())},this._initializeDisplayName()}_createMediaTracksSeparately(r,t,e){const i=()=>{this._fillDevicesSelectControls(),this._errorMessageActive=!0,this.updateErrorMessage(),e&&e()};this._errorMessageActive=!1,r&&t?this._cameraPreview.createTrack(r).then(()=>this._micVolumePreview.createTrack(t)).then(()=>{i()}):r?this._cameraPreview.createTrack(r).then(()=>{i()}):this._micVolumePreview.createTrack(t).then(()=>{i()})}_runTestNeededMode(){this._setTestNeededMode(),this._cameraPreview.showInTestNeededMode(),this._micVolumePreview.showInTestNeededMode()}_runPreviewMode(r){this._setPreviewMode(r),r?(this._cameraPreview.setToggleButtonVisibility(!0),this._micVolumePreview.setToggleButtonVisibility(!0)):(this._cameraPreview.showInPreviewMode(),this._micVolumePreview.showInPreviewMode())}_onCreateMediaTracks(r,t,e){const i=r.filter(s=>s.kind==="audio"),n=r.filter(s=>s.kind==="video");this._errorMessageActive=!1,i.length>0?this._micVolumePreview.setTrack(i[0],t):this._micVolumePreview.setTrack(null,t,{name:"Unknown error",message:""}),n.length>0?this._cameraPreview.setTrack(n[0],e):this._cameraPreview.setTrack(null,e,{name:"Unknown error",message:""}),this._errorMessageActive=!0,this.updateErrorMessage(),this._fillDevicesSelectControls(),this._runPreviewMode(!0)}_testCamera(){const r={audio:as(rc),video:as(oc)};Twilio.Video.createLocalTracks(r).then(t=>{this._onCreateMediaTracks(t)}).catch(t=>{this._createMediaTracksSeparately(oc,rc,()=>this._runPreviewMode(!0))})}_setTestNeededMode(){this._joinMode=!1;const r=`
        <button class="ext-meeting-button ext-meeting-dialog-buttons"
                id="ext-meeting-test-button" data-strings="meetings.testCamera">
        </button>
      `,t=document.getElementById("ext-meeting-join-button-container");rt.removeChildren(t),To(t,r),Ki("ext-meeting-test-button",()=>this._testCamera())}_setPreviewMode(r){if(this._joinMode)return;this._joinMode=!0;const t=`
        <button class="ext-meeting-button ext-meeting-dialog-buttons"
                id="ext-meeting-join-button" data-strings="meetings.join">
        </button>
      `,e=document.getElementById("ext-meeting-join-button-container");rt.removeChildren(e),To(e,t),this._mediaInitialized=!0,this._updateJoinButtonState(),Ki("ext-meeting-join-button",()=>this._joinMeeting()),r||this._setMediaInitialized(!1)}_onMediaInitialized(){this._setMediaInitialized(!0)}_updateJoinButtonState(){const r=document.getElementById("ext-meeting-join-button");r&&(r.disabled=!(this._preflightTestDone&&this._mediaInitialized))}_setMediaInitialized(r){this._mediaInitialized=r,this._updateJoinButtonState()}_setPreflightTestDone(){this._preflightTestDone=!0,this._updateJoinButtonState()}_initializeDisplayName(){const r=document.getElementById("ext-meeting-join-name");let t=localStorage.getItem("extMtgDisplayName");t&&(r.value=t),r.focus(),r.select()}_checkDisplayName(){const r=document.getElementById("ext-meeting-join-name"),t=r.value.trim();if(!t){rt.highlightInput(r);return}return t}_blurHelp(){document.getElementById("help-and-primary-progress").classList.add("ui-blur")}_unblurHelp(){const r=document.getElementById("help-and-primary-progress");r.classList.remove("ui-blur"),r.classList.add("ui-unblur")}_runPrefilghtTest(r){const t=new Promise((i,n)=>{const s="https://pubsub.pubnub.com/time/0",l=new Date().getTime()/1e3;Vr(s,null,null,c=>{const h=c[0]/1e7,d=Math.abs(h-l);console.warn("PubNub test completed, response time:",d.toFixed(4)+"s"),i()},(c,h)=>{console.error("PubNub test error:",c,h),n(new Error("PubNub test failed"))})}),e=new Promise((i,n)=>{const s=Twilio.Video.runPreflight(r,{duration:CP});s.on("failed",(a,l)=>{console.error("Twilio test error:",a),n(new Error("Twilio test failed"))}),s.on("completed",()=>{i()})});Promise.all([t,e]).then(()=>{this._setPreflightTestDone()}).catch(i=>{console.error(i);const n=document.getElementById("ext-meeting-join-network-error-container");rt.show(n),this._setPreflightTestDone()})}_joinMeeting(){const r=this._checkDisplayName();if(r===void 0)return;localStorage.setItem("extMtgDisplayName",r);const t=this._micVolumePreview.device,e=this._cameraPreview.device;this._dispose(),this._onJoinCallback(r,t,e)}updateErrorMessage(){this._errorMessageActive&&this._errorMessageGenerator.update()}_dispose(){this._dialog.close(),this._unblurHelp(),navigator.mediaDevices.removeEventListener("devicechange",this._onDevicesChangedBound),this._cameraPreview.dispose(),this._micVolumePreview.dispose(),this._dialog=null,this._cameraPreview=null,this._micVolumePreview=null}};const np=13,sd=15,rd=3,sp=2,od=9,OP=2;class FP{constructor(){this._room=null,this._bars=[],this._crossLines=[],this._crossIsVisible=!1,this._updateBind=this._update.bind(this),this._qualityToBarIndex=[-1,0,0,1,2,2],this._create()}_create(){const t=document.getElementById("ext-meeting-quality-indicator-container");console.assert(t!==null,"Quality indicator container not found");const e=document.createElementNS("http://www.w3.org/2000/svg","svg");e.setAttribute("width",np),e.setAttribute("height",sd),t.appendChild(e);const i=Math.floor((np+sp)/rd)-sp,n=i+sp,s=Math.floor(sd/rd);for(let d=0;d<rd;d++){const u=d*n,f=(d+1)*s,p=sd-f;this._addBar(e,u,p,i,f)}const a=(np-od)/2,l=(sd-od)/2,c=a+od,h=l+od;this._addCrossLine(e,a,l,c,h),this._addCrossLine(e,a,h,c,l)}_addBar(t,e,i,n,s){const a=document.createElementNS("http://www.w3.org/2000/svg","rect");a.setAttribute("x",e),a.setAttribute("y",i),a.setAttribute("width",n),a.setAttribute("height",s),a.setAttribute("display","none"),t.appendChild(a),this._bars.push(a)}_addCrossLine(t,e,i,n,s){const a=document.createElementNS("http://www.w3.org/2000/svg","line");a.setAttribute("x1",e),a.setAttribute("y1",i),a.setAttribute("x2",n),a.setAttribute("y2",s),a.setAttribute("stroke","red"),a.setAttribute("stroke-width",OP),a.setAttribute("display","none"),t.appendChild(a),this._crossLines.push(a)}_hideBars(){this._bars.forEach(t=>{t.setAttribute("display","none")})}_hideCross(){this._crossIsVisible&&(this._crossLines.forEach(t=>{t.setAttribute("display","none")}),this._crossIsVisible=!1)}_showBars(){this._bars.forEach(t=>{t.setAttribute("display","block")})}_showCross(){this._crossIsVisible||(this._crossLines.forEach(t=>{t.setAttribute("display","block")}),this._crossIsVisible=!0)}onConnect(t){console.assert(this._room===null),this._room=t,this._showBars(),this._update(this._room.localParticipant.networkQualityLevel),t.localParticipant.on("networkQualityLevelChanged",this._updateBind)}onDisconnect(){console.assert(this._room),this._room.localParticipant.removeListener("networkQualityLevelChanged",this._updateBind),this._room=null,this._hideBars(),this._hideCross()}_getColor(t,e){return t<=this._qualityToBarIndex[e]?"white":"dimgray"}_update(t){if(t!==null){for(let e=0;e<rd;e++){const i=this._getColor(e,t);this._bars[e].setAttribute("fill",i),this._bars[e].setAttribute("stroke",i)}t===0?this._showCross():this._hideCross()}}}function BP(){T.FONT_FAMILIES_TO_LOAD.push("FontAwesomeSolid"),T.FONT_FAMILIES_TO_LOAD.push("FontAwesomeRegular");const r=.1,t="#0775e8",e=new _e(0,1,0),i=document.getElementById("walk-canvas"),n=T.urlHashGetArgument("av-region");function s(){return T.DEVEL_MEETING_SCENE_URL||window.location.href}function a(){const B=window.location.hostname;return B.endsWith(".shapespark.com")?"https://cloud"+B.substr(B.indexOf(".")):B.endsWith(".shapespark.com.cn")?"https://cloud.shapespark.com.cn":T.DEVEL_MEETING_CLOUD_URL||"https://cloud.shapespark.com"}function l(B){const Y=new Date(B),re=new Date;return re.getDate()===Y.getDate()&&re.getMonth()===Y.getMonth()&&re.getFullYear()===Y.getFullYear()?Y.toLocaleTimeString():Y.toLocaleDateString()+" "+Y.toLocaleTimeString()}function c(B,Y,re,le){const ge=document.createElement("li");ge.classList.add("ext-meeting-list-entry");const pe=ge.appendChild(document.createElement("span"));if(pe.classList.add("ext-meeting-list-name"),pe.innerText=B,pe.style.color=re,le&&(Ss(ge,le),ge.style.cursor="pointer"),Y){ge.appendChild(document.createElement("br"));const Ae=ge.appendChild(document.createElement("small"));Ae.innerText=Y,Ae.style.color="white"}return ge}function h(B,Y,re){return{color:t,icon:"edit",opacity:1,position:[B,Y,re],radius:.07,type:"sphere"}}function d(B,Y,re,le=!1){const ge=Y&&re?`<button class="ext-meeting-dialog-ok ext-meeting-button">
            ${Y}
          </button>`:"",Ae=`<div>
        <h3>${B}</h3>
      </div>
      <div class ="ext-meeting-dialog-buttons">
        ${ge}
        ${le?`<button class="ext-meeting-dialog-cancel ext-meeting-button" data-strings="meetings.cancel">
        </button>`:""}
      </div>`,Fe=new rt.UiPopup(Ae);if(Fe.showDismiss=!1,Fe.open(),le){const he=Fe.getElementsByClassName("ext-meeting-dialog-cancel")[0];he.onclick=()=>Fe.dismiss()}if(Y&&re){const he=Fe.getElementsByClassName("ext-meeting-dialog-ok")[0];he.onclick=()=>{Fe.close(),re()}}}function u(B,Y){const re=Y.attach(),le=B.createTextureFromHtmlVideo(re);return le.play(),le}function f(B){B.detach().forEach(Y=>Y.remove())}function p(B){return B&&B.isStarted&&B.isEnabled&&!B.isStopped}function m(B,Y,re){this._viewer=B,this._uuid=Y;const le=parseInt(Y.substring(2));this._color=T.AVATAR_COLORS[le%T.AVATAR_COLORS.length],this._displayName=null,this._avatar=null,this._twilioParticipant=null,this._lastRenderedPosition=[],this._lastRenderedPositionLength=0,this._dataTrack=null,this._micTrack=null,this._cameraTrack=null,this._screenTrack=null,this._audioTrack=null,this._noSoundThreshold=80,this._soundVolumeUpdatesScheduler=re,this._volumeVisualizer=new sc.VolumeVisualizer(20,3,this._noSoundThreshold,3),this._volumeMeter=null}m.prototype={constructor:m,_setUpAvatar:function(){console.assert(this._displayName,"Display name must be known to set up the avatar"),Re.log("Setting up avatar for %s:%s",this._uuid,this._displayName),this._avatar=this._viewer.addAvatar(this._uuid,{displayName:this._displayName,color:this._color})},get uuid(){return this._uuid},get color(){return this._color},get displayName(){return this._displayName},get hasDisplayName(){return this._displayName!==null},_positionChanged:function(B){if(this._lastRenderedPositionLength!==B.length)return!0;const Y=1e-5;for(let re=0;re<B.length;re++)if(Math.abs(this._lastRenderedPosition[re]-B[re])>Y)return!0;return!1},_setLastRenderedPosition:function(B){this._lastRenderedPositionLength=B.length;for(let Y=0;Y<B.length;Y++)this._lastRenderedPosition[Y]=B[Y]},get volumeVisualizer(){return this._volumeVisualizer},updatePosition:function(B){if(!this.hasDisplayName||!this._positionChanged(B))return;this._setLastRenderedPosition(B);const Y=this._avatar;Y.setPositionFromArray(B),Y.rotate(B[3],B[4]),B.length>=6?Y.placePointer(B[5],B[6],B[7]):Y.hidePointer(),Y.visible&&(Y.updateMatrixWorld(!0),this._viewer.requestFrame())},updateSoundVolumeVisualization(){console.assert(this._volumeMeter!==null,"this._voulmeMeter not created");const B=this._volumeMeter.measureSoundVolume();this._onSoundVolumeUpdated(B)},_onSoundVolumeUpdated(B){this._volumeVisualizer.update(B)},dispose:function(){this.isSoundMeasurementActive()&&this._stopSoundMeasurement(),this._avatar&&(this._viewer.removeAvatar(this._avatar),this._avatar=null,this._viewer.requestFrame())},_updateSoundMeasurementState:function(){this._micTrack!==null&&this._micTrack.isEnabled?this._startSoundMeasurement():this._stopSoundMeasurement()},isSoundMeasurementActive:function(){return this._volumeMeter!==null},_startSoundMeasurement:function(){this.isSoundMeasurementActive()||(this._volumeMeter=new sc.VolumeMeter(this._micTrack,512,this._noSoundThreshold),this._soundVolumeUpdatesScheduler.registerUser(this))},_stopSoundMeasurement:function(){this.isSoundMeasurementActive()&&(this._soundVolumeUpdatesScheduler.unregisterUser(this),this._volumeMeter.dispose(),this._volumeMeter=null,this._avatar.onSoundSwitchedOff())}},Object.defineProperty(m.prototype,"micTrack",{get:function(){return this._micTrack}}),Object.defineProperty(m.prototype,"cameraTrack",{get:function(){return this._cameraTrack}}),Object.defineProperty(m.prototype,"audioTrack",{get:function(){return this._audioTrack}});function b(B,Y,re,le,ge,pe){m.call(this,B,Y,le,!0),this._displayName=re,this._setUpAvatar(),this._avatar.hideBody(),this._isPublishingTracksDuringConnecting=!1,this._dataTrack=new Twilio.Video.LocalDataTrack({name:"data",maxPacketLifeTime:1e3}),this._isCreatingMicTrack=!1,this._isCreatingCameraTrack=!1,this._micDevice=ge,this._cameraDevice=pe,this._micTrack=this._micDevice.track,this._micTrack!==null&&this._subscribeToMicEvents(),this._updateSoundMeasurementState(),this._cameraTrack=this._cameraDevice.track,this._cameraTrack!==null&&(console.assert(this._cameraDevice.active,"Got inactive camera track from MeetingStarter"),this._subscribeToCameraEvents()),this._lastPosition=null,this._positionMessage=[Y,re,null],this._resendInterval=null,this._onMicTrackStateChanged=null,this._onCameraTrackStateChanged=null}b.prototype=Object.create(m.prototype),b.prototype.constructor=b,Object.defineProperty(b.prototype,"dataTrack",{get:function(){return this._dataTrack}}),Object.defineProperty(b.prototype,"screenTrack",{get:function(){return this._screenTrack}}),b.prototype.getAllTracks=function(){const B=[this._dataTrack];return this._micTrack&&B.push(this._micTrack),this._cameraTrack&&B.push(this._cameraTrack),this._screenTrack&&B.push(this._screenTrack),this._audioTrack&&B.push(this._audioTrack),B},b.prototype._sendPosition=function(B){this._positionMessage[2]=B,this._dataTrack.send(JSON.stringify(this._positionMessage))},b.prototype._resendLastPosition=function(){this._lastPosition!==null&&this._sendPosition(this._lastPosition)},b.prototype.startedConnectingToTwilio=function(){this._isPublishingTracksDuringConnecting=!0},b.prototype.failedToConnectToTwilio=function(){this._isPublishingTracksDuringConnecting=!1},b.prototype.connectedToTwilio=function(B){this._twilioParticipant=B,B.publishTracks(this.getAllTracks()).finally(()=>{this._isPublishingTracksDuringConnecting=!1}),this._resendLastPosition();const Y=1e3;this._resendInterval=setInterval(()=>this._resendLastPosition(),Y)},b.prototype.disconnectedFromTwilio=function(){this._twilioParticipant=null,clearInterval(this._resendInterval),this._resendInterval=null},Object.defineProperty(b.prototype,"isConnectedToTwilio",{get:function(){return this._twilioParticipant!==null}}),b.prototype.updatePosition=function(B){m.prototype.updatePosition.call(this,B),this._lastPosition=B,this.isConnectedToTwilio&&this._sendPosition(B)},b.prototype.setAvTracksStateHandlers=function(B,Y){this._onMicTrackStateChanged=B,this._onCameraTrackStateChanged=Y},b.prototype._removeStoppedMicTrack=function(){console.assert(this._micTrack&&this._micTrack.isStopped),Re.log("Removing stopped local mic track"),this._twilioParticipant&&(Re.log("Unpublishing stopped local mic track"),this._twilioParticipant.unpublishTrack(this._micTrack)),this._micTrack=null},b.prototype._subscribeToMicEvents=function(){const B=()=>{this._updateSoundMeasurementState(),this._onMicTrackStateChanged&&this._onMicTrackStateChanged(this._micTrack)},Y=()=>{B(),this._removeStoppedMicTrack()};this._micTrack.on("started",B),this._micTrack.on("enabled",B),this._micTrack.on("disabled",B),this._micTrack.on("stopped",Y)},b.prototype._createMicTrack=function(){if(Re.log("Creating local mic track"),this._isCreatingMicTrack){Re.log("Local mic track is already being created");return}this._isCreatingMicTrack=!0;let B=null;Twilio.Video.createLocalAudioTrack(this._micDevice.trackOptions).then(Y=>{if(B=Y,this.isConnectedToTwilio)return Re.log("Publishing local mic track"),this._twilioParticipant.publishTrack(B)}).then(Y=>{Y?Re.log("Local mic track created and published"):Re.log("Local mic track created but not yet published"),this._micTrack=B,this._subscribeToMicEvents(),this._onMicTrackStateChanged&&this._onMicTrackStateChanged(this._micTrack),this._isCreatingMicTrack=!1}).catch(Y=>{B&&B.stop(),this._micDevice.error=Y,this._showCreateTrackError(this._micDevice),this._isCreatingMicTrack=!1})},b.prototype.toggleMic=function(){this._micTrack?this._micTrack.isEnabled?(Re.log("Disabling local mic track"),this._micTrack.disable()):(Re.log("Enabling local mic track"),this._micTrack.enable()):this._createMicTrack()},b.prototype._removeStoppedCameraTrack=function(){console.assert(this._cameraTrack&&this._cameraTrack.isStopped),Re.log("Removing stopped local camera track"),this._twilioParticipant&&(Re.log("Unpublishing stopped local camera track"),this._twilioParticipant.unpublishTrack(this._cameraTrack)),this._cameraTrack=null},b.prototype._subscribeToCameraEvents=function(){const B=()=>{this._onCameraTrackStateChanged&&this._onCameraTrackStateChanged(this._cameraTrack)},Y=()=>{B(),this._removeStoppedCameraTrack()};this._cameraTrack.on("started",B),this._cameraTrack.on("enabled",B),this._cameraTrack.on("disabled",B),this._cameraTrack.on("stopped",Y)},b.prototype._createCameraTrack=function(){if(Re.log("Creating local camera track"),this._isCreatingCameraTrack){Re.log("Local camera track is already being created");return}this._isCreatingCameraTrack=!0;let B=null;Twilio.Video.createLocalVideoTrack(this._cameraDevice.trackOptions).then(Y=>{if(B=Y,this.isConnectedToTwilio)return Re.log("Publishing local camera track"),this._twilioParticipant.publishTrack(B)}).then(Y=>{Y?Re.log("Local camera track created and published"):Re.log("Local camera track created but not yet published"),this._cameraTrack=B,this._subscribeToCameraEvents(),this._onCameraTrackStateChanged&&this._onCameraTrackStateChanged(this._cameraTrack),this._isCreatingCameraTrack=!1}).catch(Y=>{B&&B.stop(),this._cameraDevice.error=Y,this._showCreateTrackError(this._cameraDevice),this._isCreatingCameraTrack=!1})},b.prototype._showCreateTrackError=function(B){const Y=B.getErrorMessageInfo();rt.showMessage(Y.description,Y.title)},b.prototype.toggleCamera=function(){if(this._cameraTrack){if(this._isPublishingTracksDuringConnecting){Re.log("Cannot disable the camera track during connection process");return}this._cameraTrack.stop()}else this._createCameraTrack()},b.prototype.startShareScreen=function(B,Y,re,le){if(this._screenTrack!==null){B();return}Re.log("Share screen start"),navigator.mediaDevices.getDisplayMedia({video:!0,audio:!0}).then(ge=>{Re.log("share screen - stream:",ge);const pe=new Twilio.Video.LocalVideoTrack(ge.getVideoTracks()[0],{name:"screen"});this._screenTrack=pe;const Ae=ge.getAudioTracks();let Fe=null;Ae.length>0?(Fe=new Twilio.Video.LocalAudioTrack(Ae[0],{name:"audio"}),this._audioTrack=Fe,le()):console.log("Audio track not available for sharing");const he=u(this._viewer,pe);this._avatar.setVideoTexture1(he),this._viewer.requestFrame(),this.isConnectedToTwilio&&(this._twilioParticipant.publishTrack(pe),Fe&&this._twilioParticipant.publishTrack(Fe)),B(),pe.once("stopped",()=>{Re.log("Screen track stopped"),this.isConnectedToTwilio&&(this._twilioParticipant.unpublishTrack(pe),Fe!==null&&this._twilioParticipant.unpublishTrack(Fe)),this._avatar.setVideoTexture1(null),f(pe),Fe!==null&&f(Fe),this._screenTrack=null,this._audioTrack&&(this._audioTrack=null,le()),this._viewer.requestFrame(),Y()})}).catch(ge=>{re()})},b.prototype.stopShareScreen=function(){this._screenTrack!==null&&(Re.log("Share screen stop"),this._screenTrack.stop())},b.prototype.dispose=function(){this._micTrack&&this._micTrack.stop(),this._cameraTrack&&this._cameraTrack.stop(),this._screenTrack&&this._screenTrack.stop(),m.prototype.dispose.call(this)};function g(B,Y,re,le){m.call(this,B,Y,re,!1),this._onUiRefreshNeeded=le,this._micTrackStateChangedBound=null,this._cameraTrackEnabledBound=null,this._cameraTrackDisabledBound=null,this._trackSubscribedBound=this._trackSubscribed.bind(this),this._trackUnsubscribedBound=this._trackUnsubscribed.bind(this),this._disposed=!1}g.prototype=Object.create(m.prototype),g.prototype.constructor=g,g.prototype._refreshUi=function(){this._onUiRefreshNeeded&&this._onUiRefreshNeeded(this)},g.prototype._setUpMicTrack=function(){Re.log("Setting up remote mic track for %s:%s",this._uuid,this._displayName),this._micTrackStateChangedBound=()=>{this._updateSoundMeasurementState(),this._refreshUi()},this._micTrack.on("enabled",this._micTrackStateChangedBound),this._micTrack.on("disabled",this._micTrackStateChangedBound),this._updateSoundMeasurementState(),this._micTrack.attach()},g.prototype._tearDownMicTrack=function(){Re.log("Tearing down remote mic track for %s:%s",this._uuid,this._displayName),f(this._micTrack),this._micTrack.removeListener("enabled",this._micTrackStateChangedBound),this._micTrack.removeListener("disabled",this._micTrackStateChangedBound),this._micTrackStateChangedBound=null},g.prototype._setUpAudioTrack=function(){Re.log("Setting up remote audio track for %s:%s",this._uuid,this._displayName),this._audioTrack.attach()},g.prototype._tearDownAudioTrack=function(){Re.log("Tearing down remote audio track for %s:%s",this._uuid,this._displayName),f(this._audioTrack)},g.prototype._setUpCameraTrack=function(){Re.log("Setting up remote camera track for %s:%s",this._uuid,this._displayName);const B=u(this._viewer,this._cameraTrack);this._cameraTrackEnabledBound=()=>{this._avatar.setVideoTexture0(B)},this._cameraTrackDisabledBound=()=>{this._avatar.setVideoTexture0(null)},this._cameraTrack.on("enabled",this._cameraTrackEnabledBound),this._cameraTrack.on("disabled",this._cameraTrackDisabledBound),this._avatar.setVideoTexture0(B)},g.prototype._tearDownCameraTrack=function(){Re.log("Tearing down remote camera track for %s:%s",this._uuid,this._displayName),this._avatar.setVideoTexture0(null),f(this._cameraTrack),this._cameraTrack.removeListener("enabled",this._cameraTrackEnabledBound),this._cameraTrack.removeListener("disabled",this._cameraTrackDisabledBound),this._cameraTrackEnabledBound=null,this._cameraTrackDisabledBound=null},g.prototype._setUpScreenTrack=function(){Re.log("Setting up remote screen track for %s:%s",this._uuid,this._displayName);const B=u(this._viewer,this._screenTrack);this._avatar.setVideoTexture1(B)},g.prototype._tearDownScreenTrack=function(){Re.log("Tearing down remote screen track for %s:%s",this._uuid,this._displayName),this._avatar.setVideoTexture1(null),f(this._screenTrack)},g.prototype._setDisplayName=function(B){Re.log("Remote display name known for %s:%s",this._uuid,B),this._displayName=B,this._setUpAvatar(),this._micTrack&&this._setUpMicTrack(),this._cameraTrack&&this._setUpCameraTrack(),this._screenTrack&&this._setUpScreenTrack(),this._audioTrack&&this._setUpAudioTrack(),this._refreshUi()},g.prototype._trackSubscribed=function(B){if(Re.log("Remote %s:%s track subscribed for %s:%s",B.kind,B.name,this._uuid,this._displayName),!this._disposed){if(B.kind==="data"&&B.name==="data"){if(this._dataTrack){Re.log("Ignoring duplicate data track");return}this._dataTrack=B,B.on("message",Y=>{Y=JSON.parse(Y);const re=Y[1],le=Y[2];this.hasDisplayName||this._setDisplayName(re),this.updatePosition(le)})}else if(B.kind==="audio"&&B.name==="mic"){if(this._micTrack){Re.log("Ignoring duplicate mic track");return}this._micTrack=B,this.hasDisplayName&&(this._setUpMicTrack(),this._refreshUi())}else if(B.kind==="video"){if(B.name==="camera"){if(this._cameraTrack){Re.log("Ignoring duplicate camera track");return}this._cameraTrack=B,this._avatar&&(this._setUpCameraTrack(),this._viewer.requestFrame())}else if(B.name==="screen"){if(this._screenTrack){Re.log("Ignoring duplicate screen track");return}this._screenTrack=B,this._avatar&&(this._setUpScreenTrack(),this._viewer.requestFrame())}}else if(B.kind==="audio"&&B.name==="audio"){if(this._audioTrack){Re.log("Ignoring duplicate audio track");return}this._audioTrack=B,this.hasDisplayName&&(this._setUpAudioTrack(),this._refreshUi())}}},g.prototype._trackUnsubscribed=function(B){Re.log("Remote %s:%s track unsubscribed for %s:%s",B.kind,B.name,this._uuid,this._displayName),!this._disposed&&(B===this._dataTrack?this._dataTrack=null:B===this._micTrack?(this.hasDisplayName&&this._tearDownMicTrack(),this._micTrack=null,this._refreshUi()):B===this._cameraTrack?(this._avatar&&(this._tearDownCameraTrack(),this._viewer.requestFrame()),this._cameraTrack=null):B===this._screenTrack?(this._avatar&&(this._tearDownScreenTrack(),this._viewer.requestFrame()),this._screenTrack=null):B===this._audioTrack&&(this.hasDisplayName&&this._tearDownAudioTrack(),this._audioTrack=null,this._refreshUi()))},g.prototype.connectedToTwilio=function(B){this._twilioParticipant=B,B.on("trackSubscribed",this._trackSubscribedBound),B.on("trackUnsubscribed",this._trackUnsubscribedBound),B.tracks.forEach(Y=>{Y.isSubscribed&&this._trackSubscribed(Y.track)})},g.prototype.seeAvatar=function(){this._avatar&&this._viewer.seeItem(this._avatar)},g.prototype._onSoundVolumeUpdated=function(B){m.prototype._onSoundVolumeUpdated.call(this,B),this._avatar.onSoundVolumeUpdated(B)},g.prototype.dispose=function(){this._onUiRefreshNeeded=null,this._micTrack&&this._trackUnsubscribed(this._micTrack),this._cameraTrack&&this._trackUnsubscribed(this._cameraTrack),this._screenTrack&&this._trackUnsubscribed(this._screenTrack),this._audioTrack&&this._trackUnsubscribed(this._audioTrack),this.isConnectedToTwilio&&(this._twilioParticipant.removeListener("trackSubscribed",this._trackSubscribedBound),this._twilioParticipant.removeListener("trackUnsubscribed",this._trackUnsubscribedBound),this._twilioParticipant=null),m.prototype.dispose.call(this),this._disposed=!0};function x(B,Y,re,le,ge,pe){const Ae=new PubNub({publishKey:Y.publishKey,subscribeKey:Y.subscribeKey,authKey:Y.authKey,uuid:B.uuid,ssl:!0}),Fe=Y.channel;Ae.subscribe({channels:[Fe],withPresence:!0}),Ae.addListener({message:function(he){Re.log("listener received message",he),he.message.type==="SceneState"&&ge(he.message.state)},presence:function(he){he.uuid!==B.uuid&&(Re.log("listener presence event",he),he.action==="join"?re(he.uuid):he.action==="leave"&&le(he.uuid))},status:function(he){(he.category==="PNAccessDeniedCategory"||he.category==="PNNetworkIssuesCategory"||he.category==="PNNetworkDownCategory"||he.category==="PNTimeoutCategory")&&pe(he.category)}}),Ae.hereNow({channels:[Fe],includeUUIDs:!0,includeState:!0},(he,tt)=>{Re.log("herenow",he,tt),tt.channels[Fe].occupants.forEach(function(Ze){Ze.uuid!==B.uuid&&re(Ze.uuid)})}),this.dispose=function(){Ae.unsubscribeAll()}}function w(B,Y,re,le,ge,pe,Ae,Fe,he,tt){const Ze=Y.avToken,N=Y.channel,U=["NotAllowedError","NotFoundError","NotReadableError","OverconstrainedError","TypeError"];let k=null,X=!1,ve=0;const De=T.urlHashContains("av-turn");function qe(Pe){const He=Pe.identity.match(/^u-\d+/),lt=He&&He[0];return lt||(T.warn("Unknown participant",Pe.identity),null)}function Ne(Pe){Re.log('Participant "%s" connected',Pe.identity);const He=qe(Pe);He&&re(He,Pe)}function me(Pe){Re.log('Participant "%s" disconnected',Pe.identity);const He=qe(Pe);He&&le(He,Pe)}function Ye(Pe){const He=Pe!==null?qe(Pe):null;tt(He)}function ue(Pe){U.includes(Pe.name)?ge(Pe):pe("T"+Pe.code)}this.isConnectingOrConnected=function(){return X};function Ee(Pe){X&&(X=!1,k.participants.forEach(me),k=null,B.disconnectedFromTwilio(),he(),ve>0?pe("TReconnectionDisconnected"+(Pe.code?" "+Pe.code:"")):Ae())}this.disconnect=function(){X&&(X=!1,k&&(k.disconnect(),k.participants.forEach(me),k=null,B.disconnectedFromTwilio(),he()))},this.dispose=function(){this.disconnect()},this.connect=function(){console.assert(!X),X=!0,B.startedConnectingToTwilio(),Re.log('Connecting to room "%s"',N),Twilio.Video.connect(Ze,{name:N,tracks:B.getAllTracks(),preferredVideoCodecs:"auto",iceTransportPolicy:De?"relay":"all",region:n||"gll",networkQuality:{local:1,remote:1},dominantSpeaker:!0}).then(Pe=>{k=Pe,Re.log("Connected to room"),k.participants.forEach(Ne),k.on("participantConnected",Ne),k.on("participantDisconnected",me),k.on("dominantSpeakerChanged",Ye),k.on("reconnecting",He=>{ve+=1}),k.on("reconnected",He=>{ve=0}),k.once("disconnected",Ee),B.connectedToTwilio(k.localParticipant),Fe(k)}).catch(Pe=>{B.failedToConnectToTwilio(),ue(Pe)})}}class C{constructor(){this._users=new Set,this._maxIntervalBetweenUpdates=100,this._idleCallback=new WE(()=>this._execute(),this._maxIntervalBetweenUpdates),rn().onBeforeRender(()=>this._onBeforeRender())}registerUser(Y){this._users.add(Y)}unregisterUser(Y){this._users.delete(Y)}dispose(){this._users.clear()}_onBeforeRender(){this._execute(),this._idleCallback.deferRun()}_execute(){this._users.forEach(Y=>Y.updateSoundVolumeVisualization())}}function M(B,Y){const pe=document.getElementById("ext-meeting-who-list-folder"),Ae=document.getElementById("ext-meeting-status");lh(Ae);const Fe=document.getElementById("ext-meeting-who-list"),he=new Eu(1e3),tt=new Eu(3e3),Ze=new Eu(1e3,()=>{Fe.style.overflowY="auto"});Fe.addEventListener("scroll",ue=>{he.isRunning()||tt.start()});let N=!0;function U(){Ze.isRunning()||(N?(N=!1,Fe.style.maxHeight=0,Fe.style.margin=0,Fe.style.overflowY="hidden",pe.children[0].style.transform="rotate(180deg)"):(pe.children[0].style.transform="",Fe.style.maxHeight="",Fe.style.margin="",Ze.start(),N=!0))}Ss(pe,U),$e.firefox&&(Fe.style.paddingRight="16px");let k=null;const X=new Map;function ve(ue,Ee,Pe){const He=document.createElement("span");if(He.classList.add("ext-meeting-who-list-name"),ue){const lt=document.createElement("span");lt.innerText=Ee;const Rt=document.createElement("span");To(Rt,` (${Bt("meetings.me")})`),He.appendChild(lt),He.appendChild(Rt)}else He.innerText=Ee;return He.style.color=Pe,He}function De(ue){const Ee=document.createElement("span");return Ee.classList.add("ext-meeting-who-list-mic-indicator"),ue?Ee.classList.add("fa-microphone"):Ee.classList.add("fa-microphone-slash"),Ee}function qe(){const ue=document.createElement("span");return ue.classList.add("ext-meeting-who-list-mic-indicator"),ue.classList.add("fa-file-audio-o"),ue}function Ne(ue){console.assert(ue.volumeVisualizer!==null,"volumeVisualizer not initialized");const Ee=document.createElement("span");return ue.isSoundMeasurementActive()?Ee.innerHTML=ue.volumeVisualizer.getHTML():Ee.innerHTML=ue.volumeVisualizer.getEmptyHTML(),Ee}function me(){const ue=document.createElement("li");ue.classList.add("ext-meeting-who-list-entry"),ue.appendChild(Ne(B)),ue.appendChild(ve(!0,B.displayName,B.color));const Ee=p(B.micTrack);return ue.appendChild(De(Ee)),B.audioTrack&&ue.appendChild(qe()),ue}function Ye(ue){const Ee=document.createElement("li");Ee.classList.add("ext-meeting-who-list-entry"),Ee.appendChild(Ne(ue));const Pe=ve(!1,ue.displayName,ue.color);Pe.style.cursor="pointer",Ee.appendChild(Pe);const He=ue.micTrack&&ue.micTrack.isEnabled;return Ee.appendChild(De(He)),ue.audioTrack&&Ee.appendChild(qe()),Ss(Pe,ue.seeAvatar.bind(ue)),Ee}this.onDominantSpeakerChanged=function(ue){if(k&&ue!==k&&(k=null),tt.isRunning()||ue===null)return;const Ee=X.get(ue);Ee?(Ee.scrollIntoView({behavior:"smooth",block:"nearest"}),he.start()):k=ue},this.update=function(ue){X.clear(),rt.removeChildren(Fe),Fe.appendChild(me());for(const Ee of Object.values(ue))if(Ee.hasDisplayName){const Pe=Ye(Ee);Fe.appendChild(Pe),X.set(Ee,Pe)}k&&X.has(k)&&(this.onDominantSpeakerChanged(k),k=null)},this.show=function(){rt.show(Ae)},this.hide=function(){rt.hide(Ae)},this.update([]),this.show()}function D(B){return`
      <div>
        <textarea id="ext-meeting-note-text"
          class="ext-meeeting-note-edit"
          placeholder="${B}"></textarea>
      </div>
      <button id="ext-meeting-note-publish"
        class="ext-meeting-button ext-meeting-dialog-buttons">
        Publish
      </button>
    `}function W(B,Y){const re="extMtg:"+B+":"+Y+":";function le(ge){let pe=re;return ge.location!==null&&(pe+=":"+ge.location.join(":")),pe}this.getTimeStampOfLastReadNoteAtLocation=function(ge){return localStorage.getItem(le(ge))||-1},this.isNoteRead=function(ge){return ge.ts<=this.getTimeStampOfLastReadNoteAtLocation(ge)||ge.author===Y},this.markAllNotesAtLocationAsRead=function(ge){localStorage.setItem(le(ge),ge.ts)}}function z(B,Y,re,le,ge,pe){const Ae="MeetingNotes",Fe=[];let he=[],tt=!1;const Ze=new rt.UiPopup(`
      <h2>
        Click a place to leave a note there.
      </h2>`);Ze.position=rt.UiPopup.TOP;const N=new rt.UiPopup(D("Type your note"));N.position=rt.UiPopup.TOP;let U,k=null,X=null;function ve(Pe){if(Pe===Y.displayName)return Y.color;for(const He of Object.values(re))if(He.displayName===Pe)return He.color;return"#ffffff"}function De(){tt=!1,le.show(),i.style.cursor="default",Ze.dismiss(),N.close()}function qe(){tt=!0,le.hide(),i.style.cursor="pointer",k&&k.close(),B.onNodeTypeClicked(U),Ze.onDismiss=()=>{B.removeOnNodeTypeClicked(U),De()},Ze.open()}function Ne(Pe,He){return Pe===null||He===null?!1:Za(Pe,He)}Ki("ext-meeting-add-note",qe);const me=new L;U=function(Pe,He,lt){i.style.cursor="default",me.copyFrom(He),Im(me,B.getCameraPosition(),r),B.removeOnNodeTypeClicked(U);const Rt=B.addAnchor(h(me.x,me.y,me.z));return Rt.material.highlight=e,Rt.material.setUniforms(),Rt.material.highlightMix=.7,Ze.close(),N.onClose=()=>{B.removeAnchor(Rt),De()},N.open(),Ki("ext-meeting-note-publish",()=>{const Et=document.getElementById("ext-meeting-note-text"),F=Et.value.trim();if(!F){rt.highlightInput(Et);return}pe(F,[me.x,me.y,me.z])}),!0};function Ye(Pe){return he.filter(He=>Ne(He.location,Pe.location))}function ue(Pe,He){let lt;function Rt(ze,Lt){if(tt)return;lt.classList.remove("ext-meeting-note-list-unread"),lt.classList.add("ext-meeting-note-list-selected"),Lt&&lt.scrollIntoView(),ze.material.highlightMix=.7,B.requestFrame();let Ht="";const gt=new Map,Wi=ge.getTimeStampOfLastReadNoteAtLocation(Pe);let Bi=null;for(const Be of Ye(Pe)){const I="ext-meeting-note-text"+Be.id,V="ext-meeting-note-author"+Be.id;let te="ext-meeting-note-entry";Be.ts>Wi&&Be.author!==Y.displayName&&(te+=" ext-meeting-note-unread"),Ht+=`<div class="${te}">
               <strong id="${V}"
                   style="color: ${ve(Be.author)}">
               </strong> <span>${l(Be.ts)}</span>
               <div id="${I}">
               </div>
             </div>`,gt.set(I,Be.text),gt.set(V,Be.author),Bi=Be}const Ii=Ht+D("Type your response");k?k.update(Ii):(k=new rt.UiPopup(Ii),k.position=rt.UiPopup.TOP,k.onClose=()=>{lt.classList.remove("ext-meeting-note-list-selected"),ze.material.highlightMix=0,B.requestFrame(),k=null}),ge.markAllNotesAtLocationAsRead(Bi),X=Pe.location,k.open(),gt.forEach((Be,I)=>{document.getElementById(I).innerText=Be}),Ki("ext-meeting-note-publish",()=>{const Be=document.getElementById("ext-meeting-note-text"),I=Be.value.trim();if(!I){rt.highlightInput(Be);return}const V=ze.position;pe(I,[V.x,V.y,V.z]),Be.value=""})}const Et=B.addAnchor(h(Pe.location[0],Pe.location[1],Pe.location[2]),ze=>Rt(ze,!0));Et.material.highlight=e,Et.material.setUniforms(),Fe.push(Et);const F=Pe,ee=F.author;lt=c(ee,l(F.ts),ve(ee),()=>{B.seeItem(Et),Rt(Et,!1)}),ge.isNoteRead(Pe)||lt.classList.add("ext-meeting-note-list-unread"),He.appendChild(lt),k!==null&&Za(X,Pe.location)&&Rt(Et,!0)}function Ee(Pe,He){console.assert(Pe===Ae),he=He.sort((Et,F)=>{const ee=ge.isNoteRead(Et),ze=ge.isNoteRead(F);return ee!==ze?ee?-1:1:Et.ts-F.ts}),De();for(const Et of Fe)B.removeAnchor(Et);Fe.length=0;const lt=document.getElementById("ext-meeting-note-list");rt.removeChildren(lt);const Rt=new Map;for(let Et=he.length-1;Et>=0;Et--){const F=he[Et];if(F.location!==null){const ee=F.location.join("/");Rt.has(ee)||(Rt.set(ee,Et),ue(F,lt),lt.lastChild.scrollIntoView())}}}B.onApiUserStateChanged(Ae,Ee)}function $(B,Y){const re=this;let le=null,ge=null;const pe=new rt.UiPopup(`
      <h2 data-strings="meetings.pointPlace">
      </h2>`);pe.position=rt.UiPopup.TOP;const Ae=B._createPointerEventHelper(0);Ae.disable(),this.pointerX=null,this.pointerY=null,this.pointerZ=null,this.isEnabled=function(){return Ae.isEnabled()},this.showPointer=function(){return this.pointerX!==null};function Fe(){return le!==null}B.onBeforeRender(()=>{if(!Fe())return;const Ze=B._findIntersectionAtPosition(le,ge);Ze.distance!==1/0&&(this.pointerX=Ze.point.x,this.pointerY=Ze.point.y,this.pointerZ=Ze.point.z)});function he(){le=null,ge=null,re.pointerX=null,re.pointerY=null,re.pointerZ=null,B._enableControls()}Ae.callbacks.onPointerDown=function(Ze,N){return le=Ze,ge=N,B._disableControls(),B.requestFrame(),!0},Ae.callbacks.onPointerMove=function(Ze,N){return Fe()?(le=Ze,ge=N,B.requestFrame(),!0):!1},Ae.callbacks.onPointerUp=function(){return he(),B.requestFrame(),!0};function tt(){re.isEnabled()?(i.style.cursor="default",he(),Ae.disable(),pe.close(),Y.show()):(i.style.cursor="pointer",pe.open(),Ae.enable(),pe.onDismiss=tt,Y.hide())}Ki("ext-meeting-pointer",function(){tt()})}function Z(){const B=[0,0,0,0,0],Y=[0,0,0,0,0,0,0,0];let re=null,le=!1;this.newUpdateWithPointer=function(){le=!1,re!==Y&&(le=!0,re=Y)},this.newUpdateNoPointer=function(){le=!1,re!==B&&(le=!0,re=B)},this.set=function(ge,pe){re[ge]!==pe&&(re[ge]=pe,le=!0)},this.getFilledArray=function(){return le?re:null}}function ne(){const B=document.getElementById("ext-meeting-mic-toggle"),Y=document.getElementById("ext-meeting-camera-toggle"),re=document.getElementById("ext-meeting-camera-preview");lh(re);let le=null;this.showCameraPreview=!0;function ge(Ae){rt.setVisibility(Ae.children[0],!0),rt.setVisibility(Ae.children[1],!1)}function pe(Ae){rt.setVisibility(Ae.children[0],!1),rt.setVisibility(Ae.children[1],!0)}this.refreshMicControls=function(Ae){p(Ae)?(rt.setButtonHighlight(B,!1),ge(B)):(rt.setButtonHighlight(B,!0),pe(B))},this.refreshCameraControls=function(Ae){let Fe=!1;p(Ae)?(le||(le=Ae.attach(),re.appendChild(le)),Fe=this.showCameraPreview,rt.setButtonHighlight(Y,!1),ge(Y)):(le&&(Ae.detach(),le.remove(),le=null),rt.setButtonHighlight(Y,!0),pe(Y)),Fe?rt.show(re):rt.hide(re)},this.setToggleButtonHandlers=function(Ae,Fe){Ss(B,Ae),Ss(Y,Fe)}}function Me(B,Y,re,le){function ge(Be){ii.info("Failed to acquire media.<br/>"+Be.message,6e3)}const pe=rn(),Ae=new Z,Fe=new C;this.myUuid=le.uuid;const he=new b(pe,this.myUuid,B,Fe,Y,re),tt={},Ze=new M(he),N=new ne,U=le.id,k=le.meetingKey;let X,ve,De;function qe(){he.dispose(),ve.dispose(),X.dispose();for(const Be of Object.values(tt))Be.dispose();Fe.dispose()}function Ne(Be,I){qe(),document.body.innerHTML='<div id="cover-image"></div>',d(Be,I,I?()=>location.reload():void 0)}function me(Be){Ne(`${Bt("meetings.connectionLost")}</br>(${Bt("meetings.code")}: ${Be}).`,Bt("meetings.joinAgain"))}function Ye(){Ne(Bt("meetings.meetingEnded"))}function ue(){he.toggleMic()}function Ee(){he.toggleCamera()}N.setToggleButtonHandlers(ue,Ee),he.setAvTracksStateHandlers(function(Be){N.refreshMicControls(Be),Ze.update(tt)},function(Be){N.refreshCameraControls(Be)}),N.refreshMicControls(he.micTrack),N.refreshCameraControls(he.cameraTrack);function Pe(Be,I){const V={meetingKey:k,author:B,text:Be,location:I};Vr(a()+"/meetings/"+U+"/notes","application/json",JSON.stringify(V),()=>Re.log("Note added."),()=>Re.log("Failed to add note"))}const He=new $(pe,Ze);T.urlHashContains("meeting-notes")&&(rt.show(document.getElementById("ext-meeting-notes-preview")),z(pe,he,tt,Ze,new W(U,B),Pe));function lt(Be){Ze.update(tt)}function Rt(Be){let I=tt[Be];return I||(I=new g(pe,Be,Fe,lt),tt[Be]=I),I}function Et(Be){Rt(Be),ve.isConnectingOrConnected()||ve.connect()}function F(Be){Be in tt&&(tt[Be].dispose(),delete tt[Be],Ze.update(tt),ve.isConnectingOrConnected()&&Object.keys(tt).length===0&&ve.disconnect())}function ee(Be,I){Rt(Be).connectedToTwilio(I)}function ze(Be,I){F(Be)}function Lt(Be){const I=Be in tt?tt[Be]:null;Ze.onDominantSpeakerChanged(I)}function Ht(Be){De=Be;for(const I of Object.keys(Be))pe.apiUserChangeState(I,Be[I])}le.sceneState!==null&&Ht(le.sceneState),X=new x(he,le,Et,F,Ht,me);const gt=new FP;ve=new w(he,le,ee,ze,ge,me,Ye,gt.onConnect.bind(gt),gt.onDisconnect.bind(gt),Lt),Ki("ext-meeting-leave",()=>{d(Bt("meetings.doYouWantToLeaveMeeting"),Bt("meetings.leaveMeeting"),()=>{Ne(Bt("meetings.youHaveLeftMeeting"),Bt("meetings.joinAgain"))},!0)});function Wi(Be){He.showPointer()?(Ae.newUpdateWithPointer(),Ae.set(5,bs(He.pointerX,3)),Ae.set(6,bs(He.pointerY,3)),Ae.set(7,bs(He.pointerZ,3))):Ae.newUpdateNoPointer();const I=pe.getCameraPosition(),V=pe.getCameraRotation();Ae.set(0,bs(I.x,3)),Ae.set(1,bs(I.y,3)),Ae.set(2,bs(I.z,3)),Ae.set(3,bs(V.yaw,1)),Ae.set(4,bs(V.pitch,1));const te=Ae.getFilledArray();te&&he.updatePosition(te)}function Bi(Be,I){if(De&&Za(I,De[Be]))return;const V={meetingKey:k,key:Be,state:I};Vr(a()+"/meetings/"+U+"/scene-state","application/json",JSON.stringify(V),()=>Re.log("State updated."),()=>Re.log("Failed to update state."))}function Ii(){Ne(Bt("meetings.meetingEndedMaximumDurationReached"))}pe.onBeforeRender(Wi),Wi(),pe.onApiUserStateChanged(Bi),this.startShareScreen=function(Be,I,V){Re.log("Screen share start requested"),he.startShareScreen(Be,I,V,()=>Ze.update(tt))},this.stopShareScreen=function(){Re.log("Screen share stop requested"),he.stopShareScreen()},this.setCameraPreviewVisibility=function(Be){N.showCameraPreview=Be,N.refreshCameraControls(he.cameraTrack)},le.remainingTimeSeconds!==null&&setTimeout(Ii,(le.remainingTimeSeconds+5)*1e3)}function Xe(B){const Y=(le,ge,pe)=>{const Ae=new Me(le,ge,pe,B);rn()._meetingJoined(Ae)};new b0(Y,B.avToken).show()}function xe(B,Y){const re=(pe,Ae)=>{fetch(pe+Ae.model).then(Fe=>Fe.text()).then(Fe=>{const he=yP(Fe);VE(pe,Ae,he),Y()}).catch(()=>ii.error(Bt("meetings.failedToLoadMeeting")))},le=()=>{B=yi("3dassets/avatar.json")},ge=pe=>$t(this,null,function*(){if(pe===void 0)return;const Ae=pe.split("/").slice(0,-1).join("/")+"/";try{const he=yield(yield fetch(pe)).json();return re(Ae,he),!0}catch(Fe){return!1}});rn().onSceneLoadComplete(()=>$t(this,null,function*(){(yield ge(B))||(le(),T.AVATAR_JSON_URL_OVERRIDE&&(B=T.AVATAR_JSON_URL_OVERRIDE),yield ge(B))||ii.error(Bt("meetings.failedToLoadMeeting"))}))}function Le(){const B=T.urlHashGetArgument("meeting"),Y=T.urlHashGetArgument("meeting-key"),re=T.urlHashGetArgument("av-mode"),le={url:s()};B&&(le.meetingName=B),Y&&(le.meetingKey=Y),re&&(le.avMode=re),n&&(le.avRegion=n),Vr(a()+"/meetings/join","application/json",JSON.stringify(le),ge=>xe(ge.avatarJsonUrl,()=>Xe(ge)),(ge,pe)=>{pe!==void 0?ii.error(pe):ii.error(Bt("meetings.failedToJoinMeeting"))})}Vb([yi("lib/pubnub.min.js"),yi("lib/twilio-video.min.js")],Le,()=>ii.error("Cannot load required library")),zv()}gP(),rn()._isMeeting()&&BP(),window.addEventListener("load",function(){return $t(this,null,function*(){if(yield Gb(),US())return;const r=new v0;Vv(r)})})})();
